<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "system-ui",
                "-apple-system",
                "BlinkMacSystemFont",
                "Segoe UI",
                "Roboto",
                "sans-serif",
              ],
            },
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-in-right": "slideInRight 0.3s ease-out",
              "slide-in-bottom": "slideInBottom 0.3s ease-out",
              "pulse-subtle": "pulseSubtle 2s ease-in-out infinite",
              "spin-slow": "spin 1.5s linear infinite",
            },
          },
        },
      };
    </script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideInBottom {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes pulseSubtle {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      * {
        -webkit-tap-highlight-color: transparent;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #e5e7eb 25%,
          #f3f4f6 50%,
          #e5e7eb 75%
        );
        background-size: 200% 100%;
        animation: skeleton 1.5s infinite;
      }
      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #374151 25%,
          #4b5563 50%,
          #374151 75%
        );
        background-size: 200% 100%;
      }
      @keyframes skeleton {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      input[type="number"]::-webkit-inner-spin-button {
        opacity: 0.5;
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .collapsible-content.open {
        max-height: 2000px;
      }
      .toast-enter {
        animation: slideInRight 0.3s ease-out;
      }
      .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
      }
      .dark .focus-ring:focus {
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4);
      }
      .touch-target {
        min-height: 44px;
        min-width: 44px;
      }
      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
      }
      .dark .glass {
        background: rgba(15, 23, 42, 0.8);
      }
      @media (max-width: 640px) {
        .mobile-full {
          width: 100%;
          max-width: 100%;
        }
        .mobile-stack {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 text-slate-900 dark:text-slate-100 font-sans min-h-screen transition-colors duration-300"
  >
    <div id="app" class="flex flex-col h-screen h-[100dvh] overflow-hidden">
      <header
        class="flex-shrink-0 glass border-b border-slate-200/50 dark:border-slate-700/50 px-3 sm:px-4 py-2.5 sm:py-3 z-30"
      >
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 sm:gap-3 min-w-0">
            <div
              class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30 flex-shrink-0"
            >
              <svg
                class="w-4 h-4 sm:w-5 sm:h-5 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <div class="min-w-0">
              <h1
                class="text-base sm:text-lg font-bold tracking-tight truncate"
              >
                ESN Studio
              </h1>
              <p
                class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 hidden xs:block truncate"
              >
                Autoregressive Forecasting
              </p>
            </div>
          </div>
          <div class="flex items-center gap-1.5 sm:gap-2">
            <div
              id="model-status"
              class="hidden sm:flex items-center gap-2 px-2.5 py-1.5 bg-slate-100/80 dark:bg-slate-700/80 rounded-lg text-xs sm:text-sm"
            >
              <span
                class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
                id="status-dot"
              ></span>
              <span id="status-text" class="font-medium">No Model</span>
            </div>
            <button
              onclick="runPrediction()"
              id="predict-btn-header"
              class="hidden sm:flex touch-target items-center justify-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg text-sm font-medium transition-all shadow-md shadow-blue-500/25 focus-ring"
              title="Predict (P)"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              <span class="hidden md:inline">Predict</span>
            </button>
            <button
              onclick="openModal('config-modal')"
              class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors focus-ring"
              title="Configure (C)"
              aria-label="Configure model"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>
            <button
              onclick="toggleMainMenu()"
              class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors focus-ring"
              title="Menu (M)"
              aria-label="Open menu"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <button
              onclick="toggleTheme()"
              class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors focus-ring"
              title="Toggle theme"
              aria-label="Toggle dark mode"
            >
              <svg
                class="w-5 h-5 dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>
      <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <main
          class="flex-1 flex flex-col overflow-hidden p-2 sm:p-4 gap-2 sm:gap-4"
        >
          <div
            class="flex items-center gap-1.5 sm:gap-2 overflow-x-auto pb-1 -mx-2 px-2 sm:mx-0 sm:px-0 scrollbar-hide"
          >
            <button
              onclick="setVisualizationMode('grid')"
              class="viz-tab touch-target px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0"
              data-mode="grid"
            >
              <span class="hidden sm:inline">Small Multiples</span><span
                class="sm:hidden"
              >Grid</span>
            </button>
            <button
              onclick="setVisualizationMode('focus')"
              class="viz-tab touch-target px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0"
              data-mode="focus"
            >
              <span class="hidden sm:inline">Focus View</span><span
                class="sm:hidden"
              >Focus</span>
            </button>
            <button
              onclick="setVisualizationMode('heatmap')"
              class="viz-tab touch-target px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0"
              data-mode="heatmap"
            >
              Heatmap
            </button>
            <button
              onclick="setVisualizationMode('uncertainty')"
              class="viz-tab touch-target px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0"
              data-mode="uncertainty"
            >
              <span class="hidden sm:inline">Uncertainty</span><span
                class="sm:hidden"
              >CI</span>
            </button>
            <button
              onclick="setVisualizationMode('bar')"
              class="viz-tab touch-target px-3 sm:px-4 py-2 rounded-xl text-xs sm:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0"
              data-mode="bar"
            >
              Snapshot
            </button>
            <div class="ml-auto flex items-center gap-2 flex-shrink-0">
              <button
                onclick="toggleSidePanel()"
                class="lg:hidden touch-target p-2 rounded-lg bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-600/50 transition-colors"
                aria-label="Toggle details panel"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div
            class="flex-1 min-h-[250px] sm:min-h-[300px] bg-white dark:bg-slate-800/50 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200/50 dark:border-slate-700/50 overflow-hidden relative"
          >
            <div id="chart-container" class="w-full h-full relative">
              <canvas
                id="main-canvas"
                class="w-full h-full touch-none"
              ></canvas>
              <div
                id="chart-controls"
                class="absolute top-2 sm:top-3 right-2 sm:right-3 flex flex-col gap-1 hidden z-10"
              >
                <button
                  onclick="chartZoomIn()"
                  class="touch-target p-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-lg hover:bg-white dark:hover:bg-slate-600 transition-colors backdrop-blur-sm"
                  aria-label="Zoom in"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v12m6-6H6"
                    />
                  </svg>
                </button>
                <button
                  onclick="chartZoomOut()"
                  class="touch-target p-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-lg hover:bg-white dark:hover:bg-slate-600 transition-colors backdrop-blur-sm"
                  aria-label="Zoom out"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M18 12H6"
                    />
                  </svg>
                </button>
                <button
                  onclick="chartResetZoom()"
                  class="touch-target p-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-lg hover:bg-white dark:hover:bg-slate-600 transition-colors backdrop-blur-sm"
                  aria-label="Reset zoom"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                    />
                  </svg>
                </button>
              </div>
              <div
                id="zoom-badge"
                class="absolute top-2 sm:top-3 left-2 sm:left-3 px-2 py-1 bg-white/90 dark:bg-slate-700/90 rounded-lg text-xs font-semibold hidden backdrop-blur-sm shadow-md"
              >
                100%
              </div>
              <div
                id="empty-state"
                class="absolute inset-0 flex items-center justify-center p-4"
              >
                <div class="text-center px-4 sm:px-6 max-w-lg">
                  <div
                    class="w-20 h-20 sm:w-28 sm:h-28 mx-auto mb-4 sm:mb-6 relative"
                  >
                    <div
                      class="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-purple-400/20 rounded-3xl rotate-6 animate-pulse"
                    >
                    </div>
                    <div
                      class="absolute inset-0 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-3xl -rotate-6"
                    >
                    </div>
                    <div
                      class="absolute inset-2 sm:inset-3 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center shadow-inner"
                    >
                      <svg
                        class="w-8 h-8 sm:w-12 sm:h-12 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        />
                      </svg>
                    </div>
                  </div>
                  <h3
                    class="text-lg sm:text-xl font-bold mb-2"
                    id="empty-title"
                  >
                    Create a Model to Begin
                  </h3>
                  <p
                    class="text-sm text-slate-500 dark:text-slate-400 mb-6"
                    id="empty-subtitle"
                  >
                    Configure your Echo State Network for autoregressive time
                    series forecasting
                  </p>
                  <div
                    id="onboarding-actions"
                    class="flex flex-col gap-3 sm:gap-2"
                  >
                    <button
                      onclick="startWithDefaults()"
                      class="touch-target w-full sm:w-auto px-5 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30 focus-ring flex items-center justify-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 10V3L4 14h7v7l9-11h-7z"
                        />
                      </svg>Start with Defaults
                    </button>
                    <div class="flex gap-2">
                      <button
                        onclick="openModal('load-modal')"
                        class="touch-target flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-600/50 rounded-xl font-medium transition-colors focus-ring flex items-center justify-center gap-2"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                          />
                        </svg><span class="hidden sm:inline">Load</span>
                      </button>
                      <button
                        onclick="runRandomTest()"
                        class="touch-target flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl font-medium transition-all shadow-lg shadow-purple-500/25 focus-ring flex items-center justify-center gap-2"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                          />
                        </svg>Demo
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div
                id="loading-state"
                class="absolute inset-0 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md flex items-center justify-center hidden z-50"
              >
                <div class="text-center p-6 max-w-sm">
                  <div
                    class="w-14 h-14 border-4 border-blue-500 border-t-transparent rounded-full animate-spin-slow mx-auto mb-4"
                  >
                  </div>
                  <p class="font-semibold text-lg mb-1" id="loading-text">
                    Processing...
                  </p>
                  <div id="progress-container" class="mt-4 hidden">
                    <div
                      class="w-full h-2.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"
                    >
                      <div
                        id="progress-bar"
                        class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300 rounded-full"
                        style="width: 0%"
                      >
                      </div>
                    </div>
                    <p class="text-sm text-slate-500 mt-2" id="progress-text">
                      0%
                    </p>
                    <button
                      onclick="cancelOperation()"
                      class="mt-4 touch-target px-5 py-2 text-sm bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors font-medium"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
              <div
                id="chart-tooltip"
                class="absolute pointer-events-none opacity-0 transition-opacity duration-150 z-40"
              >
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl shadow-slate-900/20 dark:shadow-slate-900/60 border border-slate-200/80 dark:border-slate-700/80 px-4 py-3 min-w-[160px] max-w-[260px]"
                >
                  <div id="tooltip-content"></div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="sm:hidden flex items-center gap-2 p-2 bg-white/80 dark:bg-slate-800/80 rounded-xl backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <div class="flex-1 flex items-center gap-2">
              <span class="text-xs text-slate-500 whitespace-nowrap"
              >Steps:</span>
              <input
                type="range"
                id="future-steps-range-mobile"
                min="1"
                max="10000"
                value="10"
                class="flex-1 h-2"
                oninput="syncFutureSteps(this.value)"
              >
              <span
                class="text-xs font-semibold w-6 text-center"
                id="steps-display-mobile"
              >10</span>
            </div>
            <button
              onclick="runPrediction()"
              id="predict-btn-mobile"
              class="touch-target px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
            </button>
          </div>
          <div id="dimension-selector" class="hidden">
            <div
              class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
            >
              <div
                class="flex items-center gap-2 sm:gap-3 overflow-x-auto pb-1 -mx-2 px-2"
              >
                <span
                  class="text-xs sm:text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap flex-shrink-0"
                >Dimension:</span>
                <div
                  id="dim-buttons"
                  class="flex items-center gap-1.5 sm:gap-2"
                >
                </div>
              </div>
            </div>
          </div>
          <div id="step-selector" class="hidden">
            <div
              class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
            >
              <div class="flex items-center gap-2 sm:gap-3">
                <span
                  class="text-xs sm:text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap flex-shrink-0"
                >Step:</span>
                <input
                  type="range"
                  id="snapshot-step-range"
                  min="0"
                  max="9"
                  value="0"
                  class="flex-1 h-2 accent-blue-500"
                  oninput="setSnapshotStep(parseInt(this.value))"
                >
                <input
                  type="number"
                  id="snapshot-step-input"
                  min="1"
                  max="10"
                  value="1"
                  class="w-16 px-2 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm text-center font-semibold focus-ring"
                  oninput="setSnapshotStep(parseInt(this.value)-1)"
                >
              </div>
            </div>
          </div>
          <div id="stats-bar" class="hidden">
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-3">
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Min
                </p>
                <p class="text-sm sm:text-lg font-bold truncate" id="stat-min">
                  -
                </p>
              </div>
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Max
                </p>
                <p class="text-sm sm:text-lg font-bold truncate" id="stat-max">
                  -
                </p>
              </div>
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Mean
                </p>
                <p class="text-sm sm:text-lg font-bold truncate" id="stat-mean">
                  -
                </p>
              </div>
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Final
                </p>
                <p
                  class="text-sm sm:text-lg font-bold truncate"
                  id="stat-final"
                >
                  -
                </p>
              </div>
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Trend
                </p>
                <p
                  class="text-sm sm:text-lg font-bold truncate flex items-center gap-1"
                  id="stat-trend"
                >
                  -
                </p>
              </div>
              <div
                class="bg-white/80 dark:bg-slate-800/80 rounded-xl p-2.5 sm:p-3 border border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm"
              >
                <p
                  class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wide"
                >
                  Confidence
                </p>
                <p
                  class="text-sm sm:text-lg font-bold truncate"
                  id="stat-confidence"
                >
                  -
                </p>
              </div>
            </div>
          </div>
        </main>
        <aside
          id="side-panel"
          class="fixed lg:relative inset-0 lg:inset-auto lg:w-80 z-40 lg:z-auto flex-shrink-0 hidden lg:flex flex-col"
        >
          <div
            class="absolute inset-0 bg-black/50 lg:hidden"
            onclick="toggleSidePanel()"
          >
          </div>
          <div
            class="absolute right-0 top-0 bottom-0 w-[85%] max-w-sm lg:relative lg:w-full bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden shadow-2xl lg:shadow-none animate-slide-in-right lg:animate-none"
          >
            <div
              class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
            >
              <h2 class="font-bold text-lg">Details</h2>
              <button
                onclick="toggleSidePanel()"
                class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors lg:hidden"
                aria-label="Close panel"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
            <div class="p-4 border-b border-slate-200 dark:border-slate-700">
              <h3
                class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
              >
                Model Metrics
              </h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm">Samples Trained</span><span
                    class="font-bold text-blue-600 dark:text-blue-400"
                    id="metric-samples"
                  >0</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Avg Loss</span><span
                    class="font-semibold font-mono text-xs"
                    id="metric-loss"
                  >-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Gradient Norm</span><span
                    class="font-semibold font-mono text-xs"
                    id="metric-gradient"
                  >-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm">Sample Weight</span><span
                    class="font-semibold font-mono text-xs"
                    id="metric-weight"
                  >-</span>
                </div>
              </div>
            </div>
            <div class="p-4 border-b border-slate-200 dark:border-slate-700">
              <h3
                class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
              >
                Prediction
              </h3>
              <div class="space-y-3">
                <div>
                  <label class="text-sm font-medium mb-2 block"
                  >Future Steps</label>
                  <div class="flex items-center gap-3">
                    <input
                      type="range"
                      id="future-steps-range"
                      min="1"
                      max="10000"
                      value="10"
                      class="flex-1 h-2 accent-blue-500"
                      oninput="syncFutureSteps(this.value)"
                    >
                    <input
                      type="number"
                      id="future-steps-input"
                      min="1"
                      max="10000"
                      value="10"
                      class="w-16 px-2 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm text-center font-semibold focus-ring"
                      oninput="syncFutureSteps(this.value)"
                    >
                  </div>
                </div>
                <button
                  onclick="runPrediction()"
                  id="predict-btn-side"
                  class="touch-target w-full px-4 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 disabled:from-slate-300 disabled:to-slate-400 dark:disabled:from-slate-600 dark:disabled:to-slate-700 text-white rounded-xl font-semibold transition-all shadow-md shadow-blue-500/25 focus-ring disabled:shadow-none disabled:cursor-not-allowed"
                  disabled
                >
                  Run Prediction
                </button>
              </div>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
              <div class="flex items-center gap-2 px-4 py-3">
                <h3
                  class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
                >
                  Event Log
                </h3>
                <select
                  id="log-filter"
                  class="ml-auto text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg focus-ring"
                  onchange="filterLogs()"
                >
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
              <div class="px-4 pb-2">
                <input
                  type="text"
                  id="log-search"
                  placeholder="Search logs..."
                  class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
                  oninput="filterLogs()"
                >
              </div>
              <div
                id="event-log"
                class="flex-1 overflow-y-auto px-4 pb-4 space-y-2"
              >
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
    <div
      id="main-menu-overlay"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"
      onclick="toggleMainMenu()"
    >
    </div>
    <div
      id="main-menu"
      class="fixed top-0 right-0 w-[85%] max-w-sm h-full bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out"
    >
      <div
        class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
      >
        <h2 class="font-bold text-lg">Menu</h2>
        <button
          onclick="toggleMainMenu()"
          class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
          aria-label="Close menu"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-60px)]">
        <div>
          <h3
            class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            Model
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('config-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-blue-600 dark:text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Create & Configure</span><p
                  class="text-xs text-slate-500"
                >
                  Set up model parameters
                </p>
              </div>
              <kbd
                class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
              >C</kbd>
            </button>
            <button
              onclick="openModal('load-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-emerald-600 dark:text-emerald-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Save & Load</span><p
                  class="text-xs text-slate-500"
                >
                  Persist your models
                </p>
              </div>
            </button>
          </div>
        </div>
        <div>
          <h3
            class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            Data
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('upload-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-purple-600 dark:text-purple-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Upload Dataset</span><p
                  class="text-xs text-slate-500"
                >
                  Import time series data
                </p>
              </div>
              <kbd
                class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
              >U</kbd>
            </button>
            <button
              onclick="openModal('insert-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-amber-600 dark:text-amber-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Manual Insert</span><p
                  class="text-xs text-slate-500"
                >
                  Add individual time steps
                </p>
              </div>
            </button>
          </div>
        </div>
        <div>
          <h3
            class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            Test
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('random-test-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-pink-600 dark:text-pink-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Random Test</span><p
                  class="text-xs text-slate-500"
                >
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </div>
        <div>
          <h3
            class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            Advanced
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('settings-modal');toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-slate-600 dark:text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Settings</span><p
                  class="text-xs text-slate-500"
                >
                  Module URL & preferences
                </p>
              </div>
            </button>
            <button
              onclick="showDataTable();toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-slate-600 dark:text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">View Data Table</span><p
                  class="text-xs text-slate-500"
                >
                  Raw prediction values
                </p>
              </div>
            </button>
            <button
              onclick="showKeyboardShortcuts();toggleMainMenu()"
              class="touch-target w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left focus-ring"
            >
              <div
                class="w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-slate-600 dark:text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div class="flex-1">
                <span class="font-medium">Keyboard Shortcuts</span>
              </div>
              <kbd
                class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
              >?</kbd>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="config-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="config-modal-title"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('config-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-3xl sm:max-h-[90vh] sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 id="config-modal-title" class="text-lg sm:text-xl font-bold">
            Model Configuration
          </h2>
          <button
            onclick="closeModal('config-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div
          class="px-4 sm:px-5 py-3 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <div class="flex items-center gap-2 overflow-x-auto pb-1 -mx-1 px-1">
            <span
              class="text-xs sm:text-sm font-semibold text-slate-500 dark:text-slate-400 whitespace-nowrap flex-shrink-0"
            >Presets:</span>
            <button
              onclick="applyPreset('start-here')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors whitespace-nowrap font-medium flex-shrink-0"
            >
              Start Here
            </button>
            <button
              onclick="applyPreset('fast')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap flex-shrink-0"
            >
              Fast
            </button>
            <button
              onclick="applyPreset('balanced')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap flex-shrink-0"
            >
              Balanced
            </button>
            <button
              onclick="applyPreset('accurate')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap flex-shrink-0"
            >
              Accurate
            </button>
            <button
              onclick="applyPreset('adaptive')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap flex-shrink-0"
            >
              Adaptive
            </button>
            <button
              onclick="applyPreset('robust')"
              class="preset-btn touch-target px-3 py-1.5 text-xs sm:text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap flex-shrink-0"
            >
              Robust
            </button>
          </div>
        </div>
        <div
          class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-3 sm:space-y-4"
          id="config-sections"
        >
        </div>
        <div
          class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-2 sm:gap-3 flex-shrink-0"
        >
          <button
            onclick="resetConfigToDefaults()"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring font-medium"
          >
            Reset Defaults
          </button>
          <button
            onclick="resetEverything()"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors focus-ring font-medium"
          >
            Reset All
          </button>
          <div class="flex-1 hidden sm:block"></div>
          <div class="flex gap-2 mt-2 sm:mt-0">
            <button
              onclick="closeModal('config-modal')"
              class="touch-target flex-1 sm:flex-initial px-4 py-2.5 text-sm rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring font-medium"
            >
              Cancel
            </button>
            <button
              onclick="createModel()"
              class="touch-target flex-1 sm:flex-initial px-6 py-2.5 text-sm rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold transition-all shadow-lg shadow-blue-500/25 focus-ring"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="upload-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('upload-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-xl sm:max-h-[90vh] sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Upload Dataset</h2>
          <button
            onclick="closeModal('upload-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-4">
          <div
            id="upload-dropzone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-6 sm:p-8 text-center cursor-pointer hover:border-blue-400 dark:hover:border-blue-500 transition-colors bg-slate-50/50 dark:bg-slate-900/30"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
            ondrop="handleDrop(event)"
            onclick="document.getElementById('file-input').click()"
          >
            <svg
              class="w-10 h-10 sm:w-12 sm:h-12 mx-auto text-slate-400 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="font-semibold mb-1">
              Drop JSON file here or tap to browse
            </p>
            <p class="text-sm text-slate-500 dark:text-slate-400">
              Supports .json files
            </p>
            <input
              type="file"
              id="file-input"
              accept=".json"
              class="hidden"
              onchange="handleFileSelect(event)"
            >
          </div>
          <div
            class="text-center text-sm text-slate-500 dark:text-slate-400 font-medium"
          >
            or paste JSON directly
          </div>
          <div>
            <textarea
              id="upload-json-input"
              class="w-full h-32 sm:h-40 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm font-mono resize-none focus-ring"
              placeholder='{"coordinates": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1], ...]}'
            ></textarea>
          </div>
          <details class="bg-slate-50 dark:bg-slate-900/50 rounded-xl">
            <summary class="px-4 py-3 cursor-pointer text-sm font-semibold">
              View format example
            </summary>
            <div class="px-4 pb-4">
              <pre
                class="text-xs bg-slate-100 dark:bg-slate-700 p-3 rounded-lg overflow-x-auto"
              >
<code>{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2],
    [1.3, 2.3, 3.3]
  ]
}</code></pre>
              <p class="text-xs text-slate-500 mt-2">
                Each row is a time step, each column is a dimension.
              </p>
              <button
                onclick="copyFormatExample()"
                class="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium"
              >
                Copy example
              </button>
            </div>
          </details>
          <div
            id="upload-preview"
            class="hidden bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-xl p-4"
          >
            <h4
              class="font-semibold text-emerald-700 dark:text-emerald-300 mb-3 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>Validation Passed
            </h4>
            <div class="grid grid-cols-2 gap-2 text-sm" id="preview-stats">
            </div>
          </div>
          <div
            id="upload-error"
            class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4"
          >
            <h4
              class="font-semibold text-red-700 dark:text-red-300 mb-2 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>Validation Error
            </h4>
            <p
              class="text-sm text-red-600 dark:text-red-400"
              id="upload-error-text"
            >
            </p>
          </div>
        </div>
        <div
          class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row gap-2 sm:justify-end flex-shrink-0"
        >
          <button
            onclick="closeModal('upload-modal')"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring font-medium"
          >
            Cancel
          </button>
          <button
            onclick="validateAndPreviewUpload()"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-slate-600 hover:bg-slate-700 text-white transition-colors focus-ring font-medium"
          >
            Validate
          </button>
          <button
            onclick="applyUploadedData()"
            id="apply-upload-btn"
            class="touch-target px-6 py-2.5 text-sm rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold transition-all shadow-lg shadow-blue-500/25 focus-ring disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
            disabled
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>
    <div
      id="insert-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('insert-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[90vh] sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Manual Insert</h2>
          <button
            onclick="closeModal('insert-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-4">
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Add time steps to the training data.
          </p>
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-semibold">Sample JSON:</label>
              <button
                onclick="generateInsertTemplate()"
                class="text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium"
              >
                Generate Template
              </button>
            </div>
            <textarea
              id="insert-json-input"
              class="w-full h-40 sm:h-48 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm font-mono resize-none focus-ring"
              placeholder='{"coordinates": [[...], [...]]}'
            ></textarea>
          </div>
          <div id="insert-validation" class="text-sm"></div>
        </div>
        <div
          class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row gap-2 sm:justify-end flex-shrink-0"
        >
          <button
            onclick="closeModal('insert-modal')"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring font-medium"
          >
            Cancel
          </button>
          <button
            onclick="applyManualInsert()"
            class="touch-target px-6 py-2.5 text-sm rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold transition-all shadow-lg shadow-blue-500/25 focus-ring"
          >
            Insert & Train
          </button>
        </div>
      </div>
    </div>
    <div
      id="load-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('load-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[90vh] sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Save & Load Model</h2>
          <button
            onclick="closeModal('load-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-6">
          <div class="space-y-3">
            <h3 class="font-semibold">Save Model</h3>
            <div class="flex gap-2">
              <button
                onclick="downloadModel()"
                class="touch-target flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-xl text-sm font-medium transition-colors focus-ring flex items-center justify-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                  />
                </svg><span class="hidden sm:inline">Download</span>
              </button>
              <button
                onclick="saveToLocalStorage()"
                class="touch-target flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-xl text-sm font-medium transition-colors focus-ring flex items-center justify-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg><span class="hidden sm:inline">Browser</span>
              </button>
            </div>
          </div>
          <div class="space-y-3">
            <h3 class="font-semibold">Load Model</h3>
            <div
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-5 text-center cursor-pointer hover:border-blue-400 dark:hover:border-blue-500 transition-colors"
              onclick="document.getElementById('load-file-input').click()"
            >
              <svg
                class="w-9 h-9 mx-auto text-slate-400 mb-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              <p class="text-sm font-medium">Tap to load from file</p>
              <input
                type="file"
                id="load-file-input"
                accept=".json"
                class="hidden"
                onchange="loadModelFromFile(event)"
              >
            </div>
            <div id="saved-models-list" class="space-y-2"></div>
          </div>
          <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
            <button
              onclick="clearLocalStorageModels()"
              class="text-sm text-red-600 dark:text-red-400 hover:underline font-medium"
            >
              Clear all saved models
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="random-test-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('random-test-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md sm:max-h-[90vh] sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Random Test</h2>
          <button
            onclick="closeModal('random-test-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-4">
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Generate synthetic time series data to test model capabilities.
          </p>
          <div class="grid grid-cols-2 gap-3 sm:gap-4">
            <div>
              <label class="block text-xs sm:text-sm font-semibold mb-1.5"
              >Seed</label><input
                type="number"
                id="test-seed"
                value="42"
                class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-xs sm:text-sm font-semibold mb-1.5"
              >Dimensions</label><input
                type="number"
                id="test-dimensions"
                value="3"
                min="1"
                max="50"
                class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-xs sm:text-sm font-semibold mb-1.5"
              >Time Steps</label><input
                type="number"
                id="test-samples"
                value="200"
                min="10"
                max="5000"
                class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-xs sm:text-sm font-semibold mb-1.5"
              >Noise</label><input
                type="number"
                id="test-noise"
                value="0.1"
                min="0"
                max="1"
                step="0.05"
                class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-xs sm:text-sm font-semibold mb-1.5"
              >Outliers</label><input
                type="number"
                id="test-outliers"
                value="0.02"
                min="0"
                max="0.2"
                step="0.01"
                class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
              >
            </div>
          </div>
          <div>
            <label class="block text-xs sm:text-sm font-semibold mb-1.5"
            >Difficulty</label>
            <select
              id="test-difficulty"
              class="touch-target w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm focus-ring"
            >
              <option value="easy">Easy (Simple patterns)</option>
              <option value="medium" selected>Medium (Nonlinear)</option>
              <option value="hard">Hard (Multi-scale + interactions)</option>
            </select>
          </div>
        </div>
        <div
          class="p-4 sm:p-5 border-t border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row gap-2 sm:justify-end flex-shrink-0"
        >
          <button
            onclick="closeModal('random-test-modal')"
            class="touch-target px-4 py-2.5 text-sm rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring font-medium"
          >
            Cancel
          </button>
          <button
            onclick="runRandomTestFromModal()"
            class="touch-target px-6 py-2.5 text-sm rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold transition-all shadow-lg shadow-purple-500/25 focus-ring"
          >
            Generate & Run
          </button>
        </div>
      </div>
    </div>
    <div
      id="settings-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('settings-modal')"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md sm:inset-auto bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-in-bottom sm:animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Settings</h2>
          <button
            onclick="closeModal('settings-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2"
            >ESNRegression Module URL</label>
            <input
              type="text"
              id="module-url-input"
              value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.3.6"
              class="w-full px-3 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl text-xs sm:text-sm font-mono focus-ring"
            >
            <p class="text-xs text-slate-500 mt-1.5">
              Change if the default URL is unavailable
            </p>
          </div>
          <button
            onclick="reinitializeWorker()"
            class="touch-target w-full px-4 py-2.5 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-xl text-sm font-semibold hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors focus-ring"
          >
            Reinitialize Worker
          </button>
          <hr class="border-slate-200 dark:border-slate-700">
          <button
            onclick="clearAllPreferences()"
            class="touch-target w-full px-4 py-2.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl text-sm font-semibold hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors focus-ring"
          >
            Clear All Preferences
          </button>
        </div>
      </div>
    </div>
    <div
      id="data-table-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('data-table-modal')"
      >
      </div>
      <div
        class="absolute inset-2 sm:inset-4 md:inset-8 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Prediction Data Table</h2>
          <button
            onclick="closeModal('data-table-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-auto p-4 sm:p-5">
          <table class="w-full text-xs sm:text-sm">
            <thead
              id="data-table-head"
              class="bg-slate-100 dark:bg-slate-700 sticky top-0"
            >
            </thead>
            <tbody id="data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div
      id="shortcuts-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('shortcuts-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-4 sm:p-5 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"
        >
          <h2 class="text-lg sm:text-xl font-bold">Keyboard Shortcuts</h2>
          <button
            onclick="closeModal('shortcuts-modal')"
            class="touch-target p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="p-4 sm:p-5 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm">Open Menu</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >M</kbd>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Configure Model</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >C</kbd>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Upload Data</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >U</kbd>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Run Prediction</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >P</kbd>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Close Modal</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >Esc</kbd>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Show Shortcuts</span><kbd
              class="px-2.5 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-mono font-semibold"
            >?</kbd>
          </div>
        </div>
      </div>
    </div>
    <div
      id="toast-container"
      class="fixed bottom-20 sm:bottom-4 left-4 right-4 sm:left-auto sm:right-4 z-50 flex flex-col gap-2 sm:w-80"
      aria-live="polite"
    >
    </div>

    <script>
      const APP_VERSION = "1.0.0";
      const COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];
      const MAX_FUTURE_STEPS = 10000;
      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };
      const PRESETS = {
        "start-here": { ...DEFAULT_CONFIG },
        "fast": {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        "balanced": {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        "accurate": {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        "adaptive": {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        "robust": {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };
      const CONFIG_SECTIONS = [
        {
          id: "reservoir",
          title: "Reservoir Architecture",
          params: [
            {
              key: "reservoirSize",
              type: "number",
              label: "Reservoir Size",
              min: 16,
              max: 2048,
              step: 16,
              desc: "Neurons in reservoir",
            },
            {
              key: "spectralRadius",
              type: "number",
              label: "Spectral Radius",
              min: 0.1,
              max: 1.5,
              step: 0.01,
              desc: "Memory length control",
            },
            {
              key: "leakRate",
              type: "number",
              label: "Leak Rate",
              min: 0.01,
              max: 1.0,
              step: 0.01,
              desc: "Temporal smoothing",
            },
            {
              key: "inputScale",
              type: "number",
              label: "Input Scale",
              min: 0.01,
              max: 10.0,
              step: 0.1,
              desc: "Input scaling factor",
            },
            {
              key: "biasScale",
              type: "number",
              label: "Bias Scale",
              min: 0.0,
              max: 1.0,
              step: 0.01,
              desc: "Bias scaling",
            },
            {
              key: "reservoirSparsity",
              type: "number",
              label: "Reservoir Sparsity",
              min: 0.0,
              max: 0.99,
              step: 0.01,
              desc: "Zero connections",
            },
            {
              key: "inputSparsity",
              type: "number",
              label: "Input Sparsity",
              min: 0.0,
              max: 0.99,
              step: 0.01,
              desc: "Input sparsity",
            },
            {
              key: "activation",
              type: "select",
              label: "Activation",
              options: ["tanh", "relu"],
              desc: "Activation function",
            },
          ],
        },
        {
          id: "readout",
          title: "Readout Configuration",
          params: [
            {
              key: "useInputInReadout",
              type: "boolean",
              label: "Use Input in Readout",
              desc: "Append input to state",
            },
            {
              key: "useBiasInReadout",
              type: "boolean",
              label: "Use Bias in Readout",
              desc: "Include bias term",
            },
          ],
        },
        {
          id: "training",
          title: "Training (RLS)",
          params: [
            {
              key: "readoutTraining",
              type: "fixed",
              label: "Algorithm",
              value: "rls",
              desc: "RLS training",
            },
            {
              key: "rlsLambda",
              type: "number",
              label: "RLS Lambda",
              min: 0.9,
              max: 0.9999,
              step: 0.001,
              desc: "Forgetting factor",
            },
            {
              key: "rlsDelta",
              type: "number",
              label: "RLS Delta",
              min: 0.01,
              max: 100.0,
              step: 0.1,
              desc: "Initial P diagonal",
            },
            {
              key: "epsilon",
              type: "number",
              label: "Epsilon",
              min: 1e-12,
              max: 1e-4,
              step: 1e-9,
              desc: "Numerical stability",
            },
            {
              key: "l2Lambda",
              type: "number",
              label: "L2 Lambda",
              min: 0.0,
              max: 0.1,
              step: 0.0001,
              desc: "L2 regularization",
            },
            {
              key: "gradientClipNorm",
              type: "number",
              label: "Gradient Clip",
              min: 0.0,
              max: 10.0,
              step: 0.1,
              desc: "Max update norm",
            },
          ],
        },
        {
          id: "normalization",
          title: "Normalization",
          params: [
            {
              key: "normalizationEpsilon",
              type: "number",
              label: "Norm Epsilon",
              min: 1e-12,
              max: 1e-4,
              step: 1e-9,
              desc: "Stability constant",
            },
            {
              key: "normalizationWarmup",
              type: "number",
              label: "Norm Warmup",
              min: 1,
              max: 100,
              step: 1,
              desc: "Warmup samples",
            },
          ],
        },
        {
          id: "outlier",
          title: "Outlier Handling",
          params: [
            {
              key: "outlierThreshold",
              type: "number",
              label: "Threshold",
              min: 1.0,
              max: 5.0,
              step: 0.1,
              desc: "Z-score threshold",
            },
            {
              key: "outlierMinWeight",
              type: "number",
              label: "Min Weight",
              min: 0.0,
              max: 1.0,
              step: 0.01,
              desc: "Outlier min weight",
            },
          ],
        },
        {
          id: "uncertainty",
          title: "Uncertainty",
          params: [
            {
              key: "uncertaintyMultiplier",
              type: "number",
              label: "CI Multiplier",
              min: 1.0,
              max: 3.5,
              step: 0.01,
              desc: "1.96 = 95% CI",
            },
          ],
        },
        {
          id: "init",
          title: "Initialization",
          params: [
            {
              key: "weightInitScale",
              type: "number",
              label: "Weight Scale",
              min: 0.01,
              max: 1.0,
              step: 0.01,
              desc: "Initial weight scale",
            },
            {
              key: "seed",
              type: "number",
              label: "Seed",
              min: 0,
              max: 999999,
              step: 1,
              desc: "Random seed",
            },
            {
              key: "verbose",
              type: "boolean",
              label: "Verbose",
              desc: "Detailed logging",
            },
          ],
        },
      ];

      let state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "focus",
        selectedDim: 0,
        selectedStep: 0,
        isDark: false,
        logs: [],
        pendingRequests: new Map(),
        currentRequestId: null,
        uploadedData: null,
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        sidePanelOpen: false,
        isLoading: false,
        loadingCount: 0,
      };

      let worker = null,
        workerReady = false,
        workerReadyResolve = null,
        workerReadyPromise = null;
      let canvas, ctx, resizeObserver;

      function initApp() {
        loadPreferences();
        initTheme();
        initWorker();
        initCanvas();
        initConfigSections();
        updateUI();
        setupEventListeners();
        log("info", "App", "ESN Regression Studio initialized");
      }

      function loadPreferences() {
        try {
          const prefs = localStorage.getItem("esn-prefs");
          if (prefs) {
            const p = JSON.parse(prefs);
            if (p.config) {
              state.config = { ...DEFAULT_CONFIG, ...p.config };
            }
            if (p.vizMode) state.vizMode = p.vizMode;
            if (p.isDark !== undefined) state.isDark = p.isDark;
          }
        } catch (e) {}
      }

      function savePreferences() {
        try {
          localStorage.setItem(
            "esn-prefs",
            JSON.stringify({
              config: state.config,
              vizMode: state.vizMode,
              isDark: state.isDark,
            }),
          );
        } catch (e) {}
      }

      function initTheme() {
        if (state.isDark) {
          document.documentElement.classList.add("dark");
        } else document.documentElement.classList.remove("dark");
      }

      function toggleTheme() {
        state.isDark = !state.isDark;
        initTheme();
        savePreferences();
        renderChart();
      }

      function getModuleUrl() {
        const input = document.getElementById("module-url-input");
        return input
          ? input.value
          : "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.3.5";
      }

      function initWorker() {
        workerReady = false;
        workerReadyPromise = new Promise((resolve) => {
          workerReadyResolve = resolve;
        });
        const workerCode = `
let ESNRegression = null, model = null, modelConfig = null;
let moduleUrl = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.3.5';
let cancelled = new Set();

async function loadModule(url) {
  moduleUrl = url || moduleUrl;
  try {
    const mod = await import(moduleUrl);
    ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module');
    return { success: true };
  } catch (e1) {
    try {
      const resp = await fetch(moduleUrl);
      const text = await resp.text();
      const blob = new Blob([text], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      const mod = await import(blobUrl);
      ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
      URL.revokeObjectURL(blobUrl);
      if (!ESNRegression) throw new Error('ESNRegression not found');
      return { success: true };
    } catch (e2) {
      return { success: false, error: 'Failed to load ESNRegression: ' + e1.message + ' / ' + e2.message };
    }
  }
}

function emitProgress(requestId, processed, total, stage) {
  self.postMessage({ type: 'progress', requestId, payload: { processed, total, percent: Math.round(processed/total*100), stage } });
}

self.onmessage = async function(e) {
  const { requestId, type, payload } = e.data;
  if (type === 'cancel') { cancelled.add(payload.requestId); return; }
  try {
    let result;
    if (type === 'init') {
      const loadResult = await loadModule(payload.moduleUrl);
      if (!loadResult.success) { self.postMessage({ requestId, type: 'error', payload: { error: loadResult.error }}); return; }
      result = { initialized: true };
    }
    else if (type === 'createModel') {
      if (!ESNRegression) { self.postMessage({ requestId, type: 'error', payload: { error: 'Module not loaded' }}); return; }
      modelConfig = payload.config;
      model = new ESNRegression(modelConfig);
      result = { created: true, config: modelConfig };
    }
    else if (type === 'train') {
      if (!model) { self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }}); return; }
      const { coordinates } = payload;
      const total = coordinates.length;
      let lastResult = null;
      for (let i = 0; i < total-1; i++) {
        if (cancelled.has(requestId)) { cancelled.delete(requestId); self.postMessage({ requestId, type: 'cancelled', payload: { processed: i }}); return; }
        lastResult = model.fitOnline({ coordinates: [coordinates[i], coordinates[i+1]] });
        if (total > 10 && i % Math.max(1, Math.floor(total/50)) === 0) emitProgress(requestId, i+1, total, 'Training');
      }
      const summary = model.getModelSummary();
      result = { trained: true, samplesProcessed: total, summary, fitResult: lastResult };
    }
    else if (type === 'predict') {
      if (!model) { self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }}); return; }
      const prediction = model.predict(payload.futureSteps);
      const summary = model.getModelSummary();
      result = { predictions: prediction.predictions.slice(0, payload.futureSteps), lowerBounds: prediction.lowerBounds.slice(0, payload.futureSteps), upperBounds: prediction.upperBounds.slice(0, payload.futureSteps), confidence: prediction.confidence, nFeatures: summary.nFeatures };
    }
    else if (type === 'save') {
      if (!model) { self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }}); return; }
      const savedState = model.save();
      const summary = model.getModelSummary();
      result = { modelState: savedState, meta: { config: modelConfig, nFeatures: summary.nFeatures, sampleCount: summary.sampleCount, createdAt: new Date().toISOString(), appVersion: '1.0.0' }};
    }
    else if (type === 'load') {
      if (!ESNRegression) { self.postMessage({ requestId, type: 'error', payload: { error: 'Module not loaded' }}); return; }
      let modelState, meta;
      if (typeof payload.data === 'string') { modelState = payload.data; meta = null; }
      else if (payload.data.modelState) { modelState = payload.data.modelState; meta = payload.data.meta; }
      else { self.postMessage({ requestId, type: 'error', payload: { error: 'Invalid model format' }}); return; }
      model = new ESNRegression();
      model.load(modelState);
      const summary = model.getModelSummary();
      modelConfig = meta?.config || {};
      result = { loaded: true, summary, meta };
    }
    else if (type === 'getSummary') {
      if (!model) result = { exists: false };
      else { const summary = model.getModelSummary(); result = { exists: true, summary }; }
    }
    else if (type === 'reset') { if (model) model.reset(); model = null; result = { reset: true }; }
    self.postMessage({ requestId, type: 'result', payload: result });
  } catch (err) { self.postMessage({ requestId, type: 'error', payload: { error: err.message || String(err) }}); }
};`;
        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });
        worker.onmessage = (e) => {
          const { requestId, type, payload } = e.data;
          if (type === "progress") {
            if (payload && payload.processed !== undefined) {
              updateProgress(
                payload.processed,
                payload.total,
                payload.stage || "Processing",
              );
            }
            return;
          }
          const pending = state.pendingRequests.get(requestId);
          if (pending) {
            state.pendingRequests.delete(requestId);
            if (type === "error") {
              pending.reject(
                new Error(payload?.error || "Unknown error"),
              );
            } else if (type === "cancelled") {
              pending.resolve({ cancelled: true, ...payload });
            } else pending.resolve(payload);
          }
        };
        worker.onerror = (e) => {
          console.error("Worker error:", e);
          showToast(
            "error",
            "Worker error: " + (e.message || "Unknown"),
          );
          hideLoadingForce();
        };
        workerRequest("init", { moduleUrl: getModuleUrl() }).then(
          () => {
            workerReady = true;
            if (workerReadyResolve) workerReadyResolve();
            log("success", "Worker", "ESNRegression module loaded");
          },
        ).catch((err) => {
          log("error", "Worker", err.message);
          showToast("error", "Failed to load module. Check Settings.");
        });
      }

      async function reinitializeWorker() {
        if (worker) {
          worker.terminate();
          state.pendingRequests.clear();
        }
        state.modelExists = false;
        state.predictions = null;
        state.sampleCount = 0;
        state.nDimensions = 0;
        hideLoadingForce();
        initWorker();
        showToast("info", "Worker reinitialized");
        closeModal("settings-modal");
        updateUI();
        renderChart();
      }

      async function workerRequest(type, payload = {}) {
        if (type !== "init" && !workerReady) await workerReadyPromise;
        return new Promise((resolve, reject) => {
          const requestId = crypto.randomUUID();
          state.pendingRequests.set(requestId, { resolve, reject });
          state.currentRequestId = requestId;
          worker.postMessage({ requestId, type, payload });
        });
      }

      function cancelOperation() {
        if (state.currentRequestId) {
          worker.postMessage({
            requestId: "",
            type: "cancel",
            payload: { requestId: state.currentRequestId },
          });
          log("warning", "Operation", "Cancelled by user");
          hideLoadingForce();
        }
      }

      function initCanvas() {
        canvas = document.getElementById("main-canvas");
        ctx = canvas.getContext("2d");
        resizeObserver = new ResizeObserver(debounce(() => {
          resizeCanvas();
          renderChart();
        }, 150));
        resizeObserver.observe(canvas.parentElement);
        canvas.addEventListener("mousemove", handleCanvasHover);
        canvas.addEventListener("mouseleave", handleCanvasLeave);
        canvas.addEventListener("touchstart", handleTouchStart, {
          passive: true,
        });
        canvas.addEventListener("touchmove", handleTouchMove, {
          passive: true,
        });
        canvas.addEventListener("touchend", handleTouchEnd, {
          passive: true,
        });
        canvas.addEventListener("wheel", handleCanvasWheel, {
          passive: false,
        });
        canvas.addEventListener("click", handleCanvasClick);
        resizeCanvas();
      }

      function resizeCanvas() {
        const container = canvas.parentElement;
        const rect = container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
      }

      function initConfigSections() {
        const container = document.getElementById("config-sections");
        container.innerHTML = CONFIG_SECTIONS.map((section) => `
          <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
            <button onclick="toggleSection('${section.id}')" class="w-full flex items-center justify-between px-4 py-3 bg-slate-50 dark:bg-slate-900/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left">
              <span class="font-semibold text-sm">${section.title}</span>
              <svg class="w-5 h-5 transform transition-transform section-chevron-${section.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div class="collapsible-content open section-content-${section.id}"><div class="p-4 space-y-4">${
          section.params.map((p) => renderConfigParam(p)).join("")
        }</div></div>
          </div>`).join("");
        updateConfigValues();
      }

      function renderConfigParam(p) {
        const value = state.config[p.key];
        if (p.type === "number") {
          return `<div class="space-y-1.5"><div class="flex items-center justify-between gap-2"><label class="text-sm font-medium">${p.label}</label><input type="number" id="cfg-${p.key}" value="${value}" min="${p.min}" max="${p.max}" step="${p.step}" class="w-20 sm:w-24 px-2 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm text-right focus-ring font-mono" onchange="updateConfigValue('${p.key}', this.value)"></div><p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p></div>`;
        }
        if (p.type === "boolean") {
          return `<div class="flex items-center justify-between gap-4"><div class="flex-1 min-w-0"><label class="text-sm font-medium">${p.label}</label><p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p></div><button onclick="toggleConfigBool('${p.key}')" class="relative w-12 h-7 rounded-full transition-colors flex-shrink-0 ${
            value ? "bg-blue-500" : "bg-slate-300 dark:bg-slate-600"
          }" id="cfg-${p.key}-btn"><span class="absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
            value ? "translate-x-5" : ""
          }"></span></button></div>`;
        }
        if (p.type === "select") {
          return `<div class="space-y-1.5"><label class="text-sm font-medium">${p.label}</label><select id="cfg-${p.key}" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring" onchange="updateConfigValue('${p.key}', this.value)">${
            p.options.map((o) =>
              `<option value="${o}" ${
                value === o ? "selected" : ""
              }>${o}</option>`
            ).join("")
          }</select><p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p></div>`;
        }
        if (p.type === "fixed") {
          return `<div class="flex items-center justify-between"><div><label class="text-sm font-medium">${p.label}</label><p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p></div><span class="px-3 py-1 bg-slate-200 dark:bg-slate-600 rounded-lg text-sm font-mono">${p.value}</span></div>`;
        }
        return "";
      }

      function toggleSection(id) {
        const content = document.querySelector(
          `.section-content-${id}`,
        );
        const chevron = document.querySelector(
          `.section-chevron-${id}`,
        );
        content.classList.toggle("open");
        chevron.classList.toggle("rotate-180");
      }
      function updateConfigValue(key, value) {
        const param = CONFIG_SECTIONS.flatMap((s) => s.params).find((
          p,
        ) => p.key === key);
        if (param?.type === "number") {
          state.config[key] = parseFloat(value);
        } else state.config[key] = value;
      }
      function toggleConfigBool(key) {
        state.config[key] = !state.config[key];
        updateConfigValues();
      }

      function updateConfigValues() {
        CONFIG_SECTIONS.flatMap((s) => s.params).forEach((p) => {
          if (p.type === "boolean") {
            const btn = document.getElementById(`cfg-${p.key}-btn`);
            if (btn) {
              btn.className =
                `relative w-12 h-7 rounded-full transition-colors flex-shrink-0 ${
                  state.config[p.key]
                    ? "bg-blue-500"
                    : "bg-slate-300 dark:bg-slate-600"
                }`;
              btn.querySelector("span").className =
                `absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                  state.config[p.key] ? "translate-x-5" : ""
                }`;
            }
          } else {
            const el = document.getElementById(`cfg-${p.key}`);
            if (el) el.value = state.config[p.key];
          }
        });
      }

      function applyPreset(preset) {
        state.config = { ...PRESETS[preset] };
        updateConfigValues();
        log("info", "Config", `Applied preset: ${preset}`);
      }
      function resetConfigToDefaults() {
        state.config = { ...DEFAULT_CONFIG };
        updateConfigValues();
        log("info", "Config", "Reset to defaults");
      }

      async function resetEverything() {
        if (!confirm("Clear model, data, and settings?")) return;
        state = {
          ...state,
          config: { ...DEFAULT_CONFIG },
          modelExists: false,
          nDimensions: 0,
          sampleCount: 0,
          predictions: null,
          logs: [],
          metrics: {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          },
        };
        localStorage.clear();
        try {
          await workerRequest("reset");
        } catch (e) {}
        updateConfigValues();
        updateUI();
        renderChart();
        log("warning", "Reset", "All data cleared");
        showToast("warning", "All data cleared");
      }

      async function startWithDefaults() {
        applyPreset("start-here");
        await createModel();
      }

      async function createModel() {
        showLoading("Creating model...");
        try {
          await workerRequest("createModel", { config: state.config });
          state.modelExists = true;
          state.sampleCount = 0;
          state.predictions = null;
          savePreferences();
          updateUI();
          renderChart();
          closeModal("config-modal");
          log("success", "Model", "Model created");
          showToast("success", "Model created");
        } catch (err) {
          log("error", "Model", err.message);
          showToast("error", "Failed: " + err.message);
        } finally {
          hideLoading();
        }
      }

      function setupEventListeners() {
        document.addEventListener("keydown", (e) => {
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA" ||
            e.target.tagName === "SELECT"
          ) return;
          if (e.key === "m" || e.key === "M") toggleMainMenu();
          else if (e.key === "c" || e.key === "C") {
            openModal("config-modal");
          } else if (e.key === "u" || e.key === "U") {
            openModal("upload-modal");
          } else if (
            (e.key === "p" || e.key === "P") && state.modelExists
          ) runPrediction();
          else if (e.key === "Escape") closeAllModals();
          else if (e.key === "?") openModal("shortcuts-modal");
        });
        setVisualizationMode(state.vizMode);
      }

      function toggleMainMenu() {
        const menu = document.getElementById("main-menu");
        const overlay = document.getElementById("main-menu-overlay");
        const isOpen = !menu.classList.contains("translate-x-full");
        if (isOpen) {
          menu.classList.add("translate-x-full");
          overlay.classList.add("hidden");
        } else {
          menu.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        }
      }
      function toggleSidePanel() {
        const panel = document.getElementById("side-panel");
        state.sidePanelOpen = !state.sidePanelOpen;
        if (state.sidePanelOpen) {
          panel.classList.remove("hidden");
          panel.classList.add("flex");
        } else {
          panel.classList.add("hidden");
          panel.classList.remove("flex");
        }
      }
      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.body.style.overflow = "hidden";
        if (id === "load-modal") updateSavedModelsList();
      }
      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
        if (!document.querySelector('[id$="-modal"]:not(.hidden)')) {
          document.body.style.overflow = "";
        }
      }
      function closeAllModals() {
        [
          "config-modal",
          "upload-modal",
          "insert-modal",
          "load-modal",
          "random-test-modal",
          "settings-modal",
          "data-table-modal",
          "shortcuts-modal",
        ].forEach(closeModal);
        const menu = document.getElementById("main-menu");
        if (!menu.classList.contains("translate-x-full")) {
          toggleMainMenu();
        }
        document.body.style.overflow = "";
      }
      function showLoading(text = "Processing...") {
        state.loadingCount++;
        state.isLoading = true;
        document.getElementById("loading-state").classList.remove(
          "hidden",
        );
        document.getElementById("loading-text").textContent = text;
        document.getElementById("progress-container").classList.add(
          "hidden",
        );
      }
      function hideLoading() {
        state.loadingCount = Math.max(0, state.loadingCount - 1);
        if (state.loadingCount === 0) {
          state.isLoading = false;
          document.getElementById("loading-state").classList.add(
            "hidden",
          );
        }
      }
      function hideLoadingForce() {
        state.loadingCount = 0;
        state.isLoading = false;
        document.getElementById("loading-state").classList.add(
          "hidden",
        );
      }
      function updateProgress(processed, total, stage) {
        const container = document.getElementById("progress-container");
        const bar = document.getElementById("progress-bar");
        const text = document.getElementById("progress-text");
        container.classList.remove("hidden");
        const pct = Math.round(processed / total * 100);
        bar.style.width = pct + "%";
        text.textContent = `${stage}: ${processed}/${total} (${pct}%)`;
      }
      function showToast(type, message) {
        const container = document.getElementById("toast-container");
        const colors = {
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };
        const toast = document.createElement("div");
        toast.className =
          `toast-enter px-4 py-3 rounded-xl shadow-2xl text-white flex items-center gap-3 ${
            colors[type]
          }`;
        toast.innerHTML =
          `<span class="flex-1 text-sm font-medium">${message}</span><button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded-lg flex-shrink-0"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>`;
        container.appendChild(toast);
        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : 4000,
        );
      }
      function log(type, category, message) {
        const entry = { type, category, message, time: new Date() };
        state.logs.unshift(entry);
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }
      function renderLogs() {
        const container = document.getElementById("event-log");
        const filter = document.getElementById("log-filter").value;
        const search = document.getElementById("log-search").value
          .toLowerCase();
        const filtered = state.logs.filter((l) => {
          if (filter !== "all" && l.type !== filter) return false;
          if (
            search && !l.message.toLowerCase().includes(search) &&
            !l.category.toLowerCase().includes(search)
          ) return false;
          return true;
        });
        container.innerHTML = filtered.slice(0, 50).map((l) => {
          const colors = {
            info: "text-blue-500",
            success: "text-emerald-500",
            warning: "text-amber-500",
            error: "text-red-500",
          };
          return `<div class="text-xs p-2.5 bg-slate-50 dark:bg-slate-900/50 rounded-lg"><div class="flex items-center gap-2 mb-1"><span class="${
            colors[l.type]
          } font-semibold">${l.category}</span><span class="text-slate-400">${l.time.toLocaleTimeString()}</span></div><p class="text-slate-600 dark:text-slate-300">${l.message}</p></div>`;
        }).join("");
      }
      function filterLogs() {
        renderLogs();
      }

      function updateUI() {
        const statusDot = document.getElementById("status-dot");
        const statusText = document.getElementById("status-text");
        const emptyState = document.getElementById("empty-state");
        const chartControls = document.getElementById("chart-controls");
        const predictBtnHeader = document.getElementById(
          "predict-btn-header",
        );
        const predictBtnSide = document.getElementById(
          "predict-btn-side",
        );
        const predictBtnMobile = document.getElementById(
          "predict-btn-mobile",
        );

        if (state.modelExists) {
          statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
          statusText.textContent = `${state.sampleCount} steps`;
          emptyState.classList.add("hidden");
          if (predictBtnHeader) {
            predictBtnHeader.classList.remove("hidden");
          }
          if (predictBtnSide) predictBtnSide.disabled = false;
          if (predictBtnMobile) predictBtnMobile.disabled = false;
        } else {
          statusDot.className =
            "w-2 h-2 rounded-full bg-slate-400 animate-pulse";
          statusText.textContent = "No Model";
          if (!state.predictions) emptyState.classList.remove("hidden");
          if (predictBtnHeader) {
            predictBtnHeader.classList.add("hidden");
          }
          if (predictBtnSide) predictBtnSide.disabled = true;
          if (predictBtnMobile) predictBtnMobile.disabled = true;
        }
        chartControls.classList.toggle("hidden", !state.predictions);
        document.getElementById("metric-samples").textContent =
          state.sampleCount;
        document.getElementById("metric-loss").textContent =
          state.metrics.avgLoss !== null
            ? state.metrics.avgLoss.toExponential(3)
            : "-";
        document.getElementById("metric-gradient").textContent =
          state.metrics.gradientNorm !== null
            ? state.metrics.gradientNorm.toExponential(3)
            : "-";
        document.getElementById("metric-weight").textContent =
          state.metrics.sampleWeight !== null
            ? state.metrics.sampleWeight.toFixed(3)
            : "-";
        updateDimensionButtons();
        updateStatsBar();
        updateStepSelector();
      }

      function syncFutureSteps(val) {
        const v = Math.max(
          1,
          Math.min(parseInt(val) || 1, MAX_FUTURE_STEPS),
        );
        [
          "future-steps-range",
          "future-steps-input",
          "future-steps-range-mobile",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.value = v;
        });
        const display = document.getElementById("steps-display-mobile");
        if (display) display.textContent = v;
      }

      function setVisualizationMode(mode) {
        state.vizMode = mode;
        document.querySelectorAll(".viz-tab").forEach((btn) => {
          const isActive = btn.dataset.mode === mode;
          btn.classList.toggle("bg-gradient-to-r", isActive);
          btn.classList.toggle("from-blue-500", isActive);
          btn.classList.toggle("to-indigo-600", isActive);
          btn.classList.toggle("text-white", isActive);
          btn.classList.toggle("shadow-lg", isActive);
          btn.classList.toggle("shadow-blue-500/25", isActive);
          btn.classList.toggle("bg-slate-100", !isActive);
          btn.classList.toggle("dark:bg-slate-700/50", !isActive);
        });
        document.getElementById("dimension-selector").classList.toggle(
          "hidden",
          mode !== "focus",
        );
        document.getElementById("stats-bar").classList.toggle(
          "hidden",
          mode !== "focus",
        );
        document.getElementById("step-selector").classList.toggle(
          "hidden",
          mode !== "bar",
        );
        savePreferences();
        renderChart();
      }

      function updateDimensionButtons() {
        const container = document.getElementById("dim-buttons");
        if (!state.predictions || state.nDimensions === 0) {
          container.innerHTML = "";
          return;
        }
        container.innerHTML = Array.from(
          { length: state.nDimensions },
          (_, i) => `
          <button onclick="selectDimension(${i})" class="touch-target px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all flex-shrink-0 ${
            state.selectedDim === i
              ? "text-white shadow-md"
              : "bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600"
          }" style="${
            state.selectedDim === i ? "background:" + getColor(i) : ""
          }">D${i + 1}</button>`,
        ).join("");
      }

      function selectDimension(i) {
        state.selectedDim = i;
        updateDimensionButtons();
        updateStatsBar();
        renderChart();
      }

      function updateStepSelector() {
        if (!state.predictions || state.vizMode !== "bar") return;
        const maxStep = state.predictions.predictions.length - 1;
        const rangeEl = document.getElementById("snapshot-step-range");
        const inputEl = document.getElementById("snapshot-step-input");
        if (rangeEl) {
          rangeEl.max = maxStep;
          rangeEl.value = state.selectedStep;
        }
        if (inputEl) {
          inputEl.max = maxStep + 1;
          inputEl.value = state.selectedStep + 1;
        }
      }

      function setSnapshotStep(step) {
        if (!state.predictions) return;
        const maxStep = state.predictions.predictions.length - 1;
        state.selectedStep = Math.max(0, Math.min(step, maxStep));
        updateStepSelector();
        renderChart();
      }

      function updateStatsBar() {
        if (!state.predictions || state.vizMode !== "focus") return;
        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const trend = preds.length > 1
          ? (preds[preds.length - 1] - preds[0])
          : 0;
        document.getElementById("stat-min").textContent = formatNumber(
          min,
        );
        document.getElementById("stat-max").textContent = formatNumber(
          max,
        );
        document.getElementById("stat-mean").textContent = formatNumber(
          mean,
        );
        document.getElementById("stat-final").textContent =
          formatNumber(final);
        document.getElementById("stat-trend").innerHTML =
          `<span class="${
            trend >= 0 ? "text-emerald-500" : "text-red-500"
          }">${trend >= 0 ? "" : ""} ${
            formatNumber(Math.abs(trend))
          }</span>`;
        document.getElementById("stat-confidence").textContent = `${
          (state.predictions.confidence * 100).toFixed(0)
        }%`;
      }

      function getColor(index) {
        return COLORS[index % COLORS.length];
      }
      function formatNumber(n) {
        if (Math.abs(n) < 0.01 || Math.abs(n) >= 10000) {
          return n.toExponential(2);
        }
        return n.toFixed(Math.abs(n) < 1 ? 3 : 2);
      }

      function renderChart() {
        if (!canvas || !ctx) return;
        const dpr = window.devicePixelRatio || 1;
        const w = canvas.width / dpr;
        const h = canvas.height / dpr;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        const isDark = state.isDark;
        ctx.fillStyle = isDark ? "#0F172A" : "#FFFFFF";
        ctx.fillRect(0, 0, w, h);
        if (!state.predictions || state.nDimensions === 0) return;
        switch (state.vizMode) {
          case "grid":
            renderGridView(w, h, isDark);
            break;
          case "focus":
            renderFocusView(w, h, isDark);
            break;
          case "heatmap":
            renderHeatmapView(w, h, isDark);
            break;
          case "uncertainty":
            renderUncertaintyView(w, h, isDark);
            break;
          case "bar":
            renderBarView(w, h, isDark);
            break;
        }
      }

      function renderFocusView(w, h, isDark) {
        const isMobile = w < 400;
        const margin = {
          left: isMobile ? 45 : 65,
          right: isMobile ? 15 : 24,
          top: 24,
          bottom: isMobile ? 35 : 45,
        };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;
        const dim = state.selectedDim;
        const allPreds = state.predictions.predictions.map((p) =>
          p[dim]
        );
        const allLowers = state.predictions.lowerBounds.map((p) =>
          p[dim]
        );
        const allUppers = state.predictions.upperBounds.map((p) =>
          p[dim]
        );
        const totalPoints = allPreds.length;
        const visibleCount = Math.max(
          2,
          Math.ceil(totalPoints / state.zoom.level),
        );
        const maxStartIndex = Math.max(0, totalPoints - visibleCount);
        const startIndex = Math.min(
          Math.max(0, Math.floor(state.zoom.offsetX)),
          maxStartIndex,
        );
        const endIndex = Math.min(
          startIndex + visibleCount,
          totalPoints,
        );
        state.zoom.visibleStart = startIndex;
        state.zoom.visibleCount = endIndex - startIndex;
        const preds = allPreds.slice(startIndex, endIndex);
        const lowers = allLowers.slice(startIndex, endIndex);
        const uppers = allUppers.slice(startIndex, endIndex);
        const allVals = [...preds, ...lowers, ...uppers];
        let minY = Math.min(...allVals);
        let maxY = Math.max(...allVals);
        const padding = (maxY - minY) * 0.12 || 1;
        minY -= padding;
        maxY += padding;
        const xScale = (i) =>
          margin.left + (i / (preds.length - 1 || 1)) * plotW;
        const yScale = (v) =>
          margin.top + plotH - ((v - minY) / (maxY - minY)) * plotH;
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.05)"
          : "rgba(0,0,0,0.05)";
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;
        const yTicks = niceScale(minY, maxY, 5);
        yTicks.forEach((tick) => {
          const y = yScale(tick);
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(w - margin.right, y);
          ctx.stroke();
        });
        ctx.setLineDash([]);
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.15)"
          : "rgba(0,0,0,0.15)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, h - margin.bottom);
        ctx.lineTo(w - margin.right, h - margin.bottom);
        ctx.stroke();
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = `500 ${isMobile ? 9 : 11}px system-ui`;
        ctx.textAlign = "right";
        yTicks.forEach((tick) => {
          ctx.fillText(
            formatNumber(tick),
            margin.left - 6,
            yScale(tick) + 4,
          );
        });
        ctx.textAlign = "center";
        const xStep = Math.max(
          1,
          Math.ceil(preds.length / (isMobile ? 5 : 8)),
        );
        for (let i = 0; i < preds.length; i += xStep) {
          ctx.fillText(
            startIndex + i + 1,
            xScale(i),
            h - margin.bottom + (isMobile ? 14 : 18),
          );
        }
        const color = getColor(dim);
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(uppers[0]));
        for (let i = 1; i < preds.length; i++) {
          ctx.lineTo(xScale(i), yScale(uppers[i]));
        }
        for (let i = preds.length - 1; i >= 0; i--) {
          ctx.lineTo(xScale(i), yScale(lowers[i]));
        }
        ctx.closePath();
        const gradient = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          h - margin.bottom,
        );
        gradient.addColorStop(0, color + (isDark ? "20" : "15"));
        gradient.addColorStop(1, color + (isDark ? "08" : "05"));
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.strokeStyle = color + "40";
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i < preds.length; i++) {
          if (i === 0) ctx.moveTo(xScale(i), yScale(uppers[i]));
          else ctx.lineTo(xScale(i), yScale(uppers[i]));
        }
        ctx.stroke();
        ctx.beginPath();
        for (let i = 0; i < preds.length; i++) {
          if (i === 0) ctx.moveTo(xScale(i), yScale(lowers[i]));
          else ctx.lineTo(xScale(i), yScale(lowers[i]));
        }
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        [[8, "1A"], [4, "33"], [isMobile ? 2 : 2.5, "FF"]].forEach(
          ([lw, alpha]) => {
            ctx.strokeStyle = color + alpha;
            ctx.lineWidth = lw;
            ctx.beginPath();
            ctx.moveTo(xScale(0), yScale(preds[0]));
            for (let i = 1; i < preds.length; i++) {
              const x0 = xScale(i - 1), y0 = yScale(preds[i - 1]);
              const x1 = xScale(i), y1 = yScale(preds[i]);
              const cpx = (x0 + x1) / 2;
              ctx.quadraticCurveTo(
                cpx,
                y0,
                (cpx + x1) / 2,
                (y0 + y1) / 2,
              );
            }
            ctx.lineTo(
              xScale(preds.length - 1),
              yScale(preds[preds.length - 1]),
            );
            ctx.stroke();
          },
        );
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const localIdx = state.hover.dataIndex;
          if (localIdx >= 0 && localIdx < preds.length) {
            const hx = xScale(localIdx);
            const hy = yScale(preds[localIdx]);
            const actualIdx = startIndex + localIdx;
            ctx.strokeStyle = isDark
              ? "rgba(255,255,255,0.3)"
              : "rgba(0,0,0,0.2)";
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(hx, margin.top);
            ctx.lineTo(hx, h - margin.bottom);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(margin.left, hy);
            ctx.lineTo(hx, hy);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.strokeStyle = color + "40";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(hx, hy, 8, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(hx, hy, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.stroke();
            updateTooltip(
              hx,
              hy,
              actualIdx,
              dim,
              preds[localIdx],
              lowers[localIdx],
              uppers[localIdx],
              w,
              h,
            );
          }
        }
      }

      function renderGridView(w, h, isDark) {
        const nDims = state.nDimensions;
        if (nDims === 0) return;
        const isMobile = w < 500;
        const cols = w < 400
          ? 2
          : w < 640
          ? 2
          : w < 1024
          ? 3
          : w < 1400
          ? 4
          : 5;
        const gap = isMobile ? 6 : 10;
        const cellW = Math.floor(
          (w - gap * 2 - gap * (cols - 1)) / cols,
        );
        const cellH = Math.min(
          isMobile ? 80 : 110,
          Math.floor((h - gap * 2) / Math.ceil(nDims / cols)) - gap,
        );
        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = gap + col * (cellW + gap);
          const y = gap + row * (cellH + gap);
          if (y + cellH > h) continue;
          ctx.fillStyle = isDark ? "#1E293B" : "#F8FAFC";
          ctx.beginPath();
          ctx.roundRect(x, y, cellW, cellH, 8);
          ctx.fill();
          const preds = state.predictions.predictions.map((p) => p[d]);
          const lowers = state.predictions.lowerBounds.map((p) => p[d]);
          const uppers = state.predictions.upperBounds.map((p) => p[d]);
          const margin = 6;
          const pW = cellW - margin * 2;
          const pH = cellH - 24;
          const allVals = [...preds, ...lowers, ...uppers];
          let minY = Math.min(...allVals);
          let maxY = Math.max(...allVals);
          const pad = (maxY - minY) * 0.1 || 1;
          minY -= pad;
          maxY += pad;
          const xs = (i) =>
            x + margin + (i / (preds.length - 1 || 1)) * pW;
          const ys = (v) =>
            y + 18 + pH - ((v - minY) / (maxY - minY)) * pH;
          const color = getColor(d);
          ctx.fillStyle = color + "1A";
          ctx.beginPath();
          ctx.moveTo(xs(0), ys(uppers[0]));
          for (let i = 1; i < preds.length; i++) {
            ctx.lineTo(xs(i), ys(uppers[i]));
          }
          for (let i = preds.length - 1; i >= 0; i--) {
            ctx.lineTo(xs(i), ys(lowers[i]));
          }
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(xs(0), ys(preds[0]));
          for (let i = 1; i < preds.length; i++) {
            ctx.lineTo(xs(i), ys(preds[i]));
          }
          ctx.stroke();
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "600 9px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(`D${d + 1}`, x + 5, y + 12);
          ctx.textAlign = "right";
          ctx.fillStyle = color;
          ctx.fillText(
            formatNumber(preds[preds.length - 1]),
            x + cellW - 5,
            y + 12,
          );
        }
      }

      function renderHeatmapView(w, h, isDark) {
        const nDims = state.nDimensions;
        if (nDims === 0) return;
        const isMobile = w < 400;
        const margin = {
          left: isMobile ? 40 : 60,
          right: isMobile ? 30 : 40,
          top: 24,
          bottom: 30,
        };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;
        const steps = state.predictions.predictions.length;
        const cellW = Math.max(8, plotW / steps);
        const cellH = Math.max(8, plotH / nDims);
        const allVals = state.predictions.predictions.flat();
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;
        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < steps; s++) {
            const val = state.predictions.predictions[s][d];
            const norm = (val - minVal) / range;
            const cx = margin.left + s * cellW;
            const cy = margin.top + d * cellH;
            const r = Math.round(59 + (239 - 59) * norm);
            const g = Math.round(130 + (68 - 130) * norm);
            const b = Math.round(246 + (68 - 246) * norm);
            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(cx, cy, cellW - 1, cellH - 1);
          }
        }
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = `500 ${isMobile ? 8 : 10}px system-ui`;
        ctx.textAlign = "right";
        for (let d = 0; d < nDims; d++) {
          ctx.fillText(
            `D${d + 1}`,
            margin.left - 5,
            margin.top + d * cellH + cellH / 2 + 3,
          );
        }
        ctx.textAlign = "center";
        const xStep = Math.max(
          1,
          Math.ceil(steps / (isMobile ? 6 : 10)),
        );
        for (let s = 0; s < steps; s += xStep) {
          ctx.fillText(
            s + 1,
            margin.left + s * cellW + cellW / 2,
            h - margin.bottom + 14,
          );
        }
        const legendW = 20;
        const legendH = plotH;
        const legendX = w - margin.right + 10;
        const legendY = margin.top;
        const lgradient = ctx.createLinearGradient(
          0,
          legendY,
          0,
          legendY + legendH,
        );
        lgradient.addColorStop(0, "rgb(239, 68, 68)");
        lgradient.addColorStop(0.5, "rgb(59, 130, 246)");
        lgradient.addColorStop(1, "rgb(59, 130, 246)");
        ctx.fillStyle = lgradient;
        ctx.fillRect(legendX, legendY, legendW, legendH);
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = "500 9px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(
          formatNumber(maxVal),
          legendX + legendW + 4,
          legendY + 8,
        );
        ctx.fillText(
          formatNumber(minVal),
          legendX + legendW + 4,
          legendY + legendH,
        );
      }

      function renderUncertaintyView(w, h, isDark) {
        const nDims = state.nDimensions;
        if (nDims === 0) return;
        const isMobile = w < 400;
        const margin = {
          left: isMobile ? 45 : 65,
          right: isMobile ? 60 : 100,
          top: 40,
          bottom: 45,
        };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;
        const uncertainties = state.predictions.predictions.map(
          (_, i) => {
            let sum = 0;
            for (let d = 0; d < nDims; d++) {
              sum += state.predictions.upperBounds[i][d] -
                state.predictions.lowerBounds[i][d];
            }
            return sum / nDims;
          },
        );
        const maxU = Math.max(...uncertainties);
        const minU = Math.min(...uncertainties);
        const range = maxU - minU || 1;
        const xScale = (i) =>
          margin.left + (i / (uncertainties.length - 1 || 1)) * plotW;
        const yScale = (v) =>
          margin.top + plotH - ((v - minU) / range) * plotH;
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(minU));
        for (let i = 0; i < uncertainties.length; i++) {
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
        }
        ctx.lineTo(xScale(uncertainties.length - 1), yScale(minU));
        ctx.closePath();
        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          h - margin.bottom,
        );
        grad.addColorStop(0, "#EF444480");
        grad.addColorStop(0.5, "#F59E0B60");
        grad.addColorStop(1, "#10B98140");
        ctx.fillStyle = grad;
        ctx.fill();
        ctx.strokeStyle = "#F59E0B";
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(uncertainties[0]));
        for (let i = 1; i < uncertainties.length; i++) {
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
        }
        ctx.stroke();
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = `500 ${isMobile ? 9 : 11}px system-ui`;
        ctx.textAlign = "right";
        ctx.fillText(
          formatNumber(maxU),
          margin.left - 6,
          margin.top + 4,
        );
        ctx.fillText(
          formatNumber(minU),
          margin.left - 6,
          h - margin.bottom,
        );
        ctx.textAlign = "center";
        const xStep = Math.max(
          1,
          Math.ceil(uncertainties.length / (isMobile ? 5 : 8)),
        );
        for (let i = 0; i < uncertainties.length; i += xStep) {
          ctx.fillText(i + 1, xScale(i), h - margin.bottom + 14);
        }
        const conf = state.predictions.confidence;
        const gaugeX = w - (isMobile ? 35 : 55);
        const gaugeY = margin.top + 30;
        const gaugeR = isMobile ? 25 : 35;
        ctx.beginPath();
        ctx.arc(gaugeX, gaugeY, gaugeR, Math.PI, 2 * Math.PI);
        ctx.strokeStyle = isDark ? "#374151" : "#E5E7EB";
        ctx.lineWidth = 6;
        ctx.stroke();
        const confColor = conf > 0.8
          ? "#10B981"
          : conf > 0.5
          ? "#F59E0B"
          : "#EF4444";
        ctx.beginPath();
        ctx.arc(
          gaugeX,
          gaugeY,
          gaugeR,
          Math.PI,
          Math.PI + conf * Math.PI,
        );
        ctx.strokeStyle = confColor;
        ctx.stroke();
        ctx.fillStyle = isDark ? "#F1F5F9" : "#1E293B";
        ctx.font = `bold ${isMobile ? 12 : 16}px system-ui`;
        ctx.textAlign = "center";
        ctx.fillText(`${(conf * 100).toFixed(0)}%`, gaugeX, gaugeY + 5);
        ctx.font = `500 ${isMobile ? 8 : 10}px system-ui`;
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.fillText(
          "Confidence",
          gaugeX,
          gaugeY + (isMobile ? 18 : 22),
        );
      }

      function renderBarView(w, h, isDark) {
        const nDims = state.nDimensions;
        if (nDims === 0) return;
        const isMobile = w < 400;
        const margin = {
          left: isMobile ? 50 : 80,
          right: 24,
          top: 24,
          bottom: 40,
        };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;
        const step = Math.min(
          state.selectedStep,
          state.predictions.predictions.length - 1,
        );
        const preds = state.predictions.predictions[step];
        const lowers = state.predictions.lowerBounds[step];
        const uppers = state.predictions.upperBounds[step];
        const maxVal = Math.max(...uppers);
        const minVal = Math.min(...lowers, 0);
        const range = maxVal - minVal || 1;
        const barH = Math.min(isMobile ? 20 : 28, plotH / nDims - 3);
        for (let d = 0; d < nDims; d++) {
          const y = margin.top + d * (barH + 3);
          const val = preds[d];
          const lower = lowers[d];
          const upper = uppers[d];
          const barW = Math.max(4, ((val - minVal) / range) * plotW);
          const errorStart = ((lower - minVal) / range) * plotW;
          const errorEnd = ((upper - minVal) / range) * plotW;
          const color = getColor(d);
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.roundRect(margin.left, y, barW, barH, 4);
          ctx.fill();
          ctx.strokeStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.lineWidth = 1.5;
          const ey = y + barH / 2;
          ctx.beginPath();
          ctx.moveTo(margin.left + errorStart, ey);
          ctx.lineTo(margin.left + errorEnd, ey);
          ctx.moveTo(margin.left + errorStart, ey - 3);
          ctx.lineTo(margin.left + errorStart, ey + 3);
          ctx.moveTo(margin.left + errorEnd, ey - 3);
          ctx.lineTo(margin.left + errorEnd, ey + 3);
          ctx.stroke();
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = `500 ${isMobile ? 9 : 11}px system-ui`;
          ctx.textAlign = "right";
          ctx.fillText(`D${d + 1}`, margin.left - 6, y + barH / 2 + 4);
          ctx.textAlign = "left";
          ctx.fillText(
            formatNumber(val),
            margin.left + barW + 6,
            y + barH / 2 + 4,
          );
        }
        ctx.fillStyle = isDark ? "#F1F5F9" : "#1E293B";
        ctx.font = "bold 12px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(`Step ${step + 1}`, w / 2, h - 10);
      }

      function updateTooltip(
        x,
        y,
        idx,
        dim,
        pred,
        lower,
        upper,
        canvasW,
        canvasH,
      ) {
        const tooltip = document.getElementById("chart-tooltip");
        const content = document.getElementById("tooltip-content");
        content.innerHTML =
          `<div class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Step</div><div class="text-xl font-bold mb-2">${
            idx + 1
          }</div><hr class="border-slate-200 dark:border-slate-700 my-2"><div class="flex items-center gap-2 mb-1"><span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background:${
            getColor(dim)
          }"></span><span class="text-sm font-medium">Dim ${
            dim + 1
          }</span><span class="ml-auto font-bold">${
            formatNumber(pred)
          }</span></div><div class="text-[11px] text-slate-500 dark:text-slate-400 space-y-0.5"><div>Bounds: ${
            formatNumber(lower)
          }  ${formatNumber(upper)}</div><div>Spread: ${
            formatNumber(upper - lower)
          }</div></div>`;
        let tx = x + 16;
        let ty = y - 20;
        if (tx + 180 > canvasW) tx = x - 180;
        if (ty < 10) ty = y + 20;
        if (tx < 10) tx = 10;
        tooltip.style.left = tx + "px";
        tooltip.style.top = ty + "px";
        tooltip.style.opacity = "1";
      }

      function hideTooltip() {
        document.getElementById("chart-tooltip").style.opacity = "0";
      }

      function handleCanvasHover(e) {
        if (!state.predictions || state.vizMode !== "focus") return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const w = rect.width;
        const isMobile = w < 400;
        const margin = {
          left: isMobile ? 45 : 65,
          right: isMobile ? 15 : 24,
        };
        const plotW = w - margin.left - margin.right;
        if (x < margin.left || x > w - margin.right) {
          state.hover.active = false;
          hideTooltip();
          renderChart();
          return;
        }
        const visibleCount = state.zoom.visibleCount ||
          state.predictions.predictions.length;
        const localIdx = Math.round(
          (x - margin.left) / plotW * (visibleCount - 1),
        );
        state.hover = {
          active: true,
          x,
          y: e.clientY - rect.top,
          dataIndex: Math.max(0, Math.min(visibleCount - 1, localIdx)),
        };
        canvas.style.cursor = "crosshair";
        renderChart();
      }

      function handleCanvasLeave() {
        state.hover.active = false;
        canvas.style.cursor = "default";
        hideTooltip();
        renderChart();
      }
      function handleTouchStart(e) {
        if (e.touches.length === 1) {
          handleCanvasHover({
            clientX: e.touches[0].clientX,
            clientY: e.touches[0].clientY,
          });
        }
      }
      function handleTouchMove(e) {
        if (e.touches.length === 1) {
          handleCanvasHover({
            clientX: e.touches[0].clientX,
            clientY: e.touches[0].clientY,
          });
        }
      }
      function handleTouchEnd() {
        setTimeout(() => {
          state.hover.active = false;
          hideTooltip();
          renderChart();
        }, 1500);
      }
      function handleCanvasWheel(e) {
        if (!e.ctrlKey && !e.metaKey) return;
        e.preventDefault();
        if (e.deltaY < 0) chartZoomIn();
        else chartZoomOut();
      }

      function handleCanvasClick(e) {
        if (state.vizMode === "grid" && state.predictions) {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const w = rect.width;
          const h = rect.height;
          const isMobile = w < 500;
          const cols = w < 400
            ? 2
            : w < 640
            ? 2
            : w < 1024
            ? 3
            : w < 1400
            ? 4
            : 5;
          const gap = isMobile ? 6 : 10;
          const cellW = Math.floor(
            (w - gap * 2 - gap * (cols - 1)) / cols,
          );
          const cellH = Math.min(
            isMobile ? 80 : 110,
            Math.floor(
              (h - gap * 2) / Math.ceil(state.nDimensions / cols),
            ) - gap,
          );
          const col = Math.floor((x - gap) / (cellW + gap));
          const row = Math.floor((y - gap) / (cellH + gap));
          const idx = row * cols + col;
          if (idx >= 0 && idx < state.nDimensions) {
            state.selectedDim = idx;
            setVisualizationMode("focus");
          }
        }
      }

      function chartZoomIn() {
        state.zoom.level = Math.min(5, state.zoom.level * 1.4);
        document.getElementById("zoom-badge").textContent =
          Math.round(state.zoom.level * 100) + "%";
        document.getElementById("zoom-badge").classList.remove(
          "hidden",
        );
        renderChart();
      }
      function chartZoomOut() {
        state.zoom.level = Math.max(1, state.zoom.level / 1.4);
        document.getElementById("zoom-badge").textContent =
          Math.round(state.zoom.level * 100) + "%";
        if (state.zoom.level <= 1.01) {
          document.getElementById("zoom-badge").classList.add("hidden");
        }
        renderChart();
      }
      function chartResetZoom() {
        state.zoom.level = 1;
        state.zoom.offsetX = 0;
        document.getElementById("zoom-badge").classList.add("hidden");
        renderChart();
      }

      function niceScale(min, max, ticks) {
        const range = max - min;
        const roughStep = range / ticks;
        const magnitude = Math.pow(
          10,
          Math.floor(Math.log10(roughStep)),
        );
        const residual = roughStep / magnitude;
        let niceStep;
        if (residual > 5) niceStep = 10 * magnitude;
        else if (residual > 2) niceStep = 5 * magnitude;
        else if (residual > 1) niceStep = 2 * magnitude;
        else niceStep = magnitude;
        const niceMin = Math.floor(min / niceStep) * niceStep;
        const niceMax = Math.ceil(max / niceStep) * niceStep;
        const result = [];
        for (let v = niceMin; v <= niceMax; v += niceStep) {
          result.push(v);
        }
        return result;
      }

      function validateDataset(data) {
        const errors = [];
        if (!data || typeof data !== "object") {
          return { valid: false, errors: ["Invalid JSON format"] };
        }
        if (!Array.isArray(data.coordinates)) {
          errors.push("Missing coordinates array");
        }
        if (errors.length) return { valid: false, errors };
        const coordLen = data.coordinates.length;
        if (coordLen === 0) errors.push("coordinates is empty");
        if (errors.length) return { valid: false, errors };
        let nDimensions = null;
        for (let i = 0; i < Math.min(coordLen, 20); i++) {
          if (!Array.isArray(data.coordinates[i])) {
            errors.push(`coordinates[${i}] not array`);
            continue;
          }
          if (nDimensions === null) {
            nDimensions = data.coordinates[i].length;
          }
          if (data.coordinates[i].length !== nDimensions) {
            errors.push(`coordinates[${i}] dimension mismatch`);
          }
          if (errors.length > 5) {
            errors.push("...more errors");
            break;
          }
        }
        if (errors.length) return { valid: false, errors };
        return { valid: true, nDimensions, sampleCount: coordLen };
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add(
          "border-blue-400",
          "dark:border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
      }
      function handleDragLeave(e) {
        e.currentTarget.classList.remove(
          "border-blue-400",
          "dark:border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
      }
      function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove(
          "border-blue-400",
          "dark:border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
        const file = e.dataTransfer.files[0];
        if (file) readFile(file);
      }
      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) readFile(file);
      }
      function readFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("upload-json-input").value =
            e.target.result;
          validateAndPreviewUpload();
        };
        reader.readAsText(file);
      }

      function validateAndPreviewUpload() {
        const input = document.getElementById("upload-json-input").value
          .trim();
        const preview = document.getElementById("upload-preview");
        const error = document.getElementById("upload-error");
        const applyBtn = document.getElementById("apply-upload-btn");
        preview.classList.add("hidden");
        error.classList.add("hidden");
        applyBtn.disabled = true;
        state.uploadedData = null;
        if (!input) return;
        let data;
        try {
          data = JSON.parse(input);
        } catch (e) {
          error.classList.remove("hidden");
          document.getElementById("upload-error-text").textContent =
            "Invalid JSON: " + e.message;
          return;
        }
        const result = validateDataset(data);
        if (!result.valid) {
          error.classList.remove("hidden");
          document.getElementById("upload-error-text").textContent =
            result.errors.join("\n");
          return;
        }
        preview.classList.remove("hidden");
        document.getElementById("preview-stats").innerHTML =
          `<div><span class="text-slate-500">Dimensions:</span> <strong>${result.nDimensions}</strong></div><div><span class="text-slate-500">Time Steps:</span> <strong>${result.sampleCount}</strong></div><div><span class="text-slate-500">Status:</span> <strong class="text-emerald-600">OK </strong></div>`;
        state.uploadedData = data;
        applyBtn.disabled = false;
      }

      async function applyUploadedData() {
        if (!state.uploadedData) return;
        if (!state.modelExists) {
          showToast("warning", "Create a model first");
          return;
        }
        showLoading("Training on uploaded data...");
        try {
          const result = await workerRequest(
            "train",
            state.uploadedData,
          );
          if (result.cancelled) {
            log("warning", "Training", "Cancelled");
            return;
          }
          state.sampleCount = result.summary.sampleCount;
          state.nDimensions = result.summary.nFeatures ||
            state.uploadedData.coordinates[0]?.length || 0;
          state.metrics = {
            avgLoss: result.fitResult?.averageLoss || null,
            gradientNorm: result.fitResult?.gradientNorm || null,
            sampleWeight: result.fitResult?.sampleWeight || null,
          };
          updateUI();
          closeModal("upload-modal");
          log(
            "success",
            "Training",
            `Trained on ${result.samplesProcessed} time steps`,
          );
          showToast(
            "success",
            `Trained on ${result.samplesProcessed} time steps`,
          );
          await runPredictionInternal();
        } catch (err) {
          log("error", "Training", err.message);
          showToast("error", "Training failed: " + err.message);
        } finally {
          hideLoading();
        }
      }

      function copyFormatExample() {
        navigator.clipboard.writeText(
          `{"coordinates": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1], [1.2, 2.2, 3.2]]}`,
        );
        showToast("success", "Copied to clipboard");
      }
      function generateInsertTemplate() {
        const nD = state.nDimensions || 3;
        document.getElementById("insert-json-input").value = JSON
          .stringify({ coordinates: [Array(nD).fill(0)] }, null, 2);
      }

      async function applyManualInsert() {
        const input = document.getElementById("insert-json-input").value
          .trim();
        if (!state.modelExists) {
          showToast("warning", "Create a model first");
          return;
        }
        let data;
        try {
          data = JSON.parse(input);
        } catch (e) {
          showToast("error", "Invalid JSON");
          return;
        }
        const result = validateDataset(data);
        if (!result.valid) {
          showToast("error", result.errors[0]);
          return;
        }
        showLoading("Inserting time steps...");
        try {
          const trainResult = await workerRequest("train", data);
          state.sampleCount = trainResult.summary.sampleCount;
          state.nDimensions = trainResult.summary.nFeatures ||
            data.coordinates[0]?.length || 0;
          state.metrics = {
            avgLoss: trainResult.fitResult?.averageLoss || null,
            gradientNorm: trainResult.fitResult?.gradientNorm || null,
            sampleWeight: trainResult.fitResult?.sampleWeight || null,
          };
          updateUI();
          closeModal("insert-modal");
          log(
            "success",
            "Insert",
            `Added ${result.sampleCount} time steps`,
          );
          showToast(
            "success",
            `Added ${result.sampleCount} time steps`,
          );
        } catch (err) {
          log("error", "Insert", err.message);
          showToast("error", err.message);
        } finally {
          hideLoading();
        }
      }

      async function runPrediction() {
        if (!state.modelExists) return;
        if (state.isLoading) return;
        showLoading("Running prediction...");
        try {
          await runPredictionInternal();
        } finally {
          hideLoading();
        }
      }

      async function runPredictionInternal() {
        const steps = parseInt(
          document.getElementById("future-steps-input").value,
        ) || 10;
        try {
          const result = await workerRequest("predict", {
            futureSteps: steps,
          });
          state.predictions = result;
          state.nDimensions = result.nFeatures ||
            (result.predictions[0]?.length || 0);
          document.getElementById("empty-state").classList.add(
            "hidden",
          );
          document.getElementById("chart-controls").classList.remove(
            "hidden",
          );
          updateDimensionButtons();
          updateStatsBar();
          updateStepSelector();
          renderChart();
          log(
            "success",
            "Prediction",
            `Generated ${steps}-step forecast`,
          );
        } catch (err) {
          log("error", "Prediction", err.message);
          showToast("error", "Prediction failed: " + err.message);
        }
      }

      async function downloadModel() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }
        showLoading("Saving model...");
        try {
          const result = await workerRequest("save");
          const blob = new Blob([
            JSON.stringify(
              { modelState: result.modelState, meta: result.meta },
              null,
              2,
            ),
          ], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-model-${
            new Date().toISOString().slice(0, 10)
          }.json`;
          a.click();
          URL.revokeObjectURL(url);
          log("success", "Save", "Model downloaded");
          showToast("success", "Model downloaded");
        } catch (err) {
          log("error", "Save", err.message);
          showToast("error", err.message);
        } finally {
          hideLoading();
        }
      }

      async function saveToLocalStorage() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }
        const name = prompt(
          "Model name:",
          `Model ${new Date().toLocaleString()}`,
        );
        if (!name) return;
        showLoading("Saving model...");
        try {
          const result = await workerRequest("save");
          const saved = JSON.parse(
            localStorage.getItem("esn-saved-models") || "{}",
          );
          saved[name] = {
            modelState: result.modelState,
            meta: result.meta,
            savedAt: new Date().toISOString(),
          };
          localStorage.setItem(
            "esn-saved-models",
            JSON.stringify(saved),
          );
          log("success", "Save", `Saved as "${name}"`);
          showToast("success", `Saved as "${name}"`);
          updateSavedModelsList();
        } catch (err) {
          log("error", "Save", err.message);
          showToast("error", err.message);
        } finally {
          hideLoading();
        }
      }

      function updateSavedModelsList() {
        const container = document.getElementById("saved-models-list");
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        const names = Object.keys(saved);
        if (names.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-500 text-center py-4">No saved models</p>';
          return;
        }
        container.innerHTML = names.map((name) => {
          const model = saved[name];
          return `<div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl"><div class="min-w-0 flex-1"><p class="font-semibold text-sm truncate">${name}</p><p class="text-xs text-slate-500">${
            model.meta?.nFeatures || "?"
          } dimensions</p></div><button onclick="loadFromLocalStorage('${name}')" class="touch-target ml-2 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm font-semibold hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors flex-shrink-0">Load</button></div>`;
        }).join("");
      }

      async function loadFromLocalStorage(name) {
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        const model = saved[name];
        if (!model) {
          showToast("error", "Model not found");
          return;
        }
        showLoading("Loading model...");
        try {
          const result = await workerRequest("load", { data: model });
          state.modelExists = true;
          state.sampleCount = result.summary.sampleCount;
          state.nDimensions = result.summary.nFeatures || 0;
          if (result.meta?.config) {
            state.config = { ...DEFAULT_CONFIG, ...result.meta.config };
          }
          updateConfigValues();
          updateUI();
          closeModal("load-modal");
          log("success", "Load", `Loaded "${name}"`);
          showToast("success", `Model "${name}" loaded`);
        } catch (err) {
          log("error", "Load", err.message);
          showToast("error", err.message);
        } finally {
          hideLoading();
        }
      }

      async function loadModelFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          showLoading("Loading model...");
          try {
            let data;
            try {
              data = JSON.parse(ev.target.result);
            } catch {
              data = ev.target.result;
            }
            const result = await workerRequest("load", { data });
            state.modelExists = true;
            state.sampleCount = result.summary.sampleCount;
            state.nDimensions = result.summary.nFeatures || 0;
            if (result.meta?.config) {
              state.config = {
                ...DEFAULT_CONFIG,
                ...result.meta.config,
              };
            }
            updateConfigValues();
            updateUI();
            closeModal("load-modal");
            log("success", "Load", "Model loaded from file");
            showToast("success", "Model loaded");
          } catch (err) {
            log("error", "Load", err.message);
            showToast("error", err.message);
          } finally {
            hideLoading();
          }
        };
        reader.readAsText(file);
      }

      function clearLocalStorageModels() {
        if (!confirm("Delete all saved models?")) return;
        localStorage.removeItem("esn-saved-models");
        updateSavedModelsList();
        showToast("success", "Saved models cleared");
      }

      function seededRandom(seed) {
        let s = seed;
        return () => {
          s = (s * 9301 + 49297) % 233280;
          return s / 233280;
        };
      }
      async function runRandomTestFromModal() {
        closeModal("random-test-modal");
        await runRandomTest();
      }

      async function runRandomTest() {
        const seedEl = document.getElementById("test-seed");
        const dimEl = document.getElementById("test-dimensions");
        const samplesEl = document.getElementById("test-samples");
        const noiseEl = document.getElementById("test-noise");
        const outliersEl = document.getElementById("test-outliers");
        const diffEl = document.getElementById("test-difficulty");
        const seed = seedEl ? (parseInt(seedEl.value) || 42) : 42;
        const nDimensions = dimEl ? (parseInt(dimEl.value) || 3) : 3;
        const nSamples = samplesEl
          ? (parseInt(samplesEl.value) || 200)
          : 200;
        const noise = noiseEl
          ? (parseFloat(noiseEl.value) || 0.1)
          : 0.1;
        const outlierRate = outliersEl
          ? (parseFloat(outliersEl.value) || 0.02)
          : 0.02;
        const difficulty = diffEl
          ? (diffEl.value || "medium")
          : "medium";
        const rand = seededRandom(seed);
        const coordinates = [];
        for (let t = 0; t < nSamples; t++) {
          const point = [];
          for (let d = 0; d < nDimensions; d++) {
            let val = Math.sin(t * 0.1 * (d + 1) + d);
            if (difficulty !== "easy" && t > 0) {
              val += 0.2 * coordinates[t - 1][(d + 1) % nDimensions];
            }
            if (difficulty === "hard" && t > 1) {
              val += 0.1 *
                Math.cos(coordinates[t - 1][d] * coordinates[t - 2][d]);
            }
            val += (rand() - 0.5) * noise * 2;
            if (rand() < outlierRate) {
              val += (rand() > 0.5 ? 1 : -1) * (3 + rand() * 2);
            }
            point.push(val);
          }
          coordinates.push(point);
        }
        applyPreset("balanced");
        showLoading("Running demo...");
        try {
          await workerRequest("createModel", { config: state.config });
          state.modelExists = true;
          const trainResult = await workerRequest("train", {
            coordinates,
          });
          if (trainResult.cancelled) {
            log("warning", "Training", "Cancelled");
            return;
          }
          state.sampleCount = trainResult.summary.sampleCount;
          state.nDimensions = trainResult.summary.nFeatures ||
            nDimensions;
          state.metrics = {
            avgLoss: trainResult.fitResult?.averageLoss || null,
            gradientNorm: trainResult.fitResult?.gradientNorm || null,
            sampleWeight: trainResult.fitResult?.sampleWeight || null,
          };
          updateUI();
          const steps = Math.min(20, MAX_FUTURE_STEPS);
          const predResult = await workerRequest("predict", {
            futureSteps: steps,
          });
          state.predictions = predResult;
          state.nDimensions = predResult.nFeatures || nDimensions;
          document.getElementById("empty-state").classList.add(
            "hidden",
          );
          document.getElementById("chart-controls").classList.remove(
            "hidden",
          );
          updateDimensionButtons();
          updateStatsBar();
          updateStepSelector();
          setVisualizationMode("focus");
          renderChart();
          log(
            "success",
            "Demo",
            `Generated ${nSamples} time steps, trained, predicted ${steps} steps`,
          );
          showToast("success", "Demo complete!");
        } catch (err) {
          log("error", "Demo", err.message);
          showToast("error", "Demo failed: " + err.message);
        } finally {
          hideLoading();
        }
      }

      function showDataTable() {
        if (!state.predictions) {
          showToast("warning", "No predictions to display");
          return;
        }
        const head = document.getElementById("data-table-head");
        const body = document.getElementById("data-table-body");
        const nDims = state.nDimensions;
        const headers = [
          "Step",
          ...Array.from({ length: nDims }, (_, i) => `P${i + 1}`),
          ...Array.from({ length: nDims }, (_, i) => `L${i + 1}`),
          ...Array.from({ length: nDims }, (_, i) => `U${i + 1}`),
        ];
        head.innerHTML = `<tr>${
          headers.map((h) =>
            `<th class="px-2 sm:px-3 py-2 text-left text-xs">${h}</th>`
          ).join("")
        }</tr>`;
        body.innerHTML = state.predictions.predictions.map(
          (preds, i) => {
            const lowers = state.predictions.lowerBounds[i];
            const uppers = state.predictions.upperBounds[i];
            const cells = [
              i + 1,
              ...preds.map(formatNumber),
              ...lowers.map(formatNumber),
              ...uppers.map(formatNumber),
            ];
            return `<tr class="border-t border-slate-200 dark:border-slate-700">${
              cells.map((c) =>
                `<td class="px-2 sm:px-3 py-1.5 text-xs font-mono">${c}</td>`
              ).join("")
            }</tr>`;
          },
        ).join("");
        openModal("data-table-modal");
      }

      function showKeyboardShortcuts() {
        openModal("shortcuts-modal");
      }
      function clearAllPreferences() {
        if (!confirm("Clear all preferences and reload?")) return;
        localStorage.clear();
        location.reload();
      }
      function debounce(fn, ms) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), ms);
        };
      }

      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
