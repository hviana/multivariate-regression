<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {},
        },
      };
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen"
  >
    <!-- Header -->
    <header
      id="header"
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/50 dark:border-slate-700/50"
    >
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          <!-- Logo & Title -->
          <div class="flex items-center gap-3">
            <div
              class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30"
            >
              <span class="text-2xl">üìä</span>
            </div>
            <div class="hidden sm:block">
              <h1 class="font-bold text-lg text-slate-900 dark:text-white">
                ESN Studio
              </h1>
              <p class="text-xs text-slate-500 dark:text-slate-400">
                Autoregressive Forecasting
              </p>
            </div>
          </div>

          <!-- Status Badge -->
          <div
            id="statusBadge"
            class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800"
          >
            <span
              id="statusDot"
              class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
            ></span>
            <span
              id="statusText"
              class="text-xs font-medium text-slate-600 dark:text-slate-300"
            >No Model</span>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-2">
            <button
              id="predictBtn"
              class="hidden min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30"
              aria-label="Predict"
            >
              <span class="flex items-center gap-2">‚ö° <span
                  class="hidden sm:inline"
                >Predict</span></span>
            </button>
            <button
              id="configBtn"
              class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300"
              aria-label="Configure"
            >
              <span class="text-xl">‚öôÔ∏è</span>
            </button>
            <button
              id="menuBtn"
              class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300"
              aria-label="Menu"
            >
              <span class="text-xl">‚ò∞</span>
            </button>
            <button
              id="themeBtn"
              class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300"
              aria-label="Toggle theme"
            >
              <span class="text-xl" id="themeIcon">üåô</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 lg:flex lg:gap-6">
      <!-- Visualization Area -->
      <div class="flex-1 space-y-4">
        <!-- Tabs -->
        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          <button
            data-mode="grid"
            class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/25"
          >
            üìä <span class="hidden sm:inline">Grid</span>
          </button>
          <button
            data-mode="focus"
            class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
          >
            üîç <span class="hidden sm:inline">Focus</span>
          </button>
          <button
            data-mode="heatmap"
            class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
          >
            üå°Ô∏è <span class="hidden sm:inline">Heatmap</span>
          </button>
          <button
            data-mode="uncertainty"
            class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
          >
            üìà <span class="hidden sm:inline">CI</span>
          </button>
          <button
            data-mode="snapshot"
            class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
          >
            üì∑ <span class="hidden sm:inline">Snapshot</span>
          </button>
        </div>

        <!-- Dimension Selector (Focus Mode) -->
        <div id="dimSelector" class="hidden flex gap-2 overflow-x-auto pb-2">
          <!-- Dimension buttons will be dynamically added -->
        </div>

        <!-- Step Selector (Snapshot Mode) -->
        <div id="stepSelector" class="hidden flex items-center gap-3">
          <label class="text-sm font-medium text-slate-700 dark:text-slate-300"
          >Step:</label>
          <input
            type="number"
            id="stepInput"
            min="1"
            value="1"
            class="w-24 px-3 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white"
          >
        </div>

        <!-- Chart Container -->
        <div
          class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
        >
          <!-- Zoom Badge -->
          <div
            id="zoomBadge"
            class="hidden absolute top-4 left-4 z-10 px-2 py-1 rounded-lg bg-slate-900/80 text-white text-xs font-medium"
          >
            100%
          </div>

          <!-- Chart Controls -->
          <div
            id="chartControls"
            class="hidden absolute top-4 right-4 z-10 flex gap-2"
          >
            <button
              id="zoomInBtn"
              class="min-w-[36px] min-h-[36px] p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-lg"
              aria-label="Zoom in"
            >
              ‚ûï
            </button>
            <button
              id="zoomOutBtn"
              class="min-w-[36px] min-h-[36px] p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-lg"
              aria-label="Zoom out"
            >
              ‚ûñ
            </button>
            <button
              id="zoomResetBtn"
              class="min-w-[36px] min-h-[36px] p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-lg"
              aria-label="Reset zoom"
            >
              üîÑ
            </button>
          </div>

          <!-- Export Controls -->
          <div
            id="exportControls"
            class="hidden absolute bottom-4 right-4 z-10 flex gap-2"
          >
            <button
              id="savePngBtn"
              class="min-w-[36px] min-h-[36px] px-3 py-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-sm font-medium"
              aria-label="Save as PNG"
            >
              üñºÔ∏è
            </button>
            <button
              id="saveSvgBtn"
              class="min-w-[36px] min-h-[36px] px-3 py-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-sm font-medium"
              aria-label="Save as SVG"
            >
              üìÑ
            </button>
            <button
              id="copyChartBtn"
              class="min-w-[36px] min-h-[36px] px-3 py-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-lg hover:bg-white dark:hover:bg-slate-600 text-sm font-medium"
              aria-label="Copy to clipboard"
            >
              üìã
            </button>
          </div>

          <!-- Canvas -->
          <canvas
            id="chartCanvas"
            class="w-full"
            style="height: 400px"
          ></canvas>

          <!-- Tooltip -->
          <div
            id="chartTooltip"
            class="hidden absolute z-20 p-3 rounded-xl bg-slate-900/95 dark:bg-slate-700/95 text-white shadow-2xl min-w-[180px] pointer-events-none"
          >
            <div class="flex items-center gap-2 mb-2">
              <span class="font-bold text-lg" id="tooltipStep">Step 1</span>
            </div>
            <div class="flex items-center gap-2 mb-1">
              <span
                id="tooltipDimDot"
                class="w-3 h-3 rounded-full bg-blue-500"
              ></span>
              <span id="tooltipDim" class="text-sm text-slate-300"
              >Dimension 1</span>
            </div>
            <div class="text-lg font-bold mb-1" id="tooltipValue">0.000</div>
            <div class="text-xs text-slate-400">
              <span id="tooltipLower">0.00</span> ‚Äî <span id="tooltipUpper"
              >0.00</span>
            </div>
            <div class="text-xs text-slate-400 mt-1">
              Spread: <span id="tooltipSpread">0.00</span>
            </div>
          </div>

          <!-- Empty State -->
          <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center p-8 bg-white dark:bg-slate-800"
          >
            <div class="relative mb-6">
              <div
                class="w-32 h-32 rounded-3xl bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30"
              >
              </div>
              <div
                class="absolute inset-4 rounded-2xl bg-gradient-to-br from-blue-200 to-indigo-200 dark:from-blue-800/30 dark:to-indigo-800/30"
              >
              </div>
              <div
                class="absolute inset-8 rounded-xl bg-gradient-to-br from-blue-300 to-indigo-300 dark:from-blue-700/40 dark:to-indigo-700/40 flex items-center justify-center"
              >
                <span class="text-4xl">üìä</span>
              </div>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
              Create a Model to Begin
            </h2>
            <p
              class="text-slate-500 dark:text-slate-400 text-center mb-6 max-w-md"
            >
              Train an Echo State Network for autoregressive time series
              forecasting with real-time learning
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="quickStartBtn"
                class="min-h-[44px] px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30 flex items-center gap-2"
              >
                ‚ö° Start with Defaults
              </button>
              <div class="flex gap-2">
                <button
                  id="loadModelBtn"
                  class="min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center gap-2"
                >
                  üì§ Load
                </button>
                <button
                  id="demoBtn"
                  class="min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium shadow-lg shadow-purple-500/25 hover:shadow-xl flex items-center gap-2"
                >
                  ‚ú® Demo
                </button>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div
            id="loadingState"
            class="hidden absolute inset-0 flex flex-col items-center justify-center p-8 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm"
          >
            <div
              class="w-16 h-16 border-4 border-blue-200 dark:border-blue-800 border-t-blue-500 rounded-full mb-4"
              style="animation: spin 1s linear infinite"
            >
            </div>
            <p
              id="loadingText"
              class="text-lg font-semibold text-slate-900 dark:text-white mb-4"
            >
              Processing...
            </p>
            <div
              class="w-64 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"
            >
              <div
                id="progressBar"
                class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full transition-all"
                style="width: 0%"
              >
              </div>
            </div>
            <p
              id="progressText"
              class="text-sm text-slate-500 dark:text-slate-400 mb-4"
            >
              0%
            </p>
            <button
              id="cancelBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium hover:bg-red-200 dark:hover:bg-red-900/50"
            >
              Cancel
            </button>
          </div>
        </div>

        <!-- Statistics Bar (Focus Mode) -->
        <div id="statsBar" class="hidden grid grid-cols-3 lg:grid-cols-6 gap-3">
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Min
            </p>
            <p
              id="statMin"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Max
            </p>
            <p
              id="statMax"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Mean
            </p>
            <p
              id="statMean"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Final
            </p>
            <p
              id="statFinal"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Trend
            </p>
            <p
              id="statTrend"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-xs font-semibold uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Confidence
            </p>
            <p
              id="statConfidence"
              class="text-lg font-bold text-slate-900 dark:text-white"
            >
              ‚Äî
            </p>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <aside
        id="sidePanel"
        class="hidden lg:block w-80 flex-shrink-0 space-y-4"
      >
        <!-- Model Metrics -->
        <div
          class="p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-slate-200/50 dark:border-slate-700/50"
        >
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3"
          >
            Model Metrics
          </h3>
          <div class="space-y-2">
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Samples Trained</span>
              <span
                id="metricSamples"
                class="text-sm font-semibold text-blue-600 dark:text-blue-400"
              >0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Avg Loss</span>
              <span
                id="metricLoss"
                class="text-sm font-mono text-slate-900 dark:text-white"
              >‚Äî</span>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Gradient Norm</span>
              <span
                id="metricGradient"
                class="text-sm font-mono text-slate-900 dark:text-white"
              >‚Äî</span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Sample Weight</span>
              <span
                id="metricWeight"
                class="text-sm font-mono text-slate-900 dark:text-white"
              >‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Prediction Controls -->
        <div
          class="p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-slate-200/50 dark:border-slate-700/50"
        >
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3"
          >
            Prediction
          </h3>
          <div class="space-y-3">
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Future Steps</label>
              <input
                type="number"
                id="futureStepsInput"
                min="1"
                value="50"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
            </div>
            <button
              id="runPredictBtn"
              disabled
              class="w-full min-h-[44px] px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2"
            >
              ‚ö° Run Prediction
            </button>
          </div>
        </div>

        <!-- Event Log -->
        <div
          class="p-4 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-slate-200/50 dark:border-slate-700/50"
        >
          <div class="flex items-center justify-between mb-3">
            <h3
              class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400"
            >
              Event Log
            </h3>
            <select
              id="logFilter"
              class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 border-0 text-slate-600 dark:text-slate-300"
            >
              <option value="all">All</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>
          <input
            type="text"
            id="logSearch"
            placeholder="Search logs..."
            class="w-full px-3 py-2 mb-3 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm text-slate-900 dark:text-white"
          >
          <div id="logContainer" class="h-48 overflow-y-auto space-y-2">
            <p class="text-sm text-slate-400 dark:text-slate-500 italic">
              No events yet
            </p>
          </div>
        </div>
      </aside>
    </main>

    <!-- Mobile Side Panel Toggle -->
    <button
      id="mobilePanelToggle"
      class="lg:hidden fixed bottom-4 right-4 z-40 w-14 h-14 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-xl shadow-blue-500/30 flex items-center justify-center text-2xl"
      aria-label="Toggle panel"
    >
      üìã
    </button>

    <!-- Mobile Side Panel Overlay -->
    <div
      id="mobilePanelOverlay"
      class="hidden fixed inset-0 z-40 bg-black/50 lg:hidden"
      aria-hidden="true"
    >
    </div>

    <!-- Mobile Side Panel -->
    <div
      id="mobileSidePanel"
      class="fixed top-0 right-0 z-50 h-full w-[85%] max-w-[384px] bg-white dark:bg-slate-800 shadow-2xl transform translate-x-full transition-transform lg:hidden overflow-y-auto"
    >
      <div
        class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
      >
        <h2 class="font-bold text-lg text-slate-900 dark:text-white">
          Details
        </h2>
        <button
          id="closeMobilePanel"
          class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
        >
          ‚úñÔ∏è
        </button>
      </div>
      <div id="mobilePanelContent" class="p-4 space-y-4">
        <!-- Content copied from side panel -->
      </div>
    </div>

    <!-- Main Menu Overlay -->
    <div
      id="menuOverlay"
      class="hidden fixed inset-0 z-40 bg-black/50"
      aria-hidden="true"
    >
    </div>

    <!-- Main Menu -->
    <div
      id="mainMenu"
      class="fixed top-0 right-0 z-50 h-full w-[85%] max-w-[384px] bg-white dark:bg-slate-800 shadow-2xl transform translate-x-full transition-transform overflow-y-auto"
    >
      <div
        class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
      >
        <h2 class="font-bold text-lg text-slate-900 dark:text-white">Menu</h2>
        <button
          id="closeMenu"
          class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
        >
          ‚úñÔ∏è
        </button>
      </div>
      <div class="p-4 space-y-6">
        <!-- Model Section -->
        <div>
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            üìÅ Model
          </h3>
          <div class="space-y-2">
            <button
              id="menuConfigure"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-xl"
              >üéõÔ∏è</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Create & Configure
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Set up model parameters
                </p>
              </div>
            </button>
            <button
              id="menuSaveLoad"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-xl"
              >üíæ</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Save & Load
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Persist your models
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Data Section -->
        <div>
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            üìÇ Data
          </h3>
          <div class="space-y-2">
            <button
              id="menuUpload"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-xl"
              >üì§</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Upload Dataset
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Import time series data
                </p>
              </div>
            </button>
            <button
              id="menuManualInsert"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-xl"
              >‚ûï</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Manual Insert
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Add individual time steps
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Test Section -->
        <div>
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            üß™ Test
          </h3>
          <div class="space-y-2">
            <button
              id="menuRandomTest"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center text-xl"
              >üí°</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Random Test
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Advanced Section -->
        <div>
          <h3
            class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            ‚öôÔ∏è Advanced
          </h3>
          <div class="space-y-2">
            <button
              id="menuSettings"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-xl"
              >üîß</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  Settings
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Module URL & preferences
                </p>
              </div>
            </button>
            <button
              id="menuDataTable"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-xl"
              >üìã</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">
                  View Data Table
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Raw prediction values
                </p>
              </div>
            </button>
            <button
              id="menuHelp"
              class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center gap-3 text-left"
            >
              <span
                class="w-10 h-10 rounded-lg bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-xl"
              >‚ùì</span>
              <div>
                <p class="font-semibold text-slate-900 dark:text-white">Help</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Documentation & usage
                </p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-start justify-center">
        <div class="fixed inset-0 bg-black/50" id="configModalOverlay"></div>
        <div
          class="relative w-full max-w-3xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl"
        >
          <!-- Header -->
          <div
            class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-800 rounded-t-2xl z-10"
          >
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              ‚öôÔ∏è Model Configuration
            </h2>
            <button
              id="closeConfigModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <!-- Presets Bar -->
          <div
            class="p-4 border-b border-slate-200 dark:border-slate-700 overflow-x-auto"
          >
            <div class="flex gap-2">
              <button
                data-preset="default"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-blue-500 text-white"
              >
                Start Here
              </button>
              <button
                data-preset="fast"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Fast
              </button>
              <button
                data-preset="balanced"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Balanced
              </button>
              <button
                data-preset="accurate"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Accurate
              </button>
              <button
                data-preset="adaptive"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Adaptive
              </button>
              <button
                data-preset="robust"
                class="preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Robust
              </button>
            </div>
          </div>

          <!-- Config Sections -->
          <div class="p-4 space-y-4 max-h-[60vh] overflow-y-auto">
            <!-- Reservoir Architecture -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üß† Reservoir Architecture</span>
                <span class="toggle-icon">‚ñº</span>
              </button>
              <div
                class="config-content p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Reservoir Size</label>
                    <input
                      type="number"
                      id="cfgReservoirSize"
                      value="256"
                      min="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Neurons in reservoir
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Spectral Radius</label>
                    <input
                      type="number"
                      id="cfgSpectralRadius"
                      value="0.9"
                      step="0.01"
                      min="0"
                      max="2"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Memory length control
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Leak Rate</label>
                    <input
                      type="number"
                      id="cfgLeakRate"
                      value="0.3"
                      step="0.01"
                      min="0"
                      max="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Temporal smoothing
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Input Scale</label>
                    <input
                      type="number"
                      id="cfgInputScale"
                      value="1.0"
                      step="0.1"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Input scaling factor
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Bias Scale</label>
                    <input
                      type="number"
                      id="cfgBiasScale"
                      value="0.1"
                      step="0.01"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Bias scaling
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Reservoir Sparsity</label>
                    <input
                      type="number"
                      id="cfgReservoirSparsity"
                      value="0.9"
                      step="0.01"
                      min="0"
                      max="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Zero connections
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Input Sparsity</label>
                    <input
                      type="number"
                      id="cfgInputSparsity"
                      value="0.0"
                      step="0.01"
                      min="0"
                      max="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Input sparsity
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Activation</label>
                    <select
                      id="cfgActivation"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                      <option value="tanh">tanh</option>
                      <option value="relu">relu</option>
                    </select>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Activation function
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Readout Configuration -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üì§ Readout Configuration</span>
                <span class="toggle-icon">‚ñº</span>
              </button>
              <div
                class="config-content p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div
                  class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <p class="font-medium text-slate-900 dark:text-white">
                      Use Input in Readout
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Append input to state
                    </p>
                  </div>
                  <label
                    class="relative inline-flex items-center cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      id="cfgUseInputInReadout"
                      checked
                      class="sr-only peer"
                    >
                    <div
                      class="w-11 h-6 bg-slate-200 dark:bg-slate-600 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                    >
                    </div>
                  </label>
                </div>
                <div
                  class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <p class="font-medium text-slate-900 dark:text-white">
                      Use Bias in Readout
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Include bias term
                    </p>
                  </div>
                  <label
                    class="relative inline-flex items-center cursor-pointer"
                  >
                    <input
                      type="checkbox"
                      id="cfgUseBiasInReadout"
                      checked
                      class="sr-only peer"
                    >
                    <div
                      class="w-11 h-6 bg-slate-200 dark:bg-slate-600 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                    >
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Training (RLS) -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üéì Training (RLS)</span>
                <span class="toggle-icon">‚ñº</span>
              </button>
              <div
                class="config-content p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div
                  class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800"
                >
                  <p class="text-sm text-blue-700 dark:text-blue-300">
                    Training Method: <span class="font-semibold"
                    >RLS (Recursive Least Squares)</span>
                  </p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >RLS Lambda</label>
                    <input
                      type="number"
                      id="cfgRlsLambda"
                      value="0.999"
                      step="0.001"
                      min="0"
                      max="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Forgetting factor
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >RLS Delta</label>
                    <input
                      type="number"
                      id="cfgRlsDelta"
                      value="1.0"
                      step="0.1"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Initial P diagonal
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Epsilon</label>
                    <input
                      type="number"
                      id="cfgEpsilon"
                      value="1e-8"
                      step="1e-9"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Numerical stability
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >L2 Lambda</label>
                    <input
                      type="number"
                      id="cfgL2Lambda"
                      value="0.0001"
                      step="0.0001"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      L2 regularization
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Gradient Clip Norm</label>
                    <input
                      type="number"
                      id="cfgGradientClipNorm"
                      value="1.0"
                      step="0.1"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Max update norm
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Normalization -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üìè Normalization</span>
                <span class="toggle-icon">‚ñ≤</span>
              </button>
              <div
                class="config-content hidden p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Normalization Epsilon</label>
                    <input
                      type="number"
                      id="cfgNormalizationEpsilon"
                      value="1e-8"
                      step="1e-9"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Stability constant
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Normalization Warmup</label>
                    <input
                      type="number"
                      id="cfgNormalizationWarmup"
                      value="10"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Warmup samples
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Outlier Handling -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üéØ Outlier Handling</span>
                <span class="toggle-icon">‚ñ≤</span>
              </button>
              <div
                class="config-content hidden p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Outlier Threshold</label>
                    <input
                      type="number"
                      id="cfgOutlierThreshold"
                      value="3.0"
                      step="0.1"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Z-score threshold
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Outlier Min Weight</label>
                    <input
                      type="number"
                      id="cfgOutlierMinWeight"
                      value="0.1"
                      step="0.01"
                      min="0"
                      max="1"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Outlier min weight
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Uncertainty -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üìä Uncertainty</span>
                <span class="toggle-icon">‚ñ≤</span>
              </button>
              <div
                class="config-content hidden p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div>
                  <label
                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                  >Uncertainty Multiplier</label>
                  <input
                    type="number"
                    id="cfgUncertaintyMultiplier"
                    value="1.96"
                    step="0.01"
                    min="0"
                    class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                  >
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    CI Multiplier (1.96 = 95% CI)
                  </p>
                </div>
              </div>
            </div>

            <!-- Initialization -->
            <div
              class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
            >
              <button
                class="config-toggle w-full p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700"
              >
                <span class="font-semibold text-slate-900 dark:text-white"
                >üîß Initialization</span>
                <span class="toggle-icon">‚ñ≤</span>
              </button>
              <div
                class="config-content hidden p-4 space-y-4 border-t border-slate-200 dark:border-slate-700"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Weight Init Scale</label>
                    <input
                      type="number"
                      id="cfgWeightInitScale"
                      value="0.1"
                      step="0.01"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Initial weight scale
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Seed</label>
                    <input
                      type="number"
                      id="cfgSeed"
                      value="42"
                      min="0"
                      class="w-full px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Random seed
                    </p>
                  </div>
                </div>
                <div
                  class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <p class="font-medium text-slate-900 dark:text-white">
                      Verbose
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Detailed logging
                    </p>
                  </div>
                  <label
                    class="relative inline-flex items-center cursor-pointer"
                  >
                    <input type="checkbox" id="cfgVerbose" class="sr-only peer">
                    <div
                      class="w-11 h-6 bg-slate-200 dark:bg-slate-600 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                    >
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div
            class="p-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2 justify-between sticky bottom-0 bg-white dark:bg-slate-800 rounded-b-2xl"
          >
            <div class="flex gap-2">
              <button
                id="resetDefaultsBtn"
                class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Reset Defaults
              </button>
              <button
                id="resetAllBtn"
                class="min-h-[44px] px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium hover:bg-red-200 dark:hover:bg-red-900/50"
              >
                Reset All
              </button>
            </div>
            <div class="flex gap-2">
              <button
                id="cancelConfigBtn"
                class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Cancel
              </button>
              <button
                id="createModelBtn"
                class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-xl hover:shadow-blue-500/30"
              >
                Create Model
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" id="uploadModalOverlay"></div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              üì§ Upload Dataset
            </h2>
            <button
              id="closeUploadModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div
            id="dropZone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/10 cursor-pointer mb-4"
          >
            <span class="text-4xl mb-4 block">üìÅ</span>
            <p class="text-slate-600 dark:text-slate-400 mb-2">
              Drop JSON file here or tap to browse
            </p>
            <input type="file" id="fileInput" accept=".json" class="hidden">
          </div>

          <div class="mb-4">
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >Or paste JSON:</label>
            <textarea
              id="uploadTextarea"
              rows="4"
              class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white font-mono text-sm"
              placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
            ></textarea>
          </div>

          <details class="mb-4">
            <summary
              class="cursor-pointer text-sm font-medium text-blue-600 dark:text-blue-400"
            >
              View format example
            </summary>
            <div
              class="mt-2 p-3 rounded-lg bg-slate-50 dark:bg-slate-700 font-mono text-xs"
            >
              <pre
                id="formatExample"
                class="whitespace-pre-wrap text-slate-600 dark:text-slate-300"
              >
{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</pre>
              <button
                id="copyExampleBtn"
                class="mt-2 px-3 py-1 rounded bg-slate-200 dark:bg-slate-600 text-xs font-medium"
              >
                üìã Copy example
              </button>
            </div>
          </details>

          <div id="uploadValidation" class="hidden mb-4 p-3 rounded-lg">
            <div
              id="uploadSuccess"
              class="hidden text-emerald-700 dark:text-emerald-400"
            >
              <p>‚úÖ <strong>Valid!</strong></p>
              <p class="text-sm">
                Dimensions: <span id="validDims">0</span> | Steps: <span
                  id="validSteps"
                >0</span>
              </p>
            </div>
            <div id="uploadError" class="hidden text-red-600 dark:text-red-400">
              <p>‚ùå <span id="errorMessage">Invalid format</span></p>
            </div>
          </div>

          <div class="flex gap-2 justify-end">
            <button
              id="cancelUploadBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              Cancel
            </button>
            <button
              id="validateUploadBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium"
            >
              Validate
            </button>
            <button
              id="applyTrainBtn"
              disabled
              class="min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Apply & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="manualInsertModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
    >
      <div class="min-h-screen px-4 py-6 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" id="manualInsertModalOverlay">
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              ‚ûï Manual Insert
            </h2>
            <button
              id="closeManualInsertModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Add time step pairs for incremental training (minimum 2 consecutive
            steps).
          </p>

          <button
            id="generateTemplateBtn"
            class="mb-4 px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
          >
            üìù Generate Template
          </button>

          <textarea
            id="manualInsertTextarea"
            rows="6"
            class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white font-mono text-sm mb-4"
            placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
          ></textarea>

          <div id="manualValidation" class="hidden mb-4 p-3 rounded-lg"></div>

          <div class="flex gap-2 justify-end">
            <button
              id="cancelManualInsertBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              Cancel
            </button>
            <button
              id="insertTrainBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold"
            >
              Insert & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div id="saveLoadModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" id="saveLoadModalOverlay"></div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              üíæ Save & Load
            </h2>
            <button
              id="closeSaveLoadModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <!-- Save Section -->
          <div class="mb-6">
            <h3
              class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3"
            >
              Save Model
            </h3>
            <div class="flex gap-2">
              <button
                id="downloadModelBtn"
                class="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center gap-2"
              >
                üì• Download
              </button>
              <button
                id="saveBrowserBtn"
                class="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center gap-2"
              >
                üíæ Browser
              </button>
            </div>
          </div>

          <!-- Load Section -->
          <div class="mb-6">
            <h3
              class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3"
            >
              Load Model
            </h3>
            <div
              id="loadDropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 cursor-pointer mb-4"
            >
              <span class="text-2xl mb-2 block">üì§</span>
              <p class="text-sm text-slate-600 dark:text-slate-400">
                Tap to upload model file
              </p>
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="hidden"
              >
            </div>

            <div
              id="savedModelsList"
              class="space-y-2 max-h-48 overflow-y-auto"
            >
              <!-- Saved models will be listed here -->
            </div>

            <button
              id="clearAllModelsBtn"
              class="mt-4 text-sm text-red-600 dark:text-red-400 hover:underline"
            >
              Clear all saved models
            </button>
          </div>

          <button
            id="closeSaveLoadModalBtn"
            class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div id="randomTestModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" id="randomTestModalOverlay">
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              üß™ Random Test
            </h2>
            <button
              id="closeRandomTestModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Generate synthetic time series for testing the model.
          </p>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Seed</label>
              <input
                type="number"
                id="testSeed"
                value="42"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Dimensions</label>
              <input
                type="number"
                id="testDimensions"
                value="3"
                min="1"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Time Steps</label>
              <input
                type="number"
                id="testTimeSteps"
                value="200"
                min="10"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Noise</label>
              <input
                type="number"
                id="testNoise"
                value="0.1"
                step="0.01"
                min="0"
                max="1"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Outliers Rate</label>
              <input
                type="number"
                id="testOutliers"
                value="0.02"
                step="0.01"
                min="0"
                max="0.5"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
            </div>
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Difficulty</label>
              <select
                id="testDifficulty"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white"
              >
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>

          <div class="flex gap-2 justify-end">
            <button
              id="cancelRandomTestBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              Cancel
            </button>
            <button
              id="generateRunBtn"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg shadow-purple-500/25"
            >
              ‚ú® Generate & Run
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-center justify-center">
        <div class="fixed inset-0 bg-black/50" id="settingsModalOverlay"></div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              üîß Settings
            </h2>
            <button
              id="closeSettingsModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div class="space-y-4">
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >Module URL</label>
              <input
                type="text"
                id="moduleUrlInput"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white font-mono text-sm"
              >
            </div>

            <button
              id="reinitWorkerBtn"
              class="w-full min-h-[44px] px-4 py-3 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 font-medium hover:bg-amber-200 dark:hover:bg-amber-900/50"
            >
              üîÑ Reinitialize Worker
            </button>

            <button
              id="clearPrefsBtn"
              class="w-full min-h-[44px] px-4 py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium hover:bg-red-200 dark:hover:bg-red-900/50"
            >
              üóëÔ∏è Clear All Preferences
            </button>
          </div>

          <button
            id="closeSettingsModalBtn"
            class="w-full min-h-[44px] px-4 py-2 mt-6 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto bg-white dark:bg-slate-900"
    >
      <div class="min-h-screen">
        <div
          class="sticky top-0 z-10 p-4 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
        >
          <h2 class="font-bold text-xl text-slate-900 dark:text-white">
            üìã Data Table
          </h2>
          <div class="flex gap-2">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border-0 text-sm text-slate-900 dark:text-white"
            >
            <button
              id="exportCsvBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              üìä CSV
            </button>
            <button
              id="copyTableBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              üìã Copy
            </button>
            <button
              id="closeDataTableModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>
        </div>
        <div class="p-4 overflow-x-auto">
          <table id="dataTable" class="w-full text-sm">
            <thead class="sticky top-16 bg-slate-100 dark:bg-slate-800">
              <tr id="tableHeader" class="text-left">
                <!-- Headers will be generated -->
              </tr>
            </thead>
            <tbody id="tableBody" class="font-mono">
              <!-- Rows will be generated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 py-6 flex items-start justify-center">
        <div class="fixed inset-0 bg-black/50" id="helpModalOverlay"></div>
        <div
          class="relative w-full max-w-3xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl"
        >
          <div
            class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-800 rounded-t-2xl z-10"
          >
            <h2 class="font-bold text-xl text-slate-900 dark:text-white">
              ‚ùì Help & Documentation
            </h2>
            <button
              id="closeHelpModal"
              class="min-w-[44px] min-h-[44px] p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
            <!-- Worker Setup -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                üîß Worker Setup
              </h3>
              <div
                class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700 font-mono text-sm"
              >
                <p class="text-slate-600 dark:text-slate-300 mb-2">
                  The ESNRegression library runs in a Web Worker for
                  non-blocking performance.
                </p>
                <p class="text-blue-600 dark:text-blue-400 break-all">
                  Module URL:
                  https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0
                </p>
              </div>
            </section>

            <!-- Creating a Model -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                üì¶ Creating a Model
              </h3>
              <pre
                class="p-4 rounded-xl bg-slate-900 text-slate-100 font-mono text-sm overflow-x-auto"
              >
<code>const model = new ESNRegression(config);
// config contains all parameters from Configuration Modal</code></pre>
            </section>

            <!-- Online Training -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                üéì Online Training (fitOnline)
              </h3>
              <pre
                class="p-4 rounded-xl bg-slate-900 text-slate-100 font-mono text-sm overflow-x-auto"
              >
<code>model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call (t, t+1)
// Returns: { averageLoss, gradientNorm, sampleWeight }</code></pre>
            </section>

            <!-- Prediction -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                ‚ö° Prediction
              </h3>
              <pre
                class="p-4 rounded-xl bg-slate-900 text-slate-100 font-mono text-sm overflow-x-auto"
              >
<code>const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</code></pre>
            </section>

            <!-- Save/Load -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                üíæ Save/Load
              </h3>
              <pre
                class="p-4 rounded-xl bg-slate-900 text-slate-100 font-mono text-sm overflow-x-auto"
              >
<code>const state = model.save(); // Returns serialized model string
model.load(state); // Restores from serialized string</code></pre>
            </section>

            <!-- Presets -->
            <section>
              <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                üéõÔ∏è Default Presets
              </h3>
              <div class="space-y-2 text-sm">
                <div
                  class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800"
                >
                  <strong class="text-blue-700 dark:text-blue-300"
                  >Start Here/Default:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    reservoirSize=256, spectralRadius=0.9, leakRate=0.3</span>
                </div>
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
                  <strong class="text-slate-700 dark:text-slate-300"
                  >Fast:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    reservoirSize=64, reservoirSparsity=0.95</span>
                </div>
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
                  <strong class="text-slate-700 dark:text-slate-300"
                  >Balanced:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    reservoirSize=256, spectralRadius=0.9</span>
                </div>
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
                  <strong class="text-slate-700 dark:text-slate-300"
                  >Accurate:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    reservoirSize=512, spectralRadius=0.95, leakRate=0.2</span>
                </div>
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
                  <strong class="text-slate-700 dark:text-slate-300"
                  >Adaptive:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    rlsLambda=0.97, spectralRadius=0.85, leakRate=0.5</span>
                </div>
                <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
                  <strong class="text-slate-700 dark:text-slate-300"
                  >Robust:</strong>
                  <span class="text-slate-600 dark:text-slate-400">
                    outlierThreshold=2.0, outlierMinWeight=0.05,
                    l2Lambda=0.01</span>
                </div>
              </div>
            </section>
          </div>
          <div class="p-4 border-t border-slate-200 dark:border-slate-700">
            <button
              id="closeHelpModalBtn"
              class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-20 lg:bottom-4 left-4 right-4 lg:left-auto lg:right-4 lg:w-96 z-50 space-y-2"
    >
    </div>

    <!-- Inline CSS for spin animation (only this, as Tailwind doesn't have it) -->
    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>

    <script>
      // ==================== STATE MANAGEMENT ====================
      const DIMENSION_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];
      const DEFAULT_MODULE_URL =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0";

      const state = {
        config: getDefaultConfig(),
        modelExists: false,
        nDimensions: 3,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 0,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: { level: 1, offsetX: 0 },
        hover: {
          active: false,
          x: 0,
          y: 0,
          dataIndex: -1,
          dimIndex: -1,
        },
        moduleUrl: DEFAULT_MODULE_URL,
        isCancelled: false,
      };

      function getDefaultConfig() {
        return {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          readoutTraining: "rls",
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        };
      }

      const PRESETS = {
        default: getDefaultConfig(),
        fast: {
          ...getDefaultConfig(),
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        balanced: {
          ...getDefaultConfig(),
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        accurate: {
          ...getDefaultConfig(),
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          ...getDefaultConfig(),
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          ...getDefaultConfig(),
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      // ==================== WEB WORKER ====================
      let worker = null;
      let requestId = 0;
      const pendingRequests = new Map();

      function createWorker() {
        const workerCode = `
        let ESNRegression = null;
        let model = null;

        self.onmessage = async function(e) {
            const { type, data, requestId } = e.data;

            try {
                switch(type) {
                    case 'init':
                        const module = await import(data.moduleUrl);
                        ESNRegression = module.ESNRegression;
                        self.postMessage({ type: 'init', requestId, success: true });
                        break;

                    case 'createModel':
                        model = new ESNRegression(data.config);
                        self.postMessage({ type: 'createModel', requestId, success: true });
                        break;

                    case 'train':
                        if (!model) throw new Error('No model created');
                        const trainResult = model.fitOnline(data);
                        self.postMessage({ type: 'train', requestId, success: true, result: trainResult });
                        break;

                    case 'predict':
                        if (!model) throw new Error('No model created');
                        const predResult = model.predict(data.steps);
                        self.postMessage({ type: 'predict', requestId, success: true, result: predResult });
                        break;

                    case 'save':
                        if (!model) throw new Error('No model created');
                        const saveResult = model.save();
                        self.postMessage({ type: 'save', requestId, success: true, result: saveResult });
                        break;

                    case 'load':
                        if (!ESNRegression) throw new Error('Module not initialized');
                        model = new ESNRegression(data.defaultConfig);
                        model.load(data.state);
                        self.postMessage({ type: 'load', requestId, success: true });
                        break;

                    case 'getSummary':
                        if (!model) throw new Error('No model created');
                        const summary = model.getModelSummary();
                        self.postMessage({ type: 'getSummary', requestId, success: true, result: summary });
                        break;

                    case 'reset':
                        model = null;
                        self.postMessage({ type: 'reset', requestId, success: true });
                        break;
                }
            } catch (error) {
                self.postMessage({ type, requestId, success: false, error: error.message });
            }
        };
    `;

        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        worker.onmessage = (e) => {
          const { type, requestId, success, result, error } = e.data;
          const pending = pendingRequests.get(requestId);
          if (pending) {
            if (success) {
              pending.resolve(result);
            } else {
              pending.reject(new Error(error));
            }
            pendingRequests.delete(requestId);
          }
        };

        return sendWorkerMessage("init", {
          moduleUrl: state.moduleUrl,
        });
      }

      function sendWorkerMessage(type, data) {
        return new Promise((resolve, reject) => {
          const id = ++requestId;
          pendingRequests.set(id, { resolve, reject });
          worker.postMessage({ type, data, requestId: id });
        });
      }

      // ==================== UI HELPERS ====================
      function $(id) {
        return document.getElementById(id);
      }
      function $$(selector) {
        return document.querySelectorAll(selector);
      }

      function showModal(id) {
        $(id).classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      function hideModal(id) {
        $(id).classList.add("hidden");
        document.body.style.overflow = "";
      }

      function showToast(message, type = "info") {
        const container = $("toastContainer");
        const toast = document.createElement("div");
        const bgColors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        toast.className = `${
          bgColors[type]
        } text-white p-4 rounded-xl shadow-xl flex items-center justify-between`;
        toast.innerHTML = `
        <span>${message}</span>
        <button class="ml-4 min-w-[32px] min-h-[32px] hover:opacity-75">‚úñÔ∏è</button>
    `;

        toast.querySelector("button").onclick = () => toast.remove();
        container.appendChild(toast);

        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : 4000,
        );
      }

      function addLog(message, type = "info") {
        state.logs.unshift({
          message,
          type,
          timestamp: new Date().toLocaleTimeString(),
        });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = $("logContainer");
        const filter = $("logFilter").value;
        const search = $("logSearch").value.toLowerCase();

        const filtered = state.logs
          .filter((log) => filter === "all" || log.type === filter)
          .filter((log) => log.message.toLowerCase().includes(search))
          .slice(0, 50);

        if (filtered.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-400 dark:text-slate-500 italic">No events yet</p>';
          return;
        }

        const typeColors = {
          info:
            "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",
          success:
            "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300",
          warning:
            "bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300",
          error:
            "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",
        };

        container.innerHTML = filtered.map((log) => `
        <div class="text-xs p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
            <div class="flex items-center gap-2 mb-1">
                <span class="px-1.5 py-0.5 rounded ${
          typeColors[log.type]
        } text-[10px] uppercase font-bold">${log.type}</span>
                <span class="text-slate-400">${log.timestamp}</span>
            </div>
            <p class="text-slate-700 dark:text-slate-300">${log.message}</p>
        </div>
    `).join("");
      }

      function updateUI() {
        // Status badge
        const statusDot = $("statusDot");
        const statusText = $("statusText");
        const statusBadge = $("statusBadge");

        statusBadge.classList.remove("hidden");
        statusBadge.classList.add("flex");

        if (state.modelExists) {
          statusDot.className =
            "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
          statusText.textContent = `${state.sampleCount} steps`;
        } else {
          statusDot.className = "w-2 h-2 rounded-full bg-slate-400";
          statusText.textContent = "No Model";
        }

        // Predict buttons
        $("predictBtn").classList.toggle(
          "hidden",
          !state.modelExists || !state.predictions,
        );
        $("runPredictBtn").disabled = !state.modelExists;

        // Chart controls
        $("chartControls").classList.toggle(
          "hidden",
          !state.predictions,
        );
        $("exportControls").classList.toggle(
          "hidden",
          !state.predictions,
        );
        $("zoomBadge").classList.toggle(
          "hidden",
          state.zoom.level === 1,
        );
        if (state.zoom.level !== 1) {
          $("zoomBadge").textContent = `${
            Math.round(state.zoom.level * 100)
          }%`;
        }

        // Empty state
        $("emptyState").classList.toggle(
          "hidden",
          state.predictions !== null,
        );

        // Dimension selector
        $("dimSelector").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !state.predictions,
        );
        if (state.vizMode === "focus" && state.predictions) {
          renderDimensionSelector();
        }

        // Step selector
        $("stepSelector").classList.toggle(
          "hidden",
          state.vizMode !== "snapshot" || !state.predictions,
        );

        // Stats bar
        $("statsBar").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !state.predictions,
        );
        if (state.vizMode === "focus" && state.predictions) {
          updateStats();
        }

        // Metrics
        $("metricSamples").textContent = state.sampleCount;
        $("metricLoss").textContent = state.metrics.avgLoss !== null
          ? state.metrics.avgLoss.toExponential(2)
          : "‚Äî";
        $("metricGradient").textContent =
          state.metrics.gradientNorm !== null
            ? state.metrics.gradientNorm.toExponential(2)
            : "‚Äî";
        $("metricWeight").textContent =
          state.metrics.sampleWeight !== null
            ? state.metrics.sampleWeight.toFixed(3)
            : "‚Äî";

        // Render chart
        if (state.predictions) {
          renderChart();
        }
      }

      function renderDimensionSelector() {
        const container = $("dimSelector");
        container.innerHTML = "";

        for (let i = 0; i < state.nDimensions; i++) {
          const btn = document.createElement("button");
          const isActive = i === state.selectedDim;
          const color = DIMENSION_COLORS[i % DIMENSION_COLORS.length];

          btn.className =
            `min-w-[44px] min-h-[44px] px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
              isActive
                ? "text-white shadow-lg"
                : "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
            }`;
          if (isActive) btn.style.backgroundColor = color;
          btn.textContent = `D${i + 1}`;
          btn.onclick = () => {
            state.selectedDim = i;
            updateUI();
          };
          container.appendChild(btn);
        }
      }

      function updateStats() {
        if (!state.predictions) return;

        const dim = state.selectedDim;
        const values = state.predictions.predictions.map((p) => p[dim]);
        const lower = state.predictions.lowerBounds.map((l) => l[dim]);
        const upper = state.predictions.upperBounds.map((u) => u[dim]);

        const min = Math.min(...values);
        const max = Math.max(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const final = values[values.length - 1];
        const trend = final - values[0];
        const confidence = state.predictions.confidence * 100;

        $("statMin").textContent = min.toFixed(3);
        $("statMax").textContent = max.toFixed(3);
        $("statMean").textContent = mean.toFixed(3);
        $("statFinal").textContent = final.toFixed(3);
        $("statTrend").innerHTML = trend >= 0
          ? `<span class="text-emerald-500">‚Üë ${
            Math.abs(trend).toFixed(3)
          }</span>`
          : `<span class="text-red-500">‚Üì ${
            Math.abs(trend).toFixed(3)
          }</span>`;
        $("statConfidence").textContent = `${confidence.toFixed(1)}%`;
      }

      // ==================== CHART RENDERING ====================
      function renderChart() {
        const canvas = $("chartCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();

        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = 400 * window.devicePixelRatio;
        canvas.style.width = rect.width + "px";
        canvas.style.height = "400px";
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

        const width = rect.width;
        const height = 400;
        const padding = { top: 30, right: 20, bottom: 40, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Clear
        ctx.fillStyle = state.isDark ? "#1e293b" : "#ffffff";
        ctx.fillRect(0, 0, width, height);

        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const steps = predictions.length;

        switch (state.vizMode) {
          case "grid":
            renderGridChart(ctx, width, height, padding);
            break;
          case "focus":
            renderFocusChart(ctx, width, height, padding);
            break;
          case "heatmap":
            renderHeatmapChart(ctx, width, height, padding);
            break;
          case "uncertainty":
            renderUncertaintyChart(ctx, width, height, padding);
            break;
          case "snapshot":
            renderSnapshotChart(ctx, width, height, padding);
            break;
        }
      }

      function renderGridChart(ctx, width, height, padding) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const dims = state.nDimensions;
        const cols = Math.ceil(Math.sqrt(dims));
        const rows = Math.ceil(dims / cols);

        const cellWidth = (width - 20) / cols;
        const cellHeight = (height - 20) / rows;
        const cellPadding = 10;

        for (let d = 0; d < dims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = 10 + col * cellWidth;
          const y = 10 + row * cellHeight;

          const values = predictions.map((p) => p[d]);
          const lower = lowerBounds.map((l) => l[d]);
          const upper = upperBounds.map((u) => u[d]);

          const allVals = [...values, ...lower, ...upper];
          const minVal = Math.min(...allVals);
          const maxVal = Math.max(...allVals);
          const range = maxVal - minVal || 1;

          const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

          // Background
          ctx.fillStyle = state.isDark ? "#334155" : "#f1f5f9";
          ctx.beginPath();
          ctx.roundRect(x, y, cellWidth - 10, cellHeight - 10, 8);
          ctx.fill();

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "bold 10px system-ui";
          ctx.fillText(`D${d + 1}`, x + 8, y + 16);

          // Draw CI area
          ctx.fillStyle = color + "20";
          ctx.beginPath();
          for (let i = 0; i < values.length; i++) {
            const px = x + cellPadding +
              (i / (values.length - 1)) * (cellWidth - 30);
            const py = y + cellPadding + 20 +
              (1 - (upper[i] - minVal) / range) * (cellHeight - 50);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          for (let i = values.length - 1; i >= 0; i--) {
            const px = x + cellPadding +
              (i / (values.length - 1)) * (cellWidth - 30);
            const py = y + cellPadding + 20 +
              (1 - (lower[i] - minVal) / range) * (cellHeight - 50);
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Draw line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < values.length; i++) {
            const px = x + cellPadding +
              (i / (values.length - 1)) * (cellWidth - 30);
            const py = y + cellPadding + 20 +
              (1 - (values[i] - minVal) / range) * (cellHeight - 50);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();
        }
      }

      function renderFocusChart(ctx, width, height, padding) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const dim = state.selectedDim;
        const color = DIMENSION_COLORS[dim % DIMENSION_COLORS.length];

        const values = predictions.map((p) => p[dim]);
        const lower = lowerBounds.map((l) => l[dim]);
        const upper = upperBounds.map((u) => u[dim]);

        const allVals = [...values, ...lower, ...upper];
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Grid lines
        ctx.strokeStyle = state.isDark ? "#374151" : "#e5e7eb";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(width - padding.right, y);
          ctx.stroke();

          const val = maxVal - (i / 5) * range;
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 8, y + 4);
        }

        // X-axis labels
        ctx.textAlign = "center";
        for (let i = 0; i <= 5; i++) {
          const x = padding.left + (i / 5) * chartWidth;
          const step = Math.round((i / 5) * (values.length - 1)) + 1;
          ctx.fillText(`${step}`, x, height - 10);
        }

        // CI area
        ctx.fillStyle = color + "30";
        ctx.beginPath();
        for (let i = 0; i < values.length; i++) {
          const x = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const y = padding.top +
            (1 - (upper[i] - minVal) / range) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        for (let i = values.length - 1; i >= 0; i--) {
          const x = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const y = padding.top +
            (1 - (lower[i] - minVal) / range) * chartHeight;
          ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 0; i < values.length; i++) {
          const x = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const y = padding.top +
            (1 - (values[i] - minVal) / range) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Hover point
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const i = state.hover.dataIndex;
          const x = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const y = padding.top +
            (1 - (values[i] - minVal) / range) * chartHeight;

          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.fill();

          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }

      function renderHeatmapChart(ctx, width, height, padding) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const steps = predictions.length;
        const dims = state.nDimensions;

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const cellWidth = chartWidth / steps;
        const cellHeight = chartHeight / dims;

        // Find global min/max
        let globalMin = Infinity, globalMax = -Infinity;
        for (const p of predictions) {
          for (const v of p) {
            globalMin = Math.min(globalMin, v);
            globalMax = Math.max(globalMax, v);
          }
        }
        const range = globalMax - globalMin || 1;

        // Draw cells
        for (let s = 0; s < steps; s++) {
          for (let d = 0; d < dims; d++) {
            const val = predictions[s][d];
            const normalized = (val - globalMin) / range;

            // Color interpolation (blue to red)
            const r = Math.round(normalized * 255);
            const b = Math.round((1 - normalized) * 255);
            const g = Math.round(
              (1 - Math.abs(normalized - 0.5) * 2) * 100,
            );

            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillRect(
              padding.left + s * cellWidth,
              padding.top + d * cellHeight,
              cellWidth,
              cellHeight,
            );
          }
        }

        // Labels
        ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        for (let d = 0; d < dims; d++) {
          ctx.fillText(
            `D${d + 1}`,
            padding.left - 8,
            padding.top + (d + 0.5) * cellHeight + 4,
          );
        }

        ctx.textAlign = "center";
        for (let i = 0; i <= 5; i++) {
          const step = Math.round((i / 5) * (steps - 1)) + 1;
          const x = padding.left + (i / 5) * chartWidth;
          ctx.fillText(`${step}`, x, height - 10);
        }
      }

      function renderUncertaintyChart(ctx, width, height, padding) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const steps = predictions.length;

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Calculate spreads
        const spreads = [];
        let maxSpread = 0;
        for (let s = 0; s < steps; s++) {
          let totalSpread = 0;
          for (let d = 0; d < state.nDimensions; d++) {
            totalSpread += upperBounds[s][d] - lowerBounds[s][d];
          }
          spreads.push(totalSpread / state.nDimensions);
          maxSpread = Math.max(maxSpread, spreads[s]);
        }

        // Grid
        ctx.strokeStyle = state.isDark ? "#374151" : "#e5e7eb";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(width - padding.right, y);
          ctx.stroke();
        }

        // Bars
        const barWidth = chartWidth / steps * 0.8;
        for (let s = 0; s < steps; s++) {
          const x = padding.left + (s / steps) * chartWidth +
            (chartWidth / steps * 0.1);
          const barHeight = (spreads[s] / maxSpread) * chartHeight;
          const y = padding.top + chartHeight - barHeight;

          const gradient = ctx.createLinearGradient(
            x,
            y + barHeight,
            x,
            y,
          );
          gradient.addColorStop(0, "#3B82F6");
          gradient.addColorStop(1, "#8B5CF6");

          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.roundRect(x, y, barWidth, barHeight, [4, 4, 0, 0]);
          ctx.fill();
        }

        // Labels
        ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(
          "Avg. Uncertainty by Step",
          width / 2,
          padding.top - 10,
        );
      }

      function renderSnapshotChart(ctx, width, height, padding) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const stepIdx = Math.min(
          state.selectedStep,
          predictions.length - 1,
        );

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const values = predictions[stepIdx];
        const lower = lowerBounds[stepIdx];
        const upper = upperBounds[stepIdx];

        const allVals = [...values, ...lower, ...upper];
        const maxVal = Math.max(...allVals.map(Math.abs));

        const barWidth = chartWidth / state.nDimensions * 0.7;
        const gap = chartWidth / state.nDimensions * 0.15;

        // Zero line
        const zeroY = padding.top + chartHeight / 2;
        ctx.strokeStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, zeroY);
        ctx.lineTo(width - padding.right, zeroY);
        ctx.stroke();

        for (let d = 0; d < state.nDimensions; d++) {
          const x = padding.left + gap + d * (barWidth + gap * 2);
          const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

          // Error bar
          const errTop = zeroY -
            (upper[d] / maxVal) * (chartHeight / 2);
          const errBottom = zeroY -
            (lower[d] / maxVal) * (chartHeight / 2);

          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 2, errTop);
          ctx.lineTo(x + barWidth / 2, errBottom);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(x + barWidth / 4, errTop);
          ctx.lineTo(x + barWidth * 3 / 4, errTop);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(x + barWidth / 4, errBottom);
          ctx.lineTo(x + barWidth * 3 / 4, errBottom);
          ctx.stroke();

          // Bar
          const val = values[d];
          const barHeight = Math.abs(val / maxVal) * (chartHeight / 2);
          const barY = val >= 0 ? zeroY - barHeight : zeroY;

          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.roundRect(x, barY, barWidth, barHeight, 4);
          ctx.fill();

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "bold 12px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(`D${d + 1}`, x + barWidth / 2, height - 10);

          // Value
          ctx.fillStyle = state.isDark ? "#e2e8f0" : "#1e293b";
          ctx.fillText(val.toFixed(2), x + barWidth / 2, barY - 8);
        }

        // Title
        ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(
          `Step ${stepIdx + 1}`,
          width / 2,
          padding.top - 10,
        );
      }

      // ==================== CHART INTERACTION ====================
      function setupChartInteraction() {
        const canvas = $("chartCanvas");

        canvas.addEventListener("mousemove", handleChartHover);
        canvas.addEventListener("mouseleave", () => {
          state.hover.active = false;
          $("chartTooltip").classList.add("hidden");
          renderChart();
        });

        canvas.addEventListener("touchstart", handleChartTouch, {
          passive: false,
        });
        canvas.addEventListener("touchmove", handleChartTouch, {
          passive: false,
        });
        canvas.addEventListener("touchend", () => {
          state.hover.active = false;
          $("chartTooltip").classList.add("hidden");
          renderChart();
        });
      }

      function handleChartHover(e) {
        if (!state.predictions) return;

        const canvas = $("chartCanvas");
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const padding = { top: 30, right: 20, bottom: 40, left: 60 };
        const chartWidth = rect.width - padding.left - padding.right;

        if (x >= padding.left && x <= rect.width - padding.right) {
          const progress = (x - padding.left) / chartWidth;
          const dataIndex = Math.round(
            progress * (state.predictions.predictions.length - 1),
          );

          state.hover = {
            active: true,
            x: e.clientX,
            y: e.clientY,
            dataIndex,
            dimIndex: state.vizMode === "focus" ? state.selectedDim : 0,
          };

          updateTooltip();
          renderChart();
        }
      }

      function handleChartTouch(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          handleChartHover({
            clientX: touch.clientX,
            clientY: touch.clientY,
          });
        }
      }

      function updateTooltip() {
        if (!state.hover.active || !state.predictions) return;

        const tooltip = $("chartTooltip");
        const { dataIndex, dimIndex } = state.hover;
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;

        const color =
          DIMENSION_COLORS[dimIndex % DIMENSION_COLORS.length];

        $("tooltipStep").textContent = `Step ${dataIndex + 1}`;
        $("tooltipDimDot").style.backgroundColor = color;
        $("tooltipDim").textContent = `Dimension ${dimIndex + 1}`;
        $("tooltipValue").textContent = predictions[dataIndex][dimIndex]
          .toFixed(4);
        $("tooltipLower").textContent = lowerBounds[dataIndex][dimIndex]
          .toFixed(2);
        $("tooltipUpper").textContent = upperBounds[dataIndex][dimIndex]
          .toFixed(2);
        $("tooltipSpread").textContent =
          (upperBounds[dataIndex][dimIndex] -
            lowerBounds[dataIndex][dimIndex]).toFixed(2);

        tooltip.classList.remove("hidden");
        tooltip.style.left =
          Math.min(state.hover.x + 10, window.innerWidth - 200) + "px";
        tooltip.style.top =
          Math.min(state.hover.y + 10, window.innerHeight - 150) + "px";
      }

      // ==================== MODEL OPERATIONS ====================
      async function createModel(config = state.config) {
        showLoading("Creating model...");
        try {
          await sendWorkerMessage("createModel", { config });
          state.config = config;
          state.modelExists = true;
          state.sampleCount = 0;
          state.predictions = null;
          state.metrics = {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          };

          addLog("Model created successfully", "success");
          showToast("Model created! üéâ", "success");
          hideLoading();
          updateUI();
        } catch (error) {
          addLog(`Failed to create model: ${error.message}`, "error");
          showToast(`Error: ${error.message}`, "error");
          hideLoading();
        }
      }

      async function trainOnData(coordinates) {
        if (!state.modelExists) {
          await createModel();
        }

        showLoading("Training on uploaded data...");

        try {
          const batchSize = 50;
          for (let i = 0; i < coordinates.length - 1; i += batchSize) {
            if (state.isCancelled) {
              state.isCancelled = false;
              throw new Error("Training cancelled");
            }

            const batch = coordinates.slice(
              i,
              Math.min(i + batchSize + 1, coordinates.length),
            );
            if (batch.length < 2) continue;

            const result = await sendWorkerMessage("train", {
              coordinates: batch,
            });
            state.metrics = {
              avgLoss: result.averageLoss,
              gradientNorm: result.gradientNorm,
              sampleWeight: result.sampleWeight,
            };
            state.sampleCount += batch.length - 1;
            state.nDimensions = coordinates[0].length;

            updateProgress(
              (i / coordinates.length) * 100,
              `Training... ${i}/${coordinates.length}`,
            );
          }

          addLog(
            `Training complete: ${state.sampleCount} samples processed`,
            "success",
          );
          showToast("Training complete! üéì", "success");
          hideLoading();
          updateUI();
        } catch (error) {
          addLog(`Training failed: ${error.message}`, "error");
          showToast(`Error: ${error.message}`, "error");
          hideLoading();
        }
      }

      async function runPrediction() {
        if (!state.modelExists) return;

        const steps = parseInt($("futureStepsInput").value) || 50;
        showLoading(`Predicting ${steps} steps...`);

        try {
          const result = await sendWorkerMessage("predict", { steps });
          state.predictions = result;

          addLog(
            `Prediction complete: ${steps} future steps`,
            "success",
          );
          showToast("Prediction complete! ‚ö°", "success");
          hideLoading();
          updateUI();
        } catch (error) {
          addLog(`Prediction failed: ${error.message}`, "error");
          showToast(`Error: ${error.message}`, "error");
          hideLoading();
        }
      }

      async function saveModel() {
        if (!state.modelExists) return;

        try {
          const savedState = await sendWorkerMessage("save");
          return savedState;
        } catch (error) {
          showToast(`Save failed: ${error.message}`, "error");
          return null;
        }
      }

      async function loadModel(savedState) {
        showLoading("Loading model...");

        try {
          await sendWorkerMessage("load", {
            state: savedState,
            defaultConfig: getDefaultConfig(),
          });
          state.modelExists = true;

          const summary = await sendWorkerMessage("getSummary");
          state.nDimensions = summary.nFeatures || 3;
          state.sampleCount = summary.sampleCount || 0;

          addLog("Model loaded successfully", "success");
          showToast("Model loaded! üì¶", "success");
          hideLoading();
          updateUI();
        } catch (error) {
          addLog(`Load failed: ${error.message}`, "error");
          showToast(`Error: ${error.message}`, "error");
          hideLoading();
        }
      }

      // ==================== LOADING STATE ====================
      function showLoading(text = "Processing...") {
        $("loadingState").classList.remove("hidden");
        $("loadingText").textContent = text;
        $("progressBar").style.width = "0%";
        $("progressText").textContent = "0%";
      }

      function updateProgress(percent, text) {
        $("progressBar").style.width = `${percent}%`;
        $("progressText").textContent = `${Math.round(percent)}%`;
        if (text) $("loadingText").textContent = text;
      }

      function hideLoading() {
        $("loadingState").classList.add("hidden");
      }

      // ==================== DATA GENERATION ====================
      function generateSyntheticData(
        seed,
        dims,
        steps,
        noise,
        outlierRate,
        difficulty,
      ) {
        const random = seedRandom(seed);
        const data = [];

        const complexityMap = { easy: 1, medium: 2, hard: 3 };
        const complexity = complexityMap[difficulty] || 2;

        for (let t = 0; t < steps; t++) {
          const point = [];
          for (let d = 0; d < dims; d++) {
            let value = 0;

            // Base signal
            value += Math.sin(t * 0.1 + d) * (1 + complexity * 0.5);

            // Add harmonics based on difficulty
            for (let h = 2; h <= complexity; h++) {
              value += Math.sin(t * 0.1 * h + d * h) * (0.5 / h);
            }

            // Trend
            value += t * 0.01 * (d + 1);

            // Noise
            value += (random() - 0.5) * noise * 2;

            // Outliers
            if (random() < outlierRate) {
              value += (random() - 0.5) * 10;
            }

            point.push(value);
          }
          data.push(point);
        }

        return data;
      }

      function seedRandom(seed) {
        let s = seed;
        return function () {
          s = Math.sin(s) * 10000;
          return s - Math.floor(s);
        };
      }

      // ==================== CONFIG MODAL ====================
      function populateConfigModal() {
        $("cfgReservoirSize").value = state.config.reservoirSize;
        $("cfgSpectralRadius").value = state.config.spectralRadius;
        $("cfgLeakRate").value = state.config.leakRate;
        $("cfgInputScale").value = state.config.inputScale;
        $("cfgBiasScale").value = state.config.biasScale;
        $("cfgReservoirSparsity").value =
          state.config.reservoirSparsity;
        $("cfgInputSparsity").value = state.config.inputSparsity;
        $("cfgActivation").value = state.config.activation;
        $("cfgUseInputInReadout").checked =
          state.config.useInputInReadout;
        $("cfgUseBiasInReadout").checked =
          state.config.useBiasInReadout;
        $("cfgRlsLambda").value = state.config.rlsLambda;
        $("cfgRlsDelta").value = state.config.rlsDelta;
        $("cfgEpsilon").value = state.config.epsilon;
        $("cfgL2Lambda").value = state.config.l2Lambda;
        $("cfgGradientClipNorm").value = state.config.gradientClipNorm;
        $("cfgNormalizationEpsilon").value =
          state.config.normalizationEpsilon;
        $("cfgNormalizationWarmup").value =
          state.config.normalizationWarmup;
        $("cfgOutlierThreshold").value = state.config.outlierThreshold;
        $("cfgOutlierMinWeight").value = state.config.outlierMinWeight;
        $("cfgUncertaintyMultiplier").value =
          state.config.uncertaintyMultiplier;
        $("cfgWeightInitScale").value = state.config.weightInitScale;
        $("cfgSeed").value = state.config.seed;
        $("cfgVerbose").checked = state.config.verbose;
      }

      function getConfigFromModal() {
        return {
          reservoirSize: parseInt($("cfgReservoirSize").value),
          spectralRadius: parseFloat($("cfgSpectralRadius").value),
          leakRate: parseFloat($("cfgLeakRate").value),
          inputScale: parseFloat($("cfgInputScale").value),
          biasScale: parseFloat($("cfgBiasScale").value),
          reservoirSparsity: parseFloat(
            $("cfgReservoirSparsity").value,
          ),
          inputSparsity: parseFloat($("cfgInputSparsity").value),
          activation: $("cfgActivation").value,
          useInputInReadout: $("cfgUseInputInReadout").checked,
          useBiasInReadout: $("cfgUseBiasInReadout").checked,
          readoutTraining: "rls",
          rlsLambda: parseFloat($("cfgRlsLambda").value),
          rlsDelta: parseFloat($("cfgRlsDelta").value),
          epsilon: parseFloat($("cfgEpsilon").value),
          l2Lambda: parseFloat($("cfgL2Lambda").value),
          gradientClipNorm: parseFloat($("cfgGradientClipNorm").value),
          normalizationEpsilon: parseFloat(
            $("cfgNormalizationEpsilon").value,
          ),
          normalizationWarmup: parseInt(
            $("cfgNormalizationWarmup").value,
          ),
          outlierThreshold: parseFloat($("cfgOutlierThreshold").value),
          outlierMinWeight: parseFloat($("cfgOutlierMinWeight").value),
          uncertaintyMultiplier: parseFloat(
            $("cfgUncertaintyMultiplier").value,
          ),
          weightInitScale: parseFloat($("cfgWeightInitScale").value),
          seed: parseInt($("cfgSeed").value),
          verbose: $("cfgVerbose").checked,
        };
      }

      function applyPreset(presetName) {
        const preset = PRESETS[presetName];
        if (preset) {
          state.config = { ...preset };
          populateConfigModal();

          $$(".preset-btn").forEach((btn) => {
            btn.className =
              "preset-btn px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap " +
              (btn.dataset.preset === presetName
                ? "bg-blue-500 text-white"
                : "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600");
          });
        }
      }

      // ==================== THEME ====================
      function initTheme() {
        const saved = localStorage.getItem("esn-theme");
        state.isDark = saved === "dark" ||
          (!saved &&
            window.matchMedia("(prefers-color-scheme: dark)").matches);
        applyTheme();
      }

      function toggleTheme() {
        state.isDark = !state.isDark;
        localStorage.setItem(
          "esn-theme",
          state.isDark ? "dark" : "light",
        );
        applyTheme();
      }

      function applyTheme() {
        document.documentElement.classList.toggle("dark", state.isDark);
        $("themeIcon").textContent = state.isDark ? "‚òÄÔ∏è" : "üåô";
        if (state.predictions) renderChart();
      }

      // ==================== EXPORT FUNCTIONS ====================
      function exportToPng() {
        const canvas = $("chartCanvas");
        const link = document.createElement("a");
        link.download = "esn-chart.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
        showToast("Chart saved as PNG! üñºÔ∏è", "success");
      }

      function exportToCsv() {
        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        let csv = "Step";

        for (let d = 0; d < state.nDimensions; d++) {
          csv += `,P${d + 1},L${d + 1},U${d + 1}`;
        }
        csv += "\n";

        for (let s = 0; s < predictions.length; s++) {
          csv += `${s + 1}`;
          for (let d = 0; d < state.nDimensions; d++) {
            csv += `,${predictions[s][d]},${lowerBounds[s][d]},${
              upperBounds[s][d]
            }`;
          }
          csv += "\n";
        }

        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.download = "esn-predictions.csv";
        link.href = URL.createObjectURL(blob);
        link.click();
        showToast("Data exported as CSV! üìä", "success");
      }

      async function copyChartToClipboard() {
        const canvas = $("chartCanvas");
        try {
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve)
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("Chart copied to clipboard! üìã", "success");
        } catch (err) {
          showToast("Failed to copy chart", "error");
        }
      }

      // ==================== DATA TABLE ====================
      function renderDataTable() {
        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const headerRow = $("tableHeader");
        const tbody = $("tableBody");

        // Header
        let headerHtml =
          '<th class="px-4 py-3 font-semibold text-slate-700 dark:text-slate-300">Step</th>';
        for (let d = 0; d < state.nDimensions; d++) {
          headerHtml +=
            `<th class="px-4 py-3 font-semibold text-slate-700 dark:text-slate-300">P${
              d + 1
            }</th>`;
          headerHtml +=
            `<th class="px-4 py-3 font-semibold text-slate-700 dark:text-slate-300">L${
              d + 1
            }</th>`;
          headerHtml +=
            `<th class="px-4 py-3 font-semibold text-slate-700 dark:text-slate-300">U${
              d + 1
            }</th>`;
        }
        headerRow.innerHTML = headerHtml;

        // Body
        let bodyHtml = "";
        for (let s = 0; s < predictions.length; s++) {
          const bgClass = s % 2 === 0
            ? "bg-white dark:bg-slate-800"
            : "bg-slate-50 dark:bg-slate-800/50";
          bodyHtml +=
            `<tr class="${bgClass} hover:bg-blue-50 dark:hover:bg-blue-900/20">`;
          bodyHtml += `<td class="px-4 py-2 font-semibold">${
            s + 1
          }</td>`;
          for (let d = 0; d < state.nDimensions; d++) {
            bodyHtml += `<td class="px-4 py-2">${
              predictions[s][d].toFixed(4)
            }</td>`;
            bodyHtml += `<td class="px-4 py-2 text-slate-500">${
              lowerBounds[s][d].toFixed(4)
            }</td>`;
            bodyHtml += `<td class="px-4 py-2 text-slate-500">${
              upperBounds[s][d].toFixed(4)
            }</td>`;
          }
          bodyHtml += "</tr>";
        }
        tbody.innerHTML = bodyHtml;
      }

      // ==================== SAVED MODELS ====================
      function loadSavedModelsList() {
        const container = $("savedModelsList");
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        const names = Object.keys(saved);

        if (names.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-500 italic">No saved models</p>';
          return;
        }

        container.innerHTML = names.map((name) => `
        <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-700">
            <div>
                <p class="font-medium text-slate-900 dark:text-white">${name}</p>
                <p class="text-xs text-slate-500">Saved model</p>
            </div>
            <button onclick="loadSavedModel('${name}')" class="min-h-[36px] px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-sm font-medium">Load</button>
        </div>
    `).join("");
      }

      async function loadSavedModel(name) {
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        if (saved[name]) {
          await loadModel(saved[name]);
          hideModal("saveLoadModal");
        }
      }

      // ==================== EVENT LISTENERS ====================
      function setupEventListeners() {
        // Theme
        $("themeBtn").onclick = toggleTheme;

        // Menu
        $("menuBtn").onclick = () => {
          $("mainMenu").classList.remove("translate-x-full");
          $("menuOverlay").classList.remove("hidden");
        };
        $("closeMenu").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
        };
        $("menuOverlay").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
        };

        // Config modal
        $("configBtn").onclick = () => {
          populateConfigModal();
          showModal("configModal");
        };
        $("closeConfigModal").onclick = () => hideModal("configModal");
        $("configModalOverlay").onclick = () =>
          hideModal("configModal");
        $("cancelConfigBtn").onclick = () => hideModal("configModal");
        $("createModelBtn").onclick = async () => {
          const config = getConfigFromModal();
          hideModal("configModal");
          await createModel(config);
        };

        // Presets
        $$(".preset-btn").forEach((btn) => {
          btn.onclick = () => applyPreset(btn.dataset.preset);
        });

        // Config sections toggle
        $$(".config-toggle").forEach((toggle) => {
          toggle.onclick = () => {
            const content = toggle.nextElementSibling;
            const icon = toggle.querySelector(".toggle-icon");
            content.classList.toggle("hidden");
            icon.textContent = content.classList.contains("hidden")
              ? "‚ñ≤"
              : "‚ñº";
          };
        });

        // Reset buttons
        $("resetDefaultsBtn").onclick = () => applyPreset("default");
        $("resetAllBtn").onclick = async () => {
          await sendWorkerMessage("reset");
          state.config = getDefaultConfig();
          state.modelExists = false;
          state.predictions = null;
          state.sampleCount = 0;
          populateConfigModal();
          updateUI();
          showToast("All reset", "info");
        };

        // Quick start
        $("quickStartBtn").onclick = () => createModel();

        // Demo
        $("demoBtn").onclick = async () => {
          await createModel();
          const data = generateSyntheticData(
            42,
            3,
            100,
            0.1,
            0.02,
            "medium",
          );
          await trainOnData(data);
          await runPrediction();
        };

        // Predict
        $("predictBtn").onclick = runPrediction;
        $("runPredictBtn").onclick = runPrediction;

        // Visualization tabs
        $$(".viz-tab").forEach((tab) => {
          tab.onclick = () => {
            state.vizMode = tab.dataset.mode;
            $$(".viz-tab").forEach((t) => {
              t.className =
                "viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm whitespace-nowrap flex items-center gap-2 " +
                (t.dataset.mode === state.vizMode
                  ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/25"
                  : "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600");
            });
            updateUI();
          };
        });

        // Step selector
        $("stepInput").onchange = () => {
          state.selectedStep = Math.max(
            0,
            parseInt($("stepInput").value) - 1,
          );
          renderChart();
        };

        // Zoom controls
        $("zoomInBtn").onclick = () => {
          state.zoom.level = Math.min(5, state.zoom.level * 1.2);
          updateUI();
        };
        $("zoomOutBtn").onclick = () => {
          state.zoom.level = Math.max(0.5, state.zoom.level / 1.2);
          updateUI();
        };
        $("zoomResetBtn").onclick = () => {
          state.zoom.level = 1;
          updateUI();
        };

        // Export
        $("savePngBtn").onclick = exportToPng;
        $("copyChartBtn").onclick = copyChartToClipboard;

        // Menu items
        $("menuConfigure").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          populateConfigModal();
          showModal("configModal");
        };

        $("menuSaveLoad").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          loadSavedModelsList();
          showModal("saveLoadModal");
        };

        $("menuUpload").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          showModal("uploadModal");
        };

        $("menuManualInsert").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          showModal("manualInsertModal");
        };

        $("menuRandomTest").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          showModal("randomTestModal");
        };

        $("menuSettings").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          $("moduleUrlInput").value = state.moduleUrl;
          showModal("settingsModal");
        };

        $("menuDataTable").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          renderDataTable();
          showModal("dataTableModal");
        };

        $("menuHelp").onclick = () => {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
          showModal("helpModal");
        };

        // Upload modal
        $("closeUploadModal").onclick = () => hideModal("uploadModal");
        $("uploadModalOverlay").onclick = () =>
          hideModal("uploadModal");
        $("cancelUploadBtn").onclick = () => hideModal("uploadModal");

        $("dropZone").onclick = () => $("fileInput").click();
        $("fileInput").onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              $("uploadTextarea").value = ev.target.result;
            };
            reader.readAsText(file);
          }
        };

        $("dropZone").ondragover = (e) => {
          e.preventDefault();
          e.currentTarget.classList.add(
            "border-blue-500",
            "bg-blue-50",
          );
        };
        $("dropZone").ondragleave = (e) => {
          e.currentTarget.classList.remove(
            "border-blue-500",
            "bg-blue-50",
          );
        };
        $("dropZone").ondrop = (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove(
            "border-blue-500",
            "bg-blue-50",
          );
          const file = e.dataTransfer.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              $("uploadTextarea").value = ev.target.result;
            };
            reader.readAsText(file);
          }
        };

        $("copyExampleBtn").onclick = () => {
          navigator.clipboard.writeText($("formatExample").textContent);
          showToast("Example copied!", "info");
        };

        $("validateUploadBtn").onclick = () => {
          try {
            const data = JSON.parse($("uploadTextarea").value);
            if (
              !data.coordinates || !Array.isArray(data.coordinates) ||
              data.coordinates.length < 2
            ) {
              throw new Error("Need at least 2 time steps");
            }
            const dims = data.coordinates[0].length;

            $("uploadValidation").classList.remove("hidden");
            $("uploadSuccess").classList.remove("hidden");
            $("uploadError").classList.add("hidden");
            $("validDims").textContent = dims;
            $("validSteps").textContent = data.coordinates.length;
            $("applyTrainBtn").disabled = false;
          } catch (err) {
            $("uploadValidation").classList.remove("hidden");
            $("uploadSuccess").classList.add("hidden");
            $("uploadError").classList.remove("hidden");
            $("errorMessage").textContent = err.message;
            $("applyTrainBtn").disabled = true;
          }
        };

        $("applyTrainBtn").onclick = async () => {
          const data = JSON.parse($("uploadTextarea").value);
          hideModal("uploadModal");
          await trainOnData(data.coordinates);
          await runPrediction();
        };

        // Manual insert modal
        $("closeManualInsertModal").onclick = () =>
          hideModal("manualInsertModal");
        $("manualInsertModalOverlay").onclick = () =>
          hideModal("manualInsertModal");
        $("cancelManualInsertBtn").onclick = () =>
          hideModal("manualInsertModal");

        $("generateTemplateBtn").onclick = () => {
          const dims = state.nDimensions || 3;
          const template = {
            coordinates: [
              Array(dims).fill(0),
              Array(dims).fill(0),
            ],
          };
          $("manualInsertTextarea").value = JSON.stringify(
            template,
            null,
            2,
          );
        };

        $("insertTrainBtn").onclick = async () => {
          try {
            const data = JSON.parse($("manualInsertTextarea").value);
            if (!data.coordinates || data.coordinates.length < 2) {
              throw new Error("Need at least 2 coordinates");
            }
            hideModal("manualInsertModal");
            await trainOnData(data.coordinates);
            await runPrediction();
          } catch (err) {
            showToast(`Error: ${err.message}`, "error");
          }
        };

        // Save/Load modal
        $("closeSaveLoadModal").onclick = () =>
          hideModal("saveLoadModal");
        $("saveLoadModalOverlay").onclick = () =>
          hideModal("saveLoadModal");
        $("closeSaveLoadModalBtn").onclick = () =>
          hideModal("saveLoadModal");

        $("downloadModelBtn").onclick = async () => {
          const saved = await saveModel();
          if (saved) {
            const blob = new Blob([saved], {
              type: "application/json",
            });
            const link = document.createElement("a");
            link.download = "esn-model.json";
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("Model downloaded! üì•", "success");
          }
        };

        $("saveBrowserBtn").onclick = async () => {
          const name = prompt("Model name:", `ESN_${Date.now()}`);
          if (name) {
            const saved = await saveModel();
            if (saved) {
              const models = JSON.parse(
                localStorage.getItem("esn-saved-models") || "{}",
              );
              models[name] = saved;
              localStorage.setItem(
                "esn-saved-models",
                JSON.stringify(models),
              );
              loadSavedModelsList();
              showToast("Model saved to browser! üíæ", "success");
            }
          }
        };

        $("loadDropZone").onclick = () => $("loadFileInput").click();
        $("loadFileInput").onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
              hideModal("saveLoadModal");
              await loadModel(ev.target.result);
            };
            reader.readAsText(file);
          }
        };

        $("clearAllModelsBtn").onclick = () => {
          if (confirm("Clear all saved models?")) {
            localStorage.removeItem("esn-saved-models");
            loadSavedModelsList();
            showToast("All models cleared", "info");
          }
        };

        $("loadModelBtn").onclick = () => {
          loadSavedModelsList();
          showModal("saveLoadModal");
        };

        // Random test modal
        $("closeRandomTestModal").onclick = () =>
          hideModal("randomTestModal");
        $("randomTestModalOverlay").onclick = () =>
          hideModal("randomTestModal");
        $("cancelRandomTestBtn").onclick = () =>
          hideModal("randomTestModal");

        $("generateRunBtn").onclick = async () => {
          const seed = parseInt($("testSeed").value);
          const dims = parseInt($("testDimensions").value);
          const steps = parseInt($("testTimeSteps").value);
          const noise = parseFloat($("testNoise").value);
          const outliers = parseFloat($("testOutliers").value);
          const difficulty = $("testDifficulty").value;

          hideModal("randomTestModal");

          const data = generateSyntheticData(
            seed,
            dims,
            steps,
            noise,
            outliers,
            difficulty,
          );
          await createModel();
          await trainOnData(data);
          await runPrediction();
        };

        // Settings modal
        $("closeSettingsModal").onclick = () =>
          hideModal("settingsModal");
        $("settingsModalOverlay").onclick = () =>
          hideModal("settingsModal");
        $("closeSettingsModalBtn").onclick = () =>
          hideModal("settingsModal");

        $("reinitWorkerBtn").onclick = async () => {
          state.moduleUrl = $("moduleUrlInput").value ||
            DEFAULT_MODULE_URL;
          localStorage.setItem("esn-module-url", state.moduleUrl);
          showLoading("Reinitializing worker...");
          try {
            await createWorker();
            addLog("Worker reinitialized", "success");
            showToast("Worker reinitialized! üîÑ", "success");
          } catch (err) {
            showToast(`Error: ${err.message}`, "error");
          }
          hideLoading();
        };

        $("clearPrefsBtn").onclick = () => {
          if (confirm("Clear all preferences?")) {
            localStorage.clear();
            location.reload();
          }
        };

        // Data table modal
        $("closeDataTableModal").onclick = () =>
          hideModal("dataTableModal");
        $("exportCsvBtn").onclick = exportToCsv;
        $("copyTableBtn").onclick = () => {
          const table = $("dataTable");
          const range = document.createRange();
          range.selectNode(table);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
          document.execCommand("copy");
          window.getSelection().removeAllRanges();
          showToast("Table copied! üìã", "success");
        };

        // Help modal
        $("closeHelpModal").onclick = () => hideModal("helpModal");
        $("helpModalOverlay").onclick = () => hideModal("helpModal");
        $("closeHelpModalBtn").onclick = () => hideModal("helpModal");

        // Cancel button
        $("cancelBtn").onclick = () => {
          state.isCancelled = true;
        };

        // Log filters
        $("logFilter").onchange = renderLogs;
        $("logSearch").oninput = renderLogs;

        // Mobile panel
        $("mobilePanelToggle").onclick = () => {
          $("mobileSidePanel").classList.remove("translate-x-full");
          $("mobilePanelOverlay").classList.remove("hidden");

          // Copy side panel content
          const content = $("mobilePanelContent");
          content.innerHTML = $("sidePanel").innerHTML;
        };

        $("mobilePanelOverlay").onclick = () => {
          $("mobileSidePanel").classList.add("translate-x-full");
          $("mobilePanelOverlay").classList.add("hidden");
        };

        $("closeMobilePanel").onclick = () => {
          $("mobileSidePanel").classList.add("translate-x-full");
          $("mobilePanelOverlay").classList.add("hidden");
        };

        // Resize handler
        window.addEventListener("resize", () => {
          if (state.predictions) renderChart();
        });
      }

      // ==================== INIT ====================
      async function init() {
        // Load saved preferences
        state.moduleUrl = localStorage.getItem("esn-module-url") ||
          DEFAULT_MODULE_URL;

        // Init theme
        initTheme();

        // Setup listeners
        setupEventListeners();
        setupChartInteraction();

        // Initialize worker
        showLoading("Initializing ESN module...");
        try {
          await createWorker();
          addLog("ESN module loaded successfully", "success");
          hideLoading();
        } catch (error) {
          addLog(`Failed to load module: ${error.message}`, "error");
          showToast(
            "Failed to load ESN module. Check settings.",
            "error",
          );
          hideLoading();
        }

        // Update UI
        updateUI();
        renderLogs();
      }

      // Start
      init();
    </script>
  </body>
</html>
