<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwindcss.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
              slate: { 850: "#172033" },
            },
          },
        },
      };
    </script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family:
          system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }
      .toast-enter {
        animation: slideIn 0.3s ease-out;
      }
      .toast-exit {
        animation: slideOut 0.3s ease-in forwards;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse-slow {
        animation: pulse 2s ease-in-out infinite;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 3px;
      }
      .dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #475569;
      }
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
      }
      .dark input[type="range"]::-webkit-slider-runnable-track {
        background: #334155;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #3b82f6;
        margin-top: -6px;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      .modal-backdrop {
        backdrop-filter: blur(4px);
      }
      .chip {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 500;
      }
      .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200"
  >
    <div id="app" class="flex flex-col h-screen">
      <!-- Header -->
      <header
        class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 shadow-sm"
      >
        <div class="flex items-center justify-between max-w-screen-2xl mx-auto">
          <div class="flex items-center gap-3">
            <button
              id="menuBtn"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              aria-label="Open menu"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <h1
              class="text-lg font-bold bg-gradient-to-r from-blue-600 to-violet-600 bg-clip-text text-transparent"
            >
              ESN Regression Studio
            </h1>
            <div
              id="modelStatus"
              class="hidden sm:flex items-center gap-2 ml-4"
            >
              <span
                class="w-2 h-2 rounded-full bg-slate-400"
                id="statusDot"
              ></span>
              <span
                class="text-xs text-slate-500 dark:text-slate-400"
                id="statusText"
              >No Model</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div
              id="configChips"
              class="hidden md:flex items-center gap-1 mr-2"
            >
            </div>
            <button
              id="quickPredict"
              class="hidden sm:inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors focus-ring disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Predict
            </button>
            <button
              id="darkModeToggle"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              aria-label="Toggle dark mode"
            >
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <svg
                class="w-5 h-5 block dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-1 flex overflow-hidden">
        <!-- Visualization Area -->
        <div class="flex-1 flex flex-col overflow-hidden p-4">
          <div
            id="vizContainer"
            class="flex-1 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col"
          >
            <!-- Viz Header -->
            <div
              class="flex items-center justify-between px-4 py-3 border-b border-slate-200 dark:border-slate-700"
            >
              <div class="flex items-center gap-2">
                <select
                  id="vizMode"
                  class="text-sm bg-transparent border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-1.5 focus-ring"
                >
                  <option value="focus">Focus View</option>
                  <option value="grid">Small Multiples</option>
                  <option value="heatmap">Heatmap</option>
                  <option value="uncertainty">Uncertainty</option>
                  <option value="snapshot">Snapshot</option>
                </select>
                <select
                  id="dimSelector"
                  class="text-sm bg-transparent border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-1.5 focus-ring max-w-[150px]"
                >
                  <option value="0">Dimension 0</option>
                </select>
              </div>
              <div class="flex items-center gap-1">
                <button
                  id="zoomIn"
                  class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
                  aria-label="Zoom in"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"
                    />
                  </svg>
                </button>
                <button
                  id="zoomOut"
                  class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
                  aria-label="Zoom out"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM7 10h6"
                    />
                  </svg>
                </button>
                <button
                  id="zoomReset"
                  class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
                  aria-label="Reset zoom"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                    />
                  </svg>
                </button>
                <button
                  id="exportPng"
                  class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
                  aria-label="Export PNG"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <!-- Canvas Container -->
            <div id="chartArea" class="flex-1 relative overflow-hidden">
              <canvas id="mainCanvas" class="absolute inset-0"></canvas>
              <div
                id="tooltip"
                class="hidden absolute pointer-events-none z-10 bg-white dark:bg-slate-700 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 px-4 py-3 text-sm"
              >
              </div>
              <!-- Empty State -->
              <div
                id="emptyState"
                class="absolute inset-0 flex flex-col items-center justify-center p-8"
              >
                <div class="w-24 h-24 mb-6 relative">
                  <div
                    class="absolute inset-0 bg-gradient-to-br from-blue-500 to-violet-500 rounded-2xl opacity-20 animate-pulse-slow"
                  >
                  </div>
                  <div
                    class="absolute inset-2 bg-gradient-to-br from-blue-500 to-violet-500 rounded-xl opacity-40"
                  >
                  </div>
                  <div
                    class="absolute inset-4 bg-gradient-to-br from-blue-500 to-violet-500 rounded-lg flex items-center justify-center"
                  >
                    <svg
                      class="w-8 h-8 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>
                  </div>
                </div>
                <h3 class="text-lg font-semibold mb-2">
                  Welcome to ESN Regression Studio
                </h3>
                <p
                  class="text-slate-500 dark:text-slate-400 text-center mb-6 max-w-sm"
                >
                  Create a model and run predictions to visualize forecasts with
                  confidence intervals.
                </p>
                <div class="flex flex-col sm:flex-row gap-3">
                  <button
                    id="emptyStartHere"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors focus-ring"
                  >
                    Start Here
                  </button>
                  <button
                    id="emptyLoadModel"
                    class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-medium rounded-lg transition-colors focus-ring"
                  >
                    Load Model
                  </button>
                  <button
                    id="emptyRunTest"
                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors focus-ring"
                  >
                    Run Test
                  </button>
                </div>
              </div>
              <!-- Loading State -->
              <div
                id="loadingState"
                class="hidden absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80"
              >
                <div class="flex flex-col items-center">
                  <div
                    class="w-8 h-8 border-3 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"
                  >
                  </div>
                  <p
                    class="text-sm text-slate-600 dark:text-slate-400"
                    id="loadingText"
                  >
                    Processing...
                  </p>
                  <div
                    id="progressBar"
                    class="hidden w-48 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mt-2 overflow-hidden"
                  >
                    <div
                      id="progressFill"
                      class="h-full bg-blue-600 transition-all duration-200"
                      style="width: 0%"
                    >
                    </div>
                  </div>
                  <button
                    id="cancelBtn"
                    class="hidden mt-3 px-3 py-1 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
            <!-- Stats Bar -->
            <div
              id="statsBar"
              class="hidden px-4 py-2 bg-slate-50 dark:bg-slate-850 border-t border-slate-200 dark:border-slate-700 flex items-center gap-4 text-xs text-slate-600 dark:text-slate-400 overflow-x-auto scrollbar-thin"
            >
              <span><strong class="text-slate-900 dark:text-slate-100"
                >Min:</strong> <span id="statMin">-</span></span>
              <span><strong class="text-slate-900 dark:text-slate-100"
                >Max:</strong> <span id="statMax">-</span></span>
              <span><strong class="text-slate-900 dark:text-slate-100"
                >Mean:</strong> <span id="statMean">-</span></span>
              <span><strong class="text-slate-900 dark:text-slate-100"
                >Final:</strong> <span id="statFinal">-</span></span>
              <span><strong class="text-slate-900 dark:text-slate-100"
                >Confidence:</strong> <span id="statConfidence">-</span></span>
            </div>
          </div>
        </div>

        <!-- Side Panel -->
        <aside
          id="sidePanel"
          class="w-80 flex-shrink-0 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden hidden lg:flex"
        >
          <!-- Prediction Controls -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-blue-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Prediction
            </h3>
            <div class="space-y-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Future Steps</label>
                <div class="flex items-center gap-2">
                  <input
                    type="range"
                    id="futureStepsRange"
                    min="1"
                    max="64"
                    value="10"
                    class="flex-1"
                  >
                  <input
                    type="number"
                    id="futureStepsInput"
                    min="1"
                    max="64"
                    value="10"
                    class="w-16 text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-transparent focus-ring"
                  >
                </div>
              </div>
              <button
                id="runPredict"
                class="w-full py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-medium rounded-lg transition-colors focus-ring flex items-center justify-center gap-2"
                disabled
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                Run Prediction
              </button>
            </div>
          </div>
          <!-- Model Summary -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
              <svg
                class="w-4 h-4 text-emerald-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Model Summary
            </h3>
            <div
              id="modelSummary"
              class="text-xs space-y-1.5 text-slate-600 dark:text-slate-400"
            >
              <p class="text-slate-400 dark:text-slate-500 italic">
                No model loaded
              </p>
            </div>
          </div>
          <!-- Event Log -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 pb-2 flex items-center justify-between">
              <h3 class="text-sm font-semibold flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-amber-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  />
                </svg>
                Event Log
              </h3>
              <select
                id="logFilter"
                class="text-xs bg-transparent border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus-ring"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <div
              id="logContainer"
              class="flex-1 overflow-y-auto px-4 pb-4 scrollbar-thin"
            >
              <div id="logList" class="space-y-2 text-xs"></div>
            </div>
          </div>
        </aside>
      </main>

      <!-- Mobile Bottom Bar -->
      <div
        id="mobileBar"
        class="lg:hidden flex-shrink-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-4 py-2 flex items-center gap-2"
      >
        <button
          id="mobilePredict"
          class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white text-sm font-medium rounded-lg transition-colors focus-ring"
          disabled
        >
          Predict
        </button>
        <button
          id="mobilePanel"
          class="p-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors focus-ring"
          aria-label="Open panel"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h7"
            />
          </svg>
        </button>
      </div>
    </div>

    <!-- Main Menu Slide-over -->
    <div id="menuOverlay" class="hidden fixed inset-0 z-40">
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="menuBackdrop"
      >
      </div>
      <div
        id="menuPanel"
        class="absolute left-0 top-0 bottom-0 w-72 max-w-full bg-white dark:bg-slate-800 shadow-xl transform -translate-x-full transition-transform duration-300 flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-semibold">Menu</h2>
          <button
            id="closeMenu"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close menu"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-2 scrollbar-thin">
          <div class="mb-4">
            <p
              class="px-3 py-1 text-xs font-semibold text-slate-400 uppercase tracking-wider"
            >
              Model
            </p>
            <button
              id="menuConfig"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-blue-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <span>Create / Configure</span>
            </button>
            <button
              id="menuSaveLoad"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-emerald-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                />
              </svg>
              <span>Save / Load</span>
            </button>
          </div>
          <div class="mb-4">
            <p
              class="px-3 py-1 text-xs font-semibold text-slate-400 uppercase tracking-wider"
            >
              Data
            </p>
            <button
              id="menuUpload"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-violet-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              <span>Upload Dataset</span>
            </button>
            <button
              id="menuInsert"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-pink-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Manual Insert</span>
            </button>
          </div>
          <div class="mb-4">
            <p
              class="px-3 py-1 text-xs font-semibold text-slate-400 uppercase tracking-wider"
            >
              Test
            </p>
            <button
              id="menuRandomTest"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-amber-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                />
              </svg>
              <span>Random Test</span>
            </button>
          </div>
          <div>
            <p
              class="px-3 py-1 text-xs font-semibold text-slate-400 uppercase tracking-wider"
            >
              Advanced
            </p>
            <button
              id="menuSettings"
              class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
            >
              <svg
                class="w-5 h-5 text-slate-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                />
              </svg>
              <span>Settings</span>
            </button>
          </div>
        </nav>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-400"
        >
          <p>
            Keyboard: <kbd
              class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"
            >M</kbd> Menu · <kbd
              class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"
            >C</kbd> Config · <kbd
              class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"
            >P</kbd> Predict
          </p>
        </div>
      </div>
    </div>

    <!-- Config Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="configBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Model Configuration</h2>
          <button
            id="closeConfig"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin">
          <div class="mb-6">
            <label class="text-sm font-medium mb-2 block">Preset</label>
            <div class="flex flex-wrap gap-2">
              <button
                data-preset="starthere"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Start Here
              </button>
              <button
                data-preset="fast"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Fast/Light
              </button>
              <button
                data-preset="balanced"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Balanced
              </button>
              <button
                data-preset="accurate"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Accurate/Stable
              </button>
              <button
                data-preset="adaptive"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Adaptive/Drift
              </button>
              <button
                data-preset="noisy"
                class="preset-btn px-3 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:border-blue-500 transition-colors focus-ring"
              >
                Noisy/Robust
              </button>
            </div>
          </div>
          <div id="configSections" class="space-y-6"></div>
        </div>
        <div
          class="flex items-center justify-between px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-850"
        >
          <div class="flex gap-2">
            <button
              id="resetDefaults"
              class="px-3 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            >
              Reset to Defaults
            </button>
            <button
              id="resetEverything"
              class="px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors focus-ring"
            >
              Reset Everything
            </button>
          </div>
          <button
            id="applyConfig"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors focus-ring"
          >
            Create Model
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="uploadBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Upload Dataset</h2>
          <button
            id="closeUpload"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin">
          <div
            class="mb-4 p-3 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs"
          >
            <p class="font-medium mb-1">Expected Format:</p>
            <pre
              class="text-slate-600 dark:text-slate-300 overflow-x-auto"
            >{ "xCoordinates": [[f1,f2,...], ...], "yCoordinates": [[t1,t2,...], ...] }</pre>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2"
            >Upload JSON File</label>
            <input
              type="file"
              id="fileInput"
              accept=".json"
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-400"
            >
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Or Paste JSON</label>
            <textarea
              id="pasteJson"
              rows="6"
              class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg p-3 bg-transparent focus-ring resize-none font-mono"
              placeholder='{"xCoordinates": [...], "yCoordinates": [...]}'
            ></textarea>
          </div>
          <div
            id="uploadPreview"
            class="hidden p-4 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg"
          >
            <h4 class="font-medium text-emerald-800 dark:text-emerald-300 mb-2">
              Validation Preview
            </h4>
            <div
              id="uploadPreviewContent"
              class="text-sm text-emerald-700 dark:text-emerald-400"
            >
            </div>
          </div>
          <div
            id="uploadError"
            class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-700 dark:text-red-400"
          >
          </div>
        </div>
        <div
          class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-850"
        >
          <button
            id="cancelUpload"
            class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            id="applyUpload"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-medium rounded-lg transition-colors focus-ring"
            disabled
          >
            Apply Data
          </button>
        </div>
      </div>
    </div>

    <!-- Insert Modal -->
    <div
      id="insertModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="insertBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Manual Insert</h2>
          <button
            id="closeInsert"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin">
          <div id="insertModelRequired" class="text-center py-8 text-slate-500">
            <p>Create a model first to insert samples.</p>
          </div>
          <div id="insertForm" class="hidden">
            <div class="mb-4 flex items-center justify-between">
              <span
                class="text-sm text-slate-500 dark:text-slate-400"
                id="insertDimInfo"
              >Features: ?, Targets: ?</span>
              <button
                id="genTemplate"
                class="text-sm text-blue-600 hover:underline"
              >
                Generate Template
              </button>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Sample JSON</label>
              <textarea
                id="insertJson"
                rows="6"
                class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg p-3 bg-transparent focus-ring resize-none font-mono"
                placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'
              ></textarea>
            </div>
            <div
              id="insertPreview"
              class="hidden p-4 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg text-sm text-emerald-700 dark:text-emerald-400 mb-4"
            >
            </div>
            <div
              id="insertError"
              class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-700 dark:text-red-400 mb-4"
            >
            </div>
          </div>
        </div>
        <div
          class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-850"
        >
          <button
            id="cancelInsert"
            class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            id="applyInsert"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-medium rounded-lg transition-colors focus-ring"
            disabled
          >
            Insert Sample
          </button>
        </div>
      </div>
    </div>

    <!-- Save/Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="saveLoadBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Save / Load Model</h2>
          <button
            id="closeSaveLoad"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin space-y-6">
          <div>
            <h3 class="font-medium mb-3">Save Model</h3>
            <div class="flex gap-2">
              <button
                id="saveToFile"
                class="flex-1 py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors focus-ring disabled:opacity-50"
                disabled
              >
                Save to File
              </button>
              <button
                id="saveToLocal"
                class="flex-1 py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors focus-ring disabled:opacity-50"
                disabled
              >
                Save to Browser
              </button>
            </div>
          </div>
          <div>
            <h3 class="font-medium mb-3">Load Model</h3>
            <div class="mb-3">
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-400"
              >
            </div>
            <button
              id="loadFromLocal"
              class="w-full py-2 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors focus-ring disabled:opacity-50"
            >
              Load from Browser
            </button>
            <p id="localStorageInfo" class="mt-2 text-xs text-slate-500"></p>
          </div>
          <div>
            <h3 class="font-medium mb-3 text-red-600">Danger Zone</h3>
            <button
              id="clearLocal"
              class="px-4 py-2 text-sm text-red-600 border border-red-300 dark:border-red-800 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors focus-ring"
            >
              Clear Browser Storage
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="testModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="testBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Random Standard Test</h2>
          <button
            id="closeTest"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin space-y-4">
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Generate synthetic multivariate data with nonlinear relationships,
            train the model, and run predictions.
          </p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-500 block mb-1">Seed</label>
              <input
                type="number"
                id="testSeed"
                value="42"
                class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-transparent focus-ring"
              >
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1"
              >Sample Count</label>
              <input
                type="number"
                id="testSamples"
                value="200"
                min="50"
                max="2000"
                class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-transparent focus-ring"
              >
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1">Features</label>
              <input
                type="number"
                id="testFeatures"
                value="3"
                min="1"
                max="50"
                class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-transparent focus-ring"
              >
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1">Targets</label>
              <input
                type="number"
                id="testTargets"
                value="2"
                min="1"
                max="30"
                class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-transparent focus-ring"
              >
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1"
              >Noise Level</label>
              <input
                type="range"
                id="testNoise"
                min="0"
                max="1"
                step="0.05"
                value="0.1"
                class="w-full"
              >
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1"
              >Outlier Rate</label>
              <input
                type="range"
                id="testOutlier"
                min="0"
                max="0.2"
                step="0.01"
                value="0.02"
                class="w-full"
              >
            </div>
          </div>
          <div
            id="testSummary"
            class="hidden p-3 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs"
          >
          </div>
        </div>
        <div
          class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-850"
        >
          <button
            id="cancelTest"
            class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            id="runTest"
            class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors focus-ring"
          >
            Generate + Train + Predict
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-black/50 modal-backdrop"
        id="settingsBackdrop"
      >
      </div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden"
      >
        <div
          class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-lg font-semibold">Settings</h2>
          <button
            id="closeSettings"
            class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin space-y-4">
          <div>
            <label class="text-sm font-medium block mb-2">Module URL</label>
            <input
              type="text"
              id="moduleUrl"
              value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression"
              class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-transparent focus-ring font-mono"
            >
            <p class="text-xs text-slate-500 mt-1">
              Change if module fails to load. Requires worker restart.
            </p>
          </div>
          <button
            id="restartWorker"
            class="w-full py-2 border border-amber-500 text-amber-600 rounded-lg hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-colors focus-ring"
          >
            Restart Worker
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"
    >
    </div>

    <script>
      (function () {
        "use strict";

        const PRESETS = {
          starthere: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.3,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.999,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.0001,
            gradientClipNorm: 1,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 3,
            outlierMinWeight: 0.1,
            residualWindowSize: 100,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
          fast: {
            reservoirSize: 64,
            maxSequenceLength: 32,
            spectralRadius: 0.8,
            leakRate: 0.5,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.99,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.001,
            gradientClipNorm: 1,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 5,
            outlierThreshold: 3,
            outlierMinWeight: 0.1,
            residualWindowSize: 50,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
          balanced: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.3,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.999,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.0001,
            gradientClipNorm: 1,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 3,
            outlierMinWeight: 0.1,
            residualWindowSize: 100,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
          accurate: {
            reservoirSize: 512,
            maxSequenceLength: 128,
            spectralRadius: 0.95,
            leakRate: 0.2,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.85,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.9995,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.0001,
            gradientClipNorm: 1,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 20,
            outlierThreshold: 3,
            outlierMinWeight: 0.1,
            residualWindowSize: 150,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
          adaptive: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.85,
            leakRate: 0.5,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.97,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.001,
            gradientClipNorm: 1,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 2.5,
            outlierMinWeight: 0.1,
            residualWindowSize: 50,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
          noisy: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.2,
            inputScale: 1,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.999,
            rlsDelta: 1,
            epsilon: 1e-8,
            l2Lambda: 0.01,
            gradientClipNorm: 0.5,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 2,
            outlierMinWeight: 0.05,
            residualWindowSize: 100,
            uncertaintyMultiplier: 2.58,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        };

        const CONFIG_SECTIONS = [
          {
            name: "🔄 Reservoir Architecture",
            params: [
              {
                key: "maxSequenceLength",
                type: "number",
                default: 64,
                min: 8,
                max: 512,
                desc:
                  "Maximum temporal context window. Limits how far back the model remembers and max prediction horizon.",
                tip: "Increase for long patterns, decrease for speed.",
              },
              {
                key: "reservoirSize",
                type: "number",
                default: 256,
                min: 16,
                max: 2048,
                desc:
                  "Number of neurons in the reservoir. More neurons = more capacity but slower.",
                tip:
                  "Start with 256, increase if underfitting complex data.",
              },
              {
                key: "spectralRadius",
                type: "number",
                default: 0.9,
                min: 0.1,
                max: 0.99,
                step: 0.01,
                desc:
                  "Controls memory length. Higher = longer memory. Must be <1 for stability.",
                tip:
                  "Use 0.95+ for long-term dependencies, 0.7-0.8 for fast-changing signals.",
              },
              {
                key: "leakRate",
                type: "number",
                default: 0.3,
                min: 0.01,
                max: 1,
                step: 0.01,
                desc:
                  "Temporal smoothing. Lower = more smoothing, higher = faster response.",
                tip:
                  "Use 0.1-0.3 for noisy data, 0.5-0.9 for clean fast signals.",
              },
              {
                key: "inputScale",
                type: "number",
                default: 1,
                min: 0.01,
                max: 5,
                step: 0.1,
                desc:
                  "Scales input before reservoir. Affects nonlinearity saturation.",
                tip:
                  "Keep at 1 with normalization. Lower if activations saturate.",
              },
              {
                key: "biasScale",
                type: "number",
                default: 0.1,
                min: 0,
                max: 1,
                step: 0.01,
                desc:
                  "Scale of random bias values. Helps break symmetry.",
                tip: "Usually keep at 0.1.",
              },
              {
                key: "reservoirSparsity",
                type: "number",
                default: 0.9,
                min: 0,
                max: 0.99,
                step: 0.01,
                desc:
                  "Fraction of zero connections in reservoir. Higher = faster, sparser.",
                tip:
                  "0.9 is a good default. Lower for denser connections.",
              },
              {
                key: "inputSparsity",
                type: "number",
                default: 0,
                min: 0,
                max: 0.9,
                step: 0.1,
                desc:
                  "Fraction of zero input connections. Acts as feature selection.",
                tip: "Keep 0 unless you have many redundant features.",
              },
              {
                key: "activation",
                type: "select",
                default: "tanh",
                options: ["tanh", "relu"],
                desc:
                  "Nonlinear activation function. tanh is bounded, relu is unbounded.",
                tip:
                  "Use tanh for most cases, relu for positive-only predictions.",
              },
            ],
          },
          {
            name: "📤 Readout Configuration",
            params: [
              {
                key: "useInputInReadout",
                type: "checkbox",
                default: true,
                desc:
                  "Include current input in output computation. Adds skip connections.",
                tip: "Keep true for direct input-output relationships.",
              },
              {
                key: "useBiasInReadout",
                type: "checkbox",
                default: true,
                desc:
                  "Include bias term in output. Allows non-zero mean predictions.",
                tip: "Keep true unless you have zero-centered data.",
              },
            ],
          },
          {
            name: "🎯 Training (RLS)",
            params: [
              {
                key: "rlsLambda",
                type: "number",
                default: 0.999,
                min: 0.9,
                max: 0.9999,
                step: 0.001,
                desc:
                  "Forgetting factor. Lower = faster adaptation, higher = more stable.",
                tip:
                  "Use 0.95-0.99 for concept drift, 0.999+ for stationary data.",
              },
              {
                key: "rlsDelta",
                type: "number",
                default: 1,
                min: 0.01,
                max: 100,
                step: 0.1,
                desc:
                  "Initial P matrix scale. Higher = faster initial learning.",
                tip:
                  "Keep at 1 unless you need aggressive initial updates.",
              },
              {
                key: "epsilon",
                type: "number",
                default: 1e-8,
                min: 1e-12,
                max: 1e-4,
                step: 1e-9,
                desc:
                  "Numerical stability constant. Prevents division by zero.",
                tip: "Keep at 1e-8 unless you see numerical issues.",
              },
              {
                key: "l2Lambda",
                type: "number",
                default: 0.0001,
                min: 0,
                max: 0.1,
                step: 0.0001,
                desc:
                  "L2 regularization strength. Prevents overfitting.",
                tip:
                  "Increase to 0.001-0.01 for small datasets or noisy data.",
              },
              {
                key: "gradientClipNorm",
                type: "number",
                default: 1,
                min: 0,
                max: 10,
                step: 0.1,
                desc: "Max update norm. Prevents explosive updates.",
                tip: "Lower to 0.5 for unstable training.",
              },
            ],
          },
          {
            name: "📊 Normalization",
            params: [
              {
                key: "normalizationEpsilon",
                type: "number",
                default: 1e-8,
                min: 1e-12,
                max: 1e-4,
                step: 1e-9,
                desc: "Stability constant for normalization.",
                tip: "Keep at 1e-8.",
              },
              {
                key: "normalizationWarmup",
                type: "number",
                default: 10,
                min: 1,
                max: 100,
                desc: "Samples before normalization activates.",
                tip: "Increase for very variable data ranges.",
              },
            ],
          },
          {
            name: "🛡️ Outlier Handling",
            params: [
              {
                key: "outlierThreshold",
                type: "number",
                default: 3,
                min: 1.5,
                max: 5,
                step: 0.1,
                desc:
                  "Z-score threshold for outlier detection. Lower = more aggressive.",
                tip:
                  "Use 2-2.5 for clean data, 3+ for keeping outliers.",
              },
              {
                key: "outlierMinWeight",
                type: "number",
                default: 0.1,
                min: 0,
                max: 0.5,
                step: 0.01,
                desc: "Minimum weight for detected outliers.",
                tip: "Set to 0 to completely ignore outliers.",
              },
            ],
          },
          {
            name: "📈 Uncertainty",
            params: [
              {
                key: "residualWindowSize",
                type: "number",
                default: 100,
                min: 10,
                max: 500,
                desc: "Recent residuals for uncertainty estimation.",
                tip:
                  "Larger = more stable estimates, smaller = more reactive.",
              },
              {
                key: "uncertaintyMultiplier",
                type: "number",
                default: 1.96,
                min: 1,
                max: 3,
                step: 0.01,
                desc: "Confidence interval multiplier. 1.96 ≈ 95% CI.",
                tip: "Use 1.64 for 90%, 2.58 for 99%.",
              },
            ],
          },
          {
            name: "⚙️ Initialization",
            params: [
              {
                key: "weightInitScale",
                type: "number",
                default: 0.1,
                min: 0.01,
                max: 1,
                step: 0.01,
                desc: "Scale for random weight initialization.",
                tip: "Keep at 0.1.",
              },
              {
                key: "seed",
                type: "number",
                default: 42,
                min: 0,
                max: 999999,
                desc: "Random seed for reproducibility.",
                tip: "Change for different random initializations.",
              },
              {
                key: "verbose",
                type: "checkbox",
                default: false,
                desc: "Enable verbose logging.",
                tip: "Enable for debugging.",
              },
              {
                key: "rollforwardMode",
                type: "select",
                default: "holdLastX",
                options: ["holdLastX", "autoregressive"],
                desc:
                  "Multi-step prediction mode. holdLastX repeats last input, autoregressive uses predictions.",
                tip:
                  "Use autoregressive only when nFeatures == nTargets.",
              },
            ],
          },
        ];

        const COLORS = [
          "#3B82F6",
          "#10B981",
          "#F59E0B",
          "#EF4444",
          "#8B5CF6",
          "#EC4899",
          "#06B6D4",
          "#84CC16",
        ];

        let worker = null;
        let requestId = 0;
        let pendingRequests = {};
        let currentConfig = { ...PRESETS.starthere };
        let modelState = {
          hasModel: false,
          nFeatures: 0,
          nTargets: 0,
          sampleCount: 0,
        };
        let predictions = null;
        let currentDim = 0;
        let zoom = { scale: 1, offset: 0 };
        let isDark = localStorage.getItem("darkMode") === "true";
        let moduleUrl = localStorage.getItem("moduleUrl") ||
          "https://cdn.esm.sh/jsr/@hviana/multivariate-regression";
        let cancelTokens = new Set();

        function $(id) {
          return document.getElementById(id);
        }
        function $$(sel) {
          return document.querySelectorAll(sel);
        }

        function initDarkMode() {
          if (isDark) document.documentElement.classList.add("dark");
          $("darkModeToggle").onclick = () => {
            isDark = !isDark;
            document.documentElement.classList.toggle("dark", isDark);
            localStorage.setItem("darkMode", isDark);
            if (predictions) renderChart();
          };
        }

        function showToast(msg, type = "info") {
          const colors = {
            info: "bg-blue-600",
            success: "bg-emerald-600",
            warning: "bg-amber-500",
            error: "bg-red-600",
          };
          const toast = document.createElement("div");
          toast.className =
            `toast-enter px-4 py-3 rounded-lg shadow-lg text-white text-sm ${
              colors[type] || colors.info
            }`;
          toast.textContent = msg;
          $("toastContainer").appendChild(toast);
          setTimeout(() => {
            toast.classList.replace("toast-enter", "toast-exit");
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        function addLog(msg, type = "info") {
          const icons = {
            info: "ℹ️",
            success: "✅",
            warning: "⚠️",
            error: "❌",
          };
          const now = new Date().toLocaleTimeString();
          const entry = document.createElement("div");
          entry.className =
            "p-2 rounded bg-slate-50 dark:bg-slate-700/50";
          entry.dataset.type = type;
          entry.innerHTML = `<span class="opacity-50">${now}</span> ${
            icons[type] || ""
          } ${msg}`;
          $("logList").prepend(entry);
          if ($("logList").children.length > 100) {
            $("logList").lastChild.remove();
          }
          filterLogs();
        }

        function filterLogs() {
          const f = $("logFilter").value;
          $$("#logList>div").forEach((e) =>
            e.classList.toggle(
              "hidden",
              f !== "all" && e.dataset.type !== f,
            )
          );
        }

        function setLoading(
          show,
          text = "Processing...",
          showProgress = false,
          showCancel = false,
        ) {
          $("loadingState").classList.toggle("hidden", !show);
          $("loadingText").textContent = text;
          $("progressBar").classList.toggle("hidden", !showProgress);
          $("cancelBtn").classList.toggle("hidden", !showCancel);
        }

        function setProgress(pct) {
          $("progressFill").style.width = pct + "%";
        }

        const workerCode = `
let ESNRegression=null;
let model=null;
let moduleUrl='https://cdn.esm.sh/jsr/@hviana/multivariate-regression';

async function loadModule(url){
try{
const m=await import(url);
ESNRegression=m.ESNRegression||m.default?.ESNRegression||m.default;
if(!ESNRegression)throw new Error('ESNRegression not found in module');
return true;
}catch(e){
console.warn('Dynamic import failed:',e);
try{
const res=await fetch(url);
let text=await res.text();
const match=text.match(/class\\s+ESNRegression/);
if(!match)throw new Error('ESNRegression class not found');
const fn=new Function('exports',text+';return ESNRegression;');
ESNRegression=fn({});
return true;
}catch(e2){
throw new Error('Failed to load module: '+e2.message);
}
}
}

self.onmessage=async(e)=>{
const{requestId,type,payload}=e.data;
const reply=(data)=>self.postMessage({requestId,...data});
const progress=(p)=>self.postMessage({requestId,type:'progress',...p});
try{
switch(type){
case 'init':{
if(payload?.url)moduleUrl=payload.url;
await loadModule(moduleUrl);
reply({type:'ready'});
break;
}
case 'create':{
if(!ESNRegression)throw new Error('Module not loaded');
model=new ESNRegression(payload);
reply({type:'created',summary:model.getModelSummary()});
break;
}
case 'fit':{
if(!model)throw new Error('No model');
const{xCoordinates,yCoordinates}=payload;
const total=xCoordinates.length;
let result;
for(let i=0;i<total;i++){
result=model.fitOnline({xCoordinates:[xCoordinates[i]],yCoordinates:[yCoordinates[i]]});
if(i%10===0||i===total-1)progress({processed:i+1,total,percent:Math.round((i+1)/total*100),stage:'training'});
}
reply({type:'fitted',result,summary:model.getModelSummary()});
break;
}
case 'fitSingle':{
if(!model)throw new Error('No model');
const result=model.fitOnline(payload);
reply({type:'fitted',result,summary:model.getModelSummary()});
break;
}
case 'predict':{
if(!model)throw new Error('No model');
const result=model.predict(payload.futureSteps);
reply({type:'predicted',result});
break;
}
case 'save':{
if(!model)throw new Error('No model');
const state=model.save();
const summary=model.getModelSummary();
reply({type:'saved',state,summary});
break;
}
case 'load':{
if(!ESNRegression)throw new Error('Module not loaded');
model=new ESNRegression();
model.load(payload.state);
reply({type:'loaded',summary:model.getModelSummary()});
break;
}
case 'getSummary':{
if(!model)throw new Error('No model');
reply({type:'summary',summary:model.getModelSummary()});
break;
}
default:reply({type:'error',error:'Unknown type: '+type});
}
}catch(err){
reply({type:'error',error:err.message||String(err)});
}
};
`;

        function initWorker() {
          if (worker) worker.terminate();
          const blob = new Blob([workerCode], {
            type: "application/javascript",
          });
          worker = new Worker(URL.createObjectURL(blob), {
            type: "module",
          });
          worker.onmessage = (e) => {
            const { requestId: rid, type } = e.data;
            if (type === "progress") {
              const p = pendingRequests[rid];
              if (p?.onProgress) p.onProgress(e.data);
              return;
            }
            const p = pendingRequests[rid];
            if (p) {
              delete pendingRequests[rid];
              if (type === "error") p.reject(new Error(e.data.error));
              else p.resolve(e.data);
            }
          };
          worker.onerror = (e) => {
            addLog("Worker error: " + e.message, "error");
          };
          return send("init", { url: moduleUrl }).then(() => {
            addLog("Worker initialized", "success");
          }).catch((e) => {
            addLog("Worker init failed: " + e.message, "error");
            showToast("Worker failed to initialize", "error");
          });
        }

        function send(type, payload = {}) {
          return new Promise((resolve, reject) => {
            const rid = ++requestId;
            pendingRequests[rid] = { resolve, reject };
            worker.postMessage({ requestId: rid, type, payload });
          });
        }

        function sendWithProgress(type, payload, onProgress) {
          return new Promise((resolve, reject) => {
            const rid = ++requestId;
            pendingRequests[rid] = { resolve, reject, onProgress };
            worker.postMessage({ requestId: rid, type, payload });
          });
        }

        function updateModelStatus() {
          const dot = $("statusDot");
          const txt = $("statusText");
          if (modelState.hasModel) {
            dot.className = "w-2 h-2 rounded-full bg-emerald-500";
            txt.textContent =
              `${modelState.nFeatures}F/${modelState.nTargets}T · ${modelState.sampleCount} samples`;
            $("quickPredict").disabled = false;
            $("runPredict").disabled = false;
            $("mobilePredict").disabled = false;
            $("saveToFile").disabled = false;
            $("saveToLocal").disabled = false;
          } else {
            dot.className = "w-2 h-2 rounded-full bg-slate-400";
            txt.textContent = "No Model";
            $("quickPredict").disabled = true;
            $("runPredict").disabled = true;
            $("mobilePredict").disabled = true;
            $("saveToFile").disabled = true;
            $("saveToLocal").disabled = true;
          }
          updateModelSummary();
          updateConfigChips();
        }

        function updateModelSummary() {
          const c = $("modelSummary");
          if (!modelState.hasModel) {
            c.innerHTML =
              '<p class="text-slate-400 italic">No model loaded</p>';
            return;
          }
          c.innerHTML = `
<p><span class="text-slate-500">Reservoir:</span> ${currentConfig.reservoirSize}</p>
<p><span class="text-slate-500">Spectral Radius:</span> ${currentConfig.spectralRadius}</p>
<p><span class="text-slate-500">Features:</span> ${modelState.nFeatures}</p>
<p><span class="text-slate-500">Targets:</span> ${modelState.nTargets}</p>
<p><span class="text-slate-500">Samples:</span> ${modelState.sampleCount}</p>
`;
        }

        function updateConfigChips() {
          const c = $("configChips");
          if (!modelState.hasModel) {
            c.innerHTML = "";
            return;
          }
          c.innerHTML = `
<span class="chip bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">R${currentConfig.reservoirSize}</span>
<span class="chip bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">ρ${currentConfig.spectralRadius}</span>
`;
        }

        function updateDimSelector() {
          const sel = $("dimSelector");
          sel.innerHTML = "";
          const n = modelState.nTargets || 1;
          for (let i = 0; i < n; i++) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = `Dimension ${i}`;
            sel.appendChild(opt);
          }
          sel.value = currentDim = 0;
        }

        function buildConfigModal() {
          const container = $("configSections");
          container.innerHTML = "";
          CONFIG_SECTIONS.forEach((sec) => {
            const div = document.createElement("div");
            div.innerHTML =
              `<h3 class="font-medium text-sm mb-3 flex items-center gap-2">${sec.name}</h3>`;
            const grid = document.createElement("div");
            grid.className = "grid grid-cols-1 sm:grid-cols-2 gap-4";
            sec.params.forEach((p) => {
              const wrap = document.createElement("div");
              wrap.className = "space-y-1";
              let input = "";
              if (p.type === "number") {
                input =
                  `<input type="number" id="cfg_${p.key}" value="${
                    currentConfig[p.key]
                  }" min="${p.min || ""}" max="${p.max || ""}" step="${
                    p.step || 1
                  }" class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1.5 bg-transparent focus-ring">`;
              } else if (p.type === "checkbox") {
                input = `<input type="checkbox" id="cfg_${p.key}" ${
                  currentConfig[p.key] ? "checked" : ""
                } class="w-4 h-4 rounded border-slate-300 dark:border-slate-600 text-blue-600 focus-ring">`;
              } else if (p.type === "select") {
                input =
                  `<select id="cfg_${p.key}" class="w-full text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1.5 bg-transparent focus-ring">${
                    p.options.map((o) =>
                      `<option value="${o}" ${
                        currentConfig[p.key] === o ? "selected" : ""
                      }>${o}</option>`
                    ).join("")
                  }</select>`;
              }
              wrap.innerHTML = `
<label class="text-xs font-medium flex items-center gap-2">${p.key}${
                p.type === "checkbox" ? input : ""
              }</label>
${p.type !== "checkbox" ? input : ""}
<details class="text-xs text-slate-500"><summary class="cursor-pointer hover:text-slate-700 dark:hover:text-slate-300">Info</summary><p class="mt-1">${p.desc}</p><p class="mt-1 text-blue-600 dark:text-blue-400">💡 ${p.tip}</p></details>
`;
              grid.appendChild(wrap);
            });
            div.appendChild(grid);
            container.appendChild(div);
          });
        }

        function getConfigFromForm() {
          const cfg = {};
          CONFIG_SECTIONS.forEach((sec) =>
            sec.params.forEach((p) => {
              const el = $(`cfg_${p.key}`);
              if (!el) return;
              if (p.type === "checkbox") cfg[p.key] = el.checked;
              else if (p.type === "number") {
                cfg[p.key] = parseFloat(el.value);
              } else cfg[p.key] = el.value;
            })
          );
          return cfg;
        }

        function setConfigToForm(cfg) {
          CONFIG_SECTIONS.forEach((sec) =>
            sec.params.forEach((p) => {
              const el = $(`cfg_${p.key}`);
              if (!el) return;
              if (p.type === "checkbox") el.checked = !!cfg[p.key];
              else el.value = cfg[p.key];
            })
          );
        }

        async function createModel(cfg) {
          setLoading(true, "Creating model...");
          try {
            currentConfig = { ...cfg };
            const res = await send("create", cfg);
            modelState = {
              hasModel: true,
              nFeatures: res.summary.nFeatures,
              nTargets: res.summary.nTargets,
              sampleCount: res.summary.sampleCount,
            };
            updateModelStatus();
            updateDimSelector();
            addLog("Model created", "success");
            showToast("Model created", "success");
            localStorage.setItem("lastConfig", JSON.stringify(cfg));
            hideEmptyState();
          } catch (e) {
            addLog("Create failed: " + e.message, "error");
            showToast("Failed to create model", "error");
          } finally {
            setLoading(false);
          }
        }

        function validateDataset(data) {
          if (!data || typeof data !== "object") {
            return { valid: false, error: "Invalid JSON object" };
          }
          if (!Array.isArray(data.xCoordinates)) {
            return {
              valid: false,
              error: "Missing or invalid xCoordinates array",
            };
          }
          if (!Array.isArray(data.yCoordinates)) {
            return {
              valid: false,
              error: "Missing or invalid yCoordinates array",
            };
          }
          if (data.xCoordinates.length === 0) {
            return { valid: false, error: "xCoordinates is empty" };
          }
          if (data.xCoordinates.length !== data.yCoordinates.length) {
            return {
              valid: false,
              error:
                `Length mismatch: xCoordinates(${data.xCoordinates.length}) vs yCoordinates(${data.yCoordinates.length})`,
            };
          }
          const nF = data.xCoordinates[0]?.length;
          const nT = data.yCoordinates[0]?.length;
          if (!nF || !nT) {
            return {
              valid: false,
              error: "Samples must be non-empty arrays",
            };
          }
          for (let i = 0; i < data.xCoordinates.length; i++) {
            if (
              !Array.isArray(data.xCoordinates[i]) ||
              data.xCoordinates[i].length !== nF
            ) {
              return {
                valid: false,
                error:
                  `xCoordinates[${i}] has wrong length (expected ${nF})`,
              };
            }
            if (
              !Array.isArray(data.yCoordinates[i]) ||
              data.yCoordinates[i].length !== nT
            ) {
              return {
                valid: false,
                error:
                  `yCoordinates[${i}] has wrong length (expected ${nT})`,
              };
            }
            for (let j = 0; j < nF; j++) {
              if (
                typeof data.xCoordinates[i][j] !== "number" ||
                isNaN(data.xCoordinates[i][j])
              ) {
                return {
                  valid: false,
                  error:
                    `xCoordinates[${i}][${j}] is not a valid number`,
                };
              }
            }
            for (let j = 0; j < nT; j++) {
              if (
                typeof data.yCoordinates[i][j] !== "number" ||
                isNaN(data.yCoordinates[i][j])
              ) {
                return {
                  valid: false,
                  error:
                    `yCoordinates[${i}][${j}] is not a valid number`,
                };
              }
            }
          }
          return {
            valid: true,
            nFeatures: nF,
            nTargets: nT,
            sampleCount: data.xCoordinates.length,
          };
        }

        async function trainOnData(data) {
          setLoading(true, "Training...", true, true);
          try {
            const res = await sendWithProgress("fit", data, (p) => {
              setProgress(p.percent);
              $("loadingText").textContent =
                `Training... ${p.processed}/${p.total}`;
            });
            modelState.sampleCount = res.summary.sampleCount;
            updateModelStatus();
            addLog(
              `Trained on ${data.xCoordinates.length} samples, avg loss: ${
                res.result.averageLoss.toFixed(6)
              }`,
              "success",
            );
            showToast("Training complete", "success");
          } catch (e) {
            addLog("Training failed: " + e.message, "error");
            showToast("Training failed", "error");
          } finally {
            setLoading(false);
            setProgress(0);
          }
        }

        async function runPrediction() {
          const steps = parseInt($("futureStepsInput").value) || 10;
          if (steps < 1 || steps > currentConfig.maxSequenceLength) {
            showToast(
              `Steps must be 1-${currentConfig.maxSequenceLength}`,
              "warning",
            );
            return;
          }
          setLoading(true, "Predicting...");
          try {
            const res = await send("predict", { futureSteps: steps });
            predictions = res.result;
            addLog(
              `Predicted ${steps} steps, confidence: ${
                (predictions.confidence * 100).toFixed(1)
              }%`,
              "success",
            );
            showToast("Prediction complete", "success");
            $("emptyState").classList.add("hidden");
            $("statsBar").classList.remove("hidden");
            renderChart();
          } catch (e) {
            addLog("Prediction failed: " + e.message, "error");
            showToast("Prediction failed", "error");
          } finally {
            setLoading(false);
          }
        }

        function hideEmptyState() {
          $("emptyState").classList.add("hidden");
        }

        function showEmptyState() {
          $("emptyState").classList.remove("hidden");
          $("statsBar").classList.add("hidden");
        }

        // Chart rendering
        let chartAnimFrame = null;
        let hoverX = -1;
        let hoverY = -1;

        function renderChart() {
          if (!predictions) return;
          cancelAnimationFrame(chartAnimFrame);
          const mode = $("vizMode").value;
          const canvas = $("mainCanvas");
          const container = $("chartArea");
          const rect = container.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          canvas.style.width = rect.width + "px";
          canvas.style.height = rect.height + "px";
          const ctx = canvas.getContext("2d");
          ctx.scale(dpr, dpr);
          ctx.translate(0.5, 0.5);
          const w = rect.width;
          const h = rect.height;

          const bg = isDark ? "#1E293B" : "#FFFFFF";
          ctx.fillStyle = bg;
          ctx.fillRect(-1, -1, w + 2, h + 2);

          if (mode === "focus") renderFocus(ctx, w, h);
          else if (mode === "grid") renderGrid(ctx, w, h);
          else if (mode === "heatmap") renderHeatmap(ctx, w, h);
          else if (mode === "uncertainty") renderUncertainty(ctx, w, h);
          else if (mode === "snapshot") renderSnapshot(ctx, w, h);

          updateStats();
        }

        function renderFocus(ctx, w, h) {
          const d = currentDim;
          const data = predictions.predictions.map((p) => p[d]);
          const lower = predictions.lowerBounds.map((p) => p[d]);
          const upper = predictions.upperBounds.map((p) => p[d]);
          const n = data.length;

          const margin = { left: 60, right: 20, top: 20, bottom: 40 };
          const cw = w - margin.left - margin.right;
          const ch = h - margin.top - margin.bottom;

          let minY = Math.min(...lower);
          let maxY = Math.max(...upper);
          const pad = (maxY - minY) * 0.1 || 1;
          minY -= pad;
          maxY += pad;

          const ticks = niceScale(minY, maxY, 6);
          minY = ticks[0];
          maxY = ticks[ticks.length - 1];

          const scaleX = (i) => margin.left + (i / (n - 1 || 1)) * cw;
          const scaleY = (v) =>
            margin.top + ch - (v - minY) / (maxY - minY) * ch;

          // Grid
          ctx.strokeStyle = isDark
            ? "rgba(255,255,255,0.06)"
            : "rgba(0,0,0,0.06)";
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          ticks.forEach((t) => {
            const y = scaleY(t);
            ctx.beginPath();
            ctx.moveTo(margin.left, y);
            ctx.lineTo(w - margin.right, y);
            ctx.stroke();
          });
          ctx.setLineDash([]);

          // Axes
          ctx.strokeStyle = isDark
            ? "rgba(255,255,255,0.15)"
            : "rgba(0,0,0,0.15)";
          ctx.beginPath();
          ctx.moveTo(margin.left, margin.top);
          ctx.lineTo(margin.left, h - margin.bottom);
          ctx.lineTo(w - margin.right, h - margin.bottom);
          ctx.stroke();

          // Labels
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "11px system-ui,-apple-system,sans-serif";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          ticks.forEach((t) => {
            const y = scaleY(t);
            ctx.fillText(formatNum(t), margin.left - 8, y);
          });
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          const step = Math.max(1, Math.floor(n / 8));
          for (let i = 0; i < n; i += step) {
            ctx.fillText(i, scaleX(i), h - margin.bottom + 8);
          }

          // Confidence band
          const color = COLORS[d % COLORS.length];
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(upper[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          for (let i = n - 1; i >= 0; i--) {
            ctx.lineTo(scaleX(i), scaleY(lower[i]));
          }
          ctx.closePath();
          const grad = ctx.createLinearGradient(
            0,
            margin.top,
            0,
            h - margin.bottom,
          );
          const alpha = isDark ? 0.15 : 0.12;
          grad.addColorStop(0, color + hex(alpha * 255));
          grad.addColorStop(1, color + hex(alpha * 0.3 * 255));
          ctx.fillStyle = grad;
          ctx.fill();

          // Band stroke
          ctx.strokeStyle = color + "4D";
          ctx.lineWidth = 1;
          ctx.setLineDash([3, 3]);
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(upper[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(lower[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.setLineDash([]);

          // Glow
          ctx.strokeStyle = color + "26";
          ctx.lineWidth = 6;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(data[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(data[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Hover
          if (hoverX >= margin.left && hoverX <= w - margin.right) {
            const idx = Math.round(
              (hoverX - margin.left) / cw * (n - 1),
            );
            if (idx >= 0 && idx < n) {
              const x = scaleX(idx);
              const y = scaleY(data[idx]);
              ctx.strokeStyle = isDark
                ? "rgba(255,255,255,0.5)"
                : "rgba(0,0,0,0.3)";
              ctx.lineWidth = 1;
              ctx.setLineDash([4, 4]);
              ctx.beginPath();
              ctx.moveTo(x, margin.top);
              ctx.lineTo(x, h - margin.bottom);
              ctx.stroke();
              ctx.beginPath();
              ctx.moveTo(margin.left, y);
              ctx.lineTo(x, y);
              ctx.stroke();
              ctx.setLineDash([]);
              ctx.fillStyle = color + "4D";
              ctx.beginPath();
              ctx.arc(x, y, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = color;
              ctx.beginPath();
              ctx.arc(x, y, 5, 0, Math.PI * 2);
              ctx.fill();
              showTooltip(
                hoverX,
                hoverY,
                `Step ${idx}<br>Pred: ${
                  formatNum(data[idx])
                }<br>Range: [${formatNum(lower[idx])}, ${
                  formatNum(upper[idx])
                }]`,
              );
            }
          }
        }

        function renderGrid(ctx, w, h) {
          const nT = modelState.nTargets;
          const cols = w < 600 ? 2 : w < 900 ? 3 : 4;
          const rows = Math.ceil(nT / cols);
          const cw = w / cols;
          const ch = h / rows;
          for (let d = 0; d < nT; d++) {
            const col = d % cols;
            const row = Math.floor(d / cols);
            const ox = col * cw + 10;
            const oy = row * ch + 10;
            const iw = cw - 20;
            const ih = ch - 30;
            const data = predictions.predictions.map((p) => p[d]);
            const lower = predictions.lowerBounds.map((p) => p[d]);
            const upper = predictions.upperBounds.map((p) => p[d]);
            const n = data.length;
            let minY = Math.min(...lower);
            let maxY = Math.max(...upper);
            const pad = (maxY - minY) * 0.1 || 1;
            minY -= pad;
            maxY += pad;
            const scaleX = (i) => ox + (i / (n - 1 || 1)) * iw;
            const scaleY = (v) =>
              oy + ih - (v - minY) / (maxY - minY) * ih;
            const color = COLORS[d % COLORS.length];
            ctx.strokeStyle = isDark
              ? "rgba(255,255,255,0.06)"
              : "rgba(0,0,0,0.06)";
            ctx.lineWidth = 1;
            ctx.strokeRect(ox, oy, iw, ih);
            ctx.beginPath();
            for (let i = 0; i < n; i++) {
              const x = scaleX(i), y = scaleY(upper[i]);
              i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            for (let i = n - 1; i >= 0; i--) {
              ctx.lineTo(scaleX(i), scaleY(lower[i]));
            }
            ctx.closePath();
            ctx.fillStyle = color + (isDark ? "26" : "1F");
            ctx.fill();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < n; i++) {
              const x = scaleX(i), y = scaleY(data[i]);
              i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
            ctx.font = "10px system-ui";
            ctx.textAlign = "left";
            ctx.fillText(`Dim ${d}`, ox + 4, oy + ih + 12);
            ctx.textAlign = "right";
            ctx.fillText(formatNum(data[n - 1]), ox + iw, oy + ih + 12);
          }
        }

        function renderHeatmap(ctx, w, h) {
          const nT = modelState.nTargets;
          const nS = predictions.predictions.length;
          const margin = { left: 50, right: 60, top: 20, bottom: 40 };
          const cw = w - margin.left - margin.right;
          const ch = h - margin.top - margin.bottom;
          const cellW = cw / nS;
          const cellH = ch / nT;
          let minV = Infinity, maxV = -Infinity;
          predictions.predictions.forEach((row) =>
            row.forEach((v) => {
              if (v < minV) minV = v;
              if (v > maxV) maxV = v;
            })
          );
          const range = maxV - minV || 1;
          for (let t = 0; t < nT; t++) {
            for (let s = 0; s < nS; s++) {
              const v = (predictions.predictions[s][t] - minV) / range;
              const color = heatColor(v);
              ctx.fillStyle = color;
              ctx.fillRect(
                margin.left + s * cellW,
                margin.top + t * cellH,
                cellW - 1,
                cellH - 1,
              );
            }
          }
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          for (let t = 0; t < nT; t++) {
            ctx.fillText(
              `D${t}`,
              margin.left - 4,
              margin.top + t * cellH + cellH / 2,
            );
          }
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          const step = Math.max(1, Math.floor(nS / 10));
          for (let s = 0; s < nS; s += step) {
            ctx.fillText(
              s,
              margin.left + s * cellW + cellW / 2,
              h - margin.bottom + 4,
            );
          }
          // Legend
          const lx = w - margin.right + 10;
          const ly = margin.top;
          const lh = ch;
          const lgrd = ctx.createLinearGradient(0, ly, 0, ly + lh);
          for (let i = 0; i <= 10; i++) {
            lgrd.addColorStop(i / 10, heatColor(1 - i / 10));
          }
          ctx.fillStyle = lgrd;
          ctx.fillRect(lx, ly, 15, lh);
          ctx.textAlign = "left";
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.fillText(formatNum(maxV), lx + 20, ly + 5);
          ctx.fillText(formatNum(minV), lx + 20, ly + lh - 5);
        }

        function renderUncertainty(ctx, w, h) {
          const d = currentDim;
          const data = predictions.predictions.map((p, i) =>
            predictions.upperBounds[i][d] -
            predictions.lowerBounds[i][d]
          );
          const n = data.length;
          const margin = { left: 60, right: 20, top: 20, bottom: 40 };
          const cw = w - margin.left - margin.right;
          const ch = h - margin.top - margin.bottom;
          const maxY = Math.max(...data) * 1.1 || 1;
          const scaleX = (i) => margin.left + (i / (n - 1 || 1)) * cw;
          const scaleY = (v) => margin.top + ch - v / maxY * ch;
          ctx.strokeStyle = isDark
            ? "rgba(255,255,255,0.15)"
            : "rgba(0,0,0,0.15)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(margin.left, margin.top);
          ctx.lineTo(margin.left, h - margin.bottom);
          ctx.lineTo(w - margin.right, h - margin.bottom);
          ctx.stroke();
          const grad = ctx.createLinearGradient(
            0,
            margin.top,
            0,
            h - margin.bottom,
          );
          grad.addColorStop(0, "#EF4444");
          grad.addColorStop(0.5, "#F59E0B");
          grad.addColorStop(1, "#10B981");
          ctx.beginPath();
          ctx.moveTo(scaleX(0), h - margin.bottom);
          for (let i = 0; i < n; i++) {
            ctx.lineTo(scaleX(i), scaleY(data[i]));
          }
          ctx.lineTo(scaleX(n - 1), h - margin.bottom);
          ctx.closePath();
          ctx.fillStyle = grad;
          ctx.globalAlpha = 0.5;
          ctx.fill();
          ctx.globalAlpha = 1;
          ctx.strokeStyle = "#F59E0B";
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = scaleX(i), y = scaleY(data[i]);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(
            formatNum(maxY),
            margin.left - 8,
            margin.top + 10,
          );
          ctx.fillText("0", margin.left - 8, h - margin.bottom);
          ctx.fillStyle = isDark ? "#E2E8F0" : "#1E293B";
          ctx.font = "bold 24px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(
            `${(predictions.confidence * 100).toFixed(0)}%`,
            w / 2,
            h / 2 - 20,
          );
          ctx.font = "12px system-ui";
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.fillText("Confidence", w / 2, h / 2 + 5);
        }

        function renderSnapshot(ctx, w, h) {
          const stepIdx = Math.min(
            parseInt($("futureStepsInput").value) - 1,
            predictions.predictions.length - 1,
          );
          const vals = predictions.predictions[stepIdx];
          const lower = predictions.lowerBounds[stepIdx];
          const upper = predictions.upperBounds[stepIdx];
          const nT = vals.length;
          const margin = { left: 50, right: 20, top: 20, bottom: 20 };
          const barH = (h - margin.top - margin.bottom) / nT - 4;
          const maxAbs =
            Math.max(...vals.map(Math.abs), ...upper.map(Math.abs)) *
              1.1 || 1;
          ctx.strokeStyle = isDark
            ? "rgba(255,255,255,0.15)"
            : "rgba(0,0,0,0.15)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          const zeroX = margin.left +
            (w - margin.left - margin.right) / 2;
          ctx.moveTo(zeroX, margin.top);
          ctx.lineTo(zeroX, h - margin.bottom);
          ctx.stroke();
          for (let t = 0; t < nT; t++) {
            const y = margin.top + t * (barH + 4);
            const v = vals[t];
            const l = lower[t];
            const u = upper[t];
            const bw = (Math.abs(v) / maxAbs) *
              (w - margin.left - margin.right) / 2;
            const x = v >= 0 ? zeroX : zeroX - bw;
            const color = COLORS[t % COLORS.length];
            ctx.fillStyle = color;
            ctx.fillRect(x, y, bw, barH);
            const errL = zeroX +
              (l / maxAbs) * (w - margin.left - margin.right) / 2;
            const errU = zeroX +
              (u / maxAbs) * (w - margin.left - margin.right) / 2;
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(errL, y + barH / 2);
            ctx.lineTo(errU, y + barH / 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(errL, y + barH / 4);
            ctx.lineTo(errL, y + barH * 3 / 4);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(errU, y + barH / 4);
            ctx.lineTo(errU, y + barH * 3 / 4);
            ctx.stroke();
            ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
            ctx.font = "10px system-ui";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(`D${t}`, margin.left - 4, y + barH / 2);
          }
        }

        function heatColor(v) {
          if (isDark) {
            const r = Math.round(30 + v * 200);
            const g = Math.round(40 + v * 180);
            const b = Math.round(60 + v * 100);
            return `rgb(${r},${g},${b})`;
          } else {
            const r = Math.round(255 - v * 200);
            const g = Math.round(255 - v * 100);
            const b = Math.round(255);
            return `rgb(${r},${g},${b})`;
          }
        }

        function hex(n) {
          return Math.round(n).toString(16).padStart(2, "0");
        }

        function formatNum(n) {
          if (Math.abs(n) >= 1e6 || Math.abs(n) < 0.001 && n !== 0) {
            return n.toExponential(2);
          }
          return n.toFixed(Math.abs(n) < 10 ? 3 : 1);
        }

        function niceScale(min, max, ticks) {
          const range = max - min;
          const rough = range / ticks;
          const mag = Math.pow(10, Math.floor(Math.log10(rough)));
          const norm = rough / mag;
          let nice;
          if (norm < 1.5) nice = 1;
          else if (norm < 3) nice = 2;
          else if (norm < 7) nice = 5;
          else nice = 10;
          const step = nice * mag;
          const start = Math.floor(min / step) * step;
          const result = [];
          for (let v = start; v <= max + step * 0.5; v += step) {
            result.push(v);
          }
          return result;
        }

        function showTooltip(x, y, html) {
          const t = $("tooltip");
          t.innerHTML = html;
          t.classList.remove("hidden");
          const rect = $("chartArea").getBoundingClientRect();
          let tx = x + 15, ty = y - 10;
          if (tx + 150 > rect.width) tx = x - 160;
          if (ty < 10) ty = 10;
          t.style.left = tx + "px";
          t.style.top = ty + "px";
        }

        function hideTooltip() {
          $("tooltip").classList.add("hidden");
        }

        function updateStats() {
          if (!predictions) return;
          const d = currentDim;
          const data = predictions.predictions.map((p) => p[d]);
          const min = Math.min(...data);
          const max = Math.max(...data);
          const mean = data.reduce((a, b) => a + b, 0) / data.length;
          $("statMin").textContent = formatNum(min);
          $("statMax").textContent = formatNum(max);
          $("statMean").textContent = formatNum(mean);
          $("statFinal").textContent = formatNum(data[data.length - 1]);
          $("statConfidence").textContent =
            (predictions.confidence * 100).toFixed(1) + "%";
        }

        function generateTestData(
          seed,
          nF,
          nT,
          count,
          noise,
          outlierRate,
        ) {
          const rng = mulberry32(seed);
          const x = [], y = [];
          const coefs = [];
          for (let t = 0; t < nT; t++) {
            coefs.push([]);
            for (let f = 0; f < nF; f++) {
              coefs[t].push((rng() - 0.5) * 2);
            }
          }
          for (let i = 0; i < count; i++) {
            const xi = [];
            for (let f = 0; f < nF; f++) {
              xi.push(Math.sin(i * 0.1 + f) + rng() * 0.5);
            }
            x.push(xi);
            const yi = [];
            for (let t = 0; t < nT; t++) {
              let v = 0;
              for (let f = 0; f < nF; f++) v += coefs[t][f] * xi[f];
              v += Math.sin(i * 0.05) * 0.5;
              v += Math.tanh(xi[0] * xi[1 % nF]) * 0.3;
              v += (rng() - 0.5) * noise * 2;
              if (rng() < outlierRate) {
                v += rng() * 5 * (rng() > 0.5 ? 1 : -1);
              }
              yi.push(v);
            }
            y.push(yi);
          }
          return { xCoordinates: x, yCoordinates: y, coefs };
        }

        function mulberry32(a) {
          return function () {
            a |= 0;
            a = a + 0x6D2B79F5 | 0;
            var t = Math.imul(a ^ a >>> 15, 1 | a);
            t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
          };
        }

        // Modal management
        function openModal(id) {
          $(id).classList.remove("hidden");
          setTimeout(
            () =>
              $(id).querySelector(".relative").classList.add(
                "scale-100",
              ),
            10,
          );
        }
        function closeModal(id) {
          $(id).classList.add("hidden");
        }
        function setupModalClose(modalId, backdropId, closeBtnId) {
          $(backdropId).onclick = () => closeModal(modalId);
          $(closeBtnId).onclick = () => closeModal(modalId);
        }

        // Event bindings
        function bindEvents() {
          $("menuBtn").onclick = () => {
            $("menuOverlay").classList.remove("hidden");
            setTimeout(
              () =>
                $("menuPanel").classList.remove("-translate-x-full"),
              10,
            );
          };
          $("closeMenu").onclick = $("menuBackdrop").onclick = () => {
            $("menuPanel").classList.add("-translate-x-full");
            setTimeout(
              () => $("menuOverlay").classList.add("hidden"),
              300,
            );
          };
          $("menuConfig").onclick = () => {
            closeMenu();
            buildConfigModal();
            openModal("configModal");
          };
          $("menuSaveLoad").onclick = () => {
            closeMenu();
            checkLocalStorage();
            openModal("saveLoadModal");
          };
          $("menuUpload").onclick = () => {
            closeMenu();
            openModal("uploadModal");
          };
          $("menuInsert").onclick = () => {
            closeMenu();
            setupInsertModal();
            openModal("insertModal");
          };
          $("menuRandomTest").onclick = () => {
            closeMenu();
            openModal("testModal");
          };
          $("menuSettings").onclick = () => {
            closeMenu();
            $("moduleUrl").value = moduleUrl;
            openModal("settingsModal");
          };
          setupModalClose(
            "configModal",
            "configBackdrop",
            "closeConfig",
          );
          setupModalClose(
            "uploadModal",
            "uploadBackdrop",
            "closeUpload",
          );
          setupModalClose(
            "insertModal",
            "insertBackdrop",
            "closeInsert",
          );
          setupModalClose(
            "saveLoadModal",
            "saveLoadBackdrop",
            "closeSaveLoad",
          );
          setupModalClose("testModal", "testBackdrop", "closeTest");
          setupModalClose(
            "settingsModal",
            "settingsBackdrop",
            "closeSettings",
          );
          $$(".preset-btn").forEach((btn) =>
            btn.onclick = () => {
              const p = btn.dataset.preset;
              if (PRESETS[p]) setConfigToForm(PRESETS[p]);
            }
          );
          $("resetDefaults").onclick = () =>
            setConfigToForm(PRESETS.starthere);
          $("resetEverything").onclick = () => {
            if (confirm("Clear model, data, logs, and localStorage?")) {
              localStorage.clear();
              location.reload();
            }
          };
          $("applyConfig").onclick = async () => {
            const cfg = getConfigFromForm();
            await createModel(cfg);
            closeModal("configModal");
          };
          $("logFilter").onchange = filterLogs;
          $("futureStepsRange").oninput = () =>
            $("futureStepsInput").value = $("futureStepsRange").value;
          $("futureStepsInput").oninput = () =>
            $("futureStepsRange").value = $("futureStepsInput").value;
          $("runPredict").onclick =
            $("quickPredict").onclick =
            $(
              "mobilePredict",
            ).onclick =
              runPrediction;
          $("vizMode").onchange = $("dimSelector").onchange = () => {
            currentDim = parseInt($("dimSelector").value);
            renderChart();
          };
          $("zoomIn").onclick = () => {
            zoom.scale *= 1.2;
            renderChart();
          };
          $("zoomOut").onclick = () => {
            zoom.scale /= 1.2;
            renderChart();
          };
          $("zoomReset").onclick = () => {
            zoom = { scale: 1, offset: 0 };
            renderChart();
          };
          $("exportPng").onclick = exportPng;
          const chartArea = $("chartArea");
          chartArea.onmousemove = (e) => {
            const r = chartArea.getBoundingClientRect();
            hoverX = e.clientX - r.left;
            hoverY = e.clientY - r.top;
            renderChart();
          };
          chartArea.onmouseleave = () => {
            hoverX = -1;
            hideTooltip();
            renderChart();
          };
          window.addEventListener(
            "resize",
            debounce(() => {
              if (predictions) renderChart();
            }, 150),
          );
          $("emptyStartHere").onclick = () => {
            buildConfigModal();
            setConfigToForm(PRESETS.starthere);
            openModal("configModal");
          };
          $("emptyLoadModel").onclick = () => {
            checkLocalStorage();
            openModal("saveLoadModal");
          };
          $("emptyRunTest").onclick = runRandomTest;
          $("fileInput").onchange = handleFileUpload;
          $("pasteJson").oninput = validateUploadJson;
          $("applyUpload").onclick = applyUploadData;
          $("cancelUpload").onclick = () => closeModal("uploadModal");
          $("insertJson").oninput = validateInsertJson;
          $("genTemplate").onclick = generateInsertTemplate;
          $("applyInsert").onclick = applyInsertData;
          $("cancelInsert").onclick = () => closeModal("insertModal");
          $("runTest").onclick = runRandomTest;
          $("cancelTest").onclick = () => closeModal("testModal");
          $("saveToFile").onclick = saveToFile;
          $("saveToLocal").onclick = saveToLocal;
          $("loadFileInput").onchange = loadFromFile;
          $("loadFromLocal").onclick = loadFromLocal;
          $("clearLocal").onclick = clearLocalStorage;
          $("restartWorker").onclick = async () => {
            moduleUrl = $("moduleUrl").value;
            localStorage.setItem("moduleUrl", moduleUrl);
            await initWorker();
            closeModal("settingsModal");
          };
          document.onkeydown = (e) => {
            if (e.key === "Escape") {
              $$("[id$=Modal]:not(.hidden)").forEach((m) =>
                m.classList.add("hidden")
              );
              $("menuPanel").classList.add("-translate-x-full");
              setTimeout(
                () => $("menuOverlay").classList.add("hidden"),
                300,
              );
            }
            if (e.key === "m" && !e.ctrlKey && !isInput(e)) {
              $("menuBtn").click();
            }
            if (e.key === "c" && !e.ctrlKey && !isInput(e)) {
              buildConfigModal();
              openModal("configModal");
            }
            if (
              e.key === "p" && !e.ctrlKey && !isInput(e) &&
              modelState.hasModel
            ) runPrediction();
          };
        }

        function isInput(e) {
          return ["INPUT", "TEXTAREA", "SELECT"].includes(
            e.target.tagName,
          );
        }
        function closeMenu() {
          $("menuPanel").classList.add("-translate-x-full");
          setTimeout(
            () => $("menuOverlay").classList.add("hidden"),
            300,
          );
        }
        function debounce(fn, ms) {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        }

        let pendingUploadData = null;
        function handleFileUpload(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            $("pasteJson").value = ev.target.result;
            validateUploadJson();
          };
          reader.readAsText(file);
        }

        function validateUploadJson() {
          const txt = $("pasteJson").value.trim();
          $("uploadPreview").classList.add("hidden");
          $("uploadError").classList.add("hidden");
          $("applyUpload").disabled = true;
          pendingUploadData = null;
          if (!txt) return;
          try {
            const data = JSON.parse(txt);
            const v = validateDataset(data);
            if (!v.valid) {
              $("uploadError").textContent = v.error;
              $("uploadError").classList.remove("hidden");
              return;
            }
            pendingUploadData = data;
            $("uploadPreviewContent").innerHTML =
              `Features: ${v.nFeatures}, Targets: ${v.nTargets}, Samples: ${v.sampleCount}<br>First X: [${
                data.xCoordinates[0].slice(0, 5).map((x) =>
                  x.toFixed(2)
                ).join(", ")
              }${data.xCoordinates[0].length > 5 ? "..." : ""}]`;
            $("uploadPreview").classList.remove("hidden");
            $("applyUpload").disabled = false;
          } catch (e) {
            $("uploadError").textContent = "Invalid JSON: " + e.message;
            $("uploadError").classList.remove("hidden");
          }
        }

        async function applyUploadData() {
          if (!pendingUploadData) return;
          closeModal("uploadModal");
          if (!modelState.hasModel) {
            showToast("Create a model first", "warning");
            return;
          }
          const v = validateDataset(pendingUploadData);
          if (
            modelState.nFeatures && v.nFeatures !== modelState.nFeatures
          ) {
            showToast(
              `Feature mismatch: expected ${modelState.nFeatures}, got ${v.nFeatures}`,
              "error",
            );
            return;
          }
          if (
            modelState.nTargets && v.nTargets !== modelState.nTargets
          ) {
            showToast(
              `Target mismatch: expected ${modelState.nTargets}, got ${v.nTargets}`,
              "error",
            );
            return;
          }
          await trainOnData(pendingUploadData);
          pendingUploadData = null;
          $("pasteJson").value = "";
        }

        function setupInsertModal() {
          if (modelState.hasModel) {
            $("insertModelRequired").classList.add("hidden");
            $("insertForm").classList.remove("hidden");
            $("insertDimInfo").textContent =
              `Features: ${modelState.nFeatures}, Targets: ${modelState.nTargets}`;
          } else {
            $("insertModelRequired").classList.remove("hidden");
            $("insertForm").classList.add("hidden");
          }
          $("insertJson").value = "";
          $("insertPreview").classList.add("hidden");
          $("insertError").classList.add("hidden");
          $("applyInsert").disabled = true;
        }

        let pendingInsertData = null;
        function validateInsertJson() {
          const txt = $("insertJson").value.trim();
          $("insertPreview").classList.add("hidden");
          $("insertError").classList.add("hidden");
          $("applyInsert").disabled = true;
          pendingInsertData = null;
          if (!txt) return;
          try {
            const data = JSON.parse(txt);
            const v = validateDataset(data);
            if (!v.valid) {
              $("insertError").textContent = v.error;
              $("insertError").classList.remove("hidden");
              return;
            }
            if (v.nFeatures !== modelState.nFeatures) {
              $("insertError").textContent =
                `Feature mismatch: expected ${modelState.nFeatures}`;
              $("insertError").classList.remove("hidden");
              return;
            }
            if (v.nTargets !== modelState.nTargets) {
              $("insertError").textContent =
                `Target mismatch: expected ${modelState.nTargets}`;
              $("insertError").classList.remove("hidden");
              return;
            }
            pendingInsertData = data;
            $("insertPreview").textContent =
              `Valid: ${v.sampleCount} sample(s)`;
            $("insertPreview").classList.remove("hidden");
            $("applyInsert").disabled = false;
          } catch (e) {
            $("insertError").textContent = "Invalid JSON: " + e.message;
            $("insertError").classList.remove("hidden");
          }
        }

        function generateInsertTemplate() {
          const nF = modelState.nFeatures || 3;
          const nT = modelState.nTargets || 2;
          const x = Array(nF).fill(0);
          const y = Array(nT).fill(0);
          $("insertJson").value = JSON.stringify(
            { xCoordinates: [x], yCoordinates: [y] },
            null,
            2,
          );
          validateInsertJson();
        }

        async function applyInsertData() {
          if (!pendingInsertData) return;
          closeModal("insertModal");
          await trainOnData(pendingInsertData);
          pendingInsertData = null;
        }

        async function runRandomTest() {
          closeModal("testModal");
          const seed = parseInt($("testSeed").value) || 42;
          const samples = parseInt($("testSamples").value) || 200;
          const nF = parseInt($("testFeatures").value) || 3;
          const nT = parseInt($("testTargets").value) || 2;
          const noise = parseFloat($("testNoise").value) || 0.1;
          const outlier = parseFloat($("testOutlier").value) || 0.02;
          setLoading(true, "Generating test...");
          try {
            const cfg = { ...PRESETS.starthere, seed };
            currentConfig = cfg;
            await send("create", cfg);
            modelState = {
              hasModel: true,
              nFeatures: nF,
              nTargets: nT,
              sampleCount: 0,
            };
            const data = generateTestData(
              seed,
              nF,
              nT,
              samples,
              noise,
              outlier,
            );
            await sendWithProgress("fit", data, (p) => {
              setProgress(p.percent);
              $("loadingText").textContent =
                `Training... ${p.percent}%`;
            });
            modelState.sampleCount = samples;
            const pred = await send("predict", { futureSteps: 20 });
            predictions = pred.result;
            updateModelStatus();
            updateDimSelector();
            $("vizMode").value = "focus";
            $("emptyState").classList.add("hidden");
            $("statsBar").classList.remove("hidden");
            renderChart();
            addLog(
              `Test complete: ${samples} samples, ${nF}F/${nT}T`,
              "success",
            );
            showToast("Test complete!", "success");
          } catch (e) {
            addLog("Test failed: " + e.message, "error");
            showToast("Test failed", "error");
          } finally {
            setLoading(false);
            setProgress(0);
          }
        }

        async function saveToFile() {
          try {
            const res = await send("save");
            const wrapper = {
              modelState: res.state,
              meta: {
                config: currentConfig,
                nFeatures: modelState.nFeatures,
                nTargets: modelState.nTargets,
                createdAt: new Date().toISOString(),
                appVersion: "1.0.0",
              },
            };
            const blob = new Blob([JSON.stringify(wrapper)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "esn_model.json";
            a.click();
            URL.revokeObjectURL(url);
            addLog("Model saved to file", "success");
            showToast("Model saved", "success");
          } catch (e) {
            addLog("Save failed: " + e.message, "error");
            showToast("Save failed", "error");
          }
        }

        async function saveToLocal() {
          try {
            const res = await send("save");
            const wrapper = {
              modelState: res.state,
              meta: {
                config: currentConfig,
                nFeatures: modelState.nFeatures,
                nTargets: modelState.nTargets,
                createdAt: new Date().toISOString(),
                appVersion: "1.0.0",
              },
            };
            localStorage.setItem("savedModel", JSON.stringify(wrapper));
            addLog("Model saved to browser", "success");
            showToast("Model saved to browser", "success");
            checkLocalStorage();
          } catch (e) {
            addLog("Save failed: " + e.message, "error");
            showToast("Save failed", "error");
          }
        }

        async function loadFromFile(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (ev) => {
            try {
              await loadModelFromString(ev.target.result);
              closeModal("saveLoadModal");
            } catch (e) {
              addLog("Load failed: " + e.message, "error");
              showToast("Load failed: " + e.message, "error");
            }
          };
          reader.readAsText(file);
        }

        async function loadFromLocal() {
          const str = localStorage.getItem("savedModel");
          if (!str) {
            showToast("No saved model in browser", "warning");
            return;
          }
          try {
            await loadModelFromString(str);
            closeModal("saveLoadModal");
          } catch (e) {
            addLog("Load failed: " + e.message, "error");
            showToast("Load failed: " + e.message, "error");
          }
        }

        async function loadModelFromString(str) {
          setLoading(true, "Loading model...");
          try {
            let parsed = JSON.parse(str);
            let state = parsed.modelState || parsed;
            if (typeof state === "object" && !parsed.modelState) {
              state = str;
            }
            await send("load", {
              state: typeof state === "string"
                ? state
                : JSON.stringify(state),
            });
            const summary = await send("getSummary");
            currentConfig = parsed.meta?.config || PRESETS.starthere;
            modelState = {
              hasModel: true,
              nFeatures: summary.summary.nFeatures,
              nTargets: summary.summary.nTargets,
              sampleCount: summary.summary.sampleCount,
            };
            updateModelStatus();
            updateDimSelector();
            hideEmptyState();
            addLog("Model loaded", "success");
            showToast("Model loaded", "success");
          } finally {
            setLoading(false);
          }
        }

        function checkLocalStorage() {
          const saved = localStorage.getItem("savedModel");
          if (saved) {
            try {
              const p = JSON.parse(saved);
              const meta = p.meta || {};
              $("localStorageInfo").textContent = `Saved: ${
                meta.createdAt?.split("T")[0] || "unknown"
              }, ${meta.nFeatures || "?"}F/${meta.nTargets || "?"}T`;
              $("loadFromLocal").disabled = false;
            } catch {
              $("localStorageInfo").textContent = "Invalid saved data";
              $("loadFromLocal").disabled = true;
            }
          } else {
            $("localStorageInfo").textContent = "No saved model";
            $("loadFromLocal").disabled = true;
          }
        }

        function clearLocalStorage() {
          if (confirm("Clear all browser storage for this app?")) {
            localStorage.clear();
            checkLocalStorage();
            showToast("Storage cleared", "success");
          }
        }

        function exportPng() {
          const canvas = $("mainCanvas");
          const link = document.createElement("a");
          link.download = "esn_chart.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
          showToast("Chart exported", "success");
        }

        // Init
        async function init() {
          initDarkMode();
          bindEvents();
          await initWorker();
          const lastCfg = localStorage.getItem("lastConfig");
          if (lastCfg) {
            try {
              currentConfig = JSON.parse(lastCfg);
            } catch {}
          }
        }

        init();
      })();
    </script>
  </body>
</html>
