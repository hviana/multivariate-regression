<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              chart: {
                blue: "#3B82F6",
                emerald: "#10B981",
                amber: "#F59E0B",
                red: "#EF4444",
                violet: "#8B5CF6",
                pink: "#EC4899",
                cyan: "#06B6D4",
                lime: "#84CC16",
              },
            },
          },
        },
      };
    </script>
    <style>
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
      }
      .animate-slide-out {
        animation: slideOut 0.3s ease-out forwards;
      }
      .animate-fade-in {
        animation: fadeIn 0.2s ease-out forwards;
      }
      .animate-fade-out {
        animation: fadeOut 0.2s ease-out forwards;
      }
      .animate-pulse-slow {
        animation: pulse 2s ease-in-out infinite;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.3);
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 116, 139, 0.5);
      }
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 116, 139, 0.3) transparent;
      }
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 3px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        margin-top: -6px;
        cursor: pointer;
      }
      .dark input[type="range"]::-webkit-slider-runnable-track {
        background: #334155;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        background: #e2e8f0;
      }
      .dark input[type="range"]::-webkit-slider-thumb {
        background: #3b82f6;
      }
      input[type="range"]::-webkit-slider-thumb {
        background: #3b82f6;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200"
  >
    <div id="app" class="flex flex-col h-screen overflow-hidden">
      <header
        class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 shadow-sm z-30"
      >
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <button
              id="menuBtn"
              class="lg:hidden p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              aria-label="Open menu"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <h1
                class="text-lg font-bold bg-gradient-to-r from-blue-600 to-violet-600 bg-clip-text text-transparent hidden sm:block"
              >
                ESN Regression Studio
              </h1>
            </div>
          </div>
          <div
            id="statusChips"
            class="hidden sm:flex items-center gap-2 flex-wrap"
          >
            <span
              id="modelChip"
              class="px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400"
            >No Model</span>
            <span
              id="samplesChip"
              class="px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hidden"
            >0 Samples</span>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="quickPredict"
              class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
              aria-label="Quick predict"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 7l5 5m0 0l-5 5m5-5H6"
                />
              </svg>
              <span>Predict</span>
            </button>
            <button
              id="themeToggle"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              aria-label="Toggle theme"
            >
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <svg
                class="w-5 h-5 block dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>
      <div class="flex flex-1 overflow-hidden">
        <aside
          id="sidebar"
          class="fixed inset-y-0 left-0 z-40 w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 transform -translate-x-full lg:translate-x-0 lg:static lg:z-auto transition-transform duration-300 flex flex-col shadow-xl lg:shadow-none"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 lg:hidden"
          >
            <span class="font-semibold">Menu</span>
            <button
              id="closeSidebar"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close menu"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto p-3 scrollbar-thin">
            <div class="space-y-1">
              <div
                class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
              >
                Model
              </div>
              <button
                data-action="config"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <span>Create / Configure</span>
              </button>
              <button
                data-action="summary"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <span>Model Summary</span>
              </button>
              <button
                data-action="saveload"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                <span>Save / Load</span>
              </button>
              <button
                data-action="reset"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-red-600 dark:text-red-400"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                <span>Reset Model</span>
              </button>
            </div>
            <div class="space-y-1 mt-4">
              <div
                class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
              >
                Data
              </div>
              <button
                data-action="upload"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                  />
                </svg>
                <span>Upload Dataset</span>
              </button>
              <button
                data-action="insert"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  />
                </svg>
                <span>Manual Insert</span>
              </button>
              <button
                data-action="randomtest"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                  />
                </svg>
                <span>Random Test</span>
              </button>
            </div>
            <div class="space-y-1 mt-4">
              <div
                class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
              >
                Train & Predict
              </div>
              <button
                data-action="train"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
                <span>Train Model</span>
              </button>
              <button
                data-action="predict"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                <span>Predict Future</span>
              </button>
            </div>
            <div class="space-y-1 mt-4">
              <div
                class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
              >
                Visualize
              </div>
              <button
                data-action="viewmode"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
                  />
                </svg>
                <span>View Modes</span>
              </button>
              <button
                data-action="export"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <span>Export Chart</span>
              </button>
            </div>
            <div class="space-y-1 mt-4">
              <div
                class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
              >
                Advanced
              </div>
              <button
                data-action="advanced"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                  />
                </svg>
                <span>Advanced Settings</span>
              </button>
              <button
                data-action="logs"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <span>Event Logs</span>
              </button>
            </div>
          </nav>
          <div class="p-3 border-t border-slate-200 dark:border-slate-700">
            <div class="text-xs text-slate-500 dark:text-slate-400 text-center">
              <kbd
                class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px]"
              >M</kbd> Menu
              <kbd
                class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px] ml-2"
              >C</kbd> Config
              <kbd
                class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px] ml-2"
              >P</kbd> Predict
            </div>
          </div>
        </aside>
        <div
          id="sidebarOverlay"
          class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden"
          aria-hidden="true"
        >
        </div>
        <main class="flex-1 overflow-hidden flex flex-col">
          <div id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-6">
            <div id="onboarding" class="max-w-2xl mx-auto">
              <div
                class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-8 md:p-12 text-center"
              >
                <div
                  class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-lg"
                >
                  <svg
                    class="w-10 h-10 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                  </svg>
                </div>
                <h2
                  class="text-2xl md:text-3xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-violet-600 bg-clip-text text-transparent"
                >
                  Welcome to ESN Regression Studio
                </h2>
                <p
                  class="text-slate-600 dark:text-slate-400 mb-8 max-w-md mx-auto"
                >
                  Build powerful multivariate regression models with Echo State
                  Networks. Real-time learning, multi-horizon forecasting, and
                  beautiful visualizations.
                </p>
                <div class="grid gap-4 sm:grid-cols-3">
                  <button
                    data-onboard="start"
                    class="group p-6 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                  >
                    <svg
                      class="w-8 h-8 mx-auto mb-3 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>
                    <div class="font-semibold">Start Here</div>
                    <div class="text-sm text-blue-100 mt-1">
                      Create model with recommended settings
                    </div>
                  </button>
                  <button
                    data-onboard="load"
                    class="group p-6 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:border-blue-400 dark:hover:border-blue-500 shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                  >
                    <svg
                      class="w-8 h-8 mx-auto mb-3 text-slate-600 dark:text-slate-300 group-hover:text-blue-500 transition-colors"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                      />
                    </svg>
                    <div
                      class="font-semibold text-slate-800 dark:text-slate-200"
                    >
                      Load Model
                    </div>
                    <div
                      class="text-sm text-slate-500 dark:text-slate-400 mt-1"
                    >
                      Resume from saved state
                    </div>
                  </button>
                  <button
                    data-onboard="test"
                    class="group p-6 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                  >
                    <svg
                      class="w-8 h-8 mx-auto mb-3 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                      />
                    </svg>
                    <div class="font-semibold">Run Demo</div>
                    <div class="text-sm text-emerald-100 mt-1">
                      See it in action instantly
                    </div>
                  </button>
                </div>
              </div>
            </div>
            <div id="dashboard" class="hidden">
              <div class="grid gap-4 lg:grid-cols-4 mb-6">
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm"
                >
                  <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">
                    Samples Trained
                  </div>
                  <div id="statSamples" class="text-2xl font-bold">0</div>
                </div>
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm"
                >
                  <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">
                    Average Loss
                  </div>
                  <div id="statLoss" class="text-2xl font-bold">—</div>
                </div>
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm"
                >
                  <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">
                    Confidence
                  </div>
                  <div
                    id="statConfidence"
                    class="text-2xl font-bold text-emerald-500"
                  >
                    —
                  </div>
                </div>
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm"
                >
                  <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">
                    Dimensions
                  </div>
                  <div id="statDims" class="text-2xl font-bold">—</div>
                </div>
              </div>
              <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden"
              >
                <div
                  class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center gap-3">
                    <h3 class="font-semibold">Predictions</h3>
                    <select
                      id="viewModeSelect"
                      class="text-sm bg-slate-100 dark:bg-slate-700 border-0 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="focus">Focus View</option>
                      <option value="grid">Small Multiples</option>
                      <option value="heatmap">Heatmap</option>
                      <option value="uncertainty">Uncertainty</option>
                      <option value="bar">Bar Chart</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      id="dimSelect"
                      class="text-sm bg-slate-100 dark:bg-slate-700 border-0 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="0">Dimension 0</option>
                    </select>
                    <button
                      id="zoomIn"
                      class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                      aria-label="Zoom in"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"
                        />
                      </svg>
                    </button>
                    <button
                      id="zoomOut"
                      class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                      aria-label="Zoom out"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"
                        />
                      </svg>
                    </button>
                    <button
                      id="zoomReset"
                      class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                      aria-label="Reset zoom"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                        />
                      </svg>
                    </button>
                    <button
                      id="exportChart"
                      class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                      aria-label="Export chart"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
                <div id="chartContainer" class="relative" style="height: 400px">
                  <canvas id="mainChart" class="w-full h-full"></canvas>
                  <div
                    id="chartEmpty"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-800/50"
                  >
                    <svg
                      class="w-16 h-16 text-slate-300 dark:text-slate-600 mb-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>
                    <p class="text-slate-500 dark:text-slate-400 font-medium">
                      Run a prediction to see results
                    </p>
                    <button
                      id="emptyPredict"
                      class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors"
                    >
                      Run Prediction
                    </button>
                  </div>
                  <div
                    id="chartLoading"
                    class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 hidden"
                  >
                    <div class="flex flex-col items-center gap-3">
                      <div
                        class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"
                      >
                      </div>
                      <span class="text-sm text-slate-600 dark:text-slate-400"
                      >Processing...</span>
                    </div>
                  </div>
                  <div
                    id="chartTooltip"
                    class="absolute hidden pointer-events-none z-20 bg-white dark:bg-slate-700 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 p-3 text-sm"
                    style="min-width: 160px"
                  >
                  </div>
                </div>
                <div
                  id="chartStats"
                  class="hidden p-4 border-t border-slate-200 dark:border-slate-700 grid grid-cols-2 md:grid-cols-6 gap-4 text-sm"
                >
                  <div>
                    <span class="text-slate-500 dark:text-slate-400">Min:</span>
                    <span id="statMin" class="font-medium">—</span>
                  </div>
                  <div>
                    <span class="text-slate-500 dark:text-slate-400">Max:</span>
                    <span id="statMax" class="font-medium">—</span>
                  </div>
                  <div>
                    <span class="text-slate-500 dark:text-slate-400"
                    >Mean:</span> <span id="statMean" class="font-medium"
                    >—</span>
                  </div>
                  <div>
                    <span class="text-slate-500 dark:text-slate-400"
                    >Final:</span> <span id="statFinal" class="font-medium"
                    >—</span>
                  </div>
                  <div>
                    <span class="text-slate-500 dark:text-slate-400"
                    >Trend:</span> <span id="statTrend" class="font-medium"
                    >—</span>
                  </div>
                  <div>
                    <span class="text-slate-500 dark:text-slate-400"
                    >Avg Band:</span> <span id="statBand" class="font-medium"
                    >—</span>
                  </div>
                </div>
              </div>
              <div
                id="gridContainer"
                class="hidden grid gap-3 grid-cols-2 md:grid-cols-3 lg:grid-cols-4"
              >
              </div>
            </div>
          </div>
          <div
            id="progressBar"
            class="hidden flex-shrink-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-4"
          >
            <div class="flex items-center gap-4">
              <div class="flex-1">
                <div class="flex items-center justify-between text-sm mb-1">
                  <span id="progressLabel">Training...</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div
                  class="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"
                >
                  <div
                    id="progressFill"
                    class="h-full bg-blue-500 rounded-full transition-all duration-300"
                    style="width: 0%"
                  >
                  </div>
                </div>
              </div>
              <button
                id="cancelBtn"
                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>
    <div
      id="toastContainer"
      class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"
    >
    </div>
    <div
      id="modalOverlay"
      class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="modalContent"
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-fade-in"
      >
      </div>
    </div>
    <script>
      const APP_VERSION = "1.0.0";
      const MODULE_URL_DEFAULT =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression";
      const CHART_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
      ];
      const PRESETS = {
        start: {
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          rlsLambda: 0.999,
          l2Lambda: 0.0001,
        },
        fast: {
          reservoirSize: 64,
          maxSequenceLength: 32,
          spectralRadius: 0.8,
          leakRate: 0.5,
          inputScale: 1.0,
          rlsLambda: 0.99,
          l2Lambda: 0.001,
        },
        balanced: {
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          rlsLambda: 0.999,
          l2Lambda: 0.0001,
        },
        accurate: {
          reservoirSize: 512,
          maxSequenceLength: 128,
          spectralRadius: 0.95,
          leakRate: 0.2,
          inputScale: 1.0,
          rlsLambda: 0.9995,
          l2Lambda: 0.00001,
        },
        adaptive: {
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.85,
          leakRate: 0.5,
          inputScale: 1.0,
          rlsLambda: 0.97,
          l2Lambda: 0.001,
        },
        robust: {
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.9,
          leakRate: 0.2,
          inputScale: 1.0,
          rlsLambda: 0.999,
          l2Lambda: 0.01,
          outlierThreshold: 2.0,
        },
      };
      const state = {
        worker: null,
        moduleUrl: MODULE_URL_DEFAULT,
        requestId: 0,
        pendingRequests: new Map(),
        cancelTokens: new Set(),
        modelReady: false,
        config: { ...PRESETS.start },
        nFeatures: 0,
        nTargets: 0,
        sampleCount: 0,
        predictions: null,
        logs: [],
        darkMode: false,
        viewMode: "focus",
        selectedDim: 0,
        zoom: { scale: 1, offsetX: 0, offsetY: 0 },
        chartAnimation: { progress: 0, running: false },
        hoverX: -1,
        performanceMode: false,
      };
      function log(type, action, details = "") {
        const entry = {
          timestamp: new Date().toISOString(),
          type,
          action,
          details,
        };
        state.logs.unshift(entry);
        if (state.logs.length > 500) state.logs.pop();
      }
      function toast(type, message, duration = 4000) {
        const container = document.getElementById("toastContainer");
        const el = document.createElement("div");
        el.className =
          `flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg animate-slide-in ${
            type === "success"
              ? "bg-emerald-500 text-white"
              : type === "error"
              ? "bg-red-500 text-white"
              : type === "warning"
              ? "bg-amber-500 text-white"
              : "bg-slate-700 text-white"
          }`;
        const icons = {
          success:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
          error:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
          warning:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
          info:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
        };
        el.innerHTML =
          `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${
            icons[type] || icons.info
          }</svg><span>${message}</span>`;
        container.appendChild(el);
        setTimeout(() => {
          el.classList.replace("animate-slide-in", "animate-slide-out");
          setTimeout(() => el.remove(), 300);
        }, duration);
      }
      const workerCode = `
let ESNRegression = null;
let model = null;
let dataset = { x: [], y: [] };
let moduleUrl = '${MODULE_URL_DEFAULT}';

async function loadModule(url) {
  try {
    const mod = await import(url);
    ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module');
    return true;
  } catch (e1) {
    try {
      const res = await fetch(url);
      let text = await res.text();
      const match = text.match(/export\\s*{[^}]*ESNRegression[^}]*}/);
      if (match) {
        text = text.replace(/export\\s*{[^}]*}/, '').replace(/export\\s+default\\s+/, '');
      }
      text = text.replace(/export\\s+(class|function|const|let|var)/g, '$1');
      const blob = new Blob([text + '\\nself.ESNRegression = ESNRegression;'], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      importScripts(blobUrl);
      URL.revokeObjectURL(blobUrl);
      if (self.ESNRegression) { ESNRegression = self.ESNRegression; return true; }
      throw new Error('Fallback module load failed');
    } catch (e2) {
      throw new Error('Module load failed: ' + e1.message + ' | Fallback: ' + e2.message);
    }
  }
}

self.onmessage = async (e) => {
  const { requestId, type, payload } = e.data;
  const reply = (data) => self.postMessage({ requestId, ...data });
  const progress = (p) => self.postMessage({ requestId, type: 'progress', ...p });
  
  try {
    if (type === 'init') {
      moduleUrl = payload?.moduleUrl || moduleUrl;
      await loadModule(moduleUrl);
      reply({ type: 'ready', moduleLoaded: true });
    }
    else if (type === 'create') {
      if (!ESNRegression) throw new Error('Module not loaded');
      model = new ESNRegression(payload.config);
      dataset = { x: [], y: [] };
      reply({ type: 'created', config: payload.config });
    }
    else if (type === 'train') {
      if (!model) throw new Error('Model not created');
      const { xCoordinates, yCoordinates, batch } = payload;
      if (batch) {
        const total = xCoordinates.length;
        let result = null;
        for (let i = 0; i < total; i++) {
          result = model.fitOnline({ xCoordinates: [xCoordinates[i]], yCoordinates: [yCoordinates[i]] });
          dataset.x.push(xCoordinates[i]);
          dataset.y.push(yCoordinates[i]);
          if (i % 10 === 0 || i === total - 1) {
            progress({ processed: i + 1, total, percent: Math.round((i + 1) / total * 100), stage: 'training' });
          }
        }
        const summary = model.getModelSummary();
        reply({ type: 'trained', result, summary, sampleCount: dataset.x.length });
      } else {
        const result = model.fitOnline({ xCoordinates, yCoordinates });
        xCoordinates.forEach((x, i) => { dataset.x.push(x); dataset.y.push(yCoordinates[i]); });
        const summary = model.getModelSummary();
        reply({ type: 'trained', result, summary, sampleCount: dataset.x.length });
      }
    }
    else if (type === 'predict') {
      if (!model) throw new Error('Model not created');
      const result = model.predict(payload.futureSteps);
      reply({ type: 'predicted', result });
    }
    else if (type === 'summary') {
      if (!model) throw new Error('Model not created');
      const summary = model.getModelSummary();
      reply({ type: 'summary', summary, sampleCount: dataset.x.length });
    }
    else if (type === 'reset') {
      if (model) model.reset();
      dataset = { x: [], y: [] };
      reply({ type: 'reset' });
    }
    else if (type === 'save') {
      if (!model) throw new Error('Model not created');
      const modelState = model.save();
      const summary = model.getModelSummary();
      reply({ type: 'saved', modelState, summary, sampleCount: dataset.x.length });
    }
    else if (type === 'load') {
      if (!ESNRegression) throw new Error('Module not loaded');
      let { modelState, config } = payload;
      if (typeof modelState === 'object' && modelState.modelState) {
        config = modelState.meta?.config;
        modelState = modelState.modelState;
      }
      model = new ESNRegression(config || {});
      model.load(modelState);
      dataset = { x: [], y: [] };
      const summary = model.getModelSummary();
      reply({ type: 'loaded', summary });
    }
    else {
      throw new Error('Unknown message type: ' + type);
    }
  } catch (err) {
    reply({ type: 'error', error: err.message || String(err) });
  }
};
`;
      function createWorker() {
        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        const url = URL.createObjectURL(blob);
        state.worker = new Worker(url);
        state.worker.onmessage = handleWorkerMessage;
        state.worker.onerror = (e) => {
          toast("error", "Worker error: " + e.message);
          log("error", "Worker Error", e.message);
        };
        sendToWorker("init", { moduleUrl: state.moduleUrl });
      }
      function sendToWorker(type, payload = {}) {
        return new Promise((resolve, reject) => {
          const requestId = ++state.requestId;
          state.pendingRequests.set(requestId, {
            resolve,
            reject,
            type,
          });
          state.worker.postMessage({ requestId, type, payload });
        });
      }
      function handleWorkerMessage(e) {
        const { requestId, type, ...data } = e.data;
        if (type === "progress") {
          updateProgress(data);
          return;
        }
        const pending = state.pendingRequests.get(requestId);
        if (!pending) return;
        state.pendingRequests.delete(requestId);
        if (type === "error") {
          pending.reject(new Error(data.error));
          toast("error", data.error);
          log("error", pending.type, data.error);
        } else {
          pending.resolve(data);
        }
      }
      function updateProgress(data) {
        const bar = document.getElementById("progressBar");
        const fill = document.getElementById("progressFill");
        const label = document.getElementById("progressLabel");
        const percent = document.getElementById("progressPercent");
        bar.classList.remove("hidden");
        fill.style.width = data.percent + "%";
        label.textContent =
          `${data.stage}: ${data.processed}/${data.total}`;
        percent.textContent = data.percent + "%";
      }
      function hideProgress() {
        document.getElementById("progressBar").classList.add("hidden");
      }
      function setLoading(show) {
        document.getElementById("chartLoading").classList.toggle(
          "hidden",
          !show,
        );
        document.querySelectorAll("button[data-action], #quickPredict")
          .forEach((b) => b.disabled = show);
      }
      function updateUI() {
        const chip = document.getElementById("modelChip");
        const samplesChip = document.getElementById("samplesChip");
        const quickPredict = document.getElementById("quickPredict");
        if (state.modelReady) {
          chip.textContent = `${state.nFeatures}→${state.nTargets}`;
          chip.className =
            "px-2.5 py-1 text-xs font-medium rounded-full bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-400";
          samplesChip.textContent = `${state.sampleCount} Samples`;
          samplesChip.classList.remove("hidden");
          quickPredict.disabled = state.sampleCount === 0;
          document.getElementById("onboarding").classList.add("hidden");
          document.getElementById("dashboard").classList.remove(
            "hidden",
          );
        } else {
          chip.textContent = "No Model";
          chip.className =
            "px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400";
          samplesChip.classList.add("hidden");
          quickPredict.disabled = true;
        }
        document.getElementById("statSamples").textContent =
          state.sampleCount;
        document.getElementById("statDims").textContent =
          state.nTargets > 0
            ? `${state.nFeatures}×${state.nTargets}`
            : "—";
      }
      async function createModel(config) {
        setLoading(true);
        try {
          await sendToWorker("create", { config });
          state.modelReady = true;
          state.config = config;
          state.sampleCount = 0;
          state.predictions = null;
          const summary = await sendToWorker("summary");
          state.nFeatures = summary.summary.nFeatures;
          state.nTargets = summary.summary.nTargets;
          updateUI();
          updateDimSelector();
          toast("success", "Model created successfully");
          log("success", "Create Model", JSON.stringify(config));
        } catch (e) {
          toast("error", e.message);
        } finally {
          setLoading(false);
        }
      }
      async function trainModel(
        xCoordinates,
        yCoordinates,
        batch = false,
      ) {
        setLoading(true);
        try {
          const result = await sendToWorker("train", {
            xCoordinates,
            yCoordinates,
            batch,
          });
          state.sampleCount = result.sampleCount;
          state.nFeatures = result.summary.nFeatures;
          state.nTargets = result.summary.nTargets;
          document.getElementById("statLoss").textContent = result
            .result.averageLoss.toFixed(6);
          updateUI();
          updateDimSelector();
          hideProgress();
          toast("success", `Trained on ${xCoordinates.length} samples`);
          log(
            "success",
            "Train",
            `${xCoordinates.length} samples, loss: ${
              result.result.averageLoss.toFixed(6)
            }`,
          );
        } catch (e) {
          toast("error", e.message);
        } finally {
          setLoading(false);
          hideProgress();
        }
      }
      async function predict(futureSteps) {
        if (!state.modelReady || state.sampleCount === 0) {
          toast("warning", "Train the model first");
          return;
        }
        setLoading(true);
        try {
          const result = await sendToWorker("predict", { futureSteps });
          state.predictions = result.result;
          document.getElementById("statConfidence").textContent =
            (result.result.confidence * 100).toFixed(1) + "%";
          document.getElementById("chartEmpty").classList.add("hidden");
          document.getElementById("chartStats").classList.remove(
            "hidden",
          );
          updateChartStats();
          renderChart();
          toast("success", `Predicted ${futureSteps} steps`);
          log(
            "success",
            "Predict",
            `${futureSteps} steps, confidence: ${
              (result.result.confidence * 100).toFixed(1)
            }%`,
          );
        } catch (e) {
          toast("error", e.message);
        } finally {
          setLoading(false);
        }
      }
      function updateDimSelector() {
        const select = document.getElementById("dimSelect");
        select.innerHTML = "";
        for (let i = 0; i < state.nTargets; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `Dimension ${i}`;
          select.appendChild(opt);
        }
        state.selectedDim = 0;
      }
      function updateChartStats() {
        if (!state.predictions) return;
        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const lower = state.predictions.lowerBounds.map((l) => l[dim]);
        const upper = state.predictions.upperBounds.map((u) => u[dim]);
        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const trend = preds[preds.length - 1] > preds[0]
          ? "↑"
          : preds[preds.length - 1] < preds[0]
          ? "↓"
          : "→";
        const avgBand =
          upper.reduce((a, b, i) => a + (b - lower[i]), 0) /
          upper.length;
        document.getElementById("statMin").textContent = min
          .toPrecision(4);
        document.getElementById("statMax").textContent = max
          .toPrecision(4);
        document.getElementById("statMean").textContent = mean
          .toPrecision(4);
        document.getElementById("statFinal").textContent = final
          .toPrecision(4);
        document.getElementById("statTrend").textContent = trend;
        document.getElementById("statBand").textContent = avgBand
          .toPrecision(3);
      }
      function niceNum(range, round) {
        const exp = Math.floor(Math.log10(range));
        const frac = range / Math.pow(10, exp);
        let nice;
        if (round) {
          nice = frac < 1.5 ? 1 : frac < 3 ? 2 : frac < 7 ? 5 : 10;
        } else {
          nice = frac <= 1 ? 1 : frac <= 2 ? 2 : frac <= 5 ? 5 : 10;
        }
        return nice * Math.pow(10, exp);
      }
      function getNiceTicks(min, max, count = 6) {
        const range = niceNum(max - min, false);
        const step = niceNum(range / (count - 1), true);
        const niceMin = Math.floor(min / step) * step;
        const niceMax = Math.ceil(max / step) * step;
        const ticks = [];
        for (let v = niceMin; v <= niceMax + step * 0.5; v += step) {
          ticks.push(v);
        }
        return ticks;
      }
      function renderChart() {
        if (state.viewMode === "grid") {
          renderGridView();
          return;
        }
        if (state.viewMode === "heatmap") {
          renderHeatmap();
          return;
        }
        if (state.viewMode === "uncertainty") {
          renderUncertainty();
          return;
        }
        if (state.viewMode === "bar") {
          renderBarChart();
          return;
        }
        const canvas = document.getElementById("mainChart");
        const container = document.getElementById("chartContainer");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
        ctx.scale(dpr, dpr);
        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        const bg = isDark ? "#1E293B" : "#FFFFFF";
        const gridColor = isDark
          ? "rgba(255,255,255,0.06)"
          : "rgba(0,0,0,0.06)";
        const axisColor = isDark
          ? "rgba(255,255,255,0.15)"
          : "rgba(0,0,0,0.15)";
        const textColor = isDark ? "#94A3B8" : "#64748B";
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, rect.width, rect.height);
        if (!state.predictions) return;
        const margin = { top: 20, right: 20, bottom: 40, left: 60 };
        const w = rect.width - margin.left - margin.right;
        const h = rect.height - margin.top - margin.bottom;
        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const lower = state.predictions.lowerBounds.map((l) => l[dim]);
        const upper = state.predictions.upperBounds.map((u) => u[dim]);
        const n = preds.length;
        let yMin = Math.min(...lower);
        let yMax = Math.max(...upper);
        const yPad = (yMax - yMin) * 0.1 || 1;
        yMin -= yPad;
        yMax += yPad;
        const yTicks = getNiceTicks(yMin, yMax, 6);
        yMin = yTicks[0];
        yMax = yTicks[yTicks.length - 1];
        const xScale = (i) =>
          margin.left + (i / (n - 1 || 1)) * w * state.zoom.scale +
          state.zoom.offsetX;
        const yScale = (v) =>
          margin.top + h -
          ((v - yMin) / (yMax - yMin)) * h * state.zoom.scale +
          state.zoom.offsetY;
        ctx.save();
        ctx.translate(0.5, 0.5);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        for (const tick of yTicks) {
          const y = yScale(tick);
          if (y >= margin.top && y <= margin.top + h) {
            ctx.beginPath();
            ctx.moveTo(margin.left, y);
            ctx.lineTo(margin.left + w, y);
            ctx.stroke();
          }
        }
        ctx.setLineDash([]);
        ctx.strokeStyle = axisColor;
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, margin.top + h);
        ctx.lineTo(margin.left + w, margin.top + h);
        ctx.stroke();
        ctx.fillStyle = textColor;
        ctx.font = "11px system-ui, -apple-system, sans-serif";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (const tick of yTicks) {
          const y = yScale(tick);
          if (y >= margin.top - 5 && y <= margin.top + h + 5) {
            ctx.fillText(tick.toPrecision(3), margin.left - 8, y);
          }
        }
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        const xStep = Math.max(1, Math.floor(n / (w / 60)));
        for (let i = 0; i < n; i += xStep) {
          const x = xScale(i);
          if (x >= margin.left && x <= margin.left + w) {
            ctx.fillText(i.toString(), x, margin.top + h + 8);
          }
        }
        const color = CHART_COLORS[dim % CHART_COLORS.length];
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y1 = yScale(upper[i]);
          const y2 = yScale(lower[i]);
          if (i === 0) ctx.moveTo(x, y1);
          else ctx.lineTo(x, y1);
        }
        for (let i = n - 1; i >= 0; i--) {
          const x = xScale(i);
          const y2 = yScale(lower[i]);
          ctx.lineTo(x, y2);
        }
        ctx.closePath();
        const bandAlpha = isDark ? 0.15 : 0.12;
        ctx.fillStyle = color.replace(")", `,${bandAlpha})`).replace(
          "rgb",
          "rgba",
        );
        ctx.fill();
        ctx.setLineDash([3, 3]);
        ctx.strokeStyle = color.replace(")", ",0.4)").replace(
          "rgb",
          "rgba",
        );
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y = yScale(upper[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y = yScale(lower[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.strokeStyle = color.replace(")", ",0.15)").replace(
          "rgb",
          "rgba",
        );
        ctx.lineWidth = 6;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y = yScale(preds[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y = yScale(preds[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        if (state.hoverX >= 0 && state.hoverX < n) {
          const i = state.hoverX;
          const x = xScale(i);
          const y = yScale(preds[i]);
          ctx.setLineDash([4, 4]);
          ctx.strokeStyle = isDark
            ? "rgba(255,255,255,0.3)"
            : "rgba(0,0,0,0.2)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, margin.top);
          ctx.lineTo(x, margin.top + h);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle = color.replace(")", ",0.3)").replace(
            "rgb",
            "rgba",
          );
          ctx.beginPath();
          ctx.arc(x, y, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();
          const tooltip = document.getElementById("chartTooltip");
          tooltip.innerHTML = `
      <div class="font-semibold mb-1">Step ${i}</div>
      <div class="text-slate-600 dark:text-slate-300">Value: <span class="font-medium">${
            preds[i].toPrecision(4)
          }</span></div>
      <div class="text-slate-500 dark:text-slate-400 text-xs">Lower: ${
            lower[i].toPrecision(3)
          }</div>
      <div class="text-slate-500 dark:text-slate-400 text-xs">Upper: ${
            upper[i].toPrecision(3)
          }</div>
      <div class="text-slate-500 dark:text-slate-400 text-xs">Band: ±${
            ((upper[i] - lower[i]) / 2).toPrecision(3)
          }</div>
    `;
          tooltip.classList.remove("hidden");
          let tx = x + 15;
          let ty = y - 60;
          if (tx + 170 > rect.width) tx = x - 175;
          if (ty < 10) ty = y + 15;
          tooltip.style.left = tx + "px";
          tooltip.style.top = ty + "px";
        } else {
          document.getElementById("chartTooltip").classList.add(
            "hidden",
          );
        }
        ctx.restore();
      }
      function renderGridView() {
        if (!state.predictions) return;
        const container = document.getElementById("gridContainer");
        const mainChart =
          document.getElementById("chartContainer").parentElement;
        mainChart.querySelector("#chartContainer").classList.add(
          "hidden",
        );
        mainChart.querySelector("#chartStats").classList.add("hidden");
        container.classList.remove("hidden");
        container.innerHTML = "";
        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        for (let dim = 0; dim < state.nTargets; dim++) {
          const card = document.createElement("div");
          card.className =
            "bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-3 cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all";
          card.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-medium text-slate-600 dark:text-slate-400">Dim ${dim}</span>
        <span class="text-xs font-semibold" style="color: ${
            CHART_COLORS[dim % CHART_COLORS.length]
          }">${
            state.predictions
              .predictions[state.predictions.predictions.length - 1][
                dim
              ].toPrecision(3)
          }</span>
      </div>
      <canvas class="w-full" style="height: 80px;"></canvas>
    `;
          container.appendChild(card);
          card.onclick = () => {
            state.selectedDim = dim;
            state.viewMode = "focus";
            document.getElementById("viewModeSelect").value = "focus";
            document.getElementById("dimSelect").value = dim;
            container.classList.add("hidden");
            mainChart.querySelector("#chartContainer").classList.remove(
              "hidden",
            );
            mainChart.querySelector("#chartStats").classList.remove(
              "hidden",
            );
            updateChartStats();
            renderChart();
          };
          const canvas = card.querySelector("canvas");
          const ctx = canvas.getContext("2d");
          const dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect();
          canvas.width = rect.width * dpr;
          canvas.height = 80 * dpr;
          ctx.scale(dpr, dpr);
          const preds = state.predictions.predictions.map((p) =>
            p[dim]
          );
          const lower = state.predictions.lowerBounds.map((l) =>
            l[dim]
          );
          const upper = state.predictions.upperBounds.map((u) =>
            u[dim]
          );
          const n = preds.length;
          let yMin = Math.min(...lower);
          let yMax = Math.max(...upper);
          const yPad = (yMax - yMin) * 0.15 || 1;
          yMin -= yPad;
          yMax += yPad;
          const w = rect.width;
          const h = 80;
          const xScale = (i) => (i / (n - 1 || 1)) * w;
          const yScale = (v) => h - ((v - yMin) / (yMax - yMin)) * h;
          const color = CHART_COLORS[dim % CHART_COLORS.length];
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = xScale(i);
            if (i === 0) ctx.moveTo(x, yScale(upper[i]));
            else ctx.lineTo(x, yScale(upper[i]));
          }
          for (let i = n - 1; i >= 0; i--) {
            ctx.lineTo(xScale(i), yScale(lower[i]));
          }
          ctx.closePath();
          ctx.fillStyle = color.replace(")", ",0.15)").replace(
            "rgb",
            "rgba",
          );
          ctx.fill();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const x = xScale(i);
            const y = yScale(preds[i]);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        }
      }
      function renderHeatmap() {
        if (!state.predictions) return;
        const canvas = document.getElementById("mainChart");
        const container = document.getElementById("chartContainer");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        const bg = isDark ? "#1E293B" : "#FFFFFF";
        const textColor = isDark ? "#94A3B8" : "#64748B";
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, rect.width, rect.height);
        const margin = { top: 30, right: 60, bottom: 40, left: 60 };
        const w = rect.width - margin.left - margin.right;
        const h = rect.height - margin.top - margin.bottom;
        const nSteps = state.predictions.predictions.length;
        const nDims = state.nTargets;
        const cellW = w / nSteps;
        const cellH = h / nDims;
        let globalMin = Infinity, globalMax = -Infinity;
        for (const row of state.predictions.predictions) {
          for (const v of row) {
            globalMin = Math.min(globalMin, v);
            globalMax = Math.max(globalMax, v);
          }
        }
        const range = globalMax - globalMin || 1;
        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < nSteps; s++) {
            const v = state.predictions.predictions[s][d];
            const t = (v - globalMin) / range;
            let r, g, b;
            if (isDark) {
              r = Math.round(20 + t * 235);
              g = Math.round(40 + t * 180);
              b = Math.round(80 + (1 - t) * 175);
            } else {
              r = Math.round(255 - t * 175);
              g = Math.round(255 - t * 100);
              b = Math.round(255 - (1 - t) * 100);
            }
            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(
              margin.left + s * cellW,
              margin.top + d * cellH,
              cellW - 1,
              cellH - 1,
            );
          }
        }
        ctx.fillStyle = textColor;
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (let d = 0; d < nDims; d++) {
          ctx.fillText(
            `D${d}`,
            margin.left - 8,
            margin.top + d * cellH + cellH / 2,
          );
        }
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        const xStep = Math.max(1, Math.floor(nSteps / 10));
        for (let s = 0; s < nSteps; s += xStep) {
          ctx.fillText(
            s.toString(),
            margin.left + s * cellW + cellW / 2,
            margin.top + h + 8,
          );
        }
        const legendW = 20;
        const legendH = h;
        const legendX = margin.left + w + 20;
        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          margin.top + legendH,
        );
        if (isDark) {
          grad.addColorStop(0, "rgb(255,220,80)");
          grad.addColorStop(0.5, "rgb(100,150,200)");
          grad.addColorStop(1, "rgb(20,40,80)");
        } else {
          grad.addColorStop(0, "rgb(80,155,255)");
          grad.addColorStop(0.5, "rgb(180,200,220)");
          grad.addColorStop(1, "rgb(255,255,255)");
        }
        ctx.fillStyle = grad;
        ctx.fillRect(legendX, margin.top, legendW, legendH);
        ctx.fillStyle = textColor;
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText(
          globalMax.toPrecision(3),
          legendX + legendW + 5,
          margin.top,
        );
        ctx.textBaseline = "bottom";
        ctx.fillText(
          globalMin.toPrecision(3),
          legendX + legendW + 5,
          margin.top + legendH,
        );
      }
      function renderUncertainty() {
        if (!state.predictions) return;
        const canvas = document.getElementById("mainChart");
        const container = document.getElementById("chartContainer");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        const bg = isDark ? "#1E293B" : "#FFFFFF";
        const textColor = isDark ? "#94A3B8" : "#64748B";
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, rect.width, rect.height);
        const margin = { top: 20, right: 20, bottom: 40, left: 60 };
        const w = rect.width - margin.left - margin.right;
        const h = rect.height - margin.top - margin.bottom;
        const dim = state.selectedDim;
        const bands = state.predictions.predictions.map((p, i) =>
          state.predictions.upperBounds[i][dim] -
          state.predictions.lowerBounds[i][dim]
        );
        const n = bands.length;
        let yMax = Math.max(...bands);
        const yTicks = getNiceTicks(0, yMax, 5);
        yMax = yTicks[yTicks.length - 1];
        const xScale = (i) => margin.left + (i / (n - 1 || 1)) * w;
        const yScale = (v) => margin.top + h - (v / yMax) * h;
        ctx.save();
        ctx.translate(0.5, 0.5);
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.06)"
          : "rgba(0,0,0,0.06)";
        ctx.setLineDash([4, 4]);
        for (const tick of yTicks) {
          const y = yScale(tick);
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(margin.left + w, y);
          ctx.stroke();
        }
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top + h);
        for (let i = 0; i < n; i++) {
          ctx.lineTo(xScale(i), yScale(bands[i]));
        }
        ctx.lineTo(margin.left + w, margin.top + h);
        ctx.closePath();
        const avgBand = bands.reduce((a, b) => a + b, 0) / n;
        const maxBand = Math.max(...bands);
        const minBand = Math.min(...bands);
        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          margin.top + h,
        );
        grad.addColorStop(0, "rgba(239,68,68,0.6)");
        grad.addColorStop(0.5, "rgba(245,158,11,0.4)");
        grad.addColorStop(1, "rgba(16,185,129,0.2)");
        ctx.fillStyle = grad;
        ctx.fill();
        ctx.strokeStyle = "#F59E0B";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = xScale(i);
          const y = yScale(bands[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.fillStyle = textColor;
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (const tick of yTicks) {
          ctx.fillText(
            tick.toPrecision(2),
            margin.left - 8,
            yScale(tick),
          );
        }
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        const xStep = Math.max(1, Math.floor(n / 10));
        for (let i = 0; i < n; i += xStep) {
          ctx.fillText(i.toString(), xScale(i), margin.top + h + 8);
        }
        ctx.font = "bold 24px system-ui";
        ctx.textAlign = "right";
        ctx.textBaseline = "top";
        ctx.fillStyle = isDark ? "#F59E0B" : "#D97706";
        ctx.fillText(
          `Conf: ${(state.predictions.confidence * 100).toFixed(1)}%`,
          margin.left + w,
          margin.top + 10,
        );
        ctx.restore();
      }
      function renderBarChart() {
        if (!state.predictions) return;
        const canvas = document.getElementById("mainChart");
        const container = document.getElementById("chartContainer");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        const bg = isDark ? "#1E293B" : "#FFFFFF";
        const textColor = isDark ? "#94A3B8" : "#64748B";
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, rect.width, rect.height);
        const margin = { top: 20, right: 20, bottom: 40, left: 80 };
        const w = rect.width - margin.left - margin.right;
        const h = rect.height - margin.top - margin.bottom;
        const stepIdx = Math.min(
          state.predictions.predictions.length - 1,
          9,
        );
        const values = state.predictions.predictions[stepIdx];
        const lower = state.predictions.lowerBounds[stepIdx];
        const upper = state.predictions.upperBounds[stepIdx];
        const nDims = values.length;
        const barH = Math.min(30, (h - 10) / nDims);
        const gap = 5;
        let xMin = Math.min(...lower);
        let xMax = Math.max(...upper);
        const xPad = (xMax - xMin) * 0.1 || 1;
        xMin -= xPad;
        xMax += xPad;
        const xScale = (v) =>
          margin.left + ((v - xMin) / (xMax - xMin)) * w;
        ctx.save();
        ctx.translate(0.5, 0.5);
        for (let d = 0; d < nDims; d++) {
          const y = margin.top + d * (barH + gap);
          const val = values[d];
          const lo = lower[d];
          const hi = upper[d];
          const color = CHART_COLORS[d % CHART_COLORS.length];
          ctx.fillStyle = color.replace(")", ",0.2)").replace(
            "rgb",
            "rgba",
          );
          ctx.fillRect(xScale(lo), y, xScale(hi) - xScale(lo), barH);
          ctx.fillStyle = color;
          const barW = xScale(val) - xScale(xMin);
          ctx.fillRect(
            xScale(xMin > 0 ? xMin : 0),
            y,
            xScale(val) - xScale(xMin > 0 ? xMin : 0),
            barH,
          );
          ctx.fillStyle = textColor;
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          ctx.fillText(`D${d}`, margin.left - 8, y + barH / 2);
          ctx.textAlign = "left";
          ctx.fillText(
            val.toPrecision(3),
            xScale(hi) + 5,
            y + barH / 2,
          );
        }
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.15)"
          : "rgba(0,0,0,0.15)";
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, margin.top + h);
        ctx.lineTo(margin.left + w, margin.top + h);
        ctx.stroke();
        ctx.restore();
      }
      function handleChartHover(e) {
        if (!state.predictions || state.viewMode !== "focus") return;
        const canvas = document.getElementById("mainChart");
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const margin = { left: 60, right: 20 };
        const w = rect.width - margin.left - margin.right;
        const n = state.predictions.predictions.length;
        const relX = (x - margin.left) / w;
        const idx = Math.round(relX * (n - 1));
        if (
          idx >= 0 && idx < n && x >= margin.left &&
          x <= rect.width - margin.right
        ) {
          state.hoverX = idx;
        } else {
          state.hoverX = -1;
        }
        renderChart();
      }
      function parseDataFormat(data) {
        if (data.xCoordinates && data.yCoordinates) {
          return {
            x: data.xCoordinates,
            y: data.yCoordinates,
            format: "A",
          };
        }
        if (data.samples && Array.isArray(data.samples)) {
          const x = data.samples.map((s) => s.x);
          const y = data.samples.map((s) => s.y);
          return { x, y, format: "B" };
        }
        if (data.x && data.y && !Array.isArray(data.x[0])) {
          return { x: [data.x], y: [data.y], format: "C" };
        }
        throw new Error(
          "Unrecognized data format. Expected xCoordinates/yCoordinates or samples array.",
        );
      }
      function validateData(x, y) {
        if (!Array.isArray(x) || !Array.isArray(y)) {
          throw new Error("Data must be arrays");
        }
        if (x.length !== y.length) {
          throw new Error(
            `Length mismatch: ${x.length} x samples vs ${y.length} y samples`,
          );
        }
        if (x.length === 0) throw new Error("Dataset is empty");
        const nFeatures = x[0].length;
        const nTargets = y[0].length;
        for (let i = 0; i < x.length; i++) {
          if (!Array.isArray(x[i])) {
            throw new Error(`x[${i}] is not an array`);
          }
          if (!Array.isArray(y[i])) {
            throw new Error(`y[${i}] is not an array`);
          }
          if (x[i].length !== nFeatures) {
            throw new Error(
              `x[${i}] has ${
                x[i].length
              } features, expected ${nFeatures}`,
            );
          }
          if (y[i].length !== nTargets) {
            throw new Error(
              `y[${i}] has ${
                y[i].length
              } targets, expected ${nTargets}`,
            );
          }
          for (let j = 0; j < x[i].length; j++) {
            if (typeof x[i][j] !== "number" || isNaN(x[i][j])) {
              throw new Error(`x[${i}][${j}] is not a valid number`);
            }
          }
          for (let j = 0; j < y[i].length; j++) {
            if (typeof y[i][j] !== "number" || isNaN(y[i][j])) {
              throw new Error(`y[${i}][${j}] is not a valid number`);
            }
          }
        }
        return { nFeatures, nTargets, sampleCount: x.length };
      }
      function showModal(content) {
        const overlay = document.getElementById("modalOverlay");
        const container = document.getElementById("modalContent");
        container.innerHTML = content;
        overlay.classList.remove("hidden");
        overlay.querySelector("input, button, select, textarea")
          ?.focus();
        const closeBtn = container.querySelector("[data-close]");
        if (closeBtn) closeBtn.onclick = hideModal;
        overlay.onclick = (e) => {
          if (e.target === overlay) hideModal();
        };
      }
      function hideModal() {
        document.getElementById("modalOverlay").classList.add("hidden");
      }
      function showConfigModal() {
        const cfg = state.config;
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Model Configuration</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto flex-1 scrollbar-thin">
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Preset</label>
        <div class="grid grid-cols-3 gap-2">
          <button data-preset="start" class="px-3 py-2 text-sm rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-medium">Start Here</button>
          <button data-preset="fast" class="px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-blue-400">Fast</button>
          <button data-preset="balanced" class="px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-blue-400">Balanced</button>
          <button data-preset="accurate" class="px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-blue-400">Accurate</button>
          <button data-preset="adaptive" class="px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-blue-400">Adaptive</button>
          <button data-preset="robust" class="px-3 py-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-blue-400">Robust</button>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Reservoir Size <span class="text-slate-400">(32-1024)</span></label>
          <input type="number" id="cfgReservoirSize" value="${cfg.reservoirSize}" min="32" max="1024" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <p class="text-xs text-slate-500 mt-1">Larger = more capacity but slower. 256 is good for most cases.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Max Sequence Length <span class="text-slate-400">(16-512)</span></label>
          <input type="number" id="cfgMaxSeqLen" value="${cfg.maxSequenceLength}" min="16" max="512" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-slate-500 mt-1">Maximum prediction horizon. Must be >= futureSteps.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Spectral Radius <span class="text-slate-400">(0.5-0.99)</span></label>
          <input type="number" id="cfgSpectralRadius" value="${cfg.spectralRadius}" min="0.5" max="0.99" step="0.01" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-slate-500 mt-1">Controls memory. Higher = longer memory. Stay below 1.0.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Leak Rate <span class="text-slate-400">(0.1-1.0)</span></label>
          <input type="number" id="cfgLeakRate" value="${cfg.leakRate}" min="0.1" max="1.0" step="0.1" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-slate-500 mt-1">Lower = more smoothing. Higher = faster response to changes.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">RLS Lambda <span class="text-slate-400">(0.9-0.9999)</span></label>
          <input type="number" id="cfgRlsLambda" value="${cfg.rlsLambda}" min="0.9" max="0.9999" step="0.001" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-slate-500 mt-1">Forgetting factor. Lower = faster adaptation to drift.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">L2 Lambda <span class="text-slate-400">(0.00001-0.1)</span></label>
          <input type="number" id="cfgL2Lambda" value="${cfg.l2Lambda}" min="0.00001" max="0.1" step="0.00001" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-slate-500 mt-1">Regularization. Higher = prevents overfitting but may underfit.</p>
        </div>
      </div>
    </div>
    <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
      <button data-close class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">Cancel</button>
      <button id="applyConfig" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium">Create Model</button>
    </div>
  `);
        document.querySelectorAll("[data-preset]").forEach((btn) => {
          btn.onclick = () => {
            const preset = PRESETS[btn.dataset.preset];
            document.getElementById("cfgReservoirSize").value =
              preset.reservoirSize;
            document.getElementById("cfgMaxSeqLen").value =
              preset.maxSequenceLength;
            document.getElementById("cfgSpectralRadius").value =
              preset.spectralRadius;
            document.getElementById("cfgLeakRate").value =
              preset.leakRate;
            document.getElementById("cfgRlsLambda").value =
              preset.rlsLambda;
            document.getElementById("cfgL2Lambda").value =
              preset.l2Lambda;
            document.querySelectorAll("[data-preset]").forEach((b) =>
              b.classList.remove(
                "border-blue-500",
                "bg-blue-50",
                "dark:bg-blue-900/30",
                "text-blue-700",
                "dark:text-blue-300",
              )
            );
            btn.classList.add(
              "border-blue-500",
              "bg-blue-50",
              "dark:bg-blue-900/30",
              "text-blue-700",
              "dark:text-blue-300",
            );
          };
        });
        document.getElementById("applyConfig").onclick = () => {
          const config = {
            reservoirSize: parseInt(
              document.getElementById("cfgReservoirSize").value,
            ),
            maxSequenceLength: parseInt(
              document.getElementById("cfgMaxSeqLen").value,
            ),
            spectralRadius: parseFloat(
              document.getElementById("cfgSpectralRadius").value,
            ),
            leakRate: parseFloat(
              document.getElementById("cfgLeakRate").value,
            ),
            rlsLambda: parseFloat(
              document.getElementById("cfgRlsLambda").value,
            ),
            l2Lambda: parseFloat(
              document.getElementById("cfgL2Lambda").value,
            ),
          };
          hideModal();
          createModel(config);
        };
      }
      function showUploadModal() {
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Upload Dataset</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto flex-1 scrollbar-thin">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Upload JSON File</label>
        <input type="file" id="fileInput" accept=".json" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Or Paste JSON</label>
        <textarea id="jsonInput" rows="6" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 font-mono text-sm" placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'></textarea>
      </div>
      <div class="bg-slate-100 dark:bg-slate-700 rounded-lg p-4 text-sm">
        <div class="font-medium mb-2">Supported Formats:</div>
        <div class="text-slate-600 dark:text-slate-400 space-y-1">
          <div><code class="bg-slate-200 dark:bg-slate-600 px-1 rounded">Format A:</code> {"xCoordinates": number[][], "yCoordinates": number[][]}</div>
          <div><code class="bg-slate-200 dark:bg-slate-600 px-1 rounded">Format B:</code> {"samples": [{"x": number[], "y": number[]}, ...]}</div>
        </div>
      </div>
      <div id="uploadPreview" class="hidden mt-4 p-4 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg border border-emerald-200 dark:border-emerald-800">
        <div class="font-medium text-emerald-800 dark:text-emerald-300 mb-2">Preview</div>
        <div id="previewContent" class="text-sm text-emerald-700 dark:text-emerald-400"></div>
      </div>
      <div id="uploadError" class="hidden mt-4 p-4 bg-red-50 dark:bg-red-900/30 rounded-lg border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400"></div>
    </div>
    <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
      <button data-close class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">Cancel</button>
      <button id="validateUpload" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-medium">Validate</button>
      <button id="applyUpload" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium hidden">Apply & Train</button>
    </div>
  `);
        let parsedData = null;
        const fileInput = document.getElementById("fileInput");
        const jsonInput = document.getElementById("jsonInput");
        const preview = document.getElementById("uploadPreview");
        const previewContent = document.getElementById(
          "previewContent",
        );
        const error = document.getElementById("uploadError");
        const validateBtn = document.getElementById("validateUpload");
        const applyBtn = document.getElementById("applyUpload");
        fileInput.onchange = async () => {
          const file = fileInput.files[0];
          if (file) {
            jsonInput.value = await file.text();
          }
        };
        validateBtn.onclick = () => {
          error.classList.add("hidden");
          preview.classList.add("hidden");
          applyBtn.classList.add("hidden");
          try {
            const data = JSON.parse(jsonInput.value);
            const { x, y, format } = parseDataFormat(data);
            const { nFeatures, nTargets, sampleCount } = validateData(
              x,
              y,
            );
            parsedData = { x, y };
            previewContent.innerHTML = `
        <div>Format detected: ${format}</div>
        <div>Samples: ${sampleCount}</div>
        <div>Features (x): ${nFeatures}</div>
        <div>Targets (y): ${nTargets}</div>
        <div class="mt-2 text-xs">First sample: x=[${
              x[0].slice(0, 3).join(", ")
            }${x[0].length > 3 ? "..." : ""}] y=[${
              y[0].slice(0, 3).join(", ")
            }${y[0].length > 3 ? "..." : ""}]</div>
      `;
            preview.classList.remove("hidden");
            applyBtn.classList.remove("hidden");
          } catch (e) {
            error.textContent = e.message;
            error.classList.remove("hidden");
          }
        };
        applyBtn.onclick = async () => {
          if (!parsedData) return;
          hideModal();
          if (!state.modelReady) {
            await createModel(state.config);
          }
          await trainModel(
            parsedData.x,
            parsedData.y,
            parsedData.x.length > 50,
          );
        };
      }
      function showPredictModal() {
        const maxSteps = state.config.maxSequenceLength || 64;
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Predict Future</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6">
      <label class="block text-sm font-medium mb-2">Future Steps (1-${maxSteps})</label>
      <input type="range" id="futureStepsRange" min="1" max="${maxSteps}" value="20" class="w-full">
      <div class="flex justify-between text-sm text-slate-500 mt-1">
        <span>1</span>
        <span id="futureStepsValue" class="font-semibold text-blue-500">20</span>
        <span>${maxSteps}</span>
      </div>
      <input type="number" id="futureStepsInput" min="1" max="${maxSteps}" value="20" class="w-full mt-3 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
    </div>
    <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
      <button data-close class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">Cancel</button>
      <button id="runPredict" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium">Run Prediction</button>
    </div>
  `);
        const range = document.getElementById("futureStepsRange");
        const input = document.getElementById("futureStepsInput");
        const display = document.getElementById("futureStepsValue");
        range.oninput = () => {
          input.value = range.value;
          display.textContent = range.value;
        };
        input.oninput = () => {
          range.value = input.value;
          display.textContent = input.value;
        };
        document.getElementById("runPredict").onclick = () => {
          const steps = parseInt(input.value);
          if (steps < 1 || steps > maxSteps) {
            toast("error", `Steps must be between 1 and ${maxSteps}`);
            return;
          }
          hideModal();
          predict(steps);
        };
      }
      function showSaveLoadModal() {
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Save / Load Model</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto flex-1">
      <div class="grid gap-4 sm:grid-cols-2 mb-6">
        <button id="saveFile" class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-blue-400 text-left" ${
          !state.modelReady ? "disabled" : ""
        }>
          <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
          <div class="font-medium">Save to File</div>
          <div class="text-sm text-slate-500">Download model as JSON</div>
        </button>
        <button id="loadFile" class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-blue-400 text-left">
          <svg class="w-8 h-8 text-emerald-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
          <div class="font-medium">Load from File</div>
          <div class="text-sm text-slate-500">Import saved model</div>
        </button>
        <button id="saveLocal" class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-blue-400 text-left" ${
          !state.modelReady ? "disabled" : ""
        }>
          <svg class="w-8 h-8 text-violet-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
          <div class="font-medium">Save to Browser</div>
          <div class="text-sm text-slate-500">Store in localStorage</div>
        </button>
        <button id="loadLocal" class="p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-blue-400 text-left">
          <svg class="w-8 h-8 text-amber-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>
          <div class="font-medium">Load from Browser</div>
          <div class="text-sm text-slate-500">Restore from localStorage</div>
        </button>
      </div>
      <input type="file" id="loadFileInput" accept=".json" class="hidden">
    </div>
  `);
        document.getElementById("saveFile").onclick = async () => {
          try {
            const result = await sendToWorker("save");
            const wrapper = {
              modelState: result.modelState,
              meta: {
                config: state.config,
                nFeatures: state.nFeatures,
                nTargets: state.nTargets,
                sampleCount: result.sampleCount,
                createdAt: new Date().toISOString(),
                appVersion: APP_VERSION,
              },
            };
            const blob = new Blob([JSON.stringify(wrapper, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `esn-model-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast("success", "Model saved to file");
            log("success", "Save", "Model exported to file");
          } catch (e) {
            toast("error", e.message);
          }
        };
        document.getElementById("loadFile").onclick = () => {
          document.getElementById("loadFileInput").click();
        };
        document.getElementById("loadFileInput").onchange = async (
          e,
        ) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            let data = JSON.parse(text);
            hideModal();
            setLoading(true);
            await sendToWorker("load", {
              modelState: data,
              config: data.meta?.config || state.config,
            });
            state.modelReady = true;
            state.config = data.meta?.config || state.config;
            const summary = await sendToWorker("summary");
            state.nFeatures = summary.summary.nFeatures;
            state.nTargets = summary.summary.nTargets;
            state.sampleCount = summary.sampleCount;
            updateUI();
            updateDimSelector();
            toast("success", "Model loaded from file");
            log("success", "Load", "Model imported from file");
          } catch (err) {
            toast("error", err.message);
          } finally {
            setLoading(false);
          }
        };
        document.getElementById("saveLocal").onclick = async () => {
          try {
            const result = await sendToWorker("save");
            const wrapper = {
              modelState: result.modelState,
              meta: {
                config: state.config,
                nFeatures: state.nFeatures,
                nTargets: state.nTargets,
                sampleCount: result.sampleCount,
                createdAt: new Date().toISOString(),
                appVersion: APP_VERSION,
              },
            };
            localStorage.setItem("esn-model", JSON.stringify(wrapper));
            toast("success", "Model saved to browser");
            log("success", "Save", "Model saved to localStorage");
            hideModal();
          } catch (e) {
            toast("error", e.message);
          }
        };
        document.getElementById("loadLocal").onclick = async () => {
          try {
            const stored = localStorage.getItem("esn-model");
            if (!stored) {
              toast("warning", "No saved model found");
              return;
            }
            const data = JSON.parse(stored);
            hideModal();
            setLoading(true);
            await sendToWorker("load", {
              modelState: data,
              config: data.meta?.config || state.config,
            });
            state.modelReady = true;
            state.config = data.meta?.config || state.config;
            const summary = await sendToWorker("summary");
            state.nFeatures = summary.summary.nFeatures;
            state.nTargets = summary.summary.nTargets;
            state.sampleCount = summary.sampleCount;
            updateUI();
            updateDimSelector();
            toast("success", "Model loaded from browser");
            log("success", "Load", "Model restored from localStorage");
          } catch (err) {
            toast("error", err.message);
          } finally {
            setLoading(false);
          }
        };
      }
      function seededRandom(seed) {
        let s = seed;
        return () => {
          s = (s * 9301 + 49297) % 233280;
          return s / 233280;
        };
      }
      function showRandomTestModal() {
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Random Test Data</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6 overflow-y-auto flex-1 scrollbar-thin">
      <div class="grid gap-4 sm:grid-cols-2">
        <div>
          <label class="block text-sm font-medium mb-1">Seed</label>
          <input type="number" id="testSeed" value="42" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Samples</label>
          <input type="number" id="testSamples" value="200" min="50" max="1000" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Features</label>
          <input type="number" id="testFeatures" value="5" min="1" max="50" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Targets</label>
          <input type="number" id="testTargets" value="3" min="1" max="20" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Noise Level</label>
          <input type="range" id="testNoise" min="0" max="0.5" step="0.05" value="0.1" class="w-full">
          <div class="text-xs text-slate-500 text-right" id="noiseDisplay">0.1</div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Predict Steps</label>
          <input type="number" id="testPredict" value="30" min="5" max="100" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700">
        </div>
      </div>
      <div class="mt-4 p-3 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm text-slate-600 dark:text-slate-400">
        Generates synthetic multivariate data with nonlinear relationships: y[i] = Σ sin(αx) + cos(βx) + noise
      </div>
    </div>
    <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
      <button data-close class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">Cancel</button>
      <button id="runRandomTest" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-medium">Generate & Train & Predict</button>
    </div>
  `);
        const noiseInput = document.getElementById("testNoise");
        const noiseDisplay = document.getElementById("noiseDisplay");
        noiseInput.oninput = () => {
          noiseDisplay.textContent = noiseInput.value;
        };
        document.getElementById("runRandomTest").onclick = async () => {
          const seed = parseInt(
            document.getElementById("testSeed").value,
          );
          const samples = parseInt(
            document.getElementById("testSamples").value,
          );
          const nFeatures = parseInt(
            document.getElementById("testFeatures").value,
          );
          const nTargets = parseInt(
            document.getElementById("testTargets").value,
          );
          const noise = parseFloat(
            document.getElementById("testNoise").value,
          );
          const predictSteps = parseInt(
            document.getElementById("testPredict").value,
          );
          hideModal();
          const rand = seededRandom(seed);
          const x = [], y = [];
          for (let i = 0; i < samples; i++) {
            const xi = Array.from(
              { length: nFeatures },
              () => rand() * 4 - 2,
            );
            const yi = [];
            for (let t = 0; t < nTargets; t++) {
              let val = 0;
              for (let f = 0; f < nFeatures; f++) {
                val += Math.sin((t + 1) * xi[f]) * 0.5 +
                  Math.cos((f + 1) * xi[f] * 0.3) * 0.3;
              }
              val += (rand() - 0.5) * noise * 2;
              yi.push(val);
            }
            x.push(xi);
            y.push(yi);
          }
          const config = {
            ...PRESETS.start,
            maxSequenceLength: Math.max(64, predictSteps + 10),
          };
          await createModel(config);
          await trainModel(x, y, samples > 50);
          await predict(predictSteps);
        };
      }
      function showLogsModal() {
        const logs = state.logs.slice(0, 100);
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Event Logs</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex gap-2">
      <button data-filter="all" class="px-3 py-1 text-sm rounded-full bg-slate-200 dark:bg-slate-600">All</button>
      <button data-filter="success" class="px-3 py-1 text-sm rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">Success</button>
      <button data-filter="error" class="px-3 py-1 text-sm rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">Error</button>
      <button data-filter="info" class="px-3 py-1 text-sm rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">Info</button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 scrollbar-thin" id="logsList">
      ${
          logs.length === 0
            ? '<div class="text-slate-500 text-center py-8">No logs yet</div>'
            : logs.map((l) => `
        <div class="flex gap-3 py-2 border-b border-slate-100 dark:border-slate-700 text-sm">
          <span class="text-slate-400 text-xs whitespace-nowrap">${
              new Date(l.timestamp).toLocaleTimeString()
            }</span>
          <span class="px-1.5 py-0.5 rounded text-xs font-medium ${
              l.type === "success"
                ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-400"
                : l.type === "error"
                ? "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400"
                : "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
            }">${l.type}</span>
          <span class="font-medium">${l.action}</span>
          <span class="text-slate-500 truncate">${l.details}</span>
        </div>
      `).join("")
        }
    </div>
  `);
      }
      function showSummaryModal() {
        if (!state.modelReady) {
          toast("warning", "Create a model first");
          return;
        }
        showModal(`
    <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <h2 class="text-xl font-bold">Model Summary</h2>
      <button data-close class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6">
      <div class="grid gap-4 sm:grid-cols-2">
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Reservoir Size</div>
          <div class="text-xl font-bold">${state.config.reservoirSize}</div>
        </div>
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Max Sequence</div>
          <div class="text-xl font-bold">${state.config.maxSequenceLength}</div>
        </div>
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Features → Targets</div>
          <div class="text-xl font-bold">${state.nFeatures} → ${state.nTargets}</div>
        </div>
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Samples Trained</div>
          <div class="text-xl font-bold">${state.sampleCount}</div>
        </div>
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Spectral Radius</div>
          <div class="text-xl font-bold">${state.config.spectralRadius}</div>
        </div>
        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
          <div class="text-sm text-slate-500 dark:text-slate-400">Leak Rate</div>
          <div class="text-xl font-bold">${state.config.leakRate}</div>
        </div>
      </div>
    </div>
  `);
      }
      function init() {
        const savedTheme = localStorage.getItem("esn-theme");
        if (
          savedTheme === "dark" ||
          (!savedTheme &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
          state.darkMode = true;
        }
        createWorker();
        document.getElementById("themeToggle").onclick = () => {
          state.darkMode = !state.darkMode;
          document.documentElement.classList.toggle(
            "dark",
            state.darkMode,
          );
          localStorage.setItem(
            "esn-theme",
            state.darkMode ? "dark" : "light",
          );
          if (state.predictions) renderChart();
        };
        document.getElementById("menuBtn").onclick = () => {
          document.getElementById("sidebar").classList.remove(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.remove(
            "hidden",
          );
        };
        document.getElementById("closeSidebar").onclick = () => {
          document.getElementById("sidebar").classList.add(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.add(
            "hidden",
          );
        };
        document.getElementById("sidebarOverlay").onclick = () => {
          document.getElementById("sidebar").classList.add(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.add(
            "hidden",
          );
        };
        document.querySelectorAll("[data-action]").forEach((btn) => {
          btn.onclick = () => {
            const action = btn.dataset.action;
            document.getElementById("sidebar").classList.add(
              "-translate-x-full",
            );
            document.getElementById("sidebarOverlay").classList.add(
              "hidden",
            );
            switch (action) {
              case "config":
                showConfigModal();
                break;
              case "upload":
                showUploadModal();
                break;
              case "insert":
                showUploadModal();
                break;
              case "predict":
                showPredictModal();
                break;
              case "saveload":
                showSaveLoadModal();
                break;
              case "randomtest":
                showRandomTestModal();
                break;
              case "logs":
                showLogsModal();
                break;
              case "summary":
                showSummaryModal();
                break;
              case "reset":
                if (confirm("Reset model and clear all data?")) {
                  sendToWorker("reset").then(() => {
                    state.modelReady = false;
                    state.sampleCount = 0;
                    state.predictions = null;
                    updateUI();
                    document.getElementById("onboarding").classList
                      .remove("hidden");
                    document.getElementById("dashboard").classList.add(
                      "hidden",
                    );
                    toast("success", "Model reset");
                  });
                }
                break;
              case "train":
                showUploadModal();
                break;
              case "viewmode":
              case "export":
              case "advanced":
                toast("info", "Use the chart controls above");
                break;
            }
          };
        });
        document.querySelectorAll("[data-onboard]").forEach((btn) => {
          btn.onclick = () => {
            const action = btn.dataset.onboard;
            switch (action) {
              case "start":
                createModel(PRESETS.start);
                break;
              case "load":
                showSaveLoadModal();
                break;
              case "test":
                showRandomTestModal();
                break;
            }
          };
        });
        document.getElementById("quickPredict").onclick = () =>
          showPredictModal();
        document.getElementById("emptyPredict").onclick = () =>
          showPredictModal();
        document.getElementById("viewModeSelect").onchange = (e) => {
          state.viewMode = e.target.value;
          const container = document.getElementById("chartContainer");
          const grid = document.getElementById("gridContainer");
          const stats = document.getElementById("chartStats");
          if (state.viewMode === "grid") {
            container.classList.add("hidden");
            stats.classList.add("hidden");
            grid.classList.remove("hidden");
          } else {
            container.classList.remove("hidden");
            grid.classList.add("hidden");
            if (state.predictions) stats.classList.remove("hidden");
          }
          if (state.predictions) renderChart();
        };
        document.getElementById("dimSelect").onchange = (e) => {
          state.selectedDim = parseInt(e.target.value);
          updateChartStats();
          renderChart();
        };
        document.getElementById("zoomIn").onclick = () => {
          state.zoom.scale = Math.min(4, state.zoom.scale * 1.2);
          renderChart();
        };
        document.getElementById("zoomOut").onclick = () => {
          state.zoom.scale = Math.max(0.5, state.zoom.scale / 1.2);
          renderChart();
        };
        document.getElementById("zoomReset").onclick = () => {
          state.zoom = { scale: 1, offsetX: 0, offsetY: 0 };
          renderChart();
        };
        document.getElementById("exportChart").onclick = () => {
          const canvas = document.getElementById("mainChart");
          const link = document.createElement("a");
          link.download = `esn-chart-${Date.now()}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
          toast("success", "Chart exported");
        };
        const mainChart = document.getElementById("mainChart");
        mainChart.addEventListener("mousemove", handleChartHover);
        mainChart.addEventListener("mouseleave", () => {
          state.hoverX = -1;
          renderChart();
        });
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (state.predictions) renderChart();
          }, 150);
        });
        document.addEventListener("keydown", (e) => {
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA"
          ) return;
          if (e.key === "m" || e.key === "M") {
            document.getElementById("sidebar").classList.toggle(
              "-translate-x-full",
            );
            document.getElementById("sidebarOverlay").classList.toggle(
              "hidden",
            );
          }
          if (e.key === "c" || e.key === "C") showConfigModal();
          if (e.key === "p" || e.key === "P") {
            if (state.modelReady && state.sampleCount > 0) {
              showPredictModal();
            }
          }
          if (e.key === "Escape") hideModal();
        });
      }
      init();
    </script>
  </body>
</html>
