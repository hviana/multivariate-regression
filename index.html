<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "Inter",
                "system-ui",
                "-apple-system",
                "sans-serif",
              ],
              mono: ["JetBrains Mono", "Consolas", "monospace"],
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    >
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen font-sans text-slate-900 dark:text-slate-100 transition-colors"
  >
    <!-- Header -->
    <header
      id="header"
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/50 dark:border-slate-700/50"
    >
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
        <div class="flex items-center justify-between h-16 sm:h-18">
          <!-- Logo & Title -->
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30"
            >
              <span class="text-xl sm:text-2xl">üìä</span>
            </div>
            <div class="hidden sm:block">
              <h1
                class="text-lg sm:text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent"
              >
                ESN Studio
              </h1>
              <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">
                Autoregressive Forecasting
              </p>
            </div>
          </div>

          <!-- Status & Actions -->
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- Status Badge -->
            <div
              id="statusBadge"
              class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
            >
              <span
                id="statusDot"
                class="w-2 h-2 rounded-full bg-slate-400"
              ></span>
              <span
                id="statusText"
                class="text-xs font-semibold text-slate-600 dark:text-slate-400"
              >No Model</span>
            </div>

            <!-- Predict Button -->
            <button
              id="headerPredictBtn"
              class="hidden min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold text-sm shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 items-center gap-2"
              aria-label="Run Prediction"
            >
              <span>‚ö°</span>
              <span class="hidden sm:inline">Predict</span>
            </button>

            <!-- Config Button -->
            <button
              id="configBtn"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700"
              aria-label="Configuration"
            >
              <span class="text-xl">‚öôÔ∏è</span>
            </button>

            <!-- Theme Toggle -->
            <button
              id="themeToggle"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700"
              aria-label="Toggle Theme"
            >
              <span id="themeIcon" class="text-xl">üåô</span>
            </button>

            <!-- Menu Button -->
            <button
              id="menuBtn"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700"
              aria-label="Open Menu"
            >
              <span class="text-xl">‚ò∞</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 pb-24 lg:pb-8">
      <div class="flex flex-col lg:flex-row gap-4 lg:gap-6 mt-4 sm:mt-6">
        <!-- Visualization Section -->
        <div class="flex-1 min-w-0">
          <!-- Visualization Tabs -->
          <div class="mb-4 overflow-x-auto scrollbar-hide">
            <div class="flex gap-2 min-w-max pb-2">
              <button
                data-viz="grid"
                class="viz-tab active min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/25"
              >
                <span>üìä</span>
                <span class="hidden sm:inline">Grid</span>
              </button>
              <button
                data-viz="focus"
                class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                <span>üîç</span>
                <span class="hidden sm:inline">Focus</span>
              </button>
              <button
                data-viz="heatmap"
                class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                <span>üå°Ô∏è</span>
                <span class="hidden sm:inline">Heatmap</span>
              </button>
              <button
                data-viz="uncertainty"
                class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                <span>üìà</span>
                <span class="hidden sm:inline">CI</span>
              </button>
              <button
                data-viz="snapshot"
                class="viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                <span>üì∑</span>
                <span class="hidden sm:inline">Snapshot</span>
              </button>
            </div>
          </div>

          <!-- Dimension Selector (Focus Mode) -->
          <div
            id="dimSelector"
            class="hidden mb-4 overflow-x-auto scrollbar-hide"
          >
            <div id="dimButtons" class="flex gap-2 min-w-max pb-2">
              <!-- Dimension buttons will be added dynamically -->
            </div>
          </div>

          <!-- Step Selector (Snapshot Mode) -->
          <div id="stepSelector" class="hidden mb-4">
            <div
              class="flex items-center gap-3 p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm"
            >
              <label
                class="text-sm font-semibold text-slate-600 dark:text-slate-400"
              >Step:</label>
              <input
                type="number"
                id="stepInput"
                min="1"
                value="1"
                class="w-24 px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
              <span id="stepMax" class="text-xs text-slate-500">/ 100</span>
            </div>
          </div>

          <!-- Chart Container -->
          <div
            class="relative rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-xl overflow-hidden"
          >
            <!-- Zoom Level Badge -->
            <div
              id="zoomBadge"
              class="hidden absolute top-3 left-3 z-10 px-2.5 py-1 rounded-lg bg-slate-900/80 dark:bg-slate-100/90 text-white dark:text-slate-900 text-xs font-bold"
            >
              100%
            </div>

            <!-- Chart Controls -->
            <div
              id="chartControls"
              class="hidden absolute top-3 right-3 z-10 flex gap-1.5"
            >
              <button
                id="zoomIn"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-lg hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Zoom In"
              >
                ‚ûï
              </button>
              <button
                id="zoomOut"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-lg hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Zoom Out"
              >
                ‚ûñ
              </button>
              <button
                id="zoomReset"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-lg hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Reset Zoom"
              >
                üîÑ
              </button>
            </div>

            <!-- Export Controls -->
            <div
              id="exportControls"
              class="hidden absolute bottom-3 right-3 z-10 flex gap-1.5"
            >
              <button
                id="savePng"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Save as PNG"
              >
                üñºÔ∏è
              </button>
              <button
                id="saveSvg"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Save as SVG"
              >
                üìÑ
              </button>
              <button
                id="copyChart"
                class="min-w-[36px] min-h-[36px] flex items-center justify-center rounded-lg bg-white dark:bg-slate-700 shadow-lg border border-slate-200 dark:border-slate-600 text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Copy to Clipboard"
              >
                üìã
              </button>
            </div>

            <!-- Canvas -->
            <canvas
              id="chartCanvas"
              class="w-full touch-pan-x touch-pan-y"
              style="height: 400px"
            ></canvas>

            <!-- Tooltip -->
            <div
              id="chartTooltip"
              class="hidden absolute z-20 pointer-events-none"
            >
              <div
                class="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-xl px-4 py-3 shadow-2xl min-w-[180px]"
              >
                <div
                  class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-700 dark:border-slate-300"
                >
                  <span class="text-lg font-bold">Step <span id="tooltipStep"
                    >1</span></span>
                </div>
                <div class="flex items-center gap-2 mb-1">
                  <span
                    id="tooltipDimDot"
                    class="w-3 h-3 rounded-full bg-blue-500"
                  ></span>
                  <span
                    id="tooltipDimName"
                    class="text-xs text-slate-400 dark:text-slate-600 font-medium"
                  >D1</span>
                </div>
                <div class="text-xl font-bold mb-2" id="tooltipValue">
                  0.000
                </div>
                <div
                  class="text-xs text-slate-400 dark:text-slate-600 space-y-0.5"
                >
                  <div>
                    CI: <span id="tooltipLower" class="font-mono">0.00</span> -
                    <span id="tooltipUpper" class="font-mono">0.00</span>
                  </div>
                  <div>
                    Spread: <span id="tooltipSpread" class="font-mono"
                    >0.00</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div
              id="emptyState"
              class="absolute inset-0 flex items-center justify-center bg-white dark:bg-slate-800"
            >
              <div class="text-center p-8 max-w-md">
                <div class="relative inline-block mb-6">
                  <div
                    class="w-32 h-32 rounded-3xl bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 flex items-center justify-center"
                  >
                    <div
                      class="w-24 h-24 rounded-2xl bg-gradient-to-br from-blue-200 to-indigo-200 dark:from-blue-800/50 dark:to-indigo-800/50 flex items-center justify-center"
                    >
                      <span class="text-5xl">üìä</span>
                    </div>
                  </div>
                </div>
                <h2
                  class="text-2xl font-bold mb-2 text-slate-800 dark:text-slate-100"
                >
                  Create a Model to Begin
                </h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">
                  ESN Studio uses Echo State Networks for multivariate
                  autoregressive time series forecasting with uncertainty
                  quantification.
                </p>
                <div class="space-y-3">
                  <button
                    id="startDefaultsBtn"
                    class="w-full min-h-[48px] px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 flex items-center justify-center gap-2"
                  >
                    <span>‚ö°</span>
                    <span>Start with Defaults</span>
                  </button>
                  <div class="flex gap-3">
                    <button
                      id="loadModelBtn"
                      class="flex-1 min-h-[44px] px-4 py-2.5 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center gap-2"
                    >
                      <span>üì§</span>
                      <span>Load</span>
                    </button>
                    <button
                      id="demoBtn"
                      class="flex-1 min-h-[44px] px-4 py-2.5 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg shadow-purple-500/25 hover:shadow-purple-500/40 flex items-center justify-center gap-2"
                    >
                      <span>‚ú®</span>
                      <span>Demo</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading Overlay -->
            <div
              id="loadingOverlay"
              class="hidden absolute inset-0 flex items-center justify-center bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm z-30"
            >
              <div class="text-center p-8">
                <div
                  class="w-16 h-16 mx-auto mb-4 border-4 border-blue-200 dark:border-blue-800 border-t-blue-500 rounded-full"
                >
                </div>
                <p
                  id="loadingText"
                  class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4"
                >
                  Processing...
                </p>
                <div
                  class="w-64 h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"
                >
                  <div
                    id="loadingProgress"
                    class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full"
                    style="width: 0%"
                  >
                  </div>
                </div>
                <p
                  id="loadingPercent"
                  class="text-sm text-slate-500 dark:text-slate-400 mb-4"
                >
                  0%
                </p>
                <button
                  id="cancelBtn"
                  class="min-h-[44px] px-6 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-semibold hover:bg-red-200 dark:hover:bg-red-900/50"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Statistics Bar (Focus Mode) -->
          <div
            id="statsBar"
            class="hidden mt-4 grid grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3"
          >
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Min
              </div>
              <div
                id="statMin"
                class="text-lg font-bold text-slate-800 dark:text-slate-100 font-mono"
              >
                -
              </div>
            </div>
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Max
              </div>
              <div
                id="statMax"
                class="text-lg font-bold text-slate-800 dark:text-slate-100 font-mono"
              >
                -
              </div>
            </div>
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Mean
              </div>
              <div
                id="statMean"
                class="text-lg font-bold text-slate-800 dark:text-slate-100 font-mono"
              >
                -
              </div>
            </div>
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Final
              </div>
              <div
                id="statFinal"
                class="text-lg font-bold text-slate-800 dark:text-slate-100 font-mono"
              >
                -
              </div>
            </div>
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Trend
              </div>
              <div id="statTrend" class="text-lg font-bold font-mono">-</div>
            </div>
            <div
              class="p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold mb-1"
              >
                Confidence
              </div>
              <div
                id="statConf"
                class="text-lg font-bold text-slate-800 dark:text-slate-100 font-mono"
              >
                -
              </div>
            </div>
          </div>
        </div>

        <!-- Side Panel (Desktop) -->
        <aside id="sidePanel" class="hidden lg:block w-80 flex-shrink-0">
          <div class="sticky top-24 space-y-4">
            <!-- Model Metrics -->
            <div
              class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg overflow-hidden"
            >
              <div
                class="px-4 py-3 border-b border-slate-200 dark:border-slate-700"
              >
                <h3
                  class="text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400"
                >
                  Model Metrics
                </h3>
              </div>
              <div class="p-4 space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600 dark:text-slate-400"
                  >Samples Trained</span>
                  <span
                    id="metricSamples"
                    class="text-sm font-bold text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded"
                  >0</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600 dark:text-slate-400"
                  >Avg Loss</span>
                  <span
                    id="metricLoss"
                    class="text-sm font-mono text-slate-700 dark:text-slate-300"
                  >-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600 dark:text-slate-400"
                  >Gradient Norm</span>
                  <span
                    id="metricGrad"
                    class="text-sm font-mono text-slate-700 dark:text-slate-300"
                  >-</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600 dark:text-slate-400"
                  >Sample Weight</span>
                  <span
                    id="metricWeight"
                    class="text-sm font-mono text-slate-700 dark:text-slate-300"
                  >-</span>
                </div>
              </div>
            </div>

            <!-- Prediction -->
            <div
              class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg overflow-hidden"
            >
              <div
                class="px-4 py-3 border-b border-slate-200 dark:border-slate-700"
              >
                <h3
                  class="text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400"
                >
                  Prediction
                </h3>
              </div>
              <div class="p-4 space-y-4">
                <div>
                  <label
                    class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2"
                  >Future Steps</label>
                  <input
                    type="number"
                    id="futureSteps"
                    min="1"
                    value="100"
                    class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                </div>
                <button
                  id="runPredictBtn"
                  disabled
                  class="w-full min-h-[48px] px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none hover:shadow-blue-500/40 flex items-center justify-center gap-2"
                >
                  <span>‚ö°</span>
                  <span>Run Prediction</span>
                </button>
              </div>
            </div>

            <!-- Event Log -->
            <div
              class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg overflow-hidden"
            >
              <div
                class="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
              >
                <h3
                  class="text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400"
                >
                  Event Log
                </h3>
                <select
                  id="logFilter"
                  class="text-xs px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 border-0 text-slate-600 dark:text-slate-400 focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
              <div
                class="px-4 py-2 border-b border-slate-100 dark:border-slate-700"
              >
                <input
                  type="text"
                  id="logSearch"
                  placeholder="Search logs..."
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border-0 text-sm placeholder-slate-400 focus:ring-2 focus:ring-blue-500"
                >
              </div>
              <div id="logContainer" class="h-48 overflow-y-auto p-2 space-y-1">
                <!-- Log entries will be added here -->
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Mobile Bottom Bar -->
    <div
      id="mobileBottomBar"
      class="lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-t border-slate-200/50 dark:border-slate-700/50 px-4 py-3"
    >
      <div class="flex items-center gap-3">
        <button
          id="mobilePanelBtn"
          class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
          aria-label="Open Details"
        >
          <span class="text-xl">üìä</span>
        </button>
        <div class="flex-1">
          <div
            class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mb-1"
          >
            <span
              id="mobileStatusDot"
              class="w-2 h-2 rounded-full bg-slate-400"
            ></span>
            <span id="mobileStatusText">No Model</span>
          </div>
        </div>
        <button
          id="mobilePredictBtn"
          disabled
          class="min-h-[44px] px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:shadow-none flex items-center gap-2"
        >
          <span>‚ö°</span>
          <span>Predict</span>
        </button>
      </div>
    </div>

    <!-- Mobile Side Panel Overlay -->
    <div id="mobilePanelOverlay" class="hidden fixed inset-0 z-50">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        id="mobilePanelBackdrop"
      >
      </div>
      <div
        class="absolute right-0 top-0 h-full w-[85%] max-w-[384px] bg-white dark:bg-slate-800 shadow-2xl overflow-y-auto"
      >
        <div
          class="sticky top-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-4 flex items-center justify-between"
        >
          <h2 class="text-lg font-bold">Details</h2>
          <button
            id="closeMobilePanel"
            class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
            aria-label="Close"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>
        <div class="p-4 space-y-4" id="mobilePanelContent">
          <!-- Same content as side panel will be cloned here -->
        </div>
      </div>
    </div>

    <!-- Main Menu Overlay -->
    <div id="menuOverlay" class="hidden fixed inset-0 z-50">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        id="menuBackdrop"
      >
      </div>
      <div
        class="absolute right-0 top-0 h-full w-[85%] max-w-[400px] bg-white dark:bg-slate-800 shadow-2xl overflow-y-auto"
      >
        <div
          class="sticky top-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-4 flex items-center justify-between"
        >
          <h2 class="text-lg font-bold">Menu</h2>
          <button
            id="closeMenu"
            class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
            aria-label="Close Menu"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>
        <div class="p-4 space-y-6">
          <!-- Model Section -->
          <div>
            <div
              class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
            >
              <span>üìÅ</span>
              <span>Model</span>
            </div>
            <div class="space-y-2">
              <button
                id="menuConfigBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center"
                >
                  <span class="text-xl">üéõÔ∏è</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Create & Configure
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Set up model parameters
                  </div>
                </div>
              </button>
              <button
                id="menuSaveLoadBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center"
                >
                  <span class="text-xl">üíæ</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Save & Load
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Persist your models
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Data Section -->
          <div>
            <div
              class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
            >
              <span>üìÇ</span>
              <span>Data</span>
            </div>
            <div class="space-y-2">
              <button
                id="menuUploadBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center"
                >
                  <span class="text-xl">üì§</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Upload Dataset
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Import time series data
                  </div>
                </div>
              </button>
              <button
                id="menuInsertBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center"
                >
                  <span class="text-xl">‚ûï</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Manual Insert
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Add individual time steps
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Test Section -->
          <div>
            <div
              class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
            >
              <span>üß™</span>
              <span>Test</span>
            </div>
            <div class="space-y-2">
              <button
                id="menuRandomBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center"
                >
                  <span class="text-xl">üí°</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Random Test
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Generate synthetic time series
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Advanced Section -->
          <div>
            <div
              class="flex items-center gap-2 text-xs uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
            >
              <span>‚öôÔ∏è</span>
              <span>Advanced</span>
            </div>
            <div class="space-y-2">
              <button
                id="menuSettingsBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-600 flex items-center justify-center"
                >
                  <span class="text-xl">üîß</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Settings
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Module URL & preferences
                  </div>
                </div>
              </button>
              <button
                id="menuDataTableBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-600 flex items-center justify-center"
                >
                  <span class="text-xl">üìã</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    View Data Table
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Raw prediction values
                  </div>
                </div>
              </button>
              <button
                id="menuHelpBtn"
                class="w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 text-left flex items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-600 flex items-center justify-center"
                >
                  <span class="text-xl">‚ùì</span>
                </div>
                <div>
                  <div class="font-semibold text-slate-800 dark:text-slate-100">
                    Help
                  </div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Documentation & guides
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div
        class="min-h-screen px-0 sm:px-4 flex items-start sm:items-center justify-center"
      >
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="configBackdrop"
        >
        </div>
        <div
          class="relative w-full sm:max-w-3xl bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl max-h-screen sm:max-h-[90vh] overflow-y-auto"
        >
          <!-- Header -->
          <div
            class="sticky top-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 py-4 flex items-center justify-between z-10"
          >
            <h2 class="text-xl font-bold">Model Configuration</h2>
            <button
              id="closeConfigModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>

          <!-- Presets -->
          <div
            class="px-4 sm:px-6 py-4 border-b border-slate-200 dark:border-slate-700 overflow-x-auto"
          >
            <div class="flex gap-2 min-w-max">
              <button
                data-preset="default"
                class="preset-btn active min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400"
              >
                Start Here
              </button>
              <button
                data-preset="fast"
                class="preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Fast
              </button>
              <button
                data-preset="balanced"
                class="preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Balanced
              </button>
              <button
                data-preset="accurate"
                class="preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Accurate
              </button>
              <button
                data-preset="adaptive"
                class="preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Adaptive
              </button>
              <button
                data-preset="robust"
                class="preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                Robust
              </button>
            </div>
          </div>

          <!-- Configuration Sections -->
          <div class="p-4 sm:p-6 space-y-4">
            <!-- Reservoir Architecture -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left"
                data-section="reservoir"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Reservoir Architecture</span>
                <span class="text-slate-400">‚ñº</span>
              </button>
              <div
                class="config-content px-4 py-4 space-y-4"
                id="reservoirSection"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Reservoir Size</label>
                    <input
                      type="number"
                      id="reservoirSize"
                      value="256"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Neurons in reservoir
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Spectral Radius</label>
                    <input
                      type="number"
                      id="spectralRadius"
                      value="0.9"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Memory length control
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Leak Rate</label>
                    <input
                      type="number"
                      id="leakRate"
                      value="0.3"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Temporal smoothing
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Input Scale</label>
                    <input
                      type="number"
                      id="inputScale"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Input scaling factor
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Bias Scale</label>
                    <input
                      type="number"
                      id="biasScale"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Bias scaling</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Reservoir Sparsity</label>
                    <input
                      type="number"
                      id="reservoirSparsity"
                      value="0.9"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Zero connections</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Input Sparsity</label>
                    <input
                      type="number"
                      id="inputSparsity"
                      value="0.0"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Input sparsity</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Activation</label>
                    <select
                      id="activation"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="tanh">tanh</option>
                      <option value="relu">relu</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">
                      Activation function
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Readout Configuration -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left"
                data-section="readout"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Readout Configuration</span>
                <span class="text-slate-400">‚ñº</span>
              </button>
              <div
                class="config-content px-4 py-4 space-y-4"
                id="readoutSection"
              >
                <div
                  class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <div class="font-medium text-slate-800 dark:text-slate-100">
                      Use Input in Readout
                    </div>
                    <div class="text-xs text-slate-500">
                      Append input to state
                    </div>
                  </div>
                  <button
                    id="useInputInReadout"
                    class="toggle-btn w-12 h-7 rounded-full bg-blue-500 relative"
                    data-value="true"
                  >
                    <span
                      class="absolute w-5 h-5 bg-white rounded-full top-1 right-1 shadow"
                    ></span>
                  </button>
                </div>
                <div
                  class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <div class="font-medium text-slate-800 dark:text-slate-100">
                      Use Bias in Readout
                    </div>
                    <div class="text-xs text-slate-500">Include bias term</div>
                  </div>
                  <button
                    id="useBiasInReadout"
                    class="toggle-btn w-12 h-7 rounded-full bg-blue-500 relative"
                    data-value="true"
                  >
                    <span
                      class="absolute w-5 h-5 bg-white rounded-full top-1 right-1 shadow"
                    ></span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Training (RLS) -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left"
                data-section="training"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Training (RLS)</span>
                <span class="text-slate-400">‚ñº</span>
              </button>
              <div
                class="config-content px-4 py-4 space-y-4"
                id="trainingSection"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Readout Training</label>
                    <input
                      type="text"
                      value="rls"
                      disabled
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-100 dark:bg-slate-600 border border-slate-200 dark:border-slate-500 text-sm text-slate-500 cursor-not-allowed"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      RLS training (fixed)
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >RLS Lambda</label>
                    <input
                      type="number"
                      id="rlsLambda"
                      value="0.999"
                      step="0.001"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Forgetting factor</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >RLS Delta</label>
                    <input
                      type="number"
                      id="rlsDelta"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Initial P diagonal
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Epsilon</label>
                    <input
                      type="number"
                      id="epsilon"
                      value="1e-8"
                      step="1e-9"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Numerical stability
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >L2 Lambda</label>
                    <input
                      type="number"
                      id="l2Lambda"
                      value="0.0001"
                      step="0.0001"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                    >
                    <p class="text-xs text-slate-500 mt-1">L2 regularization</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Gradient Clip Norm</label>
                    <input
                      type="number"
                      id="gradientClipNorm"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Max update norm</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Normalization -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left collapsed"
                data-section="normalization"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Normalization</span>
                <span class="text-slate-400">‚ñ∂</span>
              </button>
              <div
                class="config-content hidden px-4 py-4 space-y-4"
                id="normalizationSection"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Normalization Epsilon</label>
                    <input
                      type="number"
                      id="normalizationEpsilon"
                      value="1e-8"
                      step="1e-9"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Stability constant
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Normalization Warmup</label>
                    <input
                      type="number"
                      id="normalizationWarmup"
                      value="10"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Warmup samples</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Outlier Handling -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left collapsed"
                data-section="outlier"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Outlier Handling</span>
                <span class="text-slate-400">‚ñ∂</span>
              </button>
              <div
                class="config-content hidden px-4 py-4 space-y-4"
                id="outlierSection"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Outlier Threshold</label>
                    <input
                      type="number"
                      id="outlierThreshold"
                      value="3.0"
                      step="0.1"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Z-score threshold</p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Outlier Min Weight</label>
                    <input
                      type="number"
                      id="outlierMinWeight"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Outlier minimum weight
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Uncertainty -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left collapsed"
                data-section="uncertainty"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Uncertainty</span>
                <span class="text-slate-400">‚ñ∂</span>
              </button>
              <div
                class="config-content hidden px-4 py-4 space-y-4"
                id="uncertaintySection"
              >
                <div>
                  <label
                    class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                  >Uncertainty Multiplier</label>
                  <input
                    type="number"
                    id="uncertaintyMultiplier"
                    value="1.96"
                    step="0.01"
                    class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                  <p class="text-xs text-slate-500 mt-1">
                    CI Multiplier (1.96 = 95% CI)
                  </p>
                </div>
              </div>
            </div>

            <!-- Initialization -->
            <div
              class="config-section rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden"
            >
              <button
                class="config-toggle w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 flex items-center justify-between text-left collapsed"
                data-section="init"
              >
                <span class="font-semibold text-slate-800 dark:text-slate-100"
                >Initialization</span>
                <span class="text-slate-400">‚ñ∂</span>
              </button>
              <div
                class="config-content hidden px-4 py-4 space-y-4"
                id="initSection"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Weight Init Scale</label>
                    <input
                      type="number"
                      id="weightInitScale"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">
                      Initial weight scale
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                    >Seed</label>
                    <input
                      type="number"
                      id="seed"
                      value="42"
                      class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <p class="text-xs text-slate-500 mt-1">Random seed</p>
                  </div>
                </div>
                <div
                  class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50"
                >
                  <div>
                    <div class="font-medium text-slate-800 dark:text-slate-100">
                      Verbose
                    </div>
                    <div class="text-xs text-slate-500">Detailed logging</div>
                  </div>
                  <button
                    id="verbose"
                    class="toggle-btn w-12 h-7 rounded-full bg-slate-300 dark:bg-slate-600 relative"
                    data-value="false"
                  >
                    <span
                      class="absolute w-5 h-5 bg-white rounded-full top-1 left-1 shadow"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div
            class="sticky bottom-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-4 sm:px-6 py-4 flex flex-wrap gap-2 sm:gap-3"
          >
            <button
              id="resetDefaults"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 text-sm"
            >
              Reset Defaults
            </button>
            <button
              id="resetAll"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-semibold hover:bg-red-200 dark:hover:bg-red-900/50 text-sm"
            >
              Reset All
            </button>
            <div class="flex-1"></div>
            <button
              id="cancelConfig"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 text-sm"
            >
              Cancel
            </button>
            <button
              id="createModel"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 text-sm"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="uploadBackdrop"
        >
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
          >
            <h2 class="text-xl font-bold">Upload Dataset</h2>
            <button
              id="closeUploadModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <!-- Drag & Drop Zone -->
            <div
              id="dropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 cursor-pointer"
            >
              <span class="text-5xl mb-4 block">üìÅ</span>
              <p class="text-slate-600 dark:text-slate-400 font-medium">
                Drop JSON file here or tap to browse
              </p>
              <input type="file" id="fileInput" accept=".json" class="hidden">
            </div>

            <!-- Or Paste -->
            <div class="text-center text-sm text-slate-500 dark:text-slate-400">
              ‚Äî or paste JSON directly ‚Äî
            </div>

            <textarea
              id="jsonPaste"
              rows="6"
              placeholder='{"coordinates": [[1.0, 2.0], [1.1, 2.1], ...]}'
              class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            ></textarea>

            <!-- Format Example -->
            <details
              class="rounded-xl bg-slate-50 dark:bg-slate-700/50 overflow-hidden"
            >
              <summary
                class="px-4 py-3 cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-400"
              >
                View format example
              </summary>
              <div class="px-4 pb-4">
                <pre
                  class="text-xs font-mono text-slate-600 dark:text-slate-400 overflow-x-auto"
                >
{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</pre>
                <button
                  id="copyExample"
                  class="mt-2 text-xs text-blue-600 dark:text-blue-400 font-semibold"
                >
                  üìã Copy example
                </button>
              </div>
            </details>

            <!-- Validation Preview -->
            <div
              id="uploadPreview"
              class="hidden p-4 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800"
            >
              <div
                class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400 font-semibold mb-2"
              >
                <span>‚úì</span>
                <span>Valid Format</span>
              </div>
              <div
                class="text-sm text-emerald-700 dark:text-emerald-300 space-y-1"
              >
                <div>
                  Dimensions: <span id="previewDims" class="font-mono font-bold"
                  >3</span>
                </div>
                <div>
                  Time Steps: <span
                    id="previewSteps"
                    class="font-mono font-bold"
                  >100</span>
                </div>
              </div>
            </div>

            <!-- Error Display -->
            <div
              id="uploadError"
              class="hidden p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
            >
              <div
                class="flex items-center gap-2 text-red-600 dark:text-red-400 font-semibold mb-1"
              >
                <span>‚úó</span>
                <span>Invalid Format</span>
              </div>
              <p
                id="uploadErrorText"
                class="text-sm text-red-700 dark:text-red-300"
              >
              </p>
            </div>
          </div>
          <div
            class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
          >
            <button
              id="cancelUpload"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              Cancel
            </button>
            <button
              id="validateUpload"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              Validate
            </button>
            <button
              id="applyTrain"
              disabled
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
            >
              Apply & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div id="insertModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="insertBackdrop"
        >
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
          >
            <h2 class="text-xl font-bold">Manual Insert</h2>
            <button
              id="closeInsertModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <p class="text-sm text-slate-600 dark:text-slate-400">
              Add individual time steps to continue training the model. Minimum
              2 consecutive steps required.
            </p>
            <button
              id="genTemplate"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 text-sm"
            >
              üìù Generate Template
            </button>
            <textarea
              id="insertJson"
              rows="8"
              placeholder='{"coordinates": [[...], [...]]}'
              class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            ></textarea>
            <div id="insertFeedback" class="hidden p-3 rounded-xl text-sm">
            </div>
          </div>
          <div
            class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
          >
            <button
              id="cancelInsert"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              Cancel
            </button>
            <button
              id="doInsert"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/25"
            >
              Insert & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div id="saveLoadModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="saveLoadBackdrop"
        >
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
          >
            <h2 class="text-xl font-bold">Save & Load</h2>
            <button
              id="closeSaveLoadModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-6 space-y-6">
            <!-- Save Section -->
            <div>
              <h3
                class="text-sm uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
              >
                Save Model
              </h3>
              <div class="flex gap-3">
                <button
                  id="downloadModel"
                  class="flex-1 min-h-[48px] px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-600 font-semibold flex items-center justify-center gap-2"
                >
                  <span>üì•</span>
                  <span>Download</span>
                </button>
                <button
                  id="saveToStorage"
                  class="flex-1 min-h-[48px] px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-600 font-semibold flex items-center justify-center gap-2"
                >
                  <span>üíæ</span>
                  <span>Browser</span>
                </button>
              </div>
            </div>

            <!-- Load Section -->
            <div>
              <h3
                class="text-sm uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 mb-3"
              >
                Load Model
              </h3>
              <div
                id="loadDropZone"
                class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 cursor-pointer mb-4"
              >
                <span class="text-3xl mb-2 block">üì§</span>
                <p class="text-sm text-slate-600 dark:text-slate-400">
                  Tap to upload model file
                </p>
                <input
                  type="file"
                  id="loadFileInput"
                  accept=".json"
                  class="hidden"
                >
              </div>

              <!-- Saved Models List -->
              <div id="savedModelsList" class="space-y-2">
                <!-- Saved models will be listed here -->
              </div>
              <button
                id="clearAllSaved"
                class="mt-4 text-sm text-red-600 dark:text-red-400 font-semibold hover:underline"
              >
                Clear all saved models
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div id="randomModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="randomBackdrop"
        >
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
          >
            <h2 class="text-xl font-bold">Random Test</h2>
            <button
              id="closeRandomModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <p class="text-sm text-slate-600 dark:text-slate-400">
              Generate synthetic time series data for testing the model.
            </p>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Seed</label>
                <input
                  type="number"
                  id="testSeed"
                  value="42"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Dimensions</label>
                <input
                  type="number"
                  id="testDims"
                  value="3"
                  min="1"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Time Steps</label>
                <input
                  type="number"
                  id="testSteps"
                  value="200"
                  min="10"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Noise</label>
                <input
                  type="number"
                  id="testNoise"
                  value="0.1"
                  step="0.01"
                  min="0"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Outliers Rate</label>
                <input
                  type="number"
                  id="testOutliers"
                  value="0.02"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1"
                >Difficulty</label>
                <select
                  id="testDifficulty"
                  class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="easy">Easy</option>
                  <option value="medium" selected>Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </div>
            </div>
          </div>
          <div
            class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
          >
            <button
              id="cancelRandom"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              Cancel
            </button>
            <button
              id="generateRun"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg shadow-purple-500/25"
            >
              Generate & Run
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="settingsBackdrop"
        >
        </div>
        <div
          class="relative w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
          >
            <h2 class="text-xl font-bold">Settings</h2>
            <button
              id="closeSettingsModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <div>
              <label
                class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2"
              >Module URL</label>
              <input
                type="text"
                id="moduleUrl"
                class="w-full px-3 py-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0"
              >
            </div>
            <button
              id="reinitWorker"
              class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 font-semibold hover:bg-amber-200 dark:hover:bg-amber-900/50"
            >
              Reinitialize Worker
            </button>
            <button
              id="clearPrefs"
              class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-semibold hover:bg-red-200 dark:hover:bg-red-900/50"
            >
              Clear All Preferences
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div id="dataTableModal" class="hidden fixed inset-0 z-50 overflow-hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        id="dataTableBackdrop"
      >
      </div>
      <div
        class="absolute inset-0 sm:inset-4 lg:inset-8 bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden"
      >
        <div
          class="px-4 sm:px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="text-xl font-bold">Prediction Data</h2>
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="w-32 sm:w-48 px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <button
              id="exportCsv"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600"
              aria-label="Export CSV"
            >
              <span>üìä</span>
            </button>
            <button
              id="copyAll"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600"
              aria-label="Copy All"
            >
              <span>üìã</span>
            </button>
            <button
              id="closeDataTableModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-auto p-4 sm:p-6">
          <table class="w-full text-sm">
            <thead
              id="tableHead"
              class="sticky top-0 bg-slate-100 dark:bg-slate-700"
            >
              <!-- Header will be generated -->
            </thead>
            <tbody id="tableBody" class="font-mono">
              <!-- Body will be generated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div
        class="min-h-screen px-0 sm:px-4 flex items-start sm:items-center justify-center"
      >
        <div
          class="fixed inset-0 bg-black/50 backdrop-blur-sm"
          id="helpBackdrop"
        >
        </div>
        <div
          class="relative w-full sm:max-w-3xl bg-white dark:bg-slate-800 sm:rounded-2xl shadow-2xl max-h-screen sm:max-h-[90vh] overflow-y-auto"
        >
          <div
            class="sticky top-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 sm:px-6 py-4 flex items-center justify-between z-10"
          >
            <h2 class="text-xl font-bold">Help & Documentation</h2>
            <button
              id="closeHelpModal"
              class="min-w-[44px] min-h-[44px] flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700"
              aria-label="Close"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
          <div class="p-4 sm:p-6 space-y-6">
            <!-- Worker Setup -->
            <div>
              <h3
                class="text-lg font-bold mb-3 text-slate-800 dark:text-slate-100"
              >
                Worker Setup
              </h3>
              <div
                class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 text-sm"
              >
                <p class="text-slate-600 dark:text-slate-400 mb-2">
                  The ESNRegression library runs in a Web Worker for
                  non-blocking performance.
                </p>
                <code
                  class="block p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                >Module URL:
                  https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0</code>
              </div>
            </div>

            <!-- Method Calls -->
            <div>
              <h3
                class="text-lg font-bold mb-3 text-slate-800 dark:text-slate-100"
              >
                Method Calls
              </h3>

              <div class="space-y-4">
                <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                  <h4
                    class="font-semibold text-slate-800 dark:text-slate-100 mb-2"
                  >
                    1. Creating a Model
                  </h4>
                  <pre
                    class="p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                  >
const model = new ESNRegression(config);
// config contains all parameters from Configuration Modal</pre>
                </div>

                <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                  <h4
                    class="font-semibold text-slate-800 dark:text-slate-100 mb-2"
                  >
                    2. Online Training (fitOnline)
                  </h4>
                  <pre
                    class="p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                  >
model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// min two coordinates per call (t, t+1), (t+2, t+3), ...
// Trains on consecutive time step pairs
// Returns: { averageLoss, gradientNorm, sampleWeight }</pre>
                </div>

                <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                  <h4
                    class="font-semibold text-slate-800 dark:text-slate-100 mb-2"
                  >
                    3. Prediction
                  </h4>
                  <pre
                    class="p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                  >
const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</pre>
                </div>

                <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                  <h4
                    class="font-semibold text-slate-800 dark:text-slate-100 mb-2"
                  >
                    4. Save/Load
                  </h4>
                  <pre
                    class="p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                  >
const state = model.save(); // Returns serialized model string
model.load(state); // Restores from serialized string</pre>
                </div>

                <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                  <h4
                    class="font-semibold text-slate-800 dark:text-slate-100 mb-2"
                  >
                    5. Model Summary
                  </h4>
                  <pre
                    class="p-3 rounded-lg bg-slate-900 text-emerald-400 text-xs font-mono overflow-x-auto"
                  >
const summary = model.getModelSummary();
// Returns: { nFeatures, sampleCount, ... }</pre>
                </div>
              </div>
            </div>

            <!-- Presets -->
            <div>
              <h3
                class="text-lg font-bold mb-3 text-slate-800 dark:text-slate-100"
              >
                Default Parameters by Preset
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div
                  class="p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
                >
                  <div class="font-semibold text-blue-700 dark:text-blue-300">
                    Start Here/Default
                  </div>
                  <div
                    class="text-xs text-blue-600 dark:text-blue-400 font-mono"
                  >
                    reservoirSize=256, spectralRadius=0.9, leakRate=0.3
                  </div>
                </div>
                <div
                  class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
                >
                  <div class="font-semibold text-slate-700 dark:text-slate-300">
                    Fast
                  </div>
                  <div
                    class="text-xs text-slate-600 dark:text-slate-400 font-mono"
                  >
                    reservoirSize=64, reservoirSparsity=0.95
                  </div>
                </div>
                <div
                  class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
                >
                  <div class="font-semibold text-slate-700 dark:text-slate-300">
                    Balanced
                  </div>
                  <div
                    class="text-xs text-slate-600 dark:text-slate-400 font-mono"
                  >
                    reservoirSize=256, spectralRadius=0.9
                  </div>
                </div>
                <div
                  class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
                >
                  <div class="font-semibold text-slate-700 dark:text-slate-300">
                    Accurate
                  </div>
                  <div
                    class="text-xs text-slate-600 dark:text-slate-400 font-mono"
                  >
                    reservoirSize=512, spectralRadius=0.95, leakRate=0.2
                  </div>
                </div>
                <div
                  class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
                >
                  <div class="font-semibold text-slate-700 dark:text-slate-300">
                    Adaptive
                  </div>
                  <div
                    class="text-xs text-slate-600 dark:text-slate-400 font-mono"
                  >
                    rlsLambda=0.97, spectralRadius=0.85, leakRate=0.5
                  </div>
                </div>
                <div
                  class="p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
                >
                  <div class="font-semibold text-slate-700 dark:text-slate-300">
                    Robust
                  </div>
                  <div
                    class="text-xs text-slate-600 dark:text-slate-400 font-mono"
                  >
                    outlierThreshold=2.0, outlierMinWeight=0.05, l2Lambda=0.01
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-20 lg:bottom-4 left-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"
    >
      <!-- Toasts will be added here -->
    </div>

    <script>
      // ==================== STATE ====================
      const COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const defaultConfig = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const presets = {
        default: { ...defaultConfig },
        fast: {
          ...defaultConfig,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        balanced: {
          ...defaultConfig,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        accurate: {
          ...defaultConfig,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          ...defaultConfig,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          ...defaultConfig,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      let state = {
        config: { ...defaultConfig },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 1,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: {
          active: false,
          x: 0,
          y: 0,
          dataIndex: -1,
          dimIndex: -1,
        },
        moduleUrl:
          "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0",
      };

      let worker = null;
      let requestId = 0;
      let pendingRequests = {};
      let isCancelled = false;

      // ==================== INITIALIZATION ====================
      function init() {
        loadPreferences();
        applyTheme();
        initWorker();
        setupEventListeners();
        renderChart();
        updateUI();
        addLog("info", "ESN Studio initialized");
      }

      function loadPreferences() {
        try {
          const saved = localStorage.getItem("esn_prefs");
          if (saved) {
            const prefs = JSON.parse(saved);
            if (prefs.isDark !== undefined) state.isDark = prefs.isDark;
            if (prefs.vizMode) state.vizMode = prefs.vizMode;
            if (prefs.config) {
              state.config = { ...defaultConfig, ...prefs.config };
            }
            if (prefs.moduleUrl) state.moduleUrl = prefs.moduleUrl;
          }
        } catch (e) {
          console.error("Failed to load preferences:", e);
        }
      }

      function savePreferences() {
        try {
          localStorage.setItem(
            "esn_prefs",
            JSON.stringify({
              isDark: state.isDark,
              vizMode: state.vizMode,
              config: state.config,
              moduleUrl: state.moduleUrl,
            }),
          );
        } catch (e) {
          console.error("Failed to save preferences:", e);
        }
      }

      function applyTheme() {
        if (state.isDark) {
          document.documentElement.classList.add("dark");
          document.getElementById("themeIcon").textContent = "‚òÄÔ∏è";
        } else {
          document.documentElement.classList.remove("dark");
          document.getElementById("themeIcon").textContent = "üåô";
        }
      }

      // ==================== WEB WORKER ====================
      function initWorker() {
        const workerCode = `
                let model = null;
                let ESNRegression = null;
                
                self.onmessage = async function(e) {
                    const { type, data, requestId } = e.data;
                    
                    try {
                        switch (type) {
                            case 'init':
                                const module = await import(data.moduleUrl);
                                ESNRegression = module.ESNRegression;
                                self.postMessage({ type: 'initComplete', requestId });
                                break;
                                
                            case 'createModel':
                                model = new ESNRegression(data.config);
                                self.postMessage({ type: 'modelCreated', requestId });
                                break;
                                
                            case 'train':
                                if (!model) throw new Error('No model exists');
                                const coords = data.coordinates;
                                let totalLoss = 0, totalGrad = 0, lastWeight = 0, count = 0;
                                
                                for (let i = 0; i < coords.length - 1; i += 2) {
                                    if (i + 1 < coords.length) {
                                        const batch = { coordinates: [coords[i], coords[i + 1]] };
                                        const result = model.fitOnline(batch);
                                        totalLoss += result.averageLoss || 0;
                                        totalGrad += result.gradientNorm || 0;
                                        lastWeight = result.sampleWeight || 0;
                                        count++;
                                        
                                        if (count % 10 === 0) {
                                            self.postMessage({
                                                type: 'progress',
                                                requestId,
                                                data: { current: i + 2, total: coords.length, percent: Math.round(((i + 2) / coords.length) * 100) }
                                            });
                                        }
                                    }
                                }
                                
                                const summary = model.getModelSummary();
                                self.postMessage({
                                    type: 'trainComplete',
                                    requestId,
                                    data: {
                                        avgLoss: count > 0 ? totalLoss / count : 0,
                                        gradientNorm: count > 0 ? totalGrad / count : 0,
                                        sampleWeight: lastWeight,
                                        sampleCount: summary.sampleCount,
                                        nFeatures: summary.nFeatures
                                    }
                                });
                                break;
                                
                            case 'predict':
                                if (!model) throw new Error('No model exists');
                                const pred = model.predict(data.steps);
                                self.postMessage({
                                    type: 'predictComplete',
                                    requestId,
                                    data: pred
                                });
                                break;
                                
                            case 'save':
                                if (!model) throw new Error('No model exists');
                                const savedState = model.save();
                                self.postMessage({
                                    type: 'saveComplete',
                                    requestId,
                                    data: { state: savedState }
                                });
                                break;
                                
                            case 'load':
                                if (!ESNRegression) throw new Error('Module not initialized');
                                model = new ESNRegression(data.config || {});
                                model.load(data.state);
                                const loadSummary = model.getModelSummary();
                                self.postMessage({
                                    type: 'loadComplete',
                                    requestId,
                                    data: { sampleCount: loadSummary.sampleCount, nFeatures: loadSummary.nFeatures }
                                });
                                break;
                                
                            case 'getSummary':
                                if (!model) throw new Error('No model exists');
                                const s = model.getModelSummary();
                                self.postMessage({
                                    type: 'summaryComplete',
                                    requestId,
                                    data: s
                                });
                                break;
                                
                            case 'reset':
                                model = null;
                                self.postMessage({ type: 'resetComplete', requestId });
                                break;
                        }
                    } catch (error) {
                        self.postMessage({ type: 'error', requestId, error: error.message });
                    }
                };
            `;

        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        worker.onmessage = handleWorkerMessage;
        worker.onerror = (e) => {
          addLog("error", "Worker error: " + e.message);
          showToast("Worker error occurred", "error");
        };

        sendWorkerMessage("init", { moduleUrl: state.moduleUrl });
      }

      function sendWorkerMessage(type, data) {
        return new Promise((resolve, reject) => {
          const id = ++requestId;
          pendingRequests[id] = { resolve, reject };
          worker.postMessage({ type, data, requestId: id });
        });
      }

      function handleWorkerMessage(e) {
        const { type, requestId: rid, data, error } = e.data;

        if (type === "progress") {
          updateLoadingProgress(
            data.percent,
            `Training... ${data.current}/${data.total}`,
          );
          return;
        }

        if (type === "error") {
          const req = pendingRequests[rid];
          if (req) {
            req.reject(new Error(error));
            delete pendingRequests[rid];
          }
          return;
        }

        const req = pendingRequests[rid];
        if (req) {
          req.resolve(data);
          delete pendingRequests[rid];
        }
      }

      // ==================== UI UPDATES ====================
      function updateUI() {
        // Status badge
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const mobileStatusDot = document.getElementById(
          "mobileStatusDot",
        );
        const mobileStatusText = document.getElementById(
          "mobileStatusText",
        );
        const statusBadge = document.getElementById("statusBadge");

        if (state.modelExists) {
          statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
          statusText.textContent = `${state.sampleCount} steps`;
          mobileStatusDot.className =
            "w-2 h-2 rounded-full bg-emerald-500";
          mobileStatusText.textContent = `${state.sampleCount} steps`;
        } else {
          statusDot.className = "w-2 h-2 rounded-full bg-slate-400";
          statusText.textContent = "No Model";
          mobileStatusDot.className =
            "w-2 h-2 rounded-full bg-slate-400";
          mobileStatusText.textContent = "No Model";
        }
        statusBadge.classList.remove("hidden");
        statusBadge.classList.add("flex");

        // Predict buttons
        const headerPredictBtn = document.getElementById(
          "headerPredictBtn",
        );
        const runPredictBtn = document.getElementById("runPredictBtn");
        const mobilePredictBtn = document.getElementById(
          "mobilePredictBtn",
        );

        if (state.modelExists) {
          headerPredictBtn.classList.remove("hidden");
          headerPredictBtn.classList.add("flex");
          runPredictBtn.disabled = false;
          mobilePredictBtn.disabled = false;
        } else {
          headerPredictBtn.classList.add("hidden");
          headerPredictBtn.classList.remove("flex");
          runPredictBtn.disabled = true;
          mobilePredictBtn.disabled = true;
        }

        // Metrics
        document.getElementById("metricSamples").textContent =
          state.sampleCount || 0;
        document.getElementById("metricLoss").textContent =
          state.metrics.avgLoss !== null
            ? state.metrics.avgLoss.toExponential(3)
            : "-";
        document.getElementById("metricGrad").textContent =
          state.metrics.gradientNorm !== null
            ? state.metrics.gradientNorm.toExponential(3)
            : "-";
        document.getElementById("metricWeight").textContent =
          state.metrics.sampleWeight !== null
            ? state.metrics.sampleWeight.toFixed(3)
            : "-";

        // Visualization tabs
        document.querySelectorAll(".viz-tab").forEach((tab) => {
          if (tab.dataset.viz === state.vizMode) {
            tab.className =
              "viz-tab active min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/25";
          } else {
            tab.className =
              "viz-tab min-w-[44px] min-h-[44px] px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";
          }
        });

        // Dimension selector
        const dimSelector = document.getElementById("dimSelector");
        const dimButtons = document.getElementById("dimButtons");
        if (state.vizMode === "focus" && state.predictions) {
          dimSelector.classList.remove("hidden");
          dimButtons.innerHTML = "";
          for (let i = 0; i < state.nDimensions; i++) {
            const btn = document.createElement("button");
            btn.className = i === state.selectedDim
              ? "min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl font-bold text-sm text-white"
              : "min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl font-semibold text-sm bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";
            if (i === state.selectedDim) {
              btn.style.backgroundColor = COLORS[i % COLORS.length];
            }
            btn.textContent = `D${i + 1}`;
            btn.onclick = () => {
              state.selectedDim = i;
              updateUI();
              renderChart();
            };
            dimButtons.appendChild(btn);
          }
        } else {
          dimSelector.classList.add("hidden");
        }

        // Step selector
        const stepSelector = document.getElementById("stepSelector");
        if (state.vizMode === "snapshot" && state.predictions) {
          stepSelector.classList.remove("hidden");
          document.getElementById("stepInput").value =
            state.selectedStep;
          document.getElementById("stepMax").textContent =
            `/ ${state.predictions.predictions.length}`;
        } else {
          stepSelector.classList.add("hidden");
        }

        // Stats bar
        const statsBar = document.getElementById("statsBar");
        if (state.vizMode === "focus" && state.predictions) {
          statsBar.classList.remove("hidden");
          updateStats();
        } else {
          statsBar.classList.add("hidden");
        }

        // Chart controls
        const hasData = state.predictions &&
          state.predictions.predictions.length > 0;
        document.getElementById("chartControls").classList.toggle(
          "hidden",
          !hasData,
        );
        document.getElementById("exportControls").classList.toggle(
          "hidden",
          !hasData,
        );
        document.getElementById("emptyState").classList.toggle(
          "hidden",
          hasData,
        );

        // Zoom badge
        const zoomBadge = document.getElementById("zoomBadge");
        if (state.zoom.level !== 1 && hasData) {
          zoomBadge.classList.remove("hidden");
          zoomBadge.textContent = `${
            Math.round(state.zoom.level * 100)
          }%`;
        } else {
          zoomBadge.classList.add("hidden");
        }

        renderLogs();
      }

      function updateStats() {
        if (!state.predictions) return;
        const preds = state.predictions.predictions.map((p) =>
          p[state.selectedDim]
        );
        const lower = state.predictions.lowerBounds.map((l) =>
          l[state.selectedDim]
        );
        const upper = state.predictions.upperBounds.map((u) =>
          u[state.selectedDim]
        );

        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const first = preds[0];
        const trend = final - first;

        const avgSpread =
          upper.map((u, i) => u - lower[i]).reduce((a, b) => a + b, 0) /
          upper.length;
        const avgValue = Math.abs(mean);
        const conf = avgValue > 0
          ? Math.max(0, 100 - (avgSpread / avgValue * 50))
          : 0;

        document.getElementById("statMin").textContent = min.toFixed(3);
        document.getElementById("statMax").textContent = max.toFixed(3);
        document.getElementById("statMean").textContent = mean.toFixed(
          3,
        );
        document.getElementById("statFinal").textContent = final
          .toFixed(3);

        const trendEl = document.getElementById("statTrend");
        if (trend >= 0) {
          trendEl.innerHTML =
            `<span class="text-emerald-500">‚Üë</span> ${
              Math.abs(trend).toFixed(3)
            }`;
        } else {
          trendEl.innerHTML = `<span class="text-red-500">‚Üì</span> ${
            Math.abs(trend).toFixed(3)
          }`;
        }

        document.getElementById("statConf").textContent =
          conf.toFixed(1) + "%";
      }

      // ==================== CHART RENDERING ====================
      function renderChart() {
        const canvas = document.getElementById("chartCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        canvas.width = rect.width * dpr;
        canvas.height = 400 * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = "400px";
        ctx.scale(dpr, dpr);

        const width = rect.width;
        const height = 400;
        const isDark = state.isDark;

        // Clear
        ctx.fillStyle = isDark ? "#1e293b" : "#ffffff";
        ctx.fillRect(0, 0, width, height);

        if (
          !state.predictions || !state.predictions.predictions.length
        ) return;

        const predictions = state.predictions.predictions;
        const lowerBounds = state.predictions.lowerBounds;
        const upperBounds = state.predictions.upperBounds;

        const padding = { top: 40, right: 20, bottom: 50, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Calculate visible range based on zoom
        const totalSteps = predictions.length;
        const visibleCount = Math.ceil(totalSteps / state.zoom.level);
        const maxOffset = totalSteps - visibleCount;
        state.zoom.visibleStart = Math.min(
          Math.max(0, state.zoom.offsetX),
          maxOffset,
        );
        state.zoom.visibleCount = visibleCount;

        const startIdx = Math.floor(state.zoom.visibleStart);
        const endIdx = Math.min(
          startIdx + visibleCount + 1,
          totalSteps,
        );

        switch (state.vizMode) {
          case "grid":
            renderGridView(
              ctx,
              predictions,
              lowerBounds,
              upperBounds,
              startIdx,
              endIdx,
              padding,
              chartWidth,
              chartHeight,
              isDark,
            );
            break;
          case "focus":
            renderFocusView(
              ctx,
              predictions,
              lowerBounds,
              upperBounds,
              startIdx,
              endIdx,
              padding,
              chartWidth,
              chartHeight,
              isDark,
            );
            break;
          case "heatmap":
            renderHeatmap(
              ctx,
              predictions,
              startIdx,
              endIdx,
              padding,
              chartWidth,
              chartHeight,
              isDark,
            );
            break;
          case "uncertainty":
            renderUncertainty(
              ctx,
              predictions,
              lowerBounds,
              upperBounds,
              startIdx,
              endIdx,
              padding,
              chartWidth,
              chartHeight,
              isDark,
            );
            break;
          case "snapshot":
            renderSnapshot(
              ctx,
              predictions,
              lowerBounds,
              upperBounds,
              padding,
              chartWidth,
              chartHeight,
              isDark,
            );
            break;
        }
      }

      function renderGridView(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        startIdx,
        endIdx,
        padding,
        chartWidth,
        chartHeight,
        isDark,
      ) {
        const nDims = state.nDimensions;
        const cols = Math.min(nDims, Math.ceil(Math.sqrt(nDims)));
        const rows = Math.ceil(nDims / cols);
        const cellWidth = chartWidth / cols;
        const cellHeight = chartHeight / rows;
        const cellPadding = 10;

        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = padding.left + col * cellWidth + cellPadding;
          const y = padding.top + row * cellHeight + cellPadding;
          const w = cellWidth - cellPadding * 2;
          const h = cellHeight - cellPadding * 2;

          const color = COLORS[d % COLORS.length];
          const data = predictions.slice(startIdx, endIdx).map((p) =>
            p[d]
          );
          const lower = lowerBounds.slice(startIdx, endIdx).map((l) =>
            l[d]
          );
          const upper = upperBounds.slice(startIdx, endIdx).map((u) =>
            u[d]
          );

          const allVals = [...data, ...lower, ...upper];
          const min = Math.min(...allVals);
          const max = Math.max(...allVals);
          const range = max - min || 1;

          // Background
          ctx.fillStyle = isDark ? "#334155" : "#f8fafc";
          ctx.fillRect(x, y, w, h);

          // Confidence band
          ctx.fillStyle = color + "20";
          ctx.beginPath();
          for (let i = 0; i < data.length; i++) {
            const px = x + (i / (data.length - 1)) * w;
            const py = y + h - ((upper[i] - min) / range) * h;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          for (let i = data.length - 1; i >= 0; i--) {
            const px = x + (i / (data.length - 1)) * w;
            const py = y + h - ((lower[i] - min) / range) * h;
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < data.length; i++) {
            const px = x + (i / (data.length - 1)) * w;
            const py = y + h - ((data[i] - min) / range) * h;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();

          // Label
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "bold 11px Inter";
          ctx.fillText(`D${d + 1}`, x + 5, y + 15);
        }
      }

      function renderFocusView(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        startIdx,
        endIdx,
        padding,
        chartWidth,
        chartHeight,
        isDark,
      ) {
        const d = state.selectedDim;
        const color = COLORS[d % COLORS.length];
        const data = predictions.slice(startIdx, endIdx).map((p) =>
          p[d]
        );
        const lower = lowerBounds.slice(startIdx, endIdx).map((l) =>
          l[d]
        );
        const upper = upperBounds.slice(startIdx, endIdx).map((u) =>
          u[d]
        );

        const allVals = [...data, ...lower, ...upper];
        const min = Math.min(...allVals);
        const max = Math.max(...allVals);
        const range = max - min || 1;

        const toX = (i) =>
          padding.left + (i / (data.length - 1)) * chartWidth;
        const toY = (v) =>
          padding.top + chartHeight - ((v - min) / range) * chartHeight;

        // Grid
        ctx.strokeStyle = isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();

          const val = max - (i / 5) * range;
          ctx.fillStyle = isDark ? "#64748b" : "#94a3b8";
          ctx.font = "11px JetBrains Mono";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 10, y + 4);
        }

        // X axis labels
        ctx.textAlign = "center";
        const stepInterval = Math.ceil(data.length / 8);
        for (let i = 0; i < data.length; i += stepInterval) {
          const x = toX(i);
          ctx.fillText(
            (startIdx + i + 1).toString(),
            x,
            padding.top + chartHeight + 20,
          );
        }

        // Confidence band
        ctx.fillStyle = color + "20";
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const px = toX(i);
          const py = toY(upper[i]);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        for (let i = data.length - 1; i >= 0; i--) {
          const px = toX(i);
          const py = toY(lower[i]);
          ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Lower bound line
        ctx.strokeStyle = color + "60";
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const px = toX(i);
          const py = toY(lower[i]);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Upper bound line
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const px = toX(i);
          const py = toY(upper[i]);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // Main line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let i = 0; i < data.length; i++) {
          const px = toX(i);
          const py = toY(data[i]);
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Hover point
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const i = state.hover.dataIndex - startIdx;
          if (i >= 0 && i < data.length) {
            const px = toX(i);
            const py = toY(data[i]);

            // Crosshair
            ctx.strokeStyle = isDark ? "#475569" : "#cbd5e1";
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(px, padding.top);
            ctx.lineTo(px, padding.top + chartHeight);
            ctx.moveTo(padding.left, py);
            ctx.lineTo(padding.left + chartWidth, py);
            ctx.stroke();
            ctx.setLineDash([]);

            // Point with glow
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(px, py, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(px, py, 3, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        // Title
        ctx.fillStyle = isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px Inter";
        ctx.textAlign = "left";
        ctx.fillText(`Dimension ${d + 1}`, padding.left, 25);
      }

      function renderHeatmap(
        ctx,
        predictions,
        startIdx,
        endIdx,
        padding,
        chartWidth,
        chartHeight,
        isDark,
      ) {
        const nDims = state.nDimensions;
        const data = predictions.slice(startIdx, endIdx);
        const steps = data.length;

        // Get global min/max
        let min = Infinity, max = -Infinity;
        for (const row of data) {
          for (const v of row) {
            min = Math.min(min, v);
            max = Math.max(max, v);
          }
        }
        const range = max - min || 1;

        const cellWidth = chartWidth / steps;
        const cellHeight = chartHeight / nDims;

        for (let s = 0; s < steps; s++) {
          for (let d = 0; d < nDims; d++) {
            const v = data[s][d];
            const norm = (v - min) / range;

            // Color gradient: blue -> white -> red
            let r, g, b;
            if (norm < 0.5) {
              const t = norm * 2;
              r = Math.round(59 + (255 - 59) * t);
              g = Math.round(130 + (255 - 130) * t);
              b = Math.round(246 + (255 - 246) * t);
            } else {
              const t = (norm - 0.5) * 2;
              r = Math.round(255 - (255 - 239) * t);
              g = Math.round(255 - (255 - 68) * t);
              b = Math.round(255 - (255 - 68) * t);
            }

            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(
              padding.left + s * cellWidth,
              padding.top + d * cellHeight,
              cellWidth + 0.5,
              cellHeight + 0.5,
            );
          }
        }

        // Axis labels
        ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px Inter";
        ctx.textAlign = "right";
        for (let d = 0; d < nDims; d++) {
          ctx.fillText(
            `D${d + 1}`,
            padding.left - 10,
            padding.top + d * cellHeight + cellHeight / 2 + 4,
          );
        }

        ctx.textAlign = "center";
        const labelInterval = Math.ceil(steps / 10);
        for (let s = 0; s < steps; s += labelInterval) {
          ctx.fillText(
            (startIdx + s + 1).toString(),
            padding.left + s * cellWidth + cellWidth / 2,
            padding.top + chartHeight + 20,
          );
        }

        // Legend
        const legendX = padding.left + chartWidth - 100;
        const legendY = padding.top - 25;
        const legendWidth = 100;
        const legendHeight = 12;

        const gradient = ctx.createLinearGradient(
          legendX,
          0,
          legendX + legendWidth,
          0,
        );
        gradient.addColorStop(0, "#3B82F6");
        gradient.addColorStop(0.5, "#ffffff");
        gradient.addColorStop(1, "#EF4444");

        ctx.fillStyle = gradient;
        ctx.fillRect(legendX, legendY, legendWidth, legendHeight);

        ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
        ctx.font = "10px JetBrains Mono";
        ctx.textAlign = "left";
        ctx.fillText(
          min.toFixed(1),
          legendX,
          legendY + legendHeight + 12,
        );
        ctx.textAlign = "right";
        ctx.fillText(
          max.toFixed(1),
          legendX + legendWidth,
          legendY + legendHeight + 12,
        );
      }

      function renderUncertainty(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        startIdx,
        endIdx,
        padding,
        chartWidth,
        chartHeight,
        isDark,
      ) {
        const nDims = state.nDimensions;
        const data = predictions.slice(startIdx, endIdx);
        const lower = lowerBounds.slice(startIdx, endIdx);
        const upper = upperBounds.slice(startIdx, endIdx);

        // Calculate spreads
        const spreads = data.map((row, i) =>
          row.map((v, d) => upper[i][d] - lower[i][d])
        );

        let maxSpread = 0;
        for (const row of spreads) {
          maxSpread = Math.max(maxSpread, ...row);
        }

        const toX = (i) =>
          padding.left + (i / (data.length - 1)) * chartWidth;
        const toY = (v) =>
          padding.top + chartHeight - (v / maxSpread) * chartHeight;

        // Grid
        ctx.strokeStyle = isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();
        }

        // Draw lines for each dimension
        for (let d = 0; d < nDims; d++) {
          const color = COLORS[d % COLORS.length];
          const dimSpreads = spreads.map((row) => row[d]);

          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < dimSpreads.length; i++) {
            const px = toX(i);
            const py = toY(dimSpreads[i]);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();
        }

        // Legend
        ctx.font = "11px Inter";
        for (let d = 0; d < Math.min(nDims, 5); d++) {
          const color = COLORS[d % COLORS.length];
          const x = padding.left + d * 60;
          const y = padding.top - 15;

          ctx.fillStyle = color;
          ctx.fillRect(x, y, 12, 12);
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.fillText(`D${d + 1}`, x + 16, y + 10);
        }

        // Y axis label
        ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px JetBrains Mono";
        ctx.textAlign = "right";
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          const val = maxSpread * (1 - i / 5);
          ctx.fillText(val.toFixed(2), padding.left - 10, y + 4);
        }

        // Title
        ctx.fillStyle = isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px Inter";
        ctx.textAlign = "left";
        ctx.fillText("Confidence Interval Spread", padding.left, 25);
      }

      function renderSnapshot(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        padding,
        chartWidth,
        chartHeight,
        isDark,
      ) {
        const stepIdx = Math.min(
          state.selectedStep - 1,
          predictions.length - 1,
        );
        const data = predictions[stepIdx];
        const lower = lowerBounds[stepIdx];
        const upper = upperBounds[stepIdx];
        const nDims = state.nDimensions;

        const allVals = [...data, ...lower, ...upper];
        const min = Math.min(...allVals, 0);
        const max = Math.max(...allVals);
        const range = max - min || 1;

        const barWidth = chartWidth / nDims * 0.6;
        const gap = chartWidth / nDims * 0.4;

        const toY = (v) =>
          padding.top + chartHeight - ((v - min) / range) * chartHeight;
        const zeroY = toY(0);

        // Grid
        ctx.strokeStyle = isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();
        }

        // Zero line
        ctx.strokeStyle = isDark ? "#64748b" : "#94a3b8";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding.left, zeroY);
        ctx.lineTo(padding.left + chartWidth, zeroY);
        ctx.stroke();

        // Bars
        for (let d = 0; d < nDims; d++) {
          const color = COLORS[d % COLORS.length];
          const x = padding.left + d * (barWidth + gap) + gap / 2;
          const y = toY(data[d]);
          const h = zeroY - y;

          // Error bar
          ctx.strokeStyle = isDark ? "#64748b" : "#94a3b8";
          ctx.lineWidth = 2;
          const centerX = x + barWidth / 2;
          ctx.beginPath();
          ctx.moveTo(centerX, toY(lower[d]));
          ctx.lineTo(centerX, toY(upper[d]));
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(centerX - 5, toY(lower[d]));
          ctx.lineTo(centerX + 5, toY(lower[d]));
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(centerX - 5, toY(upper[d]));
          ctx.lineTo(centerX + 5, toY(upper[d]));
          ctx.stroke();

          // Bar
          ctx.fillStyle = color;
          if (h >= 0) {
            ctx.fillRect(x, y, barWidth, h);
          } else {
            ctx.fillRect(x, zeroY, barWidth, -h);
          }

          // Label
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "bold 11px Inter";
          ctx.textAlign = "center";
          ctx.fillText(
            `D${d + 1}`,
            x + barWidth / 2,
            padding.top + chartHeight + 20,
          );

          // Value
          ctx.font = "10px JetBrains Mono";
          ctx.fillText(
            data[d].toFixed(2),
            x + barWidth / 2,
            Math.min(y, zeroY) - 8,
          );
        }

        // Y axis labels
        ctx.textAlign = "right";
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          const val = max - (i / 5) * range;
          ctx.fillText(val.toFixed(2), padding.left - 10, y + 4);
        }

        // Title
        ctx.fillStyle = isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px Inter";
        ctx.textAlign = "left";
        ctx.fillText(`Step ${state.selectedStep}`, padding.left, 25);
      }

      // ==================== LOGGING ====================
      function addLog(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        state.logs.unshift({ type, message, timestamp });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = document.getElementById("logContainer");
        const filter = document.getElementById("logFilter").value;
        const search = document.getElementById("logSearch").value
          .toLowerCase();

        const filtered = state.logs
          .filter((l) => filter === "all" || l.type === filter)
          .filter((l) =>
            !search || l.message.toLowerCase().includes(search)
          )
          .slice(0, 50);

        container.innerHTML = filtered.map((log) => {
          const colors = {
            info:
              "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
            success:
              "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
            warning:
              "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
            error:
              "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
          };
          return `
                    <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50 text-xs">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${
            colors[log.type]
          }">${log.type}</span>
                            <span class="text-slate-400 font-mono">${log.timestamp}</span>
                        </div>
                        <div class="text-slate-600 dark:text-slate-400">${log.message}</div>
                    </div>
                `;
        }).join("");
      }

      // ==================== TOAST ====================
      function showToast(message, type = "info") {
        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        const toast = document.createElement("div");
        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between gap-3 pointer-events-auto`;
        toast.innerHTML = `
                <span>${message}</span>
                <button class="min-w-[24px] min-h-[24px] text-white/80 hover:text-white" aria-label="Close">‚úñÔ∏è</button>
            `;

        toast.querySelector("button").onclick = () => toast.remove();

        document.getElementById("toastContainer").appendChild(toast);

        const duration = type === "error" ? 6000 : 4000;
        setTimeout(() => toast.remove(), duration);
      }

      // ==================== LOADING ====================
      function showLoading(text = "Processing...") {
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingProgress").style.width = "0%";
        document.getElementById("loadingPercent").textContent = "0%";
        document.getElementById("loadingOverlay").classList.remove(
          "hidden",
        );
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add(
          "hidden",
        );
      }

      function updateLoadingProgress(percent, text) {
        document.getElementById("loadingProgress").style.width =
          percent + "%";
        document.getElementById("loadingPercent").textContent =
          percent + "%";
        if (text) {
          document.getElementById("loadingText").textContent = text;
        }
      }

      // ==================== MODEL OPERATIONS ====================
      async function createModel(config) {
        try {
          showLoading("Creating model...");
          await sendWorkerMessage("createModel", { config });
          state.config = config;
          state.modelExists = true;
          state.sampleCount = 0;
          state.nDimensions = 0;
          state.predictions = null;
          addLog("success", "Model created successfully");
          showToast("Model created", "success");
          savePreferences();
          updateUI();
        } catch (e) {
          addLog("error", "Failed to create model: " + e.message);
          showToast("Failed to create model", "error");
        } finally {
          hideLoading();
        }
      }

      async function trainModel(coordinates) {
        if (!state.modelExists) {
          showToast("No model exists", "error");
          return;
        }

        try {
          showLoading("Training...");
          const result = await sendWorkerMessage("train", {
            coordinates,
          });
          state.sampleCount = result.sampleCount;
          state.nDimensions = result.nFeatures;
          state.metrics = {
            avgLoss: result.avgLoss,
            gradientNorm: result.gradientNorm,
            sampleWeight: result.sampleWeight,
          };
          addLog("success", `Trained on ${coordinates.length} samples`);
          showToast("Training complete", "success");
          updateUI();
        } catch (e) {
          addLog("error", "Training failed: " + e.message);
          showToast("Training failed", "error");
        } finally {
          hideLoading();
        }
      }

      async function runPrediction() {
        if (!state.modelExists) {
          showToast("No model exists", "error");
          return;
        }

        const steps =
          parseInt(document.getElementById("futureSteps").value) || 100;

        try {
          showLoading("Predicting...");
          const result = await sendWorkerMessage("predict", { steps });
          state.predictions = result;
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: steps,
          };
          state.selectedStep = 1;
          addLog("success", `Generated ${steps} predictions`);
          showToast("Prediction complete", "success");
          updateUI();
          renderChart();
        } catch (e) {
          addLog("error", "Prediction failed: " + e.message);
          showToast("Prediction failed", "error");
        } finally {
          hideLoading();
        }
      }

      // ==================== DATA GENERATION ====================
      function generateSyntheticData(
        seed,
        dims,
        steps,
        noise,
        outlierRate,
        difficulty,
      ) {
        const random = (s) => {
          const x = Math.sin(s++) * 10000;
          return x - Math.floor(x);
        };

        let s = seed;
        const data = [];
        const freq = difficulty === "easy"
          ? 0.05
          : difficulty === "medium"
          ? 0.1
          : 0.2;
        const amp = difficulty === "easy"
          ? 1
          : difficulty === "medium"
          ? 2
          : 3;

        for (let t = 0; t < steps; t++) {
          const row = [];
          for (let d = 0; d < dims; d++) {
            let val = amp * Math.sin(freq * t * (d + 1) + d) +
              0.5 * Math.cos(freq * 2 * t + d * 0.5);
            val += (random(s++) - 0.5) * noise * 2;

            if (random(s++) < outlierRate) {
              val += (random(s++) - 0.5) * 10;
            }

            row.push(val);
          }
          data.push(row);
        }

        return data;
      }

      // ==================== MODAL HELPERS ====================
      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
        document.body.style.overflow = "";
      }

      // ==================== EVENT LISTENERS ====================
      function setupEventListeners() {
        // Theme toggle
        document.getElementById("themeToggle").onclick = () => {
          state.isDark = !state.isDark;
          applyTheme();
          savePreferences();
          renderChart();
        };

        // Menu
        document.getElementById("menuBtn").onclick = () =>
          openModal("menuOverlay");
        document.getElementById("closeMenu").onclick = () =>
          closeModal("menuOverlay");
        document.getElementById("menuBackdrop").onclick = () =>
          closeModal("menuOverlay");

        // Config modal
        document.getElementById("configBtn").onclick = () => {
          closeModal("menuOverlay");
          loadConfigToForm();
          openModal("configModal");
        };
        document.getElementById("menuConfigBtn").onclick = () => {
          closeModal("menuOverlay");
          loadConfigToForm();
          openModal("configModal");
        };
        document.getElementById("closeConfigModal").onclick = () =>
          closeModal("configModal");
        document.getElementById("configBackdrop").onclick = () =>
          closeModal("configModal");
        document.getElementById("cancelConfig").onclick = () =>
          closeModal("configModal");

        // Config toggles
        document.querySelectorAll(".config-toggle").forEach(
          (toggle) => {
            toggle.onclick = () => {
              const section = toggle.nextElementSibling;
              const chevron = toggle.querySelector("span:last-child");
              section.classList.toggle("hidden");
              chevron.textContent = section.classList.contains("hidden")
                ? "‚ñ∂"
                : "‚ñº";
            };
          },
        );

        // Toggle buttons
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.onclick = () => {
            const isOn = btn.dataset.value === "true";
            btn.dataset.value = (!isOn).toString();
            if (!isOn) {
              btn.className =
                "toggle-btn w-12 h-7 rounded-full bg-blue-500 relative";
              btn.querySelector("span").className =
                "absolute w-5 h-5 bg-white rounded-full top-1 right-1 shadow";
            } else {
              btn.className =
                "toggle-btn w-12 h-7 rounded-full bg-slate-300 dark:bg-slate-600 relative";
              btn.querySelector("span").className =
                "absolute w-5 h-5 bg-white rounded-full top-1 left-1 shadow";
            }
          };
        });

        // Presets
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.onclick = () => {
            const preset = presets[btn.dataset.preset];
            if (preset) {
              state.config = { ...preset };
              loadConfigToForm();
              document.querySelectorAll(".preset-btn").forEach((b) => {
                b.className = b === btn
                  ? "preset-btn active min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400"
                  : "preset-btn min-h-[40px] px-4 py-2 rounded-xl text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600";
              });
            }
          };
        });

        // Create model
        document.getElementById("createModel").onclick = async () => {
          const config = getConfigFromForm();
          closeModal("configModal");
          await createModel(config);
        };

        document.getElementById("resetDefaults").onclick = () => {
          state.config = { ...defaultConfig };
          loadConfigToForm();
        };

        document.getElementById("resetAll").onclick = async () => {
          state.config = { ...defaultConfig };
          state.modelExists = false;
          state.predictions = null;
          state.sampleCount = 0;
          state.nDimensions = 0;
          await sendWorkerMessage("reset", {});
          loadConfigToForm();
          closeModal("configModal");
          updateUI();
          renderChart();
          showToast("Reset complete", "info");
        };

        // Viz tabs
        document.querySelectorAll(".viz-tab").forEach((tab) => {
          tab.onclick = () => {
            state.vizMode = tab.dataset.viz;
            savePreferences();
            updateUI();
            renderChart();
          };
        });

        // Prediction buttons
        document.getElementById("runPredictBtn").onclick =
          runPrediction;
        document.getElementById("headerPredictBtn").onclick =
          runPrediction;
        document.getElementById("mobilePredictBtn").onclick =
          runPrediction;

        // Step input
        document.getElementById("stepInput").onchange = (e) => {
          state.selectedStep = Math.max(
            1,
            parseInt(e.target.value) || 1,
          );
          if (state.predictions) {
            state.selectedStep = Math.min(
              state.selectedStep,
              state.predictions.predictions.length,
            );
          }
          renderChart();
        };

        // Zoom controls
        document.getElementById("zoomIn").onclick = () => {
          state.zoom.level = Math.min(state.zoom.level * 1.5, 10);
          updateUI();
          renderChart();
        };

        document.getElementById("zoomOut").onclick = () => {
          state.zoom.level = Math.max(state.zoom.level / 1.5, 1);
          if (state.zoom.level === 1) state.zoom.offsetX = 0;
          updateUI();
          renderChart();
        };

        document.getElementById("zoomReset").onclick = () => {
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: 0,
          };
          updateUI();
          renderChart();
        };

        // Chart interaction
        const canvas = document.getElementById("chartCanvas");

        canvas.onmousemove = (e) => {
          if (!state.predictions) return;
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const padding = { left: 60, right: 20, top: 40, bottom: 50 };
          const chartWidth = rect.width - padding.left - padding.right;

          if (x >= padding.left && x <= rect.width - padding.right) {
            const relX = (x - padding.left) / chartWidth;
            const totalSteps = state.predictions.predictions.length;
            const visibleCount = Math.ceil(
              totalSteps / state.zoom.level,
            );
            const dataIndex = Math.floor(
              state.zoom.visibleStart + relX * visibleCount,
            );

            if (dataIndex >= 0 && dataIndex < totalSteps) {
              state.hover = {
                active: true,
                x: e.clientX,
                y: e.clientY,
                dataIndex,
                dimIndex: state.selectedDim,
              };
              updateTooltip();
              renderChart();
            }
          }
        };

        canvas.onmouseleave = () => {
          state.hover.active = false;
          document.getElementById("chartTooltip").classList.add(
            "hidden",
          );
          renderChart();
        };

        // Touch support
        let touchStartX = 0;
        let touchStartOffset = 0;

        canvas.ontouchstart = (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartOffset = state.zoom.offsetX;
        };

        canvas.ontouchmove = (e) => {
          if (!state.predictions || state.zoom.level <= 1) return;
          e.preventDefault();
          const dx = e.touches[0].clientX - touchStartX;
          const rect = canvas.getBoundingClientRect();
          const totalSteps = state.predictions.predictions.length;
          const visibleCount = Math.ceil(totalSteps / state.zoom.level);
          const stepsPerPixel = visibleCount / rect.width;

          state.zoom.offsetX = Math.max(
            0,
            Math.min(
              totalSteps - visibleCount,
              touchStartOffset - dx * stepsPerPixel,
            ),
          );
          renderChart();
        };

        // Wheel zoom
        canvas.onwheel = (e) => {
          if (!state.predictions) return;
          e.preventDefault();

          if (e.deltaY < 0) {
            state.zoom.level = Math.min(state.zoom.level * 1.1, 10);
          } else {
            state.zoom.level = Math.max(state.zoom.level / 1.1, 1);
          }

          if (state.zoom.level === 1) state.zoom.offsetX = 0;
          updateUI();
          renderChart();
        };

        // Export buttons
        document.getElementById("savePng").onclick = () => {
          const canvas = document.getElementById("chartCanvas");
          const link = document.createElement("a");
          link.download = "esn-chart.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
          showToast("Chart saved as PNG", "success");
        };

        document.getElementById("copyChart").onclick = async () => {
          try {
            const canvas = document.getElementById("chartCanvas");
            const blob = await new Promise((resolve) =>
              canvas.toBlob(resolve, "image/png")
            );
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob }),
            ]);
            showToast("Chart copied to clipboard", "success");
          } catch (e) {
            showToast("Failed to copy chart", "error");
          }
        };

        // Mobile panel
        document.getElementById("mobilePanelBtn").onclick = () =>
          openModal("mobilePanelOverlay");
        document.getElementById("closeMobilePanel").onclick = () =>
          closeModal("mobilePanelOverlay");
        document.getElementById("mobilePanelBackdrop").onclick = () =>
          closeModal("mobilePanelOverlay");

        // Empty state buttons
        document.getElementById("startDefaultsBtn").onclick =
          async () => {
            await createModel(defaultConfig);
          };

        document.getElementById("demoBtn").onclick = async () => {
          await createModel(defaultConfig);
          const data = generateSyntheticData(
            42,
            3,
            200,
            0.1,
            0.02,
            "medium",
          );
          await trainModel(data);
          await runPrediction();
        };

        document.getElementById("loadModelBtn").onclick = () => {
          openModal("saveLoadModal");
        };

        // Menu items
        document.getElementById("menuUploadBtn").onclick = () => {
          closeModal("menuOverlay");
          openModal("uploadModal");
        };

        document.getElementById("menuInsertBtn").onclick = () => {
          closeModal("menuOverlay");
          openModal("insertModal");
        };

        document.getElementById("menuSaveLoadBtn").onclick = () => {
          closeModal("menuOverlay");
          renderSavedModelsList();
          openModal("saveLoadModal");
        };

        document.getElementById("menuRandomBtn").onclick = () => {
          closeModal("menuOverlay");
          openModal("randomModal");
        };

        document.getElementById("menuSettingsBtn").onclick = () => {
          closeModal("menuOverlay");
          document.getElementById("moduleUrl").value = state.moduleUrl;
          openModal("settingsModal");
        };

        document.getElementById("menuDataTableBtn").onclick = () => {
          closeModal("menuOverlay");
          renderDataTable();
          openModal("dataTableModal");
        };

        document.getElementById("menuHelpBtn").onclick = () => {
          closeModal("menuOverlay");
          openModal("helpModal");
        };

        // Upload modal
        document.getElementById("closeUploadModal").onclick = () =>
          closeModal("uploadModal");
        document.getElementById("uploadBackdrop").onclick = () =>
          closeModal("uploadModal");
        document.getElementById("cancelUpload").onclick = () =>
          closeModal("uploadModal");

        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => {
          e.preventDefault();
          dropZone.classList.add(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-blue-900/10",
          );
        };
        dropZone.ondragleave = () => {
          dropZone.classList.remove(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-blue-900/10",
          );
        };
        dropZone.ondrop = (e) => {
          e.preventDefault();
          dropZone.classList.remove(
            "border-blue-500",
            "bg-blue-50",
            "dark:bg-blue-900/10",
          );
          const file = e.dataTransfer.files[0];
          if (file) handleUploadFile(file);
        };

        fileInput.onchange = (e) => {
          if (e.target.files[0]) handleUploadFile(e.target.files[0]);
        };

        document.getElementById("validateUpload").onclick =
          validateUploadData;
        document.getElementById("applyTrain").onclick = applyUploadData;

        document.getElementById("copyExample").onclick = () => {
          navigator.clipboard.writeText(
            '{\n  "coordinates": [\n    [1.0, 2.0, 3.0],\n    [1.1, 2.1, 3.1],\n    [1.2, 2.2, 3.2]\n  ]\n}',
          );
          showToast("Example copied", "success");
        };

        // Insert modal
        document.getElementById("closeInsertModal").onclick = () =>
          closeModal("insertModal");
        document.getElementById("insertBackdrop").onclick = () =>
          closeModal("insertModal");
        document.getElementById("cancelInsert").onclick = () =>
          closeModal("insertModal");

        document.getElementById("genTemplate").onclick = () => {
          const dims = state.nDimensions || 3;
          const template = {
            coordinates: [Array(dims).fill(0), Array(dims).fill(0)],
          };
          document.getElementById("insertJson").value = JSON.stringify(
            template,
            null,
            2,
          );
        };

        document.getElementById("doInsert").onclick = async () => {
          try {
            const data = JSON.parse(
              document.getElementById("insertJson").value,
            );
            if (!data.coordinates || data.coordinates.length < 2) {
              throw new Error("Need at least 2 coordinates");
            }
            closeModal("insertModal");
            await trainModel(data.coordinates);
          } catch (e) {
            document.getElementById("insertFeedback").className =
              "p-3 rounded-xl text-sm bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400";
            document.getElementById("insertFeedback").textContent =
              e.message;
            document.getElementById("insertFeedback").classList.remove(
              "hidden",
            );
          }
        };

        // Save/Load modal
        document.getElementById("closeSaveLoadModal").onclick = () =>
          closeModal("saveLoadModal");
        document.getElementById("saveLoadBackdrop").onclick = () =>
          closeModal("saveLoadModal");

        document.getElementById("downloadModel").onclick = async () => {
          if (!state.modelExists) {
            showToast("No model to save", "error");
            return;
          }
          try {
            const result = await sendWorkerMessage("save", {});
            const blob = new Blob([
              JSON.stringify({
                state: result.state,
                config: state.config,
              }),
            ], { type: "application/json" });
            const link = document.createElement("a");
            link.download = `esn-model-${Date.now()}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("Model downloaded", "success");
          } catch (e) {
            showToast("Failed to save model", "error");
          }
        };

        document.getElementById("saveToStorage").onclick = async () => {
          if (!state.modelExists) {
            showToast("No model to save", "error");
            return;
          }
          const name = prompt("Model name:", `Model ${Date.now()}`);
          if (!name) return;

          try {
            const result = await sendWorkerMessage("save", {});
            const saved = JSON.parse(
              localStorage.getItem("esn_saved_models") || "{}",
            );
            saved[name] = {
              state: result.state,
              config: state.config,
              dims: state.nDimensions,
              samples: state.sampleCount,
            };
            localStorage.setItem(
              "esn_saved_models",
              JSON.stringify(saved),
            );
            renderSavedModelsList();
            showToast("Model saved to browser", "success");
          } catch (e) {
            showToast("Failed to save model", "error");
          }
        };

        const loadDropZone = document.getElementById("loadDropZone");
        const loadFileInput = document.getElementById("loadFileInput");

        loadDropZone.onclick = () => loadFileInput.click();
        loadFileInput.onchange = (e) => {
          if (e.target.files[0]) handleLoadFile(e.target.files[0]);
        };

        document.getElementById("clearAllSaved").onclick = () => {
          if (confirm("Clear all saved models?")) {
            localStorage.removeItem("esn_saved_models");
            renderSavedModelsList();
            showToast("Saved models cleared", "info");
          }
        };

        // Random test modal
        document.getElementById("closeRandomModal").onclick = () =>
          closeModal("randomModal");
        document.getElementById("randomBackdrop").onclick = () =>
          closeModal("randomModal");
        document.getElementById("cancelRandom").onclick = () =>
          closeModal("randomModal");

        document.getElementById("generateRun").onclick = async () => {
          const seed =
            parseInt(document.getElementById("testSeed").value) || 42;
          const dims =
            parseInt(document.getElementById("testDims").value) || 3;
          const steps =
            parseInt(document.getElementById("testSteps").value) || 200;
          const noise =
            parseFloat(document.getElementById("testNoise").value) ||
            0.1;
          const outliers =
            parseFloat(document.getElementById("testOutliers").value) ||
            0.02;
          const difficulty =
            document.getElementById("testDifficulty").value;

          closeModal("randomModal");

          if (!state.modelExists) {
            await createModel(defaultConfig);
          }

          const data = generateSyntheticData(
            seed,
            dims,
            steps,
            noise,
            outliers,
            difficulty,
          );
          await trainModel(data);
          await runPrediction();
        };

        // Settings modal
        document.getElementById("closeSettingsModal").onclick = () =>
          closeModal("settingsModal");
        document.getElementById("settingsBackdrop").onclick = () =>
          closeModal("settingsModal");

        document.getElementById("reinitWorker").onclick = async () => {
          state.moduleUrl = document.getElementById("moduleUrl").value;
          savePreferences();
          worker.terminate();
          initWorker();
          showToast("Worker reinitialized", "info");
        };

        document.getElementById("clearPrefs").onclick = () => {
          if (confirm("Clear all preferences?")) {
            localStorage.removeItem("esn_prefs");
            location.reload();
          }
        };

        // Data table modal
        document.getElementById("closeDataTableModal").onclick = () =>
          closeModal("dataTableModal");
        document.getElementById("dataTableBackdrop").onclick = () =>
          closeModal("dataTableModal");

        document.getElementById("tableSearch").oninput =
          renderDataTable;

        document.getElementById("exportCsv").onclick = () => {
          if (!state.predictions) return;
          const csv = generateCsv();
          const blob = new Blob([csv], { type: "text/csv" });
          const link = document.createElement("a");
          link.download = "predictions.csv";
          link.href = URL.createObjectURL(blob);
          link.click();
          showToast("CSV exported", "success");
        };

        document.getElementById("copyAll").onclick = async () => {
          if (!state.predictions) return;
          const csv = generateCsv();
          await navigator.clipboard.writeText(csv);
          showToast("Data copied", "success");
        };

        // Help modal
        document.getElementById("closeHelpModal").onclick = () =>
          closeModal("helpModal");
        document.getElementById("helpBackdrop").onclick = () =>
          closeModal("helpModal");

        // Log filter
        document.getElementById("logFilter").onchange = renderLogs;
        document.getElementById("logSearch").oninput = renderLogs;

        // Cancel loading
        document.getElementById("cancelBtn").onclick = () => {
          isCancelled = true;
          hideLoading();
        };

        // Window resize
        window.onresize = () => {
          renderChart();
        };
      }

      // ==================== HELPERS ====================
      function loadConfigToForm() {
        document.getElementById("reservoirSize").value =
          state.config.reservoirSize;
        document.getElementById("spectralRadius").value =
          state.config.spectralRadius;
        document.getElementById("leakRate").value =
          state.config.leakRate;
        document.getElementById("inputScale").value =
          state.config.inputScale;
        document.getElementById("biasScale").value =
          state.config.biasScale;
        document.getElementById("reservoirSparsity").value =
          state.config.reservoirSparsity;
        document.getElementById("inputSparsity").value =
          state.config.inputSparsity;
        document.getElementById("activation").value =
          state.config.activation;
        document.getElementById("rlsLambda").value =
          state.config.rlsLambda;
        document.getElementById("rlsDelta").value =
          state.config.rlsDelta;
        document.getElementById("epsilon").value = state.config.epsilon;
        document.getElementById("l2Lambda").value =
          state.config.l2Lambda;
        document.getElementById("gradientClipNorm").value =
          state.config.gradientClipNorm;
        document.getElementById("normalizationEpsilon").value =
          state.config.normalizationEpsilon;
        document.getElementById("normalizationWarmup").value =
          state.config.normalizationWarmup;
        document.getElementById("outlierThreshold").value =
          state.config.outlierThreshold;
        document.getElementById("outlierMinWeight").value =
          state.config.outlierMinWeight;
        document.getElementById("uncertaintyMultiplier").value =
          state.config.uncertaintyMultiplier;
        document.getElementById("weightInitScale").value =
          state.config.weightInitScale;
        document.getElementById("seed").value = state.config.seed;

        updateToggle(
          "useInputInReadout",
          state.config.useInputInReadout,
        );
        updateToggle("useBiasInReadout", state.config.useBiasInReadout);
        updateToggle("verbose", state.config.verbose);
      }

      function updateToggle(id, value) {
        const btn = document.getElementById(id);
        btn.dataset.value = value.toString();
        if (value) {
          btn.className =
            "toggle-btn w-12 h-7 rounded-full bg-blue-500 relative";
          btn.querySelector("span").className =
            "absolute w-5 h-5 bg-white rounded-full top-1 right-1 shadow";
        } else {
          btn.className =
            "toggle-btn w-12 h-7 rounded-full bg-slate-300 dark:bg-slate-600 relative";
          btn.querySelector("span").className =
            "absolute w-5 h-5 bg-white rounded-full top-1 left-1 shadow";
        }
      }

      function getConfigFromForm() {
        return {
          reservoirSize:
            parseInt(document.getElementById("reservoirSize").value) ||
            256,
          spectralRadius: parseFloat(
            document.getElementById("spectralRadius").value,
          ) || 0.9,
          leakRate:
            parseFloat(document.getElementById("leakRate").value) ||
            0.3,
          inputScale:
            parseFloat(document.getElementById("inputScale").value) ||
            1.0,
          biasScale:
            parseFloat(document.getElementById("biasScale").value) ||
            0.1,
          reservoirSparsity: parseFloat(
            document.getElementById("reservoirSparsity").value,
          ) || 0.9,
          inputSparsity: parseFloat(
            document.getElementById("inputSparsity").value,
          ) || 0.0,
          activation: document.getElementById("activation").value ||
            "tanh",
          useInputInReadout:
            document.getElementById("useInputInReadout").dataset
              .value === "true",
          useBiasInReadout:
            document.getElementById("useBiasInReadout").dataset
              .value === "true",
          readoutTraining: "rls",
          rlsLambda:
            parseFloat(document.getElementById("rlsLambda").value) ||
            0.999,
          rlsDelta:
            parseFloat(document.getElementById("rlsDelta").value) ||
            1.0,
          epsilon:
            parseFloat(document.getElementById("epsilon").value) ||
            1e-8,
          l2Lambda:
            parseFloat(document.getElementById("l2Lambda").value) ||
            0.0001,
          gradientClipNorm: parseFloat(
            document.getElementById("gradientClipNorm").value,
          ) || 1.0,
          normalizationEpsilon: parseFloat(
            document.getElementById("normalizationEpsilon").value,
          ) || 1e-8,
          normalizationWarmup: parseInt(
            document.getElementById("normalizationWarmup").value,
          ) || 10,
          outlierThreshold: parseFloat(
            document.getElementById("outlierThreshold").value,
          ) || 3.0,
          outlierMinWeight: parseFloat(
            document.getElementById("outlierMinWeight").value,
          ) || 0.1,
          uncertaintyMultiplier: parseFloat(
            document.getElementById("uncertaintyMultiplier").value,
          ) || 1.96,
          weightInitScale: parseFloat(
            document.getElementById("weightInitScale").value,
          ) || 0.1,
          seed: parseInt(document.getElementById("seed").value) || 42,
          verbose:
            document.getElementById("verbose").dataset.value === "true",
        };
      }

      function updateTooltip() {
        if (!state.hover.active || !state.predictions) return;

        const tooltip = document.getElementById("chartTooltip");
        const idx = state.hover.dataIndex;
        const dim = state.vizMode === "focus" ? state.selectedDim : 0;

        if (idx < 0 || idx >= state.predictions.predictions.length) {
          tooltip.classList.add("hidden");
          return;
        }

        const pred = state.predictions.predictions[idx][dim];
        const lower = state.predictions.lowerBounds[idx][dim];
        const upper = state.predictions.upperBounds[idx][dim];

        document.getElementById("tooltipStep").textContent = idx + 1;
        document.getElementById("tooltipDimName").textContent = `D${
          dim + 1
        }`;
        document.getElementById("tooltipDimDot").style.backgroundColor =
          COLORS[dim % COLORS.length];
        document.getElementById("tooltipValue").textContent = pred
          .toFixed(4);
        document.getElementById("tooltipLower").textContent = lower
          .toFixed(3);
        document.getElementById("tooltipUpper").textContent = upper
          .toFixed(3);
        document.getElementById("tooltipSpread").textContent =
          (upper - lower).toFixed(3);

        tooltip.classList.remove("hidden");

        const rect = tooltip.getBoundingClientRect();
        let x = state.hover.x + 15;
        let y = state.hover.y - rect.height / 2;

        if (x + rect.width > window.innerWidth) {
          x = state.hover.x - rect.width - 15;
        }
        if (y < 0) y = 10;
        if (y + rect.height > window.innerHeight) {
          y = window.innerHeight - rect.height - 10;
        }

        tooltip.style.left = x + "px";
        tooltip.style.top = y + "px";
      }

      let uploadData = null;

      function handleUploadFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("jsonPaste").value = e.target.result;
          validateUploadData();
        };
        reader.readAsText(file);
      }

      function validateUploadData() {
        const preview = document.getElementById("uploadPreview");
        const error = document.getElementById("uploadError");
        const applyBtn = document.getElementById("applyTrain");

        try {
          const text = document.getElementById("jsonPaste").value;
          const data = JSON.parse(text);

          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            throw new Error('Missing "coordinates" array');
          }

          if (data.coordinates.length < 2) {
            throw new Error("Need at least 2 coordinates");
          }

          const dims = data.coordinates[0].length;
          if (
            !dims || data.coordinates.some((c) => c.length !== dims)
          ) {
            throw new Error("Inconsistent dimensions");
          }

          uploadData = data.coordinates;

          document.getElementById("previewDims").textContent = dims;
          document.getElementById("previewSteps").textContent =
            data.coordinates.length;

          preview.classList.remove("hidden");
          error.classList.add("hidden");
          applyBtn.disabled = false;
        } catch (e) {
          document.getElementById("uploadErrorText").textContent =
            e.message;
          error.classList.remove("hidden");
          preview.classList.add("hidden");
          applyBtn.disabled = true;
          uploadData = null;
        }
      }

      async function applyUploadData() {
        if (!uploadData) return;

        closeModal("uploadModal");

        if (!state.modelExists) {
          await createModel(defaultConfig);
        }

        await trainModel(uploadData);
        uploadData = null;
        document.getElementById("jsonPaste").value = "";
        document.getElementById("uploadPreview").classList.add(
          "hidden",
        );
      }

      async function handleLoadFile(file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            showLoading("Loading model...");
            await sendWorkerMessage("load", {
              state: data.state,
              config: data.config,
            });
            state.config = data.config || defaultConfig;
            state.modelExists = true;

            const summary = await sendWorkerMessage("getSummary", {});
            state.sampleCount = summary.sampleCount;
            state.nDimensions = summary.nFeatures;

            closeModal("saveLoadModal");
            addLog("success", "Model loaded from file");
            showToast("Model loaded", "success");
            updateUI();
          } catch (e) {
            addLog("error", "Failed to load model: " + e.message);
            showToast("Failed to load model", "error");
          } finally {
            hideLoading();
          }
        };
        reader.readAsText(file);
      }

      function renderSavedModelsList() {
        const container = document.getElementById("savedModelsList");
        try {
          const saved = JSON.parse(
            localStorage.getItem("esn_saved_models") || "{}",
          );
          const names = Object.keys(saved);

          if (names.length === 0) {
            container.innerHTML =
              '<div class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No saved models</div>';
            return;
          }

          container.innerHTML = names.map((name) => `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
                        <div>
                            <div class="font-semibold text-slate-800 dark:text-slate-100">${name}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${
            saved[name].dims || "?"
          } dimensions ‚Ä¢ ${saved[name].samples || "?"} samples</div>
                        </div>
                        <button class="load-saved-btn min-h-[36px] px-3 py-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-semibold text-sm" data-name="${name}">Load</button>
                    </div>
                `).join("");

          container.querySelectorAll(".load-saved-btn").forEach(
            (btn) => {
              btn.onclick = async () => {
                const name = btn.dataset.name;
                const saved = JSON.parse(
                  localStorage.getItem("esn_saved_models") || "{}",
                );
                const model = saved[name];
                if (model) {
                  try {
                    showLoading("Loading model...");
                    await sendWorkerMessage("load", {
                      state: model.state,
                      config: model.config,
                    });
                    state.config = model.config || defaultConfig;
                    state.modelExists = true;
                    state.sampleCount = model.samples || 0;
                    state.nDimensions = model.dims || 0;

                    closeModal("saveLoadModal");
                    addLog("success", `Model "${name}" loaded`);
                    showToast("Model loaded", "success");
                    updateUI();
                  } catch (e) {
                    showToast("Failed to load model", "error");
                  } finally {
                    hideLoading();
                  }
                }
              };
            },
          );
        } catch (e) {
          container.innerHTML =
            '<div class="text-sm text-red-500">Error loading saved models</div>';
        }
      }

      function renderDataTable() {
        if (!state.predictions) {
          document.getElementById("tableHead").innerHTML = "";
          document.getElementById("tableBody").innerHTML =
            '<tr><td class="p-4 text-center text-slate-500">No predictions available</td></tr>';
          return;
        }

        const search = document.getElementById("tableSearch").value
          .toLowerCase();
        const predictions = state.predictions.predictions;
        const lowerBounds = state.predictions.lowerBounds;
        const upperBounds = state.predictions.upperBounds;
        const nDims = state.nDimensions;

        // Header
        let headerHtml =
          '<tr><th class="px-3 py-2 text-left text-xs font-bold text-slate-600 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">Step</th>';
        for (let d = 0; d < nDims; d++) {
          headerHtml +=
            `<th class="px-3 py-2 text-left text-xs font-bold uppercase cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600" style="color: ${
              COLORS[d % COLORS.length]
            }">P${d + 1}</th>`;
        }
        for (let d = 0; d < nDims; d++) {
          headerHtml +=
            `<th class="px-3 py-2 text-left text-xs font-bold text-slate-500 dark:text-slate-500 uppercase cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">L${
              d + 1
            }</th>`;
        }
        for (let d = 0; d < nDims; d++) {
          headerHtml +=
            `<th class="px-3 py-2 text-left text-xs font-bold text-slate-500 dark:text-slate-500 uppercase cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">U${
              d + 1
            }</th>`;
        }
        headerHtml += "</tr>";
        document.getElementById("tableHead").innerHTML = headerHtml;

        // Body
        let bodyHtml = "";
        for (let i = 0; i < predictions.length; i++) {
          const rowData = [
            (i + 1).toString(),
            ...predictions[i].map((v) => v.toFixed(4)),
            ...lowerBounds[i].map((v) => v.toFixed(4)),
            ...upperBounds[i].map((v) => v.toFixed(4)),
          ];

          if (
            search &&
            !rowData.some((v) => v.toLowerCase().includes(search))
          ) continue;

          const bgClass = i % 2 === 0
            ? "bg-white dark:bg-slate-800"
            : "bg-slate-50 dark:bg-slate-800/50";
          bodyHtml +=
            `<tr class="${bgClass} hover:bg-blue-50 dark:hover:bg-blue-900/20">`;
          bodyHtml +=
            `<td class="px-3 py-2 font-bold text-slate-600 dark:text-slate-400">${
              i + 1
            }</td>`;
          for (let d = 0; d < nDims; d++) {
            bodyHtml += `<td class="px-3 py-2" style="color: ${
              COLORS[d % COLORS.length]
            }">${predictions[i][d].toFixed(4)}</td>`;
          }
          for (let d = 0; d < nDims; d++) {
            bodyHtml += `<td class="px-3 py-2 text-slate-500">${
              lowerBounds[i][d].toFixed(4)
            }</td>`;
          }
          for (let d = 0; d < nDims; d++) {
            bodyHtml += `<td class="px-3 py-2 text-slate-500">${
              upperBounds[i][d].toFixed(4)
            }</td>`;
          }
          bodyHtml += "</tr>";
        }

        document.getElementById("tableBody").innerHTML = bodyHtml ||
          '<tr><td class="p-4 text-center text-slate-500" colspan="100">No matching results</td></tr>';
      }

      function generateCsv() {
        if (!state.predictions) return "";

        const predictions = state.predictions.predictions;
        const lowerBounds = state.predictions.lowerBounds;
        const upperBounds = state.predictions.upperBounds;
        const nDims = state.nDimensions;

        let header = ["Step"];
        for (let d = 0; d < nDims; d++) header.push(`P${d + 1}`);
        for (let d = 0; d < nDims; d++) header.push(`L${d + 1}`);
        for (let d = 0; d < nDims; d++) header.push(`U${d + 1}`);

        let csv = header.join(",") + "\n";

        for (let i = 0; i < predictions.length; i++) {
          const row = [
            i + 1,
            ...predictions[i],
            ...lowerBounds[i],
            ...upperBounds[i],
          ];
          csv += row.join(",") + "\n";
        }

        return csv;
      }

      // Initialize
      init();
    </script>
  </body>
</html>
