<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ESN Regression Studio</title>
    <script>
      tailwind = {
        config: {
          safelist: [
            "bg-blue-500",
            "bg-emerald-500",
            "bg-amber-500",
            "bg-red-500",
            "bg-violet-500",
            "bg-pink-500",
            "bg-cyan-500",
            "bg-lime-500",
            "bg-orange-500",
            "bg-teal-500",
            "text-blue-500",
            "text-emerald-500",
            "text-amber-500",
            "text-red-500",
            "text-violet-500",
            "text-pink-500",
            "text-cyan-500",
            "text-lime-500",
            "text-orange-500",
            "text-teal-500",
            "border-blue-200",
            "border-emerald-200",
            "border-amber-200",
            "border-red-200",
            "border-violet-200",
            "border-pink-200",
            "border-cyan-200",
            "border-lime-200",
            "border-orange-200",
            "border-teal-200",
          ],
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-b from-slate-50 to-indigo-50 text-slate-900">
    <div id="app" class="min-h-dvh">
      <header
        class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200/60"
      >
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div
              class="w-11 h-11 rounded-xl shadow-lg shadow-blue-500/30 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 grid place-items-center"
              aria-hidden="true"
            >
              <span class="text-2xl">üìä</span>
            </div>
            <div class="min-w-0">
              <div class="font-extrabold tracking-tight truncate">
                ESN Studio
              </div>
              <div class="text-xs text-slate-600 truncate">
                Autoregressive Forecasting
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div
              id="badge"
              class="px-3 py-1 rounded-full bg-white/80 border border-slate-200 shadow-sm flex items-center gap-2 text-xs"
              aria-label="Model status badge"
            >
              <span
                id="dot"
                class="w-2.5 h-2.5 rounded-full bg-slate-400"
                aria-hidden="true"
              ></span><span id="badgeTxt">No Model</span>
            </div>
            <button
              id="btnPredictTop"
              class="hidden px-3 py-2 rounded-xl text-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 font-semibold text-sm flex items-center gap-2"
              aria-label="Predict"
            >
              <span aria-hidden="true">‚ö°</span><span class="hidden sm:inline"
              >Predict</span>
            </button>
            <button
              id="btnCfg"
              class="px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm"
              aria-label="Configure"
            >
              ‚öôÔ∏è
            </button>
            <button
              id="btnMenu"
              class="px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-sm"
              aria-label="Open menu"
            >
              ‚ò∞
            </button>
          </div>
        </div>
      </header>

      <main class="max-w-6xl mx-auto px-4 py-4 lg:flex gap-4">
        <section class="lg:flex-1">
          <div
            class="flex gap-2 overflow-x-auto pb-2"
            aria-label="Visualization tabs"
          >
            <button
              data-tab="grid"
              class="tab px-3 py-2 rounded-xl whitespace-nowrap text-sm font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
              aria-label="Grid mode"
            >
              üìä Grid
            </button>
            <button
              data-tab="focus"
              class="tab px-3 py-2 rounded-xl whitespace-nowrap text-sm font-semibold bg-slate-100 text-slate-700"
              aria-label="Focus mode"
            >
              üîç Focus
            </button>
            <button
              data-tab="snapshot"
              class="tab px-3 py-2 rounded-xl whitespace-nowrap text-sm font-semibold bg-slate-100 text-slate-700"
              aria-label="Snapshot mode"
            >
              üßä Snapshot
            </button>
          </div>

          <div
            id="dimRow"
            class="hidden mt-2 -mx-1 px-1 flex gap-2 overflow-x-auto"
            aria-label="Dimension selector"
          >
          </div>

          <div
            class="mt-3 bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden relative"
          >
            <div id="empty" class="p-8 text-center">
              <div
                class="mx-auto w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100 grid place-items-center shadow-inner"
              >
                <div class="text-5xl" aria-hidden="true">üìä</div>
              </div>
              <div class="mt-5 font-extrabold text-lg">
                Create a Model to Begin
              </div>
              <div class="mt-2 text-sm text-slate-600">
                Upload multivariate time series JSON and train an ESN regression
                model for autoregressive forecasting.
              </div>
              <div class="mt-6 flex flex-col sm:flex-row gap-2 justify-center">
                <button
                  id="btnDefaults"
                  class="px-4 py-3 rounded-xl text-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 font-semibold"
                  aria-label="Start with defaults"
                >
                  <span aria-hidden="true">‚ö°</span> Start with Defaults
                </button>
                <button
                  id="btnLoadOpen"
                  class="px-4 py-3 rounded-xl bg-white border border-slate-200 shadow-sm font-semibold"
                  aria-label="Open load modal"
                >
                  <span aria-hidden="true">üì§</span> Load
                </button>
                <button
                  id="btnDemo"
                  class="px-4 py-3 rounded-xl text-white shadow-lg bg-gradient-to-r from-purple-600 to-pink-500 font-semibold"
                  aria-label="Run demo"
                >
                  <span aria-hidden="true">‚ú®</span> Demo
                </button>
              </div>
            </div>

            <div id="chartWrap" class="hidden">
              <div
                class="p-3 border-b border-slate-200 flex items-center justify-between gap-2"
              >
                <div
                  id="stats"
                  class="grid grid-cols-3 sm:grid-cols-6 gap-2 flex-1"
                  aria-label="Statistics bar"
                >
                </div>
                <div class="flex items-center gap-2">
                  <button
                    id="btnPNG"
                    class="px-2.5 py-2 rounded-xl bg-slate-50 border border-slate-200"
                    aria-label="Save as PNG"
                  >
                    üñºÔ∏è
                  </button>
                  <button
                    id="btnSVG"
                    class="px-2.5 py-2 rounded-xl bg-slate-50 border border-slate-200"
                    aria-label="Save as SVG"
                  >
                    üìÑ
                  </button>
                  <button
                    id="btnCopy"
                    class="px-2.5 py-2 rounded-xl bg-slate-50 border border-slate-200"
                    aria-label="Copy to clipboard"
                  >
                    üìã
                  </button>
                </div>
              </div>
              <div class="relative">
                <canvas
                  id="cv"
                  class="w-full h-[360px] sm:h-[420px] touch-none"
                  aria-label="Chart canvas"
                ></canvas>
                <div
                  class="absolute left-3 top-3 px-2 py-1 rounded-lg bg-white/80 border border-slate-200 text-xs font-semibold shadow-sm"
                  aria-label="Zoom level"
                >
                  <span id="zoomBadge">100%</span>
                </div>
                <div
                  id="floatCtrls"
                  class="absolute right-3 top-3 flex gap-2"
                  aria-label="Zoom controls"
                >
                  <button
                    id="zIn"
                    class="px-3 py-2 rounded-xl bg-white/90 border border-slate-200 shadow-sm"
                    aria-label="Zoom in"
                  >
                    ‚ûï
                  </button>
                  <button
                    id="zOut"
                    class="px-3 py-2 rounded-xl bg-white/90 border border-slate-200 shadow-sm"
                    aria-label="Zoom out"
                  >
                    ‚ûñ
                  </button>
                  <button
                    id="zReset"
                    class="px-3 py-2 rounded-xl bg-white/90 border border-slate-200 shadow-sm"
                    aria-label="Reset zoom"
                  >
                    üîÑ
                  </button>
                </div>
                <div id="tip" class="hidden absolute z-10 pointer-events-none">
                  <div
                    class="bg-white/95 border border-slate-200 shadow-xl rounded-xl p-3 text-xs"
                  >
                    <div class="font-extrabold text-sm" id="tipStep">
                      Step 0
                    </div>
                    <div class="mt-1 flex items-center gap-2">
                      <span
                        id="tipDot"
                        class="w-2.5 h-2.5 rounded-full bg-blue-500"
                      ></span><span id="tipDim" class="font-semibold">D1</span>
                    </div>
                    <div class="mt-2">
                      Pred: <span class="font-bold" id="tipVal">0</span>
                    </div>
                    <div>
                      CI: <span class="font-semibold" id="tipCI">0 ‚Äì 0</span>
                    </div>
                    <div class="text-slate-600">
                      Spread: <span id="tipSp">0</span>
                    </div>
                  </div>
                </div>
              </div>

              <div
                id="snapRow"
                class="hidden p-3 border-t border-slate-200 flex items-center gap-2"
                aria-label="Snapshot controls"
              >
                <div class="text-sm font-semibold">Step:</div>
                <input
                  id="snapStep"
                  type="number"
                  min="0"
                  class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white"
                  aria-label="Snapshot step"
                />
                <div class="text-xs text-slate-600">
                  Shows tooltip + marker at selected step.
                </div>
              </div>
            </div>
          </div>
        </section>

        <aside class="mt-4 lg:mt-0 lg:w-[360px]">
          <div
            class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden"
          >
            <div class="p-4 border-b border-slate-200">
              <div
                class="text-xs font-extrabold tracking-widest text-slate-500"
              >
                MODEL METRICS
              </div>
              <div
                class="mt-3 grid grid-cols-2 gap-2 text-sm"
                aria-label="Model metrics"
              >
                <div class="p-3 rounded-xl bg-blue-50 border border-blue-100">
                  <div class="text-[10px] uppercase font-bold text-blue-700">
                    Samples Trained
                  </div>
                  <div id="mSamples" class="mt-1 font-extrabold">0</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                  <div class="text-[10px] uppercase font-bold text-slate-600">
                    Avg Loss
                  </div>
                  <div id="mLoss" class="mt-1 font-extrabold">0</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                  <div class="text-[10px] uppercase font-bold text-slate-600">
                    Gradient Norm
                  </div>
                  <div id="mGrad" class="mt-1 font-extrabold">0</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-50 border border-slate-200">
                  <div class="text-[10px] uppercase font-bold text-slate-600">
                    Sample Weight
                  </div>
                  <div id="mW" class="mt-1 font-extrabold">0</div>
                </div>
              </div>
            </div>

            <div class="p-4 border-b border-slate-200">
              <div
                class="text-xs font-extrabold tracking-widest text-slate-500"
              >
                PREDICTION
              </div>
              <div class="mt-3 flex items-center gap-2">
                <div class="flex-1">
                  <label
                    class="text-xs text-slate-600"
                    for="future"
                    aria-label="Future steps label"
                  >Future Steps</label>
                  <input
                    id="future"
                    type="number"
                    min="1"
                    value="50"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"
                    aria-label="Future steps input"
                  />
                </div>
                <button
                  id="btnPredict"
                  class="mt-5 px-4 py-3 rounded-xl text-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 font-semibold disabled:opacity-40 disabled:shadow-none"
                  disabled
                  aria-label="Run prediction"
                >
                  Run ‚ö°
                </button>
              </div>
            </div>

            <div class="p-4">
              <div class="flex items-center justify-between gap-2">
                <div
                  class="text-xs font-extrabold tracking-widest text-slate-500"
                >
                  EVENT LOG
                </div>
                <button
                  id="btnClrLog"
                  class="text-xs font-bold px-2 py-1 rounded-lg bg-slate-100 border border-slate-200"
                  aria-label="Clear log"
                >
                  üßπ
                </button>
              </div>
              <div class="mt-3 flex gap-2">
                <select
                  id="logFilter"
                  class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"
                  aria-label="Log filter"
                >
                  <option>All</option>
                  <option>Info</option>
                  <option>Success</option>
                  <option>Warning</option>
                  <option>Error</option>
                </select>
                <input
                  id="logSearch"
                  class="flex-1 px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"
                  placeholder="Search‚Ä¶"
                  aria-label="Log search"
                />
              </div>
              <div
                id="logList"
                class="mt-3 max-h-[320px] overflow-auto space-y-2"
                aria-label="Log list"
              >
              </div>
            </div>
          </div>
        </aside>
      </main>

      <!-- Drawer -->
      <div
        id="drawerBg"
        class="hidden fixed inset-0 z-50 bg-slate-900/20"
        aria-hidden="true"
      >
      </div>
      <aside
        id="drawer"
        class="fixed right-0 top-0 z-50 h-dvh w-[86vw] max-w-[380px] bg-white border-l border-slate-200 shadow-2xl translate-x-full transition-transform"
        aria-label="Menu panel"
      >
        <div
          class="p-4 border-b border-slate-200 flex items-center justify-between"
        >
          <div class="font-extrabold">Menu</div>
          <button
            id="btnCloseMenu"
            class="px-3 py-2 rounded-xl bg-slate-50 border border-slate-200"
            aria-label="Close menu"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="p-4 space-y-3">
          <div class="text-xs font-extrabold tracking-widest text-slate-500">
            üìÅ MODEL
          </div>
          <button
            data-open="cfg"
            class="w-full p-4 rounded-2xl border border-blue-100 bg-blue-50 text-left flex gap-3 items-start"
            aria-label="Create and configure"
          >
            <div
              class="w-10 h-10 rounded-xl bg-blue-500 text-white grid place-items-center shadow"
              aria-hidden="true"
            >
              üéõÔ∏è
            </div>
            <div>
              <div class="font-extrabold">Create & Configure</div>
              <div class="text-sm text-slate-600">Set up model parameters</div>
            </div>
          </button>
          <button
            data-open="save"
            class="w-full p-4 rounded-2xl border border-emerald-100 bg-emerald-50 text-left flex gap-3 items-start"
            aria-label="Save and load"
          >
            <div
              class="w-10 h-10 rounded-xl bg-emerald-500 text-white grid place-items-center shadow"
              aria-hidden="true"
            >
              üíæ
            </div>
            <div>
              <div class="font-extrabold">Save & Load</div>
              <div class="text-sm text-slate-600">Persist your models</div>
            </div>
          </button>

          <div
            class="text-xs font-extrabold tracking-widest text-slate-500 mt-2"
          >
            üìÇ DATA
          </div>
          <button
            data-open="upload"
            class="w-full p-4 rounded-2xl border border-purple-100 bg-purple-50 text-left flex gap-3 items-start"
            aria-label="Upload dataset"
          >
            <div
              class="w-10 h-10 rounded-xl bg-violet-500 text-white grid place-items-center shadow"
              aria-hidden="true"
            >
              üì§
            </div>
            <div>
              <div class="font-extrabold">Upload Dataset</div>
              <div class="text-sm text-slate-600">Import time series data</div>
            </div>
          </button>

          <div
            class="text-xs font-extrabold tracking-widest text-slate-500 mt-2"
          >
            üß™ TEST
          </div>
          <button
            data-open="rand"
            class="w-full p-4 rounded-2xl border border-pink-100 bg-pink-50 text-left flex gap-3 items-start"
            aria-label="Random test"
          >
            <div
              class="w-10 h-10 rounded-xl bg-pink-500 text-white grid place-items-center shadow"
              aria-hidden="true"
            >
              üí°
            </div>
            <div>
              <div class="font-extrabold">Random Test</div>
              <div class="text-sm text-slate-600">
                Generate synthetic time series
              </div>
            </div>
          </button>

          <div
            class="text-xs font-extrabold tracking-widest text-slate-500 mt-2"
          >
            ‚öôÔ∏è ADVANCED
          </div>
          <button
            data-open="table"
            class="w-full p-4 rounded-2xl border border-slate-200 bg-slate-50 text-left flex gap-3 items-start"
            aria-label="View data table"
          >
            <div
              class="w-10 h-10 rounded-xl bg-slate-700 text-white grid place-items-center shadow"
              aria-hidden="true"
            >
              üìã
            </div>
            <div>
              <div class="font-extrabold">View Data Table</div>
              <div class="text-sm text-slate-600">Raw prediction values</div>
            </div>
          </button>
        </div>
      </aside>

      <!-- Toasts -->
      <div
        id="toasts"
        class="fixed bottom-3 left-0 right-0 z-[60] px-3 space-y-2"
        aria-label="Toast container"
      >
      </div>

      <!-- Loading overlay -->
      <div
        id="loading"
        class="hidden fixed inset-0 z-[70] backdrop-blur bg-white/60"
      >
        <div class="min-h-dvh grid place-items-center px-6">
          <div
            class="w-full max-w-md bg-white rounded-2xl border border-slate-200 shadow-2xl p-5"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-11 h-11 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 grid place-items-center text-white"
                aria-hidden="true"
              >
                ‚è≥
              </div>
              <div class="flex-1">
                <div class="font-extrabold" id="loadTitle">Processing‚Ä¶</div>
                <div class="text-sm text-slate-600" id="loadSub">Working</div>
              </div>
              <div
                class="w-6 h-6 rounded-full border-2 border-slate-200 border-t-slate-700 animate-spin"
                aria-hidden="true"
              >
              </div>
            </div>
            <div class="mt-4">
              <div
                class="h-3 rounded-full bg-slate-100 overflow-hidden border border-slate-200"
                aria-label="Progress bar"
              >
                <div
                  id="loadBar"
                  class="h-full w-0 bg-gradient-to-r from-blue-500 to-indigo-500"
                >
                </div>
              </div>
              <div class="mt-2 text-xs text-slate-600">
                <span id="loadPct">0%</span>
              </div>
            </div>
            <div class="mt-4 flex justify-end">
              <button
                id="btnCancelOp"
                class="px-4 py-2 rounded-xl bg-red-500 text-white font-bold"
                aria-label="Cancel operation"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modals (reused shell) -->
      <div
        id="modalBg"
        class="hidden fixed inset-0 z-[80] bg-slate-900/30"
        aria-hidden="true"
      >
      </div>
      <div
        id="modal"
        class="hidden fixed inset-0 z-[81] grid place-items-center px-3"
        role="dialog"
        aria-modal="true"
        aria-label="Modal"
      >
        <div
          class="w-full max-w-2xl bg-white rounded-2xl border border-slate-200 shadow-2xl overflow-hidden"
        >
          <div
            class="p-4 border-b border-slate-200 flex items-center justify-between gap-2"
          >
            <div class="font-extrabold" id="modalTitle">Modal</div>
            <button
              id="btnCloseModal"
              class="px-3 py-2 rounded-xl bg-slate-50 border border-slate-200"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div id="modalBody" class="max-h-[78vh] overflow-auto p-4"></div>
        </div>
      </div>

      <script type="module">
        const $ = (s) => document.querySelector(s),
          $$ = (s) => [...document.querySelectorAll(s)],
          E = (id) => document.getElementById(id);
        const DC = [
          "#3B82F6",
          "#10B981",
          "#F59E0B",
          "#EF4444",
          "#8B5CF6",
          "#EC4899",
          "#06B6D4",
          "#84CC16",
          "#F97316",
          "#14B8A6",
        ];
        const Dbg = [
          "bg-blue-500",
          "bg-emerald-500",
          "bg-amber-500",
          "bg-red-500",
          "bg-violet-500",
          "bg-pink-500",
          "bg-cyan-500",
          "bg-lime-500",
          "bg-orange-500",
          "bg-teal-500",
        ];
        const Dtxt = [
          "text-blue-500",
          "text-emerald-500",
          "text-amber-500",
          "text-red-500",
          "text-violet-500",
          "text-pink-500",
          "text-cyan-500",
          "text-lime-500",
          "text-orange-500",
          "text-teal-500",
        ];
        const now = () =>
          new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        const ls = {
          g: (k, d) => {
            try {
              let v = localStorage.getItem(k);
              return v ? JSON.parse(v) : d;
            } catch {
              return d;
            }
          },
          s: (k, v) => {
            try {
              localStorage.setItem(k, JSON.stringify(v));
            } catch {}
          },
        };
        const DEF = {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          readoutTraining: "rls",
          rlsLambda: 0.999,
          rlsDelta: 1,
          epsilon: 1e-8,
          l2Lambda: 1e-4,
          gradientClipNorm: 1,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        };
        const PRE = {
          start: {
            reservoirSize: 256,
            spectralRadius: 0.9,
            leakRate: 0.3,
          },
          fast: { reservoirSize: 64, reservoirSparsity: 0.95 },
          balanced: { reservoirSize: 256, spectralRadius: 0.9 },
          accurate: {
            reservoirSize: 512,
            spectralRadius: 0.95,
            leakRate: 0.2,
          },
          adaptive: {
            rlsLambda: 0.97,
            spectralRadius: 0.85,
            leakRate: 0.5,
          },
          robust: {
            outlierThreshold: 2,
            outlierMinWeight: 0.05,
            l2Lambda: 0.01,
            leakRate: 0.2,
          },
        };
        const S = {
          config: Object.assign({}, DEF, ls.g("esn_cfg", {})),
          modelExists: false,
          nDimensions: 0,
          sampleCount: 0,
          data: null,
          pred: null,
          vizMode: ls.g("esn_viz", "grid"),
          selectedDim: 0,
          selectedStep: 0,
          logs: [],
          metrics: {
            samplesProcessed: 0,
            averageLoss: 0,
            gradientNorm: 0,
            driftDetected: false,
            sampleWeight: 1,
          },
          zoom: {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: 0,
          },
          hover: { active: false, x: 0, y: 0, dataIndex: 0 },
          rid: 0,
          pending: new Map(),
          worker: null,
          fall: null,
          opRid: null,
          table: { q: "", k: "Step", dir: 1 },
        };
        const cap = (a, b, c) => Math.max(b, Math.min(c, a));
        const fmtE = (x) =>
          Number.isFinite(x)
            ? (Math.abs(x) >= 1e4 || Math.abs(x) <= 1e-3 && x !== 0
              ? x.toExponential(2)
              : (+x).toFixed(4))
            : String(x);
        const toast = (kind, msg, ms) => {
          const m = {
            Info: ["bg-blue-500", "text-white"],
            Success: ["bg-emerald-500", "text-white"],
            Warning: ["bg-amber-500", "text-white"],
            Error: ["bg-red-500", "text-white"],
          }[kind] || ["bg-slate-900", "text-white"];
          ms = ms ?? (kind === "Error" ? 6000 : 4000);
          const id = "t" + Math.random().toString(36).slice(2);
          const el = document.createElement("div");
          el.id = id;
          el.className = `${m[0]} ${
            m[1]
          } rounded-2xl shadow-2xl px-4 py-3 flex items-start gap-3`;
          el.innerHTML = `<div class="text-lg" aria-hidden="true">${
            kind === "Success"
              ? "‚úÖ"
              : kind === "Warning"
              ? "‚ö†Ô∏è"
              : kind === "Error"
              ? "üõë"
              : "‚ÑπÔ∏è"
          }</div><div class="flex-1 text-sm font-semibold">${msg}</div><button class="text-white/90 font-bold" aria-label="Close toast">‚úñÔ∏è</button>`;
          el.querySelector("button").onclick = () => el.remove();
          E("toasts").appendChild(el);
          setTimeout(() => {
            el && el.remove();
          }, ms);
        };
        const log = (k, m) => {
          S.logs.unshift({ k, t: Date.now(), ts: now(), m });
          S.logs = S.logs.slice(0, 200);
          renderLog();
        };
        const setLoading = (on, title, sub, pct) => {
          E("loading").classList.toggle("hidden", !on);
          if (on) {
            E("loadTitle").textContent = title || "Processing‚Ä¶";
            E("loadSub").textContent = sub || "Working";
            setProg(pct ?? 0);
          }
        };
        const setProg = (p) => {
          p = cap(p, 0, 100);
          E("loadBar").style.width = p + "%";
          E("loadPct").textContent = Math.round(p) + "%";
        };
        const ar = (s) =>
          s.replace(
            /[&<>"']/g,
            (c) => ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c]),
          );
        const openDrawer = (on) => {
          E("drawerBg").classList.toggle("hidden", !on);
          E("drawer").classList.toggle("translate-x-full", !on);
          if (on) {
            S._lastFocus = document.activeElement;
            E("btnCloseMenu").focus();
          } else S._lastFocus && S._lastFocus.focus();
        };
        const openModal = (key, title, bodyHtml) => {
          E("modalTitle").textContent = title;
          E("modalBody").innerHTML = bodyHtml;
          E("modalBg").classList.remove("hidden");
          E("modal").classList.remove("hidden");
          S._lastFocus = document.activeElement;
          setTimeout(() => {
            const f = E("modal").querySelector(
              "button,select,input,textarea",
            );
            f && f.focus();
          }, 0);
          E("modal").dataset.key = key;
        };
        const closeModal = () => {
          E("modalBg").classList.add("hidden");
          E("modal").classList.add("hidden");
          E("modalBody").innerHTML = "";
          S._lastFocus && S._lastFocus.focus();
        };
        E("btnCloseModal").onclick = closeModal;
        E("modalBg").onclick = closeModal;
        const vPersist = () => {
          ls.s("esn_cfg", S.config);
          ls.s("esn_viz", S.vizMode);
        };

        function mkWorker() {
          const src =
            `let ESN=null,model=null,cancel=new Set(),inited=0;
  const send=o=>postMessage(o);
  onmessage=async(e)=>{const d=e.data||{},{type,rid,payload}=d;try{
    if(type==="init"){if(!inited){ESN=(await import("https://esm.sh/jsr/@hviana/multivariate-regression")).ESNRegression;inited=1}send({type:"inited",rid,ok:1});return}
    if(type==="reset"){model=null;cancel.clear();send({type:"reset",rid,ok:1});return}
    if(type==="cancel"){cancel.add(payload?.rid??rid);send({type:"cancelled",rid,ok:1});return}
    if(!inited){ESN=(await import("https://esm.sh/jsr/@hviana/multivariate-regression")).ESNRegression;inited=1}
    if(type==="createModel"){model=new ESN(payload?.config||{});send({type:"modelCreated",rid,ok:1});return}
    if(type==="load"){const cfg=payload?.config||{};model=new ESN(cfg);model.load(payload?.state);send({type:"loaded",rid,ok:1});return}
    if(type==="save"){if(!model)throw Error("No model");send({type:"saved",rid,ok:1,state:model.save()});return}
    if(type==="getSummary"){if(!model){send({type:"summary",rid,ok:1,summary:null});return}send({type:"summary",rid,ok:1,summary:model.getModelSummary()});return}
    if(type==="train"){
      if(!model)throw Error("No model");
      const c=payload?.coordinates; if(!Array.isArray(c)||c.length<2)throw Error("Need at least 2 coordinates");
      const pairs=Math.floor(c.length/2),total=pairs||1; let last=null;
      for(let i=0;i<pairs;i++){
        if(cancel.has(rid)||cancel.has("all")){cancel.delete(rid);throw Error("Cancelled")}
        const a=c[i*2],b=c[i*2+1]; last=model.fitOnline({coordinates:[a,b]});
        const pct=(i+1)/total*100; send({type:"progress",rid,ok:1,pct,metrics:last});
      }
      send({type:"trained",rid,ok:1,metrics:last});
      return
    }
    if(type==="predict"){
      if(!model)throw Error("No model");
      const n=payload?.futureSteps|0; if(!(n>0))throw Error("Future steps must be > 0");
      const r=model.predict(n); send({type:"predicted",rid,ok:1,result:r});return
    }
    throw Error("Unknown type: "+type)
  }catch(err){send({type:"error",rid,ok:0,message:err?.message||String(err)})}}`;
          try {
            const b = new Blob([src], { type: "text/javascript" });
            return new Worker(URL.createObjectURL(b), {
              type: "module",
            });
          } catch (e) {
            return null;
          }
        }
        async function mkFallback() {
          try {
            const mod = await import(
              "https://esm.sh/jsr/@hviana/multivariate-regression"
            );
            return { ESN: mod.ESNRegression, model: null };
          } catch (e) {
            return null;
          }
        }

        async function rpc(type, payload, progressCb) {
          const rid = ++S.rid;
          S.opRid = rid;
          const send = (msg) => {
            try {
              S.worker?.postMessage(msg);
            } catch {}
          };
          return new Promise(async (res, rej) => {
            const done = (ok, data) => {
              S.pending.delete(rid);
              ok ? res(data) : rej(data);
            };
            S.pending.set(rid, { done, progressCb });
            try {
              if (S.worker) send({ type, rid, payload });
              else {
                if (!S.fall) S.fall = await mkFallback();
                if (!S.fall) {
                  throw Error(
                    "Worker unavailable and fallback import failed",
                  );
                }
                const F = S.fall; // emulate
                const emit = (t, o) =>
                  onMsg({ data: { type: t, rid, ...o } });
                const cfg = payload?.config || S.config;
                if (type === "init") {
                  emit("inited", { ok: 1 });
                  return;
                }
                if (type === "reset") {
                  F.model = null;
                  emit("reset", { ok: 1 });
                  return;
                }
                if (type === "cancel") {
                  emit("cancelled", { ok: 1 });
                  return;
                }
                if (type === "createModel") {
                  F.model = new F.ESN(cfg);
                  emit("modelCreated", { ok: 1 });
                  return;
                }
                if (type === "load") {
                  F.model = new F.ESN(payload?.config || {});
                  F.model.load(payload?.state);
                  emit("loaded", { ok: 1 });
                  return;
                }
                if (type === "save") {
                  if (!F.model) throw Error("No model");
                  emit("saved", { ok: 1, state: F.model.save() });
                  return;
                }
                if (type === "getSummary") {
                  emit("summary", {
                    ok: 1,
                    summary: F.model
                      ? F.model.getModelSummary()
                      : null,
                  });
                  return;
                }
                if (type === "train") {
                  if (!F.model) throw Error("No model");
                  const c = payload?.coordinates;
                  if (!Array.isArray(c) || c.length < 2) {
                    throw Error("Need at least 2 coordinates");
                  }
                  const pairs = Math.floor(c.length / 2),
                    total = pairs || 1;
                  let last = null;
                  for (let i = 0; i < pairs; i++) {
                    last = F.model.fitOnline({
                      coordinates: [c[i * 2], c[i * 2 + 1]],
                    });
                    emit("progress", {
                      ok: 1,
                      pct: (i + 1) / total * 100,
                      metrics: last,
                    });
                  }
                  emit("trained", { ok: 1, metrics: last });
                  return;
                }
                if (type === "predict") {
                  if (!F.model) throw Error("No model");
                  const n = payload?.futureSteps | 0;
                  if (!(n > 0)) {
                    throw Error("Future steps must be > 0");
                  }
                  emit("predicted", {
                    ok: 1,
                    result: F.model.predict(n),
                  });
                  return;
                }
                throw Error("Unknown type");
              }
            } catch (e) {
              done(0, { message: e.message || String(e) });
            }
          });
        }
        function onMsg(e) {
          const d = e.data || {}, p = S.pending.get(d.rid);
          if (!p) return;
          if (d.type === "progress") {
            p.progressCb && p.progressCb(d);
            return;
          }
          if (d.type === "error") {
            p.done(0, d);
            return;
          }
          p.done(1, d);
        }
        function bindWorker() {
          S.worker = mkWorker();
          if (S.worker) {
            S.worker.onmessage = onMsg;
            S.worker.onerror = (ev) => {
              toast(
                "Error",
                "Worker failed; falling back to main thread.",
                6000,
              );
              log(
                "Error",
                "Worker error: " + (ev?.message || "unknown"),
              );
              S.worker = null;
            };
          } else {
            toast(
              "Warning",
              "Worker unavailable; using main-thread fallback.",
              5000,
            );
            log("Warning", "Worker unavailable; fallback mode");
          }
        }

        const cv = E("cv"), ctx = cv.getContext("2d");
        const sz = () => {
          const r = cv.getBoundingClientRect();
          const d = Math.max(1, devicePixelRatio || 1);
          cv.width = Math.floor(r.width * d);
          cv.height = Math.floor(r.height * d);
          ctx.setTransform(d, 0, 0, d, 0, 0);
          draw();
        };
        window.addEventListener("resize", sz, { passive: true });

        function series() {
          const A = S.data?.coordinates || null;
          const P = S.pred?.predictions || null,
            L = S.pred?.lowerBounds || null,
            U = S.pred?.upperBounds || null;
          const nA = A ? A.length : 0,
            nP = P ? P.length : 0,
            n = S.nDimensions || ((A && A[0]?.length) || 0) ||
              ((P && P[0]?.length) || 0);
          return { A, P, L, U, nA, nP, n };
        }
        function viewRange(total) {
          const lvl = S.zoom.level || 1;
          const vis = Math.max(
            10,
            Math.round(total / Math.max(1, lvl)),
          );
          const st = cap(
            Math.round(S.zoom.offsetX),
            0,
            Math.max(0, total - vis),
          );
          S.zoom.visibleCount = vis;
          S.zoom.visibleStart = st;
          return { st, vis, en: st + vis };
        }
        function draw() {
          const r = cv.getBoundingClientRect();
          if (!r.width || !r.height) return;
          ctx.clearRect(0, 0, r.width, r.height);
          const { A, P, L, U, nA, nP, n } = series();
          const total = S.vizMode === "grid"
            ? (nA + nP || 0)
            : (nA + nP || 0);
          if (!total) return;
          const pad = 36,
            W = r.width,
            H = r.height,
            innerW = W - pad * 2,
            innerH = H - pad * 2;
          const { st, vis, en } = viewRange(total);
          const x = (i) => pad + (i - st) / (vis - 1 || 1) * innerW;
          const get = (arr, i, dim) =>
            arr && arr[i] ? arr[i][dim] : null;
          const dims = (S.vizMode === "grid")
            ? [...Array(n).keys()]
            : [S.selectedDim];
          const rows = S.vizMode === "grid"
            ? Math.ceil(Math.sqrt(n))
            : 1;
          const cols = S.vizMode === "grid" ? Math.ceil(n / rows) : 1;
          const cellW = innerW / cols, cellH = innerH / rows;
          for (let di = 0; di < dims.length; di++) {
            const d = dims[di],
              rr = S.vizMode === "grid" ? Math.floor(di / cols) : 0,
              cc = S.vizMode === "grid" ? di % cols : 0;
            const ox = pad + cc * cellW,
              oy = pad + rr * cellH,
              w = S.vizMode === "grid" ? cellW : h(innerW),
              hgt = S.vizMode === "grid" ? cellH : innerH;
            function h(v) {
              return v;
            }
            // collect y range from visible window
            let ymin = Infinity, ymax = -Infinity;
            for (let i = st; i < en; i++) {
              const v = i < nA ? get(A, i, d) : get(P, i - nA, d);
              const lo = i < nA ? null : get(L, i - nA, d),
                up = i < nA ? null : get(U, i - nA, d);
              if (v != null) {
                ymin = Math.min(ymin, v);
                ymax = Math.max(ymax, v);
              }
              if (lo != null && up != null) {
                ymin = Math.min(ymin, lo);
                ymax = Math.max(ymax, up);
              }
            }
            if (!isFinite(ymin) || !isFinite(ymax)) {
              ymin = -1;
              ymax = 1;
            }
            if (ymin === ymax) {
              ymin -= 1;
              ymax += 1;
            }
            const y = (v) =>
              oy + hgt - (v - ymin) / (ymax - ymin) * hgt;
            // bg + axes
            ctx.save();
            ctx.globalAlpha = 1;
            ctx.strokeStyle = "rgba(148,163,184,.35)";
            ctx.lineWidth = 1;
            ctx.strokeRect(ox, oy, w, hgt);
            // grid lines
            ctx.beginPath();
            for (let g = 1; g < 4; g++) {
              const yy = oy + g * hgt / 4;
              ctx.moveTo(ox, yy);
              ctx.lineTo(ox + w, yy);
            }
            ctx.stroke();
            // CI band (pred only)
            if (L && U && nP) {
              ctx.save();
              ctx.globalAlpha = .12;
              ctx.fillStyle = DC[d % 10];
              ctx.beginPath();
              let started = 0;
              for (let i = Math.max(st, nA); i < en; i++) {
                const j = i - nA,
                  lo = get(L, j, d),
                  up = get(U, j, d);
                if (lo == null || up == null) continue;
                const xx = ox + (i - st) / (vis - 1 || 1) * w;
                if (!started) {
                  ctx.moveTo(xx, y(up));
                  started = 1;
                } else ctx.lineTo(xx, y(up));
              }
              for (let i = en - 1; i >= Math.max(st, nA); i--) {
                const j = i - nA,
                  lo = get(L, j, d),
                  up = get(U, j, d);
                if (lo == null || up == null) continue;
                const xx = ox + (i - st) / (vis - 1 || 1) * w;
                ctx.lineTo(xx, y(lo));
              }
              if (started) {
                ctx.closePath();
                ctx.fill();
              }
              ctx.restore();
            }
            // actual line
            if (A && nA) {
              ctx.save();
              ctx.strokeStyle = DC[d % 10];
              ctx.lineWidth = 2;
              ctx.beginPath();
              let started = 0;
              for (let i = st; i < Math.min(en, nA); i++) {
                const v = get(A, i, d);
                if (v == null) continue;
                const xx = ox + (i - st) / (vis - 1 || 1) * w;
                const yy = y(v);
                if (!started) {
                  ctx.moveTo(xx, yy);
                  started = 1;
                } else ctx.lineTo(xx, yy);
              }
              ctx.stroke();
              ctx.restore();
            }
            // prediction dashed continuation
            if (P && nP) {
              ctx.save();
              ctx.strokeStyle = DC[d % 10];
              ctx.lineWidth = 2;
              ctx.setLineDash([6, 6]);
              ctx.beginPath();
              let started = 0;
              for (let i = Math.max(st, nA); i < en; i++) {
                const v = get(P, i - nA, d);
                if (v == null) continue;
                const xx = ox + (i - st) / (vis - 1 || 1) * w;
                const yy = y(v);
                if (!started) {
                  ctx.moveTo(xx, yy);
                  started = 1;
                } else ctx.lineTo(xx, yy);
              }
              ctx.stroke();
              ctx.restore();
            }
            // dim label
            ctx.save();
            ctx.fillStyle = "rgba(15,23,42,.85)";
            ctx.font = "700 12px ui-sans-serif,system-ui";
            const lab = "D" + (d + 1);
            ctx.fillText(lab, ox + 8, oy + 16);
            ctx.restore();
            // hover/crosshair only for focus/snapshot
            if (S.vizMode !== "grid" && S.hover.active) {
              const i = S.hover.dataIndex;
              if (i >= st && i < en) {
                const xx = pad + (i - st) / (vis - 1 || 1) * innerW;
                const vv = i < nA ? get(A, i, d) : get(P, i - nA, d);
                if (vv != null) {
                  const yy = pad + innerH -
                    (vv - ymin) / (ymax - ymin) * innerH;
                  ctx.save();
                  ctx.strokeStyle = "rgba(15,23,42,.25)";
                  ctx.lineWidth = 1;
                  ctx.beginPath();
                  ctx.moveTo(xx, pad);
                  ctx.lineTo(xx, pad + innerH);
                  ctx.moveTo(pad, yy);
                  ctx.lineTo(pad + innerW, yy);
                  ctx.stroke();
                  ctx.fillStyle = DC[d % 10];
                  ctx.shadowColor = DC[d % 10];
                  ctx.shadowBlur = 12;
                  ctx.beginPath();
                  ctx.arc(xx, yy, 4, 0, Math.PI * 2);
                  ctx.fill();
                  ctx.restore();
                }
              }
            }
            ctx.restore();
          }
          E("zoomBadge").textContent =
            Math.round((S.zoom.level || 1) * 100) + "%";
        }
        function statsForDim(d) {
          const { A, P, L, U, nA, nP } = series();
          const take = (arr) =>
            arr
              ? arr.map((v) => v[d]).filter((x) => Number.isFinite(x))
              : [];
          const a = take(A), p = take(P), all = [...a, ...p];
          if (!all.length) return null;
          const min = Math.min(...all),
            max = Math.max(...all),
            mean = all.reduce((s, x) => s + x, 0) / all.length;
          const fin = p.length
            ? p[p.length - 1]
            : a.length
            ? a[a.length - 1]
            : 0;
          const first = a.length ? a[0] : (p.length ? p[0] : 0);
          const ch = fin - first;
          const conf = S.pred?.confidence ?? null;
          return { min, max, mean, fin, ch, conf };
        }
        function renderStats() {
          if (!S.pred && !S.data) {
            E("stats").innerHTML = "";
            return;
          }
          const d = S.selectedDim || 0, st = statsForDim(d);
          if (!st) {
            E("stats").innerHTML = "";
            return;
          }
          const up = st.ch >= 0;
          const conf = st.conf != null
            ? Math.round(st.conf * 100)
            : null;
          const cards = [
            ["MIN", st.min],
            ["MAX", st.max],
            ["MEAN", st.mean],
            ["FINAL", st.fin],
            [
              "TREND",
              `${up ? "‚Üë" : "‚Üì"} ${Math.abs(st.ch).toFixed(4)}`,
              up ? "text-emerald-600" : "text-red-600",
            ],
            ["CONF", conf != null ? conf + "%" : "‚Äî"],
          ];
          E("stats").innerHTML = cards.map(([k, v, cl]) =>
            `<div class="p-2 rounded-xl bg-white/70 border border-slate-200 shadow-sm"><div class="text-[10px] uppercase font-extrabold text-slate-500">${k}</div><div class="mt-1 font-extrabold ${
              cl || ""
            }">${typeof v === "number" ? fmtE(v) : v}</div></div>`
          ).join("");
        }
        function renderDimRow() {
          const n = S.nDimensions || 0;
          const el = E("dimRow");
          if (S.vizMode !== "focus" || n < 2) {
            el.classList.add("hidden");
            el.innerHTML = "";
            return;
          }
          el.classList.remove("hidden");
          el.innerHTML = [...Array(n).keys()].map((i) => {
            const act = i === S.selectedDim;
            const c = Dbg[i % 10];
            return `<button data-dim="${i}" class="px-3 py-2 rounded-xl text-sm font-extrabold border ${
              act
                ? `${c} text-white border-transparent shadow`
                : "bg-slate-100 text-slate-700 border-slate-200"
            }" aria-label="Select dimension D${i + 1}">D${
              i + 1
            }</button>`;
          }).join("");
          el.querySelectorAll("button").forEach((b) =>
            b.onclick = () => {
              S.selectedDim = +b.dataset.dim;
              renderStats();
              draw();
            }
          );
        }

        function renderBadge() {
          const ex = S.modelExists;
          E("dot").className = "w-2.5 h-2.5 rounded-full " +
            (ex ? "bg-emerald-500" : "bg-slate-400");
          E("badgeTxt").textContent = ex
            ? `${S.sampleCount || 0} steps`
            : "No Model";
          E("btnPredictTop").classList.toggle("hidden", !ex);
          E("btnPredict").disabled = !ex;
        }
        function renderLog() {
          const f = E("logFilter").value,
            q = E("logSearch").value.trim().toLowerCase();
          const col = {
            Info: "bg-blue-50 text-blue-700 border-blue-100",
            Success:
              "bg-emerald-50 text-emerald-700 border-emerald-100",
            Warning: "bg-amber-50 text-amber-700 border-amber-100",
            Error: "bg-red-50 text-red-700 border-red-100",
          };
          const items = S.logs.filter((x) =>
            (f === "All" || x.k === f) &&
            (!q || x.m.toLowerCase().includes(q))
          ).slice(0, 50);
          E("logList").innerHTML =
            items.map((x) =>
              `<div class="p-3 rounded-xl border ${
                col[x.k] ||
                "bg-slate-50 border-slate-200 text-slate-700"
              }"><div class="flex items-center justify-between"><div class="text-[10px] uppercase font-extrabold tracking-widest">${x.k}</div><div class="text-[10px] text-slate-500">${
                ar(x.ts)
              }</div></div><div class="mt-1 text-sm font-semibold">${
                ar(x.m)
              }</div></div>`
            ).join("") ||
            `<div class="p-4 rounded-xl bg-slate-50 border border-slate-200 text-sm text-slate-600">No entries.</div>`;
        }
        function renderMain() {
          const has = S.data || S.pred;
          E("empty").classList.toggle("hidden", !!has);
          E("chartWrap").classList.toggle("hidden", !has);
          E("floatCtrls").classList.toggle("hidden", !S.pred);
          E("snapRow").classList.toggle(
            "hidden",
            S.vizMode !== "snapshot",
          );
          renderDimRow();
          renderStats();
          renderBadge();
          if (has) sz();
        }

        function setTab(mode) {
          S.vizMode = mode;
          vPersist();
          $$(".tab").forEach((b) => {
            const on = b.dataset.tab === mode;
            b.className =
              "tab px-3 py-2 rounded-xl whitespace-nowrap text-sm font-semibold " +
              (on
                ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
                : "bg-slate-100 text-slate-700");
          });
          renderMain();
        }

        function validateCoords(coords) {
          if (!Array.isArray(coords) || !coords.length) {
            throw Error("coordinates must be a non-empty array");
          }
          const n = coords[0]?.length;
          if (!(n > 0)) {
            throw Error(
              "Each coordinate must be an array of numbers",
            );
          }
          coords.forEach((row, i) => {
            if (!Array.isArray(row) || row.length !== n) {
              throw Error(
                "Row " + i + " has inconsistent dimensions",
              );
            }
            row.forEach((v, j) => {
              if (!Number.isFinite(+v)) {
                throw Error(`Non-number at row ${i}, col ${j}`);
              }
            });
          });
          return { nDimensions: n, sampleCount: coords.length };
        }

        async function ensureInit() {
          try {
            await rpc("init", {});
            log("Info", "Engine initialized");
          } catch (e) {
            toast("Error", "Init failed: " + (e.message || e));
            log("Error", "Init failed: " + (e.message || e));
          }
        }
        async function createModel() {
          try {
            setLoading(
              1,
              "Creating model‚Ä¶",
              "Applying configuration",
              10,
            );
            await rpc("createModel", { config: S.config });
            const sum = (await rpc("getSummary", {})).summary;
            S.modelExists = 1;
            S.sampleCount = sum?.sampleCount || S.sampleCount || 0;
            toast("Success", "Model created");
            log("Success", "Model created");
          } catch (e) {
            toast(
              "Error",
              "Create model failed: " + (e.message || e),
            );
            log("Error", "Create model failed: " + (e.message || e));
          } finally {
            setLoading(0);
            renderBadge();
            renderMain();
          }
        }
        async function trainOn(coords, why) {
          try {
            setLoading(1, "Training‚Ä¶", why || "Fitting online", 0);
            const r = await rpc(
              "train",
              { coordinates: coords },
              (d) => {
                setProg(d.pct || 0);
                if (d.metrics) {
                  S.metrics = d.metrics;
                  S.sampleCount = d.metrics.samplesProcessed ||
                    S.sampleCount;
                  renderBadge();
                  renderMetrics();
                }
              },
            );
            if (r.metrics) {
              S.metrics = r.metrics;
              S.sampleCount = r.metrics.samplesProcessed ||
                S.sampleCount;
            }
            S.modelExists = 1;
            toast("Success", "Training complete");
            log("Success", "Training complete");
          } catch (e) {
            toast("Error", "Training failed: " + (e.message || e));
            log("Error", "Training failed: " + (e.message || e));
          } finally {
            setLoading(0);
            renderBadge();
            renderMetrics();
            renderMain();
          }
        }
        function renderMetrics() {
          E("mSamples").textContent = S.metrics.samplesProcessed ??
            S.sampleCount ?? 0;
          E("mLoss").textContent = fmtE(S.metrics.averageLoss || 0);
          E("mGrad").textContent = fmtE(S.metrics.gradientNorm || 0);
          E("mW").textContent = (S.metrics.sampleWeight ?? 1).toFixed(
            3,
          );
        }
        async function predict(n) {
          try {
            n = +n;
            if (!(n > 0)) throw Error("Future steps must be > 0");
            setLoading(1, "Predicting‚Ä¶", "Generating forecasts", 10);
            const r = await rpc("predict", { futureSteps: n });
            S.pred = r.result;
            toast("Success", "Prediction ready");
            log("Success", "Prediction ready");
          } catch (e) {
            toast("Error", "Predict failed: " + (e.message || e));
            log("Error", "Predict failed: " + (e.message || e));
          } finally {
            setLoading(0);
            renderMain();
            draw();
          }
        }
        async function saveModel(downloadOnly) {
          try {
            if (!S.modelExists) throw Error("No model");
            setLoading(1, "Saving‚Ä¶", "Serializing model", 20);
            const s = (await rpc("save", {})).state;
            const pack = {
              name: "ESN Studio Model",
              ts: Date.now(),
              config: S.config,
              meta: {
                nDimensions: S.nDimensions,
                sampleCount: S.sampleCount,
              },
              state: s,
            };
            if (downloadOnly) {
              const a = document.createElement("a");
              a.href = URL.createObjectURL(
                new Blob([JSON.stringify(pack)], {
                  type: "application/json",
                }),
              );
              a.download = "esn-model.json";
              a.click();
              toast("Success", "Downloaded model JSON");
              log("Success", "Downloaded model JSON");
            } else {
              const nm = prompt(
                "Name this model:",
                `Model ${new Date().toLocaleString()}`,
              );
              if (!nm) throw Error("Cancelled");
              const all = ls.g("esn_models", {});
              all[nm] = pack;
              ls.s("esn_models", all);
              toast("Success", "Saved to browser");
              log("Success", "Saved model to localStorage");
            }
          } catch (e) {
            toast("Error", "Save failed: " + (e.message || e));
            log("Error", "Save failed: " + (e.message || e));
          } finally {
            setLoading(0);
          }
        }
        async function loadPack(pack) {
          try {
            if (!pack?.state) throw Error("Invalid model file");
            setLoading(1, "Loading‚Ä¶", "Restoring model", 20);
            S.config = Object.assign({}, DEF, pack.config || {});
            vPersist();
            await rpc("load", {
              config: S.config,
              state: pack.state,
            });
            S.modelExists = 1;
            S.nDimensions = pack.meta?.nDimensions || S.nDimensions;
            S.sampleCount = pack.meta?.sampleCount || S.sampleCount;
            const sum = (await rpc("getSummary", {})).summary;
            if (sum?.sampleCount != null) {
              S.sampleCount = sum.sampleCount;
            }
            toast("Success", "Model loaded");
            log("Success", "Model loaded");
          } catch (e) {
            toast("Error", "Load failed: " + (e.message || e));
            log("Error", "Load failed: " + (e.message || e));
          } finally {
            setLoading(0);
            renderBadge();
            renderMain();
          }
        }

        function cfgModal() {
          const sec = (id, title, items) =>
            `<div class="rounded-2xl border border-slate-200 overflow-hidden">
    <button class="w-full px-4 py-3 bg-slate-50 flex items-center justify-between font-extrabold" data-coll="${id}" aria-label="Toggle ${title}">${title}<span aria-hidden="true">‚ñº</span></button>
    <div class="p-4 space-y-3" id="sec_${id}">${items}</div></div>`;
          const n = (k, min, step, help) =>
            `<div><label class="text-xs font-bold text-slate-600" for="cfg_${k}">${k}</label>
    <input id="cfg_${k}" type="number" step="${step ?? "any"}" ${
              min != null ? `min="${min}"` : ""
            } value="${
              S.config[k]
            }" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" aria-label="${k}"/>
    <div class="text-xs text-slate-500 mt-1">${
              help || ""
            }</div></div>`;
          const t = (k, help) =>
            `<label class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200 bg-white" aria-label="${k}">
    <div><div class="font-extrabold text-sm">${k}</div><div class="text-xs text-slate-500">${
              help || ""
            }</div></div>
    <input id="cfg_${k}" type="checkbox" ${
              S.config[k] ? "checked" : ""
            } class="w-5 h-5" aria-label="${k} toggle"/></label>`;
          const sel = (k, opts, help) =>
            `<div><label class="text-xs font-bold text-slate-600" for="cfg_${k}">${k}</label>
    <select id="cfg_${k}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" aria-label="${k}">
      ${
              opts.map((o) =>
                `<option ${
                  S.config[k] === o ? "selected" : ""
                }>${o}</option>`
              ).join("")
            }
    </select><div class="text-xs text-slate-500 mt-1">${
              help || ""
            }</div></div>`;
          const presets =
            `<div class="flex gap-2 overflow-x-auto pb-2" aria-label="Presets">
    ${
              [
                ["start", "Start Here", "bg-blue-500"],
                ["fast", "Fast", "bg-slate-900"],
                ["balanced", "Balanced", "bg-indigo-600"],
                ["accurate", "Accurate", "bg-emerald-600"],
                ["adaptive", "Adaptive", "bg-amber-500"],
                ["robust", "Robust", "bg-red-500"],
              ].map(([k, l, c]) =>
                `<button data-pre="${k}" class="px-3 py-2 rounded-xl text-white font-extrabold shadow ${c} whitespace-nowrap" aria-label="Preset ${l}">${l}</button>`
              ).join("")
            }
  </div>`;
          const body = presets + `<div class="space-y-3">
    ${
            sec(
              "res",
              "Reservoir Architecture",
              [
                n("reservoirSize", 1, 1, "Neurons in reservoir"),
                n("spectralRadius", 0, 0.01, "Memory length control"),
                n("leakRate", 0, 0.01, "Temporal smoothing"),
                n("inputScale", 0, 0.01, "Input scaling factor"),
                n("biasScale", 0, 0.01, "Bias scaling"),
                n("reservoirSparsity", 0, 0.01, "Zero connections"),
                n("inputSparsity", 0, 0.01, "Input sparsity"),
                sel(
                  "activation",
                  ["tanh", "relu"],
                  "Activation function",
                ),
              ].join(""),
            )
          }
    ${
            sec(
              "rd",
              "Readout Configuration",
              [
                t("useInputInReadout", "Append input to state"),
                t("useBiasInReadout", "Include bias term"),
                `<div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs font-extrabold text-slate-600">readoutTraining</div><div class="mt-1 font-extrabold">rls</div></div>`,
              ].join(""),
            )
          }
    ${
            sec(
              "rls",
              "Training (RLS)",
              [
                n("rlsLambda", 0, 0.001, "Forgetting factor"),
                n("rlsDelta", 0, 0.01, "Initial P diagonal"),
                n("epsilon", 0, 1e-8, "Numerical stability"),
                n("l2Lambda", 0, 0.0001, "L2 regularization"),
                n("gradientClipNorm", 0, 0.1, "Max update norm"),
              ].join(""),
            )
          }
    ${
            sec(
              "norm",
              "Normalization",
              [
                n(
                  "normalizationEpsilon",
                  0,
                  1e-8,
                  "Stability constant",
                ),
                n("normalizationWarmup", 0, 1, "Warmup samples"),
              ].join(""),
            )
          }
    ${
            sec(
              "out",
              "Outlier Handling",
              [
                n("outlierThreshold", 0, 0.1, "Z-score threshold"),
                n("outlierMinWeight", 0, 0.01, "Outlier min weight"),
              ].join(""),
            )
          }
    ${
            sec(
              "unc",
              "Uncertainty",
              [
                n(
                  "uncertaintyMultiplier",
                  0,
                  0.01,
                  "CI Multiplier (1.96 = 95% CI)",
                ),
              ].join(""),
            )
          }
    ${
            sec(
              "init",
              "Initialization",
              [
                n("weightInitScale", 0, 0.01, "Initial weight scale"),
                n("seed", 0, 1, "Random seed"),
                t("verbose", "Detailed logging"),
              ].join(""),
            )
          }
  </div>
  <div class="mt-4 flex flex-wrap gap-2 justify-end">
    <button id="cfgResetDef" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 font-bold" aria-label="Reset defaults">Reset Defaults</button>
    <button id="cfgResetAll" class="px-4 py-2 rounded-xl bg-red-500 text-white font-bold" aria-label="Reset all">Reset All</button>
    <button id="cfgCancel" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 font-bold" aria-label="Cancel config">Cancel</button>
    <button id="cfgCreate" class="px-4 py-2 rounded-xl text-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 font-extrabold" aria-label="Create model">Create Model</button>
  </div>`;
          openModal("cfg", "Configuration", body);
          // collapsibles
          $$("[data-coll]").forEach((b) =>
            b.onclick = () => {
              const id = b.dataset.coll, sec = E("sec_" + id);
              const open = !sec.classList.contains("hidden");
              sec.classList.toggle("hidden", open);
              b.lastElementChild.textContent = open ? "‚ñº" : "‚ñ≤";
            }
          );
          // presets
          $$("[data-pre]").forEach((b) =>
            b.onclick = () => {
              Object.assign(S.config, PRE[b.dataset.pre] || {});
              toast("Info", "Preset applied");
              cfgModal();
            }
          );
          // actions
          E("cfgCancel").onclick = closeModal;
          E("cfgResetDef").onclick = () => {
            S.config = Object.assign({}, DEF);
            vPersist();
            toast("Success", "Defaults restored");
            cfgModal();
          };
          E("cfgResetAll").onclick = async () => {
            S.config = Object.assign({}, DEF);
            vPersist();
            try {
              await rpc("reset", {});
              S.modelExists = 0;
              S.sampleCount = 0;
              S.metrics = {
                samplesProcessed: 0,
                averageLoss: 0,
                gradientNorm: 0,
                driftDetected: false,
                sampleWeight: 1,
              };
              S.pred = null;
              toast("Success", "Reset complete");
              log("Success", "Reset all");
            } catch (e) {
              toast("Error", "Reset failed");
              log("Error", "Reset failed");
            } finally {
              closeModal();
              renderMain();
              renderMetrics();
              renderBadge();
            }
          };
          E("cfgCreate").onclick = async () => {
            try {
              // read back inputs
              Object.keys(DEF).forEach((k) => {
                const el = E("cfg_" + k);
                if (!el) return;
                if (el.type === "checkbox") {
                  S.config[k] = !!el.checked;
                } else if (el.tagName === "SELECT") {
                  S.config[k] = el.value;
                } else {
                  const v = +el.value;
                  if (!Number.isFinite(v)) {
                    throw Error("Invalid number: " + k);
                  }
                  S.config[k] = v;
                }
              });
              vPersist();
              closeModal();
              await createModel();
            } catch (e) {
              toast("Error", e.message || String(e));
              log("Error", "Config error: " + (e.message || e));
            }
          };
        }
        function uploadModal() {
          const ex = `{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}`;
          openModal(
            "upload",
            "Upload Dataset",
            `
  <div class="space-y-4">
    <div id="drop" class="p-6 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 text-center" aria-label="Drop zone">
      <div class="text-4xl" aria-hidden="true">üìÅ</div>
      <div class="mt-2 font-extrabold">Drop JSON file here or tap to browse</div>
      <div class="text-sm text-slate-600 mt-1">Expected: {"coordinates":[[...],[...]]}</div>
      <input id="file" type="file" accept=".json,application/json" class="hidden" aria-label="File input"/>
      <button id="browse" class="mt-4 px-4 py-2 rounded-xl bg-white border border-slate-200 font-bold" aria-label="Browse file">Browse</button>
    </div>
    <div>
      <div class="text-xs font-extrabold tracking-widest text-slate-500">PASTE JSON</div>
      <textarea id="paste" class="mt-2 w-full min-h-[140px] px-3 py-2 rounded-xl border border-slate-200 font-mono text-xs" placeholder='{"coordinates":[[...]]}' aria-label="Paste JSON"></textarea>
    </div>
    <details class="rounded-2xl border border-slate-200 bg-white p-3">
      <summary class="font-extrabold cursor-pointer" aria-label="Format example">Format Example</summary>
      <pre class="mt-3 text-xs font-mono bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto">${
              ar(ex)
            }</pre>
      <button id="copyEx" class="mt-2 px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 font-bold" aria-label="Copy example">Copy example</button>
    </details>
    <div id="valBox" class="hidden p-3 rounded-2xl border" aria-label="Validation feedback"></div>
    <div class="flex justify-end gap-2">
      <button id="upCancel" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 font-bold" aria-label="Cancel upload">Cancel</button>
      <button id="upVal" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-extrabold" aria-label="Validate upload">Validate</button>
      <button id="upApply" class="px-4 py-2 rounded-xl text-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-600 font-extrabold disabled:opacity-40" disabled aria-label="Apply and train">Apply & Train</button>
    </div>
  </div>`,
          );
          let parsed = null;
          const show = (ok, msg) => {
            const b = E("valBox");
            b.classList.remove("hidden");
            b.className = `p-3 rounded-2xl border ${
              ok
                ? "bg-emerald-50 border-emerald-200 text-emerald-800"
                : "bg-red-50 border-red-200 text-red-800"
            }`;
            b.textContent = msg;
          };
          const parse = () => {
            const t = E("paste").value.trim();
            if (!t) throw Error("Paste JSON or upload a file");
            const j = JSON.parse(t);
            if (!j?.coordinates) {
              throw Error("Missing coordinates field");
            }
            const info = validateCoords(j.coordinates);
            parsed = j;
            show(
              1,
              `‚úÖ Valid: ${info.nDimensions} dimensions, ${info.sampleCount} time steps`,
            );
            E("upApply").disabled = false;
          };
          const setText = (txt) => {
            E("paste").value = txt;
          };
          E("copyEx").onclick = async () => {
            try {
              await navigator.clipboard.writeText(ex);
              toast("Success", "Copied example");
            } catch {
              toast("Error", "Clipboard blocked");
            }
          };
          E("upCancel").onclick = closeModal;
          E("upVal").onclick = () => {
            try {
              parse();
            } catch (e) {
              show(0, e.message || String(e));
              E("upApply").disabled = true;
            }
          };
          E("upApply").onclick = async () => {
            try {
              if (!parsed) parse();
              S.data = parsed;
              const info = validateCoords(S.data.coordinates);
              S.nDimensions = info.nDimensions;
              S.sampleCount = info.sampleCount;
              S.selectedDim = 0;
              S.pred = null;
              S.zoom.level = 1;
              S.zoom.offsetX = 0;
              closeModal();
              if (!S.modelExists) await createModel();
              await trainOn(
                S.data.coordinates,
                "Training on uploaded data‚Ä¶",
              );
              renderMain();
            } catch (e) {
              toast("Error", e.message || String(e));
              log("Error", "Apply/train failed: " + (e.message || e));
            }
          };
          const drop = E("drop"), file = E("file");
          E("browse").onclick = () => file.click();
          drop.onclick = () => file.click();
          file.onchange = async () => {
            try {
              const f = file.files?.[0];
              if (!f) return;
              const txt = await f.text();
              setText(txt);
              toast("Info", "File loaded. Click Validate.");
            } catch (e) {
              toast("Error", "Read failed");
            }
          };
          const hi = (on) =>
            drop.classList.toggle("border-indigo-400", on);
          ["dragenter", "dragover"].forEach((ev) =>
            drop.addEventListener(ev, (e) => {
              e.preventDefault();
              hi(1);
            }, { passive: false })
          );
          ["dragleave", "drop"].forEach((ev) =>
            drop.addEventListener(ev, (e) => {
              e.preventDefault();
              hi(0);
            }, { passive: false })
          );
          drop.addEventListener("drop", async (e) => {
            try {
              const f = e.dataTransfer.files?.[0];
              if (!f) return;
              setText(await f.text());
              toast("Info", "Dropped file loaded. Click Validate.");
            } catch {
              toast("Error", "Drop read failed");
            }
          }, { passive: false });
        }
        function saveModal() {
          const all = ls.g("esn_models", {});
          const keys = Object.keys(all);
          openModal(
            "save",
            "Save & Load",
            `
  <div class="space-y-6">
    <div class="rounded-2xl border border-slate-200 p-4 bg-white">
      <div class="font-extrabold flex items-center gap-2"><span aria-hidden="true">üì•</span> Download</div>
      <div class="text-sm text-slate-600 mt-1">Download model JSON file.</div>
      <button id="dl" class="mt-3 px-4 py-2 rounded-xl text-white shadow-lg bg-gradient-to-r from-emerald-500 to-teal-500 font-extrabold disabled:opacity-40" ${
              S.modelExists ? "" : "disabled"
            } aria-label="Download model">Download</button>
      <button id="sv" class="mt-3 ml-2 px-4 py-2 rounded-xl bg-white border border-slate-200 font-extrabold disabled:opacity-40" ${
              S.modelExists ? "" : "disabled"
            } aria-label="Save to browser">Save to Browser</button>
    </div>

    <div class="rounded-2xl border border-slate-200 p-4 bg-white">
      <div class="font-extrabold flex items-center gap-2"><span aria-hidden="true">üì§</span> Load</div>
      <div class="mt-3 p-5 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 text-center" id="loadZone" aria-label="Load zone">
        <div class="text-3xl" aria-hidden="true">üì§</div>
        <div class="mt-2 font-extrabold">Tap to upload model JSON</div>
        <input id="loadFile" type="file" accept=".json,application/json" class="hidden" aria-label="Load file input"/>
      </div>

      <div class="mt-4">
        <div class="text-xs font-extrabold tracking-widest text-slate-500">SAVED MODELS</div>
        <div class="mt-2 space-y-2">${
              keys.length
                ? keys.map((k) => {
                  const m = all[k],
                    nd = m?.meta?.nDimensions ?? "‚Äî",
                    sc = m?.meta?.sampleCount ?? "‚Äî";
                  return `<div class="p-3 rounded-2xl border border-slate-200 bg-white flex items-center gap-2">
            <div class="flex-1 min-w-0">
              <div class="font-extrabold truncate">${ar(k)}</div>
              <div class="text-xs text-slate-600">Dims: ${nd} ‚Ä¢ Steps: ${sc}</div>
            </div>
            <button data-ld="${
                    ar(k)
                  }" class="px-3 py-2 rounded-xl text-white bg-emerald-500 font-extrabold" aria-label="Load ${
                    ar(k)
                  }">Load</button>
            <button data-del="${
                    ar(k)
                  }" class="px-3 py-2 rounded-xl bg-red-500 text-white font-extrabold" aria-label="Delete ${
                    ar(k)
                  }">Delete</button>
          </div>`;
                }).join("")
                : `<div class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm text-slate-600">No saved models.</div>`
            }</div>
      </div>
    </div>

    <div class="flex justify-end"><button id="closeSave" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 font-extrabold" aria-label="Close">Close</button></div>
  </div>`,
          );
          E("closeSave").onclick = closeModal;
          E("dl").onclick = () => saveModel(true);
          E("sv").onclick = () => saveModel(false);
          const z = E("loadZone"), fi = E("loadFile");
          z.onclick = () => fi.click();
          fi.onchange = async () => {
            try {
              const f = fi.files?.[0];
              if (!f) return;
              const txt = await f.text();
              await loadPack(JSON.parse(txt));
              closeModal();
            } catch (e) {
              toast("Error", "Invalid model file");
              log("Error", "Load file error: " + (e.message || e));
            }
          };
          $$("[data-ld]").forEach((b) =>
            b.onclick = async () => {
              await loadPack(all[b.dataset.ld]);
              closeModal();
            }
          );
          $$("[data-del]").forEach((b) =>
            b.onclick = () => {
              const k = b.dataset.del;
              if (confirm("Delete " + k + "?")) {
                delete all[k];
                ls.s("esn_models", all);
                toast("Success", "Deleted");
                saveModal();
              }
            }
          );
        }
        function randModal() {
          openModal(
            "rand",
            "Random Test",
            `
  <div class="space-y-4">
    <div class="grid grid-cols-2 gap-3">
      <div><label class="text-xs font-bold text-slate-600">Seed</label><input id="r_seed" type="number" value="42" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Seed"/></div>
      <div><label class="text-xs font-bold text-slate-600">Dimensions</label><input id="r_dim" type="number" min="1" value="3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Dimensions"/></div>
      <div><label class="text-xs font-bold text-slate-600">Time Steps</label><input id="r_t" type="number" min="10" value="200" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Time steps"/></div>
      <div><label class="text-xs font-bold text-slate-600">Noise</label><input id="r_noise" type="number" min="0" step="0.01" value="0.1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Noise"/></div>
      <div><label class="text-xs font-bold text-slate-600">Outliers rate</label><input id="r_out" type="number" min="0" step="0.01" value="0.02" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Outliers rate"/></div>
      <div><label class="text-xs font-bold text-slate-600">Difficulty</label>
        <select id="r_diff" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" aria-label="Difficulty">
          <option>Easy</option><option selected>Medium</option><option>Hard</option>
        </select>
      </div>
    </div>
    <div class="flex justify-end gap-2">
      <button id="r_cancel" class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 font-extrabold" aria-label="Cancel">Cancel</button>
      <button id="r_go" class="px-4 py-2 rounded-xl text-white shadow-lg bg-gradient-to-r from-purple-600 to-pink-500 font-extrabold" aria-label="Generate and run">Generate & Run</button>
    </div>
  </div>`,
          );
          E("r_cancel").onclick = closeModal;
          E("r_go").onclick = async () => {
            try {
              let seed = +E("r_seed").value | 0,
                d = +E("r_dim").value | 0,
                T = +E("r_t").value | 0,
                noise = +E("r_noise").value,
                out = +E("r_out").value,
                diff = E("r_diff").value;
              if (!(d > 0 && T > 10)) {
                throw Error("Invalid dimensions/steps");
              }
              // simple RNG
              let x = seed >>> 0;
              const rnd =
                () => ((x = (x * 1664525 + 1013904223) >>> 0) /
                  4294967296);
              const k = diff === "Easy"
                ? 0.6
                : diff === "Hard"
                ? 1.3
                : 1.0;
              const coords = [];
              const freq = [...Array(d).keys()].map((i) =>
                0.03 * k * (i + 1)
              );
              const phase = [...Array(d).keys()].map(() =>
                rnd() * Math.PI * 2
              );
              let drift = 0;
              for (let t = 0; t < T; t++) {
                drift += (rnd() - .5) * 0.01 * k;
                const row = [];
                for (let i = 0; i < d; i++) {
                  let v = Math.sin((t + drift) * freq[i] + phase[i]) +
                    0.6 *
                      Math.cos(
                        (t + drift) * freq[i] * 0.5 + phase[i] * 0.3,
                      );
                  v += (rnd() - .5) * noise * k;
                  if (rnd() < out) {
                    v += (rnd() > .5 ? 1 : -1) * (2 + 4 * rnd()) * k;
                  }
                  row.push(v);
                }
                coords.push(row);
              }
              S.data = { coordinates: coords };
              const info = validateCoords(coords);
              S.nDimensions = info.nDimensions;
              S.sampleCount = info.sampleCount;
              S.selectedDim = 0;
              S.pred = null;
              S.zoom.level = 1;
              S.zoom.offsetX = 0;
              closeModal();
              if (!S.modelExists) await createModel();
              await trainOn(coords, "Training on synthetic data‚Ä¶");
              renderMain();
              toast("Success", "Random test complete");
              log("Success", "Random test complete");
            } catch (e) {
              toast("Error", e.message || String(e));
              log("Error", "Random test error: " + (e.message || e));
            }
          };
        }
        function tableModal() {
          const { P, L, U, nP, n } = series();
          if (!P) {
            toast("Warning", "No predictions to show");
            log("Warning", "Table open blocked: no predictions");
            return;
          }
          const rows = [...Array(nP).keys()].map((i) => ({
            Step: i + 1,
            Pred: P[i],
            Lo: L?.[i],
            Up: U?.[i],
          }));
          const headers = ["Step", ...Array(n).keys()].map((i) =>
            "P" + (i + 1)
          ).concat(Array(n).keys().map((i) => "L" + (i + 1))).concat(
            Array(n).keys().map((i) => "U" + (i + 1)),
          );
          const getCell = (row, h) => {
            if (h === "Step") return row.Step;
            const t = h[0], idx = (+h.slice(1)) - 1;
            const arr = t === "P"
              ? row.Pred
              : t === "L"
              ? row.Lo
              : row.Up;
            return arr?.[idx];
          };
          const build = () => {
            const q = S.table.q.toLowerCase();
            let filtered = rows.filter((r) => {
              if (!q) return true;
              if (String(r.Step).includes(q)) return true;
              for (let i = 0; i < n; i++) {
                const v = r.Pred?.[i];
                if (v != null && String(v).includes(q)) return true;
              }
              return false;
            });
            const k = S.table.k, dir = S.table.dir;
            filtered.sort((a, b) => {
              const va = getCell(a, k), vb = getCell(b, k);
              if (va == null && vb == null) return 0;
              if (va == null) return 1;
              if (vb == null) return -1;
              return (va > vb ? 1 : va < vb ? -1 : 0) * dir;
            });
            return filtered;
          };
          const renderT = () => {
            const filtered = build();
            E("tblBody").innerHTML = filtered.map((r) => {
              const cells = headers.map((h) =>
                `<td class="px-3 py-2 whitespace-nowrap">${
                  h === "Step" ? r.Step : fmtE(getCell(r, h))
                }</td>`
              ).join("");
              return `<tr class="odd:bg-slate-50 hover:bg-indigo-50">${cells}</tr>`;
            }).join("");
          };
          openModal(
            "table",
            "Data Table",
            `
  <div class="space-y-3">
    <div class="flex gap-2 items-center">
      <input id="tblQ" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Search/filter‚Ä¶" aria-label="Table search"/>
      <button id="csv" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-extrabold" aria-label="Export CSV">üìä Export CSV</button>
      <button id="copyAll" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-extrabold" aria-label="Copy all">üìã Copy All</button>
    </div>
    <div class="rounded-2xl border border-slate-200 overflow-auto max-h-[70vh]">
      <table class="min-w-full text-xs font-mono" aria-label="Prediction table">
        <thead class="sticky top-0 bg-white border-b border-slate-200"><tr>
          ${
              headers.map((h) =>
                `<th data-h="${h}" class="px-3 py-2 text-left font-extrabold cursor-pointer">${h}${
                  S.table.k === h
                    ? (S.table.dir > 0 ? " ‚ñ≤" : " ‚ñº")
                    : ""
                }</th>`
              ).join("")
            }
        </tr></thead>
        <tbody id="tblBody"></tbody>
      </table>
    </div>
  </div>`,
          );
          E("tblQ").value = S.table.q;
          E("tblQ").oninput = () => {
            S.table.q = E("tblQ").value;
            renderT();
          };
          $$("[data-h]").forEach((th) =>
            th.onclick = () => {
              const k = th.dataset.h;
              S.table.dir = S.table.k === k ? -S.table.dir : 1;
              S.table.k = k;
              tableModal();
            }
          );
          const toCSV = () => {
            const filtered = build();
            const lines = [headers.join(",")].concat(
              filtered.map((r) =>
                headers.map((h) => {
                  const v = getCell(r, h);
                  return v == null
                    ? ""
                    : (typeof v === "number" ? String(v) : String(v))
                      .replaceAll('"', '""');
                }).map((s) => `"${s}"`).join(",")
              ),
            );
            return lines.join("\n");
          };
          E("csv").onclick = () => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(
              new Blob([toCSV()], { type: "text/csv" }),
            );
            a.download = "predictions.csv";
            a.click();
            toast("Success", "CSV exported");
          };
          E("copyAll").onclick = async () => {
            try {
              await navigator.clipboard.writeText(toCSV());
              toast("Success", "Copied CSV");
            } catch {
              toast("Error", "Clipboard blocked");
            }
          };
          renderT();
        }

        function updateTip(px, py, hold) {
          const r = cv.getBoundingClientRect();
          const { A, P, L, U, nA, nP } = series();
          const total = nA + nP;
          if (!total) return;
          const pad = 36,
            innerW = r.width - pad * 2,
            innerH = r.height - pad * 2;
          const { st, vis, en } = viewRange(total);
          const relx = cap(px - pad, 0, innerW);
          const i = cap(
            Math.round(st + relx / innerW * (vis - 1 || 1)),
            0,
            total - 1,
          );
          S.hover.active = true;
          S.hover.dataIndex = i;
          const d = S.selectedDim || 0;
          const v = i < nA ? (A?.[i]?.[d]) : (P?.[i - nA]?.[d]);
          const lo = i < nA ? null : (L?.[i - nA]?.[d]);
          const up = i < nA ? null : (U?.[i - nA]?.[d]);
          const tip = E("tip");
          tip.classList.remove("hidden");
          tip.style.left = cap(px + 12, 8, r.width - 200) + "px";
          tip.style.top = cap(py + 12, 8, r.height - 120) + "px";
          E("tipStep").textContent = "Step " + (i + 1);
          E("tipDim").textContent = "D" + (d + 1);
          E("tipDot").className = "w-2.5 h-2.5 rounded-full " +
            Dbg[d % 10];
          E("tipVal").textContent = fmtE(v ?? 0);
          E("tipCI").textContent = (lo != null && up != null)
            ? `${fmtE(lo)} ‚Äì ${fmtE(up)}`
            : "‚Äî";
          E("tipSp").textContent = (lo != null && up != null)
            ? fmtE((up - lo) / 2)
            : "‚Äî";
          draw();
        }

        function hideTip() {
          S.hover.active = false;
          E("tip").classList.add("hidden");
          draw();
        }

        function zoomBy(f, centerX) {
          const old = S.zoom.level || 1;
          const nl = cap(old * f, 0.5, 20);
          if (nl === old) return;
          // keep center anchored
          const { A, P, nA, nP } = series();
          const total = nA + nP;
          if (!total) return;
          const { st, vis } = viewRange(total);
          const r = cv.getBoundingClientRect(),
            pad = 36,
            innerW = r.width - pad * 2;
          const cx = cap((centerX ?? (r.width / 2)) - pad, 0, innerW);
          const idx = st + cx / innerW * (vis - 1 || 1);
          S.zoom.level = nl;
          const { vis: vis2 } = viewRange(total);
          S.zoom.offsetX = idx - (cx / innerW) * (vis2 - 1 || 1);
          draw();
        }
        function panBy(dx) {
          const { A, P, nA, nP } = series();
          const total = nA + nP;
          if (!total) return;
          const r = cv.getBoundingClientRect(),
            pad = 36,
            innerW = r.width - pad * 2;
          const { vis } = viewRange(total);
          const di = dx / innerW * (vis - 1 || 1);
          S.zoom.offsetX = cap(
            S.zoom.offsetX - di,
            0,
            Math.max(0, total - vis),
          );
          draw();
        }

        let drag = null,
          holdT = null,
          pinch = null,
          vel = { vx: 0, last: 0 };
        cv.addEventListener("pointerdown", (e) => {
          cv.setPointerCapture(e.pointerId);
          if (e.pointerType === "touch") {
            if (!pinch) {
              pinch = {
                ids: new Set(),
                pts: new Map(),
                dist: 0,
                midX: 0,
              };
            }
            pinch.ids.add(e.pointerId);
            pinch.pts.set(e.pointerId, {
              x: e.clientX,
              y: e.clientY,
            });
            if (pinch.ids.size === 2) {
              const [a, b] = [...pinch.ids].map((id) =>
                pinch.pts.get(id)
              );
              pinch.dist = Math.hypot(a.x - b.x, a.y - b.y);
              pinch.midX = (a.x + b.x) / 2;
            }
          }
          drag = { x: e.clientX, y: e.clientY, t: performance.now() };
          vel = { vx: 0, last: drag.t };
          clearTimeout(holdT);
          holdT = setTimeout(() => {
            const r = cv.getBoundingClientRect();
            updateTip(e.clientX - r.left, e.clientY - r.top, true);
          }, 350);
        }, { passive: true });
        cv.addEventListener("pointermove", (e) => {
          const r = cv.getBoundingClientRect();
          const px = e.clientX - r.left, py = e.clientY - r.top;
          if (pinch && pinch.ids.has(e.pointerId)) {
            pinch.pts.set(e.pointerId, {
              x: e.clientX,
              y: e.clientY,
            });
            if (pinch.ids.size === 2) {
              const [a, b] = [...pinch.ids].map((id) =>
                pinch.pts.get(id)
              );
              const d = Math.hypot(a.x - b.x, a.y - b.y);
              const f = d / (pinch.dist || d);
              pinch.dist = d;
              zoomBy(f, (pinch.midX = (a.x + b.x) / 2) - r.left);
              clearTimeout(holdT);
              return;
            }
          }
          if (drag) {
            clearTimeout(holdT);
            const dx = e.clientX - drag.x;
            if ((S.zoom.level || 1) > 1) panBy(dx);
            const t = performance.now(), dt = t - vel.last || 16;
            vel.vx = 0.8 * vel.vx + 0.2 * (dx / dt);
            vel.last = t;
            drag.x = e.clientX;
            drag.y = e.clientY;
          } else if (S.vizMode !== "grid") {
            updateTip(px, py, false);
          }
        }, { passive: true });
        cv.addEventListener("pointerup", (e) => {
          clearTimeout(holdT);
          if (pinch && pinch.ids.has(e.pointerId)) {
            pinch.ids.delete(e.pointerId);
            pinch.pts.delete(e.pointerId);
            if (pinch.ids.size < 2) pinch.dist = 0;
          }
          if (drag) {
            // momentum (touch only) if zoomed
            const zoomed = (S.zoom.level || 1) > 1;
            const v = vel.vx * 16;
            if (
              zoomed && Math.abs(v) > 0.3 && e.pointerType === "touch"
            ) {
              let vx = v;
              const step = () => {
                vx *= 0.92;
                if (Math.abs(vx) < 0.2) return;
                panBy(vx);
                requestAnimationFrame(step);
              };
              requestAnimationFrame(step);
            }
            drag = null;
          } else hideTip();
        }, { passive: true });
        cv.addEventListener("pointercancel", () => {
          drag = null;
          pinch = null;
          clearTimeout(holdT);
          hideTip();
        }, { passive: true });
        cv.addEventListener("wheel", (e) => {
          e.preventDefault();
          const r = cv.getBoundingClientRect();
          zoomBy(e.deltaY < 0 ? 1.12 : 0.89, e.clientX - r.left);
        }, { passive: false });

        E("zIn").onclick = () => zoomBy(1.18);
        E("zOut").onclick = () => zoomBy(0.85);
        E("zReset").onclick = () => {
          S.zoom.level = 1;
          S.zoom.offsetX = 0;
          draw();
        };
        E("btnPNG").onclick = () => {
          try {
            const a = document.createElement("a");
            a.href = cv.toDataURL("image/png");
            a.download = "esn-chart.png";
            a.click();
            toast("Success", "PNG saved");
          } catch {
            toast("Error", "PNG export failed");
          }
        };
        E("btnSVG").onclick = () => {
          try {
            const { A, P, L, U, nA, nP } = series();
            const d = S.selectedDim || 0;
            const tot = nA + nP;
            if (!tot) throw Error("No data");
            const w = 900, h = 420, p = 40;
            const get = (arr, i) => arr?.[i]?.[d];
            const vals = [];
            for (let i = 0; i < tot; i++) {
              const v = i < nA ? get(A, i) : get(P, i - nA);
              if (v != null) vals.push(v);
            }
            let ymin = Math.min(...vals), ymax = Math.max(...vals);
            if (ymin === ymax) {
              ymin -= 1;
              ymax += 1;
            }
            const X = (i) => p + i / (tot - 1 || 1) * (w - 2 * p);
            const Y = (v) =>
              h - p - (v - ymin) / (ymax - ymin) * (h - 2 * p);
            const path = (arr, off, styleDash) => {
              let dstr = "";
              for (let i = 0; i < arr.length; i++) {
                const v = get(arr, i);
                if (v == null) continue;
                dstr += (dstr ? "L" : "M") + X(i + off) + "," + Y(v);
              }
              return dstr;
            };
            const pa = A ? path(A, 0, 0) : "";
            const pp = P ? path(P, nA, 1) : "";
            const svg =
              `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <rect x="0" y="0" width="${w}" height="${h}" fill="white"/>
      <rect x="${p}" y="${p}" width="${w - 2 * p}" height="${
                h - 2 * p
              }" fill="none" stroke="#cbd5e1"/>
      ${
                L && U
                  ? (() => {
                    let d1 = "", d2 = "";
                    for (let i = 0; i < nP; i++) {
                      const lo = L[i]?.[d], up = U[i]?.[d];
                      if (lo == null || up == null) continue;
                      d1 += (d1 ? "L" : "M") + X(nA + i) + "," +
                        Y(up);
                      d2 = "L" + X(nA + i) + "," + Y(lo) + " " + d2;
                    }
                    return `<path d="${d1 + " " + d2 + "Z"}" fill="${
                      DC[d % 10]
                    }" fill-opacity=".12" stroke="none"/>`;
                  })()
                  : ""
              }
      ${
                pa
                  ? `<path d="${pa}" fill="none" stroke="${
                    DC[d % 10]
                  }" stroke-width="3"/>`
                  : ""
              }
      ${
                pp
                  ? `<path d="${pp}" fill="none" stroke="${
                    DC[d % 10]
                  }" stroke-width="3" stroke-dasharray="10 8"/>`
                  : ""
              }
      <text x="${p + 8}" y="${
                p + 18
              }" font-family="ui-sans-serif,system-ui" font-size="14" font-weight="800" fill="#0f172a">D${
                d + 1
              }</text>
    </svg>`;
            const a = document.createElement("a");
            a.href = URL.createObjectURL(
              new Blob([svg], { type: "image/svg+xml" }),
            );
            a.download = "esn-chart.svg";
            a.click();
            toast("Success", "SVG saved");
          } catch (e) {
            toast("Error", "SVG export failed: " + (e.message || e));
          }
        };
        E("btnCopy").onclick = async () => {
          try {
            await navigator.clipboard.writeText(
              cv.toDataURL("image/png"),
            );
            toast("Success", "Copied PNG data URL");
          } catch {
            toast("Error", "Clipboard blocked");
          }
        };

        E("btnMenu").onclick = () => openDrawer(1);
        E("btnCloseMenu").onclick = () => openDrawer(0);
        E("drawerBg").onclick = () => openDrawer(0);
        $$("[data-open]").forEach((b) =>
          b.onclick = () => {
            openDrawer(0);
            ({
              cfg: cfgModal,
              save: saveModal,
              upload: uploadModal,
              rand: randModal,
              table: tableModal,
            }[b.dataset.open] || (() => {}))();
          }
        );

        E("btnCfg").onclick = cfgModal;
        E("btnDefaults").onclick = async () => {
          try {
            await ensureInit();
            await createModel();
          } catch {}
        };
        E("btnLoadOpen").onclick = () => saveModal();
        E("btnDemo").onclick = () => randModal();

        E("btnPredict").onclick = () => predict(E("future").value);
        E("btnPredictTop").onclick = () => predict(E("future").value);

        E("btnClrLog").onclick = () => {
          S.logs = [];
          renderLog();
          toast("Success", "Log cleared");
        };
        E("logFilter").onchange = renderLog;
        E("logSearch").oninput = renderLog;

        E("btnCancelOp").onclick = async () => {
          try {
            setLoading(0);
            if (S.opRid) await rpc("cancel", { rid: S.opRid });
            toast("Warning", "Cancelled");
            log("Warning", "Operation cancelled");
          } catch (e) {
            toast("Error", "Cancel failed");
            log("Error", "Cancel failed");
          }
        };

        $$(".tab").forEach((b) =>
          b.onclick = () => setTab(b.dataset.tab)
        );

        E("snapStep").oninput = () => {
          S.selectedStep = cap(+E("snapStep").value | 0, 0, 999999);
          S.hover.active = true;
          S.hover.dataIndex = S.selectedStep;
          draw();
        };

        function boot() {
          bindWorker();
          ensureInit();
          setTab(S.vizMode || "grid");
          renderMetrics();
          renderBadge();
          renderLog();
          renderMain();
          log("Info", "Ready");
        }
        boot();
      </script>
    </div>
  </body>
</html>
