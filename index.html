<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwindcss.config = {
        darkMode: "class",
        theme: { extend: {} },
      };
    </script>
  </head>
  <body
    class="bg-slate-100 dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen"
  >
    <div id="app" class="flex flex-col min-h-screen">
      <!-- Header -->
      <header
        class="sticky top-0 z-40 backdrop-blur-lg bg-white/80 dark:bg-slate-900/80 border-b border-slate-200/50 dark:border-slate-700/50"
      >
        <div class="flex items-center justify-between px-4 py-3">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30"
            >
              <span class="text-xl">üìä</span>
            </div>
            <div>
              <h1 class="font-bold text-slate-900 dark:text-slate-100">
                ESN Studio
              </h1>
              <p class="text-xs text-slate-500 dark:text-slate-400">
                Autoregressive Forecasting
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div
              id="statusBadge"
              class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-700/50"
            >
              <span
                id="statusDot"
                class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
              ></span>
              <span
                id="statusText"
                class="text-xs font-medium text-slate-600 dark:text-slate-300"
              >No Model</span>
            </div>
            <button
              id="predictBtn"
              class="hidden px-3 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium shadow-lg"
              aria-label="Run prediction"
            >
              ‚ö° Predict
            </button>
            <button
              id="configBtn"
              class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 text-xl"
              aria-label="Configure model"
            >
              ‚öôÔ∏è
            </button>
            <button
              id="menuBtn"
              class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 text-xl"
              aria-label="Open menu"
            >
              ‚ò∞
            </button>
            <button
              id="themeBtn"
              class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 text-xl"
              aria-label="Toggle theme"
            >
              üåô
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col p-4 gap-4">
        <!-- Viz Mode Tabs -->
        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          <button
            data-mode="grid"
            class="viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
            aria-label="Grid view"
          >
            üìä Grid
          </button>
          <button
            data-mode="focus"
            class="viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
            aria-label="Focus view"
          >
            üîç Focus
          </button>
          <button
            data-mode="heatmap"
            class="viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
            aria-label="Heatmap view"
          >
            üå°Ô∏è Heatmap
          </button>
          <button
            data-mode="uncertainty"
            class="viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
            aria-label="Uncertainty view"
          >
            üìà CI
          </button>
          <button
            data-mode="snapshot"
            class="viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
            aria-label="Snapshot view"
          >
            üì∑ Snapshot
          </button>
        </div>

        <!-- Dimension Selector -->
        <div id="dimSelector" class="hidden flex gap-2 overflow-x-auto pb-2">
          <!-- Populated dynamically -->
        </div>

        <!-- Step Selector -->
        <div id="stepSelector" class="hidden flex items-center gap-2">
          <label class="text-sm font-medium text-slate-700 dark:text-slate-300"
          >Step:</label>
          <input
            type="number"
            id="stepInput"
            min="1"
            value="1"
            class="w-20 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
          >
        </div>

        <!-- Chart Container -->
        <div
          class="relative flex-1 min-h-64 bg-white dark:bg-slate-800/50 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
        >
          <!-- Zoom Badge -->
          <div
            id="zoomBadge"
            class="hidden absolute top-3 left-3 px-2 py-1 rounded-lg bg-slate-900/70 text-white text-xs font-medium z-10"
          >
            100%
          </div>

          <!-- Zoom Controls -->
          <div
            id="zoomControls"
            class="hidden absolute top-3 right-3 flex gap-1 z-10"
          >
            <button
              id="zoomIn"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Zoom in"
            >
              ‚ûï
            </button>
            <button
              id="zoomOut"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Zoom out"
            >
              ‚ûñ
            </button>
            <button
              id="zoomReset"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Reset zoom"
            >
              üîÑ
            </button>
          </div>

          <!-- Export Controls -->
          <div
            id="exportControls"
            class="hidden absolute bottom-3 right-3 flex gap-1 z-10"
          >
            <button
              id="exportPng"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Export PNG"
            >
              üñºÔ∏è
            </button>
            <button
              id="exportSvg"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Export SVG"
            >
              üìÑ
            </button>
            <button
              id="copyClip"
              class="p-2 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow text-sm"
              aria-label="Copy to clipboard"
            >
              üìã
            </button>
          </div>

          <!-- Canvas -->
          <canvas id="chartCanvas" class="w-full h-full"></canvas>

          <!-- Empty State -->
          <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center p-6"
          >
            <div class="relative mb-6">
              <div
                class="w-32 h-32 rounded-3xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center"
              >
                <div
                  class="w-24 h-24 rounded-2xl bg-gradient-to-br from-blue-500/30 to-purple-500/30 flex items-center justify-center"
                >
                  <span class="text-5xl">üìä</span>
                </div>
              </div>
            </div>
            <h2
              class="text-xl font-bold text-slate-900 dark:text-slate-100 text-center mb-2"
            >
              Create a Model to Begin
            </h2>
            <p
              class="text-sm text-slate-500 dark:text-slate-400 text-center mb-6 max-w-xs"
            >
              ESN autoregressive forecasting with online learning for time
              series prediction
            </p>
            <div class="flex flex-wrap gap-3 justify-center">
              <button
                id="startDefaultBtn"
                class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg"
              >
                ‚ö° Start with Defaults
              </button>
              <button
                id="loadEmptyBtn"
                class="px-5 py-2.5 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              >
                üì§ Load
              </button>
              <button
                id="demoBtn"
                class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium shadow-lg"
              >
                ‚ú® Demo
              </button>
            </div>
          </div>

          <!-- Loading Overlay -->
          <div
            id="loadingOverlay"
            class="hidden absolute inset-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur flex flex-col items-center justify-center z-20"
          >
            <div
              class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"
            >
            </div>
            <p
              id="loadingText"
              class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-4"
            >
              Processing...
            </p>
            <div
              class="w-48 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-4"
            >
              <div
                id="progressBar"
                class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300"
                style="width: 0%"
              >
              </div>
            </div>
            <span
              id="progressText"
              class="text-xs text-slate-500 dark:text-slate-400 mb-4"
            >0%</span>
            <button
              id="cancelBtn"
              class="px-4 py-2 rounded-xl bg-red-500 text-white text-sm font-medium"
            >
              Cancel
            </button>
          </div>

          <!-- Tooltip -->
          <div
            id="tooltip"
            class="hidden absolute z-30 p-3 rounded-xl bg-slate-900 text-white text-sm shadow-xl pointer-events-none"
          >
            <div id="tooltipContent"></div>
          </div>
        </div>

        <!-- Stats Bar (Focus Mode) -->
        <div id="statsBar" class="hidden grid grid-cols-3 gap-2">
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Min
            </p>
            <p
              id="statMin"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Max
            </p>
            <p
              id="statMax"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Mean
            </p>
            <p
              id="statMean"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Final
            </p>
            <p
              id="statFinal"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Trend
            </p>
            <p
              id="statTrend"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
          <div
            class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
          >
            <p class="text-xs uppercase text-slate-500 dark:text-slate-400">
              Confidence
            </p>
            <p
              id="statConf"
              class="font-bold text-slate-900 dark:text-slate-100"
            >
              -
            </p>
          </div>
        </div>

        <!-- Side Panel -->
        <div
          class="bg-white dark:bg-slate-800/50 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-4"
        >
          <!-- Model Metrics -->
          <div class="mb-4">
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3"
            >
              Model Metrics
            </h3>
            <div class="grid grid-cols-2 gap-2">
              <div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Samples
                </p>
                <p
                  id="metricSamples"
                  class="font-bold text-blue-600 dark:text-blue-400"
                >
                  0
                </p>
              </div>
              <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Avg Loss
                </p>
                <p
                  id="metricLoss"
                  class="font-bold text-slate-900 dark:text-slate-100"
                >
                  -
                </p>
              </div>
              <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Grad Norm
                </p>
                <p
                  id="metricGrad"
                  class="font-bold text-slate-900 dark:text-slate-100"
                >
                  -
                </p>
              </div>
              <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                <p class="text-xs text-slate-500 dark:text-slate-400">Weight</p>
                <p
                  id="metricWeight"
                  class="font-bold text-slate-900 dark:text-slate-100"
                >
                  -
                </p>
              </div>
            </div>
          </div>

          <!-- Prediction -->
          <div class="mb-4">
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3"
            >
              Prediction
            </h3>
            <div class="flex gap-2">
              <input
                type="number"
                id="futureSteps"
                min="1"
                value="50"
                class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                placeholder="Future steps"
                aria-label="Future steps"
              >
              <button
                id="runPredictBtn"
                class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium disabled:opacity-50"
                disabled
                aria-label="Run prediction"
              >
                Run
              </button>
            </div>
          </div>

          <!-- Event Log -->
          <div>
            <div class="flex items-center justify-between mb-3">
              <h3
                class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400"
              >
                Event Log
              </h3>
              <select
                id="logFilter"
                class="text-xs px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-300"
                aria-label="Filter logs"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <input
              type="text"
              id="logSearch"
              placeholder="Search logs..."
              class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm mb-2"
              aria-label="Search logs"
            >
            <div
              id="logContainer"
              class="h-32 overflow-y-auto space-y-1 text-xs"
            >
              <!-- Logs populated dynamically -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Slide-Out Menu -->
    <div
      id="menuOverlay"
      class="hidden fixed inset-0 bg-black/50 z-50"
      aria-hidden="true"
    >
    </div>
    <div
      id="menuPanel"
      class="fixed top-0 right-0 h-full w-80 max-w-full bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300"
      role="dialog"
      aria-modal="true"
      aria-label="Main menu"
    >
      <div
        class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
      >
        <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
          Menu
        </h2>
        <button
          id="closeMenuBtn"
          class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
          aria-label="Close menu"
        >
          ‚úñÔ∏è
        </button>
      </div>
      <div class="p-4 space-y-6 overflow-y-auto h-full pb-24">
        <!-- Model Section -->
        <div>
          <p
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2"
          >
            üìÅ Model
          </p>
          <div class="space-y-2">
            <button
              id="menuConfig"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-xl"
              >üéõÔ∏è</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Create & Configure
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Set up model parameters
                </p>
              </div>
            </button>
            <button
              id="menuSaveLoad"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-xl"
              >üíæ</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Save & Load
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Persist your models
                </p>
              </div>
            </button>
          </div>
        </div>
        <!-- Data Section -->
        <div>
          <p
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2"
          >
            üìÇ Data
          </p>
          <div class="space-y-2">
            <button
              id="menuUpload"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-xl"
              >üì§</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Upload Dataset
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Import time series data
                </p>
              </div>
            </button>
            <button
              id="menuManual"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-xl"
              >‚ûï</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Manual Insert
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Add individual time steps
                </p>
              </div>
            </button>
          </div>
        </div>
        <!-- Test Section -->
        <div>
          <p
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2"
          >
            üß™ Test
          </p>
          <div class="space-y-2">
            <button
              id="menuRandom"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center text-xl"
              >üí°</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Random Test
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </div>
        <!-- Advanced Section -->
        <div>
          <p
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-2"
          >
            ‚öôÔ∏è Advanced
          </p>
          <div class="space-y-2">
            <button
              id="menuSettings"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
              >üîß</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Settings
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Module URL & preferences
                </p>
              </div>
            </button>
            <button
              id="menuDataTable"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
              >üìã</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  View Data Table
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Raw prediction values
                </p>
              </div>
            </button>
            <button
              id="menuHelp"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 text-left"
            >
              <span
                class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
              >‚ùì</span>
              <div>
                <p class="font-medium text-slate-900 dark:text-slate-100">
                  Help
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Documentation & examples
                </p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 left-4 right-4 z-50 space-y-2"
    >
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Model configuration"
    >
      <div class="absolute inset-0 bg-black/50" id="configModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            ‚öôÔ∏è Model Configuration
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <!-- Presets -->
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex gap-2 overflow-x-auto flex-shrink-0"
        >
          <button
            data-preset="default"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-500 text-white"
          >
            Start Here
          </button>
          <button
            data-preset="fast"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          >
            Fast
          </button>
          <button
            data-preset="balanced"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          >
            Balanced
          </button>
          <button
            data-preset="accurate"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          >
            Accurate
          </button>
          <button
            data-preset="adaptive"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          >
            Adaptive
          </button>
          <button
            data-preset="robust"
            class="preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          >
            Robust
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Reservoir Architecture -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="true"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Reservoir Architecture</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Reservoir Size <span class="text-slate-400"
                  >(Neurons)</span></label>
                <input
                  type="number"
                  id="cfg_reservoirSize"
                  value="256"
                  min="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Spectral Radius <span class="text-slate-400"
                  >(Memory length)</span></label>
                <input
                  type="number"
                  id="cfg_spectralRadius"
                  value="0.9"
                  step="0.01"
                  min="0"
                  max="2"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Leak Rate <span class="text-slate-400"
                  >(Temporal smoothing)</span></label>
                <input
                  type="number"
                  id="cfg_leakRate"
                  value="0.3"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Input Scale</label>
                <input
                  type="number"
                  id="cfg_inputScale"
                  value="1.0"
                  step="0.1"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Bias Scale</label>
                <input
                  type="number"
                  id="cfg_biasScale"
                  value="0.1"
                  step="0.01"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Reservoir Sparsity <span class="text-slate-400"
                  >(Zero connections)</span></label>
                <input
                  type="number"
                  id="cfg_reservoirSparsity"
                  value="0.9"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Input Sparsity</label>
                <input
                  type="number"
                  id="cfg_inputSparsity"
                  value="0.0"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Activation</label>
                <select
                  id="cfg_activation"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
                  <option value="tanh">tanh</option>
                  <option value="relu">relu</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Readout Configuration -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="true"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Readout Configuration</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-2 space-y-3">
              <div class="flex items-center justify-between">
                <label class="text-sm text-slate-600 dark:text-slate-400"
                >Use Input in Readout</label>
                <button
                  id="cfg_useInputInReadout"
                  class="toggle-switch w-12 h-6 rounded-full bg-blue-500 relative"
                  data-value="true"
                  aria-pressed="true"
                >
                  <span
                    class="absolute right-1 top-1 w-4 h-4 rounded-full bg-white transition-all"
                  ></span>
                </button>
              </div>
              <div class="flex items-center justify-between">
                <label class="text-sm text-slate-600 dark:text-slate-400"
                >Use Bias in Readout</label>
                <button
                  id="cfg_useBiasInReadout"
                  class="toggle-switch w-12 h-6 rounded-full bg-blue-500 relative"
                  data-value="true"
                  aria-pressed="true"
                >
                  <span
                    class="absolute right-1 top-1 w-4 h-4 rounded-full bg-white transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>
          <!-- Training (RLS) -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="true"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Training (RLS)</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Training Method</label>
                <input
                  type="text"
                  value="rls"
                  disabled
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-400"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >RLS Lambda <span class="text-slate-400"
                  >(Forgetting factor)</span></label>
                <input
                  type="number"
                  id="cfg_rlsLambda"
                  value="0.999"
                  step="0.001"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >RLS Delta <span class="text-slate-400"
                  >(Initial P diagonal)</span></label>
                <input
                  type="number"
                  id="cfg_rlsDelta"
                  value="1.0"
                  step="0.1"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Epsilon <span class="text-slate-400"
                  >(Numerical stability)</span></label>
                <input
                  type="number"
                  id="cfg_epsilon"
                  value="1e-8"
                  step="1e-9"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >L2 Lambda <span class="text-slate-400"
                  >(Regularization)</span></label>
                <input
                  type="number"
                  id="cfg_l2Lambda"
                  value="0.0001"
                  step="0.0001"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Gradient Clip Norm</label>
                <input
                  type="number"
                  id="cfg_gradientClipNorm"
                  value="1.0"
                  step="0.1"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
            </div>
          </div>
          <!-- Normalization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Normalization</span>
              <span class="toggle-icon">‚ñ≤</span>
            </button>
            <div class="section-content hidden mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Epsilon <span class="text-slate-400"
                  >(Stability constant)</span></label>
                <input
                  type="number"
                  id="cfg_normalizationEpsilon"
                  value="1e-8"
                  step="1e-9"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Warmup Samples</label>
                <input
                  type="number"
                  id="cfg_normalizationWarmup"
                  value="10"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
            </div>
          </div>
          <!-- Outlier Handling -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Outlier Handling</span>
              <span class="toggle-icon">‚ñ≤</span>
            </button>
            <div class="section-content hidden mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Threshold <span class="text-slate-400">(Z-score)</span></label>
                <input
                  type="number"
                  id="cfg_outlierThreshold"
                  value="3.0"
                  step="0.1"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Min Weight</label>
                <input
                  type="number"
                  id="cfg_outlierMinWeight"
                  value="0.1"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
            </div>
          </div>
          <!-- Uncertainty -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Uncertainty</span>
              <span class="toggle-icon">‚ñ≤</span>
            </button>
            <div class="section-content hidden mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >CI Multiplier <span class="text-slate-400"
                  >(1.96 = 95%)</span></label>
                <input
                  type="number"
                  id="cfg_uncertaintyMultiplier"
                  value="1.96"
                  step="0.01"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
            </div>
          </div>
          <!-- Initialization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900 dark:text-slate-100"
              >Initialization</span>
              <span class="toggle-icon">‚ñ≤</span>
            </button>
            <div class="section-content hidden mt-2 space-y-3">
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Weight Init Scale</label>
                <input
                  type="number"
                  id="cfg_weightInitScale"
                  value="0.1"
                  step="0.01"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div>
                <label
                  class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
                >Random Seed</label>
                <input
                  type="number"
                  id="cfg_seed"
                  value="42"
                  min="0"
                  class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                >
              </div>
              <div class="flex items-center justify-between">
                <label class="text-sm text-slate-600 dark:text-slate-400"
                >Verbose Logging</label>
                <button
                  id="cfg_verbose"
                  class="toggle-switch w-12 h-6 rounded-full bg-slate-300 dark:bg-slate-600 relative"
                  data-value="false"
                  aria-pressed="false"
                >
                  <span
                    class="absolute left-1 top-1 w-4 h-4 rounded-full bg-white transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Footer -->
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2 flex-shrink-0"
        >
          <button
            id="resetDefaults"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Reset Defaults
          </button>
          <button
            id="resetAll"
            class="px-4 py-2 rounded-xl bg-red-500 text-white text-sm font-medium"
          >
            Reset All
          </button>
          <div class="flex-1"></div>
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
          <button
            id="createModelBtn"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium shadow-lg"
          >
            Create Model
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Upload dataset"
    >
      <div class="absolute inset-0 bg-black/50" id="uploadModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            üì§ Upload Dataset
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div
            id="dropZone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-8 text-center hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer"
          >
            <span class="text-4xl mb-2 block">üìÅ</span>
            <p class="text-slate-600 dark:text-slate-400">
              Drop JSON file here or tap to browse
            </p>
            <input type="file" id="fileInput" accept=".json" class="hidden">
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >Or paste JSON:</label>
            <textarea
              id="jsonPaste"
              rows="4"
              class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-mono text-sm"
              placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
            ></textarea>
          </div>
          <details class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-3">
            <summary
              class="cursor-pointer text-sm font-medium text-slate-700 dark:text-slate-300"
            >
              Format Example
            </summary>
            <div class="mt-2">
              <pre
                id="formatExample"
                class="text-xs bg-slate-100 dark:bg-slate-800 p-2 rounded-lg overflow-x-auto font-mono"
              >
{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</pre>
              <button
                id="copyExample"
                class="mt-2 text-xs text-blue-500 hover:text-blue-600"
              >
                üìã Copy example
              </button>
            </div>
          </details>
          <div id="uploadValidation" class="hidden">
            <div
              id="uploadSuccess"
              class="hidden p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800"
            >
              <p class="text-sm text-emerald-700 dark:text-emerald-300">
                <span id="uploadDims"></span> dimensions, <span
                  id="uploadSteps"
                ></span> time steps ‚úÖ
              </p>
            </div>
            <div
              id="uploadError"
              class="hidden p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
            >
              <p
                id="uploadErrorText"
                class="text-sm text-red-700 dark:text-red-300"
              >
              </p>
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
          <button
            id="validateUpload"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Validate
          </button>
          <button
            id="applyUpload"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium shadow-lg disabled:opacity-50"
            disabled
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="manualModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Manual insert"
    >
      <div class="absolute inset-0 bg-black/50" id="manualModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            ‚ûï Manual Insert
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Add time series data manually. Requires at least 2 coordinates per
            call.
          </p>
          <button
            id="genTemplate"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Generate Template
          </button>
          <textarea
            id="manualJson"
            rows="6"
            class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-mono text-sm"
            placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
          ></textarea>
          <div id="manualValidation" class="hidden">
            <div
              id="manualSuccess"
              class="hidden p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800"
            >
              <p class="text-sm text-emerald-700 dark:text-emerald-300">
                Valid data ‚úÖ
              </p>
            </div>
            <div
              id="manualError"
              class="hidden p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
            >
              <p
                id="manualErrorText"
                class="text-sm text-red-700 dark:text-red-300"
              >
              </p>
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
          <button
            id="insertTrain"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium shadow-lg"
          >
            Insert & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Save and load"
    >
      <div class="absolute inset-0 bg-black/50" id="saveLoadModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            üíæ Save & Load
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <!-- Save Section -->
          <div>
            <h3
              class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3"
            >
              Save Model
            </h3>
            <div class="flex gap-2">
              <button
                id="downloadModel"
                class="flex-1 p-3 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-center"
              >
                <span class="text-2xl block mb-1">üì•</span>
                <span class="text-sm text-slate-700 dark:text-slate-300"
                >Download</span>
              </button>
              <button
                id="saveLocal"
                class="flex-1 p-3 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-center"
              >
                <span class="text-2xl block mb-1">üíæ</span>
                <span class="text-sm text-slate-700 dark:text-slate-300"
                >Browser</span>
              </button>
            </div>
          </div>
          <!-- Load Section -->
          <div>
            <h3
              class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3"
            >
              Load Model
            </h3>
            <div
              id="loadDropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-6 text-center hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer mb-4"
            >
              <span class="text-2xl">üì§</span>
              <p class="text-sm text-slate-600 dark:text-slate-400">
                Tap to upload model file
              </p>
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="hidden"
              >
            </div>
            <div id="savedModelsList" class="space-y-2">
              <!-- Populated dynamically -->
            </div>
            <button
              id="clearSaved"
              class="mt-3 text-xs text-red-500 hover:text-red-600"
            >
              Clear all saved models
            </button>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Random test"
    >
      <div class="absolute inset-0 bg-black/50" id="randomModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            üí° Random Test
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Seed</label>
              <input
                type="number"
                id="rand_seed"
                value="42"
                min="0"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
            </div>
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Dimensions</label>
              <input
                type="number"
                id="rand_dims"
                value="3"
                min="1"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
            </div>
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Time Steps</label>
              <input
                type="number"
                id="rand_steps"
                value="200"
                min="10"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
            </div>
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Noise</label>
              <input
                type="number"
                id="rand_noise"
                value="0.1"
                step="0.01"
                min="0"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
            </div>
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Outlier Rate</label>
              <input
                type="number"
                id="rand_outliers"
                value="0.02"
                step="0.01"
                min="0"
                max="1"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
            </div>
            <div>
              <label
                class="block text-sm text-slate-600 dark:text-slate-400 mb-1"
              >Difficulty</label>
              <select
                id="rand_difficulty"
                class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              >
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Cancel
          </button>
          <button
            id="generateRandom"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm font-medium shadow-lg"
          >
            Generate & Run
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Settings"
    >
      <div class="absolute inset-0 bg-black/50" id="settingsModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            üîß Settings
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >Module URL</label>
            <input
              type="text"
              id="moduleUrl"
              class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-mono text-xs"
            >
          </div>
          <button
            id="reinitWorker"
            class="w-full px-4 py-2 rounded-xl bg-amber-500 text-white text-sm font-medium"
          >
            Reinitialize Worker
          </button>
          <button
            id="clearPrefs"
            class="w-full px-4 py-2 rounded-xl bg-red-500 text-white text-sm font-medium"
          >
            Clear All Preferences
          </button>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 z-50 flex flex-col bg-white dark:bg-slate-900"
      role="dialog"
      aria-modal="true"
      aria-label="Data table"
    >
      <div
        class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
      >
        <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
          üìã Data Table
        </h2>
        <div class="flex gap-2">
          <button
            id="exportCsv"
            class="px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-sm"
            aria-label="Export CSV"
          >
            üìä CSV
          </button>
          <button
            id="copyAll"
            class="px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-sm"
            aria-label="Copy all"
          >
            üìã Copy
          </button>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
      </div>
      <div class="p-4 flex-shrink-0">
        <input
          type="text"
          id="tableSearch"
          placeholder="Search..."
          class="w-full px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm"
          aria-label="Search table"
        >
      </div>
      <div class="flex-1 overflow-auto p-4 pt-0">
        <table class="w-full text-xs font-mono">
          <thead
            id="tableHead"
            class="sticky top-0 bg-slate-100 dark:bg-slate-800"
          >
            <!-- Populated dynamically -->
          </thead>
          <tbody id="tableBody">
            <!-- Populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-modal="true"
      aria-label="Help"
    >
      <div class="absolute inset-0 bg-black/50" id="helpModalOverlay"></div>
      <div
        class="relative w-full max-w-lg max-h-[90vh] bg-white dark:bg-slate-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900 dark:text-slate-100">
            ‚ùì Help
          </h2>
          <button
            class="modal-close p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-xl"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div
          class="flex-1 overflow-y-auto p-4 space-y-6 text-sm text-slate-700 dark:text-slate-300"
        >
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Worker Setup
            </h3>
            <p class="mb-2">
              The ESNRegression library runs in a Web Worker for non-blocking
              performance.
            </p>
            <p
              class="font-mono text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded-lg break-all"
            >
              Module URL:
              https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3
            </p>
          </div>
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Creating a Model
            </h3>
            <pre
              class="text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded-lg overflow-x-auto"
            >const model = new ESNRegression(config);</pre>
          </div>
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Online Training (fitOnline)
            </h3>
            <pre
              class="text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded-lg overflow-x-auto"
            >
model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call
// Returns: { averageLoss, gradientNorm, sampleWeight }</pre>
          </div>
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Prediction
            </h3>
            <pre
              class="text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded-lg overflow-x-auto"
            >
const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</pre>
          </div>
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Save/Load
            </h3>
            <pre
              class="text-xs bg-slate-100 dark:bg-slate-700 p-2 rounded-lg overflow-x-auto"
            >
const state = model.save();
model.load(state);</pre>
          </div>
          <div>
            <h3 class="font-semibold text-slate-900 dark:text-slate-100 mb-2">
              Preset Configurations
            </h3>
            <ul class="space-y-1 text-xs">
              <li>
                <strong>Start Here:</strong> reservoirSize=256,
                spectralRadius=0.9, leakRate=0.3
              </li>
              <li>
                <strong>Fast:</strong> reservoirSize=64, reservoirSparsity=0.95
              </li>
              <li>
                <strong>Balanced:</strong> reservoirSize=256, spectralRadius=0.9
              </li>
              <li>
                <strong>Accurate:</strong> reservoirSize=512,
                spectralRadius=0.95, leakRate=0.2
              </li>
              <li>
                <strong>Adaptive:</strong> rlsLambda=0.97, spectralRadius=0.85,
                leakRate=0.5
              </li>
              <li>
                <strong>Robust:</strong> outlierThreshold=2.0,
                outlierMinWeight=0.05, l2Lambda=0.01
              </li>
            </ul>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end flex-shrink-0"
        >
          <button
            class="modal-close px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // Dimension colors
      const DIM_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      // Default config
      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        default: { ...DEFAULT_CONFIG },
        fast: {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        balanced: {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        accurate: {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      // Application state
      let state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 1,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
      };

      // Worker and request tracking
      let worker = null;
      let requestId = 0;
      let pendingRequests = {};
      let currentOperation = null;
      let uploadedData = null;

      // Module URL
      const DEFAULT_MODULE_URL =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3";

      // Load persisted state
      function loadPersistedState() {
        try {
          const saved = localStorage.getItem("esn_state");
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.config) {
              state.config = { ...DEFAULT_CONFIG, ...parsed.config };
            }
            if (parsed.vizMode) state.vizMode = parsed.vizMode;
            if (typeof parsed.isDark === "boolean") {
              state.isDark = parsed.isDark;
            }
          }
          const moduleUrl = localStorage.getItem("esn_module_url");
          if (moduleUrl) {
            document.getElementById("moduleUrl").value = moduleUrl;
          }
        } catch (e) {
          console.error("Failed to load state:", e);
        }
      }

      function savePersistedState() {
        try {
          localStorage.setItem(
            "esn_state",
            JSON.stringify({
              config: state.config,
              vizMode: state.vizMode,
              isDark: state.isDark,
            }),
          );
        } catch (e) {
          console.error("Failed to save state:", e);
        }
      }

      // Theme
      function applyTheme() {
        if (state.isDark) {
          document.documentElement.classList.add("dark");
          document.getElementById("themeBtn").textContent = "‚òÄÔ∏è";
        } else {
          document.documentElement.classList.remove("dark");
          document.getElementById("themeBtn").textContent = "üåô";
        }
        savePersistedState();
        renderChart();
      }

      // Toast notifications
      function showToast(message, type = "info", duration = 4000) {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };
        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between`;
        toast.innerHTML =
          `<span>${message}</span><button class="ml-3 text-white/80 hover:text-white">‚úñÔ∏è</button>`;
        toast.querySelector("button").onclick = () => toast.remove();
        container.appendChild(toast);
        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : duration,
        );
      }

      // Logging
      function addLog(message, type = "info") {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        state.logs.unshift({
          message,
          type,
          timestamp,
          time: now.getTime(),
        });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = document.getElementById("logContainer");
        const filter = document.getElementById("logFilter").value;
        const search = document.getElementById("logSearch").value
          .toLowerCase();
        const filtered = state.logs.filter((l) =>
          (filter === "all" || l.type === filter) &&
          (!search || l.message.toLowerCase().includes(search))
        ).slice(0, 50);

        container.innerHTML = filtered.map((l) => {
          const colors = {
            info: "text-blue-500",
            success: "text-emerald-500",
            warning: "text-amber-500",
            error: "text-red-500",
          };
          return `<div class="py-1 border-b border-slate-100 dark:border-slate-700/50">
                <span class="${
            colors[l.type]
          } font-medium uppercase">${l.type}</span>
                <span class="text-slate-400 ml-2">${l.timestamp}</span>
                <p class="text-slate-700 dark:text-slate-300">${l.message}</p>
            </div>`;
        }).join("");
      }

      // Worker initialization
      function initWorker() {
        const moduleUrl = document.getElementById("moduleUrl")?.value ||
          localStorage.getItem("esn_module_url") || DEFAULT_MODULE_URL;

        const workerCode = `
            let ESNRegression = null;
            let model = null;
            let cancelled = false;

            self.onmessage = async function(e) {
                const { type, data, id } = e.data;
                cancelled = false;

                try {
                    switch(type) {
                        case 'init':
                            const module = await import('${moduleUrl}');
                            ESNRegression = module.ESNRegression;
                            self.postMessage({ type: 'result', id, success: true, data: { initialized: true } });
                            break;

                        case 'createModel':
                            model = new ESNRegression(data.config);
                            self.postMessage({ type: 'result', id, success: true, data: { created: true } });
                            break;

                        case 'train':
                            if (!model) throw new Error('No model created');
                            const coords = data.coordinates;
                            const batchSize = Math.max(2, Math.min(10, Math.floor(coords.length / 10)));
                            let result = null;
                            
                            for (let i = 0; i < coords.length - 1; i += batchSize) {
                                if (cancelled) {
                                    self.postMessage({ type: 'result', id, success: false, error: 'Cancelled' });
                                    return;
                                }
                                const batch = coords.slice(i, Math.min(i + batchSize + 1, coords.length));
                                if (batch.length >= 2) {
                                    result = model.fitOnline({ coordinates: batch });
                                }
                                const progress = Math.min(100, Math.round(((i + batchSize) / coords.length) * 100));
                                self.postMessage({ type: 'progress', id, progress });
                            }
                            
                            const summary = model.getModelSummary();
                            self.postMessage({ type: 'result', id, success: true, data: { 
                                metrics: result, 
                                nFeatures: summary.nFeatures,
                                sampleCount: summary.sampleCount 
                            }});
                            break;

                        case 'predict':
                            if (!model) throw new Error('No model created');
                            const predictions = model.predict(data.steps);
                            self.postMessage({ type: 'result', id, success: true, data: predictions });
                            break;

                        case 'save':
                            if (!model) throw new Error('No model created');
                            const state = model.save();
                            self.postMessage({ type: 'result', id, success: true, data: state });
                            break;

                        case 'load':
                            if (!model) model = new ESNRegression({});
                            model.load(data.state);
                            const loadSummary = model.getModelSummary();
                            self.postMessage({ type: 'result', id, success: true, data: { 
                                nFeatures: loadSummary.nFeatures,
                                sampleCount: loadSummary.sampleCount 
                            }});
                            break;

                        case 'getSummary':
                            if (!model) throw new Error('No model created');
                            const summ = model.getModelSummary();
                            self.postMessage({ type: 'result', id, success: true, data: summ });
                            break;

                        case 'reset':
                            model = null;
                            self.postMessage({ type: 'result', id, success: true, data: { reset: true } });
                            break;

                        case 'cancel':
                            cancelled = true;
                            self.postMessage({ type: 'result', id, success: true, data: { cancelled: true } });
                            break;
                    }
                } catch (error) {
                    self.postMessage({ type: 'result', id, success: false, error: error.message });
                }
            };
        `;

        try {
          if (worker) worker.terminate();
          const blob = new Blob([workerCode], {
            type: "application/javascript",
          });
          worker = new Worker(URL.createObjectURL(blob), {
            type: "module",
          });

          worker.onmessage = (e) => {
            const { type, id, success, data, error, progress } = e.data;

            if (type === "progress") {
              updateProgress(progress);
              return;
            }

            if (type === "result" && pendingRequests[id]) {
              const { resolve, reject } = pendingRequests[id];
              delete pendingRequests[id];
              if (success) resolve(data);
              else reject(new Error(error));
            }
          };

          worker.onerror = (e) => {
            addLog(`Worker error: ${e.message}`, "error");
            showToast("Worker error occurred", "error");
          };

          sendWorkerMessage("init").then(() => {
            addLog("Worker initialized", "success");
          }).catch((e) => {
            addLog(`Worker init failed: ${e.message}`, "error");
            showToast("Failed to initialize worker", "error");
          });
        } catch (e) {
          addLog(`Worker creation failed: ${e.message}`, "error");
          showToast("Failed to create worker", "error");
        }
      }

      function sendWorkerMessage(type, data = {}) {
        return new Promise((resolve, reject) => {
          const id = ++requestId;
          pendingRequests[id] = { resolve, reject };
          worker.postMessage({ type, data, id });
        });
      }

      // UI Updates
      function updateUI() {
        // Status badge
        const dot = document.getElementById("statusDot");
        const text = document.getElementById("statusText");
        if (state.modelExists) {
          dot.className =
            "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
          text.textContent = `${state.sampleCount} steps`;
        } else {
          dot.className =
            "w-2 h-2 rounded-full bg-slate-400 animate-pulse";
          text.textContent = "No Model";
        }

        // Buttons
        document.getElementById("predictBtn").classList.toggle(
          "hidden",
          !state.modelExists,
        );
        document.getElementById("runPredictBtn").disabled = !state
          .modelExists;

        // Empty state
        document.getElementById("emptyState").classList.toggle(
          "hidden",
          state.predictions !== null,
        );

        // Zoom/export controls
        const hasData = state.predictions !== null;
        document.getElementById("zoomControls").classList.toggle(
          "hidden",
          !hasData,
        );
        document.getElementById("exportControls").classList.toggle(
          "hidden",
          !hasData,
        );
        document.getElementById("zoomBadge").classList.toggle(
          "hidden",
          !hasData,
        );

        // Stats bar
        document.getElementById("statsBar").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !hasData,
        );
        document.getElementById("dimSelector").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !hasData,
        );
        document.getElementById("stepSelector").classList.toggle(
          "hidden",
          state.vizMode !== "snapshot" || !hasData,
        );

        // Metrics
        document.getElementById("metricSamples").textContent =
          state.sampleCount || 0;
        document.getElementById("metricLoss").textContent =
          state.metrics.avgLoss?.toExponential(2) || "-";
        document.getElementById("metricGrad").textContent =
          state.metrics.gradientNorm?.toExponential(2) || "-";
        document.getElementById("metricWeight").textContent =
          state.metrics.sampleWeight?.toFixed(3) || "-";

        // Viz tabs
        document.querySelectorAll(".viz-tab").forEach((btn) => {
          const mode = btn.dataset.mode;
          if (mode === state.vizMode) {
            btn.className =
              "viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg";
          } else {
            btn.className =
              "viz-tab flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300";
          }
        });

        // Zoom badge
        document.getElementById("zoomBadge").textContent = `${
          Math.round(state.zoom.level * 100)
        }%`;

        renderDimSelector();
        updateFocusStats();
        renderChart();
      }

      function renderDimSelector() {
        const container = document.getElementById("dimSelector");
        if (!state.predictions || state.vizMode !== "focus") {
          container.innerHTML = "";
          return;
        }

        const nDims = state.predictions.predictions[0]?.length || 0;
        container.innerHTML = Array.from({ length: nDims }, (_, i) => {
          const color = DIM_COLORS[i % DIM_COLORS.length];
          const isActive = i === state.selectedDim;
          return `<button data-dim="${i}" class="dim-btn flex-shrink-0 px-4 py-2 rounded-xl text-sm font-medium ${
            isActive
              ? "text-white"
              : "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
          }" style="${isActive ? `background: ${color}` : ""}">D${
            i + 1
          }</button>`;
        }).join("");
      }

      function updateFocusStats() {
        if (state.vizMode !== "focus" || !state.predictions) return;

        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const lower = state.predictions.lowerBounds.map((l) => l[dim]);
        const upper = state.predictions.upperBounds.map((u) => u[dim]);

        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const first = preds[0];
        const trend = final - first;
        const avgSpread =
          upper.map((u, i) => u - lower[i]).reduce((a, b) => a + b, 0) /
          upper.length;
        const conf = state.predictions.confidence?.[dim] || 0.95;

        document.getElementById("statMin").textContent = min.toFixed(3);
        document.getElementById("statMax").textContent = max.toFixed(3);
        document.getElementById("statMean").textContent = mean.toFixed(
          3,
        );
        document.getElementById("statFinal").textContent = final
          .toFixed(3);
        document.getElementById("statTrend").innerHTML = trend >= 0
          ? `<span class="text-emerald-500">‚Üë ${
            Math.abs(trend).toFixed(3)
          }</span>`
          : `<span class="text-red-500">‚Üì ${
            Math.abs(trend).toFixed(3)
          }</span>`;
        document.getElementById("statConf").textContent = `${
          (conf * 100).toFixed(0)
        }%`;
      }

      // Chart rendering
      function renderChart() {
        const canvas = document.getElementById("chartCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

        const isDark = state.isDark;
        ctx.fillStyle = isDark ? "#1e293b" : "#ffffff";
        ctx.fillRect(0, 0, rect.width, rect.height);

        if (!state.predictions) return;

        const padding = { top: 30, right: 20, bottom: 40, left: 50 };
        const width = rect.width - padding.left - padding.right;
        const height = rect.height - padding.top - padding.bottom;

        switch (state.vizMode) {
          case "grid":
            renderGrid(ctx, padding, width, height, isDark);
            break;
          case "focus":
            renderFocus(ctx, padding, width, height, isDark);
            break;
          case "heatmap":
            renderHeatmap(ctx, padding, width, height, isDark);
            break;
          case "uncertainty":
            renderUncertainty(ctx, padding, width, height, isDark);
            break;
          case "snapshot":
            renderSnapshot(ctx, padding, width, height, isDark);
            break;
        }
      }

      function renderGrid(ctx, padding, width, height, isDark) {
        const preds = state.predictions.predictions;
        const nDims = preds[0]?.length || 0;
        const nSteps = preds.length;

        const cols = Math.ceil(Math.sqrt(nDims));
        const rows = Math.ceil(nDims / cols);
        const cellW = width / cols;
        const cellH = height / rows;
        const cellPad = 10;

        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = padding.left + col * cellW + cellPad;
          const y = padding.top + row * cellH + cellPad;
          const w = cellW - 2 * cellPad;
          const h = cellH - 2 * cellPad;

          const values = preds.map((p) => p[d]);
          const min = Math.min(...values);
          const max = Math.max(...values);
          const range = max - min || 1;

          ctx.strokeStyle = isDark ? "#475569" : "#e2e8f0";
          ctx.strokeRect(x, y, w, h);

          const color = DIM_COLORS[d % DIM_COLORS.length];
          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.beginPath();

          values.forEach((v, i) => {
            const px = x + (i / (nSteps - 1)) * w;
            const py = y + h - ((v - min) / range) * h;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          });
          ctx.stroke();

          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.fillText(`D${d + 1}`, x + 4, y + 12);
        }
      }

      function renderFocus(ctx, padding, width, height, isDark) {
        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const lower = state.predictions.lowerBounds.map((l) => l[dim]);
        const upper = state.predictions.upperBounds.map((u) => u[dim]);

        const allVals = [...preds, ...lower, ...upper];
        const min = Math.min(...allVals);
        const max = Math.max(...allVals);
        const range = max - min || 1;
        const nSteps = preds.length;

        const zoom = state.zoom.level;
        const visibleSteps = Math.ceil(nSteps / zoom);
        const offset = Math.min(
          state.zoom.offsetX,
          nSteps - visibleSteps,
        );
        const startIdx = Math.max(0, Math.floor(offset));
        const endIdx = Math.min(nSteps, startIdx + visibleSteps);

        const color = DIM_COLORS[dim % DIM_COLORS.length];

        // CI fill
        ctx.fillStyle = color + "20";
        ctx.beginPath();
        for (let i = startIdx; i < endIdx; i++) {
          const x = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * width;
          const y = padding.top + height -
            ((upper[i] - min) / range) * height;
          if (i === startIdx) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        for (let i = endIdx - 1; i >= startIdx; i--) {
          const x = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * width;
          const y = padding.top + height -
            ((lower[i] - min) / range) * height;
          ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();

        // Prediction line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = startIdx; i < endIdx; i++) {
          const x = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * width;
          const y = padding.top + height -
            ((preds[i] - min) / range) * height;
          if (i === startIdx) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Axes
        drawAxes(
          ctx,
          padding,
          width,
          height,
          isDark,
          min,
          max,
          startIdx,
          endIdx - 1,
        );

        // Hover
        if (
          state.hover.active && state.hover.dataIndex >= startIdx &&
          state.hover.dataIndex < endIdx
        ) {
          const i = state.hover.dataIndex;
          const x = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * width;
          const y = padding.top + height -
            ((preds[i] - min) / range) * height;

          ctx.strokeStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(x, padding.top);
          ctx.lineTo(x, padding.top + height);
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + width, y);
          ctx.stroke();
          ctx.setLineDash([]);

          ctx.beginPath();
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }

      function renderHeatmap(ctx, padding, width, height, isDark) {
        const preds = state.predictions.predictions;
        const nDims = preds[0]?.length || 0;
        const nSteps = preds.length;

        const cellW = width / nSteps;
        const cellH = height / nDims;

        let globalMin = Infinity, globalMax = -Infinity;
        preds.forEach((row) =>
          row.forEach((v) => {
            globalMin = Math.min(globalMin, v);
            globalMax = Math.max(globalMax, v);
          })
        );
        const range = globalMax - globalMin || 1;

        for (let s = 0; s < nSteps; s++) {
          for (let d = 0; d < nDims; d++) {
            const val = preds[s][d];
            const norm = (val - globalMin) / range;
            const hue = (1 - norm) * 240;
            ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
            ctx.fillRect(
              padding.left + s * cellW,
              padding.top + d * cellH,
              cellW + 1,
              cellH + 1,
            );
          }
        }

        // Labels
        ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
        ctx.font = "10px system-ui";
        for (let d = 0; d < nDims; d++) {
          ctx.fillText(
            `D${d + 1}`,
            padding.left - 25,
            padding.top + d * cellH + cellH / 2 + 3,
          );
        }
      }

      function renderUncertainty(ctx, padding, width, height, isDark) {
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const nDims = preds[0]?.length || 0;
        const nSteps = preds.length;

        const spreads = preds.map((_, s) => {
          return Array.from(
            { length: nDims },
            (_, d) => upper[s][d] - lower[s][d],
          );
        });

        const maxSpread = Math.max(...spreads.flat());
        const minSpread = Math.min(...spreads.flat());
        const range = maxSpread - minSpread || 1;

        for (let d = 0; d < nDims; d++) {
          const color = DIM_COLORS[d % DIM_COLORS.length];
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();

          for (let s = 0; s < nSteps; s++) {
            const x = padding.left + (s / (nSteps - 1)) * width;
            const y = padding.top + height -
              ((spreads[s][d] - minSpread) / range) * height;
            if (s === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        }

        drawAxes(
          ctx,
          padding,
          width,
          height,
          isDark,
          minSpread,
          maxSpread,
          0,
          nSteps - 1,
        );
      }

      function renderSnapshot(ctx, padding, width, height, isDark) {
        const step = Math.max(
          0,
          Math.min(
            state.selectedStep - 1,
            state.predictions.predictions.length - 1,
          ),
        );
        const preds = state.predictions.predictions[step];
        const lower = state.predictions.lowerBounds[step];
        const upper = state.predictions.upperBounds[step];
        const nDims = preds.length;

        const barWidth = width / (nDims * 1.5);
        const gap = barWidth * 0.5;

        const allVals = [...preds, ...lower, ...upper];
        const min = Math.min(0, ...allVals);
        const max = Math.max(...allVals);
        const range = max - min || 1;
        const zero = padding.top + height -
          ((0 - min) / range) * height;

        for (let d = 0; d < nDims; d++) {
          const x = padding.left + d * (barWidth + gap) + gap / 2;
          const color = DIM_COLORS[d % DIM_COLORS.length];

          const y = padding.top + height -
            ((preds[d] - min) / range) * height;
          const barH = zero - y;

          ctx.fillStyle = color;
          ctx.fillRect(x, Math.min(y, zero), barWidth, Math.abs(barH));

          // Error bars
          const yLower = padding.top + height -
            ((lower[d] - min) / range) * height;
          const yUpper = padding.top + height -
            ((upper[d] - min) / range) * height;
          ctx.strokeStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 2, yLower);
          ctx.lineTo(x + barWidth / 2, yUpper);
          ctx.moveTo(x + barWidth / 4, yLower);
          ctx.lineTo(x + barWidth * 3 / 4, yLower);
          ctx.moveTo(x + barWidth / 4, yUpper);
          ctx.lineTo(x + barWidth * 3 / 4, yUpper);
          ctx.stroke();

          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(
            `D${d + 1}`,
            x + barWidth / 2,
            padding.top + height + 15,
          );
        }
        ctx.textAlign = "left";
      }

      function drawAxes(
        ctx,
        padding,
        width,
        height,
        isDark,
        minY,
        maxY,
        minX,
        maxX,
      ) {
        ctx.strokeStyle = isDark ? "#475569" : "#e2e8f0";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top);
        ctx.lineTo(padding.left, padding.top + height);
        ctx.lineTo(padding.left + width, padding.top + height);
        ctx.stroke();

        ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
        ctx.font = "10px system-ui";

        ctx.textAlign = "right";
        ctx.fillText(
          maxY.toFixed(2),
          padding.left - 5,
          padding.top + 10,
        );
        ctx.fillText(
          minY.toFixed(2),
          padding.left - 5,
          padding.top + height,
        );

        ctx.textAlign = "center";
        ctx.fillText(
          minX.toString(),
          padding.left,
          padding.top + height + 15,
        );
        ctx.fillText(
          maxX.toString(),
          padding.left + width,
          padding.top + height + 15,
        );
        ctx.textAlign = "left";
      }

      // Loading state
      function showLoading(text = "Processing...") {
        document.getElementById("loadingOverlay").classList.remove(
          "hidden",
        );
        document.getElementById("loadingText").textContent = text;
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("progressText").textContent = "0%";
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add(
          "hidden",
        );
      }

      function updateProgress(percent) {
        document.getElementById("progressBar").style.width = percent +
          "%";
        document.getElementById("progressText").textContent = percent +
          "%";
      }

      // Modal management
      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(id).querySelector("button, input")
          ?.focus();
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function closeAllModals() {
        [
          "configModal",
          "uploadModal",
          "manualModal",
          "saveLoadModal",
          "randomModal",
          "settingsModal",
          "dataTableModal",
          "helpModal",
        ].forEach(closeModal);
      }

      // Menu
      function openMenu() {
        document.getElementById("menuOverlay").classList.remove(
          "hidden",
        );
        document.getElementById("menuPanel").classList.remove(
          "translate-x-full",
        );
      }

      function closeMenu() {
        document.getElementById("menuOverlay").classList.add("hidden");
        document.getElementById("menuPanel").classList.add(
          "translate-x-full",
        );
      }

      // Config modal helpers
      function getConfigFromForm() {
        return {
          reservoirSize: parseInt(
            document.getElementById("cfg_reservoirSize").value,
          ),
          spectralRadius: parseFloat(
            document.getElementById("cfg_spectralRadius").value,
          ),
          leakRate: parseFloat(
            document.getElementById("cfg_leakRate").value,
          ),
          inputScale: parseFloat(
            document.getElementById("cfg_inputScale").value,
          ),
          biasScale: parseFloat(
            document.getElementById("cfg_biasScale").value,
          ),
          reservoirSparsity: parseFloat(
            document.getElementById("cfg_reservoirSparsity").value,
          ),
          inputSparsity: parseFloat(
            document.getElementById("cfg_inputSparsity").value,
          ),
          activation: document.getElementById("cfg_activation").value,
          useInputInReadout:
            document.getElementById("cfg_useInputInReadout").dataset
              .value === "true",
          useBiasInReadout:
            document.getElementById("cfg_useBiasInReadout").dataset
              .value === "true",
          readoutTraining: "rls",
          rlsLambda: parseFloat(
            document.getElementById("cfg_rlsLambda").value,
          ),
          rlsDelta: parseFloat(
            document.getElementById("cfg_rlsDelta").value,
          ),
          epsilon: parseFloat(
            document.getElementById("cfg_epsilon").value,
          ),
          l2Lambda: parseFloat(
            document.getElementById("cfg_l2Lambda").value,
          ),
          gradientClipNorm: parseFloat(
            document.getElementById("cfg_gradientClipNorm").value,
          ),
          normalizationEpsilon: parseFloat(
            document.getElementById("cfg_normalizationEpsilon").value,
          ),
          normalizationWarmup: parseInt(
            document.getElementById("cfg_normalizationWarmup").value,
          ),
          outlierThreshold: parseFloat(
            document.getElementById("cfg_outlierThreshold").value,
          ),
          outlierMinWeight: parseFloat(
            document.getElementById("cfg_outlierMinWeight").value,
          ),
          uncertaintyMultiplier: parseFloat(
            document.getElementById("cfg_uncertaintyMultiplier").value,
          ),
          weightInitScale: parseFloat(
            document.getElementById("cfg_weightInitScale").value,
          ),
          seed: parseInt(document.getElementById("cfg_seed").value),
          verbose:
            document.getElementById("cfg_verbose").dataset.value ===
              "true",
        };
      }

      function setConfigToForm(config) {
        document.getElementById("cfg_reservoirSize").value =
          config.reservoirSize;
        document.getElementById("cfg_spectralRadius").value =
          config.spectralRadius;
        document.getElementById("cfg_leakRate").value = config.leakRate;
        document.getElementById("cfg_inputScale").value =
          config.inputScale;
        document.getElementById("cfg_biasScale").value =
          config.biasScale;
        document.getElementById("cfg_reservoirSparsity").value =
          config.reservoirSparsity;
        document.getElementById("cfg_inputSparsity").value =
          config.inputSparsity;
        document.getElementById("cfg_activation").value =
          config.activation;
        setToggle("cfg_useInputInReadout", config.useInputInReadout);
        setToggle("cfg_useBiasInReadout", config.useBiasInReadout);
        document.getElementById("cfg_rlsLambda").value =
          config.rlsLambda;
        document.getElementById("cfg_rlsDelta").value = config.rlsDelta;
        document.getElementById("cfg_epsilon").value = config.epsilon;
        document.getElementById("cfg_l2Lambda").value = config.l2Lambda;
        document.getElementById("cfg_gradientClipNorm").value =
          config.gradientClipNorm;
        document.getElementById("cfg_normalizationEpsilon").value =
          config.normalizationEpsilon;
        document.getElementById("cfg_normalizationWarmup").value =
          config.normalizationWarmup;
        document.getElementById("cfg_outlierThreshold").value =
          config.outlierThreshold;
        document.getElementById("cfg_outlierMinWeight").value =
          config.outlierMinWeight;
        document.getElementById("cfg_uncertaintyMultiplier").value =
          config.uncertaintyMultiplier;
        document.getElementById("cfg_weightInitScale").value =
          config.weightInitScale;
        document.getElementById("cfg_seed").value = config.seed;
        setToggle("cfg_verbose", config.verbose);
      }

      function setToggle(id, value) {
        const el = document.getElementById(id);
        el.dataset.value = value.toString();
        el.setAttribute("aria-pressed", value.toString());
        if (value) {
          el.className =
            "toggle-switch w-12 h-6 rounded-full bg-blue-500 relative";
          el.querySelector("span").className =
            "absolute right-1 top-1 w-4 h-4 rounded-full bg-white transition-all";
        } else {
          el.className =
            "toggle-switch w-12 h-6 rounded-full bg-slate-300 dark:bg-slate-600 relative";
          el.querySelector("span").className =
            "absolute left-1 top-1 w-4 h-4 rounded-full bg-white transition-all";
        }
      }

      // Create model
      async function createModel(config) {
        try {
          showLoading("Creating model...");
          await sendWorkerMessage("createModel", { config });
          state.config = config;
          state.modelExists = true;
          state.sampleCount = 0;
          state.predictions = null;
          state.nDimensions = 0;
          savePersistedState();
          addLog("Model created", "success");
          showToast("Model created successfully", "success");
        } catch (e) {
          addLog(`Create failed: ${e.message}`, "error");
          showToast("Failed to create model", "error");
        } finally {
          hideLoading();
          updateUI();
        }
      }

      // Train model
      async function trainModel(coordinates) {
        if (!state.modelExists) {
          showToast("Create a model first", "warning");
          return;
        }
        try {
          showLoading("Training on uploaded data...");
          currentOperation = "train";
          const result = await sendWorkerMessage("train", {
            coordinates,
          });
          state.sampleCount = result.sampleCount;
          state.nDimensions = result.nFeatures;
          state.metrics = {
            avgLoss: result.metrics?.averageLoss,
            gradientNorm: result.metrics?.gradientNorm,
            sampleWeight: result.metrics?.sampleWeight,
          };
          addLog(`Trained on ${coordinates.length} samples`, "success");
          showToast("Training complete", "success");
        } catch (e) {
          if (e.message !== "Cancelled") {
            addLog(`Training failed: ${e.message}`, "error");
            showToast("Training failed", "error");
          }
        } finally {
          currentOperation = null;
          hideLoading();
          updateUI();
        }
      }

      // Predict
      async function runPrediction(steps) {
        if (!state.modelExists) {
          showToast("Create a model first", "warning");
          return;
        }
        try {
          showLoading("Running prediction...");
          const result = await sendWorkerMessage("predict", { steps });
          state.predictions = result;
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: steps,
          };
          addLog(`Predicted ${steps} future steps`, "success");
          showToast("Prediction complete", "success");
        } catch (e) {
          addLog(`Prediction failed: ${e.message}`, "error");
          showToast("Prediction failed", "error");
        } finally {
          hideLoading();
          updateUI();
        }
      }

      // Generate random data
      function generateRandomData(
        seed,
        dims,
        steps,
        noise,
        outlierRate,
        difficulty,
      ) {
        const rng = (s) => {
          s = Math.sin(s) * 10000;
          return s - Math.floor(s);
        };
        let r = seed;
        const rand = () => {
          r++;
          return rng(r);
        };

        const freqMult = { easy: 1, medium: 2, hard: 4 }[difficulty];
        const coords = [];

        for (let t = 0; t < steps; t++) {
          const point = [];
          for (let d = 0; d < dims; d++) {
            let val = Math.sin(t * 0.05 * freqMult + d) +
              Math.cos(t * 0.03 * freqMult - d * 0.5);
            val += (rand() - 0.5) * noise * 2;
            if (rand() < outlierRate) val += (rand() - 0.5) * 10;
            point.push(val);
          }
          coords.push(point);
        }
        return coords;
      }

      // Validate upload data
      function validateUploadData(text) {
        try {
          const data = JSON.parse(text);
          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            return {
              valid: false,
              error: 'Missing "coordinates" array',
            };
          }
          if (data.coordinates.length < 2) {
            return {
              valid: false,
              error: "Need at least 2 coordinates",
            };
          }
          const dims = data.coordinates[0].length;
          if (
            !data.coordinates.every((c) =>
              Array.isArray(c) && c.length === dims &&
              c.every((v) => typeof v === "number")
            )
          ) {
            return { valid: false, error: "Invalid coordinate format" };
          }
          return {
            valid: true,
            data: data.coordinates,
            dims,
            steps: data.coordinates.length,
          };
        } catch (e) {
          return { valid: false, error: "Invalid JSON: " + e.message };
        }
      }

      // Save model state
      async function saveModelState() {
        try {
          return await sendWorkerMessage("save");
        } catch (e) {
          addLog(`Save failed: ${e.message}`, "error");
          return null;
        }
      }

      // Load model state
      async function loadModelState(modelState) {
        try {
          showLoading("Loading model...");
          const result = await sendWorkerMessage("load", {
            state: modelState,
          });
          state.modelExists = true;
          state.nDimensions = result.nFeatures;
          state.sampleCount = result.sampleCount;
          addLog("Model loaded", "success");
          showToast("Model loaded successfully", "success");
        } catch (e) {
          addLog(`Load failed: ${e.message}`, "error");
          showToast("Failed to load model", "error");
        } finally {
          hideLoading();
          updateUI();
        }
      }

      // Saved models list
      function getSavedModels() {
        try {
          const saved = localStorage.getItem("esn_saved_models");
          return saved ? JSON.parse(saved) : [];
        } catch {
          return [];
        }
      }

      function saveModelToStorage(name, modelState) {
        const models = getSavedModels();
        models.push({ name, state: modelState, date: Date.now() });
        localStorage.setItem(
          "esn_saved_models",
          JSON.stringify(models),
        );
      }

      function renderSavedModels() {
        const container = document.getElementById("savedModelsList");
        const models = getSavedModels();
        if (models.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-500 dark:text-slate-400">No saved models</p>';
          return;
        }
        container.innerHTML = models.map((m, i) => `
            <div class="flex items-center justify-between p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                <div>
                    <p class="font-medium text-slate-900 dark:text-slate-100">${m.name}</p>
                    <p class="text-xs text-slate-500">${
          new Date(m.date).toLocaleDateString()
        }</p>
                </div>
                <button data-load-idx="${i}" class="px-3 py-1 rounded-lg bg-blue-500 text-white text-sm">Load</button>
            </div>
        `).join("");
      }

      // Export functions
      function exportPNG() {
        const canvas = document.getElementById("chartCanvas");
        const link = document.createElement("a");
        link.download = "esn-chart.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }

      function exportSVG() {
        showToast("SVG export not yet implemented", "info");
      }

      async function copyToClipboard() {
        try {
          const canvas = document.getElementById("chartCanvas");
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve)
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("Copied to clipboard", "success");
        } catch {
          showToast("Failed to copy", "error");
        }
      }

      function exportCSV() {
        if (!state.predictions) return;
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const nDims = preds[0]?.length || 0;

        let csv = "Step," +
          Array.from({ length: nDims }, (_, i) => `P${i + 1}`).join(
            ",",
          ) + "," +
          Array.from({ length: nDims }, (_, i) => `L${i + 1}`).join(
            ",",
          ) + "," +
          Array.from({ length: nDims }, (_, i) => `U${i + 1}`).join(
            ",",
          ) + "\n";

        preds.forEach((p, s) => {
          csv += `${s + 1},${p.join(",")},${lower[s].join(",")},${
            upper[s].join(",")
          }\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.download = "esn-predictions.csv";
        link.href = URL.createObjectURL(blob);
        link.click();
      }

      function renderDataTable() {
        if (!state.predictions) return;
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const nDims = preds[0]?.length || 0;
        const search = document.getElementById("tableSearch").value
          .toLowerCase();

        const thead = document.getElementById("tableHead");
        thead.innerHTML = `<tr>
            <th class="p-2 text-left">Step</th>
            ${
          Array.from({ length: nDims }, (_, i) =>
            `<th class="p-2 text-right">P${i + 1}</th>`).join("")
        }
            ${
          Array.from({ length: nDims }, (_, i) =>
            `<th class="p-2 text-right">L${i + 1}</th>`).join("")
        }
            ${
          Array.from({ length: nDims }, (_, i) =>
            `<th class="p-2 text-right">U${i + 1}</th>`).join("")
        }
        </tr>`;

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = preds.map((p, s) => {
          const row = `${s + 1} ${p.join(" ")} ${lower[s].join(" ")} ${
            upper[s].join(" ")
          }`;
          if (search && !row.includes(search)) return "";
          return `<tr class="${
            s % 2 ? "bg-slate-50 dark:bg-slate-800/50" : ""
          } hover:bg-blue-50 dark:hover:bg-blue-900/20">
                <td class="p-2">${s + 1}</td>
                ${
            p.map((v) =>
              `<td class="p-2 text-right">${v.toFixed(4)}</td>`
            ).join("")
          }
                ${
            lower[s].map((v) =>
              `<td class="p-2 text-right">${v.toFixed(4)}</td>`
            ).join("")
          }
                ${
            upper[s].map((v) =>
              `<td class="p-2 text-right">${v.toFixed(4)}</td>`
            ).join("")
          }
            </tr>`;
        }).join("");
      }

      // Event listeners
      function initEventListeners() {
        // Theme toggle
        document.getElementById("themeBtn").onclick = () => {
          state.isDark = !state.isDark;
          applyTheme();
        };

        // Menu
        document.getElementById("menuBtn").onclick = openMenu;
        document.getElementById("closeMenuBtn").onclick = closeMenu;
        document.getElementById("menuOverlay").onclick = closeMenu;

        // Menu items
        document.getElementById("menuConfig").onclick = () => {
          closeMenu();
          setConfigToForm(state.config);
          openModal("configModal");
        };
        document.getElementById("menuSaveLoad").onclick = () => {
          closeMenu();
          renderSavedModels();
          openModal("saveLoadModal");
        };
        document.getElementById("menuUpload").onclick = () => {
          closeMenu();
          openModal("uploadModal");
        };
        document.getElementById("menuManual").onclick = () => {
          closeMenu();
          openModal("manualModal");
        };
        document.getElementById("menuRandom").onclick = () => {
          closeMenu();
          openModal("randomModal");
        };
        document.getElementById("menuSettings").onclick = () => {
          closeMenu();
          openModal("settingsModal");
        };
        document.getElementById("menuDataTable").onclick = () => {
          closeMenu();
          renderDataTable();
          openModal("dataTableModal");
        };
        document.getElementById("menuHelp").onclick = () => {
          closeMenu();
          openModal("helpModal");
        };

        // Header buttons
        document.getElementById("configBtn").onclick = () => {
          setConfigToForm(state.config);
          openModal("configModal");
        };
        document.getElementById("predictBtn").onclick = () =>
          runPrediction(
            parseInt(document.getElementById("futureSteps").value) ||
              50,
          );

        // Empty state buttons
        document.getElementById("startDefaultBtn").onclick = () =>
          createModel(DEFAULT_CONFIG);
        document.getElementById("loadEmptyBtn").onclick = () => {
          renderSavedModels();
          openModal("saveLoadModal");
        };
        document.getElementById("demoBtn").onclick = async () => {
          await createModel(DEFAULT_CONFIG);
          const data = generateRandomData(
            42,
            3,
            200,
            0.1,
            0.02,
            "medium",
          );
          await trainModel(data);
          await runPrediction(50);
        };

        // Modal closes
        document.querySelectorAll(".modal-close").forEach((btn) => {
          btn.onclick = () => closeAllModals();
        });
        [
          "configModalOverlay",
          "uploadModalOverlay",
          "manualModalOverlay",
          "saveLoadModalOverlay",
          "randomModalOverlay",
          "settingsModalOverlay",
          "helpModalOverlay",
        ].forEach((id) => {
          document.getElementById(id)?.addEventListener(
            "click",
            closeAllModals,
          );
        });

        // Config modal
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.onclick = () => {
            const preset = PRESETS[btn.dataset.preset];
            setConfigToForm(preset);
            document.querySelectorAll(".preset-btn").forEach((b) => {
              b.className =
                "preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300";
            });
            btn.className =
              "preset-btn flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-500 text-white";
          };
        });

        document.querySelectorAll(".section-toggle").forEach((btn) => {
          btn.onclick = () => {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector(".toggle-icon");
            const expanded =
              btn.getAttribute("aria-expanded") === "true";
            btn.setAttribute("aria-expanded", (!expanded).toString());
            content.classList.toggle("hidden");
            icon.textContent = expanded ? "‚ñ≤" : "‚ñº";
          };
        });

        document.querySelectorAll(".toggle-switch").forEach((btn) => {
          btn.onclick = () => {
            const val = btn.dataset.value === "true";
            setToggle(btn.id, !val);
          };
        });

        document.getElementById("resetDefaults").onclick = () =>
          setConfigToForm(DEFAULT_CONFIG);
        document.getElementById("resetAll").onclick = async () => {
          try {
            await sendWorkerMessage("reset");
            state.modelExists = false;
            state.predictions = null;
            state.sampleCount = 0;
            addLog("Model reset", "info");
            updateUI();
          } catch (e) {
            showToast("Reset failed", "error");
          }
        };
        document.getElementById("createModelBtn").onclick =
          async () => {
            const config = getConfigFromForm();
            await createModel(config);
            closeAllModals();
          };

        // Upload modal
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => {
          e.preventDefault();
          dropZone.classList.add("border-blue-500");
        };
        dropZone.ondragleave = () =>
          dropZone.classList.remove("border-blue-500");
        dropZone.ondrop = (e) => {
          e.preventDefault();
          dropZone.classList.remove("border-blue-500");
          const file = e.dataTransfer.files[0];
          if (file) readUploadFile(file);
        };
        fileInput.onchange = () => {
          if (fileInput.files[0]) readUploadFile(fileInput.files[0]);
        };

        function readUploadFile(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("jsonPaste").value =
              e.target.result;
            validateUpload();
          };
          reader.readAsText(file);
        }

        document.getElementById("validateUpload").onclick =
          validateUpload;
        document.getElementById("copyExample").onclick = () => {
          navigator.clipboard.writeText(
            document.getElementById("formatExample").textContent,
          );
          showToast("Copied!", "success");
        };

        function validateUpload() {
          const text = document.getElementById("jsonPaste").value;
          const result = validateUploadData(text);
          document.getElementById("uploadValidation").classList.remove(
            "hidden",
          );

          if (result.valid) {
            document.getElementById("uploadSuccess").classList.remove(
              "hidden",
            );
            document.getElementById("uploadError").classList.add(
              "hidden",
            );
            document.getElementById("uploadDims").textContent =
              result.dims;
            document.getElementById("uploadSteps").textContent =
              result.steps;
            document.getElementById("applyUpload").disabled = false;
            uploadedData = result.data;
          } else {
            document.getElementById("uploadSuccess").classList.add(
              "hidden",
            );
            document.getElementById("uploadError").classList.remove(
              "hidden",
            );
            document.getElementById("uploadErrorText").textContent =
              result.error;
            document.getElementById("applyUpload").disabled = true;
            uploadedData = null;
          }
        }

        document.getElementById("applyUpload").onclick = async () => {
          if (uploadedData) {
            if (!state.modelExists) await createModel(state.config);
            await trainModel(uploadedData);
            closeAllModals();
          }
        };

        // Manual modal
        document.getElementById("genTemplate").onclick = () => {
          const dims = state.nDimensions || 3;
          const template = {
            coordinates: [
              Array(dims).fill(0),
              Array(dims).fill(0),
            ],
          };
          document.getElementById("manualJson").value = JSON.stringify(
            template,
            null,
            2,
          );
        };

        document.getElementById("insertTrain").onclick = async () => {
          const text = document.getElementById("manualJson").value;
          const result = validateUploadData(text);

          if (result.valid) {
            if (!state.modelExists) await createModel(state.config);
            await trainModel(result.data);
            closeAllModals();
          } else {
            document.getElementById("manualValidation").classList
              .remove("hidden");
            document.getElementById("manualError").classList.remove(
              "hidden",
            );
            document.getElementById("manualErrorText").textContent =
              result.error;
          }
        };

        // Save/Load modal
        document.getElementById("downloadModel").onclick = async () => {
          const modelState = await saveModelState();
          if (modelState) {
            const blob = new Blob([JSON.stringify(modelState)], {
              type: "application/json",
            });
            const link = document.createElement("a");
            link.download = "esn-model.json";
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("Model downloaded", "success");
          }
        };

        document.getElementById("saveLocal").onclick = async () => {
          const name = prompt("Model name:");
          if (name) {
            const modelState = await saveModelState();
            if (modelState) {
              saveModelToStorage(name, modelState);
              renderSavedModels();
              showToast("Model saved", "success");
            }
          }
        };

        const loadDropZone = document.getElementById("loadDropZone");
        const loadFileInput = document.getElementById("loadFileInput");
        loadDropZone.onclick = () => loadFileInput.click();
        loadFileInput.onchange = () => {
          const file = loadFileInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const modelState = JSON.parse(e.target.result);
                await loadModelState(modelState);
                closeAllModals();
              } catch {
                showToast("Invalid model file", "error");
              }
            };
            reader.readAsText(file);
          }
        };

        document.getElementById("savedModelsList").onclick = async (
          e,
        ) => {
          const idx = e.target.dataset.loadIdx;
          if (idx !== undefined) {
            const models = getSavedModels();
            await loadModelState(models[idx].state);
            closeAllModals();
          }
        };

        document.getElementById("clearSaved").onclick = () => {
          localStorage.removeItem("esn_saved_models");
          renderSavedModels();
          showToast("Saved models cleared", "info");
        };

        // Random modal
        document.getElementById("generateRandom").onclick =
          async () => {
            const seed = parseInt(
              document.getElementById("rand_seed").value,
            );
            const dims = parseInt(
              document.getElementById("rand_dims").value,
            );
            const steps = parseInt(
              document.getElementById("rand_steps").value,
            );
            const noise = parseFloat(
              document.getElementById("rand_noise").value,
            );
            const outliers = parseFloat(
              document.getElementById("rand_outliers").value,
            );
            const difficulty =
              document.getElementById("rand_difficulty").value;

            await createModel(state.config);
            const data = generateRandomData(
              seed,
              dims,
              steps,
              noise,
              outliers,
              difficulty,
            );
            await trainModel(data);
            await runPrediction(50);
            closeAllModals();
          };

        // Settings modal
        document.getElementById("moduleUrl").value =
          localStorage.getItem("esn_module_url") || DEFAULT_MODULE_URL;
        document.getElementById("reinitWorker").onclick = () => {
          localStorage.setItem(
            "esn_module_url",
            document.getElementById("moduleUrl").value,
          );
          initWorker();
          showToast("Worker reinitialized", "info");
        };
        document.getElementById("clearPrefs").onclick = () => {
          localStorage.clear();
          location.reload();
        };

        // Data table
        document.getElementById("tableSearch").oninput =
          renderDataTable;
        document.getElementById("exportCsv").onclick = exportCSV;
        document.getElementById("copyAll").onclick = () => {
          exportCSV();
          showToast("CSV exported", "success");
        };

        // Viz tabs
        document.querySelectorAll(".viz-tab").forEach((btn) => {
          btn.onclick = () => {
            state.vizMode = btn.dataset.mode;
            savePersistedState();
            updateUI();
          };
        });

        // Dimension selector
        document.getElementById("dimSelector").onclick = (e) => {
          const dim = e.target.dataset.dim;
          if (dim !== undefined) {
            state.selectedDim = parseInt(dim);
            updateUI();
          }
        };

        // Step selector
        document.getElementById("stepInput").onchange = (e) => {
          state.selectedStep = parseInt(e.target.value) || 1;
          renderChart();
        };

        // Prediction button
        document.getElementById("runPredictBtn").onclick = () => {
          const steps =
            parseInt(document.getElementById("futureSteps").value) ||
            50;
          runPrediction(steps);
        };

        // Log filter
        document.getElementById("logFilter").onchange = renderLogs;
        document.getElementById("logSearch").oninput = renderLogs;

        // Zoom controls
        document.getElementById("zoomIn").onclick = () => {
          state.zoom.level = Math.min(10, state.zoom.level * 1.5);
          updateUI();
        };
        document.getElementById("zoomOut").onclick = () => {
          state.zoom.level = Math.max(1, state.zoom.level / 1.5);
          updateUI();
        };
        document.getElementById("zoomReset").onclick = () => {
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: 0,
          };
          updateUI();
        };

        // Export controls
        document.getElementById("exportPng").onclick = exportPNG;
        document.getElementById("exportSvg").onclick = exportSVG;
        document.getElementById("copyClip").onclick = copyToClipboard;

        // Cancel operation
        document.getElementById("cancelBtn").onclick = async () => {
          try {
            await sendWorkerMessage("cancel");
          } catch {}
          hideLoading();
        };

        // Canvas interactions
        const canvas = document.getElementById("chartCanvas");
        let isDragging = false;
        let lastX = 0;

        canvas.onmousedown = (e) => {
          isDragging = true;
          lastX = e.clientX;
        };
        canvas.onmousemove = (e) => {
          if (isDragging && state.zoom.level > 1) {
            const dx = e.clientX - lastX;
            state.zoom.offsetX = Math.max(
              0,
              state.zoom.offsetX - dx / 5,
            );
            lastX = e.clientX;
            renderChart();
          }

          if (state.predictions && state.vizMode === "focus") {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const padding = 50;
            const width = rect.width - 70;

            if (x > padding && x < padding + width) {
              const nSteps = state.predictions.predictions.length;
              const visibleSteps = Math.ceil(nSteps / state.zoom.level);
              const startIdx = Math.max(
                0,
                Math.floor(state.zoom.offsetX),
              );
              const idx = startIdx +
                Math.floor(((x - padding) / width) * visibleSteps);

              if (idx >= 0 && idx < nSteps) {
                state.hover = {
                  active: true,
                  x: e.clientX,
                  y: e.clientY,
                  dataIndex: idx,
                };
                showCanvasTooltip(idx, e.clientX, e.clientY);
                renderChart();
              }
            }
          }
        };
        canvas.onmouseup = () => isDragging = false;
        canvas.onmouseleave = () => {
          isDragging = false;
          state.hover.active = false;
          document.getElementById("tooltip").classList.add("hidden");
          renderChart();
        };

        canvas.onwheel = (e) => {
          if (state.predictions) {
            e.preventDefault();
            if (e.deltaY < 0) {
              state.zoom.level = Math.min(10, state.zoom.level * 1.1);
            } else {
              state.zoom.level = Math.max(1, state.zoom.level / 1.1);
            }
            updateUI();
          }
        };

        // Touch interactions
        let touchStartX = 0;
        let touchStartY = 0;
        let initialPinchDist = 0;

        canvas.ontouchstart = (e) => {
          if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
          } else if (e.touches.length === 2) {
            initialPinchDist = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY,
            );
          }
        };

        canvas.ontouchmove = (e) => {
          e.preventDefault();
          if (e.touches.length === 1 && state.zoom.level > 1) {
            const dx = e.touches[0].clientX - touchStartX;
            state.zoom.offsetX = Math.max(
              0,
              state.zoom.offsetX - dx / 5,
            );
            touchStartX = e.touches[0].clientX;
            renderChart();
          } else if (e.touches.length === 2) {
            const dist = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY,
            );
            const scale = dist / initialPinchDist;
            state.zoom.level = Math.max(
              1,
              Math.min(10, state.zoom.level * scale),
            );
            initialPinchDist = dist;
            updateUI();
          }
        };

        // Resize
        window.onresize = () => renderChart();
      }

      function showCanvasTooltip(idx, x, y) {
        const tooltip = document.getElementById("tooltip");
        const content = document.getElementById("tooltipContent");

        if (!state.predictions) return;

        const dim = state.selectedDim;
        const pred = state.predictions.predictions[idx][dim];
        const lower = state.predictions.lowerBounds[idx][dim];
        const upper = state.predictions.upperBounds[idx][dim];
        const color = DIM_COLORS[dim % DIM_COLORS.length];

        content.innerHTML = `
            <div class="font-bold text-lg mb-1">Step ${idx + 1}</div>
            <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 rounded-full" style="background:${color}"></span>
                <span>Dimension ${dim + 1}</span>
            </div>
            <div class="font-bold">${pred.toFixed(4)}</div>
            <div class="text-slate-300 text-xs">${lower.toFixed(3)} - ${
          upper.toFixed(3)
        }</div>
            <div class="text-slate-400 text-xs">Spread: ${
          (upper - lower).toFixed(4)
        }</div>
        `;

        tooltip.classList.remove("hidden");
        tooltip.style.left = Math.min(x + 10, window.innerWidth - 200) +
          "px";
        tooltip.style.top = Math.min(y + 10, window.innerHeight - 150) +
          "px";
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadPersistedState();
        applyTheme();
        initWorker();
        initEventListeners();
        updateUI();
        addLog("ESN Studio initialized", "info");
      });
    </script>
  </body>
</html>
