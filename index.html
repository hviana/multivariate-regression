<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <header
      id="header"
      class="sticky top-0 z-40 bg-white/80 backdrop-blur-lg border-b border-slate-200/50 shadow-sm"
    >
      <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30"
          >
            <span class="text-xl">üìä</span>
          </div>
          <div>
            <h1 class="font-bold text-slate-900 text-lg leading-tight">
              ESN Studio
            </h1>
            <p class="text-xs text-slate-500">Autoregressive Forecasting</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div
            id="statusBadge"
            class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full"
          >
            <span
              id="statusDot"
              class="w-2 h-2 rounded-full bg-slate-400"
            ></span>
            <span id="statusText" class="text-xs font-medium text-slate-600"
            >No Model</span>
          </div>
          <button
            id="predictBtn"
            class="hidden items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-semibold rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform"
            aria-label="Run prediction"
          >
            <span>‚ö°</span>
            <span>Predict</span>
          </button>
          <button
            id="configBtn"
            class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl hover:bg-slate-200 active:scale-95 transition-all"
            aria-label="Open configuration"
          >
            <span class="text-lg">‚öôÔ∏è</span>
          </button>
          <button
            id="menuBtn"
            class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl hover:bg-slate-200 active:scale-95 transition-all"
            aria-label="Open menu"
          >
            <span class="text-lg">‚ò∞</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-col lg:flex-row min-h-[calc(100vh-4rem)]">
      <!-- Visualization Area -->
      <div class="flex-1 p-4 space-y-4">
        <!-- Tab Navigation -->
        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          <button
            data-viz="grid"
            class="viz-tab flex items-center gap-2 px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/30"
            aria-label="Grid view"
          >
            <span>üìä</span>
            <span>Small Multiples</span>
          </button>
          <button
            data-viz="focus"
            class="viz-tab flex items-center gap-2 px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap bg-slate-100 text-slate-700 hover:bg-slate-200"
            aria-label="Focus view"
          >
            <span>üîç</span>
            <span>Focus View</span>
          </button>
        </div>

        <!-- Dimension Selector (Focus Mode) -->
        <div id="dimSelector" class="hidden flex gap-2 overflow-x-auto pb-2">
        </div>

        <!-- Chart Container -->
        <div
          id="chartContainer"
          class="relative bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden min-h-[400px]"
        >
          <!-- Empty State -->
          <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center p-8"
          >
            <div class="relative mb-6">
              <div
                class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl blur-2xl"
              >
              </div>
              <div
                class="relative w-24 h-24 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-3xl flex items-center justify-center"
              >
                <span class="text-5xl">üìä</span>
              </div>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">
              Create a Model to Begin
            </h2>
            <p class="text-slate-500 text-center text-sm mb-6 max-w-xs">
              ESN autoregressive forecasting learns patterns from time series
              data to predict future values
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="startDefaultBtn"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform"
              >
                <span>‚ö°</span>
                <span>Start with Defaults</span>
              </button>
              <button
                id="loadEmptyBtn"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 active:scale-95 transition-all"
              >
                <span>üì§</span>
                <span>Load</span>
              </button>
              <button
                id="demoBtn"
                class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl shadow-lg shadow-purple-500/30 active:scale-95 transition-transform"
              >
                <span>‚ú®</span>
                <span>Demo</span>
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div
            id="loadingState"
            class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-20"
          >
            <div
              class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"
            >
            </div>
            <p id="loadingText" class="text-slate-700 font-medium mb-4">
              Processing...
            </p>
            <div
              class="w-64 h-2 bg-slate-200 rounded-full overflow-hidden mb-4"
            >
              <div
                id="progressBar"
                class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300"
                style="width: 0%"
              >
              </div>
            </div>
            <p id="progressText" class="text-sm text-slate-500 mb-4">0%</p>
            <button
              id="cancelBtn"
              class="px-4 py-2 bg-red-500 text-white font-medium rounded-xl hover:bg-red-600 active:scale-95 transition-all"
            >
              Cancel
            </button>
          </div>

          <!-- Canvas -->
          <canvas id="mainCanvas" class="w-full h-full"></canvas>

          <!-- Floating Controls -->
          <div id="floatingControls" class="hidden">
            <div
              class="absolute top-4 left-4 px-3 py-1.5 bg-white/90 backdrop-blur rounded-lg shadow-lg border border-slate-200"
            >
              <span id="zoomLevel" class="text-sm font-medium text-slate-700"
              >100%</span>
            </div>
            <div class="absolute top-4 right-4 flex gap-2">
              <button
                id="zoomInBtn"
                class="w-10 h-10 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all"
                aria-label="Zoom in"
              >
                <span>‚ûï</span>
              </button>
              <button
                id="zoomOutBtn"
                class="w-10 h-10 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all"
                aria-label="Zoom out"
              >
                <span>‚ûñ</span>
              </button>
              <button
                id="zoomResetBtn"
                class="w-10 h-10 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all"
                aria-label="Reset zoom"
              >
                <span>üîÑ</span>
              </button>
            </div>
            <div class="absolute bottom-4 right-4 flex gap-2">
              <button
                id="exportPngBtn"
                class="px-3 py-2 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center gap-2 hover:bg-slate-50 active:scale-95 transition-all text-sm font-medium"
                aria-label="Export as PNG"
              >
                <span>üñºÔ∏è</span>
                <span>PNG</span>
              </button>
              <button
                id="exportSvgBtn"
                class="px-3 py-2 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center gap-2 hover:bg-slate-50 active:scale-95 transition-all text-sm font-medium"
                aria-label="Export as SVG"
              >
                <span>üìÑ</span>
                <span>SVG</span>
              </button>
              <button
                id="copyChartBtn"
                class="px-3 py-2 bg-white/90 backdrop-blur rounded-xl shadow-lg border border-slate-200 flex items-center gap-2 hover:bg-slate-50 active:scale-95 transition-all text-sm font-medium"
                aria-label="Copy to clipboard"
              >
                <span>üìã</span>
                <span>Copy</span>
              </button>
            </div>
          </div>

          <!-- Tooltip -->
          <div
            id="tooltip"
            class="hidden absolute z-30 bg-slate-900 text-white px-4 py-3 rounded-xl shadow-2xl text-sm pointer-events-none min-w-[180px]"
          >
            <div id="tooltipStep" class="font-bold text-lg mb-1"></div>
            <div id="tooltipDim" class="flex items-center gap-2 mb-2">
              <span id="tooltipDimDot" class="w-3 h-3 rounded-full"></span>
              <span id="tooltipDimLabel"></span>
            </div>
            <div class="space-y-1">
              <div class="flex justify-between gap-4">
                <span class="text-slate-400">Predicted:</span>
                <span id="tooltipValue" class="font-bold"></span>
              </div>
              <div class="flex justify-between gap-4">
                <span class="text-slate-400">CI:</span>
                <span id="tooltipCI" class="text-slate-300"></span>
              </div>
              <div class="flex justify-between gap-4">
                <span class="text-slate-400">Spread:</span>
                <span id="tooltipSpread" class="text-slate-300"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Bar (Focus Mode) -->
        <div id="statsBar" class="hidden grid grid-cols-3 sm:grid-cols-6 gap-2">
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">Min</p>
            <p id="statMin" class="font-bold text-slate-900">-</p>
          </div>
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">Max</p>
            <p id="statMax" class="font-bold text-slate-900">-</p>
          </div>
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">Mean</p>
            <p id="statMean" class="font-bold text-slate-900">-</p>
          </div>
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">Final</p>
            <p id="statFinal" class="font-bold text-slate-900">-</p>
          </div>
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">Trend</p>
            <p id="statTrend" class="font-bold text-slate-900">-</p>
          </div>
          <div
            class="bg-white/60 backdrop-blur rounded-xl p-3 border border-slate-100"
          >
            <p class="text-xs uppercase text-slate-500 font-medium">
              Confidence
            </p>
            <p id="statConfidence" class="font-bold text-slate-900">-</p>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <aside
        class="w-full lg:w-80 bg-white border-t lg:border-t-0 lg:border-l border-slate-200 p-4 space-y-6"
      >
        <!-- Model Metrics -->
        <div>
          <h3 class="text-xs uppercase font-bold text-slate-500 mb-3">
            Model Metrics
          </h3>
          <div class="space-y-2">
            <div
              class="flex justify-between items-center py-2 px-3 bg-blue-50 rounded-lg"
            >
              <span class="text-sm text-slate-600">Samples Trained</span>
              <span id="metricSamples" class="font-bold text-blue-600">0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg"
            >
              <span class="text-sm text-slate-600">Avg Loss</span>
              <span id="metricLoss" class="font-mono text-sm text-slate-900"
              >0.00e+0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg"
            >
              <span class="text-sm text-slate-600">Gradient Norm</span>
              <span id="metricGradient" class="font-mono text-sm text-slate-900"
              >0.00e+0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 px-3 bg-slate-50 rounded-lg"
            >
              <span class="text-sm text-slate-600">Sample Weight</span>
              <span id="metricWeight" class="font-mono text-sm text-slate-900"
              >0.000</span>
            </div>
          </div>
        </div>

        <!-- Prediction -->
        <div>
          <h3 class="text-xs uppercase font-bold text-slate-500 mb-3">
            Prediction
          </h3>
          <div class="space-y-3">
            <div>
              <label for="futureSteps" class="block text-sm text-slate-600 mb-1"
              >Future Steps</label>
              <input
                type="number"
                id="futureSteps"
                value="50"
                min="1"
                class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Number of future steps to predict"
              >
            </div>
            <button
              id="runPredictBtn"
              class="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform"
              disabled
              aria-label="Run prediction"
            >
              Run Prediction
            </button>
          </div>
        </div>

        <!-- Event Log -->
        <div>
          <h3 class="text-xs uppercase font-bold text-slate-500 mb-3">
            Event Log
          </h3>
          <div class="space-y-2 mb-3">
            <select
              id="logFilter"
              class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              aria-label="Filter logs"
            >
              <option value="all">All</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
            <input
              type="text"
              id="logSearch"
              placeholder="Search logs..."
              class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              aria-label="Search logs"
            >
          </div>
          <div id="logContainer" class="h-48 overflow-y-auto space-y-1 text-sm">
          </div>
        </div>
      </aside>
    </main>

    <!-- Slide-out Menu -->
    <div
      id="menuOverlay"
      class="hidden fixed inset-0 bg-black/50 z-50"
      aria-hidden="true"
    >
    </div>
    <div
      id="slideMenu"
      class="fixed top-0 right-0 h-full w-80 max-w-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300"
      role="dialog"
      aria-label="Main menu"
    >
      <div
        class="p-4 border-b border-slate-200 flex justify-between items-center"
      >
        <h2 class="font-bold text-lg text-slate-900">Menu</h2>
        <button
          id="closeMenuBtn"
          class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 active:scale-95 transition-all"
          aria-label="Close menu"
        >
          <span class="text-xl">‚úñÔ∏è</span>
        </button>
      </div>
      <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-4rem)]">
        <!-- Model Section -->
        <div>
          <h3
            class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center gap-2"
          >
            <span>üìÅ</span> Model
          </h3>
          <div class="space-y-2">
            <button
              id="menuConfigBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-blue-50 active:scale-98 transition-all text-left"
            >
              <div
                class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center"
              >
                <span class="text-lg">üéõÔ∏è</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">Create & Configure</p>
                <p class="text-xs text-slate-500">Set up model parameters</p>
              </div>
            </button>
            <button
              id="menuSaveLoadBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-emerald-50 active:scale-98 transition-all text-left"
            >
              <div
                class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center"
              >
                <span class="text-lg">üíæ</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">Save & Load</p>
                <p class="text-xs text-slate-500">Persist your models</p>
              </div>
            </button>
          </div>
        </div>

        <!-- Data Section -->
        <div>
          <h3
            class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center gap-2"
          >
            <span>üìÇ</span> Data
          </h3>
          <div class="space-y-2">
            <button
              id="menuUploadBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-purple-50 active:scale-98 transition-all text-left"
            >
              <div
                class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center"
              >
                <span class="text-lg">üì§</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">Upload Dataset</p>
                <p class="text-xs text-slate-500">Import time series data</p>
              </div>
            </button>
          </div>
        </div>

        <!-- Test Section -->
        <div>
          <h3
            class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center gap-2"
          >
            <span>üß™</span> Test
          </h3>
          <div class="space-y-2">
            <button
              id="menuRandomBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-pink-50 active:scale-98 transition-all text-left"
            >
              <div
                class="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center"
              >
                <span class="text-lg">üí°</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">Random Test</p>
                <p class="text-xs text-slate-500">
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Advanced Section -->
        <div>
          <h3
            class="text-xs uppercase font-bold text-slate-500 mb-3 flex items-center gap-2"
          >
            <span>‚öôÔ∏è</span> Advanced
          </h3>
          <div class="space-y-2">
            <button
              id="menuDataTableBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 active:scale-98 transition-all text-left"
            >
              <div
                class="w-10 h-10 bg-slate-200 rounded-xl flex items-center justify-center"
              >
                <span class="text-lg">üìã</span>
              </div>
              <div>
                <p class="font-semibold text-slate-900">View Data Table</p>
                <p class="text-xs text-slate-500">Raw prediction values</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-label="Configuration modal"
    >
      <div
        class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900">‚öôÔ∏è Configuration</h2>
          <button
            id="closeConfigBtn"
            class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100"
            aria-label="Close configuration"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>

        <!-- Presets -->
        <div class="p-4 border-b border-slate-200 flex-shrink-0">
          <div class="flex gap-2 overflow-x-auto pb-2">
            <button
              data-preset="default"
              class="preset-btn px-4 py-2 bg-blue-500 text-white rounded-xl text-sm font-medium whitespace-nowrap"
            >
              Start Here
            </button>
            <button
              data-preset="fast"
              class="preset-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium whitespace-nowrap hover:bg-slate-200"
            >
              Fast
            </button>
            <button
              data-preset="balanced"
              class="preset-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium whitespace-nowrap hover:bg-slate-200"
            >
              Balanced
            </button>
            <button
              data-preset="accurate"
              class="preset-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium whitespace-nowrap hover:bg-slate-200"
            >
              Accurate
            </button>
            <button
              data-preset="adaptive"
              class="preset-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium whitespace-nowrap hover:bg-slate-200"
            >
              Adaptive
            </button>
            <button
              data-preset="robust"
              class="preset-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium whitespace-nowrap hover:bg-slate-200"
            >
              Robust
            </button>
          </div>
        </div>

        <!-- Config Sections -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Reservoir Architecture -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="true"
            >
              <span class="font-semibold text-slate-900"
              >üß† Reservoir Architecture</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="config-section-content p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Reservoir Size</label>
                <input
                  type="number"
                  id="cfg-reservoirSize"
                  value="256"
                  min="16"
                  max="2048"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Neurons in reservoir</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Spectral Radius</label>
                <input
                  type="number"
                  id="cfg-spectralRadius"
                  value="0.9"
                  min="0.1"
                  max="2"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Memory length control</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Leak Rate</label>
                <input
                  type="number"
                  id="cfg-leakRate"
                  value="0.3"
                  min="0.01"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Temporal smoothing</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Input Scale</label>
                <input
                  type="number"
                  id="cfg-inputScale"
                  value="1.0"
                  min="0.01"
                  max="10"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Input scaling factor</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Bias Scale</label>
                <input
                  type="number"
                  id="cfg-biasScale"
                  value="0.1"
                  min="0"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Bias scaling</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Reservoir Sparsity</label>
                <input
                  type="number"
                  id="cfg-reservoirSparsity"
                  value="0.9"
                  min="0"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">
                  Zero connections ratio
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Input Sparsity</label>
                <input
                  type="number"
                  id="cfg-inputSparsity"
                  value="0.0"
                  min="0"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Input sparsity ratio</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Activation Function</label>
                <select
                  id="cfg-activation"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="tanh">tanh</option>
                  <option value="relu">relu</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">Activation function</p>
              </div>
            </div>
          </div>

          <!-- Readout Configuration -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900"
              >üì§ Readout Configuration</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-slate-700"
                  >Use Input in Readout</label>
                  <p class="text-xs text-slate-500">Append input to state</p>
                </div>
                <button
                  id="cfg-useInputInReadout"
                  class="toggle-switch w-12 h-6 rounded-full bg-blue-500 relative"
                  data-value="true"
                  aria-label="Toggle use input in readout"
                >
                  <span
                    class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-all"
                  ></span>
                </button>
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-slate-700"
                  >Use Bias in Readout</label>
                  <p class="text-xs text-slate-500">Include bias term</p>
                </div>
                <button
                  id="cfg-useBiasInReadout"
                  class="toggle-switch w-12 h-6 rounded-full bg-blue-500 relative"
                  data-value="true"
                  aria-label="Toggle use bias in readout"
                >
                  <span
                    class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Training (RLS) -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900"
              >üéØ Training (RLS)</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Training Method</label>
                <input
                  type="text"
                  value="rls"
                  disabled
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl bg-slate-50 text-slate-500"
                >
                <p class="text-xs text-slate-500 mt-1">RLS training (fixed)</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >RLS Lambda</label>
                <input
                  type="number"
                  id="cfg-rlsLambda"
                  value="0.999"
                  min="0.9"
                  max="1"
                  step="0.001"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Forgetting factor</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >RLS Delta</label>
                <input
                  type="number"
                  id="cfg-rlsDelta"
                  value="1.0"
                  min="0.01"
                  max="100"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Initial P diagonal</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Epsilon</label>
                <input
                  type="number"
                  id="cfg-epsilon"
                  value="1e-8"
                  step="any"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Numerical stability</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >L2 Lambda</label>
                <input
                  type="number"
                  id="cfg-l2Lambda"
                  value="0.0001"
                  min="0"
                  max="1"
                  step="0.0001"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">L2 regularization</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Gradient Clip Norm</label>
                <input
                  type="number"
                  id="cfg-gradientClipNorm"
                  value="1.0"
                  min="0.1"
                  max="100"
                  step="0.1"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Max update norm</p>
              </div>
            </div>
          </div>

          <!-- Normalization -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900">üìè Normalization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Normalization Epsilon</label>
                <input
                  type="number"
                  id="cfg-normalizationEpsilon"
                  value="1e-8"
                  step="any"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Stability constant</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Normalization Warmup</label>
                <input
                  type="number"
                  id="cfg-normalizationWarmup"
                  value="10"
                  min="1"
                  max="1000"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Warmup samples</p>
              </div>
            </div>
          </div>

          <!-- Outlier Handling -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900"
              >üõ°Ô∏è Outlier Handling</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Outlier Threshold</label>
                <input
                  type="number"
                  id="cfg-outlierThreshold"
                  value="3.0"
                  min="1"
                  max="10"
                  step="0.1"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Z-score threshold</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Outlier Min Weight</label>
                <input
                  type="number"
                  id="cfg-outlierMinWeight"
                  value="0.1"
                  min="0.01"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">
                  Outlier minimum weight
                </p>
              </div>
            </div>
          </div>

          <!-- Uncertainty -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900">üìä Uncertainty</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Uncertainty Multiplier</label>
                <input
                  type="number"
                  id="cfg-uncertaintyMultiplier"
                  value="1.96"
                  min="0.5"
                  max="5"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">
                  CI Multiplier (1.96 = 95% CI)
                </p>
              </div>
            </div>
          </div>

          <!-- Initialization -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              class="config-section-toggle w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100"
              aria-expanded="false"
            >
              <span class="font-semibold text-slate-900"
              >üîß Initialization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="config-section-content hidden p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Weight Init Scale</label>
                <input
                  type="number"
                  id="cfg-weightInitScale"
                  value="0.1"
                  min="0.01"
                  max="1"
                  step="0.01"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Initial weight scale</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                >Seed</label>
                <input
                  type="number"
                  id="cfg-seed"
                  value="42"
                  min="0"
                  class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <p class="text-xs text-slate-500 mt-1">Random seed</p>
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <label class="text-sm font-medium text-slate-700"
                  >Verbose</label>
                  <p class="text-xs text-slate-500">Detailed logging</p>
                </div>
                <button
                  id="cfg-verbose"
                  class="toggle-switch w-12 h-6 rounded-full bg-slate-300 relative"
                  data-value="false"
                  aria-label="Toggle verbose logging"
                >
                  <span
                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div
          class="p-4 border-t border-slate-200 flex flex-wrap gap-2 flex-shrink-0"
        >
          <button
            id="resetDefaultsBtn"
            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Reset Defaults
          </button>
          <button
            id="resetAllBtn"
            class="px-4 py-2 bg-red-100 text-red-700 rounded-xl font-medium hover:bg-red-200 active:scale-95 transition-all"
          >
            Reset All
          </button>
          <div class="flex-1"></div>
          <button
            id="cancelConfigBtn"
            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Cancel
          </button>
          <button
            id="createModelBtn"
            class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/30 active:scale-95 transition-transform"
          >
            Create Model
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-label="Upload dataset modal"
    >
      <div
        class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900">üì§ Upload Dataset</h2>
          <button
            id="closeUploadBtn"
            class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100"
            aria-label="Close upload modal"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Drop Zone -->
          <div
            id="dropZone"
            class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-colors cursor-pointer"
          >
            <span class="text-4xl mb-4 block">üìÅ</span>
            <p class="text-slate-700 font-medium">
              Drop JSON file here or tap to browse
            </p>
            <p class="text-sm text-slate-500 mt-1">Accepts .json files</p>
            <input type="file" id="fileInput" accept=".json" class="hidden">
          </div>

          <!-- Paste Section -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"
            >Or paste JSON data:</label>
            <textarea
              id="pasteArea"
              rows="5"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
              placeholder='{"coordinates": [[1, 2], [3, 4]]}'
            ></textarea>
          </div>

          <!-- Format Example -->
          <div class="border border-slate-200 rounded-xl overflow-hidden">
            <button
              id="toggleFormatExample"
              class="w-full flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 text-sm"
              aria-expanded="false"
            >
              <span class="font-medium text-slate-700">üìù Format Example</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div
              id="formatExampleContent"
              class="hidden p-3 bg-slate-900 relative"
            >
              <button
                id="copyExampleBtn"
                class="absolute top-2 right-2 px-2 py-1 bg-slate-700 text-white text-xs rounded hover:bg-slate-600"
              >
                Copy
              </button>
              <pre
                class="text-green-400 text-xs overflow-x-auto"
              >
<code>{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
            </div>
          </div>

          <!-- Validation Feedback -->
          <div id="validationFeedback" class="hidden rounded-xl p-4">
            <div id="validationSuccess" class="hidden">
              <p class="font-medium text-emerald-700">‚úÖ Valid dataset</p>
              <p class="text-sm text-emerald-600 mt-1">
                <span id="validationDims"></span> dimensions, <span
                  id="validationSteps"
                ></span> time steps
              </p>
            </div>
            <div id="validationError" class="hidden">
              <p class="font-medium text-red-700">‚ùå Validation Error</p>
              <p id="validationErrorMsg" class="text-sm text-red-600 mt-1"></p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-200 flex gap-2 flex-shrink-0">
          <button
            id="cancelUploadBtn"
            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Cancel
          </button>
          <button
            id="validateBtn"
            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Validate
          </button>
          <button
            id="applyTrainBtn"
            class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform"
            disabled
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-label="Save and load modal"
    >
      <div
        class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900">üíæ Save & Load</h2>
          <button
            id="closeSaveLoadBtn"
            class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100"
            aria-label="Close save and load modal"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <!-- Save Section -->
          <div>
            <h3 class="text-sm font-bold text-slate-500 uppercase mb-3">
              Save Model
            </h3>
            <div class="flex gap-2">
              <button
                id="downloadModelBtn"
                class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-blue-50 text-blue-700 rounded-xl font-medium hover:bg-blue-100 active:scale-95 transition-all disabled:opacity-50"
                disabled
              >
                <span>üì•</span>
                <span>Download</span>
              </button>
              <button
                id="saveBrowserBtn"
                class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-xl font-medium hover:bg-emerald-100 active:scale-95 transition-all disabled:opacity-50"
                disabled
              >
                <span>üíæ</span>
                <span>Browser</span>
              </button>
            </div>
          </div>

          <!-- Load Section -->
          <div>
            <h3 class="text-sm font-bold text-slate-500 uppercase mb-3">
              Load Model
            </h3>
            <div
              id="loadDropZone"
              class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-500 hover:bg-blue-50 transition-colors cursor-pointer mb-4"
            >
              <span class="text-2xl mb-2 block">üì§</span>
              <p class="text-slate-700 font-medium text-sm">
                Tap to upload model file
              </p>
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="hidden"
              >
            </div>

            <!-- Saved Models List -->
            <div id="savedModelsList" class="space-y-2">
              <p class="text-sm text-slate-500 text-center py-4">
                No saved models
              </p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-200 flex-shrink-0">
          <button
            id="closeSaveLoadFooterBtn"
            class="w-full px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
      role="dialog"
      aria-label="Random test modal"
    >
      <div
        class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900">üí° Random Test</h2>
          <button
            id="closeRandomBtn"
            class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100"
            aria-label="Close random test modal"
          >
            <span class="text-xl">‚úñÔ∏è</span>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Seed</label>
            <input
              type="number"
              id="rand-seed"
              value="42"
              min="0"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Dimensions</label>
            <input
              type="number"
              id="rand-dimensions"
              value="3"
              min="1"
              max="10"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Time Steps</label>
            <input
              type="number"
              id="rand-timeSteps"
              value="200"
              min="10"
              max="10000"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Noise</label>
            <input
              type="number"
              id="rand-noise"
              value="0.1"
              min="0"
              max="1"
              step="0.01"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Outliers Rate</label>
            <input
              type="number"
              id="rand-outliers"
              value="0.02"
              min="0"
              max="0.5"
              step="0.01"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1"
            >Difficulty</label>
            <select
              id="rand-difficulty"
              class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-200 flex gap-2 flex-shrink-0">
          <button
            id="cancelRandomBtn"
            class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Cancel
          </button>
          <button
            id="generateRunBtn"
            class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium shadow-lg shadow-purple-500/30 active:scale-95 transition-transform"
          >
            Generate & Run
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Data table modal"
    >
      <div
        class="bg-white w-full h-full sm:rounded-2xl rounded-2xl flex flex-col overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"
        >
          <h2 class="font-bold text-lg text-slate-900">üìã Data Table</h2>
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="px-3 py-2 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32 sm:w-48"
            >
            <button
              id="exportCsvBtn"
              class="px-3 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-medium text-sm hover:bg-emerald-200 active:scale-95 transition-all flex items-center gap-1"
              aria-label="Export as CSV"
            >
              <span>üìä</span>
              <span class="hidden sm:inline">CSV</span>
            </button>
            <button
              id="copyAllBtn"
              class="px-3 py-2 bg-blue-100 text-blue-700 rounded-xl font-medium text-sm hover:bg-blue-200 active:scale-95 transition-all flex items-center gap-1"
              aria-label="Copy all data"
            >
              <span>üìã</span>
              <span class="hidden sm:inline">Copy</span>
            </button>
            <button
              id="closeDataTableBtn"
              class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100"
              aria-label="Close data table"
            >
              <span class="text-xl">‚úñÔ∏è</span>
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-auto">
          <table id="dataTable" class="w-full text-sm">
            <thead class="bg-slate-50 sticky top-0">
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody" class="font-mono"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Save Name Prompt Modal -->
    <div
      id="saveNameModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Save name prompt"
    >
      <div class="bg-white w-full max-w-sm rounded-2xl p-6">
        <h3 class="font-bold text-lg text-slate-900 mb-4">üíæ Save Model</h3>
        <input
          type="text"
          id="saveNameInput"
          placeholder="Model name..."
          class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
        >
        <div class="flex gap-2">
          <button
            id="cancelSaveNameBtn"
            class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 active:scale-95 transition-all"
          >
            Cancel
          </button>
          <button
            id="confirmSaveNameBtn"
            class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-medium shadow-lg active:scale-95 transition-transform"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-96 z-50 space-y-2"
    >
    </div>

    <script>
      // ==================== CONSTANTS ====================
      const DIMENSION_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const PRESETS = {
        default: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
        },
        fast: { reservoirSize: 64, reservoirSparsity: 0.95 },
        balanced: { reservoirSize: 256, spectralRadius: 0.9 },
        accurate: {
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      // ==================== STATE ====================
      let state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        trainingData: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 0,
        logs: [],
        metrics: {
          samplesProcessed: 0,
          averageLoss: 0,
          gradientNorm: 0,
          driftDetected: false,
          sampleWeight: 0,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        isLoading: false,
        currentRequestId: 0,
        validatedData: null,
      };

      // Load persisted state
      try {
        const savedConfig = localStorage.getItem("esn_config");
        const savedVizMode = localStorage.getItem("esn_vizMode");
        if (savedConfig) {
          state.config = {
            ...DEFAULT_CONFIG,
            ...JSON.parse(savedConfig),
          };
        }
        if (savedVizMode) state.vizMode = savedVizMode;
      } catch (e) {
        console.warn("Failed to load persisted state:", e);
      }

      // ==================== WEB WORKER ====================
      const workerCode = `
            let ESNRegression;
            let model = null;
            let cancelled = false;

            async function initModule() {
                try {
                    const module = await import('https://esm.sh/jsr/@hviana/multivariate-regression');
                    ESNRegression = module.ESNRegression;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            self.onmessage = async (e) => {
                const { type, payload, requestId } = e.data;
                cancelled = false;

                try {
                    switch (type) {
                        case 'init': {
                            const result = await initModule();
                            self.postMessage({ type: 'init', requestId, ...result });
                            break;
                        }

                        case 'createModel': {
                            if (!ESNRegression) {
                                throw new Error('Module not initialized');
                            }
                            model = new ESNRegression(payload.config);
                            self.postMessage({ type: 'createModel', requestId, success: true });
                            break;
                        }

                        case 'train': {
                            if (!model) throw new Error('No model exists');
                            const { coordinates } = payload;
                            const batchSize = 10;
                            const totalBatches = Math.ceil(coordinates.length / batchSize);
                            let result = null;
                            
                            for (let i = 0; i < coordinates.length - 1; i += batchSize) {
                                if (cancelled) {
                                    self.postMessage({ type: 'train', requestId, cancelled: true });
                                    return;
                                }
                                const end = Math.min(i + batchSize + 1, coordinates.length);
                                const batch = coordinates.slice(i, end);
                                if (batch.length >= 2) {
                                    result = model.fitOnline({ coordinates: batch });
                                }
                                const progress = Math.round(((i + batchSize) / coordinates.length) * 100);
                                self.postMessage({ 
                                    type: 'progress', 
                                    requestId, 
                                    progress: Math.min(progress, 100),
                                    metrics: result 
                                });
                            }
                            
                            self.postMessage({ type: 'train', requestId, success: true, metrics: result });
                            break;
                        }

                        case 'predict': {
                            if (!model) throw new Error('No model exists');
                            const result = model.predict(payload.futureSteps);
                            self.postMessage({ type: 'predict', requestId, success: true, result });
                            break;
                        }

                        case 'save': {
                            if (!model) throw new Error('No model exists');
                            const modelState = model.save();
                            self.postMessage({ type: 'save', requestId, success: true, state: modelState });
                            break;
                        }

                        case 'load': {
                            if (!ESNRegression) throw new Error('Module not initialized');
                            model = new ESNRegression({});
                            model.load(payload.state);
                            self.postMessage({ type: 'load', requestId, success: true });
                            break;
                        }

                        case 'getSummary': {
                            if (!model) throw new Error('No model exists');
                            const summary = model.getModelSummary();
                            self.postMessage({ type: 'getSummary', requestId, success: true, summary });
                            break;
                        }

                        case 'reset': {
                            model = null;
                            self.postMessage({ type: 'reset', requestId, success: true });
                            break;
                        }

                        case 'cancel': {
                            cancelled = true;
                            self.postMessage({ type: 'cancel', requestId, success: true });
                            break;
                        }
                    }
                } catch (error) {
                    self.postMessage({ type, requestId, success: false, error: error.message });
                }
            };
        `;

      const blob = new Blob([workerCode], { type: "text/javascript" });
      const worker = new Worker(URL.createObjectURL(blob), {
        type: "module",
      });

      const pendingRequests = new Map();

      worker.onmessage = (e) => {
        const { type, requestId, ...data } = e.data;

        if (type === "progress") {
          updateProgress(data.progress, data.metrics);
          return;
        }

        const resolver = pendingRequests.get(requestId);
        if (resolver) {
          pendingRequests.delete(requestId);
          resolver(data);
        }
      };

      worker.onerror = (e) => {
        console.error("Worker error:", e);
        showToast("Worker error occurred", "error");
        addLog("Worker error: " + e.message, "error");
      };

      function sendWorkerMessage(type, payload = {}) {
        return new Promise((resolve) => {
          const requestId = ++state.currentRequestId;
          pendingRequests.set(requestId, resolve);
          worker.postMessage({ type, payload, requestId });
        });
      }

      // Initialize worker
      (async () => {
        try {
          const result = await sendWorkerMessage("init");
          if (result.success) {
            addLog("ESN module initialized", "success");
          } else {
            addLog(
              "Failed to initialize ESN module: " + result.error,
              "error",
            );
            showToast("Failed to initialize ESN module", "error");
          }
        } catch (e) {
          addLog("Worker initialization failed", "error");
        }
      })();

      // ==================== DOM ELEMENTS ====================
      const elements = {
        statusBadge: document.getElementById("statusBadge"),
        statusDot: document.getElementById("statusDot"),
        statusText: document.getElementById("statusText"),
        predictBtn: document.getElementById("predictBtn"),
        configBtn: document.getElementById("configBtn"),
        menuBtn: document.getElementById("menuBtn"),
        menuOverlay: document.getElementById("menuOverlay"),
        slideMenu: document.getElementById("slideMenu"),
        closeMenuBtn: document.getElementById("closeMenuBtn"),
        emptyState: document.getElementById("emptyState"),
        loadingState: document.getElementById("loadingState"),
        loadingText: document.getElementById("loadingText"),
        progressBar: document.getElementById("progressBar"),
        progressText: document.getElementById("progressText"),
        cancelBtn: document.getElementById("cancelBtn"),
        mainCanvas: document.getElementById("mainCanvas"),
        floatingControls: document.getElementById("floatingControls"),
        zoomLevel: document.getElementById("zoomLevel"),
        tooltip: document.getElementById("tooltip"),
        dimSelector: document.getElementById("dimSelector"),
        statsBar: document.getElementById("statsBar"),
        futureSteps: document.getElementById("futureSteps"),
        runPredictBtn: document.getElementById("runPredictBtn"),
        logFilter: document.getElementById("logFilter"),
        logSearch: document.getElementById("logSearch"),
        logContainer: document.getElementById("logContainer"),
        toastContainer: document.getElementById("toastContainer"),
        configModal: document.getElementById("configModal"),
        uploadModal: document.getElementById("uploadModal"),
        saveLoadModal: document.getElementById("saveLoadModal"),
        randomModal: document.getElementById("randomModal"),
        dataTableModal: document.getElementById("dataTableModal"),
        saveNameModal: document.getElementById("saveNameModal"),
      };

      // ==================== UTILITY FUNCTIONS ====================
      function formatNumber(num, decimals = 4) {
        if (num === null || num === undefined || isNaN(num)) return "-";
        if (Math.abs(num) < 0.0001 || Math.abs(num) >= 10000) {
          return num.toExponential(2);
        }
        return num.toFixed(decimals);
      }

      function formatExponential(num) {
        if (num === null || num === undefined || isNaN(num)) {
          return "0.00e+0";
        }
        return num.toExponential(2);
      }

      function getDimensionColor(index) {
        return DIMENSION_COLORS[index % DIMENSION_COLORS.length];
      }

      function showToast(message, type = "info", duration = 4000) {
        const toast = document.createElement("div");
        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between gap-3 animate-pulse`;
        toast.innerHTML = `
                <span>${message}</span>
                <button class="hover:opacity-75" aria-label="Close notification">‚úñÔ∏è</button>
            `;

        toast.querySelector("button").onclick = () => toast.remove();
        elements.toastContainer.appendChild(toast);

        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : duration,
        );
      }

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        state.logs.unshift({ message, type, timestamp });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const filter = elements.logFilter.value;
        const search = elements.logSearch.value.toLowerCase();

        const filtered = state.logs
          .filter((log) => filter === "all" || log.type === filter)
          .filter((log) => log.message.toLowerCase().includes(search))
          .slice(0, 50);

        const colors = {
          info: "bg-blue-100 text-blue-700",
          success: "bg-emerald-100 text-emerald-700",
          warning: "bg-amber-100 text-amber-700",
          error: "bg-red-100 text-red-700",
        };

        elements.logContainer.innerHTML = filtered.map((log) => `
                <div class="p-2 rounded-lg bg-slate-50 text-xs">
                    <span class="inline-block px-1.5 py-0.5 rounded ${
          colors[log.type]
        } font-medium mr-2">${log.type}</span>
                    <span class="text-slate-400">${log.timestamp}</span>
                    <p class="text-slate-700 mt-1">${log.message}</p>
                </div>
            `).join("");
      }

      function updateStatus() {
        if (state.modelExists) {
          elements.statusDot.className =
            "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
          elements.statusText.textContent =
            `${state.sampleCount} steps`;
          elements.predictBtn.classList.remove("hidden");
          elements.predictBtn.classList.add("flex");
          elements.runPredictBtn.disabled = false;
          document.getElementById("downloadModelBtn").disabled = false;
          document.getElementById("saveBrowserBtn").disabled = false;
        } else {
          elements.statusDot.className =
            "w-2 h-2 rounded-full bg-slate-400";
          elements.statusText.textContent = "No Model";
          elements.predictBtn.classList.add("hidden");
          elements.predictBtn.classList.remove("flex");
          elements.runPredictBtn.disabled = true;
          document.getElementById("downloadModelBtn").disabled = true;
          document.getElementById("saveBrowserBtn").disabled = true;
        }
      }

      function updateMetrics(metrics) {
        if (!metrics) return;
        state.metrics = { ...state.metrics, ...metrics };
        document.getElementById("metricSamples").textContent =
          metrics.samplesProcessed || 0;
        document.getElementById("metricLoss").textContent =
          formatExponential(metrics.averageLoss);
        document.getElementById("metricGradient").textContent =
          formatExponential(metrics.gradientNorm);
        document.getElementById("metricWeight").textContent =
          (metrics.sampleWeight || 0).toFixed(3);
      }

      function updateProgress(progress, metrics) {
        elements.progressBar.style.width = `${progress}%`;
        elements.progressText.textContent = `${progress}%`;
        if (metrics) updateMetrics(metrics);
      }

      function showLoading(text = "Processing...") {
        state.isLoading = true;
        elements.loadingState.classList.remove("hidden");
        elements.loadingText.textContent = text;
        elements.progressBar.style.width = "0%";
        elements.progressText.textContent = "0%";
      }

      function hideLoading() {
        state.isLoading = false;
        elements.loadingState.classList.add("hidden");
      }

      function persistState() {
        try {
          localStorage.setItem(
            "esn_config",
            JSON.stringify(state.config),
          );
          localStorage.setItem("esn_vizMode", state.vizMode);
        } catch (e) {
          console.warn("Failed to persist state:", e);
        }
      }

      // ==================== CHART RENDERING ====================
      const canvas = elements.mainCanvas;
      const ctx = canvas.getContext("2d");
      let animationFrame = null;

      function resizeCanvas() {
        const container = canvas.parentElement;
        const rect = container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
        ctx.scale(dpr, dpr);
        renderChart();
      }

      function renderChart() {
        if (animationFrame) cancelAnimationFrame(animationFrame);
        animationFrame = requestAnimationFrame(() => {
          const width = canvas.width / (window.devicePixelRatio || 1);
          const height = canvas.height / (window.devicePixelRatio || 1);

          ctx.clearRect(0, 0, width, height);

          if (!state.predictions && !state.trainingData) {
            elements.emptyState.classList.remove("hidden");
            elements.floatingControls.classList.add("hidden");
            return;
          }

          elements.emptyState.classList.add("hidden");
          elements.floatingControls.classList.remove("hidden");

          if (state.vizMode === "grid") {
            renderGridView(width, height);
          } else {
            renderFocusView(width, height);
          }
        });
      }

      function renderGridView(width, height) {
        const dims = state.nDimensions ||
          (state.trainingData ? state.trainingData[0].length : 0);
        if (dims === 0) return;

        const cols = Math.ceil(Math.sqrt(dims));
        const rows = Math.ceil(dims / cols);
        const padding = 16;
        const cellWidth = (width - padding * (cols + 1)) / cols;
        const cellHeight = (height - padding * (rows + 1)) / rows;

        for (let i = 0; i < dims; i++) {
          const col = i % cols;
          const row = Math.floor(i / cols);
          const x = padding + col * (cellWidth + padding);
          const y = padding + row * (cellHeight + padding);

          // Cell background
          ctx.fillStyle = "#f8fafc";
          ctx.fillRect(x, y, cellWidth, cellHeight);

          // Cell border
          ctx.strokeStyle = "#e2e8f0";
          ctx.lineWidth = 1;
          ctx.strokeRect(x, y, cellWidth, cellHeight);

          // Label
          ctx.fillStyle = "#64748b";
          ctx.font = "bold 11px system-ui";
          ctx.fillText(`D${i + 1}`, x + 8, y + 16);

          renderDimensionChart(
            i,
            x + 8,
            y + 24,
            cellWidth - 16,
            cellHeight - 32,
          );
        }
      }

      function renderFocusView(width, height) {
        const padding = { top: 40, right: 40, bottom: 60, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Background
        ctx.fillStyle = "#f8fafc";
        ctx.fillRect(
          padding.left,
          padding.top,
          chartWidth,
          chartHeight,
        );

        // Border
        ctx.strokeStyle = "#e2e8f0";
        ctx.lineWidth = 1;
        ctx.strokeRect(
          padding.left,
          padding.top,
          chartWidth,
          chartHeight,
        );

        renderDimensionChart(
          state.selectedDim,
          padding.left,
          padding.top,
          chartWidth,
          chartHeight,
          true,
        );

        // Axis labels
        ctx.fillStyle = "#64748b";
        ctx.font = "12px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Time Step", width / 2, height - 10);

        ctx.save();
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText(`Dimension ${state.selectedDim + 1}`, 0, 0);
        ctx.restore();

        // Crosshair
        if (state.hover.active) {
          ctx.strokeStyle = "#94a3b8";
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);

          ctx.beginPath();
          ctx.moveTo(state.hover.x, padding.top);
          ctx.lineTo(state.hover.x, padding.top + chartHeight);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(padding.left, state.hover.y);
          ctx.lineTo(padding.left + chartWidth, state.hover.y);
          ctx.stroke();

          ctx.setLineDash([]);
        }

        updateFocusStats();
      }

      function renderDimensionChart(
        dimIndex,
        x,
        y,
        w,
        h,
        detailed = false,
      ) {
        const trainData = state.trainingData || [];
        const predData = state.predictions;
        const color = getDimensionColor(dimIndex);

        // Collect all values for scaling
        let allValues = [];
        trainData.forEach((point) => {
          if (point[dimIndex] !== undefined) {
            allValues.push(point[dimIndex]);
          }
        });

        if (predData) {
          predData.predictions.forEach((point) => {
            if (point[dimIndex] !== undefined) {
              allValues.push(point[dimIndex]);
            }
          });
          predData.lowerBounds.forEach((point) => {
            if (point[dimIndex] !== undefined) {
              allValues.push(point[dimIndex]);
            }
          });
          predData.upperBounds.forEach((point) => {
            if (point[dimIndex] !== undefined) {
              allValues.push(point[dimIndex]);
            }
          });
        }

        if (allValues.length === 0) return;

        const minVal = Math.min(...allValues);
        const maxVal = Math.max(...allValues);
        const range = maxVal - minVal || 1;
        const padding = range * 0.1;

        const scaleX = (idx, total) =>
          x + (idx / Math.max(total - 1, 1)) * w;
        const scaleY = (val) =>
          y + h -
          ((val - minVal + padding) / (range + 2 * padding)) * h;

        const trainLen = trainData.length;
        const predLen = predData ? predData.predictions.length : 0;
        const totalLen = trainLen + predLen;

        // Apply zoom
        const zoom = state.zoom.level;
        const visibleCount = Math.ceil(totalLen / zoom);
        const maxOffset = totalLen - visibleCount;
        const offset = Math.min(
          Math.max(0, state.zoom.offsetX),
          maxOffset,
        );

        const startIdx = Math.floor(offset);
        const endIdx = Math.min(startIdx + visibleCount, totalLen);

        // Draw confidence interval (prediction area)
        if (predData && trainLen <= endIdx) {
          ctx.fillStyle = color + "20";
          ctx.beginPath();

          const predStart = Math.max(0, startIdx - trainLen);
          const predEnd = Math.min(predLen, endIdx - trainLen);

          // Upper bound
          for (let i = predStart; i < predEnd; i++) {
            const px = scaleX(
              trainLen + i - startIdx,
              endIdx - startIdx,
            );
            const py = scaleY(predData.upperBounds[i][dimIndex]);
            if (i === predStart) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }

          // Lower bound (reverse)
          for (let i = predEnd - 1; i >= predStart; i--) {
            const px = scaleX(
              trainLen + i - startIdx,
              endIdx - startIdx,
            );
            const py = scaleY(predData.lowerBounds[i][dimIndex]);
            ctx.lineTo(px, py);
          }

          ctx.closePath();
          ctx.fill();
        }

        // Draw training data line
        if (trainLen > 0 && startIdx < trainLen) {
          ctx.strokeStyle = color;
          ctx.lineWidth = detailed ? 2 : 1.5;
          ctx.beginPath();

          const dataStart = Math.max(0, startIdx);
          const dataEnd = Math.min(trainLen, endIdx);

          for (let i = dataStart; i < dataEnd; i++) {
            const px = scaleX(i - startIdx, endIdx - startIdx);
            const py = scaleY(trainData[i][dimIndex]);
            if (i === dataStart) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();
        }

        // Draw prediction line (dashed)
        if (predData && trainLen <= endIdx) {
          ctx.strokeStyle = color;
          ctx.lineWidth = detailed ? 2 : 1.5;
          ctx.setLineDash([6, 4]);
          ctx.beginPath();

          // Connect from last training point
          if (trainLen > 0 && trainLen > startIdx) {
            const lastTrainX = scaleX(
              trainLen - 1 - startIdx,
              endIdx - startIdx,
            );
            const lastTrainY = scaleY(
              trainData[trainLen - 1][dimIndex],
            );
            ctx.moveTo(lastTrainX, lastTrainY);

            const firstPredX = scaleX(
              trainLen - startIdx,
              endIdx - startIdx,
            );
            const firstPredY = scaleY(
              predData.predictions[0][dimIndex],
            );
            ctx.lineTo(firstPredX, firstPredY);
          }

          const predStart = Math.max(0, startIdx - trainLen);
          const predEnd = Math.min(predLen, endIdx - trainLen);

          for (let i = predStart; i < predEnd; i++) {
            const px = scaleX(
              trainLen + i - startIdx,
              endIdx - startIdx,
            );
            const py = scaleY(predData.predictions[i][dimIndex]);
            if (i === predStart && trainLen <= startIdx) {
              ctx.moveTo(px, py);
            } else ctx.lineTo(px, py);
          }
          ctx.stroke();
          ctx.setLineDash([]);
        }

        // Highlight hovered point
        if (
          detailed && state.hover.active && state.hover.dataIndex >= 0
        ) {
          const idx = state.hover.dataIndex;
          let val;

          if (idx < trainLen) {
            val = trainData[idx][dimIndex];
          } else if (predData && idx - trainLen < predLen) {
            val = predData.predictions[idx - trainLen][dimIndex];
          }

          if (val !== undefined) {
            const px = scaleX(idx - startIdx, endIdx - startIdx);
            const py = scaleY(val);

            // Glow effect
            ctx.fillStyle = color + "40";
            ctx.beginPath();
            ctx.arc(px, py, 12, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(px, py, 2, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        // Draw axes for detailed view
        if (detailed) {
          ctx.strokeStyle = "#cbd5e1";
          ctx.lineWidth = 1;

          // Y-axis ticks
          const yTicks = 5;
          for (let i = 0; i <= yTicks; i++) {
            const val = minVal - padding +
              (range + 2 * padding) * (i / yTicks);
            const py = y + h - (h * i / yTicks);

            ctx.beginPath();
            ctx.moveTo(x - 5, py);
            ctx.lineTo(x, py);
            ctx.stroke();

            ctx.fillStyle = "#64748b";
            ctx.font = "10px system-ui";
            ctx.textAlign = "right";
            ctx.fillText(formatNumber(val, 2), x - 8, py + 3);
          }

          // X-axis ticks
          const xTicks = Math.min(10, endIdx - startIdx);
          for (let i = 0; i <= xTicks; i++) {
            const idx = startIdx +
              Math.round((endIdx - startIdx) * i / xTicks);
            const px = x + (w * i / xTicks);

            ctx.beginPath();
            ctx.moveTo(px, y + h);
            ctx.lineTo(px, y + h + 5);
            ctx.stroke();

            ctx.fillStyle = "#64748b";
            ctx.font = "10px system-ui";
            ctx.textAlign = "center";
            ctx.fillText(idx.toString(), px, y + h + 16);
          }
        }
      }

      function updateFocusStats() {
        const dim = state.selectedDim;
        const predData = state.predictions;

        if (!predData) {
          document.getElementById("statMin").textContent = "-";
          document.getElementById("statMax").textContent = "-";
          document.getElementById("statMean").textContent = "-";
          document.getElementById("statFinal").textContent = "-";
          document.getElementById("statTrend").textContent = "-";
          document.getElementById("statConfidence").textContent = "-";
          return;
        }

        const values = predData.predictions.map((p) => p[dim]);
        const min = Math.min(...values);
        const max = Math.max(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const final = values[values.length - 1];
        const first = values[0];
        const trend = final - first;

        document.getElementById("statMin").textContent = formatNumber(
          min,
          3,
        );
        document.getElementById("statMax").textContent = formatNumber(
          max,
          3,
        );
        document.getElementById("statMean").textContent = formatNumber(
          mean,
          3,
        );
        document.getElementById("statFinal").textContent = formatNumber(
          final,
          3,
        );

        const trendEl = document.getElementById("statTrend");
        if (trend > 0) {
          trendEl.innerHTML = `<span class="text-emerald-600">‚Üë ${
            formatNumber(Math.abs(trend), 3)
          }</span>`;
        } else if (trend < 0) {
          trendEl.innerHTML = `<span class="text-red-600">‚Üì ${
            formatNumber(Math.abs(trend), 3)
          }</span>`;
        } else {
          trendEl.textContent = "‚Üí 0";
        }

        document.getElementById("statConfidence").textContent =
          predData.confidence
            ? `${(predData.confidence * 100).toFixed(1)}%`
            : "-";
      }

      // ==================== MODAL MANAGEMENT ====================
      function openModal(modalEl) {
        modalEl.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        modalEl.querySelector("button, input")?.focus();
      }

      function closeModal(modalEl) {
        modalEl.classList.add("hidden");
        document.body.style.overflow = "";
      }

      function closeMenu() {
        elements.slideMenu.classList.add("translate-x-full");
        elements.menuOverlay.classList.add("hidden");
      }

      function openMenu() {
        elements.slideMenu.classList.remove("translate-x-full");
        elements.menuOverlay.classList.remove("hidden");
      }

      // ==================== CONFIGURATION ====================
      function getConfigFromForm() {
        return {
          reservoirSize: parseInt(
            document.getElementById("cfg-reservoirSize").value,
          ),
          spectralRadius: parseFloat(
            document.getElementById("cfg-spectralRadius").value,
          ),
          leakRate: parseFloat(
            document.getElementById("cfg-leakRate").value,
          ),
          inputScale: parseFloat(
            document.getElementById("cfg-inputScale").value,
          ),
          biasScale: parseFloat(
            document.getElementById("cfg-biasScale").value,
          ),
          reservoirSparsity: parseFloat(
            document.getElementById("cfg-reservoirSparsity").value,
          ),
          inputSparsity: parseFloat(
            document.getElementById("cfg-inputSparsity").value,
          ),
          activation: document.getElementById("cfg-activation").value,
          useInputInReadout:
            document.getElementById("cfg-useInputInReadout").dataset
              .value === "true",
          useBiasInReadout:
            document.getElementById("cfg-useBiasInReadout").dataset
              .value === "true",
          readoutTraining: "rls",
          rlsLambda: parseFloat(
            document.getElementById("cfg-rlsLambda").value,
          ),
          rlsDelta: parseFloat(
            document.getElementById("cfg-rlsDelta").value,
          ),
          epsilon: parseFloat(
            document.getElementById("cfg-epsilon").value,
          ),
          l2Lambda: parseFloat(
            document.getElementById("cfg-l2Lambda").value,
          ),
          gradientClipNorm: parseFloat(
            document.getElementById("cfg-gradientClipNorm").value,
          ),
          normalizationEpsilon: parseFloat(
            document.getElementById("cfg-normalizationEpsilon").value,
          ),
          normalizationWarmup: parseInt(
            document.getElementById("cfg-normalizationWarmup").value,
          ),
          outlierThreshold: parseFloat(
            document.getElementById("cfg-outlierThreshold").value,
          ),
          outlierMinWeight: parseFloat(
            document.getElementById("cfg-outlierMinWeight").value,
          ),
          uncertaintyMultiplier: parseFloat(
            document.getElementById("cfg-uncertaintyMultiplier").value,
          ),
          weightInitScale: parseFloat(
            document.getElementById("cfg-weightInitScale").value,
          ),
          seed: parseInt(document.getElementById("cfg-seed").value),
          verbose:
            document.getElementById("cfg-verbose").dataset.value ===
              "true",
        };
      }

      function setConfigForm(config) {
        document.getElementById("cfg-reservoirSize").value =
          config.reservoirSize;
        document.getElementById("cfg-spectralRadius").value =
          config.spectralRadius;
        document.getElementById("cfg-leakRate").value = config.leakRate;
        document.getElementById("cfg-inputScale").value =
          config.inputScale;
        document.getElementById("cfg-biasScale").value =
          config.biasScale;
        document.getElementById("cfg-reservoirSparsity").value =
          config.reservoirSparsity;
        document.getElementById("cfg-inputSparsity").value =
          config.inputSparsity;
        document.getElementById("cfg-activation").value =
          config.activation;
        setToggle("cfg-useInputInReadout", config.useInputInReadout);
        setToggle("cfg-useBiasInReadout", config.useBiasInReadout);
        document.getElementById("cfg-rlsLambda").value =
          config.rlsLambda;
        document.getElementById("cfg-rlsDelta").value = config.rlsDelta;
        document.getElementById("cfg-epsilon").value = config.epsilon;
        document.getElementById("cfg-l2Lambda").value = config.l2Lambda;
        document.getElementById("cfg-gradientClipNorm").value =
          config.gradientClipNorm;
        document.getElementById("cfg-normalizationEpsilon").value =
          config.normalizationEpsilon;
        document.getElementById("cfg-normalizationWarmup").value =
          config.normalizationWarmup;
        document.getElementById("cfg-outlierThreshold").value =
          config.outlierThreshold;
        document.getElementById("cfg-outlierMinWeight").value =
          config.outlierMinWeight;
        document.getElementById("cfg-uncertaintyMultiplier").value =
          config.uncertaintyMultiplier;
        document.getElementById("cfg-weightInitScale").value =
          config.weightInitScale;
        document.getElementById("cfg-seed").value = config.seed;
        setToggle("cfg-verbose", config.verbose);
      }

      function setToggle(id, value) {
        const el = document.getElementById(id);
        el.dataset.value = value.toString();
        if (value) {
          el.classList.remove("bg-slate-300");
          el.classList.add("bg-blue-500");
          el.querySelector("span").classList.remove("left-1");
          el.querySelector("span").classList.add("right-1");
        } else {
          el.classList.add("bg-slate-300");
          el.classList.remove("bg-blue-500");
          el.querySelector("span").classList.add("left-1");
          el.querySelector("span").classList.remove("right-1");
        }
      }

      function applyPreset(presetName) {
        const base = { ...DEFAULT_CONFIG };
        const preset = PRESETS[presetName] || {};
        const config = { ...base, ...preset };
        setConfigForm(config);

        document.querySelectorAll(".preset-btn").forEach((btn) => {
          if (btn.dataset.preset === presetName) {
            btn.classList.remove("bg-slate-100", "text-slate-700");
            btn.classList.add("bg-blue-500", "text-white");
          } else {
            btn.classList.add("bg-slate-100", "text-slate-700");
            btn.classList.remove("bg-blue-500", "text-white");
          }
        });
      }

      // ==================== MODEL OPERATIONS ====================
      async function createModel() {
        try {
          const config = getConfigFromForm();
          state.config = config;
          persistState();

          const result = await sendWorkerMessage("createModel", {
            config,
          });
          if (result.success) {
            state.modelExists = true;
            state.sampleCount = 0;
            state.predictions = null;
            updateStatus();
            addLog("Model created with new configuration", "success");
            showToast("Model created successfully", "success");
            closeModal(elements.configModal);
            renderChart();
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Failed to create model: " + e.message, "error");
          showToast("Failed to create model: " + e.message, "error");
        }
      }

      async function trainModel(coordinates) {
        try {
          showLoading("Training on uploaded data...");
          state.trainingData = coordinates;
          state.nDimensions = coordinates[0].length;

          const result = await sendWorkerMessage("train", {
            coordinates,
          });

          if (result.cancelled) {
            addLog("Training cancelled", "warning");
            showToast("Training cancelled", "warning");
          } else if (result.success) {
            state.sampleCount = result.metrics?.samplesProcessed ||
              coordinates.length;
            updateMetrics(result.metrics);
            updateStatus();
            addLog(
              `Trained on ${coordinates.length} samples`,
              "success",
            );
            showToast("Training completed", "success");
            renderChart();
            updateDimensionSelector();
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Training failed: " + e.message, "error");
          showToast("Training failed: " + e.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function runPrediction() {
        try {
          const futureSteps = parseInt(elements.futureSteps.value) ||
            50;
          if (futureSteps < 1) {
            showToast(
              "Please enter a valid number of steps",
              "warning",
            );
            return;
          }

          showLoading("Generating predictions...");

          const result = await sendWorkerMessage("predict", {
            futureSteps,
          });

          if (result.success) {
            state.predictions = result.result;
            addLog(
              `Generated ${futureSteps} step predictions`,
              "success",
            );
            showToast("Prediction completed", "success");
            renderChart();
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Prediction failed: " + e.message, "error");
          showToast("Prediction failed: " + e.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function resetModel() {
        try {
          await sendWorkerMessage("reset");
          state.modelExists = false;
          state.predictions = null;
          state.trainingData = null;
          state.nDimensions = 0;
          state.sampleCount = 0;
          state.metrics = {
            samplesProcessed: 0,
            averageLoss: 0,
            gradientNorm: 0,
            driftDetected: false,
            sampleWeight: 0,
          };
          updateStatus();
          updateMetrics(state.metrics);
          renderChart();
          addLog("Model reset", "info");
        } catch (e) {
          addLog("Reset failed: " + e.message, "error");
        }
      }

      // ==================== DATA GENERATION ====================
      function generateRandomData(
        seed,
        dimensions,
        timeSteps,
        noise,
        outlierRate,
        difficulty,
      ) {
        const rand = seededRandom(seed);
        const data = [];

        const complexityFactors = { easy: 1, medium: 2, hard: 3 };
        const complexity = complexityFactors[difficulty] || 2;

        for (let t = 0; t < timeSteps; t++) {
          const point = [];
          for (let d = 0; d < dimensions; d++) {
            let value = 0;

            // Base signal
            for (let f = 1; f <= complexity; f++) {
              value += Math.sin(
                2 * Math.PI * f * t / (50 / f) +
                  d * Math.PI / dimensions,
              );
              value += 0.5 *
                Math.cos(2 * Math.PI * f * t / (30 / f) - d);
            }

            // Trend
            value += t * 0.001 * (d + 1);

            // Noise
            value += (rand() - 0.5) * 2 * noise;

            // Outliers
            if (rand() < outlierRate) {
              value += (rand() - 0.5) * 10;
            }

            point.push(value);
          }
          data.push(point);
        }

        return data;
      }

      function seededRandom(seed) {
        let s = seed;
        return function () {
          s = Math.sin(s) * 10000;
          return s - Math.floor(s);
        };
      }

      // ==================== DATA VALIDATION ====================
      function validateDataset(jsonStr) {
        try {
          const data = JSON.parse(jsonStr);

          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            return {
              valid: false,
              error: 'Missing or invalid "coordinates" array',
            };
          }

          if (data.coordinates.length < 2) {
            return {
              valid: false,
              error: "Need at least 2 time steps",
            };
          }

          const dims = data.coordinates[0].length;
          if (!dims || dims < 1) {
            return { valid: false, error: "Invalid dimensions" };
          }

          for (let i = 0; i < data.coordinates.length; i++) {
            if (!Array.isArray(data.coordinates[i])) {
              return {
                valid: false,
                error: `Invalid data at step ${i}`,
              };
            }
            if (data.coordinates[i].length !== dims) {
              return {
                valid: false,
                error: `Inconsistent dimensions at step ${i}`,
              };
            }
            for (let j = 0; j < dims; j++) {
              if (
                typeof data.coordinates[i][j] !== "number" ||
                isNaN(data.coordinates[i][j])
              ) {
                return {
                  valid: false,
                  error: `Invalid number at step ${i}, dimension ${j}`,
                };
              }
            }
          }

          return {
            valid: true,
            dimensions: dims,
            steps: data.coordinates.length,
            coordinates: data.coordinates,
          };
        } catch (e) {
          return { valid: false, error: "Invalid JSON: " + e.message };
        }
      }

      // ==================== DIMENSION SELECTOR ====================
      function updateDimensionSelector() {
        const dims = state.nDimensions;
        elements.dimSelector.innerHTML = "";

        for (let i = 0; i < dims; i++) {
          const btn = document.createElement("button");
          btn.className =
            `px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap transition-all ${
              i === state.selectedDim
                ? "text-white shadow-lg"
                : "bg-slate-100 text-slate-700 hover:bg-slate-200"
            }`;
          if (i === state.selectedDim) {
            btn.style.backgroundColor = getDimensionColor(i);
          }
          btn.textContent = `D${i + 1}`;
          btn.onclick = () => {
            state.selectedDim = i;
            updateDimensionSelector();
            renderChart();
          };
          elements.dimSelector.appendChild(btn);
        }
      }

      // ==================== VISUALIZATION MODE ====================
      function setVizMode(mode) {
        state.vizMode = mode;
        persistState();

        document.querySelectorAll(".viz-tab").forEach((tab) => {
          if (tab.dataset.viz === mode) {
            tab.classList.remove("bg-slate-100", "text-slate-700");
            tab.classList.add(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-indigo-600",
              "text-white",
              "shadow-lg",
              "shadow-blue-500/30",
            );
          } else {
            tab.classList.add("bg-slate-100", "text-slate-700");
            tab.classList.remove(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-indigo-600",
              "text-white",
              "shadow-lg",
              "shadow-blue-500/30",
            );
          }
        });

        if (mode === "focus") {
          elements.dimSelector.classList.remove("hidden");
          elements.statsBar.classList.remove("hidden");
        } else {
          elements.dimSelector.classList.add("hidden");
          elements.statsBar.classList.add("hidden");
        }

        renderChart();
      }

      // ==================== SAVE/LOAD ====================
      async function saveModelToFile() {
        try {
          const result = await sendWorkerMessage("save");
          if (result.success) {
            const blob = new Blob([
              JSON.stringify(result.state, null, 2),
            ], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `esn-model-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            addLog("Model saved to file", "success");
            showToast("Model downloaded", "success");
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Save failed: " + e.message, "error");
          showToast("Save failed", "error");
        }
      }

      async function saveModelToBrowser(name) {
        try {
          const result = await sendWorkerMessage("save");
          if (result.success) {
            const savedModels = JSON.parse(
              localStorage.getItem("esn_savedModels") || "{}",
            );
            savedModels[name] = {
              state: result.state,
              dimensions: state.nDimensions,
              timestamp: Date.now(),
            };
            localStorage.setItem(
              "esn_savedModels",
              JSON.stringify(savedModels),
            );
            addLog(`Model saved as "${name}"`, "success");
            showToast("Model saved to browser", "success");
            updateSavedModelsList();
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Save failed: " + e.message, "error");
          showToast("Save failed", "error");
        }
      }

      async function loadModelFromState(modelState) {
        try {
          showLoading("Loading model...");
          const result = await sendWorkerMessage("load", {
            state: modelState,
          });
          if (result.success) {
            state.modelExists = true;

            const summary = await sendWorkerMessage("getSummary");
            if (summary.success) {
              state.sampleCount = summary.summary.sampleCount || 0;
              state.nDimensions = summary.summary.nTargets || 0;
            }

            updateStatus();
            addLog("Model loaded successfully", "success");
            showToast("Model loaded", "success");
            updateDimensionSelector();
            renderChart();
          } else {
            throw new Error(result.error);
          }
        } catch (e) {
          addLog("Load failed: " + e.message, "error");
          showToast("Load failed", "error");
        } finally {
          hideLoading();
        }
      }

      function updateSavedModelsList() {
        const savedModels = JSON.parse(
          localStorage.getItem("esn_savedModels") || "{}",
        );
        const list = document.getElementById("savedModelsList");

        const names = Object.keys(savedModels);
        if (names.length === 0) {
          list.innerHTML =
            '<p class="text-sm text-slate-500 text-center py-4">No saved models</p>';
          return;
        }

        list.innerHTML = names.map((name) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                    <div>
                        <p class="font-medium text-slate-900">${name}</p>
                        <p class="text-xs text-slate-500">${
          savedModels[name].dimensions || "?"
        } dimensions</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadSavedModel('${name}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">Load</button>
                        <button onclick="deleteSavedModel('${name}')" class="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200">Delete</button>
                    </div>
                </div>
            `).join("");
      }

      window.loadSavedModel = async function (name) {
        const savedModels = JSON.parse(
          localStorage.getItem("esn_savedModels") || "{}",
        );
        if (savedModels[name]) {
          await loadModelFromState(savedModels[name].state);
          closeModal(elements.saveLoadModal);
        }
      };

      window.deleteSavedModel = function (name) {
        const savedModels = JSON.parse(
          localStorage.getItem("esn_savedModels") || "{}",
        );
        delete savedModels[name];
        localStorage.setItem(
          "esn_savedModels",
          JSON.stringify(savedModels),
        );
        updateSavedModelsList();
        showToast("Model deleted", "info");
      };

      // ==================== DATA TABLE ====================
      function renderDataTable() {
        const predData = state.predictions;
        if (!predData) return;

        const dims = predData.predictions[0].length;
        const header = document.getElementById("tableHeader");
        const body = document.getElementById("tableBody");

        // Header
        let headerHtml =
          '<th class="px-4 py-3 text-left font-semibold text-slate-700 cursor-pointer hover:bg-slate-100" data-sort="step">Step</th>';
        for (let d = 0; d < dims; d++) {
          headerHtml +=
            `<th class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-100" style="color: ${
              getDimensionColor(d)
            }" data-sort="p${d}">P${d + 1}</th>`;
        }
        for (let d = 0; d < dims; d++) {
          headerHtml +=
            `<th class="px-4 py-3 text-left font-semibold text-slate-500 cursor-pointer hover:bg-slate-100" data-sort="l${d}">L${
              d + 1
            }</th>`;
        }
        for (let d = 0; d < dims; d++) {
          headerHtml +=
            `<th class="px-4 py-3 text-left font-semibold text-slate-500 cursor-pointer hover:bg-slate-100" data-sort="u${d}">U${
              d + 1
            }</th>`;
        }
        header.innerHTML = headerHtml;

        // Body
        const search = document.getElementById("tableSearch").value
          .toLowerCase();
        let bodyHtml = "";

        for (let i = 0; i < predData.predictions.length; i++) {
          const rowData = [
            i + 1,
            ...predData.predictions[i],
            ...predData.lowerBounds[i],
            ...predData.upperBounds[i],
          ];
          const rowStr = rowData.join(" ");

          if (search && !rowStr.toLowerCase().includes(search)) {
            continue;
          }

          const bgClass = i % 2 === 0 ? "bg-white" : "bg-slate-50";
          bodyHtml += `<tr class="${bgClass} hover:bg-blue-50">`;
          bodyHtml +=
            `<td class="px-4 py-2 font-medium text-slate-900">${
              i + 1
            }</td>`;

          for (let d = 0; d < dims; d++) {
            bodyHtml += `<td class="px-4 py-2" style="color: ${
              getDimensionColor(d)
            }">${formatNumber(predData.predictions[i][d], 4)}</td>`;
          }
          for (let d = 0; d < dims; d++) {
            bodyHtml += `<td class="px-4 py-2 text-slate-500">${
              formatNumber(predData.lowerBounds[i][d], 4)
            }</td>`;
          }
          for (let d = 0; d < dims; d++) {
            bodyHtml += `<td class="px-4 py-2 text-slate-500">${
              formatNumber(predData.upperBounds[i][d], 4)
            }</td>`;
          }
          bodyHtml += "</tr>";
        }

        body.innerHTML = bodyHtml;
      }

      function exportCSV() {
        const predData = state.predictions;
        if (!predData) return;

        const dims = predData.predictions[0].length;
        let csv = "Step";
        for (let d = 0; d < dims; d++) csv += `,P${d + 1}`;
        for (let d = 0; d < dims; d++) csv += `,L${d + 1}`;
        for (let d = 0; d < dims; d++) csv += `,U${d + 1}`;
        csv += "\n";

        for (let i = 0; i < predData.predictions.length; i++) {
          csv += i + 1;
          for (let d = 0; d < dims; d++) {
            csv += `,${predData.predictions[i][d]}`;
          }
          for (let d = 0; d < dims; d++) {
            csv += `,${predData.lowerBounds[i][d]}`;
          }
          for (let d = 0; d < dims; d++) {
            csv += `,${predData.upperBounds[i][d]}`;
          }
          csv += "\n";
        }

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `esn-predictions-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("CSV exported", "success");
      }

      // ==================== EXPORT CHART ====================
      function exportChartAsPNG() {
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `esn-chart-${Date.now()}.png`;
        a.click();
        showToast("PNG exported", "success");
      }

      function exportChartAsSVG() {
        // Create SVG from canvas (simplified)
        const width = canvas.width / (window.devicePixelRatio || 1);
        const height = canvas.height / (window.devicePixelRatio || 1);

        let svg =
          `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">`;
        svg += `<rect width="100%" height="100%" fill="#f8fafc"/>`;
        svg +=
          `<image href="${canvas.toDataURL()}" width="${width}" height="${height}"/>`;
        svg += `</svg>`;

        const blob = new Blob([svg], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `esn-chart-${Date.now()}.svg`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("SVG exported", "success");
      }

      async function copyChartToClipboard() {
        try {
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/png")
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("Chart copied to clipboard", "success");
        } catch (e) {
          showToast("Failed to copy chart", "error");
        }
      }

      // ==================== EVENT LISTENERS ====================

      // Menu
      elements.menuBtn.onclick = openMenu;
      elements.closeMenuBtn.onclick = closeMenu;
      elements.menuOverlay.onclick = closeMenu;

      // Config modal
      elements.configBtn.onclick = () => {
        setConfigForm(state.config);
        openModal(elements.configModal);
      };
      document.getElementById("closeConfigBtn").onclick = () =>
        closeModal(elements.configModal);
      document.getElementById("cancelConfigBtn").onclick = () =>
        closeModal(elements.configModal);
      document.getElementById("createModelBtn").onclick = createModel;
      document.getElementById("menuConfigBtn").onclick = () => {
        closeMenu();
        setConfigForm(state.config);
        openModal(elements.configModal);
      };

      // Presets
      document.querySelectorAll(".preset-btn").forEach((btn) => {
        btn.onclick = () => applyPreset(btn.dataset.preset);
      });

      // Reset buttons
      document.getElementById("resetDefaultsBtn").onclick = () =>
        applyPreset("default");
      document.getElementById("resetAllBtn").onclick = async () => {
        applyPreset("default");
        await resetModel();
      };

      // Config section toggles
      document.querySelectorAll(".config-section-toggle").forEach(
        (toggle) => {
          toggle.onclick = () => {
            const content = toggle.nextElementSibling;
            const icon = toggle.querySelector(".toggle-icon");
            const expanded =
              toggle.getAttribute("aria-expanded") === "true";

            toggle.setAttribute(
              "aria-expanded",
              (!expanded).toString(),
            );
            content.classList.toggle("hidden");
            icon.textContent = expanded ? "‚ñ∂" : "‚ñº";
          };
        },
      );

      // Toggle switches
      document.querySelectorAll(".toggle-switch").forEach((toggle) => {
        toggle.onclick = () => {
          const current = toggle.dataset.value === "true";
          setToggle(toggle.id, !current);
        };
      });

      // Upload modal
      document.getElementById("menuUploadBtn").onclick = () => {
        closeMenu();
        openModal(elements.uploadModal);
      };
      document.getElementById("closeUploadBtn").onclick = () =>
        closeModal(elements.uploadModal);
      document.getElementById("cancelUploadBtn").onclick = () =>
        closeModal(elements.uploadModal);

      // Drag and drop
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const pasteArea = document.getElementById("pasteArea");

      dropZone.onclick = () => fileInput.click();
      dropZone.ondragover = (e) => {
        e.preventDefault();
        dropZone.classList.add("border-blue-500", "bg-blue-50");
      };
      dropZone.ondragleave = () => {
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
      };
      dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      };

      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      };

      function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          pasteArea.value = e.target.result;
          validateUpload();
        };
        reader.readAsText(file);
      }

      document.getElementById("validateBtn").onclick = validateUpload;

      function validateUpload() {
        const jsonStr = pasteArea.value;
        const result = validateDataset(jsonStr);
        const feedback = document.getElementById("validationFeedback");
        const success = document.getElementById("validationSuccess");
        const error = document.getElementById("validationError");

        feedback.classList.remove("hidden");

        if (result.valid) {
          feedback.classList.remove("bg-red-50");
          feedback.classList.add("bg-emerald-50");
          success.classList.remove("hidden");
          error.classList.add("hidden");
          document.getElementById("validationDims").textContent =
            result.dimensions;
          document.getElementById("validationSteps").textContent =
            result.steps;
          document.getElementById("applyTrainBtn").disabled = false;
          state.validatedData = result.coordinates;
        } else {
          feedback.classList.add("bg-red-50");
          feedback.classList.remove("bg-emerald-50");
          success.classList.add("hidden");
          error.classList.remove("hidden");
          document.getElementById("validationErrorMsg").textContent =
            result.error;
          document.getElementById("applyTrainBtn").disabled = true;
          state.validatedData = null;
        }
      }

      document.getElementById("applyTrainBtn").onclick = async () => {
        if (!state.validatedData) return;

        closeModal(elements.uploadModal);

        if (!state.modelExists) {
          await createModel();
        }

        await trainModel(state.validatedData);
        state.validatedData = null;
      };

      // Format example toggle
      document.getElementById("toggleFormatExample").onclick = () => {
        const content = document.getElementById("formatExampleContent");
        const toggle = document.getElementById("toggleFormatExample");
        const icon = toggle.querySelector(".toggle-icon");
        const expanded =
          toggle.getAttribute("aria-expanded") === "true";

        toggle.setAttribute("aria-expanded", (!expanded).toString());
        content.classList.toggle("hidden");
        icon.textContent = expanded ? "‚ñ∂" : "‚ñº";
      };

      document.getElementById("copyExampleBtn").onclick = () => {
        const example = `{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}`;
        navigator.clipboard.writeText(example);
        showToast("Example copied", "success");
      };

      // Save/Load modal
      document.getElementById("menuSaveLoadBtn").onclick = () => {
        closeMenu();
        updateSavedModelsList();
        openModal(elements.saveLoadModal);
      };
      document.getElementById("closeSaveLoadBtn").onclick = () =>
        closeModal(elements.saveLoadModal);
      document.getElementById("closeSaveLoadFooterBtn").onclick = () =>
        closeModal(elements.saveLoadModal);
      document.getElementById("loadEmptyBtn").onclick = () => {
        updateSavedModelsList();
        openModal(elements.saveLoadModal);
      };

      document.getElementById("downloadModelBtn").onclick =
        saveModelToFile;
      document.getElementById("saveBrowserBtn").onclick = () => {
        openModal(elements.saveNameModal);
        document.getElementById("saveNameInput").value =
          `Model ${Date.now()}`;
        document.getElementById("saveNameInput").focus();
      };

      document.getElementById("cancelSaveNameBtn").onclick = () =>
        closeModal(elements.saveNameModal);
      document.getElementById("confirmSaveNameBtn").onclick = () => {
        const name = document.getElementById("saveNameInput").value
          .trim();
        if (name) {
          saveModelToBrowser(name);
          closeModal(elements.saveNameModal);
        }
      };

      // Load file
      const loadDropZone = document.getElementById("loadDropZone");
      const loadFileInput = document.getElementById("loadFileInput");

      loadDropZone.onclick = () => loadFileInput.click();
      loadFileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const modelState = JSON.parse(e.target.result);
              closeModal(elements.saveLoadModal);
              await loadModelFromState(modelState);
            } catch (err) {
              showToast("Invalid model file", "error");
            }
          };
          reader.readAsText(file);
        }
      };

      // Random test modal
      document.getElementById("menuRandomBtn").onclick = () => {
        closeMenu();
        openModal(elements.randomModal);
      };
      document.getElementById("closeRandomBtn").onclick = () =>
        closeModal(elements.randomModal);
      document.getElementById("cancelRandomBtn").onclick = () =>
        closeModal(elements.randomModal);
      document.getElementById("demoBtn").onclick = () =>
        openModal(elements.randomModal);

      document.getElementById("generateRunBtn").onclick = async () => {
        const seed = parseInt(
          document.getElementById("rand-seed").value,
        );
        const dimensions = parseInt(
          document.getElementById("rand-dimensions").value,
        );
        const timeSteps = parseInt(
          document.getElementById("rand-timeSteps").value,
        );
        const noise = parseFloat(
          document.getElementById("rand-noise").value,
        );
        const outliers = parseFloat(
          document.getElementById("rand-outliers").value,
        );
        const difficulty =
          document.getElementById("rand-difficulty").value;

        closeModal(elements.randomModal);

        const data = generateRandomData(
          seed,
          dimensions,
          timeSteps,
          noise,
          outliers,
          difficulty,
        );

        if (!state.modelExists) {
          await createModel();
        }

        await trainModel(data);
        await runPrediction();
      };

      // Data table modal
      document.getElementById("menuDataTableBtn").onclick = () => {
        closeMenu();
        if (!state.predictions) {
          showToast("No predictions to display", "warning");
          return;
        }
        renderDataTable();
        openModal(elements.dataTableModal);
      };
      document.getElementById("closeDataTableBtn").onclick = () =>
        closeModal(elements.dataTableModal);
      document.getElementById("tableSearch").oninput = renderDataTable;
      document.getElementById("exportCsvBtn").onclick = exportCSV;
      document.getElementById("copyAllBtn").onclick = () => {
        const table = document.getElementById("dataTable");
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        showToast("Table copied", "success");
      };

      // Prediction buttons
      elements.predictBtn.onclick = runPrediction;
      elements.runPredictBtn.onclick = runPrediction;

      // Start with defaults
      document.getElementById("startDefaultBtn").onclick = async () => {
        applyPreset("default");
        await createModel();
      };

      // Visualization tabs
      document.querySelectorAll(".viz-tab").forEach((tab) => {
        tab.onclick = () => setVizMode(tab.dataset.viz);
      });

      // Cancel button
      elements.cancelBtn.onclick = () => {
        sendWorkerMessage("cancel");
      };

      // Log filters
      elements.logFilter.onchange = renderLogs;
      elements.logSearch.oninput = renderLogs;

      // Zoom controls
      document.getElementById("zoomInBtn").onclick = () => {
        state.zoom.level = Math.min(state.zoom.level * 1.5, 10);
        elements.zoomLevel.textContent =
          Math.round(state.zoom.level * 100) + "%";
        renderChart();
      };
      document.getElementById("zoomOutBtn").onclick = () => {
        state.zoom.level = Math.max(state.zoom.level / 1.5, 1);
        elements.zoomLevel.textContent =
          Math.round(state.zoom.level * 100) + "%";
        renderChart();
      };
      document.getElementById("zoomResetBtn").onclick = () => {
        state.zoom = {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        };
        elements.zoomLevel.textContent = "100%";
        renderChart();
      };

      // Export controls
      document.getElementById("exportPngBtn").onclick =
        exportChartAsPNG;
      document.getElementById("exportSvgBtn").onclick =
        exportChartAsSVG;
      document.getElementById("copyChartBtn").onclick =
        copyChartToClipboard;

      // Canvas interactions
      let isDragging = false;
      let dragStartX = 0;
      let dragStartOffset = 0;
      let touchStartDist = 0;
      let touchStartZoom = 1;
      let longPressTimer = null;

      canvas.onmousedown = (e) => {
        isDragging = true;
        dragStartX = e.clientX;
        dragStartOffset = state.zoom.offsetX;
      };

      canvas.onmousemove = (e) => {
        const rect = canvas.getBoundingClientRect();
        state.hover.x = e.clientX - rect.left;
        state.hover.y = e.clientY - rect.top;
        state.hover.active = true;

        // Calculate data index with proper padding and zoom
        let paddingLeft, chartWidth;
        if (state.vizMode === "focus") {
          paddingLeft = 60;
          chartWidth = rect.width - 100; // left: 60, right: 40
        } else {
          paddingLeft = 16;
          chartWidth = rect.width - paddingLeft * 2;
        }

        const trainLen = state.trainingData?.length || 0;
        const predLen = state.predictions?.predictions.length || 0;
        const totalLen = trainLen + predLen;

        if (totalLen > 0) {
          const zoom = state.zoom.level;
          const visibleCount = Math.ceil(totalLen / zoom);
          const maxOffset = Math.max(0, totalLen - visibleCount);
          const offset = Math.min(
            Math.max(0, state.zoom.offsetX),
            maxOffset,
          );
          const startIdx = Math.floor(offset);
          const endIdx = Math.min(startIdx + visibleCount, totalLen);

          const relX = (state.hover.x - paddingLeft) / chartWidth;
          const range = Math.max(endIdx - startIdx - 1, 1);
          state.hover.dataIndex = Math.round(startIdx + relX * range);

          // Clamp to valid range
          state.hover.dataIndex = Math.max(
            startIdx,
            Math.min(endIdx - 1, state.hover.dataIndex),
          );
        } else {
          state.hover.dataIndex = -1;
        }

        if (isDragging && state.zoom.level > 1) {
          const dx = e.clientX - dragStartX;
          const scale = totalLen / chartWidth;
          state.zoom.offsetX = Math.max(
            0,
            dragStartOffset - dx * scale / state.zoom.level,
          );
        }

        updateTooltip();
        renderChart();
      };

      canvas.onmouseup = () => {
        isDragging = false;
      };
      canvas.onmouseleave = () => {
        isDragging = false;
        state.hover.active = false;
        elements.tooltip.classList.add("hidden");
        renderChart();
      };

      canvas.onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        state.zoom.level = Math.max(
          1,
          Math.min(10, state.zoom.level * delta),
        );
        elements.zoomLevel.textContent =
          Math.round(state.zoom.level * 100) + "%";
        renderChart();
      };

      // Touch events
      canvas.ontouchstart = (e) => {
        if (e.touches.length === 1) {
          dragStartX = e.touches[0].clientX;
          dragStartOffset = state.zoom.offsetX;

          longPressTimer = setTimeout(() => {
            const rect = canvas.getBoundingClientRect();
            state.hover.x = e.touches[0].clientX - rect.left;
            state.hover.y = e.touches[0].clientY - rect.top;
            state.hover.active = true;
            updateTooltip();
            renderChart();
          }, 500);
        } else if (e.touches.length === 2) {
          clearTimeout(longPressTimer);
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          touchStartDist = Math.sqrt(dx * dx + dy * dy);
          touchStartZoom = state.zoom.level;
        }
      };

      canvas.ontouchmove = (e) => {
        e.preventDefault();
        clearTimeout(longPressTimer);

        if (e.touches.length === 1 && state.zoom.level > 1) {
          const rect = canvas.getBoundingClientRect();
          const trainLen = state.trainingData?.length || 0;
          const predLen = state.predictions?.predictions.length || 0;
          const totalLen = trainLen + predLen;

          const dx = e.touches[0].clientX - dragStartX;
          const scale = totalLen / rect.width;
          state.zoom.offsetX = Math.max(
            0,
            dragStartOffset - dx * scale / state.zoom.level,
          );
          renderChart();
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const scale = dist / touchStartDist;
          state.zoom.level = Math.max(
            1,
            Math.min(10, touchStartZoom * scale),
          );
          elements.zoomLevel.textContent =
            Math.round(state.zoom.level * 100) + "%";
          renderChart();
        }
      };

      canvas.ontouchend = () => {
        clearTimeout(longPressTimer);
        state.hover.active = false;
        elements.tooltip.classList.add("hidden");
        renderChart();
      };

      function updateTooltip() {
        if (!state.hover.active || state.hover.dataIndex < 0) {
          elements.tooltip.classList.add("hidden");
          return;
        }

        const trainLen = state.trainingData?.length || 0;
        const predData = state.predictions;
        const idx = state.hover.dataIndex;
        const dim = state.vizMode === "focus" ? state.selectedDim : 0;

        let value, lower, upper;

        if (idx < trainLen && state.trainingData) {
          value = state.trainingData[idx][dim];
          lower = upper = value;
        } else if (
          predData && idx >= trainLen &&
          idx - trainLen < predData.predictions.length
        ) {
          const predIdx = idx - trainLen;
          value = predData.predictions[predIdx][dim];
          lower = predData.lowerBounds[predIdx][dim];
          upper = predData.upperBounds[predIdx][dim];
        } else {
          elements.tooltip.classList.add("hidden");
          return;
        }

        document.getElementById("tooltipStep").textContent = `Step ${
          idx + 1
        }`;
        document.getElementById("tooltipDimDot").style.backgroundColor =
          getDimensionColor(dim);
        document.getElementById("tooltipDimLabel").textContent =
          `Dimension ${dim + 1}`;
        document.getElementById("tooltipValue").textContent =
          formatNumber(value, 4);
        document.getElementById("tooltipCI").textContent = `${
          formatNumber(lower, 3)
        } - ${formatNumber(upper, 3)}`;
        document.getElementById("tooltipSpread").textContent =
          formatNumber(upper - lower, 4);

        const rect = canvas.getBoundingClientRect();
        let left = state.hover.x + 16;
        let top = state.hover.y + 16;

        if (left + 200 > rect.width) left = state.hover.x - 200;
        if (top + 150 > rect.height) top = state.hover.y - 150;

        elements.tooltip.style.left = left + "px";
        elements.tooltip.style.top = top + "px";
        elements.tooltip.classList.remove("hidden");
      }

      // Window resize
      window.addEventListener("resize", resizeCanvas);

      // Click outside modals to close
      [
        elements.configModal,
        elements.uploadModal,
        elements.saveLoadModal,
        elements.randomModal,
        elements.dataTableModal,
      ].forEach((modal) => {
        modal.onclick = (e) => {
          if (e.target === modal) closeModal(modal);
        };
      });

      // Initialize
      setVizMode(state.vizMode);
      setConfigForm(state.config);
      updateStatus();
      renderLogs();
      resizeCanvas();
      addLog("ESN Regression Studio initialized", "info");
    </script>
  </body>
</html>
