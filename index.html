<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ§  ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            boxShadow: {
              soft: "0 10px 30px rgba(0,0,0,0.12)",
              glow:
                "0 0 0 1px rgba(255,255,255,0.12), 0 20px 50px rgba(0,0,0,0.35)",
            },
          },
        },
      };
    </script>
  </head>

  <body
    class="min-h-screen bg-slate-950 text-slate-100 selection:bg-sky-500/30"
  >
    <!-- BACKDROP -->
    <div class="pointer-events-none fixed inset-0">
      <div
        class="absolute inset-0 bg-[radial-gradient(60%_40%_at_20%_0%,rgba(56,189,248,0.18),transparent_55%),radial-gradient(55%_45%_at_95%_15%,rgba(168,85,247,0.14),transparent_60%),radial-gradient(70%_60%_at_45%_100%,rgba(34,197,94,0.12),transparent_60%)]"
      >
      </div>
      <div
        class="absolute inset-0 bg-[linear-gradient(to_bottom,rgba(2,6,23,0.4),rgba(2,6,23,0.9))]"
      >
      </div>
    </div>

    <!-- TOP BAR -->
    <header
      class="relative z-10 mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6"
    >
      <div class="flex items-center gap-3">
        <button
          id="btnMenu"
          class="group inline-flex items-center justify-center rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10 backdrop-blur hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
          aria-label="Open menu"
        >
          <svg
            class="h-5 w-5 text-slate-200 group-hover:text-white"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path
              d="M4 7h16M4 12h16M4 17h16"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <div class="flex flex-col leading-tight">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold tracking-wide text-white"
            >ðŸ§  ESN Regression Studio</span>
            <span
              id="statusPill"
              class="inline-flex items-center gap-2 rounded-full bg-white/5 px-2.5 py-1 text-xs text-slate-200 ring-1 ring-white/10"
            >
              <span
                id="statusDot"
                class="h-2 w-2 rounded-full bg-amber-400"
              ></span>
              <span id="statusText">Idle</span>
            </span>
          </div>
          <span class="text-xs text-slate-400"
          >Worker-based â€¢ JSON-only â€¢ N-dimensional visualization</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          id="btnQuickPredict"
          class="hidden sm:inline-flex items-center gap-2 rounded-xl bg-sky-500/15 px-4 py-2 text-sm font-medium text-sky-200 ring-1 ring-sky-400/30 backdrop-blur hover:bg-sky-500/20 hover:text-sky-100 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          Predict
        </button>
        <button
          id="btnReset"
          class="inline-flex items-center gap-2 rounded-xl bg-rose-500/10 px-4 py-2 text-sm font-medium text-rose-200 ring-1 ring-rose-400/20 backdrop-blur hover:bg-rose-500/15 focus:outline-none focus:ring-2 focus:ring-rose-400/50"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
            <path
              d="M3 12a9 9 0 0 1 15.5-6.36M21 12a9 9 0 0 1-15.5 6.36"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M18 3v5h-5"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M6 21v-5h5"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Reset
        </button>
      </div>
    </header>

    <!-- MAIN -->
    <main
      class="relative z-10 mx-auto grid max-w-7xl grid-cols-1 gap-4 px-4 pb-10 sm:px-6 lg:grid-cols-12 lg:gap-6"
    >
      <!-- LEFT: SUMMARY -->
      <section class="lg:col-span-5">
        <div
          class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 backdrop-blur shadow-soft"
        >
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold text-white">Model Summary</h2>
              <p class="mt-1 text-xs text-slate-400">
                Live snapshot from the worker.
              </p>
            </div>
            <button
              id="btnOpenConfig"
              class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M19.4 15a7.98 7.98 0 0 0 .1-1 7.98 7.98 0 0 0-.1-1l2.1-1.6-2-3.4-2.5 1a7.9 7.9 0 0 0-1.7-1l-.4-2.7H9.1l-.4 2.7a7.9 7.9 0 0 0-1.7 1l-2.5-1-2 3.4L4.6 13a7.98 7.98 0 0 0-.1 1 7.98 7.98 0 0 0 .1 1L2.5 16.6l2 3.4 2.5-1a7.9 7.9 0 0 0 1.7 1l.4 2.7h5.8l.4-2.7a7.9 7.9 0 0 0 1.7-1l2.5 1 2-3.4L19.4 15Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
              </svg>
              Configure
            </button>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3">
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Initialized</div>
              <div
                id="sumInitialized"
                class="mt-1 text-sm font-semibold text-white"
              >
                No
              </div>
            </div>
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Samples</div>
              <div
                id="sumSamples"
                class="mt-1 text-sm font-semibold text-white"
              >
                0
              </div>
            </div>
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Reservoir</div>
              <div
                id="sumReservoir"
                class="mt-1 text-sm font-semibold text-white"
              >
                â€”
              </div>
            </div>
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Features</div>
              <div
                id="sumFeatures"
                class="mt-1 text-sm font-semibold text-white"
              >
                â€”
              </div>
            </div>
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Targets</div>
              <div
                id="sumTargets"
                class="mt-1 text-sm font-semibold text-white"
              >
                â€”
              </div>
            </div>
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="text-[11px] text-slate-400">Spectral Radius</div>
              <div
                id="sumSpectral"
                class="mt-1 text-sm font-semibold text-white"
              >
                â€”
              </div>
            </div>
          </div>

          <div class="mt-4 rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-[11px] text-slate-400">Last Fit Result</div>
                <div id="fitLine" class="mt-1 text-sm font-semibold text-white">
                  No training yet
                </div>
              </div>
              <button
                id="btnOpenData"
                class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M7 7h10M7 12h10M7 17h6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                </svg>
                Add Data
              </button>
            </div>
            <div
              class="mt-2 grid grid-cols-2 gap-2 text-xs text-slate-300 sm:grid-cols-4"
            >
              <div class="rounded-lg bg-white/5 px-2 py-1 ring-1 ring-white/10">
                loss: <span id="fitLoss" class="font-semibold text-white"
                >â€”</span>
              </div>
              <div class="rounded-lg bg-white/5 px-2 py-1 ring-1 ring-white/10">
                grad: <span id="fitGrad" class="font-semibold text-white"
                >â€”</span>
              </div>
              <div class="rounded-lg bg-white/5 px-2 py-1 ring-1 ring-white/10">
                weight: <span id="fitWeight" class="font-semibold text-white"
                >â€”</span>
              </div>
              <div class="rounded-lg bg-white/5 px-2 py-1 ring-1 ring-white/10">
                drift: <span id="fitDrift" class="font-semibold text-white"
                >â€”</span>
              </div>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button
              id="btnSave"
              class="inline-flex items-center gap-2 rounded-xl bg-emerald-500/10 px-3 py-2 text-xs font-medium text-emerald-200 ring-1 ring-emerald-400/20 hover:bg-emerald-500/15 focus:outline-none focus:ring-2 focus:ring-emerald-400/50"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                <path
                  d="M7 7h10v14H7z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M9 7V4h6v3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M9 14h6"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Save JSON
            </button>

            <button
              id="btnLoad"
              class="inline-flex items-center gap-2 rounded-xl bg-violet-500/10 px-3 py-2 text-xs font-medium text-violet-200 ring-1 ring-violet-400/20 hover:bg-violet-500/15 focus:outline-none focus:ring-2 focus:ring-violet-400/50"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                <path
                  d="M7 20h10V10H7z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
                <path
                  d="M9 4h6v6H9z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linejoin="round"
                />
              </svg>
              Load JSON
            </button>

            <button
              id="btnOpenPredict"
              class="inline-flex items-center gap-2 rounded-xl bg-sky-500/15 px-3 py-2 text-xs font-medium text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 3v18M3 12h18"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Predict
            </button>

            <button
              id="btnOpenRandom"
              class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
            >
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                <path
                  d="M4 4h7v7H4zM13 13h7v7h-7z"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M14 4h6v6"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
                <path
                  d="M20 4l-7 7"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              Random Test
            </button>
          </div>

          <div class="mt-4 rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-[11px] text-slate-400">
                  Upload Format (JSON only)
                </div>
                <div class="mt-1 text-xs text-slate-300">
                  <span class="font-semibold text-white">Bulk fit:</span>
                  <code class="rounded bg-white/5 px-1 py-0.5"
                  >{"xCoordinates":[[...]],"yCoordinates":[[...]]}</code>
                </div>
              </div>
              <button
                id="btnOpenFormat"
                class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M12 18h.01M12 6h.01"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                  <path
                    d="M10.5 10a2.5 2.5 0 1 1 3.5 2.3c-.8.3-1.5 1-1.5 1.7V15"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                  <path
                    d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
                Details
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: VISUALIZATION -->
      <section class="lg:col-span-7">
        <div
          class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 backdrop-blur shadow-soft"
        >
          <div
            class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
          >
            <div>
              <h2 class="text-base font-semibold text-white">Predictions</h2>
              <p class="mt-1 text-xs text-slate-400">
                Heatmap (steps Ã— targets) + selected target chart with bounds.
              </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <label
                class="inline-flex items-center gap-2 rounded-xl bg-black/20 px-3 py-2 text-xs ring-1 ring-white/10"
              >
                <span class="text-slate-300">Steps</span>
                <input
                  id="stepsInput"
                  type="number"
                  min="1"
                  max="512"
                  value="10"
                  class="w-20 rounded-lg bg-white/5 px-2 py-1 text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
                />
              </label>

              <label
                class="inline-flex items-center gap-2 rounded-xl bg-black/20 px-3 py-2 text-xs ring-1 ring-white/10"
              >
                <span class="text-slate-300">Target</span>
                <select
                  id="targetSelect"
                  class="max-w-[160px] rounded-lg bg-white/5 px-2 py-1 text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
                >
                  <option value="0">0</option>
                </select>
              </label>

              <button
                id="btnPredict"
                class="inline-flex items-center gap-2 rounded-xl bg-sky-500/15 px-4 py-2 text-xs font-semibold text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M6 7l12 5-12 5V7Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linejoin="round"
                  />
                </svg>
                Run Predict
              </button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <div class="text-xs font-semibold text-white">Heatmap</div>
                <div class="text-[11px] text-slate-400" id="heatmapMeta">â€”</div>
              </div>
              <div class="mt-2 overflow-hidden rounded-lg ring-1 ring-white/10">
                <canvas
                  id="heatmapCanvas"
                  class="block h-56 w-full bg-slate-950"
                ></canvas>
              </div>
              <div
                class="mt-2 flex items-center justify-between text-[11px] text-slate-400"
              >
                <span>Low</span>
                <span class="opacity-70">normalized by global min/max</span>
                <span>High</span>
              </div>
            </div>

            <div class="rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <div class="text-xs font-semibold text-white">
                  Selected Target
                </div>
                <div class="text-[11px] text-slate-400" id="lineMeta">â€”</div>
              </div>
              <div class="mt-2 overflow-hidden rounded-lg ring-1 ring-white/10">
                <canvas
                  id="lineCanvas"
                  class="block h-56 w-full bg-slate-950"
                ></canvas>
              </div>
              <div class="mt-2 text-[11px] text-slate-400">
                Line = prediction â€¢ band = confidence bounds â€¢ overall
                confidence:
                <span id="confText" class="font-semibold text-white">â€”</span>
              </div>
            </div>
          </div>

          <div class="mt-4 rounded-xl bg-black/20 p-3 ring-1 ring-white/10">
            <div
              class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
            >
              <div class="text-xs font-semibold text-white">
                Preview (first steps, selected target)
              </div>
              <div class="text-[11px] text-slate-400">
                JSON output stays in memory until you export/save
              </div>
            </div>
            <div
              class="mt-2 max-h-44 overflow-auto rounded-lg bg-white/5 p-2 font-mono text-[11px] leading-5 text-slate-200 ring-1 ring-white/10"
            >
              <pre id="previewOut">No prediction yet.</pre>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- DRAWER MENU -->
    <div
      id="menuOverlay"
      class="fixed inset-0 z-30 hidden bg-black/60 backdrop-blur-sm"
    >
    </div>
    <aside
      id="menuDrawer"
      class="fixed left-0 top-0 z-40 h-full w-[88%] max-w-sm -translate-x-full transform bg-slate-950/90 shadow-glow ring-1 ring-white/10 backdrop-blur transition-transform duration-300 ease-out"
      aria-hidden="true"
    >
      <div class="flex items-center justify-between px-4 py-4">
        <div class="flex items-center gap-2">
          <div
            class="h-9 w-9 rounded-2xl bg-white/5 ring-1 ring-white/10 flex items-center justify-center"
          >
            ðŸ§ 
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold text-white">Studio Menu</div>
            <div class="text-xs text-slate-400">Keep things tidy.</div>
          </div>
        </div>
        <button
          id="btnCloseMenu"
          class="rounded-xl bg-white/5 p-2 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
          aria-label="Close menu"
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none">
            <path
              d="M6 6l12 12M18 6L6 18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>

      <div class="px-4 pb-6">
        <div class="space-y-3">
          <details class="group rounded-2xl bg-white/5 ring-1 ring-white/10">
            <summary
              class="cursor-pointer list-none px-4 py-3 text-sm font-semibold text-white"
            >
              <div class="flex items-center justify-between">
                <span>Model</span>
                <span
                  class="text-slate-400 group-open:rotate-180 transition-transform"
                >â–¾</span>
              </div>
            </summary>
            <div class="px-4 pb-4 space-y-2">
              <button
                id="menuConfig"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Configure & Instantiate
              </button>
              <button
                id="menuSave"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Save Model (JSON)
              </button>
              <button
                id="menuLoad"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Load Model (JSON)
              </button>
              <button
                id="menuReset"
                class="w-full rounded-xl bg-rose-500/10 px-3 py-2 text-left text-sm text-rose-200 ring-1 ring-rose-400/20 hover:bg-rose-500/15"
              >
                Reset Model
              </button>
            </div>
          </details>

          <details class="group rounded-2xl bg-white/5 ring-1 ring-white/10">
            <summary
              class="cursor-pointer list-none px-4 py-3 text-sm font-semibold text-white"
            >
              <div class="flex items-center justify-between">
                <span>Data</span>
                <span
                  class="text-slate-400 group-open:rotate-180 transition-transform"
                >â–¾</span>
              </div>
            </summary>
            <div class="px-4 pb-4 space-y-2">
              <button
                id="menuBulk"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Bulk Upload & Train
              </button>
              <button
                id="menuManual"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Manual Insert (JSON)
              </button>
              <button
                id="menuFormat"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Upload Format Help
              </button>
            </div>
          </details>

          <details class="group rounded-2xl bg-white/5 ring-1 ring-white/10">
            <summary
              class="cursor-pointer list-none px-4 py-3 text-sm font-semibold text-white"
            >
              <div class="flex items-center justify-between">
                <span>Prediction</span>
                <span
                  class="text-slate-400 group-open:rotate-180 transition-transform"
                >â–¾</span>
              </div>
            </summary>
            <div class="px-4 pb-4 space-y-2">
              <button
                id="menuPredict"
                class="w-full rounded-xl bg-sky-500/15 px-3 py-2 text-left text-sm text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20"
              >
                Predict (multi-horizon)
              </button>
              <button
                id="menuRandom"
                class="w-full rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Generate Random Standard Test
              </button>
            </div>
          </details>

          <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
            <div class="text-sm font-semibold text-white">Tips</div>
            <ul class="mt-2 space-y-1 text-xs text-slate-300">
              <li>â€¢ Configure first, then add data (bulk or manual).</li>
              <li>
                â€¢ Use <span class="font-semibold text-white">rlsLambda</span> to
                control adaptivity (drift vs stability).
              </li>
              <li>
                â€¢ If overfitting, raise <span class="font-semibold text-white"
                >l2Lambda</span> or reduce <span
                  class="font-semibold text-white"
                >reservoirSize</span>.
              </li>
              <li>
                â€¢ For fast-changing signals, increase <span
                  class="font-semibold text-white"
                >leakRate</span> and reduce <span
                  class="font-semibold text-white"
                >spectralRadius</span>.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </aside>

    <!-- LOADING OVERLAY -->
    <div
      id="busyOverlay"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm"
    >
      <div
        class="w-[90%] max-w-md rounded-2xl bg-slate-950/90 p-4 ring-1 ring-white/10 shadow-glow"
      >
        <div class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-2xl bg-white/5 ring-1 ring-white/10 flex items-center justify-center"
          >
            <div
              class="h-5 w-5 animate-spin rounded-full border-2 border-white/20 border-t-white"
            >
            </div>
          </div>
          <div class="flex-1">
            <div id="busyTitle" class="text-sm font-semibold text-white">
              Workingâ€¦
            </div>
            <div id="busySub" class="mt-0.5 text-xs text-slate-400">
              Please wait.
            </div>
          </div>
        </div>

        <div class="mt-3 hidden" id="busyBarWrap">
          <div
            class="h-2 w-full overflow-hidden rounded-full bg-white/10 ring-1 ring-white/10"
          >
            <div id="busyBar" class="h-full w-0 bg-sky-400/60"></div>
          </div>
          <div class="mt-1 flex justify-between text-[11px] text-slate-400">
            <span id="busyLeft">â€”</span>
            <span id="busyRight">â€”</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TOASTS -->
    <div
      id="toastHost"
      class="fixed bottom-4 right-4 z-[60] flex w-[92%] max-w-sm flex-col gap-2 sm:w-auto"
    >
    </div>

    <!-- MODALS -->
    <div
      id="modalHost"
      class="fixed inset-0 z-[55] hidden items-center justify-center bg-black/60 p-3 backdrop-blur-sm"
    >
      <div
        id="modalCard"
        class="max-h-[90vh] w-full max-w-3xl overflow-hidden rounded-2xl bg-slate-950/90 ring-1 ring-white/10 shadow-glow backdrop-blur"
      >
        <div
          class="flex items-start justify-between gap-3 border-b border-white/10 px-4 py-4"
        >
          <div>
            <div id="modalTitle" class="text-base font-semibold text-white">
              Modal
            </div>
            <div id="modalSubtitle" class="mt-1 text-xs text-slate-400">â€”</div>
          </div>
          <button
            id="btnCloseModal"
            class="rounded-xl bg-white/5 p-2 ring-1 ring-white/10 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
            aria-label="Close modal"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none">
              <path
                d="M6 6l12 12M18 6L6 18"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
        <div id="modalBody" class="max-h-[calc(90vh-68px)] overflow-auto p-4">
        </div>
      </div>
    </div>

    <script type="module">
      // =========================
      // Worker (Blob module)
      // =========================
      const WORKER_CODE = `
        import { ESNRegression } from "https://cdn.esm.sh/jsr/@hviana/multivariate-regression";

        let model = null;

        function ok(id, data) {
          postMessage({ id, ok: true, data });
        }
        function fail(id, error) {
          const msg = (error && (error.stack || error.message)) ? (error.stack || error.message) : String(error);
          postMessage({ id, ok: false, error: msg });
        }
        function ensure() {
          if (!model) throw new Error("Model is not initialized. Call init(config) first.");
        }

        onmessage = (e) => {
          const { id, type, payload } = e.data || {};
          try {
            if (!id) throw new Error("Missing request id.");
            switch (type) {
              case "init": {
                const cfg = (payload && payload.config) ? payload.config : {};
                model = new ESNRegression(cfg);
                ok(id, { summary: model.getModelSummary() });
                break;
              }
              case "fit": {
                ensure();
                const args = payload || {};
                const res = model.fitOnline(args);
                ok(id, res);
                break;
              }
              case "predict": {
                ensure();
                const steps = (payload && payload.futureSteps) ? payload.futureSteps : 1;
                const res = model.predict(steps);
                ok(id, res);
                break;
              }
              case "summary": {
                ensure();
                ok(id, model.getModelSummary());
                break;
              }
              case "norm": {
                ensure();
                ok(id, model.getNormalizationStats());
                break;
              }
              case "weights": {
                ensure();
                ok(id, model.getWeights());
                break;
              }
              case "save": {
                ensure();
                const serialized = model.save();
                ok(id, { serialized });
                break;
              }
              case "load": {
                ensure();
                const s = payload && payload.serialized;
                if (typeof s !== "string" || !s.length) throw new Error("Missing serialized model string.");
                model.load(s);
                ok(id, { summary: model.getModelSummary() });
                break;
              }
              case "reset": {
                ensure();
                model.reset();
                ok(id, { summary: model.getModelSummary() });
                break;
              }
              default:
                throw new Error("Unknown message type: " + type);
            }
          } catch (err) {
            fail(id, err);
          }
        };
      `;

      const workerUrl = URL.createObjectURL(
        new Blob([WORKER_CODE], { type: "text/javascript" }),
      );
      const worker = new Worker(workerUrl, { type: "module" });
      // Safe to revoke after instantiation; the worker keeps its own copy.
      URL.revokeObjectURL(workerUrl);

      // =========================
      // UI Helpers
      // =========================
      const $ = (id) => document.getElementById(id);

      const statusDot = $("statusDot");
      const statusText = $("statusText");
      const sumInitialized = $("sumInitialized");
      const sumSamples = $("sumSamples");
      const sumReservoir = $("sumReservoir");
      const sumFeatures = $("sumFeatures");
      const sumTargets = $("sumTargets");
      const sumSpectral = $("sumSpectral");

      const fitLine = $("fitLine");
      const fitLoss = $("fitLoss");
      const fitGrad = $("fitGrad");
      const fitWeight = $("fitWeight");
      const fitDrift = $("fitDrift");

      const stepsInput = $("stepsInput");
      const targetSelect = $("targetSelect");
      const confText = $("confText");
      const previewOut = $("previewOut");

      const heatmapCanvas = $("heatmapCanvas");
      const lineCanvas = $("lineCanvas");
      const heatmapMeta = $("heatmapMeta");
      const lineMeta = $("lineMeta");

      const toastHost = $("toastHost");

      function toast(kind, title, msg) {
        const el = document.createElement("div");
        const tone = kind === "ok"
          ? "bg-emerald-500/10 ring-emerald-400/20 text-emerald-100"
          : kind === "warn"
          ? "bg-amber-500/10 ring-amber-400/20 text-amber-100"
          : "bg-rose-500/10 ring-rose-400/20 text-rose-100";
        el.className =
          `rounded-2xl p-3 ring-1 shadow-soft backdrop-blur ${tone}`;
        el.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="mt-0.5 h-2 w-2 rounded-full ${
          kind === "ok"
            ? "bg-emerald-400"
            : kind === "warn"
            ? "bg-amber-400"
            : "bg-rose-400"
        }"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold">${
          escapeHtml(title)
        }</div>
              <div class="mt-0.5 text-xs opacity-90">${
          escapeHtml(msg)
        }</div>
            </div>
            <button class="rounded-lg bg-white/5 px-2 py-1 text-xs ring-1 ring-white/10 hover:bg-white/10">Close</button>
          </div>
        `;
        el.querySelector("button").onclick = () => el.remove();
        toastHost.appendChild(el);
        setTimeout(() => {
          if (el.isConnected) el.remove();
        }, 4500);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Busy overlay
      const busyOverlay = $("busyOverlay");
      const busyTitle = $("busyTitle");
      const busySub = $("busySub");
      const busyBarWrap = $("busyBarWrap");
      const busyBar = $("busyBar");
      const busyLeft = $("busyLeft");
      const busyRight = $("busyRight");

      let busyCount = 0;
      function setBusy(
        on,
        title = "Workingâ€¦",
        subtitle = "Please wait.",
      ) {
        if (on) busyCount++;
        else busyCount = Math.max(0, busyCount - 1);

        const active = busyCount > 0;
        busyOverlay.classList.toggle("hidden", !active);
        busyOverlay.classList.toggle("flex", active);
        if (active) {
          busyTitle.textContent = title;
          busySub.textContent = subtitle;
        }
      }
      function setBusyProgress(pct, leftText = "", rightText = "") {
        const show = pct !== null && pct !== undefined;
        busyBarWrap.classList.toggle("hidden", !show);
        if (!show) return;
        const clamped = Math.max(0, Math.min(100, pct));
        busyBar.style.width = clamped.toFixed(1) + "%";
        busyLeft.textContent = leftText || "â€”";
        busyRight.textContent = rightText || "â€”";
      }

      function setStatus(mode, text) {
        statusText.textContent = text;
        if (mode === "busy") {
          statusDot.className = "h-2 w-2 rounded-full bg-sky-400";
        } else if (mode === "ok") {
          statusDot.className = "h-2 w-2 rounded-full bg-emerald-400";
        } else if (mode === "err") {
          statusDot.className = "h-2 w-2 rounded-full bg-rose-400";
        } else {statusDot.className =
            "h-2 w-2 rounded-full bg-amber-400";}
      }

      // =========================
      // Worker RPC
      // =========================
      const pending = new Map();
      function uuid() {
        return Math.random().toString(16).slice(2) +
          Date.now().toString(16);
      }

      worker.onmessage = (e) => {
        const { id, ok, data, error } = e.data || {};
        const p = pending.get(id);
        if (!p) return;
        pending.delete(id);
        ok
          ? p.resolve(data)
          : p.reject(new Error(error || "Worker error"));
      };

      worker.onerror = (e) => {
        setStatus("err", "Worker error");
        toast("err", "Worker crashed", e.message || "Unknown error");
      };

      async function callWorker(type, payload, busyLabel) {
        const id = uuid();
        setStatus("busy", "Working");
        setBusy(
          true,
          busyLabel || "Workingâ€¦",
          "Running in a Web Worker.",
        );
        return await new Promise((resolve, reject) => {
          pending.set(id, { resolve, reject });
          worker.postMessage({ id, type, payload });
        })
          .finally(() => {
            setBusy(false);
            setBusyProgress(null);
            setStatus("ok", "Ready");
          });
      }

      // =========================
      // App State
      // =========================
      let lastPrediction = null;
      let modelInitialized = false;
      let lastSummary = null;

      function updateSummaryUI(summary) {
        lastSummary = summary || null;
        modelInitialized = !!summary;
        sumInitialized.textContent = modelInitialized ? "Yes" : "No";
        sumSamples.textContent = summary?.sampleCount ?? "0";
        sumReservoir.textContent = summary?.reservoirSize ?? "â€”";
        sumFeatures.textContent = summary?.nFeatures ?? "â€”";
        sumTargets.textContent = summary?.nTargets ?? "â€”";
        sumSpectral.textContent = summary?.spectralRadius ?? "â€”";

        // target selector
        const nT = Number(summary?.nTargets || 0);
        targetSelect.innerHTML = "";
        if (nT > 0) {
          for (let i = 0; i < nT; i++) {
            const opt = document.createElement("option");
            opt.value = String(i);
            opt.textContent = String(i);
            targetSelect.appendChild(opt);
          }
        } else {
          const opt = document.createElement("option");
          opt.value = "0";
          opt.textContent = "0";
          targetSelect.appendChild(opt);
        }
      }

      // =========================
      // Canvas Rendering
      // =========================
      function resizeCanvasToCss(canvas) {
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(
          1,
          Math.min(2, window.devicePixelRatio || 1),
        );
        const w = Math.max(1, Math.floor(rect.width * dpr));
        const h = Math.max(1, Math.floor(rect.height * dpr));
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w;
          canvas.height = h;
        }
        return { w, h, dpr };
      }

      function lerp(a, b, t) {
        return a + (b - a) * t;
      }

      function colorRamp(t) {
        // t in [0,1] -> pleasant ramp (purple->sky->emerald->amber)
        t = Math.max(0, Math.min(1, t));
        let r = 0, g = 0, b = 0;
        if (t < 0.33) {
          const u = t / 0.33;
          r = lerp(168, 56, u);
          g = lerp(85, 189, u);
          b = lerp(247, 248, u);
        } else if (t < 0.66) {
          const u = (t - 0.33) / 0.33;
          r = lerp(56, 34, u);
          g = lerp(189, 197, u);
          b = lerp(248, 94, u);
        } else {
          const u = (t - 0.66) / 0.34;
          r = lerp(34, 245, u);
          g = lerp(197, 158, u);
          b = lerp(94, 11, u);
        }
        return `rgb(${Math.round(r)},${Math.round(g)},${
          Math.round(b)
        })`;
      }

      function drawHeatmap(pred) {
        const { w, h } = resizeCanvasToCss(heatmapCanvas);
        const ctx = heatmapCanvas.getContext("2d");
        ctx.clearRect(0, 0, w, h);

        const P = pred?.predictions;
        if (!Array.isArray(P) || !P.length || !Array.isArray(P[0])) {
          ctx.fillStyle = "rgba(255,255,255,0.7)";
          ctx.font = `${
            Math.floor(h * 0.09)
          }px ui-sans-serif, system-ui`;
          ctx.fillText(
            "No data",
            Math.floor(w * 0.08),
            Math.floor(h * 0.55),
          );
          heatmapMeta.textContent = "â€”";
          return;
        }

        const steps = P.length;
        const targets = P[0].length;

        let minV = Infinity;
        let maxV = -Infinity;
        for (let i = 0; i < steps; i++) {
          const row = P[i];
          for (let j = 0; j < targets; j++) {
            const v = row[j];
            if (v < minV) minV = v;
            if (v > maxV) maxV = v;
          }
        }
        const span = Math.max(1e-12, maxV - minV);

        const cellW = w / targets;
        const cellH = h / steps;

        for (let i = 0; i < steps; i++) {
          for (let j = 0; j < targets; j++) {
            const v = P[i][j];
            const t = (v - minV) / span;
            ctx.fillStyle = colorRamp(t);
            ctx.fillRect(
              j * cellW,
              i * cellH,
              Math.ceil(cellW),
              Math.ceil(cellH),
            );
          }
        }

        // subtle grid
        ctx.globalAlpha = 0.12;
        ctx.strokeStyle = "white";
        ctx.lineWidth = 1;
        for (let j = 1; j < targets; j++) {
          ctx.beginPath();
          ctx.moveTo(j * cellW, 0);
          ctx.lineTo(j * cellW, h);
          ctx.stroke();
        }
        for (let i = 1; i < steps; i++) {
          ctx.beginPath();
          ctx.moveTo(0, i * cellH);
          ctx.lineTo(w, i * cellH);
          ctx.stroke();
        }
        ctx.globalAlpha = 1;

        heatmapMeta.textContent =
          `${steps} steps Ã— ${targets} targets (min=${fmt(minV)} max=${
            fmt(maxV)
          })`;
      }

      function drawLine(pred, targetIdx) {
        const { w, h } = resizeCanvasToCss(lineCanvas);
        const ctx = lineCanvas.getContext("2d");
        ctx.clearRect(0, 0, w, h);

        const P = pred?.predictions;
        const L = pred?.lowerBounds;
        const U = pred?.upperBounds;
        if (!Array.isArray(P) || !P.length || !Array.isArray(P[0])) {
          ctx.fillStyle = "rgba(255,255,255,0.7)";
          ctx.font = `${
            Math.floor(h * 0.09)
          }px ui-sans-serif, system-ui`;
          ctx.fillText(
            "No data",
            Math.floor(w * 0.08),
            Math.floor(h * 0.55),
          );
          lineMeta.textContent = "â€”";
          return;
        }

        const steps = P.length;
        const t = Math.max(
          0,
          Math.min((P[0].length || 1) - 1, targetIdx),
        );

        let minV = Infinity;
        let maxV = -Infinity;
        for (let i = 0; i < steps; i++) {
          const v = P[i][t];
          const lo = Array.isArray(L?.[i]) ? L[i][t] : v;
          const up = Array.isArray(U?.[i]) ? U[i][t] : v;
          if (lo < minV) minV = lo;
          if (up > maxV) maxV = up;
        }
        const pad = (maxV - minV) * 0.08 + 1e-9;
        minV -= pad;
        maxV += pad;

        const margin = Math.floor(Math.min(w, h) * 0.12);
        const x0 = margin;
        const y0 = margin;
        const x1 = w - margin;
        const y1 = h - margin;

        function x(i) {
          const u = steps <= 1 ? 0 : i / (steps - 1);
          return x0 + u * (x1 - x0);
        }
        function y(v) {
          const u = (v - minV) / Math.max(1e-12, maxV - minV);
          return y1 - u * (y1 - y0);
        }

        // axes
        ctx.globalAlpha = 0.35;
        ctx.strokeStyle = "white";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x0, y1);
        ctx.lineTo(x1, y1);
        ctx.stroke();
        ctx.globalAlpha = 1;

        // band
        if (Array.isArray(L) && Array.isArray(U)) {
          ctx.fillStyle = "rgba(56,189,248,0.18)";
          ctx.beginPath();
          for (let i = 0; i < steps; i++) {
            ctx.lineTo(x(i), y(U[i][t]));
          }
          for (let i = steps - 1; i >= 0; i--) {
            ctx.lineTo(x(i), y(L[i][t]));
          }
          ctx.closePath();
          ctx.fill();
        }

        // line
        ctx.strokeStyle = "rgba(255,255,255,0.95)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < steps; i++) {
          const v = P[i][t];
          const xi = x(i);
          const yi = y(v);
          if (i === 0) ctx.moveTo(xi, yi);
          else ctx.lineTo(xi, yi);
        }
        ctx.stroke();

        // points
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        for (let i = 0; i < steps; i++) {
          const v = P[i][t];
          ctx.beginPath();
          ctx.arc(x(i), y(v), 2.5, 0, Math.PI * 2);
          ctx.fill();
        }

        lineMeta.textContent = `target=${t} â€¢ range ${fmt(minV)}..${
          fmt(maxV)
        }`;
      }

      function fmt(x) {
        if (!Number.isFinite(x)) return "â€”";
        const ax = Math.abs(x);
        if (ax >= 1000) return x.toFixed(1);
        if (ax >= 10) return x.toFixed(3);
        if (ax >= 1) return x.toFixed(5);
        return x.toFixed(7);
      }

      function updatePreview(pred, targetIdx) {
        if (!pred?.predictions?.length) {
          previewOut.textContent = "No prediction yet.";
          return;
        }
        const steps = pred.predictions.length;
        const t = Math.max(
          0,
          Math.min((pred.predictions[0].length || 1) - 1, targetIdx),
        );
        const rows = [];
        const maxRows = Math.min(steps, 16);
        for (let i = 0; i < maxRows; i++) {
          const v = pred.predictions[i][t];
          const lo = pred.lowerBounds?.[i]?.[t];
          const up = pred.upperBounds?.[i]?.[t];
          rows.push({
            step: i + 1,
            prediction: v,
            lower: lo,
            upper: up,
          });
        }
        previewOut.textContent = JSON.stringify(
          {
            confidence: pred.confidence,
            selectedTarget: t,
            preview: rows,
            note: steps > maxRows
              ? `showing first ${maxRows}/${steps} steps`
              : "showing all steps",
          },
          null,
          2,
        );
      }

      function redrawAll() {
        const t = Number(targetSelect.value || 0);
        drawHeatmap(lastPrediction);
        drawLine(lastPrediction, t);
        confText.textContent = lastPrediction?.confidence != null
          ? `${(lastPrediction.confidence * 100).toFixed(1)}%`
          : "â€”";
        updatePreview(lastPrediction, t);
      }

      window.addEventListener("resize", () => redrawAll());

      // =========================
      // Modal Framework
      // =========================
      const modalHost = $("modalHost");
      const modalTitle = $("modalTitle");
      const modalSubtitle = $("modalSubtitle");
      const modalBody = $("modalBody");

      function openModal(title, subtitle, bodyHtml) {
        modalTitle.textContent = title;
        modalSubtitle.textContent = subtitle || "â€”";
        modalBody.innerHTML = bodyHtml || "";
        modalHost.classList.remove("hidden");
        modalHost.classList.add("flex");
      }
      function closeModal() {
        modalHost.classList.add("hidden");
        modalHost.classList.remove("flex");
        modalBody.innerHTML = "";
      }
      $("btnCloseModal").onclick = closeModal;
      modalHost.addEventListener("click", (e) => {
        if (e.target === modalHost) closeModal();
      });

      // =========================
      // Drawer Menu
      // =========================
      const menuOverlay = $("menuOverlay");
      const menuDrawer = $("menuDrawer");

      function openMenu() {
        menuOverlay.classList.remove("hidden");
        menuDrawer.style.transform = "translateX(0)";
        menuDrawer.setAttribute("aria-hidden", "false");
      }
      function closeMenu() {
        menuOverlay.classList.add("hidden");
        menuDrawer.style.transform = "translateX(-100%)";
        menuDrawer.setAttribute("aria-hidden", "true");
      }

      $("btnMenu").onclick = openMenu;
      $("btnCloseMenu").onclick = closeMenu;
      menuOverlay.onclick = closeMenu;

      // =========================
      // Parameter Explanations
      // =========================
      const PARAMS = [
        {
          key: "maxSequenceLength",
          label: "maxSequenceLength",
          type: "int",
          min: 1,
          max: 512,
          step: 1,
          hint: "Temporal context + max prediction horizon.",
          details:
            "Controls the size of the internal history buffer (ring buffer). Larger values allow longer temporal patterns, but cost more memory/compute. If your patterns are short and noisy (high-frequency data), keep it smaller (32â€“64). For longer dependencies, increase (64â€“256).",
        },
        {
          key: "reservoirSize",
          label: "reservoirSize",
          type: "int",
          min: 16,
          max: 2048,
          step: 1,
          hint: "Reservoir neuron count (capacity).",
          details:
            "Main capacity knob. Small (32â€“128) = fast & stable, good for simpler dynamics. Medium (128â€“512) = balanced. Large (512â€“1024+) = more expressive but can overfit and may be slower. If predictions are too smooth/underfit: increase. If unstable/overfit: decrease.",
        },
        {
          key: "spectralRadius",
          label: "spectralRadius",
          type: "float",
          min: 0.1,
          max: 0.999,
          step: 0.001,
          hint: "Memory depth (echo state property).",
          details:
            "Lower values (0.5â€“0.8) forget quickly â†’ responsive to rapid changes. Higher (0.9â€“0.99) retain longer memory â†’ better for long dependencies, but risk instability near 1.0. If model is â€˜stuckâ€™ on old patterns, reduce this slightly.",
        },
        {
          key: "leakRate",
          label: "leakRate",
          type: "float",
          min: 0.01,
          max: 1.0,
          step: 0.01,
          hint: "Temporal smoothing vs reactivity.",
          details:
            "Higher leak (0.6â€“1.0) updates reservoir state quickly (reactive). Lower (0.1â€“0.4) smooths changes (good for noisy signals). If you want faster response to recent changes, increase leakRate.",
        },
        {
          key: "inputScale",
          label: "inputScale",
          type: "float",
          min: 0.01,
          max: 5.0,
          step: 0.01,
          hint: "Scales inputs into reservoir.",
          details:
            "If inputs are large-magnitude, reduce inputScale to prevent saturation/instability. If signals are tiny, increase inputScale to excite the reservoir. If using normalization (default), 1.0 is usually fine.",
        },
        {
          key: "biasScale",
          label: "biasScale",
          type: "float",
          min: 0.0,
          max: 1.0,
          step: 0.01,
          hint: "Random bias magnitude.",
          details:
            "Adds a baseline drive that can break symmetry, especially in sparse reservoirs. Too high can shift dynamics; too low may reduce diversity. Typical: 0.02â€“0.2.",
        },
        {
          key: "reservoirSparsity",
          label: "reservoirSparsity",
          type: "float",
          min: 0.0,
          max: 0.999,
          step: 0.001,
          hint: "Fraction of zero reservoir connections.",
          details:
            "Higher sparsity (0.85â€“0.98) speeds compute and reduces overfitting; too high can reduce capacity. Dense reservoirs can be powerful but slower and may overfit. Most cases: 0.85â€“0.95.",
        },
        {
          key: "inputSparsity",
          label: "inputSparsity",
          type: "float",
          min: 0.0,
          max: 0.99,
          step: 0.01,
          hint: "Sparse input-to-reservoir connections.",
          details:
            "Acts like feature selection. For very high-dimensional inputs, moderate sparsity (0.3â€“0.7) can help generalization. For low-dimensional inputs, keep near 0.",
        },
        {
          key: "activation",
          label: "activation",
          type: "enum",
          options: ["tanh", "relu"],
          hint: "Reservoir non-linearity.",
          details:
            "tanh is bounded and stable for most data. relu can work well for strictly positive signals but is unbounded; it may require lower spectralRadius/inputScale to stay stable.",
        },
        {
          key: "useInputInReadout",
          label: "useInputInReadout",
          type: "bool",
          hint: "Skip connection: include x(t) in readout.",
          details:
            "Usually keep true. Helps direct influence of inputs on outputs. Turn off if you want a â€˜pure temporalâ€™ reservoir-only readout.",
        },
        {
          key: "useBiasInReadout",
          label: "useBiasInReadout",
          type: "bool",
          hint: "Include constant bias term in readout.",
          details:
            "Usually keep true. Helps handle offsets and baseline levels.",
        },
        {
          key: "readoutTraining",
          label: "readoutTraining",
          type: "enum",
          options: ["rls"],
          hint: "Readout training algorithm.",
          details:
            "This library focuses on RLS for online learning. RLS is fast and adaptive; tune rlsLambda and rlsDelta to control responsiveness and startup behavior.",
        },
        {
          key: "rlsLambda",
          label: "rlsLambda",
          type: "float",
          min: 0.90,
          max: 0.999999,
          step: 0.0001,
          hint: "Forgetting factor (adaptivity).",
          details:
            "Lower â†’ more responsive to new data (handles drift) but noisier. Higher â†’ more stable but slower to adapt. Drift-heavy streams: 0.95â€“0.99. Stable signals: 0.995â€“0.9999.",
        },
        {
          key: "rlsDelta",
          label: "rlsDelta",
          type: "float",
          min: 0.001,
          max: 100.0,
          step: 0.001,
          hint: "Initial inverse-covariance scale.",
          details:
            "Controls how fast learning starts. Higher means faster initial adaptation (but can overshoot). Typical: 0.1â€“10. If first predictions are wild, reduce it.",
        },
        {
          key: "epsilon",
          label: "epsilon",
          type: "float",
          min: 1e-12,
          max: 1e-3,
          step: 1e-8,
          hint: "Numerical stability epsilon.",
          details:
            "Small constant to avoid division by zero and stabilize calculations. Usually keep at default.",
        },
        {
          key: "l2Lambda",
          label: "l2Lambda",
          type: "float",
          min: 0.0,
          max: 0.1,
          step: 0.0001,
          hint: "Readout L2 regularization.",
          details:
            "Primary overfitting control. Small data or noisy targets: increase (0.001â€“0.01). Large clean data: keep smaller (1e-5â€“1e-4). If outputs swing wildly, increase a bit.",
        },
        {
          key: "gradientClipNorm",
          label: "gradientClipNorm",
          type: "float",
          min: 0.0,
          max: 10.0,
          step: 0.01,
          hint: "Clips update magnitude.",
          details:
            "Prevents rare large updates from destabilizing the readout. If you see occasional extreme predictions, lower this (0.3â€“1.0). 0 disables clipping (not recommended).",
        },
        {
          key: "normalizationEpsilon",
          label: "normalizationEpsilon",
          type: "float",
          min: 1e-12,
          max: 1e-3,
          step: 1e-8,
          hint: "Normalizer epsilon.",
          details:
            "Stabilizes variance computations during online normalization. Typically keep default.",
        },
        {
          key: "normalizationWarmup",
          label: "normalizationWarmup",
          type: "int",
          min: 0,
          max: 2000,
          step: 1,
          hint: "Samples before normalization activates.",
          details:
            "During warmup, stats accumulate but normalization is not applied. For streams, 10â€“50 is common. If early predictions are off due to uncalibrated stats, increase slightly.",
        },
        {
          key: "outlierThreshold",
          label: "outlierThreshold",
          type: "float",
          min: 1.5,
          max: 8.0,
          step: 0.1,
          hint: "Residual z-score for outliers.",
          details:
            "Lower threshold downweights more points (robust) but may ignore legitimate moves. Noisy data: 2.0â€“2.8. Standard: 3.0. Only extreme filtering: 4.0+.",
        },
        {
          key: "outlierMinWeight",
          label: "outlierMinWeight",
          type: "float",
          min: 0.0,
          max: 1.0,
          step: 0.01,
          hint: "Minimum weight for outliers.",
          details:
            "Outliers are downweighted but not necessarily ignored. If you want stronger robustness, reduce this (0â€“0.1).",
        },
        {
          key: "residualWindowSize",
          label: "residualWindowSize",
          type: "int",
          min: 10,
          max: 5000,
          step: 1,
          hint: "Window for uncertainty estimation.",
          details:
            "Larger windows make confidence intervals smoother but slower to react. For rapidly changing error, reduce (50â€“200). For stability, increase (200â€“1000).",
        },
        {
          key: "uncertaintyMultiplier",
          label: "uncertaintyMultiplier",
          type: "float",
          min: 0.5,
          max: 5.0,
          step: 0.01,
          hint: "CI width (e.g., 1.96 â‰ˆ 95%).",
          details:
            "Higher multiplier produces wider bounds (more conservative). Common: 1.64 (90%), 1.96 (95%), 2.58 (99%).",
        },
        {
          key: "weightInitScale",
          label: "weightInitScale",
          type: "float",
          min: 0.001,
          max: 1.0,
          step: 0.001,
          hint: "Initial random weight scale.",
          details:
            "If reservoir dynamics are too weak, increase slightly; if saturating/unstable, reduce. Typical: 0.03â€“0.15.",
        },
        {
          key: "seed",
          label: "seed",
          type: "int",
          min: 0,
          max: 1000000000,
          step: 1,
          hint: "Deterministic initialization seed.",
          details:
            "Same seed â†’ same reservoir. Change seeds to try different random reservoirs; small changes can matter.",
        },
        {
          key: "verbose",
          label: "verbose",
          type: "bool",
          hint: "Extra logs (if supported).",
          details:
            "Enable if you want more internal logging; can slow things down.",
        },
        {
          key: "rollforwardMode",
          label: "rollforwardMode",
          type: "enum",
          options: ["holdLastX", "autoregressive"],
          hint: "How multi-step rollforward works.",
          details:
            "holdLastX keeps features fixed while predicting multiple steps (safe, avoids error compounding). autoregressive feeds predictions back as inputs; requires nFeatures == nTargets and careful stability tuning.",
        },
      ];

      const DEFAULT_CONFIG = {
        maxSequenceLength: 64,
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        residualWindowSize: 100,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
        rollforwardMode: "holdLastX",
      };

      // =========================
      // Modal Builders
      // =========================
      function buildConfigModal(currentCfg) {
        const cfg = { ...DEFAULT_CONFIG, ...(currentCfg || {}) };

        const rows = PARAMS.map((p) => {
          const v = cfg[p.key];
          const id = "cfg_" + p.key;

          let inputHtml = "";
          if (p.type === "bool") {
            inputHtml = `
              <label class="flex items-center justify-between gap-3 rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                <span class="text-sm text-slate-200">${p.label}</span>
                <input id="${id}" type="checkbox" class="h-5 w-5 accent-sky-400" ${
              v ? "checked" : ""
            } />
              </label>
            `;
          } else if (p.type === "enum") {
            const opts = (p.options || []).map((o) =>
              `<option value="${escapeHtml(o)}" ${
                String(v) === o ? "selected" : ""
              }>${escapeHtml(o)}</option>`
            ).join("");
            const disabled = p.key === "readoutTraining"
              ? "disabled"
              : "";
            inputHtml = `
              <label class="flex flex-col gap-2 rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-200">${p.label}</span>
                  <span class="text-[11px] text-slate-400">${
              escapeHtml(p.hint || "")
            }</span>
                </div>
                <select id="${id}" class="rounded-lg bg-black/20 px-2 py-2 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" ${disabled}>
                  ${opts}
                </select>
              </label>
            `;
          } else {
            const isInt = p.type === "int";
            const min = p.min ?? "";
            const max = p.max ?? "";
            const step = p.step ?? (isInt ? 1 : 0.001);

            inputHtml = `
              <div class="rounded-xl bg-white/5 px-3 py-3 ring-1 ring-white/10">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <div class="min-w-[160px]">
                    <div class="text-sm font-medium text-slate-200">${p.label}</div>
                    <div class="mt-0.5 text-[11px] text-slate-400">${
              escapeHtml(p.hint || "")
            }</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <input
                      id="${id}"
                      type="number"
                      ${min !== "" ? `min="${min}"` : ""}
                      ${max !== "" ? `max="${max}"` : ""}
                      step="${step}"
                      value="${Number.isFinite(v) ? v : escapeHtml(v)}"
                      class="w-32 rounded-xl bg-black/20 px-3 py-2 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60"
                    />
                  </div>
                </div>
                <div class="mt-3">
                  <input
                    id="${id}_range"
                    type="range"
                    ${min !== "" ? `min="${min}"` : ""}
                    ${max !== "" ? `max="${max}"` : ""}
                    step="${step}"
                    value="${Number.isFinite(v) ? v : 0}"
                    class="w-full accent-sky-400"
                  />
                </div>

                <details class="group mt-3 rounded-xl bg-black/20 px-3 py-2 ring-1 ring-white/10">
                  <summary class="cursor-pointer list-none text-xs font-semibold text-white">
                    <div class="flex items-center justify-between">
                      <span>Optimization guide</span>
                      <span class="text-slate-400 group-open:rotate-180 transition-transform">â–¾</span>
                    </div>
                  </summary>
                  <div class="mt-2 text-xs leading-relaxed text-slate-300">
                    ${escapeHtml(p.details || "")}
                  </div>
                </details>
              </div>
            `;
          }

          return `<div class="space-y-2">${inputHtml}</div>`;
        }).join("");

        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <div class="text-sm font-semibold text-white">Instantiate ESNRegression (in Worker)</div>
                  <div class="mt-1 text-xs text-slate-300">
                    This will create a <span class="font-semibold text-white">new</span> model instance in the worker with the config below.
                    Data & predictions stay in-memory unless you Save JSON.
                  </div>
                </div>
                <button
                  id="btnCfgResetDefaults"
                  class="rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
                >
                  Reset defaults
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 gap-3 lg:grid-cols-2">
              ${rows}
            </div>

            <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
              <button
                id="btnCfgCancel"
                class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10"
              >
                Cancel
              </button>
              <button
                id="btnCfgInit"
                class="rounded-xl bg-sky-500/15 px-4 py-2 text-sm font-semibold text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20"
              >
                Instantiate in Worker
              </button>
            </div>

            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <details class="group">
                <summary class="cursor-pointer list-none text-sm font-semibold text-white">
                  <div class="flex items-center justify-between">
                    <span>Fast presets</span>
                    <span class="text-slate-400 group-open:rotate-180 transition-transform">â–¾</span>
                  </div>
                </summary>
                <div class="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
                  <button data-preset="fast" class="presetBtn rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    <div class="font-semibold text-white">ðŸš€ Fast & Simple</div>
                    <div class="text-xs text-slate-400">Small reservoir, snappy, safe.</div>
                  </button>
                  <button data-preset="balanced" class="presetBtn rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    <div class="font-semibold text-white">âš–ï¸ Balanced</div>
                    <div class="text-xs text-slate-400">Good default-like behavior.</div>
                  </button>
                  <button data-preset="adaptive" class="presetBtn rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    <div class="font-semibold text-white">ðŸ”„ Adaptive</div>
                    <div class="text-xs text-slate-400">More responsive to drift.</div>
                  </button>
                  <button data-preset="robust" class="presetBtn rounded-xl bg-white/5 px-3 py-2 text-left text-sm text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    <div class="font-semibold text-white">ðŸ›¡ï¸ Robust</div>
                    <div class="text-xs text-slate-400">Noisy data / outlier heavy.</div>
                  </button>
                </div>
              </details>
            </div>
          </div>
        `;
      }

      function attachConfigModalHandlers(initialCfg) {
        let cfg = { ...DEFAULT_CONFIG, ...(initialCfg || {}) };

        function readConfigFromUI() {
          const out = { ...cfg };
          for (const p of PARAMS) {
            const id = "cfg_" + p.key;
            const el = document.getElementById(id);
            if (!el) continue;

            if (p.type === "bool") {
              out[p.key] = !!el.checked;
            } else if (p.type === "enum") {
              out[p.key] = el.value;
            } else if (p.type === "int") {
              const v = Number(el.value);
              out[p.key] = Number.isFinite(v)
                ? Math.trunc(v)
                : cfg[p.key];
            } else {
              const v = Number(el.value);
              out[p.key] = Number.isFinite(v) ? v : cfg[p.key];
            }
          }
          // keep readoutTraining forced to "rls"
          out.readoutTraining = "rls";
          return out;
        }

        function syncRanges() {
          for (const p of PARAMS) {
            if (p.type !== "int" && p.type !== "float") continue;
            const num = document.getElementById("cfg_" + p.key);
            const rng = document.getElementById(
              "cfg_" + p.key + "_range",
            );
            if (!num || !rng) continue;
            // number -> range
            num.addEventListener("input", () => {
              rng.value = num.value;
            });
            // range -> number
            rng.addEventListener("input", () => {
              num.value = rng.value;
            });
          }
        }

        // presets
        document.querySelectorAll(".presetBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const kind = btn.getAttribute("data-preset");
            let patch = {};
            if (kind === "fast") {
              patch = {
                reservoirSize: 64,
                maxSequenceLength: 32,
                spectralRadius: 0.8,
                leakRate: 0.5,
                reservoirSparsity: 0.9,
                rlsLambda: 0.995,
                l2Lambda: 0.001,
                gradientClipNorm: 0.8,
              };
            } else if (kind === "balanced") {
              patch = {
                reservoirSize: 256,
                maxSequenceLength: 64,
                spectralRadius: 0.9,
                leakRate: 0.3,
                reservoirSparsity: 0.9,
                rlsLambda: 0.999,
                l2Lambda: 0.0001,
                gradientClipNorm: 1.0,
              };
            } else if (kind === "adaptive") {
              patch = {
                reservoirSize: 256,
                maxSequenceLength: 64,
                spectralRadius: 0.85,
                leakRate: 0.6,
                reservoirSparsity: 0.92,
                rlsLambda: 0.97,
                outlierThreshold: 2.5,
                l2Lambda: 0.001,
                gradientClipNorm: 0.6,
              };
            } else if (kind === "robust") {
              patch = {
                reservoirSize: 256,
                maxSequenceLength: 64,
                spectralRadius: 0.9,
                leakRate: 0.2,
                outlierThreshold: 2.2,
                outlierMinWeight: 0.05,
                l2Lambda: 0.01,
                gradientClipNorm: 0.5,
                residualWindowSize: 200,
              };
            }
            cfg = { ...cfg, ...patch };
            // re-render modal to reflect patch
            openConfigModal(cfg);
            toast("ok", "Preset applied", kind);
          });
        });

        $("btnCfgResetDefaults").onclick = () => {
          cfg = { ...DEFAULT_CONFIG };
          openConfigModal(cfg);
          toast(
            "ok",
            "Defaults restored",
            "Config reset to library-friendly defaults.",
          );
        };

        $("btnCfgCancel").onclick = closeModal;

        $("btnCfgInit").onclick = async () => {
          const newCfg = readConfigFromUI();
          try {
            await callWorker(
              "init",
              { config: newCfg },
              "Instantiating modelâ€¦",
            );
            const summary = await callWorker(
              "summary",
              null,
              "Fetching summaryâ€¦",
            );
            updateSummaryUI(summary);
            toast(
              "ok",
              "Model instantiated",
              "Worker is ready. Add training data next.",
            );
            closeModal();
          } catch (e) {
            toast("err", "Init failed", e.message || String(e));
          }
        };

        syncRanges();
      }

      function openConfigModal(cfg) {
        closeMenu();
        openModal(
          "Configure & Instantiate",
          "Detailed parameter explanations + optimization tips (expand each guide).",
          buildConfigModal(cfg),
        );
        attachConfigModalHandlers(cfg);
      }

      function buildFormatModal() {
        const exampleBulk = {
          xCoordinates: [
            [1.0, 2.0, 3.0],
            [1.1, 2.1, 3.1],
            [1.2, 2.2, 3.2],
          ],
          yCoordinates: [
            [4.0, 5.0],
            [4.1, 5.1],
            [4.2, 5.2],
          ],
        };
        const exampleManualSample = {
          x: [0.12, 0.34, 0.56],
          y: [0.9, 1.1],
        };
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Bulk Upload (Training)</div>
              <div class="mt-1 text-xs leading-relaxed text-slate-300">
                Upload a JSON file shaped as:
                <div class="mt-2 rounded-xl bg-white/5 p-3 font-mono text-[11px] ring-1 ring-white/10 overflow-auto">
                  <pre>${
          escapeHtml(JSON.stringify(exampleBulk, null, 2))
        }</pre>
                </div>
                Rules:
                <ul class="mt-2 list-disc pl-5 text-xs text-slate-300 space-y-1">
                  <li><span class="font-semibold text-white">xCoordinates</span> is an array of samples; each sample is a numeric array (nFeatures).</li>
                  <li><span class="font-semibold text-white">yCoordinates</span> matches length of xCoordinates; each sample is numeric array (nTargets).</li>
                  <li>All values must be numbers (no strings). Keep it JSON only.</li>
                  <li>For large datasets, the UI will stream chunks to the worker with progress.</li>
                </ul>
              </div>
            </div>

            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Manual Insert (Single sample or Batch)</div>
              <div class="mt-1 text-xs leading-relaxed text-slate-300">
                You can paste JSON as either:
                <div class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2">
                  <div class="rounded-xl bg-white/5 p-3 ring-1 ring-white/10">
                    <div class="text-xs font-semibold text-white">Single sample</div>
                    <pre class="mt-2 font-mono text-[11px] overflow-auto">${
          escapeHtml(JSON.stringify(exampleManualSample, null, 2))
        }</pre>
                  </div>
                  <div class="rounded-xl bg-white/5 p-3 ring-1 ring-white/10">
                    <div class="text-xs font-semibold text-white">Batch</div>
                    <pre class="mt-2 font-mono text-[11px] overflow-auto">${
          escapeHtml(JSON.stringify(exampleBulk, null, 2))
        }</pre>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button id="btnFormatClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">Close</button>
            </div>
          </div>
        `;
      }

      function openFormatModal() {
        closeMenu();
        openModal(
          "JSON Upload Format",
          "Clear rules + copyable examples.",
          buildFormatModal(),
        );
        $("btnFormatClose").onclick = closeModal;
      }

      function buildDataModal() {
        const placeholder = `{
  "xCoordinates": [[1,2,3],[1.1,2.1,3.1]],
  "yCoordinates": [[4,5],[4.1,5.1]]
}`;
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <div class="text-sm font-semibold text-white">Bulk Upload & Train</div>
                  <div class="mt-1 text-xs text-slate-300">
                    Upload a JSON file with <span class="font-semibold text-white">xCoordinates</span> and <span class="font-semibold text-white">yCoordinates</span>.
                    Training will be streamed to the worker in chunks with a progress bar.
                  </div>
                </div>
                <button id="btnDataFormat" class="rounded-xl bg-white/5 px-3 py-2 text-xs font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">Format help</button>
              </div>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <input id="fileBulk" type="file" accept="application/json,.json" class="block w-full text-sm text-slate-300 file:mr-3 file:rounded-xl file:border-0 file:bg-white/10 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-white/15" />
                <button id="btnTrainFile" class="rounded-xl bg-emerald-500/10 px-4 py-2 text-sm font-semibold text-emerald-200 ring-1 ring-emerald-400/20 hover:bg-emerald-500/15">
                  Train from file
                </button>
              </div>

              <div class="mt-3 rounded-xl bg-white/5 p-3 ring-1 ring-white/10">
                <div class="text-xs text-slate-300">
                  Chunk size:
                  <select id="chunkSize" class="ml-2 rounded-lg bg-black/20 px-2 py-1 text-xs text-white ring-1 ring-white/10">
                    <option value="64">64</option>
                    <option value="128" selected>128</option>
                    <option value="256">256</option>
                    <option value="512">512</option>
                    <option value="1024">1024</option>
                  </select>
                  <span class="ml-2 text-[11px] text-slate-400">Use smaller chunks for smoother UI updates.</span>
                </div>
              </div>
            </div>

            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Manual Insert (JSON)</div>
              <div class="mt-1 text-xs text-slate-300">
                Paste either a single sample <code class="rounded bg-white/5 px-1 py-0.5">{"x":[...],"y":[...]}</code>
                or a batch <code class="rounded bg-white/5 px-1 py-0.5">{"xCoordinates":[...],"yCoordinates":[...]}</code>.
              </div>
              <textarea id="manualJson" class="mt-3 h-44 w-full rounded-2xl bg-black/30 p-3 font-mono text-[11px] text-slate-200 ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" spellcheck="false">${
          escapeHtml(placeholder)
        }</textarea>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:justify-end">
                <button id="btnManualTrain" class="rounded-xl bg-sky-500/15 px-4 py-2 text-sm font-semibold text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20">
                  Train from pasted JSON
                </button>
              </div>
            </div>

            <div class="flex justify-end">
              <button id="btnDataClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">Close</button>
            </div>
          </div>
        `;
      }

      function openDataModal() {
        closeMenu();
        openModal(
          "Add Training Data",
          "Bulk upload or manual insert (JSON only).",
          buildDataModal(),
        );

        $("btnDataClose").onclick = closeModal;
        $("btnDataFormat").onclick = openFormatModal;

        $("btnTrainFile").onclick = async () => {
          if (!modelInitialized) {
            toast(
              "warn",
              "Not initialized",
              "Configure & instantiate the model first.",
            );
            return;
          }
          const file = $("fileBulk").files?.[0];
          if (!file) {
            toast(
              "warn",
              "No file selected",
              "Choose a .json file first.",
            );
            return;
          }

          let obj;
          try {
            setBusy(true, "Reading fileâ€¦", "Parsing JSON.");
            const txt = await file.text();
            obj = JSON.parse(txt);
          } catch (e) {
            setBusy(false);
            toast("err", "Invalid JSON", e.message || String(e));
            return;
          } finally {
            setBusy(false);
          }

          const { xCoordinates, yCoordinates } =
            normalizeTrainingPayload(obj);
          if (!xCoordinates || !yCoordinates) return;

          const chunk = Math.max(
            1,
            Number($("chunkSize").value || 128),
          );
          await streamFit({ xCoordinates, yCoordinates }, chunk);
        };

        $("btnManualTrain").onclick = async () => {
          if (!modelInitialized) {
            toast(
              "warn",
              "Not initialized",
              "Configure & instantiate the model first.",
            );
            return;
          }
          const txt = $("manualJson").value || "";
          let obj;
          try {
            obj = JSON.parse(txt);
          } catch (e) {
            toast("err", "Invalid JSON", e.message || String(e));
            return;
          }
          const payload = normalizeTrainingPayload(obj);
          if (!payload) return;

          await streamFit(payload, payload.xCoordinates.length);
        };
      }

      function normalizeTrainingPayload(obj) {
        if (!obj || typeof obj !== "object") {
          toast("err", "Bad payload", "Expected JSON object.");
          return null;
        }

        // single sample: {x:[...], y:[...]}
        if (Array.isArray(obj.x) && Array.isArray(obj.y)) {
          const x = obj.x;
          const y = obj.y;
          if (!x.every(Number.isFinite) || !y.every(Number.isFinite)) {
            toast(
              "err",
              "Bad sample",
              "x and y must be numeric arrays.",
            );
            return null;
          }
          return { xCoordinates: [x], yCoordinates: [y] };
        }

        // batch: {xCoordinates:[[...]], yCoordinates:[[...]]}
        const xCoordinates = obj.xCoordinates;
        const yCoordinates = obj.yCoordinates;

        if (
          !Array.isArray(xCoordinates) || !Array.isArray(yCoordinates)
        ) {
          toast(
            "err",
            "Bad payload",
            'Need "xCoordinates" and "yCoordinates" arrays (or single {x,y}).',
          );
          return null;
        }
        if (xCoordinates.length !== yCoordinates.length) {
          toast(
            "err",
            "Shape mismatch",
            "xCoordinates.length must equal yCoordinates.length.",
          );
          return null;
        }
        if (xCoordinates.length === 0) {
          toast("err", "Empty dataset", "Provide at least 1 sample.");
          return null;
        }

        const nf = Array.isArray(xCoordinates[0])
          ? xCoordinates[0].length
          : 0;
        const nt = Array.isArray(yCoordinates[0])
          ? yCoordinates[0].length
          : 0;

        for (let i = 0; i < xCoordinates.length; i++) {
          const x = xCoordinates[i];
          const y = yCoordinates[i];
          if (!Array.isArray(x) || !Array.isArray(y)) {
            toast(
              "err",
              "Bad dataset",
              "Each sample must be an array.",
            );
            return null;
          }
          if (x.length !== nf || y.length !== nt) {
            toast(
              "err",
              "Inconsistent dimensions",
              "All samples must have consistent feature/target sizes.",
            );
            return null;
          }
          for (let j = 0; j < x.length; j++) {
            if (!Number.isFinite(x[j])) {
              toast(
                "err",
                "Non-numeric x",
                `Found non-number at x[${i}][${j}]`,
              );
              return null;
            }
          }
          for (let j = 0; j < y.length; j++) {
            if (!Number.isFinite(y[j])) {
              toast(
                "err",
                "Non-numeric y",
                `Found non-number at y[${i}][${j}]`,
              );
              return null;
            }
          }
        }

        return { xCoordinates, yCoordinates };
      }

      async function streamFit(payload, chunkSize) {
        const X = payload.xCoordinates;
        const Y = payload.yCoordinates;
        const total = X.length;

        try {
          setBusy(
            true,
            "Trainingâ€¦",
            "Streaming batches to the worker.",
          );
          setBusyProgress(0, "0%", `${total} samples`);

          let lastRes = null;

          for (let i = 0; i < total; i += chunkSize) {
            const end = Math.min(total, i + chunkSize);
            const xChunk = X.slice(i, end);
            const yChunk = Y.slice(i, end);

            const pct = (end / total) * 100;
            setBusyProgress(
              pct,
              `${pct.toFixed(1)}%`,
              `${end}/${total}`,
            );

            lastRes = await callWorker("fit", {
              xCoordinates: xChunk,
              yCoordinates: yChunk,
            }, "Training chunkâ€¦");
            // keep UI responsive, yield to event loop
            await new Promise((r) => setTimeout(r, 0));
          }

          const summary = await callWorker(
            "summary",
            null,
            "Fetching summaryâ€¦",
          );
          updateSummaryUI(summary);

          if (lastRes) {
            fitLine.textContent =
              `Processed ${lastRes.samplesProcessed} â€¢ avgLoss ${
                fmt(lastRes.averageLoss)
              } â€¢ grad ${fmt(lastRes.gradientNorm)}`;
            fitLoss.textContent = fmt(lastRes.averageLoss);
            fitGrad.textContent = fmt(lastRes.gradientNorm);
            fitWeight.textContent = fmt(lastRes.sampleWeight);
            fitDrift.textContent = String(!!lastRes.driftDetected);
          }

          toast(
            "ok",
            "Training complete",
            `${total} samples streamed to worker.`,
          );
          closeModal();
        } catch (e) {
          toast("err", "Training failed", e.message || String(e));
        } finally {
          setBusy(false);
          setBusyProgress(null);
        }
      }

      function buildPredictModal() {
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Predict (multi-horizon)</div>
              <div class="mt-1 text-xs text-slate-300">
                The worker will run <code class="rounded bg-white/5 px-1 py-0.5">predict(futureSteps)</code> and return:
                <code class="rounded bg-white/5 px-1 py-0.5">predictions</code>,
                <code class="rounded bg-white/5 px-1 py-0.5">lowerBounds</code>,
                <code class="rounded bg-white/5 px-1 py-0.5">upperBounds</code>,
                <code class="rounded bg-white/5 px-1 py-0.5">confidence</code>.
              </div>
              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <label class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                  <span class="text-xs text-slate-300">futureSteps</span>
                  <input id="modalSteps" type="number" min="1" max="512" value="${
          escapeHtml(stepsInput.value || "10")
        }" class="w-24 rounded-lg bg-black/20 px-2 py-1 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" />
                </label>
                <div class="flex gap-2">
                  <button id="btnDoPredict" class="rounded-xl bg-sky-500/15 px-4 py-2 text-sm font-semibold text-sky-200 ring-1 ring-sky-400/30 hover:bg-sky-500/20">
                    Run Predict
                  </button>
                  <button id="btnPredictClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    Close
                  </button>
                </div>
              </div>
            </div>

            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <details class="group">
                <summary class="cursor-pointer list-none text-sm font-semibold text-white">
                  <div class="flex items-center justify-between">
                    <span>Note on n-dimensional targets</span>
                    <span class="text-slate-400 group-open:rotate-180 transition-transform">â–¾</span>
                  </div>
                </summary>
                <div class="mt-2 text-xs leading-relaxed text-slate-300">
                  If you have many targets (e.g., 50â€“500), a per-target line chart becomes noisy.
                  This UI defaults to a <span class="font-semibold text-white">heatmap</span> across all targets and steps, and you can
                  inspect a <span class="font-semibold text-white">single target</span> using the selector above the chart.
                </div>
              </details>
            </div>
          </div>
        `;
      }

      function openPredictModal() {
        closeMenu();
        openModal(
          "Predict",
          "Multi-step forecasting with confidence bounds.",
          buildPredictModal(),
        );
        $("btnPredictClose").onclick = closeModal;
        $("btnDoPredict").onclick = async () => {
          const steps = Math.max(
            1,
            Math.min(512, Number($("modalSteps").value || 1)),
          );
          stepsInput.value = String(steps);
          await runPredict(steps);
          closeModal();
        };
      }

      function buildSaveModal(serialized) {
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Model State (JSON string)</div>
              <div class="mt-1 text-xs text-slate-300">
                This is the result of <code class="rounded bg-white/5 px-1 py-0.5">model.save()</code>.
                You can download it as a <span class="font-semibold text-white">.json</span> file or copy to clipboard.
              </div>
              <textarea id="saveText" class="mt-3 h-56 w-full rounded-2xl bg-black/30 p-3 font-mono text-[11px] text-slate-200 ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" spellcheck="false">${
          escapeHtml(serialized || "")
        }</textarea>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:justify-end">
                <button id="btnCopySave" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                  Copy
                </button>
                <button id="btnDownloadSave" class="rounded-xl bg-emerald-500/10 px-4 py-2 text-sm font-semibold text-emerald-200 ring-1 ring-emerald-400/20 hover:bg-emerald-500/15">
                  Download JSON
                </button>
                <button id="btnSaveClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;
      }

      function openSaveModal(serialized) {
        closeMenu();
        openModal(
          "Save Model",
          "Export full state as JSON.",
          buildSaveModal(serialized),
        );
        $("btnSaveClose").onclick = closeModal;
        $("btnCopySave").onclick = async () => {
          const t = $("saveText").value || "";
          try {
            await navigator.clipboard.writeText(t);
            toast("ok", "Copied", "Model JSON copied to clipboard.");
          } catch (e) {
            toast(
              "warn",
              "Copy blocked",
              "Your browser prevented clipboard access. You can copy manually.",
            );
          }
        };
        $("btnDownloadSave").onclick = () => {
          const t = $("saveText").value || "";
          const blob = new Blob([t], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "esn_model.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          toast("ok", "Downloaded", "Saved as esn_model.json");
        };
      }

      function buildLoadModal() {
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Load Model (JSON)</div>
              <div class="mt-1 text-xs text-slate-300">
                Load a model previously exported with Save. You can either upload the file or paste JSON directly.
              </div>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <input id="fileLoad" type="file" accept="application/json,.json" class="block w-full text-sm text-slate-300 file:mr-3 file:rounded-xl file:border-0 file:bg-white/10 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-white/15" />
                <button id="btnLoadFile" class="rounded-xl bg-violet-500/10 px-4 py-2 text-sm font-semibold text-violet-200 ring-1 ring-violet-400/20 hover:bg-violet-500/15">
                  Load file
                </button>
              </div>

              <textarea id="loadText" class="mt-3 h-56 w-full rounded-2xl bg-black/30 p-3 font-mono text-[11px] text-slate-200 ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" spellcheck="false" placeholder="Paste model JSON hereâ€¦"></textarea>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:justify-end">
                <button id="btnLoadPaste" class="rounded-xl bg-violet-500/10 px-4 py-2 text-sm font-semibold text-violet-200 ring-1 ring-violet-400/20 hover:bg-violet-500/15">
                  Load pasted JSON
                </button>
                <button id="btnLoadClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;
      }

      function openLoadModal() {
        closeMenu();
        openModal(
          "Load Model",
          "Restore a saved state into the worker.",
          buildLoadModal(),
        );
        $("btnLoadClose").onclick = closeModal;

        $("btnLoadFile").onclick = async () => {
          const file = $("fileLoad").files?.[0];
          if (!file) {
            toast(
              "warn",
              "No file selected",
              "Choose a .json file first.",
            );
            return;
          }
          try {
            setBusy(true, "Reading fileâ€¦", "Parsing JSON.");
            const txt = await file.text();
            $("loadText").value = txt;
            toast(
              "ok",
              "Loaded into editor",
              "Now click 'Load pasted JSON' to apply.",
            );
          } catch (e) {
            toast("err", "Read failed", e.message || String(e));
          } finally {
            setBusy(false);
          }
        };

        $("btnLoadPaste").onclick = async () => {
          const txt = $("loadText").value || "";
          if (!txt.trim()) {
            toast("warn", "Empty input", "Paste model JSON first.");
            return;
          }
          if (!modelInitialized) {
            // If not initialized, initialize with defaults then load
            try {
              await callWorker("init", {
                config: { ...DEFAULT_CONFIG },
              }, "Instantiating modelâ€¦");
              const summary0 = await callWorker(
                "summary",
                null,
                "Fetching summaryâ€¦",
              );
              updateSummaryUI(summary0);
            } catch (e) {
              toast("err", "Init failed", e.message || String(e));
              return;
            }
          }
          try {
            await callWorker(
              "load",
              { serialized: txt },
              "Loading modelâ€¦",
            );
            const summary = await callWorker(
              "summary",
              null,
              "Fetching summaryâ€¦",
            );
            updateSummaryUI(summary);
            toast("ok", "Model loaded", "State restored in worker.");
            closeModal();
          } catch (e) {
            toast("err", "Load failed", e.message || String(e));
          }
        };
      }

      function buildRandomModal() {
        return `
          <div class="space-y-4">
            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <div class="text-sm font-semibold text-white">Random Standard Test Generator</div>
              <div class="mt-1 text-xs text-slate-300">
                Generates a synthetic multivariate, non-linear time series with lag influence, then trains the model and runs a prediction.
                Great for quickly validating stability and UI flow.
              </div>

              <div class="mt-3 grid grid-cols-2 gap-2 sm:grid-cols-4">
                <label class="rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                  <div class="text-[11px] text-slate-400">Samples</div>
                  <input id="rndSamples" type="number" min="20" max="20000" value="600" class="mt-1 w-full rounded-lg bg-black/20 px-2 py-1 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" />
                </label>
                <label class="rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                  <div class="text-[11px] text-slate-400">Features</div>
                  <input id="rndFeatures" type="number" min="1" max="512" value="6" class="mt-1 w-full rounded-lg bg-black/20 px-2 py-1 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" />
                </label>
                <label class="rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                  <div class="text-[11px] text-slate-400">Targets</div>
                  <input id="rndTargets" type="number" min="1" max="512" value="4" class="mt-1 w-full rounded-lg bg-black/20 px-2 py-1 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" />
                </label>
                <label class="rounded-xl bg-white/5 px-3 py-2 ring-1 ring-white/10">
                  <div class="text-[11px] text-slate-400">Noise</div>
                  <input id="rndNoise" type="number" min="0" max="1" step="0.001" value="0.02" class="mt-1 w-full rounded-lg bg-black/20 px-2 py-1 text-sm text-white ring-1 ring-white/10 focus:outline-none focus:ring-2 focus:ring-sky-400/60" />
                </label>
              </div>

              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <label class="inline-flex items-center gap-2 rounded-xl bg-white/5 px-3 py-2 text-xs ring-1 ring-white/10">
                  <input id="rndAutoInit" type="checkbox" class="h-4 w-4 accent-sky-400" checked />
                  <span class="text-slate-300">Auto-initialize model (balanced preset)</span>
                </label>

                <div class="flex gap-2">
                  <button id="btnRndRun" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-semibold text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    Generate & Train
                  </button>
                  <button id="btnRndClose" class="rounded-xl bg-white/5 px-4 py-2 text-sm font-medium text-slate-200 ring-1 ring-white/10 hover:bg-white/10">
                    Close
                  </button>
                </div>
              </div>
            </div>

            <div class="rounded-2xl bg-black/20 p-4 ring-1 ring-white/10">
              <details class="group">
                <summary class="cursor-pointer list-none text-sm font-semibold text-white">
                  <div class="flex items-center justify-between">
                    <span>What this test generates</span>
                    <span class="text-slate-400 group-open:rotate-180 transition-transform">â–¾</span>
                  </div>
                </summary>
                <div class="mt-2 text-xs leading-relaxed text-slate-300">
                  Features are a mix of sine/cosine waves + cross terms + mild trends.
                  Targets are nonlinear mixtures of current and previous-step features (lag) plus Gaussian noise.
                  This ensures the ESN must use its reservoir memory to perform well.
                </div>
              </details>
            </div>
          </div>
        `;
      }

      function openRandomModal() {
        closeMenu();
        openModal(
          "Random Standard Test",
          "Generate synthetic data, train, then predict.",
          buildRandomModal(),
        );
        $("btnRndClose").onclick = closeModal;
        $("btnRndRun").onclick = async () => {
          const n = Math.max(
            20,
            Math.min(20000, Number($("rndSamples").value || 600)),
          );
          const nf = Math.max(
            1,
            Math.min(512, Number($("rndFeatures").value || 6)),
          );
          const nt = Math.max(
            1,
            Math.min(512, Number($("rndTargets").value || 4)),
          );
          const noise = Math.max(
            0,
            Math.min(1, Number($("rndNoise").value || 0.02)),
          );
          const autoInit = !!$("rndAutoInit").checked;

          try {
            setBusy(
              true,
              "Generating dataâ€¦",
              "Creating synthetic time series.",
            );
            setBusyProgress(10, "10%", "Building arrays");
            const data = genSynthetic(n, nf, nt, noise);
            setBusyProgress(30, "30%", "Data ready");

            if (autoInit) {
              const cfg = {
                ...DEFAULT_CONFIG,
                reservoirSize: Math.max(
                  64,
                  Math.min(512, 64 + Math.floor((nf + nt) * 20)),
                ),
                maxSequenceLength: Math.max(
                  32,
                  Math.min(128, Math.floor(Math.sqrt(n) * 4)),
                ),
                spectralRadius: 0.9,
                leakRate: 0.4,
                rlsLambda: 0.995,
                l2Lambda: 0.001,
                gradientClipNorm: 0.8,
                seed: 42,
              };
              setBusyProgress(40, "40%", "Instantiating model");
              await callWorker(
                "init",
                { config: cfg },
                "Instantiating modelâ€¦",
              );
              const summary0 = await callWorker(
                "summary",
                null,
                "Fetching summaryâ€¦",
              );
              updateSummaryUI(summary0);
            } else if (!modelInitialized) {
              toast(
                "warn",
                "Not initialized",
                "Enable auto-initialize, or configure the model first.",
              );
              return;
            }

            setBusyProgress(50, "50%", "Training");
            await streamFit({
              xCoordinates: data.xCoordinates,
              yCoordinates: data.yCoordinates,
            }, 256);

            // predict a few steps beyond
            const steps = Math.max(
              5,
              Math.min(50, Math.floor(Math.sqrt(n))),
            );
            stepsInput.value = String(steps);
            setBusyProgress(90, "90%", "Predicting");
            await runPredict(steps);

            toast(
              "ok",
              "Random test complete",
              `Trained on ${n} samples, predicted ${steps} steps.`,
            );
            closeModal();
          } catch (e) {
            toast("err", "Random test failed", e.message || String(e));
          } finally {
            setBusy(false);
            setBusyProgress(null);
          }
        };
      }

      function genSynthetic(n, nf, nt, noise) {
        function randn() {
          // Box-Muller
          let u = 0, v = 0;
          while (u === 0) u = Math.random();
          while (v === 0) v = Math.random();
          return Math.sqrt(-2.0 * Math.log(u)) *
            Math.cos(2.0 * Math.PI * v);
        }

        const xCoordinates = new Array(n);
        const yCoordinates = new Array(n);

        // base frequencies
        const f1 = 0.03 + Math.random() * 0.01;
        const f2 = 0.017 + Math.random() * 0.01;

        let prevX = new Array(nf).fill(0);

        for (let t = 0; t < n; t++) {
          const x = new Array(nf);
          for (let i = 0; i < nf; i++) {
            const s = Math.sin((t + i * 3) * (f1 + i * 0.0007));
            const c = Math.cos((t + i * 5) * (f2 + i * 0.0005));
            const trend = (t / n) * (i % 3 === 0 ? 0.8 : 0.2);
            const cross = i > 0
              ? 0.15 * Math.sin((t * 0.01) + prevX[i - 1])
              : 0;
            x[i] = 0.9 * s + 0.6 * c + trend + cross +
              noise * 0.25 * randn();
          }

          const y = new Array(nt);
          for (let k = 0; k < nt; k++) {
            const a = x[k % nf];
            const b = x[(k + 2) % nf];
            const c0 = prevX[(k + 1) % nf];
            const nonlin = Math.sin(a * 1.2 + 0.35 * c0) +
              0.4 * Math.tanh(b * 0.9) + 0.15 * (a * b);
            const lag = 0.25 * Math.sin(c0 + t * 0.01);
            y[k] = nonlin + lag + noise * randn();
          }

          xCoordinates[t] = x;
          yCoordinates[t] = y;
          prevX = x;
        }

        return { xCoordinates, yCoordinates };
      }

      // =========================
      // Predict Flow
      // =========================
      async function runPredict(steps) {
        if (!modelInitialized) {
          toast(
            "warn",
            "Not initialized",
            "Configure & instantiate the model first.",
          );
          return;
        }
        try {
          const s = Math.max(1, Math.min(512, Number(steps || 1)));
          const pred = await callWorker(
            "predict",
            { futureSteps: s },
            "Predictingâ€¦",
          );
          lastPrediction = pred;
          redrawAll();
          toast("ok", "Prediction ready", `${s} steps returned.`);
        } catch (e) {
          toast("err", "Predict failed", e.message || String(e));
        }
      }

      // =========================
      // Global Buttons
      // =========================
      $("btnOpenConfig").onclick = () =>
        openConfigModal(DEFAULT_CONFIG);
      $("btnOpenData").onclick = openDataModal;
      $("btnOpenPredict").onclick = openPredictModal;
      $("btnOpenRandom").onclick = openRandomModal;
      $("btnOpenFormat").onclick = openFormatModal;

      $("btnQuickPredict").onclick = () => openPredictModal();
      $("btnPredict").onclick = () =>
        runPredict(Number(stepsInput.value || 10));
      targetSelect.onchange = () => redrawAll();

      $("btnReset").onclick = async () => {
        if (!modelInitialized) {
          toast(
            "warn",
            "Nothing to reset",
            "Initialize the model first.",
          );
          return;
        }
        try {
          await callWorker("reset", null, "Resetting modelâ€¦");
          const summary = await callWorker(
            "summary",
            null,
            "Fetching summaryâ€¦",
          );
          updateSummaryUI(summary);
          lastPrediction = null;
          fitLine.textContent = "No training yet";
          fitLoss.textContent = "â€”";
          fitGrad.textContent = "â€”";
          fitWeight.textContent = "â€”";
          fitDrift.textContent = "â€”";
          previewOut.textContent = "No prediction yet.";
          confText.textContent = "â€”";
          drawHeatmap(null);
          drawLine(null, 0);
          toast(
            "ok",
            "Reset complete",
            "Model state cleared (config preserved).",
          );
        } catch (e) {
          toast("err", "Reset failed", e.message || String(e));
        }
      };

      $("btnSave").onclick = async () => {
        if (!modelInitialized) {
          toast(
            "warn",
            "Not initialized",
            "Initialize the model first.",
          );
          return;
        }
        try {
          const res = await callWorker("save", null, "Saving modelâ€¦");
          openSaveModal(res.serialized || "");
        } catch (e) {
          toast("err", "Save failed", e.message || String(e));
        }
      };

      $("btnLoad").onclick = () => openLoadModal();

      // Drawer menu bindings
      $("menuConfig").onclick = () => openConfigModal(DEFAULT_CONFIG);
      $("menuSave").onclick = () => $("btnSave").click();
      $("menuLoad").onclick = () => openLoadModal();
      $("menuReset").onclick = () => $("btnReset").click();
      $("menuBulk").onclick = openDataModal;
      $("menuManual").onclick = openDataModal;
      $("menuFormat").onclick = openFormatModal;
      $("menuPredict").onclick = openPredictModal;
      $("menuRandom").onclick = openRandomModal;

      // =========================
      // Initial UI State
      // =========================
      setStatus("idle", "Idle");
      drawHeatmap(null);
      drawLine(null, 0);

      // Helpful: auto-initialize with defaults (comment out if you prefer manual)
      (async () => {
        try {
          setStatus("busy", "Starting");
          await callWorker(
            "init",
            { config: { ...DEFAULT_CONFIG } },
            "Booting workerâ€¦",
          );
          const summary = await callWorker(
            "summary",
            null,
            "Fetching summaryâ€¦",
          );
          updateSummaryUI(summary);
          setStatus("ok", "Ready");
          toast(
            "ok",
            "Ready",
            "Default model instantiated. You can re-configure anytime.",
          );
        } catch (e) {
          setStatus("err", "Init failed");
          toast("err", "Startup failed", e.message || String(e));
        }
      })();
    </script>
  </body>
</html>
