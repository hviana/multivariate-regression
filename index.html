<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
                950: "#082f49",
              },
              surface: {
                50: "#fafafa",
                100: "#f4f4f5",
                200: "#e4e4e7",
                300: "#d4d4d8",
                700: "#3f3f46",
                800: "#27272a",
                900: "#18181b",
                950: "#09090b",
              },
            },
          },
        },
      };
    </script>
    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .animate-fade-in {
        animation: fadeIn 0.2s ease-out;
      }
      .animate-slide-in {
        animation: slideIn 0.3s ease-out;
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .glass {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #71717a;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1aa;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #52525b;
      }
      .dark ::-webkit-scrollbar-thumb:hover {
        background: #71717a;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body
    class="h-full bg-surface-100 dark:bg-surface-950 text-surface-900 dark:text-surface-100 transition-colors duration-200"
  >
    <div id="app" class="h-full flex flex-col">
      <!-- Top Bar -->
      <header
        class="flex-shrink-0 h-14 bg-white/80 dark:bg-surface-900/80 glass border-b border-surface-200 dark:border-surface-800 flex items-center px-4 gap-3 z-40"
      >
        <button
          id="menuBtn"
          class="lg:hidden p-2 -ml-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 focus:outline-none focus:ring-2 focus:ring-primary-500"
          aria-label="Open menu"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
        <div class="flex items-center gap-2">
          <div
            class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center"
          >
            <svg
              class="w-5 h-5 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h1 class="font-semibold text-lg hidden sm:block">
            ESN Regression Studio
          </h1>
        </div>
        <div class="flex-1"></div>
        <div
          id="statusBadge"
          class="px-3 py-1 rounded-full text-xs font-medium bg-surface-200 dark:bg-surface-700 text-surface-600 dark:text-surface-300"
        >
          Not initialized
        </div>
        <button
          id="themeBtn"
          class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 focus:outline-none focus:ring-2 focus:ring-primary-500"
          aria-label="Toggle theme"
        >
          <svg
            class="w-5 h-5 dark:hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
          </svg>
          <svg
            class="w-5 h-5 hidden dark:block"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
        </button>
        <button
          id="helpBtn"
          class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 focus:outline-none focus:ring-2 focus:ring-primary-500"
          aria-label="Help"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        </button>
        <button
          id="consoleBtn"
          class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 focus:outline-none focus:ring-2 focus:ring-primary-500 relative"
          aria-label="Console"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
          <span
            id="consoleBadge"
            class="absolute -top-1 -right-1 w-4 h-4 bg-primary-500 text-white text-[10px] rounded-full hidden items-center justify-center"
          >0</span>
        </button>
      </header>

      <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar Overlay -->
        <div
          id="menuOverlay"
          class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
          aria-hidden="true"
        >
        </div>

        <!-- Sidebar -->
        <aside
          id="sidebar"
          class="fixed lg:static inset-y-0 left-0 w-72 bg-white dark:bg-surface-900 border-r border-surface-200 dark:border-surface-800 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col overflow-hidden"
        >
          <div
            class="p-4 border-b border-surface-200 dark:border-surface-800 flex items-center justify-between lg:hidden"
          >
            <span class="font-semibold">Menu</span>
            <button
              id="closeSidebar"
              class="p-2 -mr-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto p-3 space-y-1">
            <div class="accordion">
              <button
                class="accordion-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                data-section="model"
              >
                <svg
                  class="w-5 h-5 text-primary-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                  />
                </svg>
                <span class="flex-1 font-medium">Model</span>
                <svg
                  class="w-4 h-4 transform transition-transform accordion-icon"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div class="accordion-content hidden pl-8 pr-3 pb-2 space-y-1">
                <button
                  data-action="instantiate"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    />
                  </svg>
                  Instantiate
                </button>
                <button
                  data-action="reset"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2 text-red-600 dark:text-red-400"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                  Reset
                </button>
              </div>
            </div>
            <div class="accordion">
              <button
                class="accordion-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                data-section="data"
              >
                <svg
                  class="w-5 h-5 text-green-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                  />
                </svg>
                <span class="flex-1 font-medium">Data</span>
                <svg
                  class="w-4 h-4 transform transition-transform accordion-icon"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div class="accordion-content hidden pl-8 pr-3 pb-2 space-y-1">
                <button
                  data-action="addManual"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                    />
                  </svg>
                  Add Manual
                </button>
                <button
                  data-action="uploadBulk"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                    />
                  </svg>
                  Upload Bulk
                </button>
                <button
                  data-action="randomTest"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  Random Test
                </button>
              </div>
            </div>
            <div class="accordion">
              <button
                class="accordion-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                data-section="predict"
              >
                <svg
                  class="w-5 h-5 text-purple-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                  />
                </svg>
                <span class="flex-1 font-medium">Predict</span>
                <svg
                  class="w-4 h-4 transform transition-transform accordion-icon"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div class="accordion-content hidden pl-8 pr-3 pb-2 space-y-1">
                <button
                  data-action="predict"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                  </svg>
                  Run Prediction
                </button>
              </div>
            </div>
            <div class="accordion">
              <button
                class="accordion-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                data-section="session"
              >
                <svg
                  class="w-5 h-5 text-amber-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                <span class="flex-1 font-medium">Session</span>
                <svg
                  class="w-4 h-4 transform transition-transform accordion-icon"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div class="accordion-content hidden pl-8 pr-3 pb-2 space-y-1">
                <button
                  data-action="saveState"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                    />
                  </svg>
                  Save State
                </button>
                <button
                  data-action="loadState"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                  Load State
                </button>
                <button
                  data-action="exportSession"
                  class="menu-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors flex items-center gap-2"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  Export Session
                </button>
              </div>
            </div>
          </nav>
          <div class="p-3 border-t border-surface-200 dark:border-surface-800">
            <div class="text-xs text-surface-500 text-center">
              ESN Regression v1.0
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 lg:p-6">
          <div class="max-w-7xl mx-auto space-y-6">
            <!-- Session Overview -->
            <section>
              <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg
                  class="w-5 h-5 text-primary-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Session Overview
              </h2>
              <div class="grid grid-cols-2 lg:grid-cols-6 gap-4">
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Samples
                  </div>
                  <div
                    id="statSamples"
                    class="text-2xl font-bold text-primary-600 dark:text-primary-400"
                  >
                    0
                  </div>
                </div>
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Features
                  </div>
                  <div id="statFeatures" class="text-2xl font-bold">—</div>
                </div>
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Targets
                  </div>
                  <div id="statTargets" class="text-2xl font-bold">—</div>
                </div>
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Avg Loss
                  </div>
                  <div id="statLoss" class="text-2xl font-bold">—</div>
                </div>
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Confidence
                  </div>
                  <div id="statConfidence" class="text-2xl font-bold">—</div>
                </div>
                <div class="card p-4">
                  <div
                    class="text-xs text-surface-500 dark:text-surface-400 mb-1"
                  >
                    Updated
                  </div>
                  <div id="statUpdated" class="text-lg font-semibold truncate">
                    —
                  </div>
                </div>
              </div>
            </section>

            <!-- Predictions Panel -->
            <section class="card overflow-hidden">
              <div
                class="p-4 border-b border-surface-200 dark:border-surface-700 flex flex-wrap items-center gap-4"
              >
                <h2 class="text-lg font-semibold flex items-center gap-2">
                  <svg
                    class="w-5 h-5 text-purple-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                    />
                  </svg>
                  Predictions
                </h2>
                <div class="flex-1"></div>
                <div
                  class="flex rounded-lg border border-surface-200 dark:border-surface-700 overflow-hidden text-sm"
                >
                  <button
                    data-tab="targets"
                    class="pred-tab px-3 py-1.5 bg-primary-500 text-white"
                  >
                    Targets
                  </button>
                  <button
                    data-tab="matrix"
                    class="pred-tab px-3 py-1.5 hover:bg-surface-100 dark:hover:bg-surface-800"
                  >
                    Matrix
                  </button>
                  <button
                    data-tab="embedding"
                    class="pred-tab px-3 py-1.5 hover:bg-surface-100 dark:hover:bg-surface-800"
                  >
                    Embedding
                  </button>
                  <button
                    data-tab="table"
                    class="pred-tab px-3 py-1.5 hover:bg-surface-100 dark:hover:bg-surface-800"
                  >
                    Table
                  </button>
                </div>
              </div>
              <div id="predContent" class="p-4 min-h-[400px] relative">
                <div
                  id="predEmpty"
                  class="absolute inset-0 flex flex-col items-center justify-center text-surface-400"
                >
                  <svg
                    class="w-16 h-16 mb-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                  </svg>
                  <p>No predictions yet</p>
                  <p class="text-sm mt-1">
                    Initialize a model and run predictions
                  </p>
                </div>
                <div id="predTargets" class="hidden">
                  <div class="flex items-center gap-4 mb-4">
                    <label class="text-sm font-medium">Target:</label><select
                      id="targetSelect"
                      class="input w-40"
                    >
                    </select><label
                      class="flex items-center gap-2 text-sm"
                    ><input
                        type="checkbox"
                        id="showBands"
                        class="rounded"
                        checked
                      > Show bands</label>
                  </div>
                  <div id="chartTargets" class="h-80"></div>
                </div>
                <div id="predMatrix" class="hidden">
                  <canvas id="heatmapCanvas" class="w-full h-80"></canvas><div
                    id="heatmapLegend"
                    class="flex items-center justify-center gap-2 mt-2 text-xs"
                  >
                  </div>
                </div>
                <div id="predEmbedding" class="hidden">
                  <div class="text-xs text-surface-500 mb-2 italic">
                    2D projection (power iteration approximation)
                  </div>
                  <div id="chartEmbedding" class="h-80"></div>
                </div>
                <div id="predTable" class="hidden overflow-auto max-h-80">
                  <table id="predTableContent" class="w-full text-sm">
                    <thead
                      class="sticky top-0 bg-surface-100 dark:bg-surface-800"
                    >
                      <tr></tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- Data Inspector -->
            <section class="card overflow-hidden">
              <div
                class="p-4 border-b border-surface-200 dark:border-surface-700"
              >
                <h2 class="text-lg font-semibold flex items-center gap-2">
                  <svg
                    class="w-5 h-5 text-green-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                    />
                  </svg>
                  Data Inspector
                </h2>
              </div>
              <div class="p-4">
                <div id="dataEmpty" class="text-center text-surface-400 py-8">
                  <p>No training data in session</p>
                </div>
                <div id="dataStats" class="hidden">
                  <div
                    class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"
                  >
                    <div>
                      <span class="text-surface-500">Count:</span> <span
                        id="dsCount"
                        class="font-medium"
                      >0</span>
                    </div>
                    <div>
                      <span class="text-surface-500">X Range:</span> <span
                        id="dsXRange"
                        class="font-medium"
                      >—</span>
                    </div>
                    <div>
                      <span class="text-surface-500">Y Range:</span> <span
                        id="dsYRange"
                        class="font-medium"
                      >—</span>
                    </div>
                    <div>
                      <span class="text-surface-500">Y Mean:</span> <span
                        id="dsYMean"
                        class="font-medium"
                      >—</span>
                    </div>
                  </div>
                  <div class="overflow-auto max-h-48">
                    <table id="dataTable" class="w-full text-xs">
                      <thead
                        class="sticky top-0 bg-surface-100 dark:bg-surface-800"
                      >
                        <tr></tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>

            <!-- Insights -->
            <section class="card overflow-hidden">
              <div
                class="p-4 border-b border-surface-200 dark:border-surface-700"
              >
                <h2 class="text-lg font-semibold flex items-center gap-2">
                  <svg
                    class="w-5 h-5 text-amber-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  Insights
                </h2>
              </div>
              <div class="p-4 grid md:grid-cols-2 gap-4">
                <div>
                  <div class="text-sm font-medium mb-2">Residual Trend</div>
                  <div
                    id="chartResidual"
                    class="h-32 bg-surface-50 dark:bg-surface-800 rounded-lg"
                  >
                  </div>
                </div>
                <div>
                  <div class="text-sm font-medium mb-2">Uncertainty Width</div>
                  <div
                    id="chartUncertainty"
                    class="h-32 bg-surface-50 dark:bg-surface-800 rounded-lg"
                  >
                  </div>
                </div>
              </div>
            </section>
          </div>
        </main>
      </div>

      <!-- Console Drawer -->
      <div
        id="consoleDrawer"
        class="fixed bottom-0 left-0 right-0 bg-surface-900 text-surface-100 transform translate-y-full transition-transform z-50"
      >
        <div
          class="flex items-center justify-between px-4 py-2 border-b border-surface-700"
        >
          <span class="text-sm font-medium">Console</span>
          <button id="closeConsole" class="p-1 hover:bg-surface-800 rounded">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div
          id="consoleLog"
          class="h-48 overflow-y-auto p-2 font-mono text-xs space-y-1"
        >
        </div>
      </div>

      <!-- Loading Overlay -->
      <div
        id="loadingOverlay"
        class="fixed inset-0 bg-black/50 z-[100] hidden items-center justify-center"
      >
        <div
          class="bg-white dark:bg-surface-800 rounded-xl p-6 flex flex-col items-center gap-4 shadow-xl"
        >
          <svg
            class="w-10 h-10 animate-spin text-primary-500"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            >
            </circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            >
            </path>
          </svg>
          <div id="loadingText" class="text-sm font-medium">Processing...</div>
        </div>
      </div>

      <!-- Toast Container -->
      <div
        id="toastContainer"
        class="fixed top-16 right-4 z-[90] space-y-2"
        aria-live="polite"
      >
      </div>

      <!-- Modal Container -->
      <div id="modalContainer" class="fixed inset-0 z-[80] hidden">
        <div class="absolute inset-0 bg-black/50" id="modalOverlay"></div>
        <div
          class="absolute inset-0 overflow-y-auto p-4 flex items-start justify-center"
        >
          <div
            id="modalContent"
            class="bg-white dark:bg-surface-900 rounded-xl shadow-2xl w-full max-w-2xl my-8 animate-fade-in"
          >
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Worker code as string
      const workerCode = `
importScripts('https://cdn.esm.sh/jsr/@hviana/multivariate-regression');
let model = null;
let config = null;

self.onmessage = async (e) => {
    const { requestId, type, payload } = e.data;
    try {
        let result;
        switch (type) {
            case 'init':
                config = payload;
                model = new ESNRegression(config);
                result = { success: true, config };
                break;
            case 'fitOnline':
                if (!model) throw new Error('Model not initialized');
                result = model.fitOnline(payload);
                break;
            case 'predict':
                if (!model) throw new Error('Model not initialized');
                result = model.predict(payload.futureSteps);
                break;
            case 'save':
                if (!model) throw new Error('Model not initialized');
                result = model.save();
                break;
            case 'load':
                if (!model) model = new ESNRegression();
                model.load(payload);
                result = { success: true };
                break;
            case 'reset':
                if (model) model.reset();
                result = { success: true };
                break;
            case 'getModelSummary':
                if (!model) throw new Error('Model not initialized');
                result = model.getModelSummary();
                break;
            case 'getNormalizationStats':
                if (!model) throw new Error('Model not initialized');
                result = model.getNormalizationStats();
                break;
            case 'getWeights':
                if (!model) throw new Error('Model not initialized');
                result = model.getWeights ? model.getWeights() : { weights: [] };
                break;
            default:
                throw new Error('Unknown message type: ' + type);
        }
        self.postMessage({ requestId, type, result });
    } catch (error) {
        self.postMessage({ requestId, type, error: error.message });
    }
};
`;

      // Create worker
      const blob = new Blob([workerCode], {
        type: "application/javascript",
      });
      const worker = new Worker(URL.createObjectURL(blob));
      let requestId = 0;
      const pendingRequests = new Map();

      worker.onmessage = (e) => {
        const { requestId: rid, type, result, error } = e.data;
        const pending = pendingRequests.get(rid);
        if (pending) {
          pendingRequests.delete(rid);
          if (error) pending.reject(new Error(error));
          else pending.resolve(result);
        }
      };

      function sendToWorker(type, payload = {}) {
        return new Promise((resolve, reject) => {
          const rid = ++requestId;
          pendingRequests.set(rid, { resolve, reject });
          worker.postMessage({ requestId: rid, type, payload });
        });
      }

      // State
      const state = {
        status: "idle", // idle, ready, training, predicting
        modelConfig: null,
        samples: [],
        maxSamples: 5000,
        predictions: null,
        lastFitResult: null,
        lastUpdate: null,
        logs: [],
        theme: localStorage.getItem("esn-theme") || "system",
        currentPredTab: "targets",
        selectedTarget: 0,
      };

      // Utils
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      function log(msg, type = "info") {
        const ts = new Date().toLocaleTimeString();
        state.logs.unshift({ ts, msg, type });
        if (state.logs.length > 50) state.logs.pop();
        renderConsole();
        const badge = $("#consoleBadge");
        badge.textContent = state.logs.length;
        badge.classList.remove("hidden");
        badge.classList.add("flex");
      }

      function toast(msg, type = "info") {
        const container = $("#toastContainer");
        const colors = {
          info: "bg-primary-500",
          success: "bg-green-500",
          error: "bg-red-500",
          warning: "bg-amber-500",
        };
        const div = document.createElement("div");
        div.className = `${
          colors[type]
        } text-white px-4 py-2 rounded-lg shadow-lg animate-fade-in text-sm`;
        div.textContent = msg;
        container.appendChild(div);
        setTimeout(() => div.remove(), 4000);
      }

      function showLoading(text = "Processing...") {
        $("#loadingText").textContent = text;
        $("#loadingOverlay").classList.remove("hidden");
        $("#loadingOverlay").classList.add("flex");
      }

      function hideLoading() {
        $("#loadingOverlay").classList.remove("flex");
        $("#loadingOverlay").classList.add("hidden");
      }

      function setStatus(status) {
        state.status = status;
        const badge = $("#statusBadge");
        const colors = {
          idle:
            "bg-surface-200 dark:bg-surface-700 text-surface-600 dark:text-surface-300",
          ready:
            "bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300",
          training:
            "bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300",
          predicting:
            "bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300",
        };
        const labels = {
          idle: "Not initialized",
          ready: "Ready",
          training: "Training...",
          predicting: "Predicting...",
        };
        badge.className = `px-3 py-1 rounded-full text-xs font-medium ${
          colors[status]
        }`;
        badge.textContent = labels[status];
      }

      // Theme
      function applyTheme() {
        const prefersDark =
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const isDark = state.theme === "dark" ||
          (state.theme === "system" && prefersDark);
        document.documentElement.classList.toggle("dark", isDark);
      }
      applyTheme();

      $("#themeBtn").onclick = () => {
        state.theme = state.theme === "dark" ? "light" : "dark";
        localStorage.setItem("esn-theme", state.theme);
        applyTheme();
      };

      // Sidebar
      $("#menuBtn").onclick = () => {
        $("#sidebar").classList.remove("-translate-x-full");
        $("#menuOverlay").classList.remove("hidden");
      };
      $("#closeSidebar").onclick = $("#menuOverlay").onclick = () => {
        $("#sidebar").classList.add("-translate-x-full");
        $("#menuOverlay").classList.add("hidden");
      };

      // Accordions
      $$(".accordion-btn").forEach((btn) => {
        btn.onclick = () => {
          const content = btn.nextElementSibling;
          const icon = btn.querySelector(".accordion-icon");
          const isOpen = !content.classList.contains("hidden");
          content.classList.toggle("hidden", isOpen);
          icon.classList.toggle("rotate-180", !isOpen);
        };
      });

      // Console
      $("#consoleBtn").onclick = () =>
        $("#consoleDrawer").classList.toggle("translate-y-full");
      $("#closeConsole").onclick = () =>
        $("#consoleDrawer").classList.add("translate-y-full");

      function renderConsole() {
        const log = $("#consoleLog");
        log.innerHTML = state.logs.map((l) => {
          const colors = {
            info: "text-blue-400",
            success: "text-green-400",
            error: "text-red-400",
            warning: "text-amber-400",
          };
          return `<div class="${
            colors[l.type]
          }"><span class="text-surface-500">[${l.ts}]</span> ${l.msg}</div>`;
        }).join("");
      }

      // Modal
      function showModal(content) {
        $("#modalContent").innerHTML = content;
        $("#modalContainer").classList.remove("hidden");
        const firstInput = $("#modalContent").querySelector(
          "input, select, textarea",
        );
        if (firstInput) firstInput.focus();
      }

      function hideModal() {
        $("#modalContainer").classList.add("hidden");
      }

      $("#modalOverlay").onclick = hideModal;
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hideModal();
      });

      // Actions
      $$(".menu-action").forEach((btn) => {
        btn.onclick = () => {
          const action = btn.dataset.action;
          $("#sidebar").classList.add("-translate-x-full");
          $("#menuOverlay").classList.add("hidden");
          handleAction(action);
        };
      });

      async function handleAction(action) {
        switch (action) {
          case "instantiate":
            showInstantiateModal();
            break;
          case "addManual":
            showManualModal();
            break;
          case "uploadBulk":
            showUploadModal();
            break;
          case "predict":
            showPredictModal();
            break;
          case "saveState":
            await saveState();
            break;
          case "loadState":
            showLoadModal();
            break;
          case "reset":
            showResetModal();
            break;
          case "randomTest":
            showRandomTestModal();
            break;
          case "exportSession":
            exportSession();
            break;
        }
      }

      // Presets
      const PRESETS = {
        fast: {
          name: "Fast & Simple",
          reservoirSize: 64,
          maxSequenceLength: 32,
          spectralRadius: 0.8,
          leakRate: 0.5,
          reservoirSparsity: 0.9,
          rlsLambda: 0.99,
        },
        balanced: {
          name: "Balanced",
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.9,
          leakRate: 0.3,
          reservoirSparsity: 0.9,
          rlsLambda: 0.999,
        },
        accurate: {
          name: "High Accuracy",
          reservoirSize: 512,
          maxSequenceLength: 128,
          spectralRadius: 0.95,
          leakRate: 0.2,
          reservoirSparsity: 0.85,
          rlsLambda: 0.9995,
          l2Lambda: 0.0001,
        },
        adaptive: {
          name: "Adaptive (Non-stationary)",
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.85,
          leakRate: 0.5,
          rlsLambda: 0.97,
          outlierThreshold: 2.5,
        },
        robust: {
          name: "Robust (Noisy)",
          reservoirSize: 256,
          maxSequenceLength: 64,
          spectralRadius: 0.9,
          leakRate: 0.2,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
        },
      };

      const PARAMS = [
        {
          key: "maxSequenceLength",
          label: "Max Sequence Length",
          default: 64,
          desc: "Maximum temporal context window",
          detail:
            "Determines how many past samples influence predictions. Higher values capture longer patterns but use more memory. Recommended: 32-512.",
        },
        {
          key: "reservoirSize",
          label: "Reservoir Size",
          default: 256,
          desc: "Number of reservoir neurons",
          detail:
            "Controls model capacity. Start small (64-128) and increase if underfitting. Memory: O(N²). Recommended: 64-1024.",
        },
        {
          key: "spectralRadius",
          label: "Spectral Radius",
          default: 0.9,
          desc: "Memory decay rate (< 1 for stability)",
          detail:
            "Higher values = longer memory. Values ≥ 1 may cause instability. Short patterns: 0.5-0.7, Long patterns: 0.95-0.99.",
        },
        {
          key: "leakRate",
          label: "Leak Rate",
          default: 0.3,
          desc: "Temporal smoothing (0-1)",
          detail:
            "Lower values smooth more (good for noisy data). Higher values respond faster. Noisy: 0.1-0.3, Fast: 0.6-0.9.",
        },
        {
          key: "inputScale",
          label: "Input Scale",
          default: 1.0,
          desc: "Input amplification factor",
          detail:
            "Scales input before reservoir. Large inputs may saturate activation. Usually 0.5-2.0.",
        },
        {
          key: "biasScale",
          label: "Bias Scale",
          default: 0.1,
          desc: "Reservoir bias magnitude",
          detail:
            "Adds diversity to neuron activations. Usually 0.05-0.2.",
        },
        {
          key: "reservoirSparsity",
          label: "Reservoir Sparsity",
          default: 0.9,
          desc: "Fraction of zero connections",
          detail:
            "Higher = faster, sparser networks. 0.9 means 90% zero weights. Recommended: 0.8-0.95.",
        },
        {
          key: "inputSparsity",
          label: "Input Sparsity",
          default: 0.0,
          desc: "Input connection sparsity",
          detail:
            "Fraction of input connections set to zero. Can act as feature selection. Usually 0-0.5.",
        },
        {
          key: "activation",
          label: "Activation",
          default: "tanh",
          type: "select",
          options: ["tanh", "relu"],
          desc: "Reservoir activation function",
          detail:
            "tanh is bounded (-1,1) and usually better. ReLU can work for positive data.",
        },
        {
          key: "useInputInReadout",
          label: "Input in Readout",
          default: true,
          type: "bool",
          desc: "Include input in output computation",
          detail:
            "Provides direct input-output shortcut. Usually improves accuracy.",
        },
        {
          key: "useBiasInReadout",
          label: "Bias in Readout",
          default: true,
          type: "bool",
          desc: "Include bias in output computation",
          detail: "Adds learnable offset. Usually keep enabled.",
        },
        {
          key: "rlsLambda",
          label: "RLS Lambda",
          default: 0.999,
          desc: "Forgetting factor (0.9-1)",
          detail:
            "Controls how fast old data is forgotten. Stationary: 0.999+, Non-stationary: 0.95-0.99.",
        },
        {
          key: "rlsDelta",
          label: "RLS Delta",
          default: 1.0,
          desc: "Initial covariance diagonal",
          detail: "Larger = faster initial learning. Usually 0.1-10.",
        },
        {
          key: "epsilon",
          label: "Epsilon",
          default: 1e-8,
          desc: "Numerical stability constant",
          detail: "Prevents division by zero. Usually 1e-8.",
        },
        {
          key: "l2Lambda",
          label: "L2 Lambda",
          default: 0.0001,
          desc: "Weight regularization strength",
          detail:
            "Prevents overfitting. Small data: 0.01-0.1, Large data: 0.00001-0.0001.",
        },
        {
          key: "gradientClipNorm",
          label: "Gradient Clip Norm",
          default: 1.0,
          desc: "Maximum update magnitude",
          detail: "Prevents explosive updates. Usually 0.5-2.0.",
        },
        {
          key: "normalizationEpsilon",
          label: "Norm Epsilon",
          default: 1e-8,
          desc: "Normalization stability constant",
          detail: "For online normalization. Usually 1e-8.",
        },
        {
          key: "normalizationWarmup",
          label: "Norm Warmup",
          default: 10,
          desc: "Samples before normalization activates",
          detail:
            "Collects statistics before normalizing. Usually 5-50.",
        },
        {
          key: "outlierThreshold",
          label: "Outlier Threshold",
          default: 3.0,
          desc: "Z-score for outlier detection",
          detail:
            "Samples beyond this are downweighted. Strict: 2.0, Lenient: 4.0.",
        },
        {
          key: "outlierMinWeight",
          label: "Outlier Min Weight",
          default: 0.1,
          desc: "Minimum weight for outliers",
          detail:
            "How much outliers still contribute. 0 = full rejection.",
        },
        {
          key: "residualWindowSize",
          label: "Residual Window",
          default: 100,
          desc: "Window for uncertainty estimation",
          detail:
            "Number of recent residuals for confidence bands. 50-200.",
        },
        {
          key: "uncertaintyMultiplier",
          label: "Uncertainty Multiplier",
          default: 1.96,
          desc: "Confidence interval width (1.96 ≈ 95%)",
          detail: "1.64 = 90%, 1.96 = 95%, 2.58 = 99% confidence.",
        },
        {
          key: "weightInitScale",
          label: "Weight Init Scale",
          default: 0.1,
          desc: "Initial weight magnitude",
          detail:
            "Scale for random weight initialization. Usually 0.05-0.2.",
        },
        {
          key: "seed",
          label: "Random Seed",
          default: 42,
          desc: "Seed for reproducibility",
          detail: "Same seed = identical results.",
        },
        {
          key: "verbose",
          label: "Verbose",
          default: false,
          type: "bool",
          desc: "Enable logging",
          detail: "Outputs training progress to console.",
        },
        {
          key: "rollforwardMode",
          label: "Rollforward Mode",
          default: "holdLastX",
          type: "select",
          options: ["holdLastX", "autoregressive"],
          desc: "Multi-step prediction strategy",
          detail:
            "holdLastX: uses last known input. autoregressive: uses predictions as next input (requires nFeatures == nTargets).",
        },
      ];

      function showInstantiateModal() {
        const presetOptions = Object.entries(PRESETS).map(([k, v]) =>
          `<option value="${k}">${v.name}</option>`
        ).join("");
        const paramsHtml = PARAMS.map((p) => {
          const inputHtml = p.type === "bool"
            ? `<input type="checkbox" id="param_${p.key}" ${
              p.default ? "checked" : ""
            } class="rounded">`
            : p.type === "select"
            ? `<select id="param_${p.key}" class="input w-32">${
              p.options.map((o) =>
                `<option value="${o}" ${
                  o === p.default ? "selected" : ""
                }>${o}</option>`
              ).join("")
            }</select>`
            : `<input type="number" id="param_${p.key}" value="${p.default}" step="any" class="input w-32">`;
          return `<div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-start py-2 border-b border-surface-100 dark:border-surface-800">
            <div><label class="font-medium text-sm">${p.label}</label><div class="text-xs text-surface-500">${p.desc}</div></div>
            <div>${inputHtml}</div>
            <details class="text-xs"><summary class="cursor-pointer text-primary-500 hover:text-primary-600">Learn more</summary><div class="mt-1 text-surface-500">${p.detail}</div></details>
        </div>`;
        }).join("");

        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Instantiate Model</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Preset</label>
                <select id="presetSelect" class="input w-full">${presetOptions}</select>
            </div>
            <div class="mb-4 p-3 bg-surface-50 dark:bg-surface-800 rounded-lg">
                <div class="text-sm font-medium mb-2">Quick Tuning Helper</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                    <select id="qh_volume" class="input"><option value="">Data volume?</option><option value="small">Small</option><option value="medium">Medium</option><option value="large">Large</option></select>
                    <select id="qh_stationary" class="input"><option value="">Stationary?</option><option value="yes">Yes</option><option value="no">No</option></select>
                    <select id="qh_pattern" class="input"><option value="">Pattern length?</option><option value="short">Short</option><option value="medium">Medium</option><option value="long">Long</option></select>
                    <select id="qh_noise" class="input"><option value="">Noise level?</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select>
                </div>
                <button id="applySuggestions" class="btn-secondary mt-2 text-xs">Apply Suggestions</button>
            </div>
            <div id="sanityWarnings" class="mb-4 hidden p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-amber-700 dark:text-amber-300 text-sm"></div>
            <details class="mb-4"><summary class="cursor-pointer text-sm font-medium">All Parameters</summary><div class="mt-2 max-h-64 overflow-y-auto">${paramsHtml}</div></details>
            <div class="flex justify-end gap-2">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="instantiateBtn" class="btn-primary">Instantiate</button>
            </div>
        </div>
    `);

        $("#presetSelect").onchange = () => {
          const preset = PRESETS[$("#presetSelect").value];
          PARAMS.forEach((p) => {
            const el = $(`#param_${p.key}`);
            const val = preset[p.key] ?? p.default;
            if (p.type === "bool") el.checked = val;
            else el.value = val;
          });
          checkSanity();
        };

        $("#applySuggestions").onclick = () => {
          const v = $("#qh_volume").value,
            s = $("#qh_stationary").value,
            p = $("#qh_pattern").value,
            n = $("#qh_noise").value;
          if (v === "small") $("#param_reservoirSize").value = 64;
          if (v === "large") $("#param_reservoirSize").value = 512;
          if (s === "no") $("#param_rlsLambda").value = 0.97;
          if (p === "short") {
            $("#param_spectralRadius").value = 0.7;
            $("#param_leakRate").value = 0.6;
          }
          if (p === "long") {
            $("#param_spectralRadius").value = 0.95;
            $("#param_leakRate").value = 0.2;
          }
          if (n === "high") {
            $("#param_leakRate").value = 0.2;
            $("#param_outlierThreshold").value = 2.0;
          }
          checkSanity();
          toast("Suggestions applied", "success");
        };

        PARAMS.forEach((p) => {
          const el = $(`#param_${p.key}`);
          el.onchange = el.oninput = checkSanity;
        });

        function checkSanity() {
          const warnings = [];
          const sr = parseFloat($("#param_spectralRadius").value);
          const rl = parseFloat($("#param_rlsLambda").value);
          const rd = parseFloat($("#param_rlsDelta").value);
          const is = parseFloat($("#param_inputScale").value);
          if (sr >= 1) {
            warnings.push("Spectral radius ≥ 1 may cause instability");
          }
          if (rl < 0.9 && rd < 0.1) {
            warnings.push(
              "Very low rlsLambda with tiny rlsDelta may be unstable",
            );
          }
          if (is > 5) {
            warnings.push("High inputScale may saturate activation");
          }
          const box = $("#sanityWarnings");
          if (warnings.length) {
            box.innerHTML =
              '<strong>⚠️ Warnings:</strong><ul class="list-disc ml-5 mt-1">' +
              warnings.map((w) => `<li>${w}</li>`).join("") + "</ul>";
            box.classList.remove("hidden");
          } else box.classList.add("hidden");
        }

        $("#instantiateBtn").onclick = async () => {
          const config = {};
          PARAMS.forEach((p) => {
            const el = $(`#param_${p.key}`);
            if (p.type === "bool") config[p.key] = el.checked;
            else if (p.type === "select") config[p.key] = el.value;
            else config[p.key] = parseFloat(el.value);
          });
          hideModal();
          showLoading("Initializing model...");
          try {
            await sendToWorker("init", config);
            state.modelConfig = config;
            state.samples = [];
            state.predictions = null;
            setStatus("ready");
            log("Model initialized", "success");
            toast("Model initialized", "success");
            renderUI();
          } catch (e) {
            log("Init failed: " + e.message, "error");
            toast("Failed to initialize: " + e.message, "error");
          }
          hideLoading();
        };

        checkSanity();
      }

      function showManualModal() {
        if (state.status === "idle") {
          toast("Initialize a model first", "warning");
          return;
        }
        const nF = state.modelConfig?.nFeatures || 3;
        const nT = state.modelConfig?.nTargets || 1;
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Add Manual Data</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium mb-1">Features (nFeatures)</label><input type="number" id="manualNF" value="${nF}" min="1" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Targets (nTargets)</label><input type="number" id="manualNT" value="${nT}" min="1" class="input w-full"></div>
            </div>
            <div id="manualSamples" class="space-y-3 max-h-64 overflow-y-auto"></div>
            <button id="addSampleRow" class="btn-secondary mt-3 text-sm">+ Add Sample</button>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="submitManual" class="btn-primary">Train</button>
            </div>
        </div>
    `);

        function renderSampleRow() {
          const nF = parseInt($("#manualNF").value) || 1;
          const nT = parseInt($("#manualNT").value) || 1;
          const container = $("#manualSamples");
          const idx = container.children.length;
          const div = document.createElement("div");
          div.className =
            "p-3 bg-surface-50 dark:bg-surface-800 rounded-lg";
          div.innerHTML = `
            <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium">Sample ${
            idx + 1
          }</span><button class="text-red-500 hover:text-red-600 text-xs remove-sample">Remove</button></div>
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-xs text-surface-500">X (comma-separated)</label><input type="text" class="input w-full sample-x" placeholder="${
            Array(nF).fill("0").join(", ")
          }"></div>
                <div><label class="text-xs text-surface-500">Y (comma-separated)</label><input type="text" class="input w-full sample-y" placeholder="${
            Array(nT).fill("0").join(", ")
          }"></div>
            </div>
        `;
          container.appendChild(div);
          div.querySelector(".remove-sample").onclick = () =>
            div.remove();
        }

        renderSampleRow();
        $("#addSampleRow").onclick = renderSampleRow;
        $("#manualNF").onchange = $("#manualNT").onchange = () => {
          $("#manualSamples").innerHTML = "";
          renderSampleRow();
        };

        $("#submitManual").onclick = async () => {
          const rows = $$("#manualSamples > div");
          const xCoordinates = [], yCoordinates = [];
          for (const row of rows) {
            const xStr = row.querySelector(".sample-x").value;
            const yStr = row.querySelector(".sample-y").value;
            const x = xStr.split(",").map((v) => parseFloat(v.trim()))
              .filter((v) => !isNaN(v));
            const y = yStr.split(",").map((v) => parseFloat(v.trim()))
              .filter((v) => !isNaN(v));
            if (x.length && y.length) {
              xCoordinates.push(x);
              yCoordinates.push(y);
            }
          }
          if (!xCoordinates.length) {
            toast("No valid samples", "error");
            return;
          }
          hideModal();
          await trainData(xCoordinates, yCoordinates);
        };
      }

      function showUploadModal() {
        if (state.status === "idle") {
          toast("Initialize a model first", "warning");
          return;
        }
        const example1 = JSON.stringify(
          { xCoordinates: [[1, 2], [3, 4]], yCoordinates: [[5], [6]] },
          null,
          2,
        );
        const example2 = JSON.stringify(
          { samples: [{ x: [1, 2], y: [5] }, { x: [3, 4], y: [6] }] },
          null,
          2,
        );
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Upload Bulk Data</h3>
            <p class="text-sm text-surface-500 mb-4">Upload a JSON file with training data.</p>
            <div class="mb-4 p-3 bg-surface-50 dark:bg-surface-800 rounded-lg text-xs">
                <div class="font-medium mb-2">Accepted formats:</div>
                <details><summary class="cursor-pointer text-primary-500">Format 1: xCoordinates/yCoordinates</summary><pre class="mt-1 overflow-auto max-h-32 bg-surface-100 dark:bg-surface-900 p-2 rounded">${example1}</pre><button class="copy-example text-primary-500 text-xs mt-1" data-example="${
          encodeURIComponent(example1)
        }">Copy</button></details>
                <details class="mt-2"><summary class="cursor-pointer text-primary-500">Format 2: samples array</summary><pre class="mt-1 overflow-auto max-h-32 bg-surface-100 dark:bg-surface-900 p-2 rounded">${example2}</pre><button class="copy-example text-primary-500 text-xs mt-1" data-example="${
          encodeURIComponent(example2)
        }">Copy</button></details>
            </div>
            <input type="file" id="uploadFile" accept=".json" class="hidden">
            <label for="uploadFile" class="btn-secondary cursor-pointer inline-block">Select JSON File</label>
            <div id="uploadStatus" class="mt-2 text-sm"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="uploadBtn" class="btn-primary" disabled>Upload & Train</button>
            </div>
        </div>
    `);

        $$(".copy-example").forEach((btn) => {
          btn.onclick = () => {
            navigator.clipboard.writeText(
              decodeURIComponent(btn.dataset.example),
            );
            toast("Copied to clipboard", "success");
          };
        });

        let uploadedData = null;
        $("#uploadFile").onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(reader.result);
              let xCoordinates, yCoordinates;
              if (data.xCoordinates && data.yCoordinates) {
                xCoordinates = data.xCoordinates;
                yCoordinates = data.yCoordinates;
              } else if (data.samples) {
                xCoordinates = data.samples.map((s) => s.x);
                yCoordinates = data.samples.map((s) => s.y);
              } else throw new Error("Unknown format");
              if (xCoordinates.length !== yCoordinates.length) {
                throw new Error("x and y length mismatch");
              }
              uploadedData = { xCoordinates, yCoordinates };
              $("#uploadStatus").innerHTML =
                `<span class="text-green-500">✓</span> ${xCoordinates.length} samples loaded`;
              $("#uploadBtn").disabled = false;
            } catch (err) {
              $("#uploadStatus").innerHTML =
                `<span class="text-red-500">✗</span> ${err.message}`;
              $("#uploadBtn").disabled = true;
            }
          };
          reader.readAsText(file);
        };

        $("#uploadBtn").onclick = async () => {
          if (!uploadedData) return;
          hideModal();
          await trainData(
            uploadedData.xCoordinates,
            uploadedData.yCoordinates,
          );
        };
      }

      async function trainData(xCoordinates, yCoordinates) {
        showLoading("Training...");
        setStatus("training");
        try {
          const result = await sendToWorker("fitOnline", {
            xCoordinates,
            yCoordinates,
          });
          state.lastFitResult = result;
          state.lastUpdate = new Date();
          xCoordinates.forEach((x, i) => {
            state.samples.push({ x, y: yCoordinates[i] });
            if (state.samples.length > state.maxSamples) {
              state.samples.shift();
            }
          });
          log(
            `Trained ${xCoordinates.length} samples, loss: ${
              result.averageLoss.toFixed(6)
            }`,
            "success",
          );
          toast(`Trained ${xCoordinates.length} samples`, "success");
          setStatus("ready");
          renderUI();
        } catch (e) {
          log("Training failed: " + e.message, "error");
          toast("Training failed: " + e.message, "error");
          setStatus("ready");
        }
        hideLoading();
      }

      function showPredictModal() {
        if (state.status === "idle") {
          toast("Initialize a model first", "warning");
          return;
        }
        const maxSeq = state.modelConfig?.maxSequenceLength || 64;
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Run Prediction</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Future Steps (max ${maxSeq})</label>
                <input type="number" id="futureSteps" value="10" min="1" max="${maxSeq}" class="input w-full">
            </div>
            <label class="flex items-center gap-2 mb-4 text-sm"><input type="checkbox" id="showUncertainty" checked class="rounded"> Show uncertainty bands</label>
            <div class="flex justify-end gap-2">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="runPredict" class="btn-primary">Predict</button>
            </div>
        </div>
    `);

        $("#runPredict").onclick = async () => {
          const steps = parseInt($("#futureSteps").value) || 10;
          hideModal();
          showLoading("Predicting...");
          setStatus("predicting");
          try {
            const result = await sendToWorker("predict", {
              futureSteps: steps,
            });
            state.predictions = result;
            state.lastUpdate = new Date();
            log(
              `Prediction completed: ${steps} steps, confidence: ${
                (result.confidence * 100).toFixed(1)
              }%`,
              "success",
            );
            toast("Prediction completed", "success");
            setStatus("ready");
            renderUI();
          } catch (e) {
            log("Prediction failed: " + e.message, "error");
            toast("Prediction failed: " + e.message, "error");
            setStatus("ready");
          }
          hideLoading();
        };
      }

      async function saveState() {
        if (state.status === "idle") {
          toast("Nothing to save", "warning");
          return;
        }
        showLoading("Saving...");
        try {
          const modelState = await sendToWorker("save");
          const summary = await sendToWorker("getModelSummary");
          const data = {
            modelState,
            meta: {
              config: state.modelConfig,
              createdAt: new Date().toISOString(),
              nFeatures: summary.nFeatures,
              nTargets: summary.nTargets,
              sampleCount: summary.sampleCount,
            },
            samples: state.samples.slice(-1000),
          };
          const blob = new Blob([JSON.stringify(data)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-state-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          log("State saved", "success");
          toast("State saved", "success");
        } catch (e) {
          log("Save failed: " + e.message, "error");
          toast("Save failed: " + e.message, "error");
        }
        hideLoading();
      }

      function showLoadModal() {
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Load State</h3>
            <input type="file" id="loadFile" accept=".json" class="hidden">
            <label for="loadFile" class="btn-secondary cursor-pointer inline-block">Select State File</label>
            <div id="loadStatus" class="mt-2 text-sm"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="loadBtn" class="btn-primary" disabled>Load</button>
            </div>
        </div>
    `);

        let loadedData = null;
        $("#loadFile").onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              loadedData = JSON.parse(reader.result);
              if (!loadedData.modelState) {
                throw new Error("Invalid state file");
              }
              $("#loadStatus").innerHTML =
                `<span class="text-green-500">✓</span> State loaded (${
                  loadedData.meta?.sampleCount || "?"
                } samples)`;
              $("#loadBtn").disabled = false;
            } catch (err) {
              $("#loadStatus").innerHTML =
                `<span class="text-red-500">✗</span> ${err.message}`;
              $("#loadBtn").disabled = true;
            }
          };
          reader.readAsText(file);
        };

        $("#loadBtn").onclick = async () => {
          if (!loadedData) return;
          hideModal();
          showLoading("Loading...");
          try {
            await sendToWorker("load", loadedData.modelState);
            state.modelConfig = loadedData.meta?.config;
            state.samples = loadedData.samples || [];
            setStatus("ready");
            log("State loaded", "success");
            toast("State loaded", "success");
            renderUI();
          } catch (e) {
            log("Load failed: " + e.message, "error");
            toast("Load failed: " + e.message, "error");
          }
          hideLoading();
        };
      }

      function showResetModal() {
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Reset Model</h3>
            <p class="text-sm text-surface-500 mb-4">This will clear the model and all session data. Are you sure?</p>
            <div class="flex justify-end gap-2">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="confirmReset" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium">Reset</button>
            </div>
        </div>
    `);

        $("#confirmReset").onclick = async () => {
          hideModal();
          showLoading("Resetting...");
          try {
            await sendToWorker("reset");
            state.modelConfig = null;
            state.samples = [];
            state.predictions = null;
            state.lastFitResult = null;
            setStatus("idle");
            log("Model reset", "success");
            toast("Model reset", "success");
            renderUI();
          } catch (e) {
            log("Reset failed: " + e.message, "error");
          }
          hideLoading();
        };
      }

      function showRandomTestModal() {
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Random Standard Test</h3>
            <p class="text-sm text-surface-500 mb-4">Generate synthetic data with trend + seasonality + noise.</p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium mb-1">Features</label><input type="number" id="rtFeatures" value="3" min="1" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Targets</label><input type="number" id="rtTargets" value="2" min="1" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Length</label><input type="number" id="rtLength" value="200" min="10" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Noise Level</label><input type="number" id="rtNoise" value="0.1" min="0" step="0.01" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Seed</label><input type="number" id="rtSeed" value="42" class="input w-full"></div>
                <div><label class="block text-sm font-medium mb-1">Predict Steps</label><input type="number" id="rtSteps" value="20" min="1" class="input w-full"></div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="hideModal()" class="btn-secondary">Cancel</button>
                <button id="runRandomTest" class="btn-primary">Run Test</button>
            </div>
        </div>
    `);

        $("#runRandomTest").onclick = async () => {
          const nF = parseInt($("#rtFeatures").value) || 3;
          const nT = parseInt($("#rtTargets").value) || 2;
          const len = parseInt($("#rtLength").value) || 200;
          const noise = parseFloat($("#rtNoise").value) || 0.1;
          const seed = parseInt($("#rtSeed").value) || 42;
          const steps = parseInt($("#rtSteps").value) || 20;
          hideModal();

          // Simple seeded random
          let s = seed;
          const rand = () => {
            s = (s * 1103515245 + 12345) & 0x7fffffff;
            return s / 0x7fffffff;
          };

          const xCoordinates = [], yCoordinates = [];
          for (let t = 0; t < len; t++) {
            const x = [];
            for (let f = 0; f < nF; f++) {
              x.push(
                Math.sin(t * 0.1 * (f + 1)) +
                  0.5 * Math.cos(t * 0.05 * (f + 1)) +
                  (rand() - 0.5) * noise,
              );
            }
            const y = [];
            for (let j = 0; j < nT; j++) {
              y.push(
                x.reduce((a, v, i) => a + v * (0.5 + i * 0.1), 0) +
                  Math.sin(t * 0.2 * (j + 1)) + (rand() - 0.5) * noise,
              );
            }
            xCoordinates.push(x);
            yCoordinates.push(y);
          }

          showLoading("Running test...");
          try {
            // Initialize with balanced preset
            const config = {
              ...PRESETS.balanced,
              maxSequenceLength: Math.min(64, len),
            };
            await sendToWorker("init", config);
            state.modelConfig = config;
            state.samples = [];

            // Train
            setStatus("training");
            const trainLen = Math.floor(len * 0.8);
            const result = await sendToWorker("fitOnline", {
              xCoordinates: xCoordinates.slice(0, trainLen),
              yCoordinates: yCoordinates.slice(0, trainLen),
            });
            state.lastFitResult = result;
            xCoordinates.slice(0, trainLen).forEach((x, i) =>
              state.samples.push({ x, y: yCoordinates[i] })
            );

            // Predict
            setStatus("predicting");
            const pred = await sendToWorker("predict", {
              futureSteps: steps,
            });
            state.predictions = pred;
            state.lastUpdate = new Date();

            // Compute RMSE
            const actual = yCoordinates.slice(
              trainLen,
              trainLen + steps,
            );
            let mse = 0, count = 0;
            for (let i = 0; i < Math.min(steps, actual.length); i++) {
              for (let j = 0; j < nT; j++) {
                mse += Math.pow(
                  pred.predictions[i][j] - actual[i][j],
                  2,
                );
                count++;
              }
            }
            const rmse = Math.sqrt(mse / count);

            setStatus("ready");
            log(
              `Random test: RMSE=${rmse.toFixed(4)}, Loss=${
                result.averageLoss.toFixed(6)
              }, Conf=${(pred.confidence * 100).toFixed(1)}%`,
              "success",
            );
            toast(`Test complete! RMSE: ${rmse.toFixed(4)}`, "success");
            renderUI();
          } catch (e) {
            log("Test failed: " + e.message, "error");
            toast("Test failed: " + e.message, "error");
            setStatus("idle");
          }
          hideLoading();
        };
      }

      function exportSession() {
        const data = {
          samples: state.samples,
          predictions: state.predictions,
          config: state.modelConfig,
          exportedAt: new Date().toISOString(),
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `esn-session-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        toast("Session exported", "success");
      }

      // Help
      $("#helpBtn").onclick = () => {
        showModal(`
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">How to Use ESN Regression Studio</h3>
            <ol class="list-decimal ml-5 space-y-2 text-sm">
                <li><strong>Instantiate</strong> a model with your preferred settings or use a preset.</li>
                <li><strong>Add data</strong> manually or upload a JSON file with training samples.</li>
                <li>Train the model by submitting your data. You can add data incrementally.</li>
                <li><strong>Run predictions</strong> to forecast future values with uncertainty bands.</li>
                <li>Explore <strong>visualizations</strong>: time series, heatmap, embedding, and table views.</li>
                <li>Check the <strong>Data Inspector</strong> for sample statistics.</li>
                <li><strong>Save/Load</strong> your model state to continue later.</li>
                <li>Use <strong>Random Test</strong> to quickly evaluate with synthetic data.</li>
            </ol>
            <div class="mt-4 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg text-sm">
                <strong>Tip:</strong> Use the Quick Tuning Helper in Instantiate to get parameter suggestions based on your data characteristics.
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="hideModal()" class="btn-primary">Got it</button>
            </div>
        </div>
    `);
      };

      // Prediction tabs
      $$(".pred-tab").forEach((tab) => {
        tab.onclick = () => {
          state.currentPredTab = tab.dataset.tab;
          renderPredictions();
        };
      });

      // Render UI
      async function renderUI() {
        // Stats
        let summary = null;
        if (state.status !== "idle") {
          try {
            summary = await sendToWorker("getModelSummary");
          } catch (e) {}
        }
        $("#statSamples").textContent = summary?.sampleCount ||
          state.samples.length || 0;
        $("#statFeatures").textContent = summary?.nFeatures || "—";
        $("#statTargets").textContent = summary?.nTargets || "—";
        $("#statLoss").textContent = state.lastFitResult
          ? state.lastFitResult.averageLoss.toFixed(6)
          : "—";
        $("#statConfidence").textContent = state.predictions
          ? (state.predictions.confidence * 100).toFixed(1) + "%"
          : "—";
        $("#statUpdated").textContent = state.lastUpdate
          ? state.lastUpdate.toLocaleTimeString()
          : "—";

        // Data inspector
        if (state.samples.length) {
          $("#dataEmpty").classList.add("hidden");
          $("#dataStats").classList.remove("hidden");
          const xAll = state.samples.flatMap((s) => s.x);
          const yAll = state.samples.flatMap((s) => s.y);
          const xMin = Math.min(...xAll), xMax = Math.max(...xAll);
          const yMin = Math.min(...yAll), yMax = Math.max(...yAll);
          const yMean = yAll.reduce((a, b) => a + b, 0) / yAll.length;
          $("#dsCount").textContent = state.samples.length;
          $("#dsXRange").textContent = `${xMin.toFixed(2)} - ${
            xMax.toFixed(2)
          }`;
          $("#dsYRange").textContent = `${yMin.toFixed(2)} - ${
            yMax.toFixed(2)
          }`;
          $("#dsYMean").textContent = yMean.toFixed(4);

          const table = $("#dataTable");
          const last = state.samples.slice(-20).reverse();
          const nF = last[0]?.x.length || 0,
            nT = last[0]?.y.length || 0;
          table.querySelector("thead tr").innerHTML =
            '<th class="px-2 py-1 text-left">#</th>' +
            Array(nF).fill(0).map((_, i) =>
              `<th class="px-2 py-1">X${i}</th>`
            ).join("") + Array(nT).fill(0).map((_, i) =>
              `<th class="px-2 py-1">Y${i}</th>`
            ).join("");
          table.querySelector("tbody").innerHTML = last.map((s, i) =>
            `<tr class="border-b border-surface-200 dark:border-surface-700"><td class="px-2 py-1 text-surface-500">${
              state.samples.length - i
            }</td>${
              s.x.map((v) =>
                `<td class="px-2 py-1">${v.toFixed(3)}</td>`
              ).join("")
            }${
              s.y.map((v) =>
                `<td class="px-2 py-1 font-medium">${v.toFixed(3)}</td>`
              ).join("")
            }</tr>`
          ).join("");
        } else {
          $("#dataEmpty").classList.remove("hidden");
          $("#dataStats").classList.add("hidden");
        }

        renderPredictions();
        renderInsights();
      }

      function renderPredictions() {
        const tabs = $$(".pred-tab");
        tabs.forEach((t) => {
          const isActive = t.dataset.tab === state.currentPredTab;
          t.classList.toggle("bg-primary-500", isActive);
          t.classList.toggle("text-white", isActive);
        });

        const panels = [
          "predTargets",
          "predMatrix",
          "predEmbedding",
          "predTable",
        ];
        panels.forEach((p) => $(`#${p}`).classList.add("hidden"));
        $("#predEmpty").classList.toggle("hidden", !!state.predictions);

        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const nT = predictions[0]?.length || 0;

        if (state.currentPredTab === "targets") {
          $("#predTargets").classList.remove("hidden");
          const select = $("#targetSelect");
          if (select.options.length !== nT) {
            select.innerHTML = Array(nT).fill(0).map((_, i) =>
              `<option value="${i}">Target ${i}</option>`
            ).join("");
            select.value = state.selectedTarget;
          }
          select.onchange = () => {
            state.selectedTarget = parseInt(select.value);
            renderPredictions();
          };
          $("#showBands").onchange = () => renderPredictions();

          const targetIdx = state.selectedTarget;
          const showBands = $("#showBands").checked;
          const data = predictions.map((p, i) => ({
            step: i + 1,
            pred: p[targetIdx],
            lower: lowerBounds[i][targetIdx],
            upper: upperBounds[i][targetIdx],
          }));
          renderLineChart("#chartTargets", data, showBands);
        } else if (state.currentPredTab === "matrix") {
          $("#predMatrix").classList.remove("hidden");
          renderHeatmap(predictions);
        } else if (state.currentPredTab === "embedding") {
          $("#predEmbedding").classList.remove("hidden");
          renderEmbedding(predictions);
        } else if (state.currentPredTab === "table") {
          $("#predTable").classList.remove("hidden");
          const table = $("#predTableContent");
          table.querySelector("thead tr").innerHTML =
            '<th class="px-3 py-2 text-left">Step</th>' +
            Array(nT).fill(0).map((_, i) =>
              `<th class="px-3 py-2">T${i} Pred</th><th class="px-3 py-2">T${i} CI</th>`
            ).join("");
          table.querySelector("tbody").innerHTML = predictions.map((
            p,
            i,
          ) =>
            `<tr class="border-b border-surface-200 dark:border-surface-700 hover:bg-surface-50 dark:hover:bg-surface-800"><td class="px-3 py-2 font-medium">${
              i + 1
            }</td>${
              p.map((v, j) =>
                `<td class="px-3 py-2">${
                  v.toFixed(4)
                }</td><td class="px-3 py-2 text-xs text-surface-500">[${
                  lowerBounds[i][j].toFixed(2)
                }, ${upperBounds[i][j].toFixed(2)}]</td>`
              ).join("")
            }</tr>`
          ).join("");
        }
      }

      function renderLineChart(selector, data, showBands) {
        const container = $(selector);
        const rect = container.getBoundingClientRect();
        const W = rect.width || 600, H = rect.height || 300;
        const margin = { top: 20, right: 20, bottom: 40, left: 50 };
        const w = W - margin.left - margin.right,
          h = H - margin.top - margin.bottom;

        const xMin = 1, xMax = data.length;
        const yVals = data.flatMap((d) =>
          showBands ? [d.pred, d.lower, d.upper] : [d.pred]
        );
        const yMin = Math.min(...yVals), yMax = Math.max(...yVals);
        const yPad = (yMax - yMin) * 0.1 || 1;
        const yScale = (v) =>
          margin.top + h -
          (v - (yMin - yPad)) / ((yMax + yPad) - (yMin - yPad)) * h;
        const xScale = (v) =>
          margin.left + (v - xMin) / (xMax - xMin) * w;

        let svg =
          `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" class="overflow-visible">`;
        svg +=
          `<defs><linearGradient id="bandGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgb(14,165,233)" stop-opacity="0.2"/><stop offset="100%" stop-color="rgb(14,165,233)" stop-opacity="0.05"/></linearGradient></defs>`;

        // Grid
        for (let i = 0; i <= 5; i++) {
          const y = margin.top + (h / 5) * i;
          const val = yMax + yPad -
            ((yMax + yPad) - (yMin - yPad)) * (i / 5);
          svg += `<line x1="${margin.left}" y1="${y}" x2="${
            W - margin.right
          }" y2="${y}" stroke="currentColor" stroke-opacity="0.1"/>`;
          svg += `<text x="${margin.left - 8}" y="${
            y + 4
          }" text-anchor="end" class="fill-current text-surface-400" font-size="10">${
            val.toFixed(2)
          }</text>`;
        }
        for (
          let i = 0;
          i <= data.length;
          i += Math.ceil(data.length / 5)
        ) {
          const x = xScale(i + 1);
          svg += `<line x1="${x}" y1="${margin.top}" x2="${x}" y2="${
            H - margin.bottom
          }" stroke="currentColor" stroke-opacity="0.1"/>`;
          svg += `<text x="${x}" y="${
            H - margin.bottom + 16
          }" text-anchor="middle" class="fill-current text-surface-400" font-size="10">${
            i + 1
          }</text>`;
        }

        // Bands
        if (showBands) {
          let bandPath = `M${xScale(1)},${yScale(data[0].upper)}`;
          data.forEach((d, i) =>
            bandPath += `L${xScale(i + 1)},${yScale(d.upper)}`
          );
          for (let i = data.length - 1; i >= 0; i--) {
            bandPath += `L${xScale(i + 1)},${yScale(data[i].lower)}`;
          }
          bandPath += "Z";
          svg += `<path d="${bandPath}" fill="url(#bandGrad)"/>`;
        }

        // Line
        let linePath = `M${xScale(1)},${yScale(data[0].pred)}`;
        data.forEach((d, i) =>
          linePath += `L${xScale(i + 1)},${yScale(d.pred)}`
        );
        svg +=
          `<path d="${linePath}" fill="none" stroke="rgb(14,165,233)" stroke-width="2"/>`;

        // Points
        data.forEach((d, i) => {
          svg += `<circle cx="${xScale(i + 1)}" cy="${
            yScale(d.pred)
          }" r="4" fill="rgb(14,165,233)" class="cursor-pointer hover:r-6"><title>Step ${
            i + 1
          }: ${d.pred.toFixed(4)}</title></circle>`;
        });

        // Labels
        svg += `<text x="${W / 2}" y="${
          H - 5
        }" text-anchor="middle" class="fill-current text-surface-500" font-size="12">Step</text>`;
        svg += `<text x="12" y="${
          H / 2
        }" text-anchor="middle" transform="rotate(-90, 12, ${
          H / 2
        })" class="fill-current text-surface-500" font-size="12">Value</text>`;

        svg += "</svg>";
        container.innerHTML = svg;
      }

      function renderHeatmap(predictions) {
        const canvas = $("#heatmapCanvas");
        const ctx = canvas.getContext("2d");
        const steps = predictions.length,
          targets = predictions[0]?.length || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = 300;

        const vals = predictions.flat();
        const min = Math.min(...vals), max = Math.max(...vals);
        const range = max - min || 1;

        const cellW = canvas.width / targets;
        const cellH = canvas.height / steps;

        for (let s = 0; s < steps; s++) {
          for (let t = 0; t < targets; t++) {
            const v = (predictions[s][t] - min) / range;
            const r = Math.round(59 + v * 196);
            const g = Math.round(130 - v * 80);
            const b = Math.round(246 - v * 180);
            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(t * cellW, s * cellH, cellW - 1, cellH - 1);
          }
        }

        $("#heatmapLegend").innerHTML =
          `<span class="text-surface-500">Min: ${
            min.toFixed(2)
          }</span><div class="w-24 h-3 rounded" style="background: linear-gradient(to right, rgb(59,130,246), rgb(255,50,66))"></div><span class="text-surface-500">Max: ${
            max.toFixed(2)
          }</span>`;
      }

      function renderEmbedding(predictions) {
        const container = $("#chartEmbedding");
        if (predictions[0]?.length < 2) {
          container.innerHTML =
            '<div class="h-full flex items-center justify-center text-surface-400">Need at least 2 targets for embedding</div>';
          return;
        }

        // Simple 2D projection: center data, pick first 2 components via power iteration
        const n = predictions.length, d = predictions[0].length;
        const mean = Array(d).fill(0);
        predictions.forEach((p) =>
          p.forEach((v, i) => mean[i] += v / n)
        );
        const centered = predictions.map((p) =>
          p.map((v, i) => v - mean[i])
        );

        // Covariance approximation & power iteration for PC1
        let pc1 = Array(d).fill(0).map(() => Math.random() - 0.5);
        for (let iter = 0; iter < 50; iter++) {
          const newPc = Array(d).fill(0);
          centered.forEach((row) => {
            const dot = row.reduce((a, v, i) => a + v * pc1[i], 0);
            row.forEach((v, i) => newPc[i] += v * dot);
          });
          const norm = Math.sqrt(newPc.reduce((a, v) =>
            a + v * v, 0)) || 1;
          pc1 = newPc.map((v) => v / norm);
        }

        // PC2: orthogonal
        let pc2 = Array(d).fill(0).map(() => Math.random() - 0.5);
        const dot12 = pc2.reduce((a, v, i) => a + v * pc1[i], 0);
        pc2 = pc2.map((v, i) => v - dot12 * pc1[i]);
        for (let iter = 0; iter < 50; iter++) {
          const newPc = Array(d).fill(0);
          centered.forEach((row) => {
            const dot = row.reduce((a, v, i) => a + v * pc2[i], 0);
            row.forEach((v, i) => newPc[i] += v * dot);
          });
          const dot12 = newPc.reduce((a, v, i) => a + v * pc1[i], 0);
          const orth = newPc.map((v, i) => v - dot12 * pc1[i]);
          const norm = Math.sqrt(orth.reduce((a, v) => a + v * v, 0)) ||
            1;
          pc2 = orth.map((v) => v / norm);
        }

        const proj = centered.map(
          (row) => [
            row.reduce((a, v, i) => a + v * pc1[i], 0),
            row.reduce((a, v, i) => a + v * pc2[i], 0),
          ],
        );
        const x1 = proj.map((p) => p[0]), x2 = proj.map((p) => p[1]);
        const xMin = Math.min(...x1), xMax = Math.max(...x1);
        const yMin = Math.min(...x2), yMax = Math.max(...x2);

        const rect = container.getBoundingClientRect();
        const W = rect.width || 600, H = rect.height || 300;
        const margin = 40;

        const xScale = (v) =>
          margin + (v - xMin) / ((xMax - xMin) || 1) * (W - 2 * margin);
        const yScale = (v) =>
          H - margin -
          (v - yMin) / ((yMax - yMin) || 1) * (H - 2 * margin);

        let svg =
          `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">`;
        svg += `<line x1="${margin}" y1="${H - margin}" x2="${
          W - margin
        }" y2="${
          H - margin
        }" stroke="currentColor" stroke-opacity="0.2"/>`;
        svg +=
          `<line x1="${margin}" y1="${margin}" x2="${margin}" y2="${
            H - margin
          }" stroke="currentColor" stroke-opacity="0.2"/>`;
        svg += `<text x="${W / 2}" y="${
          H - 10
        }" text-anchor="middle" class="fill-current text-surface-400" font-size="10">PC1</text>`;
        svg += `<text x="15" y="${
          H / 2
        }" text-anchor="middle" transform="rotate(-90, 15, ${
          H / 2
        })" class="fill-current text-surface-400" font-size="10">PC2</text>`;

        // Path
        let path = `M${xScale(proj[0][0])},${yScale(proj[0][1])}`;
        proj.forEach((p, i) => {
          if (i > 0) path += `L${xScale(p[0])},${yScale(p[1])}`;
        });
        svg +=
          `<path d="${path}" fill="none" stroke="rgb(168,85,247)" stroke-width="1.5" stroke-opacity="0.6"/>`;

        // Points
        proj.forEach((p, i) => {
          const color = `hsl(${
            270 - (i / proj.length) * 60
          }, 70%, 60%)`;
          svg += `<circle cx="${xScale(p[0])}" cy="${
            yScale(p[1])
          }" r="5" fill="${color}"><title>Step ${
            i + 1
          }</title></circle>`;
        });

        svg += "</svg>";
        container.innerHTML = svg;
      }

      function renderInsights() {
        // Residual trend (mock with fit result history - for demo, show last predictions variance)
        const residualContainer = $("#chartResidual");
        const uncertaintyContainer = $("#chartUncertainty");

        if (!state.predictions || !state.lastFitResult) {
          residualContainer.innerHTML =
            '<div class="h-full flex items-center justify-center text-surface-400 text-sm">No data yet</div>';
          uncertaintyContainer.innerHTML =
            '<div class="h-full flex items-center justify-center text-surface-400 text-sm">No data yet</div>';
          return;
        }

        // Simple sparkline of prediction magnitudes
        const preds = state.predictions.predictions;
        const avgPerStep = preds.map((p) =>
          p.reduce((a, b) => a + Math.abs(b), 0) / p.length
        );
        renderSparkline(
          residualContainer,
          avgPerStep,
          "rgb(34,197,94)",
        );

        // Uncertainty width per step
        const widths = state.predictions.upperBounds.map((u, i) =>
          u.reduce(
            (a, v, j) => a + (v - state.predictions.lowerBounds[i][j]),
            0,
          ) / u.length
        );
        renderSparkline(
          uncertaintyContainer,
          widths,
          "rgb(251,146,60)",
        );
      }

      function renderSparkline(container, data, color) {
        if (!data.length) return;
        const rect = container.getBoundingClientRect();
        const W = rect.width || 200, H = rect.height || 100;
        const min = Math.min(...data), max = Math.max(...data);
        const range = max - min || 1;
        const xScale = (i) => (i / (data.length - 1)) * W;
        const yScale = (v) => H - 10 - ((v - min) / range) * (H - 20);

        let path = `M0,${yScale(data[0])}`;
        data.forEach((v, i) => path += `L${xScale(i)},${yScale(v)}`);

        const svg =
          `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
        <path d="${path}L${W},${H}L0,${H}Z" fill="${color}" fill-opacity="0.1"/>
        <path d="${path}" fill="none" stroke="${color}" stroke-width="2"/>
    </svg>`;
        container.innerHTML = svg;
      }

      // CSS classes
      const style = document.createElement("style");
      style.textContent = `
    .card { background: white; border-radius: 0.75rem; border: 1px solid rgb(228,228,231); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .dark .card { background: rgb(39,39,42); border-color: rgb(63,63,70); }
    .input { padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgb(212,212,216); background: white; font-size: 0.875rem; transition: all 0.15s; }
    .input:focus { outline: none; border-color: rgb(14,165,233); box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }
    .dark .input { background: rgb(39,39,42); border-color: rgb(63,63,70); color: white; }
    .btn-primary { padding: 0.5rem 1rem; border-radius: 0.5rem; background: rgb(14,165,233); color: white; font-weight: 500; font-size: 0.875rem; transition: all 0.15s; }
    .btn-primary:hover { background: rgb(2,132,199); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { padding: 0.5rem 1rem; border-radius: 0.5rem; background: rgb(244,244,245); color: rgb(63,63,70); font-weight: 500; font-size: 0.875rem; transition: all 0.15s; }
    .btn-secondary:hover { background: rgb(228,228,231); }
    .dark .btn-secondary { background: rgb(63,63,70); color: rgb(228,228,231); }
    .dark .btn-secondary:hover { background: rgb(82,82,91); }
`;
      document.head.appendChild(style);

      // Initial render
      renderUI();
      log("ESN Regression Studio loaded", "info");
    </script>
  </body>
</html>
