<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="h-full text-slate-900">
    <!-- Toasts -->
    <div
      id="toastHost"
      class="fixed bottom-4 left-0 right-0 z-[80] px-4 flex flex-col gap-2 items-center pointer-events-none"
      aria-live="polite"
    >
    </div>

    <!-- Slide-out Menu Backdrop -->
    <div
      id="menuBackdrop"
      class="hidden fixed inset-0 bg-slate-900/40 z-[60]"
      aria-hidden="true"
    >
    </div>

    <!-- Slide-out Menu -->
    <aside
      id="menuPanel"
      class="fixed top-0 right-0 h-full w-[88%] max-w-sm bg-white shadow-2xl z-[70] translate-x-full transition-transform duration-200"
      aria-label="Slide out menu"
    >
      <div
        class="p-5 border-b border-slate-200 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg shadow-blue-500/20 grid place-items-center text-white"
          >
            ‚ò∞
          </div>
          <div>
            <div class="font-extrabold tracking-tight">Studio Menu</div>
            <div class="text-xs text-slate-500">Tools & workflows</div>
          </div>
        </div>
        <button
          id="menuCloseBtn"
          class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200"
          aria-label="Close menu"
        >
          ‚úñÔ∏è
        </button>
      </div>

      <div class="p-5 space-y-3 overflow-y-auto h-[calc(100%-80px)]">
        <div class="text-xs font-bold tracking-widest text-slate-500 uppercase">
          üìÅ Model
        </div>

        <button
          id="menuCreateConfigure"
          class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Create and configure model"
        >
          <div class="flex items-start gap-3">
            <div
              class="h-10 w-10 rounded-xl bg-blue-50 text-blue-700 grid place-items-center text-lg"
            >
              üéõÔ∏è
            </div>
            <div>
              <div class="font-bold">Create & Configure</div>
              <div class="text-sm text-slate-600">Set up model parameters</div>
            </div>
          </div>
        </button>

        <button
          id="menuSaveLoad"
          class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          aria-label="Save and load models"
        >
          <div class="flex items-start gap-3">
            <div
              class="h-10 w-10 rounded-xl bg-emerald-50 text-emerald-700 grid place-items-center text-lg"
            >
              üíæ
            </div>
            <div>
              <div class="font-bold">Save & Load</div>
              <div class="text-sm text-slate-600">Persist your models</div>
            </div>
          </div>
        </button>

        <div
          class="pt-2 text-xs font-bold tracking-widest text-slate-500 uppercase"
        >
          üìÇ Data
        </div>

        <button
          id="menuUploadDataset"
          class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-purple-500"
          aria-label="Upload dataset"
        >
          <div class="flex items-start gap-3">
            <div
              class="h-10 w-10 rounded-xl bg-purple-50 text-purple-700 grid place-items-center text-lg"
            >
              üì§
            </div>
            <div>
              <div class="font-bold">Upload Dataset</div>
              <div class="text-sm text-slate-600">Import time series data</div>
            </div>
          </div>
        </button>

        <div
          class="pt-2 text-xs font-bold tracking-widest text-slate-500 uppercase"
        >
          üß™ Test
        </div>

        <button
          id="menuRandomTest"
          class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-pink-500"
          aria-label="Random test"
        >
          <div class="flex items-start gap-3">
            <div
              class="h-10 w-10 rounded-xl bg-pink-50 text-pink-700 grid place-items-center text-lg"
            >
              üí°
            </div>
            <div>
              <div class="font-bold">Random Test</div>
              <div class="text-sm text-slate-600">
                Generate synthetic time series
              </div>
            </div>
          </div>
        </button>

        <div
          class="pt-2 text-xs font-bold tracking-widest text-slate-500 uppercase"
        >
          ‚öôÔ∏è Advanced
        </div>

        <button
          id="menuDataTable"
          class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-500"
          aria-label="View data table"
        >
          <div class="flex items-start gap-3">
            <div
              class="h-10 w-10 rounded-xl bg-slate-100 text-slate-700 grid place-items-center text-lg"
            >
              üìã
            </div>
            <div>
              <div class="font-bold">View Data Table</div>
              <div class="text-sm text-slate-600">Raw prediction values</div>
            </div>
          </div>
        </button>
      </div>
    </aside>

    <!-- Header -->
    <header
      class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-slate-200/60"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3"
      >
        <div class="flex items-center gap-3 min-w-0">
          <div
            class="h-11 w-11 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg shadow-blue-500/30 grid place-items-center text-white text-xl"
          >
            üìä
          </div>
          <div class="min-w-0">
            <div class="font-extrabold tracking-tight leading-5">
              ESN Studio
            </div>
            <div class="text-xs text-slate-500 truncate">
              Autoregressive Forecasting
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div
            id="modelBadge"
            class="px-3 py-2 rounded-2xl bg-white border border-slate-200 shadow-sm flex items-center gap-2"
            aria-label="Model status"
          >
            <span
              id="modelDot"
              class="inline-block h-2.5 w-2.5 rounded-full bg-slate-400"
            ></span>
            <span
              id="modelStatusText"
              class="text-sm font-semibold text-slate-700"
            >No Model</span>
          </div>

          <button
            id="predictBtn"
            class="hidden px-3 py-2 rounded-2xl text-white font-bold bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:brightness-105 focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-label="Predict"
          >
            ‚ö° <span class="hidden sm:inline">Predict</span>
          </button>

          <button
            id="configBtn"
            class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400"
            aria-label="Configure"
          >
            ‚öôÔ∏è
          </button>

          <button
            id="menuBtn"
            class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400"
            aria-label="Open menu"
          >
            ‚ò∞
          </button>
        </div>
      </div>
    </header>

    <!-- Loading overlay -->
    <div
      id="loadingOverlay"
      class="hidden fixed inset-0 z-[75] bg-white/60 backdrop-blur-sm"
    >
      <div class="max-w-md mx-auto mt-28 px-4">
        <div
          class="bg-white rounded-3xl shadow-2xl border border-slate-200 p-5"
        >
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold tracking-tight">Processing‚Ä¶</div>
              <div id="loadingText" class="text-sm text-slate-600">
                Working on your request
              </div>
            </div>
            <div
              class="h-10 w-10 rounded-2xl border-4 border-slate-200 border-t-blue-500 animate-spin"
              aria-label="Loading spinner"
            >
            </div>
          </div>

          <div class="mt-4">
            <div
              class="flex items-center justify-between text-xs text-slate-600"
            >
              <span>Progress</span>
              <span id="loadingPct" class="font-bold">0%</span>
            </div>
            <div
              class="mt-2 h-3 rounded-full bg-slate-100 overflow-hidden border border-slate-200"
            >
              <div
                id="loadingBar"
                class="h-full w-0 bg-gradient-to-r from-blue-500 to-indigo-500"
              >
              </div>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button
              id="cancelOpBtn"
              class="px-4 py-2 rounded-2xl bg-red-600 text-white font-bold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
              aria-label="Cancel operation"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex flex-col lg:flex-row gap-4">
        <!-- Visualization column -->
        <section class="flex-1 min-w-0">
          <!-- Tabs -->
          <div
            class="flex gap-2 overflow-x-auto pb-2"
            aria-label="Visualization mode tabs"
          >
            <button
              data-tab="grid"
              id="tabGrid"
              class="shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
              aria-label="Small multiples grid view"
            >
              üìä Grid
            </button>
            <button
              data-tab="focus"
              id="tabFocus"
              class="shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-slate-100 text-slate-800 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400"
              aria-label="Focus view"
            >
              üîç Focus
            </button>
          </div>

          <!-- Focus: dimension selector -->
          <div id="dimSelectorWrap" class="hidden mt-2">
            <div
              class="flex gap-2 overflow-x-auto py-1"
              id="dimSelector"
              aria-label="Dimension selector"
            >
            </div>
          </div>

          <!-- Stats bar (focus mode) -->
          <div
            id="statsBar"
            class="hidden mt-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2"
            aria-label="Statistics bar"
          >
          </div>

          <!-- Chart card -->
          <div
            class="mt-3 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden relative"
          >
            <!-- Export + floating controls -->
            <div class="absolute top-3 right-3 z-10 flex flex-col gap-2">
              <div
                id="zoomControls"
                class="hidden bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-lg p-2 flex flex-col gap-2"
              >
                <button
                  id="zoomInBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold"
                  aria-label="Zoom in"
                >
                  ‚ûï
                </button>
                <button
                  id="zoomOutBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold"
                  aria-label="Zoom out"
                >
                  ‚ûñ
                </button>
                <button
                  id="zoomResetBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold"
                  aria-label="Reset zoom"
                >
                  üîÑ
                </button>
              </div>

              <div
                id="exportControls"
                class="hidden bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-lg p-2 flex flex-col gap-2"
              >
                <button
                  id="savePngBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold text-left"
                  aria-label="Save as PNG"
                >
                  üñºÔ∏è PNG
                </button>
                <button
                  id="saveSvgBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold text-left"
                  aria-label="Save as SVG"
                >
                  üìÑ SVG
                </button>
                <button
                  id="copyBtn"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold text-left"
                  aria-label="Copy to clipboard"
                >
                  üìã Copy
                </button>
              </div>
            </div>

            <div class="absolute top-3 left-3 z-10">
              <div
                id="zoomBadge"
                class="hidden px-3 py-1.5 rounded-2xl bg-white/90 backdrop-blur border border-slate-200 shadow text-xs font-extrabold"
                aria-label="Zoom level"
              >
                100%
              </div>
            </div>

            <div id="emptyState" class="p-10 sm:p-14">
              <div class="max-w-md mx-auto text-center">
                <div class="relative">
                  <div
                    class="absolute inset-0 blur-2xl bg-gradient-to-br from-blue-200 via-indigo-200 to-purple-200 rounded-3xl opacity-60"
                  >
                  </div>
                  <div
                    class="relative bg-white/80 border border-slate-200 rounded-3xl p-8 shadow-xl"
                  >
                    <div class="text-5xl">üìä</div>
                    <div class="mt-3 text-2xl font-extrabold tracking-tight">
                      Create a Model to Begin
                    </div>
                    <div class="mt-2 text-sm text-slate-600">
                      ESN Regression Studio performs multivariate online
                      learning and autoregressive forecasting with confidence
                      intervals.
                    </div>
                    <div
                      class="mt-6 flex flex-col sm:flex-row gap-2 justify-center"
                    >
                      <button
                        id="startDefaultsBtn"
                        class="px-5 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:brightness-105 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        aria-label="Start with defaults"
                      >
                        ‚ö° Start with Defaults
                      </button>
                      <button
                        id="loadBtnEmpty"
                        class="px-5 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold focus:outline-none focus:ring-2 focus:ring-slate-400"
                        aria-label="Load model"
                      >
                        üì§ Load
                      </button>
                      <button
                        id="demoBtn"
                        class="px-5 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg shadow-purple-500/20 hover:brightness-105 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        aria-label="Run demo"
                      >
                        ‚ú® Demo
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="canvasWrap" class="hidden relative">
              <canvas
                id="chartCanvas"
                class="w-full h-[58vh] sm:h-[62vh] touch-none"
                aria-label="Prediction chart canvas"
              ></canvas>

              <!-- Tooltip -->
              <div
                id="tooltip"
                class="hidden absolute z-20 pointer-events-none max-w-[90vw] bg-slate-900 text-white rounded-2xl shadow-2xl px-4 py-3 border border-white/10"
                role="status"
                aria-label="Chart tooltip"
              >
                <div class="text-xs uppercase tracking-widest text-slate-300">
                  Step
                </div>
                <div id="ttStep" class="text-lg font-extrabold leading-6">
                  ‚Äî
                </div>
                <div class="mt-2 flex items-center gap-2">
                  <span
                    id="ttColor"
                    class="inline-block h-2.5 w-2.5 rounded-full bg-blue-400"
                  ></span>
                  <div id="ttDim" class="text-sm font-bold">D1</div>
                </div>
                <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-xs text-slate-300">Pred</div>
                    <div id="ttPred" class="font-extrabold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-xs text-slate-300">Spread</div>
                    <div id="ttSpread" class="font-extrabold">‚Äî</div>
                  </div>
                  <div class="col-span-2">
                    <div class="text-xs text-slate-300">CI</div>
                    <div id="ttCI" class="font-bold">‚Äî</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Side panel -->
        <aside class="lg:w-[360px] shrink-0">
          <div
            class="bg-white rounded-2xl shadow-xl border border-slate-200 p-4"
          >
            <div class="flex items-center justify-between">
              <div>
                <div
                  class="text-xs font-bold tracking-widest text-slate-500 uppercase"
                >
                  Model Metrics
                </div>
                <div class="mt-1 font-extrabold tracking-tight">
                  Training Telemetry
                </div>
              </div>
              <button
                id="summaryBtn"
                class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold focus:outline-none focus:ring-2 focus:ring-slate-400"
                aria-label="Get model summary"
              >
                üßæ
              </button>
            </div>

            <div class="mt-4 space-y-2">
              <div
                class="flex items-center justify-between p-3 rounded-2xl bg-blue-50 border border-blue-100"
              >
                <div class="text-sm font-bold">Samples Trained</div>
                <div id="mSamples" class="font-extrabold tabular-nums">0</div>
              </div>
              <div
                class="flex items-center justify-between p-3 rounded-2xl bg-white border border-slate-200"
              >
                <div class="text-sm font-bold text-slate-700">Avg Loss</div>
                <div id="mLoss" class="font-extrabold tabular-nums">‚Äî</div>
              </div>
              <div
                class="flex items-center justify-between p-3 rounded-2xl bg-white border border-slate-200"
              >
                <div class="text-sm font-bold text-slate-700">
                  Gradient Norm
                </div>
                <div id="mGrad" class="font-extrabold tabular-nums">‚Äî</div>
              </div>
              <div
                class="flex items-center justify-between p-3 rounded-2xl bg-white border border-slate-200"
              >
                <div class="text-sm font-bold text-slate-700">
                  Sample Weight
                </div>
                <div id="mWeight" class="font-extrabold tabular-nums">‚Äî</div>
              </div>
            </div>

            <div class="mt-6 border-t border-slate-200 pt-5">
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                Prediction
              </div>

              <label class="block mt-3 text-sm font-bold" for="futureStepsInput"
              >Future Steps</label>
              <input
                id="futureStepsInput"
                type="number"
                min="1"
                value="50"
                class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Future steps"
              />

              <button
                id="runPredictBtn"
                class="mt-3 w-full px-5 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:brightness-105 disabled:opacity-40 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Run prediction"
              >
                ‚ö° Run Prediction
              </button>
            </div>

            <div class="mt-6 border-t border-slate-200 pt-5">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div
                    class="text-xs font-bold tracking-widest text-slate-500 uppercase"
                  >
                    Event Log
                  </div>
                  <div class="mt-1 font-extrabold tracking-tight">
                    Studio Activity
                  </div>
                </div>
                <button
                  id="clearLogBtn"
                  class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold focus:outline-none focus:ring-2 focus:ring-slate-400"
                  aria-label="Clear log"
                >
                  üßπ
                </button>
              </div>

              <div class="mt-3 flex gap-2">
                <label class="sr-only" for="logFilter">Filter</label>
                <select
                  id="logFilter"
                  class="w-32 px-3 py-2 rounded-2xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-400"
                  aria-label="Log filter"
                >
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>

                <label class="sr-only" for="logSearch">Search</label>
                <input
                  id="logSearch"
                  type="text"
                  placeholder="Search‚Ä¶"
                  class="flex-1 px-3 py-2 rounded-2xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-slate-400"
                  aria-label="Search log"
                />
              </div>

              <div
                id="logList"
                class="mt-3 h-56 overflow-y-auto rounded-2xl border border-slate-200 bg-slate-50"
                aria-label="Event log list"
              >
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- MODALS -->
    <!-- Modal Backdrop -->
    <div
      id="modalBackdrop"
      class="hidden fixed inset-0 bg-slate-900/40 z-[90]"
      aria-hidden="true"
    >
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-[95] overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-label="Configuration modal"
    >
      <div class="min-h-full flex items-end sm:items-center justify-center p-4">
        <div
          class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden"
        >
          <div
            class="p-5 border-b border-slate-200 flex items-start justify-between gap-3"
          >
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                ‚öôÔ∏è Configuration
              </div>
              <div class="mt-1 text-xl font-extrabold tracking-tight">
                ESN Regression Parameters
              </div>
              <div class="mt-1 text-sm text-slate-600">
                Tune the reservoir, training, normalization, and uncertainty
                controls.
              </div>
            </div>
            <button
              class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200"
              id="configCloseX"
              aria-label="Close configuration"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div class="p-5 space-y-5">
            <!-- Presets -->
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                Presets
              </div>
              <div
                class="mt-3 flex gap-2 overflow-x-auto pb-1"
                aria-label="Preset bar"
              >
                <button
                  data-preset="default"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-extrabold bg-blue-600 text-white"
                  aria-label="Start here preset"
                >
                  Start Here
                </button>
                <button
                  data-preset="fast"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200"
                  aria-label="Fast preset"
                >
                  Fast
                </button>
                <button
                  data-preset="balanced"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200"
                  aria-label="Balanced preset"
                >
                  Balanced
                </button>
                <button
                  data-preset="accurate"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200"
                  aria-label="Accurate preset"
                >
                  Accurate
                </button>
                <button
                  data-preset="adaptive"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200"
                  aria-label="Adaptive preset"
                >
                  Adaptive
                </button>
                <button
                  data-preset="robust"
                  class="presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200"
                  aria-label="Robust preset"
                >
                  Robust
                </button>
              </div>
            </div>

            <!-- Collapsible sections -->
            <div class="space-y-3">
              <!-- Reservoir -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="reservoir"
                  aria-label="Toggle reservoir architecture section"
                >
                  <span>Reservoir Architecture</span><span id="chevReservoir"
                  >‚ñº</span>
                </button>
                <div id="sectionReservoir" class="p-4 space-y-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm font-bold" for="reservoirSize"
                      >reservoirSize</label>
                      <div class="text-xs text-slate-500">
                        Neurons in reservoir
                      </div>
                      <input
                        id="reservoirSize"
                        type="number"
                        min="1"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Reservoir size"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="reservoirSize"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="spectralRadius"
                      >spectralRadius</label>
                      <div class="text-xs text-slate-500">
                        Memory length control
                      </div>
                      <input
                        id="spectralRadius"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Spectral radius"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="spectralRadius"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="leakRate"
                      >leakRate</label>
                      <div class="text-xs text-slate-500">
                        Temporal smoothing
                      </div>
                      <input
                        id="leakRate"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Leak rate"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="leakRate"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="inputScale"
                      >inputScale</label>
                      <div class="text-xs text-slate-500">
                        Input scaling factor
                      </div>
                      <input
                        id="inputScale"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Input scale"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="inputScale"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="biasScale"
                      >biasScale</label>
                      <div class="text-xs text-slate-500">Bias scaling</div>
                      <input
                        id="biasScale"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Bias scale"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="biasScale"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="reservoirSparsity"
                      >reservoirSparsity</label>
                      <div class="text-xs text-slate-500">Zero connections</div>
                      <input
                        id="reservoirSparsity"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Reservoir sparsity"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="reservoirSparsity"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="inputSparsity"
                      >inputSparsity</label>
                      <div class="text-xs text-slate-500">Input sparsity</div>
                      <input
                        id="inputSparsity"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Input sparsity"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="inputSparsity"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="activation"
                      >activation</label>
                      <div class="text-xs text-slate-500">
                        Activation function
                      </div>
                      <select
                        id="activation"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white"
                        aria-label="Activation"
                      >
                        <option value="tanh">tanh</option>
                        <option value="relu">relu</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Readout -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="readout"
                  aria-label="Toggle readout section"
                >
                  <span>Readout Configuration</span><span id="chevReadout"
                  >‚ñº</span>
                </button>
                <div id="sectionReadout" class="p-4 space-y-3">
                  <div
                    class="flex items-center justify-between p-3 rounded-2xl border border-slate-200 bg-white"
                  >
                    <div>
                      <div class="font-bold">useInputInReadout</div>
                      <div class="text-xs text-slate-500">
                        Append input to state
                      </div>
                    </div>
                    <button
                      id="useInputInReadout"
                      class="toggleBtn px-3 py-2 rounded-2xl bg-emerald-600 text-white font-bold"
                      aria-label="Toggle use input in readout"
                    >
                      true
                    </button>
                  </div>
                  <div
                    class="flex items-center justify-between p-3 rounded-2xl border border-slate-200 bg-white"
                  >
                    <div>
                      <div class="font-bold">useBiasInReadout</div>
                      <div class="text-xs text-slate-500">
                        Include bias term
                      </div>
                    </div>
                    <button
                      id="useBiasInReadout"
                      class="toggleBtn px-3 py-2 rounded-2xl bg-emerald-600 text-white font-bold"
                      aria-label="Toggle use bias in readout"
                    >
                      true
                    </button>
                  </div>
                </div>
              </div>

              <!-- Training -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="training"
                  aria-label="Toggle training section"
                >
                  <span>Training (RLS)</span><span id="chevTraining">‚ñº</span>
                </button>
                <div id="sectionTraining" class="p-4 space-y-3">
                  <div
                    class="p-3 rounded-2xl border border-slate-200 bg-slate-50"
                  >
                    <div class="text-sm font-bold">readoutTraining</div>
                    <div class="text-xs text-slate-500">RLS training</div>
                    <div
                      class="mt-2 px-3 py-2 rounded-2xl bg-white border border-slate-200 font-mono text-sm"
                    >
                      rls
                    </div>
                  </div>

                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm font-bold" for="rlsLambda"
                      >rlsLambda</label>
                      <div class="text-xs text-slate-500">
                        Forgetting factor
                      </div>
                      <input
                        id="rlsLambda"
                        type="number"
                        step="0.0001"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="RLS lambda"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="rlsLambda"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="rlsDelta"
                      >rlsDelta</label>
                      <div class="text-xs text-slate-500">
                        Initial P diagonal
                      </div>
                      <input
                        id="rlsDelta"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="RLS delta"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="rlsDelta"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="epsilon"
                      >epsilon</label>
                      <div class="text-xs text-slate-500">
                        Numerical stability
                      </div>
                      <input
                        id="epsilon"
                        type="number"
                        step="0.00000001"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Epsilon"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="epsilon"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="l2Lambda"
                      >l2Lambda</label>
                      <div class="text-xs text-slate-500">
                        L2 regularization
                      </div>
                      <input
                        id="l2Lambda"
                        type="number"
                        step="0.0001"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="L2 lambda"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="l2Lambda"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="gradientClipNorm"
                      >gradientClipNorm</label>
                      <div class="text-xs text-slate-500">Max update norm</div>
                      <input
                        id="gradientClipNorm"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Gradient clip norm"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="gradientClipNorm"
                      >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Normalization -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="norm"
                  aria-label="Toggle normalization section"
                >
                  <span>Normalization</span><span id="chevNorm">‚ñº</span>
                </button>
                <div id="sectionNorm" class="p-4 space-y-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label
                        class="text-sm font-bold"
                        for="normalizationEpsilon"
                      >normalizationEpsilon</label>
                      <div class="text-xs text-slate-500">
                        Stability constant
                      </div>
                      <input
                        id="normalizationEpsilon"
                        type="number"
                        step="0.00000001"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Normalization epsilon"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="normalizationEpsilon"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="normalizationWarmup"
                      >normalizationWarmup</label>
                      <div class="text-xs text-slate-500">Warmup samples</div>
                      <input
                        id="normalizationWarmup"
                        type="number"
                        min="0"
                        step="1"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Normalization warmup"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="normalizationWarmup"
                      >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Outliers -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="outliers"
                  aria-label="Toggle outlier section"
                >
                  <span>Outlier Handling</span><span id="chevOutliers">‚ñº</span>
                </button>
                <div id="sectionOutliers" class="p-4 space-y-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm font-bold" for="outlierThreshold"
                      >outlierThreshold</label>
                      <div class="text-xs text-slate-500">
                        Z-score threshold
                      </div>
                      <input
                        id="outlierThreshold"
                        type="number"
                        step="0.1"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Outlier threshold"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="outlierThreshold"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="outlierMinWeight"
                      >outlierMinWeight</label>
                      <div class="text-xs text-slate-500">
                        Outlier min weight
                      </div>
                      <input
                        id="outlierMinWeight"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Outlier min weight"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="outlierMinWeight"
                      >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Uncertainty -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="uncertainty"
                  aria-label="Toggle uncertainty section"
                >
                  <span>Uncertainty</span><span id="chevUnc">‚ñº</span>
                </button>
                <div id="sectionUncertainty" class="p-4 space-y-3">
                  <div>
                    <label class="text-sm font-bold" for="uncertaintyMultiplier"
                    >uncertaintyMultiplier</label>
                    <div class="text-xs text-slate-500">
                      CI Multiplier (1.96 = 95% CI)
                    </div>
                    <input
                      id="uncertaintyMultiplier"
                      type="number"
                      step="0.01"
                      class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                      aria-label="Uncertainty multiplier"
                    >
                    <div
                      class="mt-1 text-xs text-red-600 hidden"
                      data-err="uncertaintyMultiplier"
                    >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Initialization -->
              <div class="rounded-3xl border border-slate-200 overflow-hidden">
                <button
                  class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                  data-collapse="init"
                  aria-label="Toggle initialization section"
                >
                  <span>Initialization</span><span id="chevInit">‚ñº</span>
                </button>
                <div id="sectionInit" class="p-4 space-y-3">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm font-bold" for="weightInitScale"
                      >weightInitScale</label>
                      <div class="text-xs text-slate-500">
                        Initial weight scale
                      </div>
                      <input
                        id="weightInitScale"
                        type="number"
                        step="0.01"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Weight init scale"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="weightInitScale"
                      >
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-bold" for="seed">seed</label>
                      <div class="text-xs text-slate-500">Random seed</div>
                      <input
                        id="seed"
                        type="number"
                        step="1"
                        class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                        aria-label="Seed"
                      >
                      <div
                        class="mt-1 text-xs text-red-600 hidden"
                        data-err="seed"
                      >
                      </div>
                    </div>
                  </div>

                  <div
                    class="flex items-center justify-between p-3 rounded-2xl border border-slate-200 bg-white"
                  >
                    <div>
                      <div class="font-bold">verbose</div>
                      <div class="text-xs text-slate-500">Detailed logging</div>
                    </div>
                    <button
                      id="verbose"
                      class="toggleBtn px-3 py-2 rounded-2xl bg-slate-200 text-slate-900 font-bold"
                      aria-label="Toggle verbose"
                    >
                      false
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="p-5 border-t border-slate-200 flex flex-col sm:flex-row gap-2 justify-end"
          >
            <button
              id="resetDefaultsBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Reset defaults"
            >
              Reset Defaults
            </button>
            <button
              id="resetAllBtn"
              class="px-4 py-3 rounded-2xl bg-red-600 hover:bg-red-700 text-white font-extrabold"
              aria-label="Reset all"
            >
              Reset All
            </button>
            <button
              id="configCancelBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Cancel"
            >
              Cancel
            </button>
            <button
              id="createModelBtn"
              class="px-4 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:brightness-105"
              aria-label="Create model"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 z-[95] overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-label="Upload dataset modal"
    >
      <div class="min-h-full flex items-end sm:items-center justify-center p-4">
        <div
          class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden"
        >
          <div
            class="p-5 border-b border-slate-200 flex items-start justify-between gap-3"
          >
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                üì§ Upload Dataset
              </div>
              <div class="mt-1 text-xl font-extrabold tracking-tight">
                Import JSON Coordinates
              </div>
              <div class="mt-1 text-sm text-slate-600">
                Upload or paste a JSON file containing <span class="font-mono"
                >coordinates</span>.
              </div>
            </div>
            <button
              class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200"
              id="uploadCloseX"
              aria-label="Close upload"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div class="p-5 space-y-4">
            <div
              id="dropZone"
              class="p-6 rounded-3xl border-2 border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 cursor-pointer text-center"
              aria-label="Drop zone"
            >
              <div class="text-4xl">üìÅ</div>
              <div class="mt-2 font-extrabold">
                Drop JSON file here or tap to browse
              </div>
              <div class="mt-1 text-sm text-slate-600">
                Expected: <span class="font-mono"
                >{"coordinates":[[...],[...]]}</span>
              </div>
              <input
                id="fileInput"
                type="file"
                accept=".json,application/json"
                class="hidden"
                aria-label="File input"
              >
            </div>

            <div>
              <div class="flex items-center justify-between">
                <div class="font-extrabold">Paste JSON</div>
                <button
                  id="pasteClearBtn"
                  class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
                  aria-label="Clear pasted JSON"
                >
                  üßΩ Clear
                </button>
              </div>
              <textarea
                id="jsonTextarea"
                rows="7"
                class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                aria-label="Paste JSON"
              ></textarea>
            </div>

            <div class="rounded-3xl border border-slate-200 overflow-hidden">
              <button
                id="exampleToggle"
                class="w-full px-4 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 font-extrabold"
                aria-label="Toggle format example"
              >
                <span>Format Example</span><span id="exampleChev">‚ñº</span>
              </button>
              <div id="exampleBody" class="hidden p-4 space-y-2">
                <button
                  id="copyExampleBtn"
                  class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
                  aria-label="Copy example"
                >
                  Copy example
                </button>
                <pre
                  class="p-4 rounded-2xl bg-slate-900 text-slate-50 overflow-x-auto text-sm"
                >
<code id="exampleCode">{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
              </div>
            </div>

            <div
              id="validationBox"
              class="hidden p-4 rounded-3xl border"
              aria-label="Validation feedback"
            >
            </div>
          </div>

          <div
            class="p-5 border-t border-slate-200 flex flex-col sm:flex-row gap-2 justify-end"
          >
            <button
              id="uploadCancelBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Cancel upload"
            >
              Cancel
            </button>
            <button
              id="validateBtn"
              class="px-4 py-3 rounded-2xl bg-slate-900 hover:bg-black text-white font-extrabold"
              aria-label="Validate dataset"
            >
              Validate
            </button>
            <button
              id="applyTrainBtn"
              class="px-4 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-purple-600 to-indigo-600 shadow-lg shadow-purple-500/20 disabled:opacity-40 disabled:cursor-not-allowed"
              disabled
              aria-label="Apply and train"
            >
              Apply & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 z-[95] overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-label="Save and load modal"
    >
      <div class="min-h-full flex items-end sm:items-center justify-center p-4">
        <div
          class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden"
        >
          <div
            class="p-5 border-b border-slate-200 flex items-start justify-between gap-3"
          >
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                üíæ Save & Load
              </div>
              <div class="mt-1 text-xl font-extrabold tracking-tight">
                Persist Models
              </div>
              <div class="mt-1 text-sm text-slate-600">
                Download as JSON or store in your browser.
              </div>
            </div>
            <button
              class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200"
              id="saveLoadCloseX"
              aria-label="Close save load"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div class="p-5 space-y-6">
            <div class="rounded-3xl border border-slate-200 p-4">
              <div class="font-extrabold">üì• Download</div>
              <div class="mt-1 text-sm text-slate-600">
                Export your current model state as a JSON file.
              </div>
              <button
                id="downloadModelBtn"
                class="mt-3 px-4 py-3 rounded-2xl bg-slate-900 hover:bg-black text-white font-extrabold disabled:opacity-40 disabled:cursor-not-allowed"
                aria-label="Download model"
                disabled
              >
                Download JSON
              </button>
            </div>

            <div class="rounded-3xl border border-slate-200 p-4">
              <div class="font-extrabold">üíæ Browser</div>
              <div class="mt-1 text-sm text-slate-600">
                Save to localStorage under a name.
              </div>
              <button
                id="saveBrowserBtn"
                class="mt-3 px-4 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold disabled:opacity-40 disabled:cursor-not-allowed"
                aria-label="Save to browser"
                disabled
              >
                Save to Browser
              </button>
            </div>

            <div class="rounded-3xl border border-slate-200 p-4">
              <div class="font-extrabold">üì§ Load</div>
              <div class="mt-1 text-sm text-slate-600">
                Upload a model JSON or load from saved list.
              </div>

              <div
                id="loadZone"
                class="mt-3 p-4 rounded-3xl border-2 border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 cursor-pointer text-center"
                aria-label="Model upload zone"
              >
                <div class="text-3xl">üì§</div>
                <div class="mt-1 font-extrabold">Tap to upload model JSON</div>
                <input
                  id="modelFileInput"
                  type="file"
                  accept=".json,application/json"
                  class="hidden"
                  aria-label="Model file input"
                >
              </div>

              <div class="mt-4">
                <div
                  class="text-xs font-bold tracking-widest text-slate-500 uppercase"
                >
                  Saved Models
                </div>
                <div
                  id="savedModelsList"
                  class="mt-2 space-y-2"
                  aria-label="Saved models list"
                >
                </div>
              </div>
            </div>
          </div>

          <div class="p-5 border-t border-slate-200 flex justify-end">
            <button
              id="saveLoadCancelBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Close"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 z-[95] overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-label="Random test modal"
    >
      <div class="min-h-full flex items-end sm:items-center justify-center p-4">
        <div
          class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden"
        >
          <div
            class="p-5 border-b border-slate-200 flex items-start justify-between gap-3"
          >
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                üß™ Random Test
              </div>
              <div class="mt-1 text-xl font-extrabold tracking-tight">
                Synthetic Dataset
              </div>
              <div class="mt-1 text-sm text-slate-600">
                Generate time series, train online, then predict.
              </div>
            </div>
            <button
              class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200"
              id="randomCloseX"
              aria-label="Close random test"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div class="p-5 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-bold" for="randSeed">Seed</label>
                <input
                  id="randSeed"
                  type="number"
                  value="42"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                  aria-label="Random seed"
                >
              </div>
              <div>
                <label class="text-sm font-bold" for="randDims"
                >Dimensions</label>
                <input
                  id="randDims"
                  type="number"
                  min="1"
                  value="3"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                  aria-label="Random dimensions"
                >
              </div>
              <div>
                <label class="text-sm font-bold" for="randSteps"
                >Time Steps</label>
                <input
                  id="randSteps"
                  type="number"
                  min="10"
                  value="200"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                  aria-label="Random time steps"
                >
              </div>
              <div>
                <label class="text-sm font-bold" for="randNoise">Noise</label>
                <input
                  id="randNoise"
                  type="number"
                  step="0.01"
                  value="0.1"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                  aria-label="Random noise"
                >
              </div>
              <div>
                <label class="text-sm font-bold" for="randOutliers"
                >Outliers rate</label>
                <input
                  id="randOutliers"
                  type="number"
                  step="0.001"
                  value="0.02"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200"
                  aria-label="Random outliers rate"
                >
              </div>
              <div>
                <label class="text-sm font-bold" for="randDifficulty"
                >Difficulty</label>
                <select
                  id="randDifficulty"
                  class="mt-2 w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white"
                  aria-label="Random difficulty"
                >
                  <option>Easy</option>
                  <option selected>Medium</option>
                  <option>Hard</option>
                </select>
              </div>
            </div>
          </div>

          <div
            class="p-5 border-t border-slate-200 flex flex-col sm:flex-row gap-2 justify-end"
          >
            <button
              id="randomCancelBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Cancel random test"
            >
              Cancel
            </button>
            <button
              id="generateRunBtn"
              class="px-4 py-3 rounded-2xl text-white font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg shadow-purple-500/20 hover:brightness-105"
              aria-label="Generate and run"
            >
              Generate & Run
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table Modal (Full screen) -->
    <div
      id="tableModal"
      class="hidden fixed inset-0 z-[95] overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-label="Data table modal"
    >
      <div class="min-h-full flex justify-center p-0 sm:p-4">
        <div
          class="w-full max-w-6xl bg-white sm:rounded-3xl shadow-2xl border border-slate-200 overflow-hidden"
        >
          <div
            class="p-4 border-b border-slate-200 flex items-center justify-between gap-3"
          >
            <div>
              <div
                class="text-xs font-bold tracking-widest text-slate-500 uppercase"
              >
                üìã Data Table
              </div>
              <div class="mt-1 text-xl font-extrabold tracking-tight">
                Predictions + Confidence Bounds
              </div>
            </div>
            <button
              class="px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200"
              id="tableCloseX"
              aria-label="Close data table"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <div
            class="p-4 flex flex-col sm:flex-row gap-2 items-stretch sm:items-center"
          >
            <input
              id="tableSearch"
              type="text"
              placeholder="Search‚Ä¶ (step or value)"
              class="flex-1 px-4 py-3 rounded-2xl border border-slate-200 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"
              aria-label="Search table"
            >
            <button
              id="exportCsvBtn"
              class="px-4 py-3 rounded-2xl bg-slate-900 hover:bg-black text-white font-extrabold"
              aria-label="Export CSV"
            >
              üìä Export CSV
            </button>
            <button
              id="copyAllBtn"
              class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold"
              aria-label="Copy all"
            >
              üìã Copy All
            </button>
          </div>

          <div class="overflow-auto max-h-[75vh] border-t border-slate-200">
            <table
              class="min-w-full text-sm font-mono"
              aria-label="Prediction table"
            >
              <thead class="sticky top-0 bg-white shadow-sm">
                <tr id="tableHeadRow" class="border-b border-slate-200"></tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>

          <div class="p-4 border-t border-slate-200 text-xs text-slate-600">
            Tip: tap column headers to sort. Values are shown as raw numbers (no
            rounding by default).
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // =========================
      // State
      // =========================
      const DIM_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",

        useInputInReadout: true,
        useBiasInReadout: true,

        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,

        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,

        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,

        uncertaintyMultiplier: 1.96,

        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        default: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
        },
        fast: { reservoirSize: 64, reservoirSparsity: 0.95 },
        balanced: { reservoirSize: 256, spectralRadius: 0.9 },
        accurate: {
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      const STORAGE_KEYS = {
        config: "esnStudio.config.v1",
        vizMode: "esnStudio.vizMode.v1",
        savedModelsIndex: "esnStudio.savedModelsIndex.v1",
        savedModelPrefix: "esnStudio.savedModel.v1.",
      };

      const appState = {
        config: loadJSON(STORAGE_KEYS.config, DEFAULT_CONFIG),
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null, // {predictions, lowerBounds, upperBounds, confidence}
        vizMode: loadJSON(STORAGE_KEYS.vizMode, "grid"),
        selectedDim: 0,
        selectedStep: 0,
        logs: [],
        metrics: {
          samplesProcessed: 0,
          averageLoss: null,
          gradientNorm: null,
          driftDetected: false,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        dataset: null, // coordinates
        workerOk: true,
      };

      // =========================
      // DOM helpers
      // =========================
      const $ = (id) => document.getElementById(id);

      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v));
      }
      function fmtExp(v) {
        if (v === null || v === undefined || Number.isNaN(v)) {
          return "‚Äî";
        }
        const n = Number(v);
        if (!Number.isFinite(n)) return "‚Äî";
        return (Math.abs(n) >= 1e4 || Math.abs(n) <= 1e-3)
          ? n.toExponential(3)
          : n.toFixed(6).replace(/0+$/, "").replace(/\.$/, "");
      }
      function fmt3(v) {
        if (v === null || v === undefined || Number.isNaN(v)) {
          return "‚Äî";
        }
        const n = Number(v);
        if (!Number.isFinite(n)) return "‚Äî";
        return n.toFixed(3);
      }

      function loadJSON(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          return JSON.parse(raw);
        } catch {
          return fallback;
        }
      }
      function saveJSON(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      // =========================
      // Logging + Toasts
      // =========================
      function logEvent(level, message) {
        const entry = {
          id: crypto.randomUUID(),
          ts: new Date().toISOString(),
          level,
          message,
        };
        appState.logs.unshift(entry);
        if (appState.logs.length > 200) appState.logs.length = 200;
        renderLog();
      }

      function toast(level, message, ms) {
        const host = $("toastHost");
        const colors = {
          info: "bg-blue-600",
          success: "bg-emerald-600",
          warning: "bg-amber-500",
          error: "bg-red-600",
        };
        const dur = ms ?? (level === "error" ? 6000 : 4000);

        const el = document.createElement("div");
        el.className = `pointer-events-auto w-full max-w-md ${
          colors[level] || "bg-slate-800"
        } text-white rounded-2xl shadow-2xl px-4 py-3 border border-white/10`;
        el.setAttribute("role", "status");
        el.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="text-sm font-bold leading-5">${
          escapeHtml(message)
        }</div>
          <button class="shrink-0 px-2 py-1 rounded-xl bg-white/15 hover:bg-white/25 font-bold" aria-label="Close toast">‚úñÔ∏è</button>
        </div>
      `;
        const closeBtn = el.querySelector("button");
        const remove = () => {
          if (el.parentNode) el.parentNode.removeChild(el);
        };
        closeBtn.addEventListener("click", remove);
        host.appendChild(el);
        setTimeout(remove, dur);
      }

      function errorToast(err, context = "Error") {
        const msg = `${context}: ${err?.message || String(err)}`;
        toast("error", msg);
        logEvent("error", msg);
        console.error(err);
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (
            c,
          ) => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[c]),
        );
      }

      // =========================
      // Modal management (focus)
      // =========================
      let lastFocusEl = null;

      function openModal(modalEl) {
        lastFocusEl = document.activeElement;
        $("modalBackdrop").classList.remove("hidden");
        modalEl.classList.remove("hidden");

        // Focus first interactive element
        const focusable = modalEl.querySelector(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
        );
        setTimeout(() => focusable?.focus?.(), 0);
      }

      function closeModal(modalEl) {
        modalEl.classList.add("hidden");
        // If no other modals visible, hide backdrop
        const anyOpen = [
          "configModal",
          "uploadModal",
          "saveLoadModal",
          "randomModal",
          "tableModal",
        ].some((id) => !$(id).classList.contains("hidden"));
        if (!anyOpen) $("modalBackdrop").classList.add("hidden");
        setTimeout(() => lastFocusEl?.focus?.(), 0);
      }

      // =========================
      // Slide-out menu
      // =========================
      function openMenu() {
        $("menuBackdrop").classList.remove("hidden");
        $("menuPanel").classList.remove("translate-x-full");
        $("menuCloseBtn").focus();
      }
      function closeMenu() {
        $("menuBackdrop").classList.add("hidden");
        $("menuPanel").classList.add("translate-x-full");
        $("menuBtn").focus();
      }

      $("menuBtn").addEventListener("click", openMenu);
      $("menuCloseBtn").addEventListener("click", closeMenu);
      $("menuBackdrop").addEventListener("click", closeMenu);

      // =========================
      // Worker (inline)
      // =========================
      const ESN_URL =
        "https://esm.sh/jsr/@hviana/multivariate-regression";

      function createWorker() {
        const code = `
        let ESNRegression = null;
        let model = null;
        let isReady = false;
        const cancelled = new Set();

        function safePost(msg){ try{ postMessage(msg); }catch(e){} }

        async function ensureImport(){
          if (ESNRegression) return;
          const mod = await import("${ESN_URL}");
          ESNRegression = mod.ESNRegression;
        }

        onmessage = async (ev) => {
          const { type, requestId, payload } = ev.data || {};
          const reply = (ok, data, error) => safePost({ type: ok ? "result" : "error", requestId, data, error });

          try{
            if (type === "cancel"){
              if (payload?.requestId) cancelled.add(payload.requestId);
              safePost({ type: "cancelled", requestId, data: { cancelledRequestId: payload?.requestId } });
              return;
            }

            if (type === "init"){
              await ensureImport();
              isReady = true;
              reply(true, { ready: true });
              return;
            }

            if (!isReady){
              await ensureImport();
              isReady = true;
            }

            if (type === "reset"){
              model = null;
              reply(true, { ok: true });
              return;
            }

            if (type === "createModel"){
              const config = payload?.config || {};
              model = new ESNRegression(config);
              reply(true, { ok: true });
              return;
            }

            if (type === "load"){
              if (!model) model = new ESNRegression(payload?.config || {});
              model.load(payload?.state);
              reply(true, { ok: true });
              return;
            }

            if (type === "save"){
              if (!model) throw new Error("No model to save");
              const state = model.save();
              reply(true, { state });
              return;
            }

            if (type === "getSummary"){
              if (!model) throw new Error("No model");
              const summary = model.getModelSummary();
              reply(true, { summary });
              return;
            }

            if (type === "train"){
              if (!model) throw new Error("No model");
              const coords = payload?.coordinates;
              const chunkPairs = Math.max(2, Number(payload?.chunkPairs || 64));
              if (!Array.isArray(coords) || coords.length < 2) throw new Error("Training requires at least 2 coordinate rows");

              let lastMetrics = null;
              const totalPairs = coords.length - 1;
              for (let start = 0; start < totalPairs; start += chunkPairs){
                if (cancelled.has(requestId)) {
                  cancelled.delete(requestId);
                  reply(false, null, "Cancelled");
                  return;
                }
                const end = Math.min(totalPairs, start + chunkPairs);
                // Need end+1 coordinates to make end-start pairs
                const slice = coords.slice(start, end + 1);
                lastMetrics = await model.fitOnline({ coordinates: slice });

                const progress = Math.round((end / totalPairs) * 100);
                safePost({ type: "progress", requestId, data: { progress, metrics: lastMetrics } });
              }

              reply(true, { metrics: lastMetrics });
              return;
            }

            if (type === "predict"){
              if (!model) throw new Error("No model");
              const futureSteps = Number(payload?.futureSteps || 1);
              if (!Number.isFinite(futureSteps) || futureSteps < 1) throw new Error("futureSteps must be >= 1");
              const result = model.predict(futureSteps);
              reply(true, { result });
              return;
            }

            reply(false, null, "Unknown message type: " + type);
          }catch(err){
            reply(false, null, err?.message || String(err));
          }
        };
      `;
        const blob = new Blob([code], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const worker = new Worker(url, { type: "module" });
        URL.revokeObjectURL(url);
        return worker;
      }

      let worker = null;
      let pending = new Map();
      let activeRequestId = null;

      function setupWorker() {
        try {
          worker = createWorker();
          worker.onmessage = (ev) => {
            const msg = ev.data || {};
            if (msg.type === "progress") {
              if (msg.requestId === activeRequestId) {
                const pct = clamp(
                  Number(msg.data?.progress || 0),
                  0,
                  100,
                );
                setLoadingProgress(pct);
                if (msg.data?.metrics) {
                  appState.metrics = {
                    ...appState.metrics,
                    ...msg.data.metrics,
                  };
                  renderMetrics();
                }
              }
              return;
            }

            if (msg.type === "error") {
              const p = pending.get(msg.requestId);
              if (p) {
                pending.delete(msg.requestId);
                p.reject(new Error(msg.error || "Worker error"));
              }
              return;
            }

            if (msg.type === "result") {
              const p = pending.get(msg.requestId);
              if (p) {
                pending.delete(msg.requestId);
                p.resolve(msg.data);
              }
              return;
            }
          };
          worker.onerror = (e) => {
            appState.workerOk = false;
            logEvent(
              "error",
              `Worker failed: ${e.message || "unknown error"}`,
            );
            toast(
              "warning",
              "Web Worker failed. Falling back to main thread (may be slower).",
              6000,
            );
          };
        } catch (err) {
          appState.workerOk = false;
          errorToast(err, "Failed to initialize worker");
        }
      }

      async function sendToWorker(type, payload) {
        const requestId = crypto.randomUUID();
        if (!worker || !appState.workerOk) {
          return await runOnMainThread(type, payload, requestId);
        }

        return await new Promise((resolve, reject) => {
          pending.set(requestId, { resolve, reject });
          try {
            worker.postMessage({ type, requestId, payload });
          } catch (err) {
            pending.delete(requestId);
            reject(err);
          }
        });
      }

      async function cancelRequest(requestId) {
        try {
          if (worker && appState.workerOk) {
            worker.postMessage({
              type: "cancel",
              requestId: crypto.randomUUID(),
              payload: { requestId },
            });
          }
        } catch {}
      }

      // =========================
      // Graceful degradation: main thread runner
      // =========================
      let mainThreadModel = null;
      let ESNMain = null;

      async function ensureMainImport() {
        if (ESNMain) return;
        const mod = await import(ESN_URL);
        ESNMain = mod.ESNRegression;
      }

      async function runOnMainThread(type, payload, requestId) {
        try {
          await ensureMainImport();

          if (type === "init") return { ready: true };
          if (type === "reset") {
            mainThreadModel = null;
            return { ok: true };
          }
          if (type === "createModel") {
            mainThreadModel = new ESNMain(payload?.config || {});
            return { ok: true };
          }
          if (type === "load") {
            if (!mainThreadModel) {
              mainThreadModel = new ESNMain(payload?.config || {});
            }
            mainThreadModel.load(payload?.state);
            return { ok: true };
          }
          if (type === "save") {
            if (!mainThreadModel) throw new Error("No model to save");
            return { state: mainThreadModel.save() };
          }
          if (type === "getSummary") {
            if (!mainThreadModel) throw new Error("No model");
            return { summary: mainThreadModel.getModelSummary() };
          }
          if (type === "train") {
            if (!mainThreadModel) throw new Error("No model");
            const coords = payload?.coordinates;
            if (!Array.isArray(coords) || coords.length < 2) {
              throw new Error(
                "Training requires at least 2 coordinate rows",
              );
            }
            // Simple chunk loop with UI progress (no true cancellation on main thread)
            const chunkPairs = Math.max(
              2,
              Number(payload?.chunkPairs || 64),
            );
            const totalPairs = coords.length - 1;
            let lastMetrics = null;
            for (
              let start = 0;
              start < totalPairs;
              start += chunkPairs
            ) {
              const end = Math.min(totalPairs, start + chunkPairs);
              const slice = coords.slice(start, end + 1);
              lastMetrics = await mainThreadModel.fitOnline({
                coordinates: slice,
              });
              const progress = Math.round((end / totalPairs) * 100);
              if (requestId === activeRequestId) {
                setLoadingProgress(progress);
                appState.metrics = {
                  ...appState.metrics,
                  ...lastMetrics,
                };
                renderMetrics();
              }
              await new Promise((r) => setTimeout(r, 0)); // yield
            }
            return { metrics: lastMetrics };
          }
          if (type === "predict") {
            if (!mainThreadModel) throw new Error("No model");
            const futureSteps = Number(payload?.futureSteps || 1);
            if (!Number.isFinite(futureSteps) || futureSteps < 1) {
              throw new Error("futureSteps must be >= 1");
            }
            return { result: mainThreadModel.predict(futureSteps) };
          }
          throw new Error("Unknown message type: " + type);
        } catch (err) {
          throw err;
        }
      }

      // =========================
      // Loading UI
      // =========================
      function showLoading(text) {
        $("loadingOverlay").classList.remove("hidden");
        $("loadingText").textContent = text || "Working‚Ä¶";
        setLoadingProgress(0);
      }
      function hideLoading() {
        $("loadingOverlay").classList.add("hidden");
        activeRequestId = null;
      }
      function setLoadingProgress(pct) {
        const p = clamp(Math.round(pct), 0, 100);
        $("loadingPct").textContent = `${p}%`;
        $("loadingBar").style.width = `${p}%`;
      }

      $("cancelOpBtn").addEventListener("click", async () => {
        if (!activeRequestId) return;
        logEvent("warning", "Cancellation requested");
        toast("warning", "Cancelling‚Ä¶");
        await cancelRequest(activeRequestId);
      });

      // =========================
      // Model status UI
      // =========================
      function renderModelStatus() {
        const dot = $("modelDot");
        const text = $("modelStatusText");
        const predictBtn = $("predictBtn");
        const runPredictBtn = $("runPredictBtn");
        const downloadModelBtn = $("downloadModelBtn");
        const saveBrowserBtn = $("saveBrowserBtn");

        if (!appState.modelExists) {
          dot.className =
            "inline-block h-2.5 w-2.5 rounded-full bg-slate-400";
          text.textContent = "No Model";
          predictBtn.classList.add("hidden");
          runPredictBtn.disabled = true;
          downloadModelBtn.disabled = true;
          saveBrowserBtn.disabled = true;
        } else {
          dot.className =
            "inline-block h-2.5 w-2.5 rounded-full bg-emerald-500";
          text.textContent = `${appState.sampleCount || 0} steps`;
          predictBtn.classList.remove("hidden");
          runPredictBtn.disabled = false;
          downloadModelBtn.disabled = false;
          saveBrowserBtn.disabled = false;
        }
      }

      function renderMetrics() {
        $("mSamples").textContent = String(
          appState.metrics.samplesProcessed ?? 0,
        );
        $("mLoss").textContent = fmtExp(appState.metrics.averageLoss);
        $("mGrad").textContent = fmtExp(appState.metrics.gradientNorm);
        $("mWeight").textContent = fmt3(appState.metrics.sampleWeight);
      }

      // =========================
      // Event log UI
      // =========================
      function levelPill(level) {
        const colors = {
          info: "bg-blue-100 text-blue-800 border-blue-200",
          success: "bg-emerald-100 text-emerald-800 border-emerald-200",
          warning: "bg-amber-100 text-amber-800 border-amber-200",
          error: "bg-red-100 text-red-800 border-red-200",
        };
        return `<span class="px-2 py-1 rounded-xl border text-[11px] font-extrabold uppercase tracking-widest ${
          colors[level] ||
          "bg-slate-100 text-slate-700 border-slate-200"
        }">${escapeHtml(level)}</span>`;
      }

      function renderLog() {
        const filter = $("logFilter").value;
        const q = $("logSearch").value.trim().toLowerCase();
        const list = $("logList");
        list.innerHTML = "";

        const items = appState.logs
          .filter((e) => filter === "all" ? true : e.level === filter)
          .filter((e) =>
            !q ? true : (e.message.toLowerCase().includes(q) ||
              e.ts.toLowerCase().includes(q))
          )
          .slice(0, 50);

        if (!items.length) {
          list.innerHTML =
            `<div class="p-4 text-sm text-slate-600">No matching events.</div>`;
          return;
        }

        for (const e of items) {
          const row = document.createElement("div");
          row.className =
            "p-3 border-b border-slate-200 last:border-b-0 bg-white hover:bg-slate-50";
          row.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            ${levelPill(e.level)}
            <div class="text-xs text-slate-500 tabular-nums">${
            new Date(e.ts).toLocaleString()
          }</div>
          </div>
          <div class="mt-2 text-sm font-semibold text-slate-800">${
            escapeHtml(e.message)
          }</div>
        `;
          list.appendChild(row);
        }
      }

      $("logFilter").addEventListener("change", renderLog);
      $("logSearch").addEventListener("input", renderLog);
      $("clearLogBtn").addEventListener("click", () => {
        appState.logs = [];
        renderLog();
        logEvent("info", "Event log cleared");
      });

      // =========================
      // Config UI bindings
      // =========================
      const configFields = [
        "reservoirSize",
        "spectralRadius",
        "leakRate",
        "inputScale",
        "biasScale",
        "reservoirSparsity",
        "inputSparsity",
        "activation",
        "rlsLambda",
        "rlsDelta",
        "epsilon",
        "l2Lambda",
        "gradientClipNorm",
        "normalizationEpsilon",
        "normalizationWarmup",
        "outlierThreshold",
        "outlierMinWeight",
        "uncertaintyMultiplier",
        "weightInitScale",
        "seed",
      ];
      const toggleFields = [
        "useInputInReadout",
        "useBiasInReadout",
        "verbose",
      ];

      function setToggleBtn(btn, value) {
        btn.textContent = value ? "true" : "false";
        if (value) {
          btn.className =
            "toggleBtn px-3 py-2 rounded-2xl bg-emerald-600 text-white font-bold";
        } else {
          btn.className =
            "toggleBtn px-3 py-2 rounded-2xl bg-slate-200 text-slate-900 font-bold";
        }
        btn.dataset.value = value ? "true" : "false";
      }

      function renderConfigForm() {
        for (const k of configFields) {
          const el = $(k);
          if (!el) continue;
          if (k === "activation") {
            el.value = appState.config[k] ?? "tanh";
          } else el.value = String(appState.config[k] ?? "");
        }
        for (const k of toggleFields) {
          const btn = $(k);
          if (!btn) continue;
          setToggleBtn(btn, !!appState.config[k]);
        }
      }

      function clearValidation() {
        document.querySelectorAll("[data-err]").forEach((el) => {
          el.classList.add("hidden");
          el.textContent = "";
        });
      }

      function setFieldError(key, msg) {
        const errEl = document.querySelector(`[data-err="${key}"]`);
        if (!errEl) return;
        errEl.textContent = msg;
        errEl.classList.remove("hidden");
      }

      function validateConfig() {
        clearValidation();
        let ok = true;
        const num = (k) => Number($(k).value);

        const mustFinite = (k, cond, msg) => {
          const v = num(k);
          if (!Number.isFinite(v) || (cond && !cond(v))) {
            setFieldError(k, msg);
            ok = false;
          }
        };

        mustFinite(
          "reservoirSize",
          (v) => v >= 1 && Number.isInteger(v),
          "Must be an integer ‚â• 1",
        );
        mustFinite("spectralRadius", (v) => v > 0, "Must be > 0");
        mustFinite(
          "leakRate",
          (v) => v >= 0 && v <= 1,
          "Must be in [0, 1]",
        );
        mustFinite("inputScale", (v) => v > 0, "Must be > 0");
        mustFinite("biasScale", (v) => v >= 0, "Must be ‚â• 0");
        mustFinite(
          "reservoirSparsity",
          (v) => v >= 0 && v <= 1,
          "Must be in [0, 1]",
        );
        mustFinite(
          "inputSparsity",
          (v) => v >= 0 && v <= 1,
          "Must be in [0, 1]",
        );

        mustFinite(
          "rlsLambda",
          (v) => v > 0 && v <= 1,
          "Must be in (0, 1]",
        );
        mustFinite("rlsDelta", (v) => v > 0, "Must be > 0");
        mustFinite("epsilon", (v) => v > 0, "Must be > 0");
        mustFinite("l2Lambda", (v) => v >= 0, "Must be ‚â• 0");
        mustFinite("gradientClipNorm", (v) => v > 0, "Must be > 0");

        mustFinite("normalizationEpsilon", (v) => v > 0, "Must be > 0");
        mustFinite(
          "normalizationWarmup",
          (v) => v >= 0 && Number.isInteger(v),
          "Must be an integer ‚â• 0",
        );

        mustFinite("outlierThreshold", (v) => v > 0, "Must be > 0");
        mustFinite(
          "outlierMinWeight",
          (v) => v > 0 && v <= 1,
          "Must be in (0, 1]",
        );

        mustFinite(
          "uncertaintyMultiplier",
          (v) => v > 0,
          "Must be > 0",
        );

        mustFinite("weightInitScale", (v) => v > 0, "Must be > 0");
        mustFinite(
          "seed",
          (v) => Number.isInteger(v),
          "Must be an integer",
        );

        return ok;
      }

      function applyConfigFromForm() {
        const next = { ...appState.config };
        for (const k of configFields) {
          const el = $(k);
          if (!el) continue;
          if (k === "activation") next[k] = el.value;
          else next[k] = Number(el.value);
        }
        for (const k of toggleFields) {
          const btn = $(k);
          next[k] = btn.dataset.value === "true";
        }
        // readoutTraining is fixed
        next.readoutTraining = "rls";
        appState.config = next;
        saveJSON(STORAGE_KEYS.config, appState.config);
      }

      // Collapsibles default open
      const collapseIds = [
        "reservoir",
        "readout",
        "training",
        "norm",
        "outliers",
        "uncertainty",
        "init",
      ];
      const collapseMap = {
        reservoir: ["sectionReservoir", "chevReservoir"],
        readout: ["sectionReadout", "chevReadout"],
        training: ["sectionTraining", "chevTraining"],
        norm: ["sectionNorm", "chevNorm"],
        outliers: ["sectionOutliers", "chevOutliers"],
        uncertainty: ["sectionUncertainty", "chevUnc"],
        init: ["sectionInit", "chevInit"],
      };
      const collapsed = new Set(); // none collapsed initially

      function renderCollapses() {
        for (const key of collapseIds) {
          const [sectionId, chevId] = collapseMap[key];
          const isCollapsed = collapsed.has(key);
          $(sectionId).classList.toggle("hidden", isCollapsed);
          $(chevId).textContent = isCollapsed ? "‚ñº" : "‚ñ≤";
        }
      }
      document.querySelectorAll("[data-collapse]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.collapse;
          if (collapsed.has(key)) collapsed.delete(key);
          else collapsed.add(key);
          renderCollapses();
        });
      });

      document.querySelectorAll(".presetBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const preset = btn.dataset.preset;
          const patch = PRESETS[preset] || {};
          appState.config = { ...appState.config, ...patch };
          renderConfigForm();
          document.querySelectorAll(".presetBtn").forEach((b) => {
            b.className =
              "presetBtn shrink-0 px-4 py-2 rounded-2xl font-bold bg-slate-100 hover:bg-slate-200";
          });
          btn.className =
            "presetBtn shrink-0 px-4 py-2 rounded-2xl font-extrabold bg-blue-600 text-white";
          logEvent("info", `Preset applied: ${preset}`);
        });
      });

      toggleFields.forEach((k) => {
        const btn = $(k);
        btn.addEventListener("click", () => {
          const v = btn.dataset.value === "true" ? false : true;
          setToggleBtn(btn, v);
        });
      });

      // Open/close config
      $("configBtn").addEventListener("click", () => {
        renderConfigForm();
        renderCollapses();
        openModal($("configModal"));
      });
      $("configCancelBtn").addEventListener(
        "click",
        () => closeModal($("configModal")),
      );
      $("configCloseX").addEventListener(
        "click",
        () => closeModal($("configModal")),
      );
      $("resetDefaultsBtn").addEventListener("click", () => {
        appState.config = { ...DEFAULT_CONFIG };
        renderConfigForm();
        toast("info", "Defaults restored");
        logEvent("info", "Configuration reset to defaults");
      });
      $("resetAllBtn").addEventListener("click", async () => {
        try {
          appState.config = { ...DEFAULT_CONFIG };
          appState.modelExists = false;
          appState.sampleCount = 0;
          appState.nDimensions = 0;
          appState.predictions = null;
          appState.dataset = null;
          appState.metrics = {
            samplesProcessed: 0,
            averageLoss: null,
            gradientNorm: null,
            driftDetected: false,
            sampleWeight: null,
          };
          renderConfigForm();
          renderModelStatus();
          renderMetrics();
          updateVizVisibility();
          resetZoom();
          await safeAsync(
            async () => sendToWorker("reset", {}),
            "Reset failed",
          );
          toast("success", "Reset complete");
          logEvent("success", "Reset all");
        } catch (err) {
          errorToast(err, "Reset all failed");
        }
      });

      $("createModelBtn").addEventListener("click", async () => {
        try {
          if (!validateConfig()) {
            toast("error", "Fix configuration errors first");
            logEvent("error", "Configuration validation failed");
            return;
          }
          applyConfigFromForm();
          await createModelFlow();
          closeModal($("configModal"));
        } catch (err) {
          errorToast(err, "Create model failed");
        }
      });

      // =========================
      // Tabs / visualization mode
      // =========================
      function setVizMode(mode) {
        appState.vizMode = mode;
        saveJSON(STORAGE_KEYS.vizMode, mode);
        $("tabGrid").className = mode === "grid"
          ? "shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
          : "shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-slate-100 text-slate-800 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400";
        $("tabFocus").className = mode === "focus"
          ? "shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20 focus:outline-none focus:ring-2 focus:ring-blue-500"
          : "shrink-0 px-4 py-2 rounded-2xl font-bold border border-slate-200 bg-slate-100 text-slate-800 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400";

        $("dimSelectorWrap").classList.toggle(
          "hidden",
          mode !== "focus",
        );
        $("statsBar").classList.toggle("hidden", mode !== "focus");
        draw();
      }

      $("tabGrid").addEventListener("click", () => setVizMode("grid"));
      $("tabFocus").addEventListener(
        "click",
        () => setVizMode("focus"),
      );

      // =========================
      // Canvas rendering + interaction
      // =========================
      const canvas = $("chartCanvas");
      const ctx = canvas.getContext("2d", { alpha: false });

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(
          1,
          Math.min(2, window.devicePixelRatio || 1),
        );
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        draw();
      }
      window.addEventListener("resize", resizeCanvas);

      function updateVizVisibility() {
        const hasPred = !!appState.predictions?.predictions?.length;
        $("emptyState").classList.toggle("hidden", hasPred);
        $("canvasWrap").classList.toggle("hidden", !hasPred);
        $("zoomControls").classList.toggle("hidden", !hasPred);
        $("exportControls").classList.toggle("hidden", !hasPred);
        $("zoomBadge").classList.toggle("hidden", !hasPred);
        if (hasPred) {
          ensureDimSelector();
          updateStatsBar();
          resizeCanvas();
        }
      }

      function resetZoom() {
        const len = appState.predictions?.predictions?.length || 0;
        appState.zoom.level = 1;
        appState.zoom.visibleStart = 0;
        appState.zoom.visibleCount = len;
        appState.zoom.offsetX = 0;
        $("zoomBadge").textContent = "100%";
        draw();
      }

      function zoomBy(factor, centerStep) {
        const len = appState.predictions?.predictions?.length || 0;
        if (!len) return;

        const prevCount = appState.zoom.visibleCount || len;
        const newCount = clamp(
          Math.round(prevCount / factor),
          Math.max(10, Math.min(200, len)),
          len,
        );

        // Keep centerStep stable
        const cs = clamp(
          centerStep ?? (appState.zoom.visibleStart + prevCount / 2),
          0,
          len - 1,
        );
        let start = Math.round(cs - newCount / 2);
        start = clamp(start, 0, Math.max(0, len - newCount));

        appState.zoom.visibleStart = start;
        appState.zoom.visibleCount = newCount;
        appState.zoom.level = len / newCount;
        $("zoomBadge").textContent = `${
          Math.round((appState.zoom.level) * 100)
        }%`;
        draw();
      }

      $("zoomInBtn").addEventListener("click", () => zoomBy(1.6));
      $("zoomOutBtn").addEventListener("click", () => zoomBy(1 / 1.6));
      $("zoomResetBtn").addEventListener("click", resetZoom);

      // Wheel zoom
      canvas.addEventListener("wheel", (e) => {
        if (!appState.predictions) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const step = xToStep(x, rect.width);
        const factor = e.deltaY < 0 ? 1.25 : 1 / 1.25;
        zoomBy(factor, step);
      }, { passive: false });

      // Pointer drag pan + hover + touch hold tooltip
      let dragging = false;
      let dragStartX = 0;
      let dragStartVisibleStart = 0;

      let pointers = new Map(); // pointerId => {x,y}
      let pinchStartDist = null;
      let pinchStartCount = null;
      let pinchCenterStep = null;

      function getClientXY(ev) {
        return { x: ev.clientX, y: ev.clientY };
      }

      canvas.addEventListener("pointerdown", (ev) => {
        if (!appState.predictions) return;
        canvas.setPointerCapture(ev.pointerId);
        pointers.set(ev.pointerId, getClientXY(ev));

        if (pointers.size === 1) {
          dragging = true;
          dragStartX = ev.clientX;
          dragStartVisibleStart = appState.zoom.visibleStart;
        } else if (pointers.size === 2) {
          const pts = [...pointers.values()];
          pinchStartDist = Math.hypot(
            pts[0].x - pts[1].x,
            pts[0].y - pts[1].y,
          );
          pinchStartCount = appState.zoom.visibleCount;
          const rect = canvas.getBoundingClientRect();
          const midx = ((pts[0].x + pts[1].x) / 2) - rect.left;
          pinchCenterStep = xToStep(midx, rect.width);
        }
      });

      canvas.addEventListener("pointermove", (ev) => {
        if (!appState.predictions) return;
        pointers.set(ev.pointerId, getClientXY(ev));

        const rect = canvas.getBoundingClientRect();
        const localX = ev.clientX - rect.left;
        const localY = ev.clientY - rect.top;

        // Hover
        updateHover(localX, localY, rect.width, rect.height);

        // Pinch
        if (pointers.size === 2 && pinchStartDist && pinchStartCount) {
          const pts = [...pointers.values()];
          const dist = Math.hypot(
            pts[0].x - pts[1].x,
            pts[0].y - pts[1].y,
          );
          const ratio = clamp(dist / pinchStartDist, 0.5, 2.0);

          const len = appState.predictions.predictions.length;
          const newCount = clamp(
            Math.round(pinchStartCount / ratio),
            Math.max(10, Math.min(200, len)),
            len,
          );
          const cs = pinchCenterStep ??
            (appState.zoom.visibleStart +
              appState.zoom.visibleCount / 2);

          let start = Math.round(cs - newCount / 2);
          start = clamp(start, 0, Math.max(0, len - newCount));
          appState.zoom.visibleStart = start;
          appState.zoom.visibleCount = newCount;
          appState.zoom.level = len / newCount;
          $("zoomBadge").textContent = `${
            Math.round(appState.zoom.level * 100)
          }%`;
          draw();
          return;
        }

        // Pan
        if (
          dragging && pointers.size === 1 &&
          appState.zoom.visibleCount <
            appState.predictions.predictions.length
        ) {
          const dx = ev.clientX - dragStartX;
          const stepsPerPx = appState.zoom.visibleCount / rect.width;
          const deltaSteps = Math.round(-dx * stepsPerPx);
          const len = appState.predictions.predictions.length;
          const maxStart = Math.max(
            0,
            len - appState.zoom.visibleCount,
          );
          appState.zoom.visibleStart = clamp(
            dragStartVisibleStart + deltaSteps,
            0,
            maxStart,
          );
          draw();
        }
      });

      canvas.addEventListener("pointerup", (ev) => {
        pointers.delete(ev.pointerId);
        dragging = false;
        pinchStartDist = null;
        pinchStartCount = null;
        pinchCenterStep = null;
      });
      canvas.addEventListener("pointercancel", (ev) => {
        pointers.delete(ev.pointerId);
        dragging = false;
        pinchStartDist = null;
        pinchStartCount = null;
        pinchCenterStep = null;
      });

      canvas.addEventListener("pointerleave", () => {
        appState.hover.active = false;
        $("tooltip").classList.add("hidden");
        draw();
      });

      function xToStep(x, width) {
        const len = appState.predictions?.predictions?.length || 0;
        if (!len) return 0;
        const start = appState.zoom.visibleStart;
        const count = appState.zoom.visibleCount || len;
        const idx = start + (x / Math.max(1, width)) * (count - 1);
        return clamp(Math.round(idx), 0, len - 1);
      }

      function updateHover(x, y, w, h) {
        if (!appState.predictions) return;
        const step = xToStep(x, w);
        appState.hover = { active: true, x, y, dataIndex: step };
        updateTooltip(step, x, y, w, h);
        draw();
      }

      function updateTooltip(step, x, y, w, h) {
        if (!appState.predictions) return;
        const mode = appState.vizMode;
        const dim = mode === "focus" ? appState.selectedDim : null;
        const tooltip = $("tooltip");

        let show = false;
        let useDim = 0;

        if (mode === "focus") {
          useDim = dim;
          show = true;
        } else {
          // In grid mode: show tooltip only if near a subplot cell
          // Simplify: show using selectedDim (last chosen) to avoid confusion
          useDim = appState.selectedDim || 0;
          show = true;
        }

        if (!show) {
          tooltip.classList.add("hidden");
          return;
        }

        const pred = appState.predictions.predictions?.[step]?.[useDim];
        const lo = appState.predictions.lowerBounds?.[step]?.[useDim];
        const hi = appState.predictions.upperBounds?.[step]?.[useDim];
        const spread = (Number.isFinite(lo) && Number.isFinite(hi))
          ? (hi - lo)
          : null;

        $("ttStep").textContent = String(step);
        $("ttDim").textContent = `D${useDim + 1}`;
        $("ttPred").textContent = pred ?? "‚Äî";
        $("ttCI").textContent =
          (Number.isFinite(lo) && Number.isFinite(hi))
            ? `${lo} ‚Äî ${hi}`
            : "‚Äî";
        $("ttSpread").textContent = Number.isFinite(spread)
          ? String(spread)
          : "‚Äî";
        $("ttColor").style.backgroundColor =
          DIM_COLORS[useDim % DIM_COLORS.length];

        // Position
        const pad = 12;
        const maxLeft = w - pad;
        const maxTop = h - pad;
        const left = clamp(x + 14, pad, maxLeft);
        const top = clamp(y + 14, pad, maxTop);

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        tooltip.classList.remove("hidden");
      }

      function draw() {
        const rect = canvas.getBoundingClientRect();
        if (!rect.width || !rect.height) {
          return;
        }

        const w = rect.width;
        const h = rect.height;

        // background
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, w, h);

        if (!appState.predictions?.predictions?.length) {
          return;
        }

        const preds = appState.predictions.predictions;
        const lows = appState.predictions.lowerBounds;
        const highs = appState.predictions.upperBounds;

        const start = appState.zoom.visibleStart || 0;
        const count = appState.zoom.visibleCount || preds.length;
        const end = Math.min(preds.length, start + count);
        const sliceLen = Math.max(2, end - start);

        const mode = appState.vizMode;

        // margins
        const padL = 42, padR = 14, padT = 18, padB = 28;

        // subtle grid
        ctx.strokeStyle = "#E2E8F0";
        ctx.lineWidth = 1;

        if (mode === "focus") {
          const dim = clamp(
            appState.selectedDim,
            0,
            appState.nDimensions - 1,
          );
          const area = {
            x: padL,
            y: padT,
            w: w - padL - padR,
            h: h - padT - padB,
          };
          drawSeries(area, dim, start, end, preds, lows, highs, true);
          drawAxes(area, start, end, dim, true);

          // crosshair
          if (appState.hover.active) {
            const idx = clamp(appState.hover.dataIndex, start, end - 1);
            const x = area.x +
              ((idx - start) / (sliceLen - 1)) * area.w;
            ctx.save();
            ctx.strokeStyle = "rgba(15, 23, 42, 0.25)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, area.y);
            ctx.lineTo(x, area.y + area.h);
            ctx.stroke();
            ctx.restore();

            // highlight point
            const y = valueToY(
              preds[idx][dim],
              seriesMinMax(dim, start, end, preds, lows, highs),
              area,
            );
            ctx.save();
            ctx.fillStyle = DIM_COLORS[dim % DIM_COLORS.length];
            ctx.beginPath();
            ctx.arc(x, y, 4.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 0.25;
            ctx.beginPath();
            ctx.arc(x, y, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
          }
        } else {
          // grid small multiples
          const n = appState.nDimensions || (preds[0]?.length || 0);
          const cols = w < 520 ? 2 : 3;
          const rows = Math.ceil(n / cols);
          const gap = 10;
          const cellW = (w - gap * (cols + 1)) / cols;
          const cellH = (h - gap * (rows + 1)) / rows;

          for (let d = 0; d < n; d++) {
            const r = Math.floor(d / cols);
            const c = d % cols;
            const x0 = gap + c * (cellW + gap);
            const y0 = gap + r * (cellH + gap);
            const area = {
              x: x0 + 32,
              y: y0 + 14,
              w: cellW - 44,
              h: cellH - 28,
            };

            // card
            ctx.save();
            ctx.fillStyle = "#F8FAFC";
            ctx.strokeStyle = "#E2E8F0";
            roundRect(ctx, x0, y0, cellW, cellH, 14);
            ctx.fill();
            ctx.stroke();
            ctx.restore();

            drawSeries(area, d, start, end, preds, lows, highs, false);
            drawAxes(area, start, end, d, false);

            // label
            ctx.save();
            ctx.fillStyle = "#0F172A";
            ctx.font =
              "700 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
            ctx.fillText(`D${d + 1}`, x0 + 12, y0 + 18);
            ctx.fillStyle = DIM_COLORS[d % DIM_COLORS.length];
            ctx.beginPath();
            ctx.arc(x0 + 46, y0 + 14, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
          }
        }
      }

      function roundRect(ctx, x, y, w, h, r) {
        const rr = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }

      function seriesMinMax(dim, start, end, preds, lows, highs) {
        let min = Infinity, max = -Infinity;
        for (let i = start; i < end; i++) {
          const v = preds[i]?.[dim];
          if (Number.isFinite(v)) {
            min = Math.min(min, v);
            max = Math.max(max, v);
          }
          const lo = lows?.[i]?.[dim];
          const hi = highs?.[i]?.[dim];
          if (Number.isFinite(lo)) min = Math.min(min, lo);
          if (Number.isFinite(hi)) max = Math.max(max, hi);
        }
        if (!Number.isFinite(min) || !Number.isFinite(max)) {
          min = -1;
          max = 1;
        }
        if (min === max) {
          min -= 1;
          max += 1;
        }
        const pad = (max - min) * 0.08;
        return { min: min - pad, max: max + pad };
      }

      function valueToY(v, mm, area) {
        const t = (v - mm.min) / (mm.max - mm.min);
        return area.y + (1 - t) * area.h;
      }

      function drawAxes(area, start, end, dim, showText) {
        // grid lines
        ctx.save();
        ctx.strokeStyle = "#E2E8F0";
        ctx.lineWidth = 1;

        const yTicks = 4;
        for (let i = 0; i <= yTicks; i++) {
          const y = area.y + (i / yTicks) * area.h;
          ctx.beginPath();
          ctx.moveTo(area.x, y);
          ctx.lineTo(area.x + area.w, y);
          ctx.stroke();
        }

        // border
        ctx.strokeStyle = "#CBD5E1";
        ctx.beginPath();
        ctx.rect(area.x, area.y, area.w, area.h);
        ctx.stroke();
        ctx.restore();

        if (!showText) return;

        ctx.save();
        ctx.fillStyle = "#475569";
        ctx.font =
          "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(`D${dim + 1}`, area.x, area.y - 6);

        // x labels
        ctx.font =
          "600 11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillStyle = "#64748B";
        ctx.fillText(String(start), area.x, area.y + area.h + 18);
        ctx.fillText(
          String(end - 1),
          area.x + area.w - 26,
          area.y + area.h + 18,
        );
        ctx.restore();
      }

      function drawSeries(
        area,
        dim,
        start,
        end,
        preds,
        lows,
        highs,
        thick,
      ) {
        const mm = seriesMinMax(dim, start, end, preds, lows, highs);
        const n = end - start;
        if (n < 2) return;

        const color = DIM_COLORS[dim % DIM_COLORS.length];

        // uncertainty band
        if (lows && highs) {
          ctx.save();
          ctx.fillStyle = hexToRgba(color, 0.14);
          ctx.beginPath();
          for (let i = 0; i < n; i++) {
            const idx = start + i;
            const x = area.x + (i / (n - 1)) * area.w;
            const y = valueToY(highs[idx][dim], mm, area);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          for (let i = n - 1; i >= 0; i--) {
            const idx = start + i;
            const x = area.x + (i / (n - 1)) * area.w;
            const y = valueToY(lows[idx][dim], mm, area);
            ctx.lineTo(x, y);
          }
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        // prediction line
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = thick ? 2.5 : 2.0;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const idx = start + i;
          const x = area.x + (i / (n - 1)) * area.w;
          const y = valueToY(preds[idx][dim], mm, area);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.restore();
      }

      function hexToRgba(hex, a) {
        const h = hex.replace("#", "").trim();
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        return `rgba(${r},${g},${b},${a})`;
      }

      // Click dimension in grid -> focus
      canvas.addEventListener("click", (ev) => {
        if (!appState.predictions) return;
        if (appState.vizMode !== "grid") return;

        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const y = ev.clientY - rect.top;

        const w = rect.width, h = rect.height;
        const n = appState.nDimensions ||
          appState.predictions.predictions[0].length;
        const cols = w < 520 ? 2 : 3;
        const rows = Math.ceil(n / cols);
        const gap = 10;
        const cellW = (w - gap * (cols + 1)) / cols;
        const cellH = (h - gap * (rows + 1)) / rows;

        let clickedDim = null;
        for (let d = 0; d < n; d++) {
          const r = Math.floor(d / cols);
          const c = d % cols;
          const x0 = gap + c * (cellW + gap);
          const y0 = gap + r * (cellH + gap);
          if (
            x >= x0 && x <= x0 + cellW && y >= y0 && y <= y0 + cellH
          ) {
            clickedDim = d;
            break;
          }
        }
        if (clickedDim !== null) {
          appState.selectedDim = clickedDim;
          setVizMode("focus");
          ensureDimSelector();
          updateStatsBar();
          logEvent("info", `Focus dimension set to D${clickedDim + 1}`);
        }
      });

      // =========================
      // Dimension selector + stats
      // =========================
      function ensureDimSelector() {
        if (!appState.predictions?.predictions?.length) return;
        const n = appState.nDimensions ||
          appState.predictions.predictions[0].length;
        const host = $("dimSelector");
        host.innerHTML = "";
        for (let d = 0; d < n; d++) {
          const btn = document.createElement("button");
          btn.className =
            "shrink-0 px-4 py-2 rounded-2xl font-extrabold border border-slate-200";
          btn.setAttribute("aria-label", `Select dimension ${d + 1}`);
          btn.textContent = `D${d + 1}`;
          const active = d === appState.selectedDim;
          btn.style.backgroundColor = active
            ? DIM_COLORS[d % DIM_COLORS.length]
            : "#F1F5F9";
          btn.style.color = active ? "white" : "#0F172A";
          btn.addEventListener("click", () => {
            appState.selectedDim = d;
            ensureDimSelector();
            updateStatsBar();
            draw();
          });
          host.appendChild(btn);
        }
      }

      function computeStatsForDim(dim) {
        const preds = appState.predictions?.predictions;
        if (!preds?.length) return null;

        const start = appState.zoom.visibleStart || 0;
        const end = Math.min(
          preds.length,
          start + (appState.zoom.visibleCount || preds.length),
        );

        let min = Infinity, max = -Infinity, sum = 0, cnt = 0;
        for (let i = start; i < end; i++) {
          const v = preds[i]?.[dim];
          if (!Number.isFinite(v)) continue;
          min = Math.min(min, v);
          max = Math.max(max, v);
          sum += v;
          cnt++;
        }
        const mean = cnt ? sum / cnt : null;
        const first = preds[start]?.[dim];
        const last = preds[end - 1]?.[dim];
        const delta = (Number.isFinite(first) && Number.isFinite(last))
          ? (last - first)
          : null;

        const conf = appState.predictions?.confidence;
        return { min, max, mean, last, delta, conf };
      }

      function statCard(label, value, extraClass = "") {
        return `
        <div class="bg-white/70 backdrop-blur border border-slate-200 rounded-2xl p-3 shadow-sm ${extraClass}">
          <div class="text-[10px] font-extrabold uppercase tracking-widest text-slate-500">${
          escapeHtml(label)
        }</div>
          <div class="mt-1 font-extrabold tabular-nums">${
          escapeHtml(value)
        }</div>
        </div>
      `;
      }

      function updateStatsBar() {
        if (appState.vizMode !== "focus" || !appState.predictions) {
          return;
        }
        const dim = clamp(
          appState.selectedDim,
          0,
          (appState.nDimensions || 1) - 1,
        );
        const s = computeStatsForDim(dim);
        if (!s) return;

        const trendUp = Number.isFinite(s.delta) && s.delta >= 0;
        const trendTxt = Number.isFinite(s.delta)
          ? `${trendUp ? "‚Üë" : "‚Üì"} ${Math.abs(s.delta)}`
          : "‚Äî";
        const trendClass = trendUp
          ? "text-emerald-700"
          : "text-red-700";

        const confPct = (s.conf !== undefined && s.conf !== null &&
            Number.isFinite(s.conf))
          ? `${Math.round(s.conf * 100)}%`
          : "‚Äî";

        $("statsBar").innerHTML = [
          statCard(
            "Min value",
            Number.isFinite(s.min) ? String(s.min) : "‚Äî",
          ),
          statCard(
            "Max value",
            Number.isFinite(s.max) ? String(s.max) : "‚Äî",
          ),
          statCard(
            "Mean value",
            Number.isFinite(s.mean) ? String(s.mean) : "‚Äî",
          ),
          statCard(
            "Final value",
            Number.isFinite(s.last) ? String(s.last) : "‚Äî",
          ),
          `<div class="bg-white/70 backdrop-blur border border-slate-200 rounded-2xl p-3 shadow-sm">
          <div class="text-[10px] font-extrabold uppercase tracking-widest text-slate-500">Trend</div>
          <div class="mt-1 font-extrabold tabular-nums ${trendClass}">${
            escapeHtml(trendTxt)
          }</div>
        </div>`,
          statCard("Confidence", confPct),
        ].join("");
      }

      // =========================
      // Export
      // =========================
      $("savePngBtn").addEventListener("click", () => {
        try {
          const url = canvas.toDataURL("image/png");
          downloadBlob(urlToBlob(url), "esn_chart.png");
          logEvent("success", "Saved PNG");
        } catch (err) {
          errorToast(err, "PNG export failed");
        }
      });

      $("saveSvgBtn").addEventListener("click", () => {
        try {
          const svg = buildSimpleSvg();
          downloadBlob(
            new Blob([svg], { type: "image/svg+xml" }),
            "esn_chart.svg",
          );
          logEvent("success", "Saved SVG");
        } catch (err) {
          errorToast(err, "SVG export failed");
        }
      });

      $("copyBtn").addEventListener("click", async () => {
        try {
          const url = canvas.toDataURL("image/png");
          const blob = urlToBlob(url);

          if (navigator.clipboard && window.ClipboardItem) {
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob }),
            ]);
            toast("success", "Copied image to clipboard");
            logEvent("success", "Copied chart to clipboard");
          } else {
            // fallback: copy data URL text
            await navigator.clipboard.writeText(url);
            toast(
              "warning",
              "Clipboard image unsupported. Copied data URL instead.",
              6000,
            );
            logEvent(
              "warning",
              "Copied data URL (image clipboard unsupported)",
            );
          }
        } catch (err) {
          errorToast(err, "Copy failed");
        }
      });

      function urlToBlob(dataUrl) {
        const [meta, b64] = dataUrl.split(",");
        const mime = (meta.match(/data:(.*);base64/) || [])[1] ||
          "application/octet-stream";
        const bin = atob(b64);
        const arr = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
        return new Blob([arr], { type: mime });
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      }

      function buildSimpleSvg() {
        if (!appState.predictions?.predictions?.length) {
          throw new Error("No predictions");
        }
        const preds = appState.predictions.predictions;

        const width = 1200, height = 600;
        const padL = 60, padR = 20, padT = 20, padB = 50;
        const start = appState.zoom.visibleStart || 0;
        const count = appState.zoom.visibleCount || preds.length;
        const end = Math.min(preds.length, start + count);

        const dims = appState.vizMode === "focus"
          ? [appState.selectedDim]
          : [...Array(appState.nDimensions).keys()];
        const lines = [];

        for (const d of dims) {
          const mm = seriesMinMax(
            d,
            start,
            end,
            preds,
            appState.predictions.lowerBounds,
            appState.predictions.upperBounds,
          );
          const n = end - start;
          let pts = "";
          for (let i = 0; i < n; i++) {
            const idx = start + i;
            const x = padL + (i / (n - 1)) * (width - padL - padR);
            const y = padT +
              (1 - ((preds[idx][d] - mm.min) / (mm.max - mm.min))) *
                (height - padT - padB);
            pts += `${x.toFixed(2)},${y.toFixed(2)} `;
          }
          lines.push(
            `<polyline fill="none" stroke="${
              DIM_COLORS[d % DIM_COLORS.length]
            }" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="${pts.trim()}" />`,
          );
        }

        return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <rect width="100%" height="100%" fill="#FFFFFF"/>
  <rect x="${padL}" y="${padT}" width="${
          width - padL - padR
        }" height="${
          height - padT - padB
        }" fill="#F8FAFC" stroke="#CBD5E1"/>
  ${lines.join("\n  ")}
  <text x="${padL}" y="${
          height - 16
        }" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono'" font-size="12" fill="#64748B">Steps ${start} ‚Üí ${
          end - 1
        }</text>
</svg>`;
      }

      // =========================
      // Core flows: create, train, predict, summary, save/load
      // =========================
      async function safeAsync(fn, context) {
        try {
          return await fn();
        } catch (err) {
          errorToast(err, context);
          throw err;
        }
      }

      async function createModelFlow() {
        showLoading("Creating model‚Ä¶");
        const rid = crypto.randomUUID();
        activeRequestId = rid;
        try {
          // init
          await sendToWorker("init", {});
          // create
          await sendToWorker("createModel", {
            config: appState.config,
          });

          appState.modelExists = true;
          appState.sampleCount = 0;
          appState.metrics = {
            samplesProcessed: 0,
            averageLoss: null,
            gradientNorm: null,
            driftDetected: false,
            sampleWeight: null,
          };
          renderModelStatus();
          renderMetrics();
          toast("success", "Model created");
          logEvent("success", "Model created");
        } catch (err) {
          throw err;
        } finally {
          hideLoading();
        }
      }

      async function trainOnDataset(coordinates) {
        if (!appState.modelExists) {
          toast("warning", "Create a model first");
          logEvent("warning", "Training blocked: no model");
          return;
        }
        if (!Array.isArray(coordinates) || coordinates.length < 2) {
          toast("error", "Dataset needs at least 2 coordinate rows");
          logEvent("error", "Invalid dataset length");
          return;
        }

        showLoading("Training online (fitOnline)‚Ä¶");
        const rid = crypto.randomUUID();
        activeRequestId = rid;

        try {
          // Train
          const data = await sendToWorker("train", {
            coordinates,
            chunkPairs: 64,
          });
          if (data?.metrics) {
            appState.metrics = { ...appState.metrics, ...data.metrics };
            renderMetrics();
          }
          appState.sampleCount = coordinates.length;
          renderModelStatus();
          toast(
            "success",
            `Training complete (${coordinates.length} steps)`,
          );
          logEvent(
            "success",
            `Training complete: ${coordinates.length} steps`,
          );
        } catch (err) {
          // If cancelled, we may get "Cancelled" as error
          const msg = err?.message || String(err);
          if (msg.toLowerCase().includes("cancel")) {
            toast("warning", "Operation cancelled", 5000);
            logEvent("warning", "Training cancelled");
          } else {
            throw err;
          }
        } finally {
          hideLoading();
        }
      }

      async function predictFlow(futureSteps) {
        if (!appState.modelExists) {
          toast("warning", "Create a model first");
          logEvent("warning", "Predict blocked: no model");
          return;
        }
        if (!Number.isFinite(futureSteps) || futureSteps < 1) {
          toast("error", "Future steps must be ‚â• 1");
          logEvent("error", "Invalid future steps");
          return;
        }

        showLoading("Generating forecast‚Ä¶");
        const rid = crypto.randomUUID();
        activeRequestId = rid;

        try {
          const data = await sendToWorker("predict", { futureSteps });
          appState.predictions = data.result;
          appState.nDimensions =
            data.result?.predictions?.[0]?.length || 0;

          // zoom init
          appState.zoom.visibleCount =
            appState.predictions.predictions.length;
          appState.zoom.visibleStart = 0;
          appState.zoom.level = 1;
          $("zoomBadge").textContent = "100%";

          updateVizVisibility();
          setVizMode(appState.vizMode || "grid");
          resetZoom();

          toast("success", `Predicted ${futureSteps} future steps`);
          logEvent(
            "success",
            `Prediction generated: ${futureSteps} steps`,
          );
        } catch (err) {
          const msg = err?.message || String(err);
          if (msg.toLowerCase().includes("cancel")) {
            toast("warning", "Operation cancelled", 5000);
            logEvent("warning", "Prediction cancelled");
          } else {
            throw err;
          }
        } finally {
          hideLoading();
        }
      }

      async function summaryFlow() {
        try {
          const data = await safeAsync(
            async () => sendToWorker("getSummary", {}),
            "Get summary failed",
          );
          const s = data.summary;
          toast(
            "info",
            `Params: ${s.totalParameters}, Reservoir: ${s.reservoirSize}, Samples: ${s.sampleCount}`,
            6000,
          );
          logEvent(
            "info",
            `Summary: params=${s.totalParameters}, reservoir=${s.reservoirSize}, samples=${s.sampleCount}`,
          );
        } catch (err) {
          // already handled
        }
      }

      // =========================
      // Header buttons
      // =========================
      $("predictBtn").addEventListener(
        "click",
        () => $("runPredictBtn").click(),
      );
      $("runPredictBtn").addEventListener("click", async () => {
        try {
          const steps = Number($("futureStepsInput").value);
          if (!Number.isFinite(steps) || steps < 1) {
            toast("error", "Future steps must be a positive integer");
            logEvent("error", "Invalid future steps input");
            return;
          }
          await predictFlow(Math.floor(steps));
        } catch (err) {
          errorToast(err, "Predict failed");
        }
      });

      $("summaryBtn").addEventListener("click", summaryFlow);

      // Empty state buttons
      $("startDefaultsBtn").addEventListener("click", async () => {
        try {
          appState.config = { ...DEFAULT_CONFIG };
          saveJSON(STORAGE_KEYS.config, appState.config);
          await createModelFlow();
        } catch (err) {
          errorToast(err, "Start with defaults failed");
        }
      });
      $("loadBtnEmpty").addEventListener("click", () => {
        renderSavedModels();
        openModal($("saveLoadModal"));
      });
      $("demoBtn").addEventListener("click", () => {
        openModal($("randomModal"));
      });

      // =========================
      // Upload modal logic
      // =========================
      let validatedDataset = null;

      function setValidationBox(ok, msg) {
        const box = $("validationBox");
        box.classList.remove("hidden");
        box.className = `p-4 rounded-3xl border ${
          ok
            ? "bg-emerald-50 border-emerald-200 text-emerald-900"
            : "bg-red-50 border-red-200 text-red-900"
        }`;
        box.textContent = msg;
      }

      function parseDataset(raw) {
        const obj = JSON.parse(raw);
        const coords = obj?.coordinates;
        if (!Array.isArray(coords)) {
          throw new Error("Missing 'coordinates' array");
        }
        if (coords.length < 2) {
          throw new Error("coordinates must have at least 2 rows");
        }
        const dims = coords[0]?.length;
        if (!Number.isInteger(dims) || dims < 1) {
          throw new Error(
            "Each coordinate row must be a non-empty array",
          );
        }
        for (let i = 0; i < coords.length; i++) {
          if (!Array.isArray(coords[i]) || coords[i].length !== dims) {
            throw new Error(`Row ${i} must have ${dims} values`);
          }
          for (let d = 0; d < dims; d++) {
            const v = coords[i][d];
            if (!Number.isFinite(Number(v))) {
              throw new Error(`Row ${i}, dim ${d} is not a number`);
            }
            coords[i][d] = Number(v);
          }
        }
        return {
          coordinates: coords,
          nDimensions: dims,
          steps: coords.length,
        };
      }

      function openUpload() {
        validatedDataset = null;
        $("applyTrainBtn").disabled = true;
        $("validationBox").classList.add("hidden");
        openModal($("uploadModal"));
      }
      $("menuUploadDataset").addEventListener("click", () => {
        closeMenu();
        openUpload();
      });

      $("uploadCancelBtn").addEventListener(
        "click",
        () => closeModal($("uploadModal")),
      );
      $("uploadCloseX").addEventListener(
        "click",
        () => closeModal($("uploadModal")),
      );

      $("dropZone").addEventListener(
        "click",
        () => $("fileInput").click(),
      );
      $("dropZone").addEventListener("dragover", (e) => {
        e.preventDefault();
      });
      $("dropZone").addEventListener("drop", async (e) => {
        e.preventDefault();
        const f = e.dataTransfer?.files?.[0];
        if (!f) return;
        await readFileToTextarea(f);
      });

      $("fileInput").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        await readFileToTextarea(f);
      });

      async function readFileToTextarea(file) {
        try {
          const text = await file.text();
          $("jsonTextarea").value = text;
          setValidationBox(true, `Loaded file: ${file.name}`);
          logEvent("info", `Dataset file loaded: ${file.name}`);
        } catch (err) {
          errorToast(err, "Failed to read file");
        }
      }

      $("pasteClearBtn").addEventListener("click", () => {
        $("jsonTextarea").value = "";
        $("validationBox").classList.add("hidden");
        validatedDataset = null;
        $("applyTrainBtn").disabled = true;
      });

      $("exampleToggle").addEventListener("click", () => {
        const body = $("exampleBody");
        const open = body.classList.contains("hidden");
        body.classList.toggle("hidden", !open);
        $("exampleChev").textContent = open ? "‚ñ≤" : "‚ñº";
      });

      $("copyExampleBtn").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(
            $("exampleCode").textContent,
          );
          toast("success", "Example copied");
          logEvent("success", "Copied dataset format example");
        } catch (err) {
          errorToast(err, "Copy example failed");
        }
      });

      $("validateBtn").addEventListener("click", () => {
        try {
          const raw = $("jsonTextarea").value.trim();
          if (!raw) {
            setValidationBox(
              false,
              "Paste JSON or upload a file first.",
            );
            validatedDataset = null;
            $("applyTrainBtn").disabled = true;
            return;
          }
          const parsed = parseDataset(raw);
          validatedDataset = parsed;
          setValidationBox(
            true,
            `Valid ‚úÖ Dimensions: ${parsed.nDimensions}, Steps: ${parsed.steps}`,
          );
          $("applyTrainBtn").disabled = false;
          logEvent(
            "success",
            `Dataset validated: dims=${parsed.nDimensions}, steps=${parsed.steps}`,
          );
        } catch (err) {
          validatedDataset = null;
          $("applyTrainBtn").disabled = true;
          setValidationBox(false, err.message || String(err));
          logEvent(
            "error",
            `Dataset validation failed: ${err.message || String(err)}`,
          );
          toast("error", "Dataset validation failed");
        }
      });

      $("applyTrainBtn").addEventListener("click", async () => {
        try {
          if (!validatedDataset) {
            toast("error", "Validate the dataset first");
            return;
          }
          appState.dataset = validatedDataset.coordinates;

          // Create model if none
          if (!appState.modelExists) {
            await createModelFlow();
          }
          await trainOnDataset(appState.dataset);
          closeModal($("uploadModal"));
        } catch (err) {
          errorToast(err, "Apply & train failed");
        }
      });

      // =========================
      // Save & Load modal logic
      // =========================
      function getSavedIndex() {
        return loadJSON(STORAGE_KEYS.savedModelsIndex, []);
      }
      function setSavedIndex(arr) {
        saveJSON(STORAGE_KEYS.savedModelsIndex, arr);
      }

      function renderSavedModels() {
        const host = $("savedModelsList");
        const idx = getSavedIndex();
        host.innerHTML = "";
        if (!idx.length) {
          host.innerHTML =
            `<div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 text-sm text-slate-600">No saved models yet.</div>`;
          return;
        }
        for (const item of idx) {
          const row = document.createElement("div");
          row.className =
            "p-3 rounded-2xl border border-slate-200 bg-white flex items-center justify-between gap-2";
          row.innerHTML = `
          <div class="min-w-0">
            <div class="font-extrabold truncate">${
            escapeHtml(item.name)
          }</div>
            <div class="text-xs text-slate-500 tabular-nums">dims: ${
            item.nDimensions || "?"
          } ¬∑ saved: ${new Date(item.ts).toLocaleString()}</div>
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="loadBtn px-3 py-2 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold" aria-label="Load saved model">Load</button>
            <button class="delBtn px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 font-bold" aria-label="Delete saved model">Delete</button>
          </div>
        `;
          row.querySelector(".loadBtn").addEventListener(
            "click",
            async () => {
              try {
                const raw = localStorage.getItem(
                  STORAGE_KEYS.savedModelPrefix + item.id,
                );
                if (!raw) throw new Error("Saved model missing");
                const obj = JSON.parse(raw);

                showLoading("Loading model‚Ä¶");
                activeRequestId = crypto.randomUUID();
                await sendToWorker("init", {});
                appState.config = obj.config || appState.config;
                saveJSON(STORAGE_KEYS.config, appState.config);

                await sendToWorker("createModel", {
                  config: appState.config,
                });
                await sendToWorker("load", {
                  state: obj.state,
                  config: appState.config,
                });

                appState.modelExists = true;
                appState.sampleCount = obj.sampleCount || 0;
                appState.nDimensions = obj.nDimensions || 0;

                renderModelStatus();
                toast("success", `Loaded: ${item.name}`);
                logEvent("success", `Loaded model: ${item.name}`);

                closeModal($("saveLoadModal"));
              } catch (err) {
                errorToast(err, "Load failed");
              } finally {
                hideLoading();
              }
            },
          );

          row.querySelector(".delBtn").addEventListener("click", () => {
            try {
              const idx2 = getSavedIndex().filter((x) =>
                x.id !== item.id
              );
              setSavedIndex(idx2);
              localStorage.removeItem(
                STORAGE_KEYS.savedModelPrefix + item.id,
              );
              renderSavedModels();
              toast("info", `Deleted: ${item.name}`);
              logEvent("info", `Deleted saved model: ${item.name}`);
            } catch (err) {
              errorToast(err, "Delete failed");
            }
          });

          host.appendChild(row);
        }
      }

      $("menuSaveLoad").addEventListener("click", () => {
        closeMenu();
        renderSavedModels();
        openModal($("saveLoadModal"));
      });
      $("saveLoadCancelBtn").addEventListener(
        "click",
        () => closeModal($("saveLoadModal")),
      );
      $("saveLoadCloseX").addEventListener(
        "click",
        () => closeModal($("saveLoadModal")),
      );

      $("downloadModelBtn").addEventListener("click", async () => {
        try {
          showLoading("Saving model‚Ä¶");
          activeRequestId = crypto.randomUUID();
          const data = await sendToWorker("save", {});
          const payload = {
            schema: "esnStudio.model.v1",
            ts: new Date().toISOString(),
            config: appState.config,
            sampleCount: appState.sampleCount,
            nDimensions: appState.nDimensions,
            state: data.state,
          };
          downloadBlob(
            new Blob([JSON.stringify(payload, null, 2)], {
              type: "application/json",
            }),
            "esn_model.json",
          );
          toast("success", "Model downloaded");
          logEvent("success", "Downloaded model JSON");
        } catch (err) {
          errorToast(err, "Download failed");
        } finally {
          hideLoading();
        }
      });

      $("saveBrowserBtn").addEventListener("click", async () => {
        try {
          const name = prompt(
            "Name this model:",
            `ESN_${new Date().toLocaleString()}`,
          ) || "";
          if (!name.trim()) {
            toast("warning", "Save cancelled");
            return;
          }
          showLoading("Saving to browser‚Ä¶");
          activeRequestId = crypto.randomUUID();

          const data = await sendToWorker("save", {});
          const id = crypto.randomUUID();
          const payload = {
            schema: "esnStudio.model.v1",
            ts: new Date().toISOString(),
            config: appState.config,
            sampleCount: appState.sampleCount,
            nDimensions: appState.nDimensions,
            state: data.state,
          };
          localStorage.setItem(
            STORAGE_KEYS.savedModelPrefix + id,
            JSON.stringify(payload),
          );
          const idx = getSavedIndex();
          idx.unshift({
            id,
            name: name.trim(),
            ts: payload.ts,
            nDimensions: payload.nDimensions,
            sampleCount: payload.sampleCount,
          });
          setSavedIndex(idx.slice(0, 50));
          renderSavedModels();
          toast("success", "Saved to browser");
          logEvent("success", `Saved model to browser: ${name.trim()}`);
        } catch (err) {
          errorToast(err, "Browser save failed");
        } finally {
          hideLoading();
        }
      });

      $("loadZone").addEventListener(
        "click",
        () => $("modelFileInput").click(),
      );
      $("modelFileInput").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try {
          const text = await f.text();
          const obj = JSON.parse(text);
          if (!obj?.state) {
            throw new Error("Invalid model JSON: missing state");
          }

          showLoading("Loading model file‚Ä¶");
          activeRequestId = crypto.randomUUID();
          await sendToWorker("init", {});
          appState.config = obj.config || appState.config;
          saveJSON(STORAGE_KEYS.config, appState.config);

          await sendToWorker("createModel", {
            config: appState.config,
          });
          await sendToWorker("load", {
            state: obj.state,
            config: appState.config,
          });

          appState.modelExists = true;
          appState.sampleCount = obj.sampleCount || 0;
          appState.nDimensions = obj.nDimensions || 0;

          renderModelStatus();
          toast("success", "Model loaded from file");
          logEvent("success", `Loaded model from file: ${f.name}`);
          closeModal($("saveLoadModal"));
        } catch (err) {
          errorToast(err, "Model file load failed");
        } finally {
          hideLoading();
        }
      });

      // =========================
      // Random test generation
      // =========================
      function mulberry32(seed) {
        let a = seed >>> 0;
        return () => {
          a |= 0;
          a = a + 0x6D2B79F5 | 0;
          let t = Math.imul(a ^ a >>> 15, 1 | a);
          t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
      }

      function generateSynthetic(
        { seed, dims, steps, noise, outliersRate, difficulty },
      ) {
        const rnd = mulberry32(seed);
        const coords = [];
        const baseFreq = difficulty === "Easy"
          ? 0.04
          : (difficulty === "Medium" ? 0.07 : 0.11);
        const drift = difficulty === "Hard"
          ? 0.004
          : (difficulty === "Medium" ? 0.002 : 0.001);

        // random phase + weights per dim
        const phase = Array.from(
          { length: dims },
          () => rnd() * Math.PI * 2,
        );
        const amp = Array.from(
          { length: dims },
          () => 0.8 + rnd() * 1.8,
        );

        for (let t = 0; t < steps; t++) {
          const row = [];
          for (let d = 0; d < dims; d++) {
            const signal =
              amp[d] * Math.sin(baseFreq * (t + 1) + phase[d]) +
              0.5 * Math.cos(baseFreq * 0.5 * (t + 1) + phase[d] * 0.7);
            const trend = drift * t * (d % 2 === 0 ? 1 : -1);
            const n = (rnd() * 2 - 1) * noise;
            let v = signal + trend + n;

            if (rnd() < outliersRate) {
              const spike = (rnd() * 2 - 1) *
                (difficulty === "Hard" ? 6 : 4);
              v += spike;
            }
            row.push(v);
          }
          coords.push(row);
        }
        return coords;
      }

      function openRandom() {
        openModal($("randomModal"));
      }
      $("menuRandomTest").addEventListener("click", () => {
        closeMenu();
        openRandom();
      });
      $("randomCancelBtn").addEventListener(
        "click",
        () => closeModal($("randomModal")),
      );
      $("randomCloseX").addEventListener(
        "click",
        () => closeModal($("randomModal")),
      );

      $("generateRunBtn").addEventListener("click", async () => {
        try {
          const seed = Number($("randSeed").value);
          const dims = Number($("randDims").value);
          const steps = Number($("randSteps").value);
          const noise = Number($("randNoise").value);
          const outliersRate = Number($("randOutliers").value);
          const difficulty = $("randDifficulty").value;

          if (!Number.isInteger(seed)) {
            throw new Error("Seed must be an integer");
          }
          if (!Number.isInteger(dims) || dims < 1) {
            throw new Error("Dimensions must be an integer ‚â• 1");
          }
          if (!Number.isInteger(steps) || steps < 10) {
            throw new Error("Time steps must be an integer ‚â• 10");
          }
          if (!Number.isFinite(noise) || noise < 0) {
            throw new Error("Noise must be ‚â• 0");
          }
          if (
            !Number.isFinite(outliersRate) || outliersRate < 0 ||
            outliersRate > 1
          ) throw new Error("Outliers rate must be in [0,1]");

          const coords = generateSynthetic({
            seed,
            dims,
            steps,
            noise,
            outliersRate,
            difficulty,
          });
          appState.dataset = coords;
          logEvent(
            "info",
            `Synthetic dataset generated: dims=${dims}, steps=${steps}, difficulty=${difficulty}`,
          );

          // Create model if needed
          if (!appState.modelExists) {
            await createModelFlow();
          }
          await trainOnDataset(coords);

          // Predict a reasonable horizon
          const future = Math.max(
            20,
            Math.min(200, Math.round(steps * 0.25)),
          );
          $("futureStepsInput").value = String(future);
          await predictFlow(future);

          closeModal($("randomModal"));
        } catch (err) {
          errorToast(err, "Generate & run failed");
        }
      });

      // =========================
      // Data table modal
      // =========================
      let tableSort = { key: "Step", dir: 1 }; // dir: 1 asc, -1 desc

      function openTable() {
        if (!appState.predictions?.predictions?.length) {
          toast("warning", "No predictions to display");
          logEvent("warning", "Data table blocked: no predictions");
          return;
        }
        buildTable();
        openModal($("tableModal"));
      }
      $("menuDataTable").addEventListener("click", () => {
        closeMenu();
        openTable();
      });
      $("tableCloseX").addEventListener(
        "click",
        () => closeModal($("tableModal")),
      );

      $("tableSearch").addEventListener("input", buildTable);

      $("exportCsvBtn").addEventListener("click", () => {
        try {
          const csv = buildCsv();
          downloadBlob(
            new Blob([csv], { type: "text/csv" }),
            "esn_predictions.csv",
          );
          toast("success", "CSV exported");
          logEvent("success", "Exported CSV");
        } catch (err) {
          errorToast(err, "CSV export failed");
        }
      });

      $("copyAllBtn").addEventListener("click", async () => {
        try {
          const csv = buildCsv();
          await navigator.clipboard.writeText(csv);
          toast("success", "Copied table to clipboard");
          logEvent("success", "Copied CSV to clipboard");
        } catch (err) {
          errorToast(err, "Copy all failed");
        }
      });

      function buildCsv() {
        const P = appState.predictions.predictions;
        const L = appState.predictions.lowerBounds;
        const U = appState.predictions.upperBounds;
        const dims = appState.nDimensions || P[0].length;

        const cols = [
          "Step",
          ...Array.from({ length: dims }, (_, i) => `P${i + 1}`),
          ...Array.from({ length: dims }, (_, i) => `L${i + 1}`),
          ...Array.from({ length: dims }, (_, i) => `U${i + 1}`),
        ];
        const lines = [cols.join(",")];
        for (let t = 0; t < P.length; t++) {
          const row = [t];
          for (let d = 0; d < dims; d++) row.push(P[t][d]);
          for (let d = 0; d < dims; d++) row.push(L?.[t]?.[d]);
          for (let d = 0; d < dims; d++) row.push(U?.[t]?.[d]);
          lines.push(row.join(","));
        }
        return lines.join("\n");
      }

      function buildTable() {
        const P = appState.predictions?.predictions;
        if (!P?.length) return;

        const L = appState.predictions.lowerBounds;
        const U = appState.predictions.upperBounds;
        const dims = appState.nDimensions || P[0].length;

        const headRow = $("tableHeadRow");
        headRow.innerHTML = "";

        const headers = [
          "Step",
          ...Array.from({ length: dims }, (_, i) => `P${i + 1}`),
          ...Array.from({ length: dims }, (_, i) => `L${i + 1}`),
          ...Array.from({ length: dims }, (_, i) => `U${i + 1}`),
        ];

        for (const h of headers) {
          const th = document.createElement("th");
          th.className =
            "text-left px-3 py-3 whitespace-nowrap cursor-pointer select-none";
          th.innerHTML = `<span class="font-extrabold">${
            escapeHtml(h)
          }</span>${
            tableSort.key === h
              ? `<span class="ml-2 text-slate-500">${
                tableSort.dir === 1 ? "‚ñ≤" : "‚ñº"
              }</span>`
              : ""
          }`;
          th.addEventListener("click", () => {
            if (tableSort.key === h) tableSort.dir *= -1;
            else tableSort = { key: h, dir: 1 };
            buildTable();
          });
          headRow.appendChild(th);
        }

        // Build rows
        const q = $("tableSearch").value.trim().toLowerCase();

        const rows = [];
        for (let t = 0; t < P.length; t++) {
          const row = { Step: t };
          for (let d = 0; d < dims; d++) row[`P${d + 1}`] = P[t][d];
          for (let d = 0; d < dims; d++) row[`L${d + 1}`] = L?.[t]?.[d];
          for (let d = 0; d < dims; d++) row[`U${d + 1}`] = U?.[t]?.[d];
          rows.push(row);
        }

        // Filter
        const filtered = !q ? rows : rows.filter((r) => {
          if (String(r.Step).includes(q)) return true;
          for (const k of Object.keys(r)) {
            if (k === "Step") continue;
            if (String(r[k]).toLowerCase().includes(q)) return true;
          }
          return false;
        });

        // Sort
        const key = tableSort.key;
        filtered.sort((a, b) => {
          const av = a[key], bv = b[key];
          const an = Number(av), bn = Number(bv);
          const cmp = (Number.isFinite(an) && Number.isFinite(bn))
            ? (an - bn)
            : String(av).localeCompare(String(bv));
          return cmp * tableSort.dir;
        });

        const body = $("tableBody");
        body.innerHTML = "";
        for (let i = 0; i < filtered.length; i++) {
          const r = filtered[i];
          const tr = document.createElement("tr");
          tr.className = `border-b border-slate-200 ${
            i % 2 === 0 ? "bg-white" : "bg-slate-50"
          } hover:bg-amber-50`;
          tr.innerHTML = headers.map((h) =>
            `<td class="px-3 py-2 whitespace-nowrap">${
              escapeHtml(r[h])
            }</td>`
          ).join("");
          body.appendChild(tr);
        }
      }

      // =========================
      // Menu actions
      // =========================
      $("menuCreateConfigure").addEventListener("click", () => {
        closeMenu();
        renderConfigForm();
        renderCollapses();
        openModal($("configModal"));
      });

      // =========================
      // Dataset: menu open upload
      // =========================
      // already wired

      // =========================
      // Menu open table
      // =========================
      // already wired

      // =========================
      // Upload & Train shortcut: Predict button should exist when model exists
      // =========================

      // =========================
      // Init & UI bootstrap
      // =========================
      function initUI() {
        renderModelStatus();
        renderMetrics();
        renderLog();

        // Viz mode
        setVizMode(appState.vizMode || "grid");

        // Config
        renderConfigForm();
        renderCollapses();

        // If worker is available, init it
        setupWorker();
        sendToWorker("init", {}).then(() => {
          logEvent("info", "Worker initialized");
        }).catch((err) => {
          appState.workerOk = false;
          errorToast(err, "Worker init failed");
        });

        // Predict input validation
        $("futureStepsInput").addEventListener("input", () => {
          const v = Number($("futureStepsInput").value);
          if (!Number.isFinite(v) || v < 1) {
            $("futureStepsInput").classList.add("border-red-300");
          } else {
            $("futureStepsInput").classList.remove("border-red-300");
          }
        });
      }

      initUI();

      // Menu shortcuts for modals with focus mgmt
      $("menuUploadDataset").addEventListener("click", () => {});
      $("menuRandomTest").addEventListener("click", () => {});
      $("menuDataTable").addEventListener("click", () => {});
      $("menuSaveLoad").addEventListener("click", () => {});

      // Also open modals from anywhere
      // Config already, SaveLoad from empty state
      $("loadBtnEmpty").addEventListener("click", () => {
        renderSavedModels();
        openModal($("saveLoadModal"));
      });

      // Upload from menu only (per spec), but you can add keyboard triggers if needed

      // Close modals when clicking backdrop (accessibility)
      $("modalBackdrop").addEventListener("click", () => {
        // close topmost modal in priority order
        const ids = [
          "tableModal",
          "randomModal",
          "saveLoadModal",
          "uploadModal",
          "configModal",
        ];
        for (const id of ids) {
          const el = $(id);
          if (el && !el.classList.contains("hidden")) {
            closeModal(el);
            break;
          }
        }
      });

      // ESC to close modals/menu
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          // Close modal if any
          const ids = [
            "tableModal",
            "randomModal",
            "saveLoadModal",
            "uploadModal",
            "configModal",
          ];
          for (const id of ids) {
            const el = $(id);
            if (el && !el.classList.contains("hidden")) {
              closeModal(el);
              e.preventDefault();
              return;
            }
          }
          // Close menu
          if (!$("menuBackdrop").classList.contains("hidden")) {
            closeMenu();
            e.preventDefault();
            return;
          }
        }
      });

      // Menu -> Upload dataset
      $("menuUploadDataset").addEventListener("click", () => {});

      // Expose quick open of upload from console if needed:
      // window.openUpload = openUpload;

      // Start menu actions to open upload now:
      // (wiring above already calls openUpload())
      // done

      // =========================
      // Wiring missing: menuUploadDataset open upload
      // =========================
      // (already wired earlier via menuUploadDataset listener)
      // ensure it's defined
      // done

      // =========================
      // Predict workflow for better UX: if no dataset trained, allow prediction but warn
      // =========================
      $("predictBtn").addEventListener("click", () => {
        if (appState.sampleCount < 2) {
          toast(
            "warning",
            "Model has not been trained yet. Upload or generate data first.",
            6000,
          );
          logEvent("warning", "Prediction requested before training");
        }
      });

      // =========================
      // Menu: Upload dataset button (final binding)
      // =========================
      // Already exists; just to ensure no duplication issues
    </script>
  </body>
</html>
