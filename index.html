<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwindcss.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "Inter",
                "system-ui",
                "-apple-system",
                "sans-serif",
              ],
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    >
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 font-sans transition-colors duration-300"
  >
    <!-- Header -->
    <header
      id="header"
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/50 dark:border-slate-700/50"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 sm:h-20">
          <!-- Left Section -->
          <div class="flex items-center gap-3 sm:gap-4">
            <div
              class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg shadow-blue-500/30 flex items-center justify-center text-xl sm:text-2xl"
            >
              üìä
            </div>
            <div class="hidden sm:block">
              <h1
                class="text-lg sm:text-xl font-bold text-slate-800 dark:text-slate-100"
              >
                ESN Studio
              </h1>
              <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">
                Autoregressive Forecasting
              </p>
            </div>
            <h1
              class="sm:hidden text-lg font-bold text-slate-800 dark:text-slate-100"
            >
              ESN Studio
            </h1>
          </div>

          <!-- Right Section -->
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- Model Status Badge -->
            <div
              id="modelStatus"
              class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-sm"
            >
              <span
                id="statusDot"
                class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
              ></span>
              <span id="statusText" class="text-slate-600 dark:text-slate-300"
              >No Model</span>
            </div>

            <!-- Predict Button -->
            <button
              id="predictBtn"
              class="hidden min-w-[44px] min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 transition-all items-center gap-2"
              aria-label="Run prediction"
            >
              <span>‚ö°</span>
              <span class="hidden sm:inline">Predict</span>
            </button>

            <!-- Configure Button -->
            <button
              id="configBtn"
              class="min-w-[44px] min-h-[44px] p-2 sm:p-3 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-xl"
              aria-label="Configure model"
            >
              ‚öôÔ∏è
            </button>

            <!-- Menu Button -->
            <button
              id="menuBtn"
              class="min-w-[44px] min-h-[44px] p-2 sm:p-3 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-xl"
              aria-label="Open menu"
            >
              ‚ò∞
            </button>

            <!-- Theme Toggle -->
            <button
              id="themeBtn"
              class="min-w-[44px] min-h-[44px] p-2 sm:p-3 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors text-xl"
              aria-label="Toggle theme"
            >
              <span class="dark:hidden">üåô</span>
              <span class="hidden dark:inline">‚òÄÔ∏è</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Visualization Area -->
        <div class="flex-1 min-w-0">
          <!-- Tab Navigation -->
          <div class="mb-4 overflow-x-auto scrollbar-hide">
            <div class="flex gap-2 min-w-max pb-2">
              <button
                data-mode="grid"
                class="viz-tab min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
                aria-label="Small Multiples view"
              >
                <span>üìä</span>
                <span class="hidden sm:inline">Grid</span>
              </button>
              <button
                data-mode="focus"
                class="viz-tab min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
                aria-label="Focus view"
              >
                <span>üîç</span>
                <span class="hidden sm:inline">Focus</span>
              </button>
              <button
                data-mode="heatmap"
                class="viz-tab min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
                aria-label="Heatmap view"
              >
                <span>üå°Ô∏è</span>
                <span class="hidden sm:inline">Heatmap</span>
              </button>
              <button
                data-mode="uncertainty"
                class="viz-tab min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
                aria-label="Uncertainty view"
              >
                <span>üìà</span>
                <span class="hidden sm:inline">CI</span>
              </button>
              <button
                data-mode="snapshot"
                class="viz-tab min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
                aria-label="Snapshot view"
              >
                <span>üì∑</span>
                <span class="hidden sm:inline">Snapshot</span>
              </button>
            </div>
          </div>

          <!-- Dimension Selector (Focus Mode) -->
          <div
            id="dimSelector"
            class="hidden mb-4 overflow-x-auto scrollbar-hide"
          >
            <div id="dimButtons" class="flex gap-2 min-w-max pb-2">
              <!-- Populated dynamically -->
            </div>
          </div>

          <!-- Step Selector (Snapshot Mode) -->
          <div id="stepSelector" class="hidden mb-4 flex items-center gap-3">
            <label class="font-medium text-slate-700 dark:text-slate-300"
            >Step:</label>
            <input
              type="number"
              id="stepInput"
              min="1"
              value="1"
              class="min-h-[44px] w-24 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-slate-200 font-medium"
              aria-label="Select step"
            >
          </div>

          <!-- Chart Container -->
          <div
            class="relative bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
          >
            <!-- Floating Controls -->
            <div
              id="floatingControls"
              class="hidden absolute top-3 right-3 z-10 flex gap-2"
            >
              <button
                id="zoomInBtn"
                class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-white/90 dark:bg-slate-700/90 shadow-lg backdrop-blur text-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
                aria-label="Zoom in"
              >
                ‚ûï
              </button>
              <button
                id="zoomOutBtn"
                class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-white/90 dark:bg-slate-700/90 shadow-lg backdrop-blur text-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
                aria-label="Zoom out"
              >
                ‚ûñ
              </button>
              <button
                id="resetZoomBtn"
                class="min-w-[44px] min-h-[44px] p-2 rounded-xl bg-white/90 dark:bg-slate-700/90 shadow-lg backdrop-blur text-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
                aria-label="Reset zoom"
              >
                üîÑ
              </button>
            </div>

            <!-- Zoom Level Badge -->
            <div
              id="zoomBadge"
              class="hidden absolute top-3 left-3 z-10 px-3 py-1.5 rounded-full bg-white/90 dark:bg-slate-700/90 shadow-lg backdrop-blur text-sm font-medium text-slate-700 dark:text-slate-300"
            >
              100%
            </div>

            <!-- Canvas -->
            <canvas
              id="mainCanvas"
              class="w-full touch-none"
              style="height: 400px"
            ></canvas>

            <!-- Loading Overlay -->
            <div
              id="loadingOverlay"
              class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4 z-20"
            >
              <div
                class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"
              >
              </div>
              <p
                id="loadingText"
                class="text-lg font-medium text-slate-700 dark:text-slate-300"
              >
                Processing...
              </p>
              <div
                class="w-64 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"
              >
                <div
                  id="progressBar"
                  class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full transition-all"
                  style="width: 0%"
                >
                </div>
              </div>
              <p
                id="progressText"
                class="text-sm text-slate-500 dark:text-slate-400"
              >
                0%
              </p>
              <button
                id="cancelBtn"
                class="min-h-[44px] px-4 py-2 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
                aria-label="Cancel operation"
              >
                Cancel
              </button>
            </div>

            <!-- Empty State -->
            <div
              id="emptyState"
              class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center"
            >
              <div class="relative mb-6">
                <div
                  class="w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 flex items-center justify-center"
                >
                  <div
                    class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-200 to-indigo-200 dark:from-blue-800/50 dark:to-indigo-800/50 flex items-center justify-center"
                  >
                    <span class="text-4xl">üìä</span>
                  </div>
                </div>
              </div>
              <h3
                class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2"
              >
                Create a Model to Begin
              </h3>
              <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-md">
                ESN autoregressive forecasting enables powerful time series
                prediction with uncertainty quantification.
              </p>
              <div class="flex flex-wrap justify-center gap-3">
                <button
                  id="startDefaultsBtn"
                  class="min-h-[44px] px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/30 hover:shadow-xl transition-all flex items-center gap-2"
                  aria-label="Start with defaults"
                >
                  <span>‚ö°</span>
                  <span>Start with Defaults</span>
                </button>
                <button
                  id="loadModelBtn"
                  class="min-h-[44px] px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2"
                  aria-label="Load model"
                >
                  <span>üì§</span>
                  <span>Load</span>
                </button>
                <button
                  id="demoBtn"
                  class="min-h-[44px] px-6 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg shadow-purple-500/30 hover:shadow-xl transition-all flex items-center gap-2"
                  aria-label="Run demo"
                >
                  <span>‚ú®</span>
                  <span>Demo</span>
                </button>
              </div>
            </div>

            <!-- Tooltip -->
            <div
              id="tooltip"
              class="hidden absolute z-30 px-4 py-3 rounded-xl bg-slate-900/95 dark:bg-slate-800/95 text-white shadow-2xl backdrop-blur pointer-events-none min-w-[180px]"
            >
              <div id="tooltipStep" class="text-lg font-bold mb-1">Step 1</div>
              <div id="tooltipDim" class="flex items-center gap-2 mb-2">
                <span id="tooltipDimDot" class="w-3 h-3 rounded-full"></span>
                <span id="tooltipDimName" class="text-slate-300"
                >Dimension 1</span>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between gap-4">
                  <span class="text-slate-400">Predicted:</span>
                  <span id="tooltipValue" class="font-semibold">0.000</span>
                </div>
                <div class="flex justify-between gap-4">
                  <span class="text-slate-400">CI:</span>
                  <span id="tooltipCI" class="text-slate-300"
                  >0.000 - 0.000</span>
                </div>
                <div class="flex justify-between gap-4">
                  <span class="text-slate-400">Spread:</span>
                  <span id="tooltipSpread" class="text-slate-300">0.000</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Statistics Bar (Focus Mode) -->
          <div
            id="statsBar"
            class="hidden mt-4 grid grid-cols-3 sm:grid-cols-6 gap-3"
          >
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Min
              </p>
              <p
                id="statMin"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Max
              </p>
              <p
                id="statMax"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Mean
              </p>
              <p
                id="statMean"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Final
              </p>
              <p
                id="statFinal"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Trend
              </p>
              <p
                id="statTrend"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
            <div
              class="p-3 rounded-xl bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-slate-200/50 dark:border-slate-700/50"
            >
              <p
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1"
              >
                Confidence
              </p>
              <p
                id="statConfidence"
                class="text-lg font-bold text-slate-800 dark:text-slate-100"
              >
                -
              </p>
            </div>
          </div>

          <!-- Export Controls -->
          <div id="exportControls" class="hidden mt-4 flex flex-wrap gap-3">
            <button
              id="exportPNG"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2"
              aria-label="Save as PNG"
            >
              <span>üñºÔ∏è</span>
              <span>PNG</span>
            </button>
            <button
              id="exportSVG"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2"
              aria-label="Save as SVG"
            >
              <span>üìÑ</span>
              <span>SVG</span>
            </button>
            <button
              id="exportClipboard"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2"
              aria-label="Copy to clipboard"
            >
              <span>üìã</span>
              <span>Copy</span>
            </button>
          </div>
        </div>

        <!-- Side Panel (Desktop) -->
        <aside id="sidePanel" class="hidden lg:block w-80 flex-shrink-0">
          <div class="sticky top-24 space-y-6">
            <!-- Model Metrics -->
            <div
              class="bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-5"
            >
              <h2
                class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4"
              >
                Model Metrics
              </h2>
              <div class="space-y-3">
                <div
                  class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
                >
                  <span class="text-slate-600 dark:text-slate-400"
                  >Samples Trained</span>
                  <span
                    id="metricSamples"
                    class="font-semibold text-blue-600 dark:text-blue-400"
                  >0</span>
                </div>
                <div
                  class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
                >
                  <span class="text-slate-600 dark:text-slate-400"
                  >Avg Loss</span>
                  <span
                    id="metricLoss"
                    class="font-semibold text-slate-800 dark:text-slate-200"
                  >-</span>
                </div>
                <div
                  class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
                >
                  <span class="text-slate-600 dark:text-slate-400"
                  >Gradient Norm</span>
                  <span
                    id="metricGradient"
                    class="font-semibold text-slate-800 dark:text-slate-200"
                  >-</span>
                </div>
                <div class="flex justify-between items-center py-2">
                  <span class="text-slate-600 dark:text-slate-400"
                  >Sample Weight</span>
                  <span
                    id="metricWeight"
                    class="font-semibold text-slate-800 dark:text-slate-200"
                  >-</span>
                </div>
              </div>
            </div>

            <!-- Prediction -->
            <div
              class="bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-5"
            >
              <h2
                class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4"
              >
                Prediction
              </h2>
              <div class="space-y-4">
                <div>
                  <label
                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                  >Future Steps</label>
                  <input
                    type="number"
                    id="futureStepsInput"
                    min="1"
                    max="1000"
                    value="50"
                    class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-slate-200 font-medium"
                    aria-label="Future steps to predict"
                  >
                </div>
                <button
                  id="runPredictBtn"
                  disabled
                  class="w-full min-h-[44px] px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/30 hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center gap-2"
                  aria-label="Run prediction"
                >
                  <span>‚ö°</span>
                  <span>Run Prediction</span>
                </button>
              </div>
            </div>

            <!-- Event Log -->
            <div
              class="bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-5"
            >
              <div class="flex items-center justify-between mb-4">
                <h2
                  class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400"
                >
                  Event Log
                </h2>
                <select
                  id="logFilter"
                  class="min-h-[36px] px-2 py-1 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300"
                  aria-label="Filter logs"
                >
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
              <input
                type="text"
                id="logSearch"
                placeholder="Search logs..."
                class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-slate-200 text-sm mb-3"
                aria-label="Search logs"
              >
              <div id="logList" class="h-48 overflow-y-auto space-y-2 text-sm">
                <!-- Populated dynamically -->
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Mobile Side Panel -->
    <div
      id="mobilePanelBackdrop"
      class="hidden fixed inset-0 bg-black/50 z-40 lg:hidden"
      aria-hidden="true"
    >
    </div>
    <aside
      id="mobilePanel"
      class="fixed top-0 right-0 h-full w-[85%] max-w-[384px] bg-white dark:bg-slate-900 shadow-2xl z-50 transform translate-x-full transition-transform lg:hidden overflow-y-auto"
    >
      <div class="p-6 space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100">
            Panel
          </h2>
          <button
            id="closeMobilePanel"
            class="min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
            aria-label="Close panel"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <!-- Mobile Panel Content (duplicated for mobile) -->
        <div id="mobilePanelContent" class="space-y-6">
          <!-- Populated via JS -->
        </div>
      </div>
    </aside>

    <!-- Slide-out Menu -->
    <div
      id="menuBackdrop"
      class="hidden fixed inset-0 bg-black/50 z-40"
      aria-hidden="true"
    >
    </div>
    <div
      id="slideMenu"
      class="fixed top-0 right-0 h-full w-[85%] max-w-[384px] bg-white dark:bg-slate-900 shadow-2xl z-50 transform translate-x-full transition-transform overflow-y-auto"
    >
      <div class="p-6">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">
            Menu
          </h2>
          <button
            id="closeMenuBtn"
            class="min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
            aria-label="Close menu"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <!-- Model Section -->
        <div class="mb-6">
          <h3
            class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            <span>üìÅ</span> Model
          </h3>
          <div class="space-y-2">
            <button
              id="menuConfigBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors text-left flex items-center gap-4"
              aria-label="Create and configure model"
            >
              <span class="text-2xl">üéõÔ∏è</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Create & Configure
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Set up model parameters
                </p>
              </div>
            </button>
            <button
              id="menuSaveLoadBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 transition-colors text-left flex items-center gap-4"
              aria-label="Save and load models"
            >
              <span class="text-2xl">üíæ</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Save & Load
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Persist your models
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Data Section -->
        <div class="mb-6">
          <h3
            class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            <span>üìÇ</span> Data
          </h3>
          <div class="space-y-2">
            <button
              id="menuUploadBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors text-left flex items-center gap-4"
              aria-label="Upload dataset"
            >
              <span class="text-2xl">üì§</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Upload Dataset
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Import time series data
                </p>
              </div>
            </button>
            <button
              id="menuInsertBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-amber-50 dark:bg-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors text-left flex items-center gap-4"
              aria-label="Manual insert"
            >
              <span class="text-2xl">‚ûï</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Manual Insert
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Add individual time steps
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Test Section -->
        <div class="mb-6">
          <h3
            class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            <span>üß™</span> Test
          </h3>
          <div class="space-y-2">
            <button
              id="menuRandomBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-pink-50 dark:bg-pink-900/20 hover:bg-pink-100 dark:hover:bg-pink-900/30 transition-colors text-left flex items-center gap-4"
              aria-label="Random test"
            >
              <span class="text-2xl">üí°</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Random Test
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Advanced Section -->
        <div>
          <h3
            class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
          >
            <span>‚öôÔ∏è</span> Advanced
          </h3>
          <div class="space-y-2">
            <button
              id="menuSettingsBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left flex items-center gap-4"
              aria-label="Settings"
            >
              <span class="text-2xl">üîß</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Settings
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Module URL & preferences
                </p>
              </div>
            </button>
            <button
              id="menuDataTableBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left flex items-center gap-4"
              aria-label="View data table"
            >
              <span class="text-2xl">üìã</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  View Data Table
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Raw prediction values
                </p>
              </div>
            </button>
            <button
              id="menuHelpBtn"
              class="w-full min-h-[60px] p-4 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left flex items-center gap-4"
              aria-label="Help"
            >
              <span class="text-2xl">‚ùì</span>
              <div>
                <p class="font-semibold text-slate-800 dark:text-slate-100">
                  Help
                </p>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                  Documentation & guide
                </p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="configModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-3xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <!-- Header -->
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="configModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              üéõÔ∏è Model Configuration
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>

          <!-- Content -->
          <div class="flex-1 overflow-y-auto p-6">
            <!-- Presets -->
            <div class="mb-6">
              <h3
                class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3"
              >
                Presets
              </h3>
              <div class="flex flex-wrap gap-2">
                <button
                  data-preset="default"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg"
                  aria-label="Start Here preset"
                >
                  Start Here
                </button>
                <button
                  data-preset="fast"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
                  aria-label="Fast preset"
                >
                  Fast
                </button>
                <button
                  data-preset="balanced"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
                  aria-label="Balanced preset"
                >
                  Balanced
                </button>
                <button
                  data-preset="accurate"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
                  aria-label="Accurate preset"
                >
                  Accurate
                </button>
                <button
                  data-preset="adaptive"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
                  aria-label="Adaptive preset"
                >
                  Adaptive
                </button>
                <button
                  data-preset="robust"
                  class="preset-btn min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
                  aria-label="Robust preset"
                >
                  Robust
                </button>
              </div>
            </div>

            <!-- Sections -->
            <div class="space-y-4">
              <!-- Reservoir Architecture -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="true"
                >
                  <span>üß† Reservoir Architecture</span>
                  <span class="toggle-icon">‚ñº</span>
                </button>
                <div
                  class="config-content p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Reservoir Size</label>
                    <input
                      type="number"
                      data-config="reservoirSize"
                      value="256"
                      min="8"
                      max="2048"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Reservoir size - Neurons in reservoir"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Neurons in reservoir
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Spectral Radius</label>
                    <input
                      type="number"
                      data-config="spectralRadius"
                      value="0.9"
                      step="0.01"
                      min="0"
                      max="2"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Spectral radius - Memory length control"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Memory length control
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Leak Rate</label>
                    <input
                      type="number"
                      data-config="leakRate"
                      value="0.3"
                      step="0.01"
                      min="0"
                      max="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Leak rate - Temporal smoothing"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Temporal smoothing
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Input Scale</label>
                    <input
                      type="number"
                      data-config="inputScale"
                      value="1.0"
                      step="0.1"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Input scale - Input scaling factor"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Input scaling factor
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Bias Scale</label>
                    <input
                      type="number"
                      data-config="biasScale"
                      value="0.1"
                      step="0.01"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Bias scale - Bias scaling"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Bias scaling
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Reservoir Sparsity</label>
                    <input
                      type="number"
                      data-config="reservoirSparsity"
                      value="0.9"
                      step="0.01"
                      min="0"
                      max="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Reservoir sparsity - Zero connections"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Zero connections
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Input Sparsity</label>
                    <input
                      type="number"
                      data-config="inputSparsity"
                      value="0.0"
                      step="0.01"
                      min="0"
                      max="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Input sparsity"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Input sparsity
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Activation</label>
                    <select
                      data-config="activation"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Activation function"
                    >
                      <option value="tanh">tanh</option>
                      <option value="relu">relu</option>
                    </select>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Activation function
                    </p>
                  </div>
                </div>
              </div>

              <!-- Readout Configuration -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üì§ Readout Configuration</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div
                  class="config-content hidden p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div
                    class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl"
                  >
                    <div>
                      <p class="font-medium text-slate-800 dark:text-slate-100">
                        Use Input in Readout
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Append input to state
                      </p>
                    </div>
                    <button
                      data-config="useInputInReadout"
                      data-type="toggle"
                      class="toggle-btn min-w-[56px] h-8 rounded-full bg-emerald-500 p-1 transition-colors"
                      aria-label="Toggle use input in readout"
                      aria-pressed="true"
                    >
                      <span
                        class="block w-6 h-6 rounded-full bg-white shadow transform translate-x-6 transition-transform"
                      ></span>
                    </button>
                  </div>
                  <div
                    class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl"
                  >
                    <div>
                      <p class="font-medium text-slate-800 dark:text-slate-100">
                        Use Bias in Readout
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Include bias term
                      </p>
                    </div>
                    <button
                      data-config="useBiasInReadout"
                      data-type="toggle"
                      class="toggle-btn min-w-[56px] h-8 rounded-full bg-emerald-500 p-1 transition-colors"
                      aria-label="Toggle use bias in readout"
                      aria-pressed="true"
                    >
                      <span
                        class="block w-6 h-6 rounded-full bg-white shadow transform translate-x-6 transition-transform"
                      ></span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Training (RLS) -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üéì Training (RLS)</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div
                  class="config-content hidden p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Readout Training</label>
                    <input
                      type="text"
                      value="rls"
                      disabled
                      class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-600 border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      RLS training (fixed)
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >RLS Lambda</label>
                    <input
                      type="number"
                      data-config="rlsLambda"
                      value="0.999"
                      step="0.001"
                      min="0.9"
                      max="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="RLS Lambda - Forgetting factor"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Forgetting factor
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >RLS Delta</label>
                    <input
                      type="number"
                      data-config="rlsDelta"
                      value="1.0"
                      step="0.1"
                      min="0.01"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="RLS Delta - Initial P diagonal"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Initial P diagonal
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Epsilon</label>
                    <input
                      type="number"
                      data-config="epsilon"
                      value="1e-8"
                      step="1e-9"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Epsilon - Numerical stability"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Numerical stability
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >L2 Lambda</label>
                    <input
                      type="number"
                      data-config="l2Lambda"
                      value="0.0001"
                      step="0.0001"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="L2 Lambda - L2 regularization"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      L2 regularization
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Gradient Clip Norm</label>
                    <input
                      type="number"
                      data-config="gradientClipNorm"
                      value="1.0"
                      step="0.1"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Gradient clip norm - Max update norm"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Max update norm
                    </p>
                  </div>
                </div>
              </div>

              <!-- Normalization -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üìè Normalization</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div
                  class="config-content hidden p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Normalization Epsilon</label>
                    <input
                      type="number"
                      data-config="normalizationEpsilon"
                      value="1e-8"
                      step="1e-9"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Normalization epsilon - Stability constant"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Stability constant
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Normalization Warmup</label>
                    <input
                      type="number"
                      data-config="normalizationWarmup"
                      value="10"
                      min="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Normalization warmup - Warmup samples"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Warmup samples
                    </p>
                  </div>
                </div>
              </div>

              <!-- Outlier Handling -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üéØ Outlier Handling</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div
                  class="config-content hidden p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Outlier Threshold</label>
                    <input
                      type="number"
                      data-config="outlierThreshold"
                      value="3.0"
                      step="0.1"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Outlier threshold - Z-score threshold"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Z-score threshold
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Outlier Min Weight</label>
                    <input
                      type="number"
                      data-config="outlierMinWeight"
                      value="0.1"
                      step="0.01"
                      min="0"
                      max="1"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Outlier min weight"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Outlier min weight
                    </p>
                  </div>
                </div>
              </div>

              <!-- Uncertainty -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üìä Uncertainty</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div class="config-content hidden p-4">
                  <div class="max-w-sm">
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Uncertainty Multiplier</label>
                    <input
                      type="number"
                      data-config="uncertaintyMultiplier"
                      value="1.96"
                      step="0.01"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Uncertainty multiplier - CI Multiplier"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      CI Multiplier (1.96 = 95% CI)
                    </p>
                  </div>
                </div>
              </div>

              <!-- Initialization -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="config-toggle w-full min-h-[56px] px-4 py-3 bg-slate-50 dark:bg-slate-800 text-left font-semibold text-slate-800 dark:text-slate-100 flex items-center justify-between"
                  aria-expanded="false"
                >
                  <span>üå± Initialization</span>
                  <span class="toggle-icon">‚ñ∂</span>
                </button>
                <div
                  class="config-content hidden p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"
                >
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Weight Init Scale</label>
                    <input
                      type="number"
                      data-config="weightInitScale"
                      value="0.1"
                      step="0.01"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Weight init scale - Initial weight scale"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Initial weight scale
                    </p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                    >Seed</label>
                    <input
                      type="number"
                      data-config="seed"
                      value="42"
                      min="0"
                      class="config-input w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                      aria-label="Random seed"
                    >
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                      Random seed
                    </p>
                  </div>
                  <div
                    class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl"
                  >
                    <div>
                      <p class="font-medium text-slate-800 dark:text-slate-100">
                        Verbose
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Detailed logging
                      </p>
                    </div>
                    <button
                      data-config="verbose"
                      data-type="toggle"
                      class="toggle-btn min-w-[56px] h-8 rounded-full bg-slate-300 dark:bg-slate-600 p-1 transition-colors"
                      aria-label="Toggle verbose"
                      aria-pressed="false"
                    >
                      <span
                        class="block w-6 h-6 rounded-full bg-white shadow transform translate-x-0 transition-transform"
                      ></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              id="resetDefaultsBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
              aria-label="Reset to defaults"
            >
              Reset Defaults
            </button>
            <button
              id="resetAllBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
              aria-label="Reset all"
            >
              Reset All
            </button>
            <div class="flex-1"></div>
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
              aria-label="Cancel"
            >
              Cancel
            </button>
            <button
              id="createModelBtn"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg shadow-blue-500/30 hover:shadow-xl transition-all"
              aria-label="Create model"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="uploadModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="uploadModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              üì§ Upload Dataset
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6 space-y-4">
            <!-- Drop Zone -->
            <div
              id="dropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-blue-500 dark:hover:border-blue-400 transition-colors cursor-pointer"
            >
              <span class="text-4xl mb-4 block">üìÅ</span>
              <p class="text-slate-700 dark:text-slate-300 font-medium">
                Drop JSON file here or tap to browse
              </p>
              <input type="file" id="fileInput" accept=".json" class="hidden">
            </div>

            <!-- Or paste JSON -->
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Or paste JSON:</label>
              <textarea
                id="jsonInput"
                rows="6"
                class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-slate-200 font-mono text-sm"
                placeholder='{"coordinates": [[1.0, 2.0], [1.1, 2.1], ...]}'
              ></textarea>
            </div>

            <!-- Format Example -->
            <details class="bg-slate-50 dark:bg-slate-800 rounded-xl">
              <summary
                class="px-4 py-3 cursor-pointer font-medium text-slate-700 dark:text-slate-300"
              >
                üìù Format Example
              </summary>
              <div class="px-4 pb-4">
                <pre
                  class="bg-slate-100 dark:bg-slate-900 p-3 rounded-lg text-sm overflow-x-auto"
                >
<code>{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
                <button
                  id="copyExampleBtn"
                  class="mt-2 min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-300 dark:hover:bg-slate-600 text-sm"
                  aria-label="Copy example"
                >
                  üìã Copy example
                </button>
              </div>
            </details>

            <!-- Validation Preview -->
            <div
              id="uploadPreview"
              class="hidden p-4 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-700"
            >
              <p
                class="text-emerald-700 dark:text-emerald-300 font-medium flex items-center gap-2"
              >
                <span>‚úì</span>
                <span id="previewInfo">Valid data</span>
              </p>
            </div>
            <div
              id="uploadError"
              class="hidden p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700"
            >
              <p
                id="uploadErrorText"
                class="text-red-700 dark:text-red-300 font-medium"
              >
              </p>
            </div>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Cancel"
            >
              Cancel
            </button>
            <button
              id="validateBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Validate"
            >
              Validate
            </button>
            <button
              id="applyTrainBtn"
              disabled
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label="Apply and train"
            >
              Apply & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="insertModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="insertModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="insertModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              ‚ûï Manual Insert
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6 space-y-4">
            <p class="text-slate-600 dark:text-slate-400">
              Add individual time steps for online training. Each coordinate
              array represents one time step.
            </p>
            <button
              id="generateTemplateBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Generate template"
            >
              üìù Generate Template
            </button>
            <textarea
              id="insertInput"
              rows="8"
              class="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-slate-200 font-mono text-sm"
              placeholder='{"coordinates": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1]]}'
            ></textarea>
            <div id="insertFeedback" class="hidden p-4 rounded-xl"></div>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Cancel"
            >
              Cancel
            </button>
            <button
              id="insertTrainBtn"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg"
              aria-label="Insert and train"
            >
              Insert & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="saveLoadModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="saveLoadModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              üíæ Save & Load
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Save Section -->
            <div>
              <h3
                class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4"
              >
                Save Model
              </h3>
              <div class="flex flex-wrap gap-3">
                <button
                  id="downloadModelBtn"
                  class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center gap-2"
                  aria-label="Download model"
                >
                  <span>üì•</span>
                  <span>Download</span>
                </button>
                <button
                  id="saveBrowserBtn"
                  class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center gap-2"
                  aria-label="Save to browser"
                >
                  <span>üíæ</span>
                  <span>Browser</span>
                </button>
              </div>
            </div>

            <!-- Load Section -->
            <div>
              <h3
                class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4"
              >
                Load Model
              </h3>
              <div
                id="loadDropZone"
                class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 cursor-pointer mb-4"
              >
                <span class="text-2xl mb-2 block">üì§</span>
                <p class="text-slate-600 dark:text-slate-400">
                  Tap to upload model file
                </p>
                <input
                  type="file"
                  id="loadFileInput"
                  accept=".json"
                  class="hidden"
                >
              </div>

              <h4
                class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2"
              >
                Saved in Browser:
              </h4>
              <div
                id="savedModelsList"
                class="space-y-2 max-h-40 overflow-y-auto"
              >
                <!-- Populated dynamically -->
              </div>
              <button
                id="clearSavedBtn"
                class="mt-3 text-sm text-red-500 hover:text-red-600 dark:text-red-400"
                aria-label="Clear all saved models"
              >
                Clear all saved models
              </button>
            </div>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Close"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="randomModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="randomModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              üí° Random Test
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Seed</label>
                <input
                  type="number"
                  id="randomSeed"
                  value="42"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Random seed"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Dimensions</label>
                <input
                  type="number"
                  id="randomDims"
                  value="3"
                  min="1"
                  max="10"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Number of dimensions"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Time Steps</label>
                <input
                  type="number"
                  id="randomSteps"
                  value="200"
                  min="10"
                  max="1000"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Number of time steps"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Noise</label>
                <input
                  type="number"
                  id="randomNoise"
                  value="0.1"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Noise level"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Outliers</label>
                <input
                  type="number"
                  id="randomOutliers"
                  value="0.02"
                  step="0.01"
                  min="0"
                  max="0.5"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Outlier rate"
                >
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
                >Difficulty</label>
                <select
                  id="randomDifficulty"
                  class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                  aria-label="Difficulty level"
                >
                  <option value="easy">Easy</option>
                  <option value="medium" selected>Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </div>
            </div>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Cancel"
            >
              Cancel
            </button>
            <button
              id="generateRunBtn"
              class="min-h-[44px] px-6 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold shadow-lg"
              aria-label="Generate and run"
            >
              Generate & Run
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="settingsModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="settingsModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              üîß Settings
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6 space-y-4">
            <div>
              <label
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Module URL</label>
              <input
                type="text"
                id="moduleUrlInput"
                value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0"
                class="w-full min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 font-mono text-sm"
                aria-label="Module URL"
              >
            </div>
            <button
              id="reinitWorkerBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-amber-500 text-white font-medium hover:bg-amber-600"
              aria-label="Reinitialize worker"
            >
              üîÑ Reinitialize Worker
            </button>
            <button
              id="clearPrefsBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600"
              aria-label="Clear all preferences"
            >
              üóëÔ∏è Clear All Preferences
            </button>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Close"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 z-50 overflow-hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="dataTableModalTitle"
    >
      <div class="h-full flex flex-col bg-white dark:bg-slate-900">
        <div
          class="flex items-center justify-between p-4 sm:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2
            id="dataTableModalTitle"
            class="text-xl font-bold text-slate-800 dark:text-slate-100"
          >
            üìã Data Table
          </h2>
          <div class="flex items-center gap-3">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm"
              aria-label="Search table"
            >
            <button
              id="exportCSVBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium flex items-center gap-2"
              aria-label="Export CSV"
            >
              <span>üìä</span>
              <span class="hidden sm:inline">CSV</span>
            </button>
            <button
              id="copyAllBtn"
              class="min-h-[44px] px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium flex items-center gap-2"
              aria-label="Copy all"
            >
              <span>üìã</span>
              <span class="hidden sm:inline">Copy</span>
            </button>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-auto">
          <table id="dataTable" class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-800">
              <tr id="tableHeader">
                <!-- Populated dynamically -->
              </tr>
            </thead>
            <tbody id="tableBody" class="font-mono">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      role="dialog"
      aria-modal="true"
      aria-labelledby="helpModalTitle"
    >
      <div class="min-h-screen px-4 flex items-center justify-center">
        <div
          class="fixed inset-0 bg-black/50 transition-opacity"
          aria-hidden="true"
        >
        </div>
        <div
          class="relative w-full max-w-3xl bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              id="helpModalTitle"
              class="text-xl font-bold text-slate-800 dark:text-slate-100"
            >
              ‚ùì Help & Documentation
            </h2>
            <button
              class="modal-close min-w-[44px] min-h-[44px] p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-xl"
              aria-label="Close modal"
            >
              ‚úñÔ∏è
            </button>
          </div>
          <div
            class="flex-1 overflow-y-auto p-6 prose dark:prose-invert max-w-none"
          >
            <h3>üîß Worker Setup</h3>
            <p>
              The ESNRegression library runs in a Web Worker for non-blocking
              performance.
            </p>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            ><code>Module URL: https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0</code></pre>

            <h3>üìù Method Documentation</h3>

            <h4>Creating a Model:</h4>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            ><code>const model = new ESNRegression(config);</code></pre>

            <h4>Online Training (fitOnline):</h4>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            >
<code>model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call (t, t+1), (t+2, t+3)...
// Returns: { averageLoss, gradientNorm, sampleWeight }</code></pre>

            <h4>Prediction:</h4>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            >
<code>const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</code></pre>

            <h4>Save/Load:</h4>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            >
<code>const state = model.save();
model.load(state);</code></pre>

            <h4>Model Summary:</h4>
            <pre
              class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl overflow-x-auto"
            >
<code>const summary = model.getModelSummary();
// Returns: { nFeatures, sampleCount, ... }</code></pre>

            <h3>üéõÔ∏è Preset Configurations</h3>
            <ul>
              <li>
                <strong>Start Here/Default:</strong> reservoirSize=256,
                spectralRadius=0.9, leakRate=0.3
              </li>
              <li>
                <strong>Fast:</strong> reservoirSize=64, reservoirSparsity=0.95
              </li>
              <li>
                <strong>Balanced:</strong> reservoirSize=256, spectralRadius=0.9
              </li>
              <li>
                <strong>Accurate:</strong> reservoirSize=512,
                spectralRadius=0.95, leakRate=0.2
              </li>
              <li>
                <strong>Adaptive:</strong> rlsLambda=0.97, spectralRadius=0.85,
                leakRate=0.5
              </li>
              <li>
                <strong>Robust:</strong> outlierThreshold=2.0,
                outlierMinWeight=0.05, l2Lambda=0.01, leakRate=0.2
              </li>
            </ul>
          </div>
          <div
            class="flex flex-wrap gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              class="modal-close min-h-[44px] px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium"
              aria-label="Close"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-96 z-50 space-y-2"
    >
      <!-- Toasts appear here -->
    </div>

    <script>
      // ===== STATE MANAGEMENT =====
      const DIMENSION_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const PRESETS = {
        default: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        fast: {
          reservoirSize: 64,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.95,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        balanced: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        accurate: {
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        adaptive: {
          reservoirSize: 256,
          spectralRadius: 0.85,
          leakRate: 0.5,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.97,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        robust: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.2,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.01,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
      };

      let state = {
        config: { ...PRESETS.default },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 1,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        moduleUrl:
          "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0",
      };

      let worker = null;
      let requestId = 0;
      let pendingRequests = {};
      let canvas, ctx;
      let touchState = {
        startX: 0,
        startY: 0,
        startDist: 0,
        isPinching: false,
        isDragging: false,
      };
      let isCancelled = false;

      // ===== INITIALIZATION =====
      function init() {
        loadPreferences();
        applyTheme();
        setupCanvas();
        setupEventListeners();
        initWorker();
        updateUI();
        addLog("info", "Application initialized");
      }

      function loadPreferences() {
        try {
          const saved = localStorage.getItem("esnStudioPrefs");
          if (saved) {
            const prefs = JSON.parse(saved);
            if (prefs.config) {
              state.config = { ...PRESETS.default, ...prefs.config };
            }
            if (prefs.vizMode) state.vizMode = prefs.vizMode;
            if (prefs.isDark !== undefined) state.isDark = prefs.isDark;
            if (prefs.moduleUrl) state.moduleUrl = prefs.moduleUrl;
          }
        } catch (e) {
          console.error("Failed to load preferences:", e);
        }
      }

      function savePreferences() {
        try {
          localStorage.setItem(
            "esnStudioPrefs",
            JSON.stringify({
              config: state.config,
              vizMode: state.vizMode,
              isDark: state.isDark,
              moduleUrl: state.moduleUrl,
            }),
          );
        } catch (e) {
          console.error("Failed to save preferences:", e);
        }
      }

      function applyTheme() {
        if (state.isDark) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      }

      // ===== WEB WORKER =====
      function initWorker() {
        const workerCode = `
                let ESNRegression = null;
                let model = null;
                let moduleUrl = '';

                self.onmessage = async function(e) {
                    const { type, payload, requestId } = e.data;
                    
                    try {
                        switch(type) {
                            case 'init':
                                moduleUrl = payload.moduleUrl;
                                const module = await import(moduleUrl);
                                ESNRegression = module.ESNRegression;
                                self.postMessage({ type: 'initComplete', requestId, success: true });
                                break;
                                
                            case 'createModel':
                                if (!ESNRegression) throw new Error('Module not initialized');
                                model = new ESNRegression(payload.config);
                                self.postMessage({ type: 'modelCreated', requestId, success: true });
                                break;
                                
                            case 'train':
                                if (!model) throw new Error('No model exists');
                                const trainResult = model.fitOnline(payload.data);
                                const summary = model.getModelSummary();
                                self.postMessage({ 
                                    type: 'trainComplete', 
                                    requestId, 
                                    success: true, 
                                    result: trainResult,
                                    summary 
                                });
                                break;
                                
                            case 'predict':
                                if (!model) throw new Error('No model exists');
                                const predictions = model.predict(payload.steps);
                                self.postMessage({ type: 'predictComplete', requestId, success: true, result: predictions });
                                break;
                                
                            case 'save':
                                if (!model) throw new Error('No model exists');
                                const savedState = model.save();
                                self.postMessage({ type: 'saveComplete', requestId, success: true, result: savedState });
                                break;
                                
                            case 'load':
                                if (!ESNRegression) throw new Error('Module not initialized');
                                model = new ESNRegression(payload.state.config || {});
                                model.load(payload.state);
                                const loadSummary = model.getModelSummary();
                                self.postMessage({ type: 'loadComplete', requestId, success: true, summary: loadSummary });
                                break;
                                
                            case 'getSummary':
                                if (!model) throw new Error('No model exists');
                                const modelSummary = model.getModelSummary();
                                self.postMessage({ type: 'summaryComplete', requestId, success: true, result: modelSummary });
                                break;
                                
                            case 'reset':
                                model = null;
                                self.postMessage({ type: 'resetComplete', requestId, success: true });
                                break;
                        }
                    } catch (error) {
                        self.postMessage({ type: 'error', requestId, error: error.message });
                    }
                };
            `;

        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        worker.onmessage = handleWorkerMessage;
        worker.onerror = (e) => {
          showToast("Worker error: " + e.message, "error");
          addLog("error", "Worker error: " + e.message);
        };

        sendWorkerMessage("init", { moduleUrl: state.moduleUrl });
      }

      function sendWorkerMessage(type, payload) {
        return new Promise((resolve, reject) => {
          const id = ++requestId;
          pendingRequests[id] = { resolve, reject };
          worker.postMessage({ type, payload, requestId: id });
        });
      }

      function handleWorkerMessage(e) {
        const { type, requestId: id, success, error, result, summary } =
          e.data;

        if (pendingRequests[id]) {
          if (success) {
            pendingRequests[id].resolve({ result, summary });
          } else if (error) {
            pendingRequests[id].reject(new Error(error));
          }
          delete pendingRequests[id];
        }

        if (type === "initComplete") {
          addLog("success", "Worker initialized");
        }
      }

      // ===== CANVAS SETUP =====
      function setupCanvas() {
        canvas = document.getElementById("mainCanvas");
        ctx = canvas.getContext("2d");
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
      }

      function resizeCanvas() {
        const container = canvas.parentElement;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = container.offsetWidth * dpr;
        canvas.height = 400 * dpr;
        canvas.style.width = container.offsetWidth + "px";
        canvas.style.height = "400px";
        ctx.scale(dpr, dpr);
        renderVisualization();
      }

      // ===== EVENT LISTENERS =====
      function setupEventListeners() {
        // Theme toggle
        document.getElementById("themeBtn").addEventListener(
          "click",
          () => {
            state.isDark = !state.isDark;
            applyTheme();
            savePreferences();
            renderVisualization();
          },
        );

        // Menu
        document.getElementById("menuBtn").addEventListener(
          "click",
          openMenu,
        );
        document.getElementById("closeMenuBtn").addEventListener(
          "click",
          closeMenu,
        );
        document.getElementById("menuBackdrop").addEventListener(
          "click",
          closeMenu,
        );

        // Config modal
        document.getElementById("configBtn").addEventListener(
          "click",
          () => openModal("configModal"),
        );
        document.getElementById("menuConfigBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("configModal");
          },
        );

        // Other menu items
        document.getElementById("menuSaveLoadBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("saveLoadModal");
            updateSavedModelsList();
          },
        );
        document.getElementById("menuUploadBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("uploadModal");
          },
        );
        document.getElementById("menuInsertBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("insertModal");
          },
        );
        document.getElementById("menuRandomBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("randomModal");
          },
        );
        document.getElementById("menuSettingsBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("settingsModal");
            document.getElementById("moduleUrlInput").value =
              state.moduleUrl;
          },
        );
        document.getElementById("menuDataTableBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("dataTableModal");
            populateDataTable();
          },
        );
        document.getElementById("menuHelpBtn").addEventListener(
          "click",
          () => {
            closeMenu();
            openModal("helpModal");
          },
        );

        // Modal close buttons
        document.querySelectorAll(".modal-close").forEach((btn) => {
          btn.addEventListener("click", () => closeAllModals());
        });

        // Config modal interactions
        document.querySelectorAll(".config-toggle").forEach((btn) => {
          btn.addEventListener("click", function () {
            const content = this.nextElementSibling;
            const icon = this.querySelector(".toggle-icon");
            const isExpanded =
              this.getAttribute("aria-expanded") === "true";

            content.classList.toggle("hidden");
            this.setAttribute("aria-expanded", !isExpanded);
            icon.textContent = isExpanded ? "‚ñ∂" : "‚ñº";
          });
        });

        // Toggle buttons
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const isPressed =
              this.getAttribute("aria-pressed") === "true";
            this.setAttribute("aria-pressed", !isPressed);
            this.classList.toggle("bg-emerald-500", !isPressed);
            this.classList.toggle("bg-slate-300", isPressed);
            this.classList.toggle("dark:bg-slate-600", isPressed);
            this.querySelector("span").classList.toggle(
              "translate-x-6",
              !isPressed,
            );
            this.querySelector("span").classList.toggle(
              "translate-x-0",
              isPressed,
            );

            const configKey = this.dataset.config;
            state.config[configKey] = !isPressed;
          });
        });

        // Presets
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document.querySelectorAll(".preset-btn").forEach((b) => {
              b.classList.remove(
                "bg-gradient-to-r",
                "from-blue-500",
                "to-indigo-600",
                "text-white",
                "shadow-lg",
              );
              b.classList.add(
                "bg-slate-100",
                "dark:bg-slate-700",
                "text-slate-700",
                "dark:text-slate-300",
              );
            });
            this.classList.add(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-indigo-600",
              "text-white",
              "shadow-lg",
            );
            this.classList.remove(
              "bg-slate-100",
              "dark:bg-slate-700",
              "text-slate-700",
              "dark:text-slate-300",
            );

            const preset = PRESETS[this.dataset.preset];
            state.config = { ...preset };
            updateConfigInputs();
          });
        });

        // Config inputs
        document.querySelectorAll(".config-input").forEach((input) => {
          input.addEventListener("change", function () {
            const key = this.dataset.config;
            let value = this.type === "number"
              ? parseFloat(this.value)
              : this.value;
            if (key === "activation") value = this.value;
            state.config[key] = value;
          });
        });

        // Create model
        document.getElementById("createModelBtn").addEventListener(
          "click",
          createModel,
        );
        document.getElementById("startDefaultsBtn").addEventListener(
          "click",
          () => {
            state.config = { ...PRESETS.default };
            createModel();
          },
        );

        // Reset buttons
        document.getElementById("resetDefaultsBtn").addEventListener(
          "click",
          () => {
            state.config = { ...PRESETS.default };
            updateConfigInputs();
            showToast("Reset to defaults", "info");
          },
        );
        document.getElementById("resetAllBtn").addEventListener(
          "click",
          async () => {
            try {
              await sendWorkerMessage("reset", {});
              state.modelExists = false;
              state.predictions = null;
              state.sampleCount = 0;
              state.nDimensions = 0;
              state.metrics = {
                avgLoss: null,
                gradientNorm: null,
                sampleWeight: null,
              };
              updateUI();
              renderVisualization();
              showToast("Model reset", "success");
              addLog("info", "Model reset");
            } catch (e) {
              showToast("Reset failed: " + e.message, "error");
            }
          },
        );

        // Visualization tabs
        document.querySelectorAll(".viz-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document.querySelectorAll(".viz-tab").forEach((t) => {
              t.classList.remove(
                "bg-gradient-to-r",
                "from-blue-500",
                "to-indigo-600",
                "text-white",
                "shadow-lg",
              );
              t.classList.add(
                "bg-slate-100",
                "dark:bg-slate-700",
                "text-slate-700",
                "dark:text-slate-300",
              );
            });
            this.classList.add(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-indigo-600",
              "text-white",
              "shadow-lg",
            );
            this.classList.remove(
              "bg-slate-100",
              "dark:bg-slate-700",
              "text-slate-700",
              "dark:text-slate-300",
            );

            state.vizMode = this.dataset.mode;
            savePreferences();
            updateModeUI();
            renderVisualization();
          });
        });

        // Predict buttons
        document.getElementById("predictBtn").addEventListener(
          "click",
          runPrediction,
        );
        document.getElementById("runPredictBtn").addEventListener(
          "click",
          runPrediction,
        );

        // Zoom controls
        document.getElementById("zoomInBtn").addEventListener(
          "click",
          () => zoom(1.2),
        );
        document.getElementById("zoomOutBtn").addEventListener(
          "click",
          () => zoom(0.8),
        );
        document.getElementById("resetZoomBtn").addEventListener(
          "click",
          resetZoom,
        );

        // Canvas interactions
        canvas.addEventListener("mousemove", handleCanvasMouseMove);
        canvas.addEventListener("mouseleave", handleCanvasMouseLeave);
        canvas.addEventListener("wheel", handleCanvasWheel, {
          passive: false,
        });
        canvas.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });
        canvas.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        });
        canvas.addEventListener("touchend", handleTouchEnd);

        // Step selector
        document.getElementById("stepInput").addEventListener(
          "change",
          function () {
            state.selectedStep = Math.max(1, parseInt(this.value) || 1);
            renderVisualization();
          },
        );

        // Export buttons
        document.getElementById("exportPNG").addEventListener(
          "click",
          exportPNG,
        );
        document.getElementById("exportSVG").addEventListener(
          "click",
          exportSVG,
        );
        document.getElementById("exportClipboard").addEventListener(
          "click",
          exportClipboard,
        );

        // Upload modal
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");

        dropZone.addEventListener("click", () => fileInput.click());
        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("border-blue-500");
        });
        dropZone.addEventListener(
          "dragleave",
          () => dropZone.classList.remove("border-blue-500"),
        );
        dropZone.addEventListener("drop", handleFileDrop);
        fileInput.addEventListener("change", handleFileSelect);

        document.getElementById("validateBtn").addEventListener(
          "click",
          validateUploadData,
        );
        document.getElementById("applyTrainBtn").addEventListener(
          "click",
          applyAndTrain,
        );
        document.getElementById("copyExampleBtn").addEventListener(
          "click",
          () => {
            navigator.clipboard.writeText(
              '{\n  "coordinates": [\n    [1.0, 2.0, 3.0],\n    [1.1, 2.1, 3.1],\n    [1.2, 2.2, 3.2]\n  ]\n}',
            );
            showToast("Example copied", "success");
          },
        );

        // Manual insert
        document.getElementById("generateTemplateBtn").addEventListener(
          "click",
          generateTemplate,
        );
        document.getElementById("insertTrainBtn").addEventListener(
          "click",
          insertAndTrain,
        );

        // Save/Load
        document.getElementById("downloadModelBtn").addEventListener(
          "click",
          downloadModel,
        );
        document.getElementById("saveBrowserBtn").addEventListener(
          "click",
          saveToBrowser,
        );
        document.getElementById("loadFileInput").addEventListener(
          "change",
          handleLoadFile,
        );
        document.getElementById("loadDropZone").addEventListener(
          "click",
          () => document.getElementById("loadFileInput").click(),
        );
        document.getElementById("clearSavedBtn").addEventListener(
          "click",
          clearSavedModels,
        );
        document.getElementById("loadModelBtn").addEventListener(
          "click",
          () => {
            openModal("saveLoadModal");
            updateSavedModelsList();
          },
        );

        // Random test
        document.getElementById("generateRunBtn").addEventListener(
          "click",
          generateAndRun,
        );
        document.getElementById("demoBtn").addEventListener(
          "click",
          () => {
            document.getElementById("randomSeed").value = 42;
            document.getElementById("randomDims").value = 3;
            document.getElementById("randomSteps").value = 200;
            document.getElementById("randomNoise").value = 0.1;
            document.getElementById("randomOutliers").value = 0.02;
            document.getElementById("randomDifficulty").value =
              "medium";
            generateAndRun();
          },
        );

        // Settings
        document.getElementById("reinitWorkerBtn").addEventListener(
          "click",
          () => {
            state.moduleUrl =
              document.getElementById("moduleUrlInput").value;
            savePreferences();
            if (worker) worker.terminate();
            initWorker();
            showToast("Worker reinitialized", "success");
          },
        );
        document.getElementById("clearPrefsBtn").addEventListener(
          "click",
          () => {
            localStorage.removeItem("esnStudioPrefs");
            localStorage.removeItem("esnSavedModels");
            showToast("Preferences cleared", "success");
          },
        );

        // Data table
        document.getElementById("tableSearch").addEventListener(
          "input",
          filterTable,
        );
        document.getElementById("exportCSVBtn").addEventListener(
          "click",
          exportCSV,
        );
        document.getElementById("copyAllBtn").addEventListener(
          "click",
          copyTableData,
        );

        // Cancel loading
        document.getElementById("cancelBtn").addEventListener(
          "click",
          () => {
            isCancelled = true;
            hideLoading();
            showToast("Operation cancelled", "warning");
          },
        );

        // Log filter
        document.getElementById("logFilter").addEventListener(
          "change",
          updateLogList,
        );
        document.getElementById("logSearch").addEventListener(
          "input",
          updateLogList,
        );
      }

      // ===== MODAL MANAGEMENT =====
      function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove("hidden");
        modal.querySelector(".modal-close")?.focus();
        document.body.style.overflow = "hidden";
      }

      function closeAllModals() {
        document.querySelectorAll('[role="dialog"]').forEach(
          (modal) => {
            modal.classList.add("hidden");
          },
        );
        document.body.style.overflow = "";
      }

      function openMenu() {
        document.getElementById("slideMenu").classList.remove(
          "translate-x-full",
        );
        document.getElementById("menuBackdrop").classList.remove(
          "hidden",
        );
      }

      function closeMenu() {
        document.getElementById("slideMenu").classList.add(
          "translate-x-full",
        );
        document.getElementById("menuBackdrop").classList.add("hidden");
      }

      // ===== UI UPDATES =====
      function updateUI() {
        // Model status
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const predictBtn = document.getElementById("predictBtn");
        const runPredictBtn = document.getElementById("runPredictBtn");
        const emptyState = document.getElementById("emptyState");
        const floatingControls = document.getElementById(
          "floatingControls",
        );
        const exportControls = document.getElementById(
          "exportControls",
        );

        if (state.modelExists) {
          statusDot.classList.remove("bg-slate-400");
          statusDot.classList.add("bg-emerald-500");
          statusText.textContent = state.sampleCount + " samples";
          predictBtn.classList.remove("hidden");
          predictBtn.classList.add("flex");
          runPredictBtn.disabled = false;
        } else {
          statusDot.classList.add("bg-slate-400");
          statusDot.classList.remove("bg-emerald-500");
          statusText.textContent = "No Model";
          predictBtn.classList.add("hidden");
          predictBtn.classList.remove("flex");
          runPredictBtn.disabled = true;
        }

        if (state.predictions) {
          emptyState.classList.add("hidden");
          floatingControls.classList.remove("hidden");
          exportControls.classList.remove("hidden");
        } else {
          emptyState.classList.remove("hidden");
          floatingControls.classList.add("hidden");
          exportControls.classList.add("hidden");
        }

        // Metrics
        document.getElementById("metricSamples").textContent =
          state.sampleCount;
        document.getElementById("metricLoss").textContent =
          state.metrics.avgLoss !== null
            ? state.metrics.avgLoss.toExponential(3)
            : "-";
        document.getElementById("metricGradient").textContent =
          state.metrics.gradientNorm !== null
            ? state.metrics.gradientNorm.toExponential(3)
            : "-";
        document.getElementById("metricWeight").textContent =
          state.metrics.sampleWeight !== null
            ? state.metrics.sampleWeight.toFixed(3)
            : "-";

        updateModeUI();
        updateLogList();
      }

      function updateModeUI() {
        const dimSelector = document.getElementById("dimSelector");
        const stepSelector = document.getElementById("stepSelector");
        const statsBar = document.getElementById("statsBar");

        dimSelector.classList.add("hidden");
        stepSelector.classList.add("hidden");
        statsBar.classList.add("hidden");

        if (state.vizMode === "focus" && state.predictions) {
          dimSelector.classList.remove("hidden");
          statsBar.classList.remove("hidden");
          updateDimensionButtons();
          updateStats();
        } else if (state.vizMode === "snapshot" && state.predictions) {
          stepSelector.classList.remove("hidden");
          const stepInput = document.getElementById("stepInput");
          stepInput.max = state.predictions.predictions.length;
        }
      }

      function updateDimensionButtons() {
        const container = document.getElementById("dimButtons");
        container.innerHTML = "";

        for (let i = 0; i < state.nDimensions; i++) {
          const btn = document.createElement("button");
          btn.className =
            "min-h-[44px] px-4 py-2 rounded-xl font-medium transition-all";
          btn.textContent = "D" + (i + 1);
          btn.setAttribute("aria-label", "Dimension " + (i + 1));

          if (i === state.selectedDim) {
            btn.style.backgroundColor =
              DIMENSION_COLORS[i % DIMENSION_COLORS.length];
            btn.classList.add("text-white", "shadow-lg");
          } else {
            btn.classList.add(
              "bg-slate-100",
              "dark:bg-slate-700",
              "text-slate-700",
              "dark:text-slate-300",
            );
          }

          btn.addEventListener("click", () => {
            state.selectedDim = i;
            updateDimensionButtons();
            updateStats();
            renderVisualization();
          });

          container.appendChild(btn);
        }
      }

      function updateStats() {
        if (!state.predictions || state.vizMode !== "focus") return;

        const dim = state.selectedDim;
        const values = state.predictions.predictions.map((p) => p[dim]);
        const lowers = state.predictions.lowerBounds.map((l) => l[dim]);
        const uppers = state.predictions.upperBounds.map((u) => u[dim]);

        const min = Math.min(...values);
        const max = Math.max(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const final = values[values.length - 1];
        const trend = final - values[0];

        // Calculate average confidence width
        const avgSpread = values.reduce(
          (sum, v, i) => sum + (uppers[i] - lowers[i]),
          0,
        ) / values.length;
        const avgValue = Math.abs(mean) || 1;
        const confidence = Math.max(
          0,
          100 - (avgSpread / avgValue * 50),
        ).toFixed(1);

        document.getElementById("statMin").textContent = min.toFixed(3);
        document.getElementById("statMax").textContent = max.toFixed(3);
        document.getElementById("statMean").textContent = mean.toFixed(
          3,
        );
        document.getElementById("statFinal").textContent = final
          .toFixed(3);

        const trendEl = document.getElementById("statTrend");
        if (trend >= 0) {
          trendEl.innerHTML = `<span class="text-emerald-500">‚Üë ${
            trend.toFixed(3)
          }</span>`;
        } else {
          trendEl.innerHTML = `<span class="text-red-500">‚Üì ${
            Math.abs(trend).toFixed(3)
          }</span>`;
        }

        document.getElementById("statConfidence").textContent =
          confidence + "%";
      }

      function updateConfigInputs() {
        document.querySelectorAll(".config-input").forEach((input) => {
          const key = input.dataset.config;
          if (key && state.config[key] !== undefined) {
            input.value = state.config[key];
          }
        });

        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          const key = btn.dataset.config;
          if (key && state.config[key] !== undefined) {
            const isOn = state.config[key];
            btn.setAttribute("aria-pressed", isOn);
            btn.classList.toggle("bg-emerald-500", isOn);
            btn.classList.toggle("bg-slate-300", !isOn);
            btn.classList.toggle("dark:bg-slate-600", !isOn);
            btn.querySelector("span").classList.toggle(
              "translate-x-6",
              isOn,
            );
            btn.querySelector("span").classList.toggle(
              "translate-x-0",
              !isOn,
            );
          }
        });
      }

      function updateLogList() {
        const filter = document.getElementById("logFilter").value;
        const search = document.getElementById("logSearch").value
          .toLowerCase();
        const container = document.getElementById("logList");

        const filtered = state.logs.filter((log) => {
          if (filter !== "all" && log.type !== filter) return false;
          if (search && !log.message.toLowerCase().includes(search)) {
            return false;
          }
          return true;
        }).slice(-50);

        container.innerHTML = filtered.map((log) => {
          const colors = {
            info:
              "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
            success:
              "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
            warning:
              "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
            error:
              "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
          };
          return `
                    <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-800">
                        <span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${
            colors[log.type]
          }">${log.type}</span>
                        <span class="text-xs text-slate-500 ml-2">${log.time}</span>
                        <p class="text-slate-700 dark:text-slate-300 mt-1">${log.message}</p>
                    </div>
                `;
        }).join("");

        container.scrollTop = container.scrollHeight;
      }

      // ===== MODEL OPERATIONS =====
      async function createModel() {
        showLoading("Creating model...");
        try {
          await sendWorkerMessage("createModel", {
            config: state.config,
          });
          state.modelExists = true;
          state.sampleCount = 0;
          state.nDimensions = 0;
          state.predictions = null;
          closeAllModals();
          updateUI();
          renderVisualization();
          showToast("Model created successfully", "success");
          addLog(
            "success",
            "Model created with reservoir size " +
              state.config.reservoirSize,
          );
          savePreferences();
        } catch (e) {
          showToast("Failed to create model: " + e.message, "error");
          addLog("error", "Model creation failed: " + e.message);
        }
        hideLoading();
      }

      async function runPrediction() {
        if (!state.modelExists) return;

        const steps =
          parseInt(document.getElementById("futureStepsInput").value) ||
          50;
        showLoading("Running prediction...");

        try {
          const { result } = await sendWorkerMessage("predict", {
            steps,
          });
          state.predictions = result;
          state.nDimensions = result.predictions[0]?.length || 0;
          resetZoom();
          updateUI();
          renderVisualization();
          showToast(`Predicted ${steps} steps`, "success");
          addLog(
            "success",
            `Generated ${steps} step prediction for ${state.nDimensions} dimensions`,
          );
        } catch (e) {
          showToast("Prediction failed: " + e.message, "error");
          addLog("error", "Prediction failed: " + e.message);
        }
        hideLoading();
      }

      async function trainOnData(coordinates) {
        if (!state.modelExists) {
          await createModel();
        }

        showLoading("Training on data...");
        isCancelled = false;

        try {
          const batchSize = 10;
          for (
            let i = 0;
            i < coordinates.length - 1 && !isCancelled;
            i += batchSize
          ) {
            const batch = coordinates.slice(
              i,
              Math.min(i + batchSize + 1, coordinates.length),
            );
            if (batch.length < 2) break;

            const { result, summary } = await sendWorkerMessage(
              "train",
              { data: { coordinates: batch } },
            );
            state.metrics = {
              avgLoss: result.averageLoss,
              gradientNorm: result.gradientNorm,
              sampleWeight: result.sampleWeight,
            };
            state.sampleCount = summary.sampleCount ||
              state.sampleCount + batch.length - 1;
            state.nDimensions = summary.nFeatures ||
              coordinates[0].length;

            updateProgress((i / coordinates.length) * 100);
            updateUI();
          }

          if (!isCancelled) {
            showToast("Training complete", "success");
            addLog(
              "success",
              `Trained on ${coordinates.length} samples`,
            );
          }
        } catch (e) {
          showToast("Training failed: " + e.message, "error");
          addLog("error", "Training failed: " + e.message);
        }
        hideLoading();
      }

      // ===== DATA HANDLING =====
      function handleFileDrop(e) {
        e.preventDefault();
        document.getElementById("dropZone").classList.remove(
          "border-blue-500",
        );
        const file = e.dataTransfer.files[0];
        if (file) readFile(file);
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) readFile(file);
      }

      function readFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("jsonInput").value = e.target.result;
          validateUploadData();
        };
        reader.readAsText(file);
      }

      function validateUploadData() {
        const input = document.getElementById("jsonInput").value;
        const preview = document.getElementById("uploadPreview");
        const error = document.getElementById("uploadError");
        const applyBtn = document.getElementById("applyTrainBtn");

        preview.classList.add("hidden");
        error.classList.add("hidden");
        applyBtn.disabled = true;

        try {
          const data = JSON.parse(input);
          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            throw new Error('Missing "coordinates" array');
          }
          if (data.coordinates.length < 2) {
            throw new Error("Need at least 2 time steps");
          }
          if (!Array.isArray(data.coordinates[0])) {
            throw new Error("Coordinates must be arrays of arrays");
          }

          const dims = data.coordinates[0].length;
          const steps = data.coordinates.length;

          document.getElementById("previewInfo").textContent =
            `Valid: ${dims} dimensions, ${steps} time steps`;
          preview.classList.remove("hidden");
          applyBtn.disabled = false;
        } catch (e) {
          document.getElementById("uploadErrorText").textContent =
            e.message;
          error.classList.remove("hidden");
        }
      }

      async function applyAndTrain() {
        const input = document.getElementById("jsonInput").value;
        try {
          const data = JSON.parse(input);
          closeAllModals();
          await trainOnData(data.coordinates);
        } catch (e) {
          showToast("Invalid data: " + e.message, "error");
        }
      }

      function generateTemplate() {
        const dims = state.nDimensions || 3;
        const template = {
          coordinates: [
            Array(dims).fill(0).map((_, i) =>
              (1.0 + i * 0.1).toFixed(1)
            ),
            Array(dims).fill(0).map((_, i) =>
              (1.1 + i * 0.1).toFixed(1)
            ),
          ],
        };
        document.getElementById("insertInput").value = JSON.stringify(
          template,
          null,
          2,
        );
      }

      async function insertAndTrain() {
        const input = document.getElementById("insertInput").value;
        const feedback = document.getElementById("insertFeedback");

        try {
          const data = JSON.parse(input);
          if (!data.coordinates || data.coordinates.length < 2) {
            throw new Error("Need at least 2 coordinates");
          }

          closeAllModals();
          await trainOnData(data.coordinates);
        } catch (e) {
          feedback.classList.remove("hidden");
          feedback.classList.add(
            "bg-red-50",
            "dark:bg-red-900/20",
            "border",
            "border-red-200",
            "dark:border-red-700",
            "text-red-700",
            "dark:text-red-300",
          );
          feedback.textContent = "Error: " + e.message;
        }
      }

      // ===== SAVE/LOAD =====
      async function downloadModel() {
        if (!state.modelExists) {
          showToast("No model to save", "warning");
          return;
        }

        try {
          const { result } = await sendWorkerMessage("save", {});
          const blob = new Blob([JSON.stringify(result)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "esn-model-" + Date.now() + ".json";
          a.click();
          URL.revokeObjectURL(url);
          showToast("Model downloaded", "success");
        } catch (e) {
          showToast("Save failed: " + e.message, "error");
        }
      }

      async function saveToBrowser() {
        if (!state.modelExists) {
          showToast("No model to save", "warning");
          return;
        }

        const name = prompt(
          "Enter a name for this model:",
          "Model " + new Date().toLocaleString(),
        );
        if (!name) return;

        try {
          const { result } = await sendWorkerMessage("save", {});
          const saved = JSON.parse(
            localStorage.getItem("esnSavedModels") || "[]",
          );
          saved.push({
            name,
            date: Date.now(),
            state: result,
            dims: state.nDimensions,
          });
          localStorage.setItem("esnSavedModels", JSON.stringify(saved));
          updateSavedModelsList();
          showToast("Model saved to browser", "success");
        } catch (e) {
          showToast("Save failed: " + e.message, "error");
        }
      }

      function updateSavedModelsList() {
        const container = document.getElementById("savedModelsList");
        const saved = JSON.parse(
          localStorage.getItem("esnSavedModels") || "[]",
        );

        if (saved.length === 0) {
          container.innerHTML =
            '<p class="text-slate-500 dark:text-slate-400 text-sm">No saved models</p>';
          return;
        }

        container.innerHTML = saved.map((model, i) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                    <div>
                        <p class="font-medium text-slate-800 dark:text-slate-100">${model.name}</p>
                        <p class="text-xs text-slate-500">${
          model.dims || "?"
        } dims</p>
                    </div>
                    <button onclick="loadSavedModel(${i})" class="min-h-[36px] px-3 py-1.5 rounded-lg bg-blue-500 text-white text-sm font-medium" aria-label="Load model">Load</button>
                </div>
            `).join("");
      }

      window.loadSavedModel = async function (index) {
        const saved = JSON.parse(
          localStorage.getItem("esnSavedModels") || "[]",
        );
        if (!saved[index]) return;

        showLoading("Loading model...");
        try {
          const { summary } = await sendWorkerMessage("load", {
            state: saved[index].state,
          });
          state.modelExists = true;
          state.sampleCount = summary.sampleCount || 0;
          state.nDimensions = summary.nFeatures || 0;
          state.predictions = null;
          closeAllModals();
          updateUI();
          renderVisualization();
          showToast("Model loaded", "success");
          addLog("success", "Loaded model: " + saved[index].name);
        } catch (e) {
          showToast("Load failed: " + e.message, "error");
        }
        hideLoading();
      };

      function handleLoadFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (ev) => {
          showLoading("Loading model...");
          try {
            const modelState = JSON.parse(ev.target.result);
            const { summary } = await sendWorkerMessage("load", {
              state: modelState,
            });
            state.modelExists = true;
            state.sampleCount = summary.sampleCount || 0;
            state.nDimensions = summary.nFeatures || 0;
            state.predictions = null;
            closeAllModals();
            updateUI();
            renderVisualization();
            showToast("Model loaded from file", "success");
          } catch (e) {
            showToast("Invalid model file: " + e.message, "error");
          }
          hideLoading();
        };
        reader.readAsText(file);
      }

      function clearSavedModels() {
        if (confirm("Clear all saved models?")) {
          localStorage.removeItem("esnSavedModels");
          updateSavedModelsList();
          showToast("Saved models cleared", "info");
        }
      }

      // ===== RANDOM TEST =====
      async function generateAndRun() {
        const seed = parseInt(
          document.getElementById("randomSeed").value,
        );
        const dims = parseInt(
          document.getElementById("randomDims").value,
        );
        const steps = parseInt(
          document.getElementById("randomSteps").value,
        );
        const noise = parseFloat(
          document.getElementById("randomNoise").value,
        );
        const outlierRate = parseFloat(
          document.getElementById("randomOutliers").value,
        );
        const difficulty =
          document.getElementById("randomDifficulty").value;

        closeAllModals();
        showLoading("Generating synthetic data...");

        // Simple seeded random
        let s = seed;
        const random = () => {
          s = (s * 9301 + 49297) % 233280;
          return s / 233280;
        };

        const difficultyParams = {
          easy: { freq: 0.05, amp: 1 },
          medium: { freq: 0.1, amp: 2 },
          hard: { freq: 0.2, amp: 3 },
        };
        const { freq, amp } = difficultyParams[difficulty];

        const coordinates = [];
        for (let t = 0; t < steps; t++) {
          const point = [];
          for (let d = 0; d < dims; d++) {
            let value =
              amp * Math.sin(2 * Math.PI * freq * t + d * 0.5) +
              amp * 0.5 * Math.cos(2 * Math.PI * freq * 2 * t + d);
            value += (random() - 0.5) * 2 * noise;

            // Outliers
            if (random() < outlierRate) {
              value += (random() - 0.5) * 10 * amp;
            }

            point.push(value);
          }
          coordinates.push(point);
        }

        hideLoading();

        // Create model if needed
        if (!state.modelExists) {
          await createModel();
        }

        // Train on most of the data
        const trainData = coordinates.slice(0, Math.floor(steps * 0.8));
        await trainOnData(trainData);

        // Run prediction
        await runPrediction();
      }

      // ===== VISUALIZATION =====
      function renderVisualization() {
        const w = canvas.width / (window.devicePixelRatio || 1);
        const h = canvas.height / (window.devicePixelRatio || 1);

        // Background
        ctx.fillStyle = state.isDark ? "#1e293b" : "#ffffff";
        ctx.fillRect(0, 0, w, h);

        if (!state.predictions) return;

        switch (state.vizMode) {
          case "grid":
            renderGridView(w, h);
            break;
          case "focus":
            renderFocusView(w, h);
            break;
          case "heatmap":
            renderHeatmap(w, h);
            break;
          case "uncertainty":
            renderUncertainty(w, h);
            break;
          case "snapshot":
            renderSnapshot(w, h);
            break;
        }
      }

      function renderGridView(w, h) {
        const dims = state.nDimensions;
        const cols = dims <= 2 ? dims : dims <= 4 ? 2 : 3;
        const rows = Math.ceil(dims / cols);

        const padding = 40;
        const gap = 20;
        const cellW = (w - padding * 2 - gap * (cols - 1)) / cols;
        const cellH = (h - padding * 2 - gap * (rows - 1)) / rows;

        for (let d = 0; d < dims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = padding + col * (cellW + gap);
          const y = padding + row * (cellH + gap);

          renderMiniChart(x, y, cellW, cellH, d);
        }
      }

      function renderMiniChart(x, y, w, h, dim) {
        const predictions = state.predictions.predictions;
        const lowers = state.predictions.lowerBounds;
        const uppers = state.predictions.upperBounds;
        const color = DIMENSION_COLORS[dim % DIMENSION_COLORS.length];

        // Get values for this dimension
        const values = predictions.map((p) => p[dim]);
        const lowerVals = lowers.map((l) => l[dim]);
        const upperVals = uppers.map((u) => u[dim]);

        const allVals = [...values, ...lowerVals, ...upperVals];
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        const chartPadding = 30;
        const chartX = x + chartPadding;
        const chartY = y + 20;
        const chartW = w - chartPadding * 1.5;
        const chartH = h - 40;

        // Title
        ctx.fillStyle = state.isDark ? "#e2e8f0" : "#1e293b";
        ctx.font = "bold 12px Inter, sans-serif";
        ctx.fillText("D" + (dim + 1), x + 10, y + 15);

        // Confidence interval fill
        ctx.fillStyle = color + "20";
        ctx.beginPath();
        for (let i = 0; i < values.length; i++) {
          const px = chartX + (i / (values.length - 1)) * chartW;
          const py = chartY +
            (1 - (upperVals[i] - minVal) / range) * chartH;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        for (let i = values.length - 1; i >= 0; i--) {
          const px = chartX + (i / (values.length - 1)) * chartW;
          const py = chartY +
            (1 - (lowerVals[i] - minVal) / range) * chartH;
          ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < values.length; i++) {
          const px = chartX + (i / (values.length - 1)) * chartW;
          const py = chartY +
            (1 - (values[i] - minVal) / range) * chartH;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      }

      function renderFocusView(w, h) {
        const dim = state.selectedDim;
        const predictions = state.predictions.predictions;
        const lowers = state.predictions.lowerBounds;
        const uppers = state.predictions.upperBounds;
        const color = DIMENSION_COLORS[dim % DIMENSION_COLORS.length];

        const values = predictions.map((p) => p[dim]);
        const lowerVals = lowers.map((l) => l[dim]);
        const upperVals = uppers.map((u) => u[dim]);

        const allVals = [...values, ...lowerVals, ...upperVals];
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        const padding = { left: 60, right: 30, top: 30, bottom: 50 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        // Apply zoom
        const visibleCount = Math.max(
          10,
          Math.floor(values.length / state.zoom.level),
        );
        const maxOffset = Math.max(0, values.length - visibleCount);
        state.zoom.offsetX = Math.min(
          Math.max(0, state.zoom.offsetX),
          maxOffset,
        );
        const startIdx = Math.floor(state.zoom.offsetX);
        const endIdx = Math.min(startIdx + visibleCount, values.length);

        // Grid lines
        ctx.strokeStyle = state.isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartH;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(w - padding.right, y);
          ctx.stroke();

          const val = maxVal - (i / 5) * range;
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px Inter, sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 10, y + 4);
        }

        // X axis labels
        ctx.textAlign = "center";
        for (let i = 0; i <= 5; i++) {
          const idx = startIdx +
            Math.floor((i / 5) * (endIdx - startIdx - 1));
          const x = padding.left + (i / 5) * chartW;
          ctx.fillText(idx + 1, x, h - padding.bottom + 20);
        }

        // Confidence interval
        ctx.fillStyle = color + "30";
        ctx.beginPath();
        for (let i = startIdx; i < endIdx; i++) {
          const px = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * chartW;
          const py = padding.top +
            (1 - (upperVals[i] - minVal) / range) * chartH;
          if (i === startIdx) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        for (let i = endIdx - 1; i >= startIdx; i--) {
          const px = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * chartW;
          const py = padding.top +
            (1 - (lowerVals[i] - minVal) / range) * chartH;
          ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let i = startIdx; i < endIdx; i++) {
          const px = padding.left +
            ((i - startIdx) / (endIdx - startIdx - 1)) * chartW;
          const py = padding.top +
            (1 - (values[i] - minVal) / range) * chartH;
          if (i === startIdx) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Hover crosshair
        if (
          state.hover.active && state.hover.dataIndex >= startIdx &&
          state.hover.dataIndex < endIdx
        ) {
          const idx = state.hover.dataIndex;
          const px = padding.left +
            ((idx - startIdx) / (endIdx - startIdx - 1)) * chartW;
          const py = padding.top +
            (1 - (values[idx] - minVal) / range) * chartH;

          ctx.strokeStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(px, padding.top);
          ctx.lineTo(px, h - padding.bottom);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(padding.left, py);
          ctx.lineTo(w - padding.right, py);
          ctx.stroke();
          ctx.setLineDash([]);

          // Highlight point
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(px, py, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = "#ffffff";
          ctx.lineWidth = 2;
          ctx.stroke();
        }

        // Update zoom badge
        document.getElementById("zoomBadge").textContent =
          Math.round(state.zoom.level * 100) + "%";
        document.getElementById("zoomBadge").classList.remove("hidden");
      }

      function renderHeatmap(w, h) {
        const predictions = state.predictions.predictions;
        const dims = state.nDimensions;
        const steps = predictions.length;

        const padding = { left: 60, right: 30, top: 30, bottom: 50 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        const cellW = chartW / steps;
        const cellH = chartH / dims;

        // Find global min/max
        let globalMin = Infinity, globalMax = -Infinity;
        for (const p of predictions) {
          for (const v of p) {
            globalMin = Math.min(globalMin, v);
            globalMax = Math.max(globalMax, v);
          }
        }
        const range = globalMax - globalMin || 1;

        // Draw cells
        for (let d = 0; d < dims; d++) {
          for (let s = 0; s < steps; s++) {
            const value = predictions[s][d];
            const normalized = (value - globalMin) / range;

            // Blue to red gradient
            const r = Math.round(normalized * 255);
            const b = Math.round((1 - normalized) * 255);
            const g = Math.round(
              (1 - Math.abs(normalized - 0.5) * 2) * 128,
            );

            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillRect(
              padding.left + s * cellW,
              padding.top + d * cellH,
              cellW + 1,
              cellH + 1,
            );
          }

          // Y axis label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px Inter, sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(
            "D" + (d + 1),
            padding.left - 10,
            padding.top + d * cellH + cellH / 2 + 4,
          );
        }

        // X axis labels
        ctx.textAlign = "center";
        for (let i = 0; i <= 5; i++) {
          const step = Math.floor((i / 5) * (steps - 1)) + 1;
          const x = padding.left + (i / 5) * chartW;
          ctx.fillText(step, x, h - padding.bottom + 20);
        }
      }

      function renderUncertainty(w, h) {
        const predictions = state.predictions.predictions;
        const lowers = state.predictions.lowerBounds;
        const uppers = state.predictions.upperBounds;

        const padding = { left: 60, right: 30, top: 30, bottom: 50 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        // Calculate average uncertainty per step
        const uncertainties = predictions.map((p, i) => {
          let total = 0;
          for (let d = 0; d < state.nDimensions; d++) {
            total += uppers[i][d] - lowers[i][d];
          }
          return total / state.nDimensions;
        });

        const maxU = Math.max(...uncertainties);
        const minU = Math.min(...uncertainties);
        const range = maxU - minU || 1;

        // Grid
        ctx.strokeStyle = state.isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartH;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(w - padding.right, y);
          ctx.stroke();

          const val = maxU - (i / 5) * range;
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px Inter, sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(3), padding.left - 10, y + 4);
        }

        // Area fill with gradient
        const gradient = ctx.createLinearGradient(
          0,
          padding.top,
          0,
          h - padding.bottom,
        );
        gradient.addColorStop(0, "#EF444480");
        gradient.addColorStop(1, "#10B98180");

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(padding.left, h - padding.bottom);
        for (let i = 0; i < uncertainties.length; i++) {
          const x = padding.left +
            (i / (uncertainties.length - 1)) * chartW;
          const y = padding.top +
            (1 - (uncertainties[i] - minU) / range) * chartH;
          ctx.lineTo(x, y);
        }
        ctx.lineTo(w - padding.right, h - padding.bottom);
        ctx.closePath();
        ctx.fill();

        // Line
        ctx.strokeStyle = "#8B5CF6";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < uncertainties.length; i++) {
          const x = padding.left +
            (i / (uncertainties.length - 1)) * chartW;
          const y = padding.top +
            (1 - (uncertainties[i] - minU) / range) * chartH;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Labels
        ctx.fillStyle = state.isDark ? "#e2e8f0" : "#1e293b";
        ctx.font = "bold 14px Inter, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("Average Uncertainty Over Time", w / 2, 20);
      }

      function renderSnapshot(w, h) {
        const step = Math.min(
          state.selectedStep,
          state.predictions.predictions.length,
        ) - 1;
        const values = state.predictions.predictions[step];
        const lowers = state.predictions.lowerBounds[step];
        const uppers = state.predictions.upperBounds[step];

        const padding = { left: 60, right: 30, top: 50, bottom: 50 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        const barWidth = Math.min(
          60,
          (chartW - 20 * (state.nDimensions - 1)) / state.nDimensions,
        );
        const totalWidth = barWidth * state.nDimensions +
          20 * (state.nDimensions - 1);
        const startX = padding.left + (chartW - totalWidth) / 2;

        // Find range
        const allVals = [...values, ...lowers, ...uppers];
        const minVal = Math.min(0, Math.min(...allVals));
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        // Title
        ctx.fillStyle = state.isDark ? "#e2e8f0" : "#1e293b";
        ctx.font = "bold 16px Inter, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(`Step ${step + 1} Predictions`, w / 2, 30);

        // Bars
        for (let d = 0; d < state.nDimensions; d++) {
          const x = startX + d * (barWidth + 20);
          const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

          // Error bar
          const errTop = padding.top +
            (1 - (uppers[d] - minVal) / range) * chartH;
          const errBottom = padding.top +
            (1 - (lowers[d] - minVal) / range) * chartH;

          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 2, errTop);
          ctx.lineTo(x + barWidth / 2, errBottom);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 4, errTop);
          ctx.lineTo(x + 3 * barWidth / 4, errTop);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 4, errBottom);
          ctx.lineTo(x + 3 * barWidth / 4, errBottom);
          ctx.stroke();

          // Bar
          const barTop = padding.top +
            (1 - (Math.max(0, values[d]) - minVal) / range) * chartH;
          const barBottom = padding.top +
            (1 - (Math.min(0, values[d]) - minVal) / range) * chartH;

          ctx.fillStyle = color;
          ctx.fillRect(x, barTop, barWidth, barBottom - barTop);

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "12px Inter, sans-serif";
          ctx.textAlign = "center";
          ctx.fillText(
            "D" + (d + 1),
            x + barWidth / 2,
            h - padding.bottom + 20,
          );

          // Value
          ctx.fillStyle = state.isDark ? "#e2e8f0" : "#1e293b";
          ctx.font = "bold 11px Inter, sans-serif";
          ctx.fillText(
            values[d].toFixed(2),
            x + barWidth / 2,
            barTop - 8,
          );
        }

        // Zero line
        const zeroY = padding.top + (1 - (0 - minVal) / range) * chartH;
        ctx.strokeStyle = state.isDark ? "#475569" : "#94a3b8";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, zeroY);
        ctx.lineTo(w - padding.right, zeroY);
        ctx.stroke();
      }

      // ===== CANVAS INTERACTIONS =====
      function handleCanvasMouseMove(e) {
        if (!state.predictions) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        updateHover(x, y);
      }

      function handleCanvasMouseLeave() {
        state.hover.active = false;
        document.getElementById("tooltip").classList.add("hidden");
        renderVisualization();
      }

      function updateHover(x, y) {
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;
        const padding = { left: 60, right: 30, top: 30, bottom: 50 };

        if (state.vizMode === "focus" && state.predictions) {
          const chartW = w - padding.left - padding.right;
          const steps = state.predictions.predictions.length;
          const visibleCount = Math.max(
            10,
            Math.floor(steps / state.zoom.level),
          );
          const startIdx = Math.floor(state.zoom.offsetX);
          const endIdx = Math.min(startIdx + visibleCount, steps);

          if (x >= padding.left && x <= w - padding.right) {
            const relX = (x - padding.left) / chartW;
            const idx = startIdx +
              Math.floor(relX * (endIdx - startIdx));

            if (idx >= 0 && idx < steps) {
              state.hover.active = true;
              state.hover.x = x;
              state.hover.y = y;
              state.hover.dataIndex = idx;

              updateTooltip(x, y, idx);
              renderVisualization();
              return;
            }
          }
        }

        state.hover.active = false;
        document.getElementById("tooltip").classList.add("hidden");
      }

      function updateTooltip(x, y, idx) {
        const tooltip = document.getElementById("tooltip");
        const dim = state.selectedDim;
        const value = state.predictions.predictions[idx][dim];
        const lower = state.predictions.lowerBounds[idx][dim];
        const upper = state.predictions.upperBounds[idx][dim];
        const spread = upper - lower;
        const color = DIMENSION_COLORS[dim % DIMENSION_COLORS.length];

        document.getElementById("tooltipStep").textContent = "Step " +
          (idx + 1);
        document.getElementById("tooltipDimDot").style.backgroundColor =
          color;
        document.getElementById("tooltipDimName").textContent =
          "Dimension " + (dim + 1);
        document.getElementById("tooltipValue").textContent = value
          .toFixed(4);
        document.getElementById("tooltipCI").textContent =
          lower.toFixed(4) + " - " + upper.toFixed(4);
        document.getElementById("tooltipSpread").textContent = spread
          .toFixed(4);

        const rect = canvas.getBoundingClientRect();
        let left = x + 15;
        let top = y + 15;

        if (left + 200 > rect.width) left = x - 195;
        if (top + 150 > rect.height) top = y - 155;

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.classList.remove("hidden");
      }

      function handleCanvasWheel(e) {
        if (!state.predictions || state.vizMode !== "focus") return;

        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const factor = e.deltaY < 0 ? 1.1 : 0.9;
          zoom(factor);
        } else {
          const delta = e.deltaX || e.deltaY;
          state.zoom.offsetX += delta * 0.1;
          renderVisualization();
        }
      }

      function handleTouchStart(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          touchState.isPinching = true;
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          touchState.startDist = Math.sqrt(dx * dx + dy * dy);
        } else if (e.touches.length === 1) {
          touchState.isDragging = true;
          touchState.startX = e.touches[0].clientX;
        }
      }

      function handleTouchMove(e) {
        if (touchState.isPinching && e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const factor = dist / touchState.startDist;
          zoom(factor);
          touchState.startDist = dist;
        } else if (touchState.isDragging && e.touches.length === 1) {
          const deltaX = touchState.startX - e.touches[0].clientX;
          state.zoom.offsetX += deltaX * 0.5;
          touchState.startX = e.touches[0].clientX;
          renderVisualization();
        }
      }

      function handleTouchEnd() {
        touchState.isPinching = false;
        touchState.isDragging = false;
      }

      function zoom(factor) {
        state.zoom.level = Math.max(
          1,
          Math.min(10, state.zoom.level * factor),
        );
        renderVisualization();
      }

      function resetZoom() {
        state.zoom.level = 1;
        state.zoom.offsetX = 0;
        renderVisualization();
      }

      // ===== EXPORT =====
      function exportPNG() {
        const link = document.createElement("a");
        link.download = "esn-prediction.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
        showToast("PNG exported", "success");
      }

      function exportSVG() {
        // Create a simple SVG export
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;

        let svg =
          `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
        svg += `<rect width="100%" height="100%" fill="${
          state.isDark ? "#1e293b" : "#ffffff"
        }"/>`;
        svg += `<text x="${w / 2}" y="30" text-anchor="middle" fill="${
          state.isDark ? "#e2e8f0" : "#1e293b"
        }" font-size="14" font-weight="bold">ESN Prediction Export</text>`;
        svg += `</svg>`;

        const blob = new Blob([svg], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "esn-prediction.svg";
        a.click();
        URL.revokeObjectURL(url);
        showToast("SVG exported", "success");
      }

      async function exportClipboard() {
        try {
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/png")
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("Copied to clipboard", "success");
        } catch (e) {
          showToast("Copy failed: " + e.message, "error");
        }
      }

      // ===== DATA TABLE =====
      function populateDataTable() {
        if (!state.predictions) {
          document.getElementById("tableBody").innerHTML =
            '<tr><td colspan="100" class="p-8 text-center text-slate-500">No predictions available</td></tr>';
          return;
        }

        const header = document.getElementById("tableHeader");
        const body = document.getElementById("tableBody");

        // Header
        let headerHTML =
          '<th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-slate-300 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700" data-sort="step">Step</th>';
        for (let d = 0; d < state.nDimensions; d++) {
          headerHTML +=
            `<th class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700" style="color: ${
              DIMENSION_COLORS[d % DIMENSION_COLORS.length]
            }">P${d + 1}</th>`;
        }
        for (let d = 0; d < state.nDimensions; d++) {
          headerHTML +=
            `<th class="px-4 py-3 text-left font-semibold text-slate-500 dark:text-slate-400">L${
              d + 1
            }</th>`;
        }
        for (let d = 0; d < state.nDimensions; d++) {
          headerHTML +=
            `<th class="px-4 py-3 text-left font-semibold text-slate-500 dark:text-slate-400">U${
              d + 1
            }</th>`;
        }
        header.innerHTML = headerHTML;

        // Body
        let bodyHTML = "";
        for (let i = 0; i < state.predictions.predictions.length; i++) {
          const bgClass = i % 2 === 0
            ? "bg-white dark:bg-slate-900"
            : "bg-slate-50 dark:bg-slate-800";
          bodyHTML +=
            `<tr class="${bgClass} hover:bg-blue-50 dark:hover:bg-slate-700">`;
          bodyHTML += `<td class="px-4 py-2 font-medium">${i + 1}</td>`;

          for (let d = 0; d < state.nDimensions; d++) {
            bodyHTML += `<td class="px-4 py-2">${
              state.predictions.predictions[i][d].toFixed(4)
            }</td>`;
          }
          for (let d = 0; d < state.nDimensions; d++) {
            bodyHTML += `<td class="px-4 py-2 text-slate-500">${
              state.predictions.lowerBounds[i][d].toFixed(4)
            }</td>`;
          }
          for (let d = 0; d < state.nDimensions; d++) {
            bodyHTML += `<td class="px-4 py-2 text-slate-500">${
              state.predictions.upperBounds[i][d].toFixed(4)
            }</td>`;
          }
          bodyHTML += "</tr>";
        }
        body.innerHTML = bodyHTML;
      }

      function filterTable() {
        const search = document.getElementById("tableSearch").value
          .toLowerCase();
        const rows = document.querySelectorAll("#tableBody tr");

        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? "" : "none";
        });
      }

      function exportCSV() {
        if (!state.predictions) return;

        let csv = "Step";
        for (let d = 0; d < state.nDimensions; d++) csv += `,P${d + 1}`;
        for (let d = 0; d < state.nDimensions; d++) csv += `,L${d + 1}`;
        for (let d = 0; d < state.nDimensions; d++) csv += `,U${d + 1}`;
        csv += "\n";

        for (let i = 0; i < state.predictions.predictions.length; i++) {
          csv += i + 1;
          for (let d = 0; d < state.nDimensions; d++) {
            csv += "," + state.predictions.predictions[i][d];
          }
          for (let d = 0; d < state.nDimensions; d++) {
            csv += "," + state.predictions.lowerBounds[i][d];
          }
          for (let d = 0; d < state.nDimensions; d++) {
            csv += "," + state.predictions.upperBounds[i][d];
          }
          csv += "\n";
        }

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "esn-predictions.csv";
        a.click();
        URL.revokeObjectURL(url);
        showToast("CSV exported", "success");
      }

      function copyTableData() {
        if (!state.predictions) return;

        let text = "";
        const rows = document.querySelectorAll("#dataTable tr");
        rows.forEach((row) => {
          const cells = row.querySelectorAll("th, td");
          text += Array.from(cells).map((c) =>
            c.textContent
          ).join("\t") + "\n";
        });

        navigator.clipboard.writeText(text);
        showToast("Table copied", "success");
      }

      // ===== UTILITY FUNCTIONS =====
      function showLoading(text) {
        document.getElementById("loadingText").textContent = text ||
          "Processing...";
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("progressText").textContent = "0%";
        document.getElementById("loadingOverlay").classList.remove(
          "hidden",
        );
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add(
          "hidden",
        );
      }

      function updateProgress(percent) {
        document.getElementById("progressBar").style.width = percent +
          "%";
        document.getElementById("progressText").textContent =
          Math.round(percent) + "%";
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between gap-4 animate-pulse`;
        toast.innerHTML = `
                <span>${message}</span>
                <button class="min-w-[44px] min-h-[44px] p-2 hover:bg-white/20 rounded-lg text-lg" aria-label="Close toast">‚úñÔ∏è</button>
            `;

        toast.querySelector("button").addEventListener(
          "click",
          () => toast.remove(),
        );
        container.appendChild(toast);

        const timeout = type === "error" ? 6000 : 4000;
        setTimeout(() => toast.remove(), timeout);
      }

      function addLog(type, message) {
        const now = new Date();
        const time = now.toLocaleTimeString();

        state.logs.push({ type, message, time });
        if (state.logs.length > 200) {
          state.logs = state.logs.slice(-200);
        }

        updateLogList();
      }

      // Initialize app
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
