<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {},
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 text-slate-800 dark:text-slate-100 transition-colors"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/50 dark:border-slate-700/50"
    >
      <div
        class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-xl shadow-lg shadow-blue-500/30 flex items-center justify-center text-xl"
          >
            üìä
          </div>
          <div>
            <h1 class="font-bold text-lg leading-tight">ESN Studio</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400">
              Autoregressive Forecasting
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div
            id="statusBadge"
            class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-sm"
          >
            <span
              id="statusDot"
              class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
            ></span>
            <span id="statusText">No Model</span>
          </div>
          <button
            id="predictBtn"
            class="hidden items-center gap-1.5 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow-lg shadow-blue-500/30 font-medium text-sm"
            aria-label="Run prediction"
          >
            ‚ö° Predict
          </button>
          <button
            id="configBtn"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors"
            aria-label="Configure model"
          >
            ‚öôÔ∏è
          </button>
          <button
            id="menuBtn"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors"
            aria-label="Open menu"
          >
            ‚ò∞
          </button>
          <button
            id="themeBtn"
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors"
            aria-label="Toggle theme"
          >
            <span class="dark:hidden">üåô</span>
            <span class="hidden dark:inline">‚òÄÔ∏è</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Visualization Area -->
        <div class="flex-1 min-w-0">
          <!-- Tab Navigation -->
          <div class="overflow-x-auto pb-2 mb-4 scrollbar-hide">
            <div class="flex gap-2 min-w-max" role="tablist">
              <button
                class="tab-btn active px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
                role="tab"
                aria-selected="true"
                data-mode="grid"
              >
                üìä Grid
              </button>
              <button
                class="tab-btn px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
                role="tab"
                aria-selected="false"
                data-mode="focus"
              >
                üîç Focus
              </button>
              <button
                class="tab-btn px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
                role="tab"
                aria-selected="false"
                data-mode="heatmap"
              >
                üå°Ô∏è Heatmap
              </button>
              <button
                class="tab-btn px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
                role="tab"
                aria-selected="false"
                data-mode="ci"
              >
                üìà CI
              </button>
              <button
                class="tab-btn px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
                role="tab"
                aria-selected="false"
                data-mode="snapshot"
              >
                üì∑ Snapshot
              </button>
            </div>
          </div>

          <!-- Dimension Selector (Focus Mode) -->
          <div id="dimSelector" class="hidden overflow-x-auto pb-2 mb-4">
            <div id="dimButtons" class="flex gap-2 min-w-max"></div>
          </div>

          <!-- Step Selector (Snapshot Mode) -->
          <div id="stepSelector" class="hidden flex items-center gap-3 mb-4">
            <label class="font-medium text-sm">Step:</label>
            <input
              type="number"
              id="stepInput"
              min="0"
              value="0"
              class="w-24 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              aria-label="Select prediction step"
            >
          </div>

          <!-- Statistics Bar (Focus Mode) -->
          <div
            id="statsBar"
            class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 mb-4"
          >
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Min
              </div>
              <div id="statMin" class="font-bold text-lg">-</div>
            </div>
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Max
              </div>
              <div id="statMax" class="font-bold text-lg">-</div>
            </div>
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Mean
              </div>
              <div id="statMean" class="font-bold text-lg">-</div>
            </div>
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Final
              </div>
              <div id="statFinal" class="font-bold text-lg">-</div>
            </div>
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Trend
              </div>
              <div id="statTrend" class="font-bold text-lg">-</div>
            </div>
            <div
              class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <div
                class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400"
              >
                Confidence
              </div>
              <div id="statConf" class="font-bold text-lg">-</div>
            </div>
          </div>

          <!-- Chart Container -->
          <div
            class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
          >
            <!-- Floating Controls -->
            <div
              id="floatingControls"
              class="hidden absolute top-3 right-3 flex gap-1 z-10"
            >
              <button
                id="zoomInBtn"
                class="w-8 h-8 bg-white/90 dark:bg-slate-700/90 backdrop-blur rounded-lg shadow flex items-center justify-center text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Zoom in"
              >
                ‚ûï
              </button>
              <button
                id="zoomOutBtn"
                class="w-8 h-8 bg-white/90 dark:bg-slate-700/90 backdrop-blur rounded-lg shadow flex items-center justify-center text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Zoom out"
              >
                ‚ûñ
              </button>
              <button
                id="zoomResetBtn"
                class="w-8 h-8 bg-white/90 dark:bg-slate-700/90 backdrop-blur rounded-lg shadow flex items-center justify-center text-sm hover:bg-slate-50 dark:hover:bg-slate-600"
                aria-label="Reset zoom"
              >
                üîÑ
              </button>
            </div>
            <div
              id="zoomBadge"
              class="hidden absolute top-3 left-3 px-2 py-1 bg-white/90 dark:bg-slate-700/90 backdrop-blur rounded text-xs font-medium shadow"
            >
              100%
            </div>

            <!-- Canvas -->
            <canvas
              id="mainCanvas"
              class="w-full"
              style="height: 400px"
            ></canvas>

            <!-- Empty State -->
            <div
              id="emptyState"
              class="absolute inset-0 flex flex-col items-center justify-center p-6"
            >
              <div class="relative mb-6">
                <div
                  class="w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-3xl flex items-center justify-center"
                >
                  <div
                    class="w-16 h-16 bg-gradient-to-br from-blue-200 to-indigo-200 dark:from-blue-800/50 dark:to-indigo-800/50 rounded-2xl flex items-center justify-center"
                  >
                    <span class="text-4xl">üìä</span>
                  </div>
                </div>
              </div>
              <h3 class="text-xl font-bold mb-2">Create a Model to Begin</h3>
              <p
                class="text-slate-500 dark:text-slate-400 text-center mb-6 max-w-sm"
              >
                Configure and train an Echo State Network for multivariate
                autoregressive forecasting
              </p>
              <div class="flex flex-wrap gap-3 justify-center">
                <button
                  id="startDefaultBtn"
                  class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg shadow-blue-500/30 font-medium"
                >
                  ‚ö° Start with Defaults
                </button>
                <button
                  id="loadModelBtn"
                  class="flex items-center gap-2 px-4 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
                >
                  üì§ Load
                </button>
                <button
                  id="demoBtn"
                  class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl shadow-lg font-medium"
                >
                  ‚ú® Demo
                </button>
              </div>
            </div>

            <!-- Loading State -->
            <div
              id="loadingState"
              class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur flex flex-col items-center justify-center"
            >
              <div
                class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"
                style="animation: spin 1s linear infinite"
              >
              </div>
              <p id="loadingText" class="font-medium mb-4">Processing...</p>
              <div
                class="w-48 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"
              >
                <div
                  id="progressBar"
                  class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all"
                  style="width: 0%"
                >
                </div>
              </div>
              <span
                id="progressText"
                class="text-sm text-slate-500 dark:text-slate-400 mb-4"
              >0%</span>
              <button
                id="cancelBtn"
                class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium"
              >
                Cancel
              </button>
            </div>

            <!-- Tooltip -->
            <div
              id="tooltip"
              class="hidden absolute pointer-events-none bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 p-3 z-20 min-w-48"
            >
              <div id="tooltipStep" class="font-bold text-lg mb-1">Step 0</div>
              <div class="flex items-center gap-2 mb-2">
                <span id="tooltipDot" class="w-3 h-3 rounded-full"></span>
                <span
                  id="tooltipDim"
                  class="text-sm text-slate-500 dark:text-slate-400"
                >Dimension 1</span>
              </div>
              <div class="space-y-1 text-sm">
                <div>
                  Predicted: <span id="tooltipValue" class="font-bold"
                  >0.000</span>
                </div>
                <div>
                  CI: <span
                    id="tooltipCI"
                    class="text-slate-500 dark:text-slate-400"
                  >0.00 - 0.00</span>
                </div>
                <div>
                  Spread: <span
                    id="tooltipSpread"
                    class="text-slate-500 dark:text-slate-400"
                  >0.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Export Controls -->
          <div id="exportControls" class="hidden flex gap-2 mt-4 justify-end">
            <button
              id="exportPNG"
              class="flex items-center gap-1.5 px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700"
              aria-label="Save as PNG"
            >
              üñºÔ∏è PNG
            </button>
            <button
              id="exportSVG"
              class="flex items-center gap-1.5 px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700"
              aria-label="Save as SVG"
            >
              üìÑ SVG
            </button>
            <button
              id="exportClip"
              class="flex items-center gap-1.5 px-3 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700"
              aria-label="Copy to clipboard"
            >
              üìã Copy
            </button>
          </div>
        </div>

        <!-- Side Panel -->
        <aside class="w-full lg:w-80 space-y-4">
          <!-- Model Metrics -->
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 p-4"
          >
            <h2
              class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-3"
            >
              Model Metrics
            </h2>
            <div class="space-y-2">
              <div
                class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
              >
                <span class="text-sm">Samples Trained</span>
                <span
                  id="metricSamples"
                  class="font-mono font-bold text-blue-500"
                >0</span>
              </div>
              <div
                class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
              >
                <span class="text-sm">Avg Loss</span>
                <span id="metricLoss" class="font-mono text-sm">-</span>
              </div>
              <div
                class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700"
              >
                <span class="text-sm">Gradient Norm</span>
                <span id="metricGrad" class="font-mono text-sm">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm">Sample Weight</span>
                <span id="metricWeight" class="font-mono text-sm">-</span>
              </div>
            </div>
          </div>

          <!-- Prediction -->
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 p-4"
          >
            <h2
              class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-3"
            >
              Prediction
            </h2>
            <div class="space-y-3">
              <div>
                <label class="block text-sm mb-1">Future Steps</label>
                <input
                  type="number"
                  id="futureSteps"
                  min="1"
                  value="50"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                  aria-label="Number of future steps to predict"
                >
              </div>
              <button
                id="runPredictBtn"
                class="w-full py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
                aria-label="Run prediction"
              >
                üîÆ Run Prediction
              </button>
            </div>
          </div>

          <!-- Event Log -->
          <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 p-4"
          >
            <div class="flex items-center justify-between mb-3">
              <h2
                class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold"
              >
                Event Log
              </h2>
              <select
                id="logFilter"
                class="text-xs px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700"
                aria-label="Filter log entries"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <input
              type="text"
              id="logSearch"
              placeholder="Search logs..."
              class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm mb-3"
              aria-label="Search log entries"
            >
            <div
              id="logContainer"
              class="h-48 overflow-y-auto space-y-2 text-sm"
            >
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Slide-out Menu -->
    <div
      id="menuOverlay"
      class="hidden fixed inset-0 bg-black/50 z-50"
      aria-hidden="true"
    >
    </div>
    <div
      id="slideMenu"
      class="fixed top-0 right-0 h-full w-80 max-w-full bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300"
      role="dialog"
      aria-label="Main menu"
    >
      <div
        class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
      >
        <h2 class="font-bold text-lg">Menu</h2>
        <button
          id="closeMenuBtn"
          class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          aria-label="Close menu"
        >
          ‚úñÔ∏è
        </button>
      </div>
      <div class="p-4 space-y-6 overflow-y-auto h-full pb-24">
        <!-- Model Section -->
        <div>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-2 flex items-center gap-2"
          >
            üìÅ Model
          </h3>
          <div class="space-y-2">
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="configure"
            >
              <div
                class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center text-xl"
              >
                üéõÔ∏è
              </div>
              <div>
                <div class="font-medium">Create & Configure</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Set up model parameters
                </div>
              </div>
            </button>
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="saveload"
            >
              <div
                class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center text-xl"
              >
                üíæ
              </div>
              <div>
                <div class="font-medium">Save & Load</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Persist your models
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- Data Section -->
        <div>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-2 flex items-center gap-2"
          >
            üìÇ Data
          </h3>
          <div class="space-y-2">
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="upload"
            >
              <div
                class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center text-xl"
              >
                üì§
              </div>
              <div>
                <div class="font-medium">Upload Dataset</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Import time series data
                </div>
              </div>
            </button>
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="manual"
            >
              <div
                class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center text-xl"
              >
                ‚ûï
              </div>
              <div>
                <div class="font-medium">Manual Insert</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Add individual time steps
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- Test Section -->
        <div>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-2 flex items-center gap-2"
          >
            üß™ Test
          </h3>
          <div class="space-y-2">
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="randomtest"
            >
              <div
                class="w-10 h-10 bg-pink-100 dark:bg-pink-900/30 rounded-lg flex items-center justify-center text-xl"
              >
                üí°
              </div>
              <div>
                <div class="font-medium">Random Test</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Generate synthetic time series
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- Advanced Section -->
        <div>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-2 flex items-center gap-2"
          >
            ‚öôÔ∏è Advanced
          </h3>
          <div class="space-y-2">
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="settings"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center text-xl"
              >
                üîß
              </div>
              <div>
                <div class="font-medium">Settings</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Module URL & preferences
                </div>
              </div>
            </button>
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="datatable"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center text-xl"
              >
                üìã
              </div>
              <div>
                <div class="font-medium">View Data Table</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Raw prediction values
                </div>
              </div>
            </button>
            <button
              class="menu-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-left"
              data-action="help"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center text-xl"
              >
                ‚ùì
              </div>
              <div>
                <div class="font-medium">Help</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                  Documentation & guide
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Model configuration"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">‚öôÔ∏è Model Configuration</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <!-- Presets -->
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 overflow-x-auto"
        >
          <div class="flex gap-2 min-w-max">
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-500 text-white"
              data-preset="default"
            >
              Start Here
            </button>
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700"
              data-preset="fast"
            >
              Fast
            </button>
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700"
              data-preset="balanced"
            >
              Balanced
            </button>
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700"
              data-preset="accurate"
            >
              Accurate
            </button>
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700"
              data-preset="adaptive"
            >
              Adaptive
            </button>
            <button
              class="preset-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700"
              data-preset="robust"
            >
              Robust
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Reservoir Architecture -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="true"
            >
              <span>üß† Reservoir Architecture</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div
              class="section-content grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">reservoirSize <span
                    class="text-slate-400"
                  >(256)</span></label>
                <input
                  type="number"
                  data-config="reservoirSize"
                  value="256"
                  min="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Neurons in reservoir</p>
              </div>
              <div>
                <label class="block text-sm mb-1">spectralRadius <span
                    class="text-slate-400"
                  >(0.9)</span></label>
                <input
                  type="number"
                  data-config="spectralRadius"
                  value="0.9"
                  step="0.01"
                  min="0"
                  max="2"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Memory length control</p>
              </div>
              <div>
                <label class="block text-sm mb-1">leakRate <span
                    class="text-slate-400"
                  >(0.3)</span></label>
                <input
                  type="number"
                  data-config="leakRate"
                  value="0.3"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Temporal smoothing</p>
              </div>
              <div>
                <label class="block text-sm mb-1">inputScale <span
                    class="text-slate-400"
                  >(1.0)</span></label>
                <input
                  type="number"
                  data-config="inputScale"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Input scaling factor</p>
              </div>
              <div>
                <label class="block text-sm mb-1">biasScale <span
                    class="text-slate-400"
                  >(0.1)</span></label>
                <input
                  type="number"
                  data-config="biasScale"
                  value="0.1"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Bias scaling</p>
              </div>
              <div>
                <label class="block text-sm mb-1">reservoirSparsity <span
                    class="text-slate-400"
                  >(0.9)</span></label>
                <input
                  type="number"
                  data-config="reservoirSparsity"
                  value="0.9"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Zero connections</p>
              </div>
              <div>
                <label class="block text-sm mb-1">inputSparsity <span
                    class="text-slate-400"
                  >(0.0)</span></label>
                <input
                  type="number"
                  data-config="inputSparsity"
                  value="0.0"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Input sparsity</p>
              </div>
              <div>
                <label class="block text-sm mb-1">activation</label>
                <select
                  data-config="activation"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                  <option value="tanh">tanh</option>
                  <option value="relu">relu</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">Activation function</p>
              </div>
            </div>
          </div>

          <!-- Readout Configuration -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="true"
            >
              <span>üì§ Readout Configuration</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div
              class="section-content grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
              >
                <div>
                  <div class="font-medium text-sm">useInputInReadout</div>
                  <div class="text-xs text-slate-500">
                    Append input to state
                  </div>
                </div>
                <button
                  data-config="useInputInReadout"
                  class="toggle-switch w-12 h-6 bg-blue-500 rounded-full relative"
                  data-value="true"
                >
                  <span
                    class="absolute w-5 h-5 bg-white rounded-full top-0.5 right-0.5 transition-all"
                  ></span>
                </button>
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
              >
                <div>
                  <div class="font-medium text-sm">useBiasInReadout</div>
                  <div class="text-xs text-slate-500">Include bias term</div>
                </div>
                <button
                  data-config="useBiasInReadout"
                  class="toggle-switch w-12 h-6 bg-blue-500 rounded-full relative"
                  data-value="true"
                >
                  <span
                    class="absolute w-5 h-5 bg-white rounded-full top-0.5 right-0.5 transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Training (RLS) -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="true"
            >
              <span>üéØ Training (RLS)</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div
              class="section-content grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">readoutTraining</label>
                <input
                  type="text"
                  value="rls"
                  disabled
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-600 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">RLS training</p>
              </div>
              <div>
                <label class="block text-sm mb-1">rlsLambda <span
                    class="text-slate-400"
                  >(0.999)</span></label>
                <input
                  type="number"
                  data-config="rlsLambda"
                  value="0.999"
                  step="0.001"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Forgetting factor</p>
              </div>
              <div>
                <label class="block text-sm mb-1">rlsDelta <span
                    class="text-slate-400"
                  >(1.0)</span></label>
                <input
                  type="number"
                  data-config="rlsDelta"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Initial P diagonal</p>
              </div>
              <div>
                <label class="block text-sm mb-1">epsilon <span
                    class="text-slate-400"
                  >(1e-8)</span></label>
                <input
                  type="number"
                  data-config="epsilon"
                  value="1e-8"
                  step="1e-9"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Numerical stability</p>
              </div>
              <div>
                <label class="block text-sm mb-1">l2Lambda <span
                    class="text-slate-400"
                  >(0.0001)</span></label>
                <input
                  type="number"
                  data-config="l2Lambda"
                  value="0.0001"
                  step="0.0001"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">L2 regularization</p>
              </div>
              <div>
                <label class="block text-sm mb-1">gradientClipNorm <span
                    class="text-slate-400"
                  >(1.0)</span></label>
                <input
                  type="number"
                  data-config="gradientClipNorm"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Max update norm</p>
              </div>
            </div>
          </div>

          <!-- Normalization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="false"
            >
              <span>üìè Normalization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div
              class="section-content hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">normalizationEpsilon <span
                    class="text-slate-400"
                  >(1e-8)</span></label>
                <input
                  type="number"
                  data-config="normalizationEpsilon"
                  value="1e-8"
                  step="1e-9"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Stability constant</p>
              </div>
              <div>
                <label class="block text-sm mb-1">normalizationWarmup <span
                    class="text-slate-400"
                  >(10)</span></label>
                <input
                  type="number"
                  data-config="normalizationWarmup"
                  value="10"
                  min="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Warmup samples</p>
              </div>
            </div>
          </div>

          <!-- Outlier Handling -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="false"
            >
              <span>üéØ Outlier Handling</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div
              class="section-content hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">outlierThreshold <span
                    class="text-slate-400"
                  >(3.0)</span></label>
                <input
                  type="number"
                  data-config="outlierThreshold"
                  value="3.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Z-score threshold</p>
              </div>
              <div>
                <label class="block text-sm mb-1">outlierMinWeight <span
                    class="text-slate-400"
                  >(0.1)</span></label>
                <input
                  type="number"
                  data-config="outlierMinWeight"
                  value="0.1"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Outlier min weight</p>
              </div>
            </div>
          </div>

          <!-- Uncertainty -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="false"
            >
              <span>üìä Uncertainty</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div
              class="section-content hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">uncertaintyMultiplier <span
                    class="text-slate-400"
                  >(1.96)</span></label>
                <input
                  type="number"
                  data-config="uncertaintyMultiplier"
                  value="1.96"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">
                  CI Multiplier (1.96 = 95% CI)
                </p>
              </div>
            </div>
          </div>

          <!-- Initialization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 font-semibold"
              aria-expanded="false"
            >
              <span>üîß Initialization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div
              class="section-content hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3"
            >
              <div>
                <label class="block text-sm mb-1">weightInitScale <span
                    class="text-slate-400"
                  >(0.1)</span></label>
                <input
                  type="number"
                  data-config="weightInitScale"
                  value="0.1"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Initial weight scale</p>
              </div>
              <div>
                <label class="block text-sm mb-1">seed <span
                    class="text-slate-400"
                  >(42)</span></label>
                <input
                  type="number"
                  data-config="seed"
                  value="42"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
                >
                <p class="text-xs text-slate-500 mt-1">Random seed</p>
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
              >
                <div>
                  <div class="font-medium text-sm">verbose</div>
                  <div class="text-xs text-slate-500">Detailed logging</div>
                </div>
                <button
                  data-config="verbose"
                  class="toggle-switch w-12 h-6 bg-slate-300 dark:bg-slate-600 rounded-full relative"
                  data-value="false"
                >
                  <span
                    class="absolute w-5 h-5 bg-white rounded-full top-0.5 left-0.5 transition-all"
                  ></span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2 justify-end"
        >
          <button
            id="resetDefaultsBtn"
            class="px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Reset Defaults
          </button>
          <button
            id="resetAllBtn"
            class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium text-sm"
          >
            Reset All
          </button>
          <button
            class="modal-close px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="createModelBtn"
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-medium text-sm shadow-lg shadow-blue-500/30"
          >
            Create Model
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Upload dataset"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">üì§ Upload Dataset</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div
            id="dropZone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
          >
            <div class="text-4xl mb-2">üìÅ</div>
            <p class="font-medium">Drop JSON file here or tap to browse</p>
            <input type="file" id="fileInput" accept=".json" class="hidden">
          </div>
          <div class="text-center text-sm text-slate-500">
            or paste JSON below
          </div>
          <textarea
            id="dataTextarea"
            rows="6"
            class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm font-mono"
            placeholder='{"coordinates": [[1,2,3], [4,5,6], ...]}'
          ></textarea>

          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between py-2 text-sm font-medium"
              aria-expanded="false"
            >
              <span>üìã Format Example</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="section-content hidden mt-2">
              <pre
                class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg text-xs overflow-x-auto"
              >
{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</pre>
              <button
                id="copyExampleBtn"
                class="mt-2 text-sm text-blue-500 hover:underline"
              >
                üìã Copy example
              </button>
            </div>
          </div>

          <div
            id="uploadPreview"
            class="hidden p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800"
          >
            <div class="text-emerald-700 dark:text-emerald-300 font-medium">
              ‚úÖ Valid Data
            </div>
            <div class="text-sm text-emerald-600 dark:text-emerald-400">
              <span id="previewDims">0</span> dimensions √ó <span
                id="previewSteps"
              >0</span> time steps
            </div>
          </div>
          <div
            id="uploadError"
            class="hidden p-3 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800"
          >
            <div class="text-red-700 dark:text-red-300 font-medium">
              ‚ùå Invalid Data
            </div>
            <div
              id="uploadErrorMsg"
              class="text-sm text-red-600 dark:text-red-400"
            >
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            class="modal-close px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="validateDataBtn"
            class="px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Validate
          </button>
          <button
            id="applyTrainBtn"
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-medium text-sm shadow-lg disabled:opacity-50"
            disabled
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="manualModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Manual data insert"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">‚ûï Manual Insert</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Add individual time steps to train the model. Min 2 coordinates
            required.
          </p>
          <button
            id="genTemplateBtn"
            class="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm font-medium"
          >
            üìù Generate Template
          </button>
          <textarea
            id="manualTextarea"
            rows="8"
            class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm font-mono"
            placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
          ></textarea>
          <div id="manualFeedback" class="hidden p-3 rounded-lg"></div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            class="modal-close px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="insertTrainBtn"
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-medium text-sm shadow-lg"
          >
            Insert & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Save and load models"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">üíæ Save & Load</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <div>
            <h3 class="font-semibold mb-3">Save Model</h3>
            <div class="flex gap-2">
              <button
                id="downloadModelBtn"
                class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                üì• Download
              </button>
              <button
                id="saveLocalBtn"
                class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-600"
              >
                üíæ Browser
              </button>
            </div>
          </div>
          <div>
            <h3 class="font-semibold mb-3">Load Model</h3>
            <div
              id="loadDropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors mb-4"
            >
              <div class="text-2xl mb-1">üì§</div>
              <p class="text-sm">Tap to upload model file</p>
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="hidden"
              >
            </div>
            <div id="savedModelsList" class="space-y-2"></div>
            <button
              id="clearSavedBtn"
              class="mt-3 text-sm text-red-500 hover:underline"
            >
              Clear all saved models
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Random test generator"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">üí° Random Test</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1">Seed</label>
              <input
                type="number"
                id="randSeed"
                value="42"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
            </div>
            <div>
              <label class="block text-sm mb-1">Dimensions</label>
              <input
                type="number"
                id="randDims"
                value="3"
                min="1"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
            </div>
            <div>
              <label class="block text-sm mb-1">Time Steps</label>
              <input
                type="number"
                id="randSteps"
                value="200"
                min="10"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
            </div>
            <div>
              <label class="block text-sm mb-1">Noise</label>
              <input
                type="number"
                id="randNoise"
                value="0.1"
                min="0"
                step="0.01"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
            </div>
            <div>
              <label class="block text-sm mb-1">Outliers Rate</label>
              <input
                type="number"
                id="randOutliers"
                value="0.02"
                min="0"
                max="1"
                step="0.01"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
            </div>
            <div>
              <label class="block text-sm mb-1">Difficulty</label>
              <select
                id="randDifficulty"
                class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm"
              >
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            class="modal-close px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="generateRunBtn"
            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium text-sm shadow-lg"
          >
            Generate & Run
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Settings"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">üîß Settings</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Module URL</label>
            <input
              type="text"
              id="moduleUrl"
              class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm font-mono"
              value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3"
            >
          </div>
          <button
            id="reinitWorkerBtn"
            class="w-full py-2.5 bg-amber-500 text-white rounded-lg font-medium"
          >
            üîÑ Reinitialize Worker
          </button>
          <button
            id="clearPrefsBtn"
            class="w-full py-2.5 bg-red-500 text-white rounded-lg font-medium"
          >
            üóëÔ∏è Clear All Preferences
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Data table"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">üìã Data Table</h2>
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-700 text-sm w-40"
            >
            <button
              id="exportCSVBtn"
              class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm font-medium"
            >
              üìä CSV
            </button>
            <button
              id="copyAllBtn"
              class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm font-medium"
            >
              üìã Copy
            </button>
            <button
              class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
              aria-label="Close"
            >
              ‚úñÔ∏è
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-auto">
          <table class="w-full text-sm">
            <thead
              id="tableHead"
              class="sticky top-0 bg-slate-50 dark:bg-slate-700"
            >
            </thead>
            <tbody id="tableBody" class="font-mono"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-label="Help documentation"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="font-bold text-lg">‚ùì Help & Documentation</h2>
          <button
            class="modal-close p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
            aria-label="Close"
          >
            ‚úñÔ∏è
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <div>
            <h3 class="font-semibold mb-2">üîß Worker Setup</h3>
            <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">
              The ESNRegression library runs in a Web Worker for non-blocking
              performance.
            </p>
            <code
              class="block bg-slate-100 dark:bg-slate-700 p-2 rounded text-xs"
            >Module URL:
              https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3</code>
          </div>
          <div>
            <h3 class="font-semibold mb-2">üìù Creating a Model</h3>
            <pre
              class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg text-xs overflow-x-auto"
            >const model = new ESNRegression(config);</pre>
          </div>
          <div>
            <h3 class="font-semibold mb-2">üéØ Online Training (fitOnline)</h3>
            <pre
              class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg text-xs overflow-x-auto"
            >
model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call
// Returns: { averageLoss, gradientNorm, sampleWeight }</pre>
          </div>
          <div>
            <h3 class="font-semibold mb-2">üîÆ Prediction</h3>
            <pre
              class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg text-xs overflow-x-auto"
            >
const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</pre>
          </div>
          <div>
            <h3 class="font-semibold mb-2">üíæ Save/Load</h3>
            <pre
              class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg text-xs overflow-x-auto"
            >
const state = model.save();
model.load(state);</pre>
          </div>
          <div>
            <h3 class="font-semibold mb-2">üìä Preset Configurations</h3>
            <ul class="text-sm space-y-1 text-slate-600 dark:text-slate-400">
              <li>
                <strong>Start Here:</strong> reservoirSize=256,
                spectralRadius=0.9, leakRate=0.3
              </li>
              <li>
                <strong>Fast:</strong> reservoirSize=64, reservoirSparsity=0.95
              </li>
              <li>
                <strong>Balanced:</strong> reservoirSize=256, spectralRadius=0.9
              </li>
              <li>
                <strong>Accurate:</strong> reservoirSize=512,
                spectralRadius=0.95, leakRate=0.2
              </li>
              <li>
                <strong>Adaptive:</strong> rlsLambda=0.97, spectralRadius=0.85,
                leakRate=0.5
              </li>
              <li>
                <strong>Robust:</strong> outlierThreshold=2.0,
                outlierMinWeight=0.05, l2Lambda=0.01
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2">
    </div>

    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>

    <script>
      // Color palette for dimensions
      const COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      // Preset configurations
      const PRESETS = {
        default: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        },
        fast: {
          reservoirSize: 64,
          spectralRadius: 0.9,
          leakRate: 0.3,
          reservoirSparsity: 0.95,
        },
        balanced: {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
        },
        accurate: {
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      // Application state
      const state = {
        config: { ...PRESETS.default },
        modelExists: false,
        nDimensions: 3,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 0,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: { level: 1, offsetX: 0, offsetY: 0 },
        hover: {
          active: false,
          x: 0,
          y: 0,
          dataIndex: -1,
          dimIndex: -1,
        },
        isLoading: false,
        worker: null,
        requestId: 0,
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        initTheme();
        initWorker();
        initEventListeners();
        initCanvas();
        loadSavedModels();
        addLog("info", "ESN Studio initialized");
      });

      // Theme management
      function initTheme() {
        const saved = localStorage.getItem("esn-theme");
        state.isDark = saved === "dark" ||
          (!saved &&
            window.matchMedia("(prefers-color-scheme: dark)").matches);
        document.documentElement.classList.toggle("dark", state.isDark);
      }

      function toggleTheme() {
        state.isDark = !state.isDark;
        document.documentElement.classList.toggle("dark", state.isDark);
        localStorage.setItem(
          "esn-theme",
          state.isDark ? "dark" : "light",
        );
        renderCanvas();
      }

      // Worker management
      function initWorker() {
        const workerCode = `
                let ESNRegression = null;
                let model = null;
                let moduleUrl = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3';

                self.onmessage = async (e) => {
                    const { type, data, requestId } = e.data;
                    try {
                        switch(type) {
                            case 'init':
                                if (data.url) moduleUrl = data.url;
                                const module = await import(moduleUrl);
                                ESNRegression = module.ESNRegression || module.default;
                                self.postMessage({ type: 'ready', requestId });
                                break;
                            case 'createModel':
                                model = new ESNRegression(data.config);
                                self.postMessage({ type: 'modelCreated', requestId });
                                break;
                            case 'train':
                                if (!model) throw new Error('No model exists');
                                const result = model.fitOnline(data);
                                self.postMessage({ type: 'trained', data: result, requestId });
                                break;
                            case 'predict':
                                if (!model) throw new Error('No model exists');
                                const predictions = model.predict(data.steps);
                                self.postMessage({ type: 'predicted', data: predictions, requestId });
                                break;
                            case 'save':
                                if (!model) throw new Error('No model exists');
                                const saved = model.save();
                                self.postMessage({ type: 'saved', data: saved, requestId });
                                break;
                            case 'load':
                                if (!model) model = new ESNRegression({});
                                model.load(data.state);
                                self.postMessage({ type: 'loaded', requestId });
                                break;
                            case 'getSummary':
                                if (!model) throw new Error('No model exists');
                                const summary = model.getModelSummary();
                                self.postMessage({ type: 'summary', data: summary, requestId });
                                break;
                            case 'reset':
                                model = null;
                                self.postMessage({ type: 'reset', requestId });
                                break;
                        }
                    } catch (error) {
                        self.postMessage({ type: 'error', error: error.message, requestId });
                    }
                };
            `;
        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        state.worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        state.worker.onmessage = handleWorkerMessage;
        state.worker.onerror = (e) => {
          showToast("error", "Worker error: " + e.message);
          addLog("error", "Worker error: " + e.message);
        };

        sendToWorker("init", {
          url: localStorage.getItem("esn-module-url"),
        });
      }

      function sendToWorker(type, data = {}) {
        const requestId = ++state.requestId;
        state.worker.postMessage({ type, data, requestId });
        return requestId;
      }

      function handleWorkerMessage(e) {
        const { type, data, error, requestId } = e.data;

        if (error) {
          hideLoading();
          showToast("error", error);
          addLog("error", error);
          return;
        }

        switch (type) {
          case "ready":
            addLog("success", "ESN module loaded");
            break;
          case "modelCreated":
            state.modelExists = true;
            state.sampleCount = 0;
            updateUI();
            hideLoading();
            showToast("success", "Model created successfully");
            addLog(
              "success",
              "Model created with " + state.config.reservoirSize +
                " neurons",
            );
            break;
          case "trained":
            state.sampleCount += 2;
            state.metrics = {
              avgLoss: data.averageLoss,
              gradientNorm: data.gradientNorm,
              sampleWeight: data.sampleWeight,
            };
            updateMetrics();
            hideLoading();
            addLog("info", "Trained on new data");
            break;
          case "predicted":
            state.predictions = data;
            state.nDimensions = data.predictions[0]?.length ||
              state.nDimensions;
            hideLoading();
            updateUI();
            renderCanvas();
            showToast(
              "success",
              `Generated ${data.predictions.length} predictions`,
            );
            addLog(
              "success",
              `Predicted ${data.predictions.length} steps`,
            );
            break;
          case "saved":
            downloadJSON(data, "esn-model.json");
            hideLoading();
            showToast("success", "Model saved");
            break;
          case "loaded":
            state.modelExists = true;
            hideLoading();
            updateUI();
            showToast("success", "Model loaded");
            addLog("success", "Model loaded from file");
            break;
          case "summary":
            state.sampleCount = data.sampleCount || 0;
            state.nDimensions = data.nFeatures || state.nDimensions;
            updateMetrics();
            break;
        }
      }

      // Event listeners
      function initEventListeners() {
        // Theme toggle
        document.getElementById("themeBtn").onclick = toggleTheme;

        // Menu
        document.getElementById("menuBtn").onclick = openMenu;
        document.getElementById("closeMenuBtn").onclick = closeMenu;
        document.getElementById("menuOverlay").onclick = closeMenu;

        // Menu items
        document.querySelectorAll(".menu-item").forEach((btn) => {
          btn.onclick = () => {
            closeMenu();
            const action = btn.dataset.action;
            switch (action) {
              case "configure":
                openModal("configModal");
                break;
              case "saveload":
                openModal("saveLoadModal");
                break;
              case "upload":
                openModal("uploadModal");
                break;
              case "manual":
                openModal("manualModal");
                break;
              case "randomtest":
                openModal("randomModal");
                break;
              case "settings":
                openModal("settingsModal");
                break;
              case "datatable":
                openModal("dataTableModal");
                populateDataTable();
                break;
              case "help":
                openModal("helpModal");
                break;
            }
          };
        });

        // Config button
        document.getElementById("configBtn").onclick = () =>
          openModal("configModal");

        // Tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.onclick = () => setVizMode(btn.dataset.mode);
        });

        // Configuration modal
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.onclick = () => applyPreset(btn.dataset.preset);
        });

        document.querySelectorAll(".section-toggle").forEach((btn) => {
          btn.onclick = () => {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector(".toggle-icon");
            const isExpanded =
              btn.getAttribute("aria-expanded") === "true";
            btn.setAttribute("aria-expanded", !isExpanded);
            content.classList.toggle("hidden", isExpanded);
            icon.textContent = isExpanded ? "‚ñ∂" : "‚ñº";
          };
        });

        document.querySelectorAll(".toggle-switch").forEach((btn) => {
          btn.onclick = () => {
            const isOn = btn.dataset.value === "true";
            btn.dataset.value = !isOn;
            btn.classList.toggle("bg-blue-500", !isOn);
            btn.classList.toggle("bg-slate-300", isOn);
            btn.classList.toggle("dark:bg-slate-600", isOn);
            const span = btn.querySelector("span");
            span.classList.toggle("right-0.5", !isOn);
            span.classList.toggle("left-0.5", isOn);
          };
        });

        document.getElementById("createModelBtn").onclick = createModel;
        document.getElementById("resetDefaultsBtn").onclick = () =>
          applyPreset("default");
        document.getElementById("resetAllBtn").onclick = resetAll;

        // Empty state buttons
        document.getElementById("startDefaultBtn").onclick = () => {
          applyPreset("default");
          createModel();
        };
        document.getElementById("loadModelBtn").onclick = () =>
          openModal("saveLoadModal");
        document.getElementById("demoBtn").onclick = runDemo;

        // Prediction
        document.getElementById("predictBtn").onclick = runPrediction;
        document.getElementById("runPredictBtn").onclick =
          runPrediction;

        // Upload modal
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => {
          e.preventDefault();
          dropZone.classList.add("border-blue-500", "bg-blue-50");
        };
        dropZone.ondragleave = () => {
          dropZone.classList.remove("border-blue-500", "bg-blue-50");
        };
        dropZone.ondrop = (e) => {
          e.preventDefault();
          dropZone.classList.remove("border-blue-500", "bg-blue-50");
          if (e.dataTransfer.files[0]) {
            handleUploadFile(e.dataTransfer.files[0]);
          }
        };
        fileInput.onchange = (e) => {
          if (e.target.files[0]) handleUploadFile(e.target.files[0]);
        };
        document.getElementById("validateDataBtn").onclick =
          validateUploadData;
        document.getElementById("applyTrainBtn").onclick =
          applyAndTrain;
        document.getElementById("copyExampleBtn").onclick = () => {
          navigator.clipboard.writeText(
            '{\n  "coordinates": [\n    [1.0, 2.0, 3.0],\n    [1.1, 2.1, 3.1],\n    [1.2, 2.2, 3.2]\n  ]\n}',
          );
          showToast("success", "Example copied!");
        };

        // Manual insert
        document.getElementById("genTemplateBtn").onclick =
          generateTemplate;
        document.getElementById("insertTrainBtn").onclick =
          insertAndTrain;

        // Save/Load
        document.getElementById("downloadModelBtn").onclick =
          downloadModel;
        document.getElementById("saveLocalBtn").onclick = saveToLocal;
        document.getElementById("loadDropZone").onclick = () =>
          document.getElementById("loadFileInput").click();
        document.getElementById("loadFileInput").onchange = (e) => {
          if (e.target.files[0]) loadModelFile(e.target.files[0]);
        };
        document.getElementById("clearSavedBtn").onclick =
          clearSavedModels;

        // Random test
        document.getElementById("generateRunBtn").onclick =
          generateAndRun;

        // Settings
        document.getElementById("reinitWorkerBtn").onclick = () => {
          const url = document.getElementById("moduleUrl").value;
          localStorage.setItem("esn-module-url", url);
          state.worker.terminate();
          initWorker();
          showToast("success", "Worker reinitialized");
        };
        document.getElementById("clearPrefsBtn").onclick = () => {
          localStorage.clear();
          location.reload();
        };

        // Data table
        document.getElementById("exportCSVBtn").onclick = exportCSV;
        document.getElementById("copyAllBtn").onclick = copyTableData;
        document.getElementById("tableSearch").oninput = (e) =>
          populateDataTable(e.target.value);

        // Export controls
        document.getElementById("exportPNG").onclick = exportPNG;
        document.getElementById("exportSVG").onclick = exportSVG;
        document.getElementById("exportClip").onclick = exportClipboard;

        // Zoom controls
        document.getElementById("zoomInBtn").onclick = () => {
          state.zoom.level = Math.min(5, state.zoom.level * 1.2);
          renderCanvas();
          updateZoomBadge();
        };
        document.getElementById("zoomOutBtn").onclick = () => {
          state.zoom.level = Math.max(0.5, state.zoom.level / 1.2);
          renderCanvas();
          updateZoomBadge();
        };
        document.getElementById("zoomResetBtn").onclick = () => {
          state.zoom = { level: 1, offsetX: 0, offsetY: 0 };
          renderCanvas();
          updateZoomBadge();
        };

        // Step selector
        document.getElementById("stepInput").onchange = (e) => {
          state.selectedStep = Math.max(
            0,
            parseInt(e.target.value) || 0,
          );
          renderCanvas();
        };

        // Loading cancel
        document.getElementById("cancelBtn").onclick = () => {
          hideLoading();
          showToast("warning", "Operation cancelled");
        };

        // Modal close buttons
        document.querySelectorAll(".modal-close").forEach((btn) => {
          btn.onclick = () =>
            closeModal(btn.closest('[role="dialog"]').id);
        });

        // Log filter
        document.getElementById("logFilter").onchange = renderLogs;
        document.getElementById("logSearch").oninput = renderLogs;

        // Canvas interactions
        const canvas = document.getElementById("mainCanvas");
        canvas.onmousemove = handleCanvasHover;
        canvas.onmouseleave = () => {
          state.hover.active = false;
          hideTooltip();
        };
        canvas.onclick = handleCanvasClick;
        canvas.onwheel = handleCanvasWheel;

        // Touch events
        let touchStart = null;
        canvas.ontouchstart = (e) => {
          touchStart = e.touches[0];
        };
        canvas.ontouchmove = (e) => {
          if (!touchStart || !state.predictions) return;
          const touch = e.touches[0];
          const dx = touch.clientX - touchStart.clientX;
          state.zoom.offsetX += dx / state.zoom.level;
          touchStart = touch;
          renderCanvas();
        };
        canvas.ontouchend = () => {
          touchStart = null;
        };
      }

      // Modal management
      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(id).querySelector("button, input")
          ?.focus();
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function openMenu() {
        document.getElementById("menuOverlay").classList.remove(
          "hidden",
        );
        document.getElementById("slideMenu").classList.remove(
          "translate-x-full",
        );
      }

      function closeMenu() {
        document.getElementById("menuOverlay").classList.add("hidden");
        document.getElementById("slideMenu").classList.add(
          "translate-x-full",
        );
      }

      // Configuration
      function applyPreset(preset) {
        const config = { ...PRESETS.default, ...PRESETS[preset] };
        state.config = config;

        document.querySelectorAll("[data-config]").forEach((input) => {
          const key = input.dataset.config;
          if (config[key] !== undefined) {
            if (input.classList.contains("toggle-switch")) {
              input.dataset.value = config[key];
              input.classList.toggle("bg-blue-500", config[key]);
              input.classList.toggle("bg-slate-300", !config[key]);
              const span = input.querySelector("span");
              span.classList.toggle("right-0.5", config[key]);
              span.classList.toggle("left-0.5", !config[key]);
            } else {
              input.value = config[key];
            }
          }
        });

        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.classList.toggle(
            "bg-blue-500",
            btn.dataset.preset === preset,
          );
          btn.classList.toggle(
            "text-white",
            btn.dataset.preset === preset,
          );
          btn.classList.toggle(
            "bg-slate-100",
            btn.dataset.preset !== preset,
          );
          btn.classList.toggle(
            "dark:bg-slate-700",
            btn.dataset.preset !== preset,
          );
        });
      }

      function getConfigFromForm() {
        const config = { ...state.config };
        document.querySelectorAll("[data-config]").forEach((input) => {
          const key = input.dataset.config;
          if (input.classList.contains("toggle-switch")) {
            config[key] = input.dataset.value === "true";
          } else if (input.type === "number") {
            config[key] = parseFloat(input.value);
          } else {
            config[key] = input.value;
          }
        });
        return config;
      }

      function createModel() {
        state.config = getConfigFromForm();
        showLoading("Creating model...");
        sendToWorker("createModel", { config: state.config });
        closeModal("configModal");
      }

      function resetAll() {
        sendToWorker("reset");
        state.modelExists = false;
        state.predictions = null;
        state.sampleCount = 0;
        state.metrics = {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        };
        updateUI();
        renderCanvas();
        showToast("success", "Model reset");
        addLog("info", "Model reset");
      }

      // Prediction
      function runPrediction() {
        if (!state.modelExists) {
          showToast("warning", "Create a model first");
          return;
        }
        const steps =
          parseInt(document.getElementById("futureSteps").value) || 50;
        showLoading("Generating predictions...");
        sendToWorker("predict", { steps });
      }

      // Data handling
      function handleUploadFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("dataTextarea").value =
            e.target.result;
          validateUploadData();
        };
        reader.readAsText(file);
      }

      function validateUploadData() {
        const text = document.getElementById("dataTextarea").value;
        const preview = document.getElementById("uploadPreview");
        const error = document.getElementById("uploadError");
        const applyBtn = document.getElementById("applyTrainBtn");

        try {
          const data = JSON.parse(text);
          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            throw new Error("Missing coordinates array");
          }
          if (data.coordinates.length < 2) {
            throw new Error("Need at least 2 time steps");
          }
          const dims = data.coordinates[0].length;
          if (
            !data.coordinates.every((c) =>
              Array.isArray(c) && c.length === dims
            )
          ) {
            throw new Error("Inconsistent dimensions");
          }

          document.getElementById("previewDims").textContent = dims;
          document.getElementById("previewSteps").textContent =
            data.coordinates.length;
          preview.classList.remove("hidden");
          error.classList.add("hidden");
          applyBtn.disabled = false;
          state.uploadedData = data;
        } catch (e) {
          document.getElementById("uploadErrorMsg").textContent =
            e.message;
          error.classList.remove("hidden");
          preview.classList.add("hidden");
          applyBtn.disabled = true;
          state.uploadedData = null;
        }
      }

      function applyAndTrain() {
        if (!state.uploadedData) return;
        if (!state.modelExists) {
          applyPreset("default");
          createModel();
          setTimeout(() => trainOnData(state.uploadedData), 500);
        } else {
          trainOnData(state.uploadedData);
        }
        closeModal("uploadModal");
      }

      function trainOnData(data) {
        showLoading("Training on uploaded data...");
        const coords = data.coordinates;
        let i = 0;
        const batchSize = 2;

        function trainBatch() {
          if (i >= coords.length - 1) {
            hideLoading();
            runPrediction();
            return;
          }
          const batch = { coordinates: coords.slice(i, i + batchSize) };
          if (batch.coordinates.length >= 2) {
            sendToWorker("train", batch);
          }
          i += batchSize - 1;
          updateProgress((i / coords.length) * 100);
          setTimeout(trainBatch, 10);
        }
        trainBatch();
      }

      function generateTemplate() {
        const dims = state.nDimensions || 3;
        const template = {
          coordinates: [
            Array(dims).fill(0).map((_, i) => (i + 1) * 0.1),
            Array(dims).fill(0).map((_, i) => (i + 1) * 0.2),
          ],
        };
        document.getElementById("manualTextarea").value = JSON
          .stringify(template, null, 2);
      }

      function insertAndTrain() {
        const text = document.getElementById("manualTextarea").value;
        const feedback = document.getElementById("manualFeedback");

        try {
          const data = JSON.parse(text);
          if (!data.coordinates || data.coordinates.length < 2) {
            throw new Error("Need at least 2 coordinates");
          }

          if (!state.modelExists) {
            state.nDimensions = data.coordinates[0].length;
            createModel();
            setTimeout(() => {
              sendToWorker("train", data);
              closeModal("manualModal");
            }, 500);
          } else {
            sendToWorker("train", data);
            closeModal("manualModal");
          }
          showToast("success", "Data inserted");
        } catch (e) {
          feedback.className =
            "p-3 rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-sm";
          feedback.textContent = e.message;
          feedback.classList.remove("hidden");
        }
      }

      // Save/Load
      function downloadModel() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }
        showLoading("Saving model...");
        sendToWorker("save");
      }

      function saveToLocal() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }
        const name = prompt("Model name:", "My Model");
        if (!name) return;

        // Get state from worker and save
        const workerPromise = new Promise((resolve) => {
          const handler = (e) => {
            if (e.data.type === "saved") {
              state.worker.removeEventListener("message", handler);
              resolve(e.data.data);
            }
          };
          state.worker.addEventListener("message", handler);
          sendToWorker("save");
        });

        workerPromise.then((modelState) => {
          const saved = JSON.parse(
            localStorage.getItem("esn-saved-models") || "[]",
          );
          saved.push({
            name,
            state: modelState,
            dims: state.nDimensions,
            date: new Date().toISOString(),
          });
          localStorage.setItem(
            "esn-saved-models",
            JSON.stringify(saved),
          );
          loadSavedModels();
          showToast("success", "Saved to browser");
        });
      }

      function loadSavedModels() {
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "[]",
        );
        const list = document.getElementById("savedModelsList");
        list.innerHTML = saved.map((m, i) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <div>
                        <div class="font-medium">${m.name}</div>
                        <div class="text-xs text-slate-500">${m.dims}D</div>
                    </div>
                    <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" onclick="loadSavedModel(${i})">Load</button>
                </div>
            `).join("");
      }

      window.loadSavedModel = function (index) {
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "[]",
        );
        if (saved[index]) {
          showLoading("Loading model...");
          sendToWorker("load", { state: saved[index].state });
          state.nDimensions = saved[index].dims;
          closeModal("saveLoadModal");
        }
      };

      function loadModelFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const modelState = JSON.parse(e.target.result);
            showLoading("Loading model...");
            sendToWorker("load", { state: modelState });
            closeModal("saveLoadModal");
          } catch (err) {
            showToast("error", "Invalid model file");
          }
        };
        reader.readAsText(file);
      }

      function clearSavedModels() {
        if (confirm("Delete all saved models?")) {
          localStorage.removeItem("esn-saved-models");
          loadSavedModels();
          showToast("success", "Saved models cleared");
        }
      }

      // Random test
      function generateAndRun() {
        const seed = parseInt(
          document.getElementById("randSeed").value,
        );
        const dims = parseInt(
          document.getElementById("randDims").value,
        );
        const steps = parseInt(
          document.getElementById("randSteps").value,
        );
        const noise = parseFloat(
          document.getElementById("randNoise").value,
        );
        const outliers = parseFloat(
          document.getElementById("randOutliers").value,
        );
        const difficulty =
          document.getElementById("randDifficulty").value;

        // Generate synthetic data
        const rng = seededRandom(seed);
        const coordinates = [];
        const frequencies = Array(dims).fill(0).map(() =>
          0.02 + rng() * 0.08
        );
        const phases = Array(dims).fill(0).map(() =>
          rng() * Math.PI * 2
        );
        const amplitudes = Array(dims).fill(0).map(() =>
          0.5 + rng() * 0.5
        );

        const complexityMult =
          { easy: 1, medium: 2, hard: 3 }[difficulty];

        for (let t = 0; t < steps; t++) {
          const coord = [];
          for (let d = 0; d < dims; d++) {
            let val = amplitudes[d] *
              Math.sin(2 * Math.PI * frequencies[d] * t + phases[d]);
            for (let h = 2; h <= complexityMult; h++) {
              val += (amplitudes[d] / h) *
                Math.sin(
                  2 * Math.PI * frequencies[d] * h * t + phases[d] * h,
                );
            }
            val += (rng() - 0.5) * 2 * noise;
            if (rng() < outliers) {
              val += (rng() - 0.5) * 4;
            }
            coord.push(val);
          }
          coordinates.push(coord);
        }

        state.nDimensions = dims;

        if (!state.modelExists) {
          applyPreset("default");
          createModel();
          setTimeout(() => {
            trainOnData({ coordinates });
          }, 500);
        } else {
          trainOnData({ coordinates });
        }

        closeModal("randomModal");
        addLog(
          "info",
          `Generated ${steps} synthetic samples with ${dims} dimensions`,
        );
      }

      function seededRandom(seed) {
        return function () {
          seed = (seed * 1103515245 + 12345) & 0x7fffffff;
          return seed / 0x7fffffff;
        };
      }

      // Demo
      function runDemo() {
        document.getElementById("randSeed").value = 42;
        document.getElementById("randDims").value = 3;
        document.getElementById("randSteps").value = 150;
        document.getElementById("randNoise").value = 0.05;
        document.getElementById("randOutliers").value = 0.01;
        document.getElementById("randDifficulty").value = "medium";
        generateAndRun();
      }

      // Visualization
      function setVizMode(mode) {
        state.vizMode = mode;
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          const isActive = btn.dataset.mode === mode;
          btn.classList.toggle("bg-gradient-to-r", isActive);
          btn.classList.toggle("from-blue-500", isActive);
          btn.classList.toggle("to-indigo-600", isActive);
          btn.classList.toggle("text-white", isActive);
          btn.classList.toggle("shadow-lg", isActive);
          btn.classList.toggle("bg-slate-100", !isActive);
          btn.classList.toggle("dark:bg-slate-700", !isActive);
          btn.classList.toggle("text-slate-600", !isActive);
          btn.classList.toggle("dark:text-slate-300", !isActive);
          btn.setAttribute("aria-selected", isActive);
        });

        document.getElementById("dimSelector").classList.toggle(
          "hidden",
          mode !== "focus" && mode !== "ci",
        );
        document.getElementById("stepSelector").classList.toggle(
          "hidden",
          mode !== "snapshot",
        );
        document.getElementById("statsBar").classList.toggle(
          "hidden",
          mode !== "focus",
        );

        if (mode === "focus" || mode === "ci") {
          renderDimButtons();
        }

        renderCanvas();
      }

      function renderDimButtons() {
        const container = document.getElementById("dimButtons");
        container.innerHTML = Array(state.nDimensions).fill(0).map((
          _,
          i,
        ) => `
                <button class="dim-btn px-3 py-1.5 rounded-lg text-sm font-medium ${
          i === state.selectedDim
            ? "text-white"
            : "bg-slate-100 dark:bg-slate-700"
        }" 
                    style="${
          i === state.selectedDim
            ? `background-color: ${COLORS[i % COLORS.length]}`
            : ""
        }"
                    onclick="selectDimension(${i})">
                    D${i + 1}
                </button>
            `).join("");
      }

      window.selectDimension = function (dim) {
        state.selectedDim = dim;
        renderDimButtons();
        updateStats();
        renderCanvas();
      };

      function updateStats() {
        if (!state.predictions || state.vizMode !== "focus") return;

        const preds = state.predictions.predictions.map((p) =>
          p[state.selectedDim]
        );
        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const trend = final - preds[0];
        const conf =
          state.predictions.confidence?.[state.selectedDim] || 0;

        document.getElementById("statMin").textContent = min.toFixed(3);
        document.getElementById("statMax").textContent = max.toFixed(3);
        document.getElementById("statMean").textContent = mean.toFixed(
          3,
        );
        document.getElementById("statFinal").textContent = final
          .toFixed(3);
        document.getElementById("statTrend").innerHTML =
          `<span class="${
            trend >= 0 ? "text-emerald-500" : "text-red-500"
          }">${trend >= 0 ? "‚Üë" : "‚Üì"} ${
            Math.abs(trend).toFixed(3)
          }</span>`;
        document.getElementById("statConf").textContent =
          (conf * 100).toFixed(1) + "%";
      }

      // Canvas rendering
      function initCanvas() {
        const canvas = document.getElementById("mainCanvas");
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;

        window.addEventListener("resize", () => {
          const rect = canvas.getBoundingClientRect();
          canvas.width = rect.width * window.devicePixelRatio;
          canvas.height = rect.height * window.devicePixelRatio;
          renderCanvas();
        });
      }

      function renderCanvas() {
        const canvas = document.getElementById("mainCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio;

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        const w = rect.width;
        const h = rect.height;

        // Clear
        ctx.fillStyle = state.isDark ? "#1e293b" : "#ffffff";
        ctx.fillRect(0, 0, w, h);

        if (!state.predictions) return;

        const padding = { top: 30, right: 20, bottom: 40, left: 60 };
        const chartW = w - padding.left - padding.right;
        const chartH = h - padding.top - padding.bottom;

        switch (state.vizMode) {
          case "grid":
            renderGrid(ctx, padding, chartW, chartH);
            break;
          case "focus":
            renderFocus(ctx, padding, chartW, chartH);
            break;
          case "heatmap":
            renderHeatmap(ctx, padding, chartW, chartH);
            break;
          case "ci":
            renderCI(ctx, padding, chartW, chartH);
            break;
          case "snapshot":
            renderSnapshot(ctx, padding, chartW, chartH);
            break;
        }
      }

      function renderGrid(ctx, padding, chartW, chartH) {
        const preds = state.predictions.predictions;
        const dims = state.nDimensions;
        const cols = Math.ceil(Math.sqrt(dims));
        const rows = Math.ceil(dims / cols);
        const cellW = chartW / cols;
        const cellH = chartH / rows;
        const cellPad = 10;

        for (let d = 0; d < dims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = padding.left + col * cellW + cellPad;
          const y = padding.top + row * cellH + cellPad;
          const w = cellW - cellPad * 2;
          const h = cellH - cellPad * 2;

          const data = preds.map((p) => p[d]);
          const min = Math.min(...data);
          const max = Math.max(...data);
          const range = max - min || 1;

          // Background
          ctx.fillStyle = state.isDark ? "#334155" : "#f1f5f9";
          ctx.fillRect(x, y, w, h);

          // Line
          ctx.beginPath();
          ctx.strokeStyle = COLORS[d % COLORS.length];
          ctx.lineWidth = 2;
          data.forEach((v, i) => {
            const px = x + (i / (data.length - 1)) * w;
            const py = y + h - ((v - min) / range) * h;
            i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          });
          ctx.stroke();

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px system-ui";
          ctx.fillText(`D${d + 1}`, x + 4, y + 14);
        }
      }

      function renderFocus(ctx, padding, chartW, chartH) {
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const d = state.selectedDim;

        const data = preds.map((p) => p[d]);
        const lowerData = lower.map((l) => l[d]);
        const upperData = upper.map((u) => u[d]);

        const allVals = [...data, ...lowerData, ...upperData];
        const min = Math.min(...allVals);
        const max = Math.max(...allVals);
        const range = max - min || 1;

        // Grid
        ctx.strokeStyle = state.isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartH;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartW, y);
          ctx.stroke();

          const val = max - (i / 5) * range;
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 8, y + 4);
        }

        // Confidence interval fill
        ctx.fillStyle = COLORS[d % COLORS.length] + "20";
        ctx.beginPath();
        data.forEach((_, i) => {
          const x = padding.left + (i / (data.length - 1)) * chartW;
          const y = padding.top + chartH -
            ((upperData[i] - min) / range) * chartH;
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        for (let i = data.length - 1; i >= 0; i--) {
          const x = padding.left + (i / (data.length - 1)) * chartW;
          const y = padding.top + chartH -
            ((lowerData[i] - min) / range) * chartH;
          ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.beginPath();
        ctx.strokeStyle = COLORS[d % COLORS.length];
        ctx.lineWidth = 2.5;
        data.forEach((v, i) => {
          const x = padding.left + (i / (data.length - 1)) * chartW;
          const y = padding.top + chartH - ((v - min) / range) * chartH;
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Hover crosshair
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const i = state.hover.dataIndex;
          const x = padding.left + (i / (data.length - 1)) * chartW;
          const y = padding.top + chartH -
            ((data[i] - min) / range) * chartH;

          ctx.strokeStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(x, padding.top);
          ctx.lineTo(x, padding.top + chartH);
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartW, y);
          ctx.stroke();
          ctx.setLineDash([]);

          // Point with glow
          ctx.shadowColor = COLORS[d % COLORS.length];
          ctx.shadowBlur = 10;
          ctx.fillStyle = COLORS[d % COLORS.length];
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        updateStats();
      }

      function renderHeatmap(ctx, padding, chartW, chartH) {
        const preds = state.predictions.predictions;
        const steps = preds.length;
        const dims = state.nDimensions;

        // Find global min/max
        let min = Infinity, max = -Infinity;
        preds.forEach((p) =>
          p.forEach((v) => {
            min = Math.min(min, v);
            max = Math.max(max, v);
          })
        );
        const range = max - min || 1;

        const cellW = chartW / steps;
        const cellH = chartH / dims;

        for (let s = 0; s < steps; s++) {
          for (let d = 0; d < dims; d++) {
            const val = preds[s][d];
            const norm = (val - min) / range;

            // Color interpolation: blue -> green -> yellow -> red
            let r, g, b;
            if (norm < 0.25) {
              r = 0;
              g = Math.round(norm * 4 * 255);
              b = 255;
            } else if (norm < 0.5) {
              r = 0;
              g = 255;
              b = Math.round((1 - (norm - 0.25) * 4) * 255);
            } else if (norm < 0.75) {
              r = Math.round((norm - 0.5) * 4 * 255);
              g = 255;
              b = 0;
            } else {
              r = 255;
              g = Math.round((1 - (norm - 0.75) * 4) * 255);
              b = 0;
            }

            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(
              padding.left + s * cellW,
              padding.top + d * cellH,
              cellW + 1,
              cellH + 1,
            );
          }
        }

        // Labels
        ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        for (let d = 0; d < dims; d++) {
          ctx.fillText(
            `D${d + 1}`,
            padding.left - 8,
            padding.top + d * cellH + cellH / 2 + 4,
          );
        }
      }

      function renderCI(ctx, padding, chartW, chartH) {
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const d = state.selectedDim;

        const spreads = preds.map((p, i) => upper[i][d] - lower[i][d]);
        const maxSpread = Math.max(...spreads);

        // Uncertainty bars
        const barW = chartW / preds.length;
        spreads.forEach((spread, i) => {
          const x = padding.left + i * barW;
          const h = (spread / maxSpread) * chartH;

          ctx.fillStyle = COLORS[d % COLORS.length] + "60";
          ctx.fillRect(x, padding.top + chartH - h, barW - 1, h);
        });

        // Trend line
        ctx.beginPath();
        ctx.strokeStyle = COLORS[d % COLORS.length];
        ctx.lineWidth = 2;
        spreads.forEach((spread, i) => {
          const x = padding.left + i * barW + barW / 2;
          const y = padding.top + chartH -
            (spread / maxSpread) * chartH;
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Y-axis labels
        ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (i / 4) * chartH;
          const val = maxSpread * (1 - i / 4);
          ctx.fillText(val.toFixed(3), padding.left - 8, y + 4);
        }
      }

      function renderSnapshot(ctx, padding, chartW, chartH) {
        const step = Math.min(
          state.selectedStep,
          state.predictions.predictions.length - 1,
        );
        const preds = state.predictions.predictions[step];
        const lower = state.predictions.lowerBounds[step];
        const upper = state.predictions.upperBounds[step];

        const allVals = [...preds, ...lower, ...upper];
        const max = Math.max(...allVals.map(Math.abs)) || 1;

        const barW = chartW / state.nDimensions;
        const midY = padding.top + chartH / 2;

        // Zero line
        ctx.strokeStyle = state.isDark ? "#475569" : "#cbd5e1";
        ctx.beginPath();
        ctx.moveTo(padding.left, midY);
        ctx.lineTo(padding.left + chartW, midY);
        ctx.stroke();

        preds.forEach((val, d) => {
          const x = padding.left + d * barW + barW * 0.15;
          const w = barW * 0.7;
          const h = (val / max) * (chartH / 2);

          // Error bar
          const lowerY = midY - (lower[d] / max) * (chartH / 2);
          const upperY = midY - (upper[d] / max) * (chartH / 2);
          ctx.strokeStyle = COLORS[d % COLORS.length];
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + w / 2, lowerY);
          ctx.lineTo(x + w / 2, upperY);
          ctx.moveTo(x + w / 4, lowerY);
          ctx.lineTo(x + 3 * w / 4, lowerY);
          ctx.moveTo(x + w / 4, upperY);
          ctx.lineTo(x + 3 * w / 4, upperY);
          ctx.stroke();

          // Bar
          ctx.fillStyle = COLORS[d % COLORS.length];
          if (val >= 0) {
            ctx.fillRect(x, midY - h, w, h);
          } else {
            ctx.fillRect(x, midY, w, -h);
          }

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "11px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(
            `D${d + 1}`,
            x + w / 2,
            padding.top + chartH + 20,
          );
        });

        // Step label
        ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Step ${step}`, padding.left, padding.top - 10);
      }

      // Canvas interactions
      function handleCanvasHover(e) {
        if (!state.predictions) return;

        const canvas = document.getElementById("mainCanvas");
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const padding = { top: 30, right: 20, bottom: 40, left: 60 };
        const chartW = rect.width - padding.left - padding.right;

        if (x >= padding.left && x <= padding.left + chartW) {
          const ratio = (x - padding.left) / chartW;
          const dataIndex = Math.round(
            ratio * (state.predictions.predictions.length - 1),
          );

          state.hover = {
            active: true,
            x: e.clientX,
            y: e.clientY,
            dataIndex,
            dimIndex: state.selectedDim,
          };

          if (state.vizMode === "focus" || state.vizMode === "ci") {
            showTooltip(
              e.clientX,
              e.clientY,
              dataIndex,
              state.selectedDim,
            );
            renderCanvas();
          }
        } else {
          state.hover.active = false;
          hideTooltip();
        }
      }

      function handleCanvasClick(e) {
        // Could be used for selection
      }

      function handleCanvasWheel(e) {
        if (!state.predictions) return;
        e.preventDefault();

        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        state.zoom.level = Math.max(
          0.5,
          Math.min(5, state.zoom.level * delta),
        );
        updateZoomBadge();
        renderCanvas();
      }

      function showTooltip(x, y, dataIndex, dimIndex) {
        const tooltip = document.getElementById("tooltip");
        const pred = state.predictions.predictions[dataIndex]
          ?.[dimIndex];
        const lower = state.predictions.lowerBounds[dataIndex]
          ?.[dimIndex];
        const upper = state.predictions.upperBounds[dataIndex]
          ?.[dimIndex];

        if (pred === undefined) return;

        document.getElementById("tooltipStep").textContent =
          `Step ${dataIndex}`;
        document.getElementById("tooltipDot").style.backgroundColor =
          COLORS[dimIndex % COLORS.length];
        document.getElementById("tooltipDim").textContent =
          `Dimension ${dimIndex + 1}`;
        document.getElementById("tooltipValue").textContent = pred
          .toFixed(4);
        document.getElementById("tooltipCI").textContent = `${
          lower.toFixed(3)
        } - ${upper.toFixed(3)}`;
        document.getElementById("tooltipSpread").textContent =
          (upper - lower).toFixed(4);

        const canvas = document.getElementById("mainCanvas");
        const rect = canvas.getBoundingClientRect();

        tooltip.classList.remove("hidden");
        tooltip.style.left = Math.min(x + 10, rect.right - 200) + "px";
        tooltip.style.top = Math.min(y + 10, rect.bottom - 150) + "px";
      }

      function hideTooltip() {
        document.getElementById("tooltip").classList.add("hidden");
      }

      function updateZoomBadge() {
        document.getElementById("zoomBadge").textContent =
          Math.round(state.zoom.level * 100) + "%";
      }

      // Export functions
      function exportPNG() {
        const canvas = document.getElementById("mainCanvas");
        const link = document.createElement("a");
        link.download = "esn-chart.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
        showToast("success", "PNG exported");
      }

      function exportSVG() {
        // Simplified SVG export
        showToast("info", "SVG export - use PNG for now");
      }

      function exportClipboard() {
        const canvas = document.getElementById("mainCanvas");
        canvas.toBlob((blob) => {
          navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("success", "Copied to clipboard");
        });
      }

      // Data table
      function populateDataTable(filter = "") {
        if (!state.predictions) return;

        const thead = document.getElementById("tableHead");
        const tbody = document.getElementById("tableBody");
        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const dims = state.nDimensions;

        // Header
        let headerHTML =
          '<tr><th class="px-3 py-2 text-left font-semibold border-b border-slate-200 dark:border-slate-600">Step</th>';
        for (let d = 0; d < dims; d++) {
          headerHTML +=
            `<th class="px-3 py-2 text-left font-semibold border-b border-slate-200 dark:border-slate-600" style="color:${
              COLORS[d % COLORS.length]
            }">P${d + 1}</th>`;
        }
        for (let d = 0; d < dims; d++) {
          headerHTML +=
            `<th class="px-3 py-2 text-left font-semibold border-b border-slate-200 dark:border-slate-600 text-slate-400">L${
              d + 1
            }</th>`;
        }
        for (let d = 0; d < dims; d++) {
          headerHTML +=
            `<th class="px-3 py-2 text-left font-semibold border-b border-slate-200 dark:border-slate-600 text-slate-400">U${
              d + 1
            }</th>`;
        }
        headerHTML += "</tr>";
        thead.innerHTML = headerHTML;

        // Body
        let bodyHTML = "";
        preds.forEach((pred, i) => {
          const rowStr = [i, ...pred, ...lower[i], ...upper[i]].join(
            " ",
          );
          if (
            filter &&
            !rowStr.toLowerCase().includes(filter.toLowerCase())
          ) return;

          bodyHTML +=
            `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700 ${
              i % 2 ? "bg-slate-50/50 dark:bg-slate-800/50" : ""
            }">`;
          bodyHTML +=
            `<td class="px-3 py-1.5 border-b border-slate-100 dark:border-slate-700">${i}</td>`;
          pred.forEach((v) => {
            bodyHTML +=
              `<td class="px-3 py-1.5 border-b border-slate-100 dark:border-slate-700">${
                v.toFixed(4)
              }</td>`;
          });
          lower[i].forEach((v) => {
            bodyHTML +=
              `<td class="px-3 py-1.5 border-b border-slate-100 dark:border-slate-700 text-slate-400">${
                v.toFixed(4)
              }</td>`;
          });
          upper[i].forEach((v) => {
            bodyHTML +=
              `<td class="px-3 py-1.5 border-b border-slate-100 dark:border-slate-700 text-slate-400">${
                v.toFixed(4)
              }</td>`;
          });
          bodyHTML += "</tr>";
        });
        tbody.innerHTML = bodyHTML;
      }

      function exportCSV() {
        if (!state.predictions) return;

        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const dims = state.nDimensions;

        let csv = "Step";
        for (let d = 0; d < dims; d++) csv += `,P${d + 1}`;
        for (let d = 0; d < dims; d++) csv += `,L${d + 1}`;
        for (let d = 0; d < dims; d++) csv += `,U${d + 1}`;
        csv += "\n";

        preds.forEach((pred, i) => {
          csv += i;
          pred.forEach((v) => csv += "," + v);
          lower[i].forEach((v) => csv += "," + v);
          upper[i].forEach((v) => csv += "," + v);
          csv += "\n";
        });

        downloadText(csv, "esn-predictions.csv", "text/csv");
        showToast("success", "CSV exported");
      }

      function copyTableData() {
        if (!state.predictions) return;
        const table = document.querySelector("#dataTableModal table");
        const text = Array.from(table.rows).map((row) =>
          Array.from(row.cells).map((cell) => cell.textContent).join(
            "\t",
          )
        ).join("\n");
        navigator.clipboard.writeText(text);
        showToast("success", "Table copied");
      }

      // UI updates
      function updateUI() {
        const hasModel = state.modelExists;
        const hasPreds = state.predictions !== null;

        document.getElementById("emptyState").classList.toggle(
          "hidden",
          hasModel || hasPreds,
        );
        document.getElementById("predictBtn").classList.toggle(
          "hidden",
          !hasModel,
        );
        document.getElementById("predictBtn").classList.toggle(
          "flex",
          hasModel,
        );
        document.getElementById("runPredictBtn").disabled = !hasModel;
        document.getElementById("floatingControls").classList.toggle(
          "hidden",
          !hasPreds,
        );
        document.getElementById("zoomBadge").classList.toggle(
          "hidden",
          !hasPreds,
        );
        document.getElementById("exportControls").classList.toggle(
          "hidden",
          !hasPreds,
        );

        // Status badge
        const dot = document.getElementById("statusDot");
        const text = document.getElementById("statusText");
        if (hasModel) {
          dot.classList.remove("bg-slate-400");
          dot.classList.add("bg-emerald-500");
          text.textContent = `${state.sampleCount} steps`;
        } else {
          dot.classList.add("bg-slate-400");
          dot.classList.remove("bg-emerald-500");
          text.textContent = "No Model";
        }

        if (
          hasPreds &&
          (state.vizMode === "focus" || state.vizMode === "ci")
        ) {
          renderDimButtons();
        }
      }

      function updateMetrics() {
        document.getElementById("metricSamples").textContent =
          state.sampleCount;
        document.getElementById("metricLoss").textContent =
          state.metrics.avgLoss?.toExponential(3) || "-";
        document.getElementById("metricGrad").textContent =
          state.metrics.gradientNorm?.toExponential(3) || "-";
        document.getElementById("metricWeight").textContent =
          state.metrics.sampleWeight?.toFixed(3) || "-";
      }

      // Loading state
      function showLoading(text = "Processing...") {
        state.isLoading = true;
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingState").classList.remove(
          "hidden",
        );
        updateProgress(0);
      }

      function hideLoading() {
        state.isLoading = false;
        document.getElementById("loadingState").classList.add("hidden");
      }

      function updateProgress(percent) {
        document.getElementById("progressBar").style.width = percent +
          "%";
        document.getElementById("progressText").textContent =
          Math.round(percent) + "%";
      }

      // Toast notifications
      function showToast(type, message) {
        const container = document.getElementById("toastContainer");
        const colors = {
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };

        const toast = document.createElement("div");
        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 max-w-sm`;
        toast.innerHTML = `
                <span class="flex-1">${message}</span>
                <button class="hover:opacity-70" onclick="this.parentElement.remove()">‚úñÔ∏è</button>
            `;
        container.appendChild(toast);

        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : 4000,
        );
      }

      // Event log
      function addLog(type, message) {
        state.logs.unshift({
          type,
          message,
          time: new Date().toLocaleTimeString(),
        });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = document.getElementById("logContainer");
        const filter = document.getElementById("logFilter").value;
        const search = document.getElementById("logSearch").value
          .toLowerCase();

        const colors = {
          info:
            "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
          success:
            "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
          warning:
            "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
          error:
            "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
        };

        const filtered = state.logs.filter((log) =>
          (filter === "all" || log.type === filter) &&
          (!search || log.message.toLowerCase().includes(search))
        ).slice(0, 50);

        container.innerHTML = filtered.map((log) => `
                <div class="flex items-start gap-2 py-1.5 border-b border-slate-100 dark:border-slate-700 last:border-0">
                    <span class="px-1.5 py-0.5 rounded text-xs font-medium ${
          colors[log.type]
        }">${log.type}</span>
                    <span class="text-xs text-slate-400">${log.time}</span>
                    <span class="text-sm flex-1">${log.message}</span>
                </div>
            `).join("");
      }

      // Utility functions
      function downloadJSON(data, filename) {
        downloadText(
          JSON.stringify(data),
          filename,
          "application/json",
        );
      }

      function downloadText(text, filename, type) {
        const blob = new Blob([text], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
