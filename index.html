<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwindcss.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      * {
        font-family: "Inter", system-ui, sans-serif;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      .toast-enter {
        animation: toastIn 0.3s ease-out;
      }
      .toast-exit {
        animation: toastOut 0.3s ease-in forwards;
      }
      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes toastOut {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
      }
      .slide-in {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.2s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .chart-tooltip {
        pointer-events: none;
        transition: opacity 0.15s, transform 0.15s;
      }
      .gradient-border {
        background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      }
      .glass {
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.8);
      }
      .dark .glass {
        background: rgba(15, 23, 42, 0.8);
      }
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-track {
        height: 4px;
        background: #e2e8f0;
        border-radius: 2px;
      }
      .dark input[type="range"]::-webkit-slider-track {
        background: #334155;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: #0ea5e9;
        border-radius: 50%;
        margin-top: -6px;
        cursor: pointer;
      }
      .btn-primary {
        @apply bg-brand-500 hover:bg-brand-600 text-white font-medium px-4
          py-2 rounded-lg transition-all duration-200 shadow-sm
          hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed;
      }
      .btn-secondary {
        @apply bg-slate-100 dark:bg-slate-700 hover:bg-slate-200
          dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200
          font-medium px-4 py-2 rounded-lg transition-all duration-200;
      }
      .input-field {
        @apply w-full px-3 py-2 border border-slate-300 dark:border-slate-600
          rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white
          focus:ring-2 focus:ring-brand-500 focus:border-transparent
          outline-none transition-all;
      }
      .card {
        @apply bg-white dark:bg-slate-800 rounded-xl shadow-sm border
          border-slate-200 dark:border-slate-700;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white min-h-screen"
  >
    <div id="app" class="flex flex-col h-screen">
      <!-- Header -->
      <header
        class="h-14 px-4 flex items-center justify-between border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 z-40 flex-shrink-0"
      >
        <div class="flex items-center gap-3">
          <button
            id="menuBtn"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 lg:hidden"
            aria-label="Open menu"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>
          <div class="flex items-center gap-2">
            <div
              class="w-8 h-8 rounded-lg gradient-border flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                />
              </svg>
            </div>
            <h1 class="font-semibold text-lg hidden sm:block">
              ESN Regression Studio
            </h1>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div id="statusChips" class="hidden sm:flex items-center gap-2 mr-2">
            <span
              id="modelStatus"
              class="px-2 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700"
            >No Model</span>
            <span
              id="dataStatus"
              class="px-2 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 hidden"
            >0 samples</span>
          </div>
          <button id="predictBtn" class="btn-primary text-sm hidden" disabled>
            Predict
          </button>
          <button
            id="darkToggle"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
            aria-label="Toggle dark mode"
          >
            <svg
              class="w-5 h-5 dark:hidden"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              />
            </svg>
            <svg
              class="w-5 h-5 hidden dark:block"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              />
            </svg>
          </button>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside
          id="sidebar"
          class="fixed inset-y-0 left-0 z-50 w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 transform -translate-x-full lg:translate-x-0 lg:static lg:z-0 transition-transform duration-300"
        >
          <div class="flex flex-col h-full pt-14 lg:pt-0">
            <div
              class="p-4 border-b border-slate-200 dark:border-slate-700 lg:hidden"
            >
              <div class="flex items-center justify-between">
                <span class="font-semibold">Menu</span>
                <button
                  id="closeSidebar"
                  class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <nav class="flex-1 overflow-y-auto p-3 space-y-1">
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="model"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                      />
                    </svg>Model</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="model"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openConfig"
                  >
                    Create / Configure
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="showSummary"
                  >
                    Summary
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="resetModel"
                  >
                    Reset Model
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openSaveLoad"
                  >
                    Save / Load
                  </button>
                </div>
              </div>
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="data"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                      />
                    </svg>Data</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="data"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openUpload"
                  >
                    Upload Dataset
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openManualInsert"
                  >
                    Manual Insert
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="exportDataset"
                  >
                    Export Dataset
                  </button>
                </div>
              </div>
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="train"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>Train</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="train"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="trainOnline"
                  >
                    Train Online
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openRandomTest"
                  >
                    Random Test Data
                  </button>
                </div>
              </div>
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="predict"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>Predict</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="predict"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openPredict"
                  >
                    Forecast Settings
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="exportPredictions"
                  >
                    Export Predictions
                  </button>
                </div>
              </div>
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="visualize"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"
                      />
                    </svg>Visualize</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="visualize"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="setViewGrid"
                  >
                    Grid View
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="setViewFocus"
                  >
                    Focus View
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="setViewHeatmap"
                  >
                    Heatmap View
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="setViewUncertainty"
                  >
                    Uncertainty View
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="exportChart"
                  >
                    Export Chart PNG
                  </button>
                </div>
              </div>
              <div class="menu-section">
                <button
                  class="menu-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-left"
                  data-section="advanced"
                >
                  <span class="flex items-center gap-2"><svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>Advanced</span>
                  <svg
                    class="w-4 h-4 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div
                  class="menu-content hidden pl-6 py-1 space-y-1"
                  data-section="advanced"
                >
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="openAdvanced"
                  >
                    Module Settings
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="togglePerformance"
                  >
                    Performance Mode
                  </button>
                  <button
                    class="menu-item w-full text-left p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-sm"
                    data-action="clearAll"
                  >
                    Reset Everything
                  </button>
                </div>
              </div>
            </nav>
          </div>
        </aside>
        <div
          id="sidebarOverlay"
          class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
        >
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
          <div class="flex-1 overflow-auto p-4">
            <!-- Onboarding -->
            <div
              id="onboarding"
              class="flex items-center justify-center h-full"
            >
              <div class="card p-8 max-w-xl w-full text-center fade-in">
                <div
                  class="w-16 h-16 mx-auto mb-6 rounded-2xl gradient-border flex items-center justify-center"
                >
                  <svg
                    class="w-8 h-8 text-white"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold mb-2">
                  Welcome to ESN Regression Studio
                </h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8">
                  Online multivariate regression and multi-horizon forecasting
                  with Echo State Networks
                </p>
                <div class="grid gap-4 sm:grid-cols-3">
                  <button
                    class="onboard-btn p-4 rounded-xl border-2 border-brand-500 bg-brand-50 dark:bg-brand-900/20 hover:bg-brand-100 dark:hover:bg-brand-900/40 transition-all"
                    data-action="startHere"
                  >
                    <div
                      class="w-10 h-10 mx-auto mb-3 rounded-lg bg-brand-500 flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 10V3L4 14h7v7l9-11h-7z"
                        />
                      </svg>
                    </div>
                    <div
                      class="font-semibold text-brand-700 dark:text-brand-300"
                    >
                      Start Here
                    </div>
                    <div
                      class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                    >
                      Recommended preset
                    </div>
                  </button>
                  <button
                    class="onboard-btn p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all"
                    data-action="loadModel"
                  >
                    <div
                      class="w-10 h-10 mx-auto mb-3 rounded-lg bg-slate-200 dark:bg-slate-600 flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-slate-600 dark:text-slate-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                        />
                      </svg>
                    </div>
                    <div class="font-semibold">Load Model</div>
                    <div
                      class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                    >
                      From file or storage
                    </div>
                  </button>
                  <button
                    class="onboard-btn p-4 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-all"
                    data-action="runTest"
                  >
                    <div
                      class="w-10 h-10 mx-auto mb-3 rounded-lg bg-purple-500 flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                        />
                      </svg>
                    </div>
                    <div
                      class="font-semibold text-purple-700 dark:text-purple-300"
                    >
                      Run Test
                    </div>
                    <div
                      class="text-xs text-slate-500 dark:text-slate-400 mt-1"
                    >
                      Auto-generate demo
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- Chart Container -->
            <div id="chartArea" class="hidden h-full">
              <div class="card h-full flex flex-col">
                <div
                  class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center gap-3">
                    <h3 id="chartTitle" class="font-semibold">Predictions</h3>
                    <div
                      id="viewTabs"
                      class="hidden sm:flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-lg p-1"
                    >
                      <button
                        class="view-tab px-3 py-1 text-sm rounded-md transition-all"
                        data-view="grid"
                      >
                        Grid
                      </button>
                      <button
                        class="view-tab px-3 py-1 text-sm rounded-md transition-all"
                        data-view="focus"
                      >
                        Focus
                      </button>
                      <button
                        class="view-tab px-3 py-1 text-sm rounded-md transition-all"
                        data-view="heatmap"
                      >
                        Heatmap
                      </button>
                      <button
                        class="view-tab px-3 py-1 text-sm rounded-md transition-all"
                        data-view="uncertainty"
                      >
                        Uncertainty
                      </button>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      id="dimSelect"
                      class="input-field text-sm py-1 w-32 hidden"
                    >
                      <option value="0">Target 0</option>
                    </select>
                    <button
                      id="exportChartBtn"
                      class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Export PNG"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="flex-1 relative p-4 overflow-hidden">
                  <canvas id="mainChart" class="w-full h-full"></canvas>
                  <div
                    id="chartTooltip"
                    class="chart-tooltip absolute hidden bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 p-3 text-sm z-10"
                  >
                  </div>
                  <div
                    id="chartEmpty"
                    class="absolute inset-0 flex items-center justify-center"
                  >
                    <div class="text-center">
                      <div
                        class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center"
                      >
                        <svg
                          class="w-8 h-8 text-slate-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                          />
                        </svg>
                      </div>
                      <p class="text-slate-500 dark:text-slate-400 mb-4">
                        No predictions yet
                      </p>
                      <button
                        id="runPredictEmpty"
                        class="btn-primary text-sm"
                        disabled
                      >
                        Run Prediction
                      </button>
                    </div>
                  </div>
                </div>
                <div
                  id="chartFooter"
                  class="hidden p-4 border-t border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-4">
                      <span class="flex items-center gap-2"><span
                          class="w-3 h-3 rounded-full bg-brand-500"
                        ></span>Prediction</span>
                      <span class="flex items-center gap-2"><span
                          class="w-3 h-0.5 bg-brand-300"
                        ></span>Confidence Band</span>
                    </div>
                    <div id="confidenceScore" class="font-medium"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom Controls -->
          <div
            id="controlBar"
            class="hidden border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4"
          >
            <div class="flex items-center gap-4 flex-wrap">
              <div class="flex items-center gap-2">
                <label class="text-sm font-medium">Steps:</label>
                <input
                  type="range"
                  id="stepsSlider"
                  min="1"
                  max="100"
                  value="10"
                  class="w-32"
                >
                <input
                  type="number"
                  id="stepsInput"
                  class="input-field w-16 text-sm py-1"
                  value="10"
                  min="1"
                  max="1000"
                >
              </div>
              <button id="runPredict" class="btn-primary">
                Run Prediction
              </button>
              <div
                id="trainProgress"
                class="hidden flex-1 flex items-center gap-3"
              >
                <div
                  class="flex-1 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"
                >
                  <div
                    id="progressBar"
                    class="h-full bg-brand-500 transition-all duration-200"
                    style="width: 0%"
                  >
                  </div>
                </div>
                <span id="progressText" class="text-sm font-medium">0%</span>
                <button id="cancelTrain" class="btn-secondary text-sm py-1">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </main>

        <!-- Right Panel -->
        <aside
          id="rightPanel"
          class="hidden lg:block w-80 border-l border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 overflow-hidden flex-shrink-0"
        >
          <div class="flex flex-col h-full">
            <div class="flex border-b border-slate-200 dark:border-slate-700">
              <button
                class="panel-tab flex-1 p-3 text-sm font-medium border-b-2 border-transparent hover:bg-slate-50 dark:hover:bg-slate-700"
                data-panel="metrics"
              >
                Metrics
              </button>
              <button
                class="panel-tab flex-1 p-3 text-sm font-medium border-b-2 border-transparent hover:bg-slate-50 dark:hover:bg-slate-700"
                data-panel="log"
              >
                Log
              </button>
            </div>
            <div id="metricsPanel" class="flex-1 overflow-auto p-4 hidden">
              <div class="space-y-4">
                <div class="card p-4">
                  <h4
                    class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3"
                  >
                    Model Summary
                  </h4>
                  <div id="modelMetrics" class="space-y-2 text-sm">
                    <p class="text-slate-400">No model created</p>
                  </div>
                </div>
                <div class="card p-4">
                  <h4
                    class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3"
                  >
                    Training Stats
                  </h4>
                  <div id="trainStats" class="space-y-2 text-sm">
                    <p class="text-slate-400">No training data</p>
                  </div>
                </div>
                <div class="card p-4">
                  <h4
                    class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3"
                  >
                    Last Prediction
                  </h4>
                  <div id="predStats" class="space-y-2 text-sm">
                    <p class="text-slate-400">No predictions</p>
                  </div>
                </div>
              </div>
            </div>
            <div id="logPanel" class="flex-1 overflow-auto p-4 hidden">
              <div class="flex items-center gap-2 mb-3">
                <select id="logFilter" class="input-field text-sm py-1 flex-1">
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
                <button
                  id="clearLog"
                  class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"
                  title="Clear log"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                </button>
              </div>
              <div id="logEntries" class="space-y-2 text-sm"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden">
      <div id="modalOverlay" class="absolute inset-0 bg-black/50"></div>
      <div
        class="absolute inset-0 flex items-center justify-center p-4 overflow-auto"
      >
        <div
          id="modalContent"
          class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-auto fade-in"
        >
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 z-50 bg-black/30 flex items-center justify-center hidden"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-xl flex items-center gap-4"
      >
        <svg
          class="w-6 h-6 animate-spin text-brand-500"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          >
          </circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          >
          </path>
        </svg>
        <span id="loadingText" class="font-medium">Loading...</span>
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        // Worker source code
        const workerSource = `
let ESNRegression = null;
let model = null;
let dataset = { x: [], y: [] };
let moduleUrl = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression';
let cancelTokens = new Set();

async function loadModule(url) {
  try {
    const mod = await import(url);
    ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module');
    return true;
  } catch (e1) {
    console.warn('Dynamic import failed, trying fetch fallback:', e1);
    try {
      const resp = await fetch(url);
      let text = await resp.text();
      const match = text.match(/class\\s+ESNRegression/);
      if (!match) throw new Error('ESNRegression class not found in fetched module');
      text = text.replace(/export\\s*\\{[^}]*\\}/g, '').replace(/export\\s+default/g, '').replace(/export\\s+/g, '');
      const fn = new Function(text + ';return ESNRegression;');
      ESNRegression = fn();
      return true;
    } catch (e2) {
      throw new Error('Failed to load ESNRegression: ' + e1.message + ' | Fallback: ' + e2.message);
    }
  }
}

function respond(requestId, type, payload) {
  self.postMessage({ requestId, type, payload });
}

function progress(requestId, processed, total, stage) {
  self.postMessage({ requestId, type: 'progress', payload: { processed, total, percent: Math.round((processed/total)*100), stage } });
}

self.onmessage = async function(e) {
  const { requestId, type, payload } = e.data;
  
  try {
    switch(type) {
      case 'init': {
        if (payload?.moduleUrl) moduleUrl = payload.moduleUrl;
        await loadModule(moduleUrl);
        respond(requestId, 'initComplete', { success: true });
        break;
      }
      
      case 'createModel': {
        if (!ESNRegression) throw new Error('Module not loaded');
        model = new ESNRegression(payload.config || {});
        dataset = { x: [], y: [] };
        const summary = model.getModelSummary();
        respond(requestId, 'modelCreated', { summary });
        break;
      }
      
      case 'fitOnline': {
        if (!model) throw new Error('No model created');
        const { xCoordinates, yCoordinates, batchSize = 50 } = payload;
        const total = xCoordinates.length;
        let result = null;
        
        for (let i = 0; i < total; i += batchSize) {
          if (cancelTokens.has(requestId)) {
            cancelTokens.delete(requestId);
            respond(requestId, 'cancelled', { processed: i });
            return;
          }
          const endIdx = Math.min(i + batchSize, total);
          const batchX = xCoordinates.slice(i, endIdx);
          const batchY = yCoordinates.slice(i, endIdx);
          result = model.fitOnline({ xCoordinates: batchX, yCoordinates: batchY });
          dataset.x.push(...batchX);
          dataset.y.push(...batchY);
          progress(requestId, endIdx, total, 'training');
        }
        
        const summary = model.getModelSummary();
        respond(requestId, 'fitComplete', { result, summary, datasetSize: dataset.x.length });
        break;
      }
      
      case 'predict': {
        if (!model) throw new Error('No model created');
        const result = model.predict(payload.futureSteps);
        respond(requestId, 'predictComplete', { result });
        break;
      }
      
      case 'getSummary': {
        if (!model) throw new Error('No model created');
        const summary = model.getModelSummary();
        respond(requestId, 'summary', { summary, datasetSize: dataset.x.length });
        break;
      }
      
      case 'reset': {
        if (model) model.reset();
        dataset = { x: [], y: [] };
        respond(requestId, 'resetComplete', {});
        break;
      }
      
      case 'save': {
        if (!model) throw new Error('No model created');
        const modelState = model.save();
        const summary = model.getModelSummary();
        const meta = {
          config: payload.config || {},
          nFeatures: summary.nFeatures,
          nTargets: summary.nTargets,
          sampleCount: summary.sampleCount,
          createdAt: new Date().toISOString(),
          appVersion: '1.0.0'
        };
        respond(requestId, 'saveComplete', { modelState, meta });
        break;
      }
      
      case 'load': {
        if (!ESNRegression) throw new Error('Module not loaded');
        let { data } = payload;
        let modelState, meta;
        
        if (typeof data === 'string') {
          try {
            const parsed = JSON.parse(data);
            if (parsed.modelState) {
              modelState = parsed.modelState;
              meta = parsed.meta;
            } else {
              modelState = data;
              meta = null;
            }
          } catch {
            modelState = data;
            meta = null;
          }
        } else if (data.modelState) {
          modelState = data.modelState;
          meta = data.meta;
        } else {
          throw new Error('Invalid model data format');
        }
        
        model = new ESNRegression(meta?.config || {});
        model.load(modelState);
        dataset = { x: [], y: [] };
        const summary = model.getModelSummary();
        respond(requestId, 'loadComplete', { summary, meta });
        break;
      }
      
      case 'getDataset': {
        respond(requestId, 'dataset', { x: dataset.x, y: dataset.y });
        break;
      }
      
      case 'cancel': {
        cancelTokens.add(payload.targetId);
        respond(requestId, 'cancelAck', {});
        break;
      }
      
      case 'setModuleUrl': {
        moduleUrl = payload.url;
        await loadModule(moduleUrl);
        respond(requestId, 'moduleUrlSet', { success: true });
        break;
      }
      
      default:
        throw new Error('Unknown command: ' + type);
    }
  } catch (err) {
    respond(requestId, 'error', { message: err.message, stack: err.stack });
  }
};
`;

        // Create worker from blob
        const workerBlob = new Blob([workerSource], {
          type: "application/javascript",
        });
        const workerUrl = URL.createObjectURL(workerBlob);
        let worker = new Worker(workerUrl, { type: "module" });

        // App State
        const state = {
          hasModel: false,
          modelSummary: null,
          predictions: null,
          currentView: "focus",
          selectedDim: 0,
          futureSteps: 10,
          darkMode: localStorage.getItem("darkMode") === "true",
          performanceMode:
            localStorage.getItem("performanceMode") === "true",
          moduleUrl: localStorage.getItem("moduleUrl") ||
            "https://cdn.esm.sh/jsr/@hviana/multivariate-regression",
          logs: [],
          pendingRequests: new Map(),
          requestCounter: 0,
          trainingInProgress: false,
          currentTrainId: null,
          datasetSize: 0,
          lastFitResult: null,
        };

        // DOM Elements
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        // Initialize dark mode
        if (state.darkMode) {
          document.documentElement.classList.add("dark");
        }

        // Worker communication
        function sendToWorker(type, payload = {}) {
          return new Promise((resolve, reject) => {
            const requestId = ++state.requestCounter;
            state.pendingRequests.set(requestId, {
              resolve,
              reject,
              type,
            });
            worker.postMessage({ requestId, type, payload });
          });
        }

        worker.onmessage = (e) => {
          const { requestId, type, payload } = e.data;
          const pending = state.pendingRequests.get(requestId);

          if (type === "progress") {
            updateProgress(payload);
            return;
          }

          if (type === "error") {
            if (pending) {
              state.pendingRequests.delete(requestId);
              pending.reject(new Error(payload.message));
            }
            addLog("error", "Worker Error", payload.message);
            return;
          }

          if (pending) {
            state.pendingRequests.delete(requestId);
            pending.resolve(payload);
          }
        };

        // Initialize worker
        async function initWorker() {
          showLoading("Initializing ESN module...");
          try {
            await sendToWorker("init", { moduleUrl: state.moduleUrl });
            addLog(
              "success",
              "Module Loaded",
              "ESNRegression module initialized successfully",
            );
            hideLoading();
          } catch (err) {
            hideLoading();
            addLog("error", "Init Failed", err.message);
            showToast(
              "error",
              "Failed to load ESN module: " + err.message,
            );
          }
        }

        // UI Functions
        function showLoading(text = "Loading...") {
          $("#loadingText").textContent = text;
          $("#loadingOverlay").classList.remove("hidden");
        }

        function hideLoading() {
          $("#loadingOverlay").classList.add("hidden");
        }

        function showToast(type, message) {
          const colors = {
            success: "bg-green-500",
            error: "bg-red-500",
            warning: "bg-amber-500",
            info: "bg-brand-500",
          };
          const toast = document.createElement("div");
          toast.className =
            `toast-enter px-4 py-3 rounded-lg shadow-lg text-white ${
              colors[type]
            } flex items-center gap-2`;
          toast.innerHTML = `
      <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${
            type === "success"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
              : ""
          }
        ${
            type === "error"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
              : ""
          }
        ${
            type === "warning"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>'
              : ""
          }
        ${
            type === "info"
              ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
              : ""
          }
      </svg>
      <span class="text-sm font-medium">${message}</span>
    `;
          $("#toasts").appendChild(toast);
          setTimeout(() => {
            toast.classList.remove("toast-enter");
            toast.classList.add("toast-exit");
            setTimeout(() => toast.remove(), 300);
          }, 4000);
        }

        function addLog(type, action, details) {
          const entry = {
            id: Date.now(),
            type,
            action,
            details,
            timestamp: new Date().toLocaleTimeString(),
          };
          state.logs.unshift(entry);
          if (state.logs.length > 500) state.logs.pop();
          renderLogs();
        }

        function renderLogs() {
          const filter = $("#logFilter").value;
          const filtered = filter === "all"
            ? state.logs
            : state.logs.filter((l) => l.type === filter);
          const colors = {
            info: "text-brand-500",
            success: "text-green-500",
            warning: "text-amber-500",
            error: "text-red-500",
          };
          $("#logEntries").innerHTML = filtered.slice(0, 100).map(
            (l) => `
      <div class="p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
        <div class="flex items-center gap-2 mb-1">
          <span class="${colors[l.type]} font-medium">${l.action}</span>
          <span class="text-xs text-slate-400">${l.timestamp}</span>
        </div>
        <div class="text-xs text-slate-500 dark:text-slate-400 break-words">${l.details}</div>
      </div>
    `,
          ).join("");
        }

        function updateProgress(data) {
          $("#progressBar").style.width = data.percent + "%";
          $("#progressText").textContent =
            `${data.percent}% (${data.processed}/${data.total})`;
        }

        function showModal(content) {
          $("#modalContent").innerHTML = content;
          $("#modalContainer").classList.remove("hidden");
          document.body.style.overflow = "hidden";
          setTimeout(() => {
            const firstInput = $("#modalContent").querySelector(
              "input, select, button",
            );
            if (firstInput) firstInput.focus();
          }, 100);
        }

        function hideModal() {
          $("#modalContainer").classList.add("hidden");
          document.body.style.overflow = "";
        }

        function updateUI() {
          const hasModel = state.hasModel;
          const hasPredictions = state.predictions !== null;

          $("#onboarding").classList.toggle("hidden", hasModel);
          $("#chartArea").classList.toggle("hidden", !hasModel);
          $("#controlBar").classList.toggle("hidden", !hasModel);
          $("#rightPanel").classList.toggle("hidden", !hasModel);
          $("#predictBtn").classList.toggle("hidden", !hasModel);
          $("#predictBtn").disabled = !hasModel;
          $("#runPredict").disabled = !hasModel;
          $("#runPredictEmpty").disabled = !hasModel;

          if (hasModel && state.modelSummary) {
            $("#modelStatus").textContent =
              `${state.modelSummary.reservoirSize}N`;
            $("#modelStatus").className =
              "px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400";

            if (state.datasetSize > 0) {
              $("#dataStatus").textContent =
                `${state.datasetSize} samples`;
              $("#dataStatus").classList.remove("hidden");
            }

            updateMetrics();
            updateDimSelect();
          } else {
            $("#modelStatus").textContent = "No Model";
            $("#modelStatus").className =
              "px-2 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700";
            $("#dataStatus").classList.add("hidden");
          }

          $("#chartEmpty").classList.toggle("hidden", hasPredictions);
          $("#chartFooter").classList.toggle("hidden", !hasPredictions);
          $("#viewTabs").classList.toggle("hidden", !hasPredictions);

          if (hasPredictions) {
            renderChart();
            updatePredStats();
          }
        }

        function updateMetrics() {
          if (!state.modelSummary) return;
          const s = state.modelSummary;
          $("#modelMetrics").innerHTML = `
      <div class="flex justify-between"><span class="text-slate-500">Reservoir Size</span><span class="font-medium">${s.reservoirSize}</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Features</span><span class="font-medium">${s.nFeatures}</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Targets</span><span class="font-medium">${s.nTargets}</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Spectral Radius</span><span class="font-medium">${
            s.spectralRadius?.toFixed(2) || "N/A"
          }</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Max Seq Length</span><span class="font-medium">${s.maxSequenceLength}</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Total Params</span><span class="font-medium">${
            s.totalParameters?.toLocaleString() || "N/A"
          }</span></div>
    `;

          if (state.lastFitResult) {
            const f = state.lastFitResult;
            $("#trainStats").innerHTML = `
        <div class="flex justify-between"><span class="text-slate-500">Samples Processed</span><span class="font-medium">${f.samplesProcessed}</span></div>
        <div class="flex justify-between"><span class="text-slate-500">Avg Loss</span><span class="font-medium">${
              f.averageLoss?.toFixed(6) || "N/A"
            }</span></div>
        <div class="flex justify-between"><span class="text-slate-500">Gradient Norm</span><span class="font-medium">${
              f.gradientNorm?.toFixed(6) || "N/A"
            }</span></div>
        <div class="flex justify-between"><span class="text-slate-500">Sample Weight</span><span class="font-medium">${
              f.sampleWeight?.toFixed(3) || "N/A"
            }</span></div>
      `;
          }
        }

        function updatePredStats() {
          if (!state.predictions) return;
          const p = state.predictions;
          $("#predStats").innerHTML = `
      <div class="flex justify-between"><span class="text-slate-500">Future Steps</span><span class="font-medium">${p.predictions.length}</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Confidence</span><span class="font-medium">${
            (p.confidence * 100).toFixed(1)
          }%</span></div>
      <div class="flex justify-between"><span class="text-slate-500">Targets</span><span class="font-medium">${
            p.predictions[0]?.length || 0
          }</span></div>
    `;
          $("#confidenceScore").textContent = `Confidence: ${
            (p.confidence * 100).toFixed(1)
          }%`;
        }

        function updateDimSelect() {
          if (!state.modelSummary) return;
          const nTargets = state.modelSummary.nTargets;
          const select = $("#dimSelect");
          select.innerHTML = Array.from(
            { length: nTargets },
            (_, i) => `<option value="${i}">Target ${i}</option>`,
          ).join("");
          select.value = state.selectedDim;
          select.classList.toggle(
            "hidden",
            state.currentView === "grid" ||
              state.currentView === "heatmap",
          );
        }

        // Chart Rendering
        const chartColors = {
          light: {
            line: "#0ea5e9",
            band: "rgba(14, 165, 233, 0.15)",
            bandStroke: "rgba(14, 165, 233, 0.3)",
            grid: "#e2e8f0",
            axis: "#64748b",
            text: "#334155",
            bg: "#ffffff",
          },
          dark: {
            line: "#38bdf8",
            band: "rgba(56, 189, 248, 0.15)",
            bandStroke: "rgba(56, 189, 248, 0.3)",
            grid: "#334155",
            axis: "#94a3b8",
            text: "#e2e8f0",
            bg: "#1e293b",
          },
        };

        function getColors() {
          return state.darkMode ? chartColors.dark : chartColors.light;
        }

        function niceNumber(range, round) {
          const exp = Math.floor(Math.log10(range));
          const frac = range / Math.pow(10, exp);
          let nice;
          if (round) {
            if (frac < 1.5) nice = 1;
            else if (frac < 3) nice = 2;
            else if (frac < 7) nice = 5;
            else nice = 10;
          } else {
            if (frac <= 1) nice = 1;
            else if (frac <= 2) nice = 2;
            else if (frac <= 5) nice = 5;
            else nice = 10;
          }
          return nice * Math.pow(10, exp);
        }

        function generateTicks(min, max, targetCount = 5) {
          const range = niceNumber(max - min, false);
          const tickSpacing = niceNumber(
            range / (targetCount - 1),
            true,
          );
          const niceMin = Math.floor(min / tickSpacing) * tickSpacing;
          const niceMax = Math.ceil(max / tickSpacing) * tickSpacing;
          const ticks = [];
          for (
            let t = niceMin;
            t <= niceMax + tickSpacing * 0.5;
            t += tickSpacing
          ) {
            ticks.push(t);
          }
          return { min: niceMin, max: niceMax, ticks };
        }

        function renderChart() {
          const canvas = $("#mainChart");
          const ctx = canvas.getContext("2d");
          const rect = canvas.parentElement.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;

          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          canvas.style.width = rect.width + "px";
          canvas.style.height = rect.height + "px";
          ctx.scale(dpr, dpr);

          const colors = getColors();
          const w = rect.width;
          const h = rect.height;

          ctx.fillStyle = colors.bg;
          ctx.fillRect(0, 0, w, h);

          if (!state.predictions) return;

          switch (state.currentView) {
            case "focus":
              renderFocusChart(ctx, w, h, colors);
              break;
            case "grid":
              renderGridChart(ctx, w, h, colors);
              break;
            case "heatmap":
              renderHeatmap(ctx, w, h, colors);
              break;
            case "uncertainty":
              renderUncertaintyChart(ctx, w, h, colors);
              break;
          }
        }

        function renderFocusChart(ctx, w, h, colors) {
          const pred = state.predictions;
          const dim = state.selectedDim;
          const data = pred.predictions.map((p) => p[dim]);
          const lower = pred.lowerBounds.map((l) => l[dim]);
          const upper = pred.upperBounds.map((u) => u[dim]);

          const padding = { top: 40, right: 40, bottom: 50, left: 60 };
          const chartW = w - padding.left - padding.right;
          const chartH = h - padding.top - padding.bottom;

          const allValues = [...data, ...lower, ...upper];
          const dataMin = Math.min(...allValues);
          const dataMax = Math.max(...allValues);
          const yPad = (dataMax - dataMin) * 0.1 || 1;
          const yAxis = generateTicks(
            dataMin - yPad,
            dataMax + yPad,
            6,
          );
          const xAxis = generateTicks(
            0,
            data.length - 1,
            Math.min(10, data.length),
          );

          const scaleX = (i) =>
            padding.left + (i / (data.length - 1 || 1)) * chartW;
          const scaleY = (v) =>
            padding.top + chartH -
            ((v - yAxis.min) / (yAxis.max - yAxis.min)) * chartH;

          // Grid
          ctx.strokeStyle = colors.grid;
          ctx.lineWidth = 1;
          yAxis.ticks.forEach((t) => {
            const y = scaleY(t);
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(w - padding.right, y);
            ctx.stroke();
          });

          // Confidence band
          ctx.fillStyle = colors.band;
          ctx.beginPath();
          ctx.moveTo(scaleX(0), scaleY(upper[0]));
          for (let i = 0; i < data.length; i++) {
            ctx.lineTo(scaleX(i), scaleY(upper[i]));
          }
          for (let i = data.length - 1; i >= 0; i--) {
            ctx.lineTo(scaleX(i), scaleY(lower[i]));
          }
          ctx.closePath();
          ctx.fill();

          ctx.strokeStyle = colors.bandStroke;
          ctx.lineWidth = 1;
          ctx.beginPath();
          for (let i = 0; i < data.length; i++) {
            i === 0
              ? ctx.moveTo(scaleX(i), scaleY(upper[i]))
              : ctx.lineTo(scaleX(i), scaleY(upper[i]));
          }
          ctx.stroke();
          ctx.beginPath();
          for (let i = 0; i < data.length; i++) {
            i === 0
              ? ctx.moveTo(scaleX(i), scaleY(lower[i]))
              : ctx.lineTo(scaleX(i), scaleY(lower[i]));
          }
          ctx.stroke();

          // Prediction line
          ctx.strokeStyle = colors.line;
          ctx.lineWidth = 2;
          ctx.lineJoin = "round";
          ctx.lineCap = "round";
          ctx.beginPath();
          for (let i = 0; i < data.length; i++) {
            i === 0
              ? ctx.moveTo(scaleX(i), scaleY(data[i]))
              : ctx.lineTo(scaleX(i), scaleY(data[i]));
          }
          ctx.stroke();

          // Points
          ctx.fillStyle = colors.line;
          for (let i = 0; i < data.length; i++) {
            ctx.beginPath();
            ctx.arc(scaleX(i), scaleY(data[i]), 4, 0, Math.PI * 2);
            ctx.fill();
          }

          // Axes labels
          ctx.fillStyle = colors.text;
          ctx.font = "12px Inter, sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          xAxis.ticks.forEach((t) => {
            if (t >= 0 && t < data.length) {
              ctx.fillText(
                Math.round(t).toString(),
                scaleX(t),
                h - padding.bottom + 10,
              );
            }
          });
          ctx.fillText("Step", w / 2, h - 15);

          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          yAxis.ticks.forEach((t) => {
            ctx.fillText(t.toFixed(2), padding.left - 10, scaleY(t));
          });

          ctx.save();
          ctx.translate(15, h / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.textAlign = "center";
          ctx.fillText(`Target ${dim}`, 0, 0);
          ctx.restore();

          // Title
          ctx.font = "14px Inter, sans-serif";
          ctx.textAlign = "left";
          ctx.fillText(`Prediction - Target ${dim}`, padding.left, 15);
        }

        function renderGridChart(ctx, w, h, colors) {
          const pred = state.predictions;
          const nTargets = pred.predictions[0].length;
          const cols = Math.ceil(Math.sqrt(nTargets));
          const rows = Math.ceil(nTargets / cols);
          const cellW = w / cols;
          const cellH = h / rows;
          const padding = 20;

          for (let t = 0; t < nTargets; t++) {
            const col = t % cols;
            const row = Math.floor(t / cols);
            const x0 = col * cellW + padding;
            const y0 = row * cellH + padding;
            const cw = cellW - padding * 2;
            const ch = cellH - padding * 2;

            const data = pred.predictions.map((p) => p[t]);
            const lower = pred.lowerBounds.map((l) => l[t]);
            const upper = pred.upperBounds.map((u) => u[t]);

            const allValues = [...data, ...lower, ...upper];
            const dataMin = Math.min(...allValues);
            const dataMax = Math.max(...allValues);
            const yPad = (dataMax - dataMin) * 0.1 || 1;

            const scaleX = (i) =>
              x0 + (i / (data.length - 1 || 1)) * cw;
            const scaleY = (v) =>
              y0 + ch -
              ((v - (dataMin - yPad)) /
                  ((dataMax + yPad) - (dataMin - yPad))) * ch;

            // Background
            ctx.fillStyle = colors.bg;
            ctx.fillRect(col * cellW, row * cellH, cellW, cellH);

            // Band
            ctx.fillStyle = colors.band;
            ctx.beginPath();
            ctx.moveTo(scaleX(0), scaleY(upper[0]));
            for (let i = 0; i < data.length; i++) {
              ctx.lineTo(scaleX(i), scaleY(upper[i]));
            }
            for (let i = data.length - 1; i >= 0; i--) {
              ctx.lineTo(scaleX(i), scaleY(lower[i]));
            }
            ctx.closePath();
            ctx.fill();

            // Line
            ctx.strokeStyle = colors.line;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < data.length; i++) {
              i === 0
                ? ctx.moveTo(scaleX(i), scaleY(data[i]))
                : ctx.lineTo(scaleX(i), scaleY(data[i]));
            }
            ctx.stroke();

            // Label
            ctx.fillStyle = colors.text;
            ctx.font = "11px Inter, sans-serif";
            ctx.textAlign = "left";
            ctx.fillText(`T${t}`, x0, y0 - 5);

            // Border
            ctx.strokeStyle = colors.grid;
            ctx.lineWidth = 1;
            ctx.strokeRect(
              col * cellW + 1,
              row * cellH + 1,
              cellW - 2,
              cellH - 2,
            );
          }
        }

        function renderHeatmap(ctx, w, h, colors) {
          const pred = state.predictions;
          const nTargets = pred.predictions[0].length;
          const nSteps = pred.predictions.length;

          const padding = { top: 40, right: 80, bottom: 50, left: 60 };
          const chartW = w - padding.left - padding.right;
          const chartH = h - padding.top - padding.bottom;

          const cellW = chartW / nSteps;
          const cellH = chartH / nTargets;

          const allVals = pred.predictions.flat();
          const vMin = Math.min(...allVals);
          const vMax = Math.max(...allVals);
          const vRange = vMax - vMin || 1;

          for (let t = 0; t < nTargets; t++) {
            for (let s = 0; s < nSteps; s++) {
              const val = pred.predictions[s][t];
              const norm = (val - vMin) / vRange;
              const hue = (1 - norm) * 240;
              ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
              ctx.fillRect(
                padding.left + s * cellW,
                padding.top + t * cellH,
                cellW - 1,
                cellH - 1,
              );
            }
          }

          // Labels
          ctx.fillStyle = colors.text;
          ctx.font = "11px Inter, sans-serif";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          for (let t = 0; t < nTargets; t++) {
            ctx.fillText(
              `T${t}`,
              padding.left - 10,
              padding.top + t * cellH + cellH / 2,
            );
          }

          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          const stepLabels = Math.min(nSteps, 10);
          const stepInterval = Math.ceil(nSteps / stepLabels);
          for (let s = 0; s < nSteps; s += stepInterval) {
            ctx.fillText(
              s.toString(),
              padding.left + s * cellW + cellW / 2,
              h - padding.bottom + 10,
            );
          }

          ctx.fillText("Step", w / 2, h - 15);

          // Legend
          const legX = w - padding.right + 20;
          const legH = chartH;
          const legW = 15;
          const gradient = ctx.createLinearGradient(
            0,
            padding.top,
            0,
            padding.top + legH,
          );
          gradient.addColorStop(0, "hsl(0, 70%, 50%)");
          gradient.addColorStop(0.5, "hsl(120, 70%, 50%)");
          gradient.addColorStop(1, "hsl(240, 70%, 50%)");
          ctx.fillStyle = gradient;
          ctx.fillRect(legX, padding.top, legW, legH);

          ctx.fillStyle = colors.text;
          ctx.textAlign = "left";
          ctx.textBaseline = "top";
          ctx.fillText(vMax.toFixed(2), legX + legW + 5, padding.top);
          ctx.textBaseline = "bottom";
          ctx.fillText(
            vMin.toFixed(2),
            legX + legW + 5,
            padding.top + legH,
          );

          // Title
          ctx.font = "14px Inter, sans-serif";
          ctx.textAlign = "left";
          ctx.textBaseline = "top";
          ctx.fillText("Prediction Heatmap", padding.left, 15);
        }

        function renderUncertaintyChart(ctx, w, h, colors) {
          const pred = state.predictions;
          const dim = state.selectedDim;
          const lower = pred.lowerBounds.map((l) => l[dim]);
          const upper = pred.upperBounds.map((u) => u[dim]);
          const bandWidth = upper.map((u, i) => u - lower[i]);

          const padding = { top: 40, right: 40, bottom: 50, left: 60 };
          const chartW = w - padding.left - padding.right;
          const chartH = h - padding.top - padding.bottom;

          const dataMax = Math.max(...bandWidth);
          const yAxis = generateTicks(0, dataMax * 1.1, 6);

          const barW = (chartW / bandWidth.length) * 0.7;
          const gap = (chartW / bandWidth.length) * 0.3;

          const scaleX = (i) =>
            padding.left + i * (barW + gap) + barW / 2;
          const scaleY = (v) =>
            padding.top + chartH - (v / yAxis.max) * chartH;

          // Grid
          ctx.strokeStyle = colors.grid;
          ctx.lineWidth = 1;
          yAxis.ticks.forEach((t) => {
            const y = scaleY(t);
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(w - padding.right, y);
            ctx.stroke();
          });

          // Bars
          const gradient = ctx.createLinearGradient(
            0,
            padding.top + chartH,
            0,
            padding.top,
          );
          gradient.addColorStop(0, colors.band);
          gradient.addColorStop(1, colors.line);

          for (let i = 0; i < bandWidth.length; i++) {
            const x = padding.left + i * (barW + gap);
            const barH = (bandWidth[i] / yAxis.max) * chartH;
            ctx.fillStyle = gradient;
            ctx.fillRect(x, padding.top + chartH - barH, barW, barH);
          }

          // Axes labels
          ctx.fillStyle = colors.text;
          ctx.font = "12px Inter, sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          const stepLabels = Math.min(bandWidth.length, 10);
          const stepInterval = Math.ceil(bandWidth.length / stepLabels);
          for (let i = 0; i < bandWidth.length; i += stepInterval) {
            ctx.fillText(
              i.toString(),
              scaleX(i),
              h - padding.bottom + 10,
            );
          }
          ctx.fillText("Step", w / 2, h - 15);

          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          yAxis.ticks.forEach((t) => {
            ctx.fillText(t.toFixed(2), padding.left - 10, scaleY(t));
          });

          ctx.save();
          ctx.translate(15, h / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.textAlign = "center";
          ctx.fillText("Uncertainty (Band Width)", 0, 0);
          ctx.restore();

          // Title
          ctx.font = "14px Inter, sans-serif";
          ctx.textAlign = "left";
          ctx.fillText(`Uncertainty - Target ${dim}`, padding.left, 15);
        }

        // Event handlers
        function setupEventListeners() {
          // Dark mode toggle
          $("#darkToggle").onclick = () => {
            state.darkMode = !state.darkMode;
            document.documentElement.classList.toggle(
              "dark",
              state.darkMode,
            );
            localStorage.setItem("darkMode", state.darkMode);
            if (state.predictions) renderChart();
          };

          // Sidebar
          $("#menuBtn").onclick = () => {
            $("#sidebar").classList.remove("-translate-x-full");
            $("#sidebarOverlay").classList.remove("hidden");
          };
          $("#closeSidebar").onclick = () => {
            $("#sidebar").classList.add("-translate-x-full");
            $("#sidebarOverlay").classList.add("hidden");
          };
          $("#sidebarOverlay").onclick = () => {
            $("#sidebar").classList.add("-translate-x-full");
            $("#sidebarOverlay").classList.add("hidden");
          };

          // Menu sections
          $$(".menu-header").forEach((btn) => {
            btn.onclick = () => {
              const section = btn.dataset.section;
              const content = $(
                `.menu-content[data-section="${section}"]`,
              );
              const icon = btn.querySelector("svg:last-child");
              content.classList.toggle("hidden");
              icon.classList.toggle("rotate-180");
            };
          });

          // Menu actions
          $$(".menu-item").forEach((btn) => {
            btn.onclick = () => handleMenuAction(btn.dataset.action);
          });

          // Onboarding buttons
          $$(".onboard-btn").forEach((btn) => {
            btn.onclick = () => handleMenuAction(btn.dataset.action);
          });

          // View tabs
          $$(".view-tab").forEach((tab) => {
            tab.onclick = () => setView(tab.dataset.view);
          });

          // Panel tabs
          $$(".panel-tab").forEach((tab) => {
            tab.onclick = () => {
              const panel = tab.dataset.panel;
              $$(".panel-tab").forEach((t) => {
                t.classList.toggle(
                  "border-brand-500",
                  t.dataset.panel === panel,
                );
                t.classList.toggle(
                  "text-brand-500",
                  t.dataset.panel === panel,
                );
              });
              $("#metricsPanel").classList.toggle(
                "hidden",
                panel !== "metrics",
              );
              $("#logPanel").classList.toggle(
                "hidden",
                panel !== "log",
              );
            };
          });
          // Init first tab
          $('[data-panel="metrics"]').click();

          // Dimension select
          $("#dimSelect").onchange = (e) => {
            state.selectedDim = parseInt(e.target.value);
            renderChart();
          };

          // Steps controls
          $("#stepsSlider").oninput = (e) => {
            state.futureSteps = parseInt(e.target.value);
            $("#stepsInput").value = state.futureSteps;
          };
          $("#stepsInput").onchange = (e) => {
            state.futureSteps = Math.max(
              1,
              Math.min(1000, parseInt(e.target.value) || 10),
            );
            $("#stepsSlider").value = Math.min(100, state.futureSteps);
            e.target.value = state.futureSteps;
          };

          // Predict buttons
          $("#runPredict").onclick = runPrediction;
          $("#predictBtn").onclick = runPrediction;
          $("#runPredictEmpty").onclick = runPrediction;

          // Cancel training
          $("#cancelTrain").onclick = cancelTraining;

          // Log filter
          $("#logFilter").onchange = renderLogs;
          $("#clearLog").onclick = () => {
            state.logs = [];
            renderLogs();
          };

          // Export chart
          $("#exportChartBtn").onclick = exportChart;

          // Modal close
          $("#modalOverlay").onclick = hideModal;

          // Keyboard shortcuts
          document.onkeydown = (e) => {
            if (
              e.target.tagName === "INPUT" ||
              e.target.tagName === "TEXTAREA"
            ) return;
            if (e.key === "Escape") hideModal();
            if (e.key === "m" || e.key === "M") $("#menuBtn").click();
            if (e.key === "c" || e.key === "C") {
              handleMenuAction("openConfig");
            }
            if (e.key === "u" || e.key === "U") {
              handleMenuAction("openUpload");
            }
            if ((e.key === "p" || e.key === "P") && state.hasModel) {
              runPrediction();
            }
          };

          // Window resize
          let resizeTimeout;
          window.onresize = () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              if (state.predictions) renderChart();
            }, 100);
          };
        }

        function setView(view) {
          state.currentView = view;
          $$(".view-tab").forEach((t) => {
            t.classList.toggle("bg-white", t.dataset.view === view);
            t.classList.toggle(
              "dark:bg-slate-600",
              t.dataset.view === view,
            );
            t.classList.toggle("shadow-sm", t.dataset.view === view);
          });
          $("#dimSelect").classList.toggle(
            "hidden",
            view === "grid" || view === "heatmap",
          );
          renderChart();
        }

        async function handleMenuAction(action) {
          $("#sidebar").classList.add("-translate-x-full");
          $("#sidebarOverlay").classList.add("hidden");

          switch (action) {
            case "openConfig":
              showConfigModal();
              break;
            case "showSummary":
              showSummaryModal();
              break;
            case "resetModel":
              await resetModel();
              break;
            case "openSaveLoad":
              showSaveLoadModal();
              break;
            case "openUpload":
              showUploadModal();
              break;
            case "openManualInsert":
              showManualInsertModal();
              break;
            case "exportDataset":
              await exportDataset();
              break;
            case "trainOnline":
              await trainOnline();
              break;
            case "openRandomTest":
              showRandomTestModal();
              break;
            case "openPredict":
              showPredictModal();
              break;
            case "exportPredictions":
              exportPredictions();
              break;
            case "setViewGrid":
              setView("grid");
              break;
            case "setViewFocus":
              setView("focus");
              break;
            case "setViewHeatmap":
              setView("heatmap");
              break;
            case "setViewUncertainty":
              setView("uncertainty");
              break;
            case "exportChart":
              exportChart();
              break;
            case "openAdvanced":
              showAdvancedModal();
              break;
            case "togglePerformance":
              togglePerformanceMode();
              break;
            case "clearAll":
              await clearAll();
              break;
            case "startHere":
              await createModelWithPreset("balanced");
              break;
            case "loadModel":
              showSaveLoadModal();
              break;
            case "runTest":
              await runStandardTest();
              break;
          }
        }

        // Model operations
        const presets = {
          startHere: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.3,
            rlsLambda: 0.999,
          },
          fast: {
            reservoirSize: 64,
            maxSequenceLength: 32,
            spectralRadius: 0.8,
            leakRate: 0.5,
            rlsLambda: 0.995,
          },
          balanced: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.3,
            rlsLambda: 0.999,
          },
          accurate: {
            reservoirSize: 512,
            maxSequenceLength: 128,
            spectralRadius: 0.95,
            leakRate: 0.2,
            rlsLambda: 0.9995,
            l2Lambda: 0.0001,
          },
          adaptive: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.85,
            leakRate: 0.5,
            rlsLambda: 0.97,
          },
          robust: {
            reservoirSize: 256,
            maxSequenceLength: 64,
            spectralRadius: 0.9,
            leakRate: 0.2,
            outlierThreshold: 2.0,
            l2Lambda: 0.01,
          },
        };

        async function createModelWithPreset(preset) {
          const config = presets[preset] || presets.balanced;
          showLoading("Creating model...");
          try {
            const result = await sendToWorker("createModel", {
              config,
            });
            state.hasModel = true;
            state.modelSummary = result.summary;
            state.predictions = null;
            state.datasetSize = 0;
            addLog(
              "success",
              "Model Created",
              `Preset: ${preset}, Reservoir: ${result.summary.reservoirSize}`,
            );
            showToast("success", "Model created successfully");
            updateUI();
          } catch (err) {
            addLog("error", "Create Failed", err.message);
            showToast(
              "error",
              "Failed to create model: " + err.message,
            );
          }
          hideLoading();
        }

        async function resetModel() {
          if (!state.hasModel) return;
          showLoading("Resetting model...");
          try {
            await sendToWorker("reset");
            state.predictions = null;
            state.datasetSize = 0;
            state.lastFitResult = null;
            const result = await sendToWorker("getSummary");
            state.modelSummary = result.summary;
            addLog("info", "Model Reset", "Model and data cleared");
            showToast("success", "Model reset");
            updateUI();
          } catch (err) {
            addLog("error", "Reset Failed", err.message);
            showToast("error", err.message);
          }
          hideLoading();
        }

        async function runPrediction() {
          if (!state.hasModel) return;
          showLoading("Running prediction...");
          try {
            const result = await sendToWorker("predict", {
              futureSteps: state.futureSteps,
            });
            state.predictions = result.result;
            addLog(
              "success",
              "Prediction Complete",
              `${state.futureSteps} steps, confidence: ${
                (result.result.confidence * 100).toFixed(1)
              }%`,
            );
            updateUI();
          } catch (err) {
            addLog("error", "Prediction Failed", err.message);
            showToast("error", err.message);
          }
          hideLoading();
        }

        async function trainOnline() {
          showToast(
            "info",
            "Use Upload or Manual Insert to add training data",
          );
        }

        async function cancelTraining() {
          if (state.currentTrainId) {
            await sendToWorker("cancel", {
              targetId: state.currentTrainId,
            });
            state.trainingInProgress = false;
            $("#trainProgress").classList.add("hidden");
            showToast("warning", "Training cancelled");
          }
        }

        function exportChart() {
          const canvas = $("#mainChart");
          const link = document.createElement("a");
          link.download = `esn-chart-${Date.now()}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
          showToast("success", "Chart exported");
        }

        function exportPredictions() {
          if (!state.predictions) {
            showToast("warning", "No predictions to export");
            return;
          }
          const data = JSON.stringify(state.predictions, null, 2);
          const blob = new Blob([data], { type: "application/json" });
          const link = document.createElement("a");
          link.download = `predictions-${Date.now()}.json`;
          link.href = URL.createObjectURL(blob);
          link.click();
          addLog("info", "Export", "Predictions exported");
          showToast("success", "Predictions exported");
        }

        async function exportDataset() {
          try {
            const result = await sendToWorker("getDataset");
            if (result.x.length === 0) {
              showToast("warning", "No dataset to export");
              return;
            }
            const data = JSON.stringify(
              { xCoordinates: result.x, yCoordinates: result.y },
              null,
              2,
            );
            const blob = new Blob([data], { type: "application/json" });
            const link = document.createElement("a");
            link.download = `dataset-${Date.now()}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("success", "Dataset exported");
          } catch (err) {
            showToast("error", err.message);
          }
        }

        function togglePerformanceMode() {
          state.performanceMode = !state.performanceMode;
          localStorage.setItem(
            "performanceMode",
            state.performanceMode,
          );
          showToast(
            "info",
            `Performance mode ${
              state.performanceMode ? "enabled" : "disabled"
            }`,
          );
        }

        async function clearAll() {
          if (
            !confirm(
              "This will clear the model, all data, logs, and localStorage. Continue?",
            )
          ) return;
          localStorage.clear();
          state.hasModel = false;
          state.modelSummary = null;
          state.predictions = null;
          state.datasetSize = 0;
          state.lastFitResult = null;
          state.logs = [];
          updateUI();
          renderLogs();
          showToast("success", "Everything cleared");
        }

        // Random test
        async function runStandardTest() {
          showLoading("Generating test data and training...");
          try {
            await createModelWithPreset("balanced");

            const seed = 42;
            const nFeatures = 3;
            const nTargets = 2;
            const nSamples = 200;

            function seededRandom(s) {
              return function () {
                s = Math.sin(s) * 10000;
                return s - Math.floor(s);
              };
            }
            const rng = seededRandom(seed);

            const xCoordinates = [];
            const yCoordinates = [];

            for (let i = 0; i < nSamples; i++) {
              const t = i / nSamples;
              const x = [
                Math.sin(t * 4 * Math.PI) + rng() * 0.1,
                Math.cos(t * 2 * Math.PI) + rng() * 0.1,
                t + rng() * 0.05,
              ];
              const y = [
                x[0] * 0.5 + x[1] * 0.3 +
                Math.sin(t * 6 * Math.PI) * 0.2 + rng() * 0.05,
                x[1] * 0.4 - x[2] * 0.2 +
                Math.cos(t * 3 * Math.PI) * 0.3 + rng() * 0.05,
              ];
              xCoordinates.push(x);
              yCoordinates.push(y);
            }

            state.trainingInProgress = true;
            state.currentTrainId = state.requestCounter + 1;
            $("#trainProgress").classList.remove("hidden");

            const result = await sendToWorker("fitOnline", {
              xCoordinates,
              yCoordinates,
              batchSize: 20,
            });

            state.trainingInProgress = false;
            $("#trainProgress").classList.add("hidden");
            state.lastFitResult = result.result;
            state.modelSummary = result.summary;
            state.datasetSize = result.datasetSize;

            addLog(
              "success",
              "Test Training Complete",
              `${nSamples} samples, loss: ${
                result.result.averageLoss?.toFixed(6)
              }`,
            );

            state.futureSteps = 20;
            $("#stepsInput").value = 20;
            $("#stepsSlider").value = 20;

            const pred = await sendToWorker("predict", {
              futureSteps: 20,
            });
            state.predictions = pred.result;

            setView("focus");
            updateUI();
            showToast(
              "success",
              "Test completed! Showing predictions.",
            );
          } catch (err) {
            state.trainingInProgress = false;
            $("#trainProgress").classList.add("hidden");
            addLog("error", "Test Failed", err.message);
            showToast("error", err.message);
          }
          hideLoading();
        }

        // Modals
        function showConfigModal() {
          const current = state.modelSummary || {};
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Model Configuration</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="mb-6">
          <label class="text-sm font-medium mb-2 block">Preset</label>
          <div class="grid grid-cols-3 gap-2">
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="startHere">Start Here</button>
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="fast">Fast/Light</button>
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="balanced">Balanced</button>
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="accurate">Accurate</button>
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="adaptive">Adaptive</button>
            <button class="preset-btn p-2 text-sm rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20" data-preset="robust">Robust</button>
          </div>
        </div>
        
        <div class="space-y-4 max-h-[40vh] overflow-y-auto pr-2">
          <div>
            <label class="text-sm font-medium">Reservoir Size</label>
            <input type="number" id="cfgReservoirSize" class="input-field mt-1" value="${
            current.reservoirSize || 256
          }" min="16" max="2048">
            <p class="text-xs text-slate-500 mt-1">Number of neurons (16-2048). Larger = more capacity, slower training.</p>
          </div>
          <div>
            <label class="text-sm font-medium">Max Sequence Length</label>
            <input type="number" id="cfgMaxSeqLen" class="input-field mt-1" value="${
            current.maxSequenceLength || 64
          }" min="8" max="512">
            <p class="text-xs text-slate-500 mt-1">History window and max prediction horizon (8-512).</p>
          </div>
          <div>
            <label class="text-sm font-medium">Spectral Radius</label>
            <input type="number" id="cfgSpectralRadius" class="input-field mt-1" value="0.9" min="0.1" max="0.99" step="0.01">
            <p class="text-xs text-slate-500 mt-1">Memory length (0.1-0.99). Higher = longer memory, risk of instability.</p>
          </div>
          <div>
            <label class="text-sm font-medium">Leak Rate</label>
            <input type="number" id="cfgLeakRate" class="input-field mt-1" value="0.3" min="0.01" max="1" step="0.01">
            <p class="text-xs text-slate-500 mt-1">Temporal smoothing (0.01-1). Lower = smoother, higher = more reactive.</p>
          </div>
          <div>
            <label class="text-sm font-medium">RLS Lambda</label>
            <input type="number" id="cfgRlsLambda" class="input-field mt-1" value="0.999" min="0.9" max="0.9999" step="0.001">
            <p class="text-xs text-slate-500 mt-1">Forgetting factor (0.9-0.9999). Lower = faster adaptation to changes.</p>
          </div>
          <div>
            <label class="text-sm font-medium">Outlier Threshold</label>
            <input type="number" id="cfgOutlierThreshold" class="input-field mt-1" value="3.0" min="1" max="5" step="0.1">
            <p class="text-xs text-slate-500 mt-1">Z-score threshold (1-5). Lower = more aggressive outlier filtering.</p>
          </div>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button id="createModelBtn" class="btn-primary flex-1">Create Model</button>
          <button onclick="hideModal()" class="btn-secondary">Cancel</button>
        </div>
      </div>
    `);

          $$(".preset-btn").forEach((btn) => {
            btn.onclick = () => {
              const p = presets[btn.dataset.preset];
              if (p) {
                $("#cfgReservoirSize").value = p.reservoirSize || 256;
                $("#cfgMaxSeqLen").value = p.maxSequenceLength || 64;
                $("#cfgSpectralRadius").value = p.spectralRadius || 0.9;
                $("#cfgLeakRate").value = p.leakRate || 0.3;
                $("#cfgRlsLambda").value = p.rlsLambda || 0.999;
                $("#cfgOutlierThreshold").value = p.outlierThreshold ||
                  3.0;
              }
            };
          });

          $("#createModelBtn").onclick = async () => {
            const config = {
              reservoirSize: parseInt($("#cfgReservoirSize").value),
              maxSequenceLength: parseInt($("#cfgMaxSeqLen").value),
              spectralRadius: parseFloat($("#cfgSpectralRadius").value),
              leakRate: parseFloat($("#cfgLeakRate").value),
              rlsLambda: parseFloat($("#cfgRlsLambda").value),
              outlierThreshold: parseFloat(
                $("#cfgOutlierThreshold").value,
              ),
            };
            hideModal();
            showLoading("Creating model...");
            try {
              const result = await sendToWorker("createModel", {
                config,
              });
              state.hasModel = true;
              state.modelSummary = result.summary;
              state.predictions = null;
              state.datasetSize = 0;
              addLog(
                "success",
                "Model Created",
                `Reservoir: ${config.reservoirSize}`,
              );
              showToast("success", "Model created");
              updateUI();
            } catch (err) {
              addLog("error", "Create Failed", err.message);
              showToast("error", err.message);
            }
            hideLoading();
          };
        }

        function showSummaryModal() {
          if (!state.modelSummary) {
            showToast("warning", "No model created");
            return;
          }
          const s = state.modelSummary;
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Model Summary</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="space-y-3">
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Reservoir Size</span><span class="font-medium">${s.reservoirSize}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Features</span><span class="font-medium">${s.nFeatures}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Targets</span><span class="font-medium">${s.nTargets}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Max Sequence Length</span><span class="font-medium">${s.maxSequenceLength}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Spectral Radius</span><span class="font-medium">${
            s.spectralRadius?.toFixed(3) || "N/A"
          }</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Total Parameters</span><span class="font-medium">${
            s.totalParameters?.toLocaleString() || "N/A"
          }</span></div>
          <div class="flex justify-between py-2 border-b border-slate-200 dark:border-slate-700"><span>Samples Trained</span><span class="font-medium">${
            s.sampleCount || 0
          }</span></div>
          <div class="flex justify-between py-2"><span>Dataset Size</span><span class="font-medium">${state.datasetSize}</span></div>
        </div>
        <button onclick="hideModal()" class="btn-secondary w-full mt-6">Close</button>
      </div>
    `);
        }

        function showUploadModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Upload Dataset</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="mb-4">
          <label class="text-sm font-medium mb-2 block">Upload JSON File</label>
          <input type="file" id="uploadFile" accept=".json" class="input-field">
        </div>
        
        <div class="mb-4">
          <label class="text-sm font-medium mb-2 block">Or Paste JSON</label>
          <textarea id="uploadText" class="input-field h-32 font-mono text-sm" placeholder='{"xCoordinates": [[1,2],[3,4]], "yCoordinates": [[5],[6]]}'></textarea>
        </div>
        
        <div class="mb-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
          <p class="text-xs font-medium mb-2">Accepted Formats:</p>
          <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Format A: {"xCoordinates": number[][], "yCoordinates": number[][]}</p>
          <p class="text-xs text-slate-500 dark:text-slate-400">Format B: {"samples": [{"x": number[], "y": number[]}, ...]}</p>
        </div>
        
        <div id="uploadPreview" class="hidden mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
          <p class="text-sm font-medium text-green-700 dark:text-green-400">Preview</p>
          <div id="uploadPreviewContent" class="text-sm mt-2"></div>
        </div>
        
        <div id="uploadError" class="hidden mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
          <p class="text-sm text-red-700 dark:text-red-400" id="uploadErrorText"></p>
        </div>
        
        <div class="flex gap-3">
          <button id="validateUpload" class="btn-secondary flex-1">Validate</button>
          <button id="applyUpload" class="btn-primary flex-1" disabled>Apply & Train</button>
        </div>
      </div>
    `);

          let parsedData = null;

          function validateData(text) {
            try {
              const data = JSON.parse(text);
              let xCoordinates, yCoordinates;

              if (data.xCoordinates && data.yCoordinates) {
                xCoordinates = data.xCoordinates;
                yCoordinates = data.yCoordinates;
              } else if (data.samples && Array.isArray(data.samples)) {
                xCoordinates = data.samples.map((s) => s.x);
                yCoordinates = data.samples.map((s) => s.y);
              } else {
                throw new Error(
                  "Invalid format. Expected xCoordinates/yCoordinates or samples array.",
                );
              }

              if (
                !Array.isArray(xCoordinates) ||
                !Array.isArray(yCoordinates)
              ) {
                throw new Error(
                  "xCoordinates and yCoordinates must be arrays.",
                );
              }
              if (xCoordinates.length !== yCoordinates.length) {
                throw new Error(
                  `Length mismatch: x has ${xCoordinates.length} samples, y has ${yCoordinates.length}.`,
                );
              }
              if (xCoordinates.length === 0) {
                throw new Error("Dataset is empty.");
              }

              const nFeatures = xCoordinates[0].length;
              const nTargets = yCoordinates[0].length;

              for (let i = 0; i < xCoordinates.length; i++) {
                if (xCoordinates[i].length !== nFeatures) {
                  throw new Error(
                    `Inconsistent feature count at sample ${i}: expected ${nFeatures}, got ${
                      xCoordinates[i].length
                    }.`,
                  );
                }
                if (yCoordinates[i].length !== nTargets) {
                  throw new Error(
                    `Inconsistent target count at sample ${i}: expected ${nTargets}, got ${
                      yCoordinates[i].length
                    }.`,
                  );
                }
                if (
                  xCoordinates[i].some((v) =>
                    typeof v !== "number" || isNaN(v)
                  )
                ) {
                  throw new Error(`Invalid value in x at sample ${i}.`);
                }
                if (
                  yCoordinates[i].some((v) =>
                    typeof v !== "number" || isNaN(v)
                  )
                ) {
                  throw new Error(`Invalid value in y at sample ${i}.`);
                }
              }

              return {
                xCoordinates,
                yCoordinates,
                nFeatures,
                nTargets,
                sampleCount: xCoordinates.length,
              };
            } catch (e) {
              throw new Error(e.message || "Invalid JSON");
            }
          }

          $("#uploadFile").onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (ev) => {
                $("#uploadText").value = ev.target.result;
              };
              reader.readAsText(file);
            }
          };

          $("#validateUpload").onclick = () => {
            const text = $("#uploadText").value.trim();
            if (!text) {
              $("#uploadError").classList.remove("hidden");
              $("#uploadErrorText").textContent =
                "Please enter or upload JSON data.";
              $("#uploadPreview").classList.add("hidden");
              $("#applyUpload").disabled = true;
              return;
            }

            try {
              parsedData = validateData(text);
              $("#uploadError").classList.add("hidden");
              $("#uploadPreview").classList.remove("hidden");
              $("#uploadPreviewContent").innerHTML = `
          <div class="flex justify-between"><span>Samples:</span><span class="font-medium">${parsedData.sampleCount}</span></div>
          <div class="flex justify-between"><span>Features:</span><span class="font-medium">${parsedData.nFeatures}</span></div>
          <div class="flex justify-between"><span>Targets:</span><span class="font-medium">${parsedData.nTargets}</span></div>
        `;
              $("#applyUpload").disabled = false;
            } catch (e) {
              $("#uploadPreview").classList.add("hidden");
              $("#uploadError").classList.remove("hidden");
              $("#uploadErrorText").textContent = e.message;
              $("#applyUpload").disabled = true;
              parsedData = null;
            }
          };

          $("#applyUpload").onclick = async () => {
            if (!parsedData) return;

            if (!state.hasModel) {
              await createModelWithPreset("balanced");
            }

            hideModal();
            state.trainingInProgress = true;
            state.currentTrainId = state.requestCounter + 1;
            $("#trainProgress").classList.remove("hidden");

            try {
              const result = await sendToWorker("fitOnline", {
                xCoordinates: parsedData.xCoordinates,
                yCoordinates: parsedData.yCoordinates,
                batchSize: 50,
              });

              state.lastFitResult = result.result;
              state.modelSummary = result.summary;
              state.datasetSize = result.datasetSize;
              addLog(
                "success",
                "Training Complete",
                `${parsedData.sampleCount} samples trained`,
              );
              showToast("success", "Dataset trained successfully");
              updateUI();
            } catch (err) {
              addLog("error", "Training Failed", err.message);
              showToast("error", err.message);
            }

            state.trainingInProgress = false;
            $("#trainProgress").classList.add("hidden");
          };
        }

        function showManualInsertModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Manual Insert</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="mb-4">
          <label class="text-sm font-medium mb-2 block">Sample JSON</label>
          <textarea id="manualText" class="input-field h-24 font-mono text-sm" placeholder='{"x": [1, 2, 3], "y": [4, 5]}'></textarea>
        </div>
        
        <div class="mb-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-xs">
          <p class="font-medium mb-1">Formats:</p>
          <p class="text-slate-500">Single: {"x": number[], "y": number[]}</p>
          <p class="text-slate-500">Batch: {"samples": [{"x": [...], "y": [...]}, ...]}</p>
        </div>
        
        <div id="manualError" class="hidden mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-400"></div>
        
        <button id="insertBtn" class="btn-primary w-full">Insert & Train</button>
      </div>
    `);

          $("#insertBtn").onclick = async () => {
            const text = $("#manualText").value.trim();
            if (!text) {
              $("#manualError").classList.remove("hidden");
              $("#manualError").textContent =
                "Please enter sample data.";
              return;
            }

            try {
              const data = JSON.parse(text);
              let xCoordinates, yCoordinates;

              if (data.x && data.y) {
                xCoordinates = [data.x];
                yCoordinates = [data.y];
              } else if (data.samples) {
                xCoordinates = data.samples.map((s) => s.x);
                yCoordinates = data.samples.map((s) => s.y);
              } else {
                throw new Error("Invalid format");
              }

              if (!state.hasModel) {
                await createModelWithPreset("balanced");
              }

              hideModal();
              showLoading("Training...");

              const result = await sendToWorker("fitOnline", {
                xCoordinates,
                yCoordinates,
              });
              state.lastFitResult = result.result;
              state.modelSummary = result.summary;
              state.datasetSize = result.datasetSize;
              addLog(
                "success",
                "Sample Inserted",
                `${xCoordinates.length} sample(s) trained`,
              );
              showToast("success", "Sample inserted");
              updateUI();
            } catch (e) {
              $("#manualError").classList.remove("hidden");
              $("#manualError").textContent = e.message;
              return;
            }
            hideLoading();
          };
        }

        function showSaveLoadModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Save / Load Model</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="grid gap-4 sm:grid-cols-2 mb-6">
          <div class="card p-4">
            <h3 class="font-medium mb-3">Save</h3>
            <div class="space-y-2">
              <button id="saveToFile" class="btn-secondary w-full text-sm" ${
            !state.hasModel ? "disabled" : ""
          }>Save to File</button>
              <button id="saveToStorage" class="btn-secondary w-full text-sm" ${
            !state.hasModel ? "disabled" : ""
          }>Save to Browser</button>
            </div>
          </div>
          <div class="card p-4">
            <h3 class="font-medium mb-3">Load</h3>
            <div class="space-y-2">
              <input type="file" id="loadFile" accept=".json" class="hidden">
              <button id="loadFromFile" class="btn-secondary w-full text-sm">Load from File</button>
              <button id="loadFromStorage" class="btn-secondary w-full text-sm" ${
            !localStorage.getItem("savedModel") ? "disabled" : ""
          }>Load from Browser</button>
            </div>
          </div>
        </div>
        
        <div id="loadPreview" class="hidden mb-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
          <p class="text-sm font-medium mb-2">Model Info</p>
          <div id="loadPreviewContent" class="text-sm"></div>
        </div>
        
        <button id="clearStorage" class="btn-secondary w-full text-sm text-red-500">Clear Browser Storage</button>
      </div>
    `);

          $("#saveToFile").onclick = async () => {
            try {
              const result = await sendToWorker("save", {});
              const wrapper = {
                modelState: result.modelState,
                meta: result.meta,
              };
              const blob = new Blob([JSON.stringify(wrapper)], {
                type: "application/json",
              });
              const link = document.createElement("a");
              link.download = `esn-model-${Date.now()}.json`;
              link.href = URL.createObjectURL(blob);
              link.click();
              addLog("info", "Model Saved", "Saved to file");
              showToast("success", "Model saved to file");
            } catch (e) {
              showToast("error", e.message);
            }
          };

          $("#saveToStorage").onclick = async () => {
            try {
              const result = await sendToWorker("save", {});
              const wrapper = {
                modelState: result.modelState,
                meta: result.meta,
              };
              localStorage.setItem(
                "savedModel",
                JSON.stringify(wrapper),
              );
              addLog("info", "Model Saved", "Saved to browser storage");
              showToast("success", "Model saved to browser");
              $("#loadFromStorage").disabled = false;
            } catch (e) {
              showToast("error", e.message);
            }
          };

          $("#loadFromFile").onclick = () => $("#loadFile").click();

          $("#loadFile").onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
              const text = await file.text();
              hideModal();
              showLoading("Loading model...");
              const result = await sendToWorker("load", { data: text });
              state.hasModel = true;
              state.modelSummary = result.summary;
              state.predictions = null;
              state.datasetSize = 0;
              addLog("success", "Model Loaded", "Loaded from file");
              showToast("success", "Model loaded");
              updateUI();
            } catch (err) {
              showToast("error", err.message);
            }
            hideLoading();
          };

          $("#loadFromStorage").onclick = async () => {
            const saved = localStorage.getItem("savedModel");
            if (!saved) {
              showToast("warning", "No saved model found");
              return;
            }

            hideModal();
            showLoading("Loading model...");
            try {
              const result = await sendToWorker("load", {
                data: saved,
              });
              state.hasModel = true;
              state.modelSummary = result.summary;
              state.predictions = null;
              state.datasetSize = 0;
              addLog(
                "success",
                "Model Loaded",
                "Loaded from browser storage",
              );
              showToast("success", "Model loaded");
              updateUI();
            } catch (err) {
              showToast("error", err.message);
            }
            hideLoading();
          };

          $("#clearStorage").onclick = () => {
            localStorage.removeItem("savedModel");
            showToast("success", "Browser storage cleared");
            $("#loadFromStorage").disabled = true;
          };
        }

        function showRandomTestModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Random Test Data</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <label class="text-sm font-medium">Seed</label>
            <input type="number" id="testSeed" class="input-field mt-1" value="42">
          </div>
          <div>
            <label class="text-sm font-medium">Samples</label>
            <input type="number" id="testSamples" class="input-field mt-1" value="200" min="10" max="1000">
          </div>
          <div>
            <label class="text-sm font-medium">Features</label>
            <input type="number" id="testFeatures" class="input-field mt-1" value="3" min="1" max="20">
          </div>
          <div>
            <label class="text-sm font-medium">Targets</label>
            <input type="number" id="testTargets" class="input-field mt-1" value="2" min="1" max="10">
          </div>
          <div>
            <label class="text-sm font-medium">Noise</label>
            <input type="number" id="testNoise" class="input-field mt-1" value="0.05" min="0" max="1" step="0.01">
          </div>
          <div>
            <label class="text-sm font-medium">Predict Steps</label>
            <input type="number" id="testSteps" class="input-field mt-1" value="20" min="1" max="100">
          </div>
        </div>
        
        <p class="text-xs text-slate-500 mb-4">Generates synthetic multivariate data with nonlinear relationships including sine/cosine patterns and coupling between dimensions.</p>
        
        <button id="runTestBtn" class="btn-primary w-full">Generate + Train + Predict</button>
      </div>
    `);

          $("#runTestBtn").onclick = async () => {
            const seed = parseInt($("#testSeed").value) || 42;
            const nSamples = parseInt($("#testSamples").value) || 200;
            const nFeatures = parseInt($("#testFeatures").value) || 3;
            const nTargets = parseInt($("#testTargets").value) || 2;
            const noise = parseFloat($("#testNoise").value) || 0.05;
            const steps = parseInt($("#testSteps").value) || 20;

            hideModal();
            showLoading("Generating and training...");

            try {
              await createModelWithPreset("balanced");

              function seededRandom(s) {
                return function () {
                  s = Math.sin(s) * 10000;
                  return s - Math.floor(s);
                };
              }
              const rng = seededRandom(seed);

              const xCoordinates = [];
              const yCoordinates = [];

              for (let i = 0; i < nSamples; i++) {
                const t = i / nSamples;
                const x = [];
                for (let f = 0; f < nFeatures; f++) {
                  x.push(
                    Math.sin(t * (f + 2) * Math.PI) + rng() * noise,
                  );
                }
                const y = [];
                for (let r = 0; r < nTargets; r++) {
                  let val = 0;
                  for (let f = 0; f < Math.min(nFeatures, 3); f++) {
                    val += x[f] * (0.3 + rng() * 0.2);
                  }
                  val += Math.sin(t * (r + 3) * Math.PI) * 0.3;
                  val += rng() * noise;
                  y.push(val);
                }
                xCoordinates.push(x);
                yCoordinates.push(y);
              }

              state.trainingInProgress = true;
              state.currentTrainId = state.requestCounter + 1;
              $("#trainProgress").classList.remove("hidden");

              const result = await sendToWorker("fitOnline", {
                xCoordinates,
                yCoordinates,
                batchSize: 20,
              });

              state.trainingInProgress = false;
              $("#trainProgress").classList.add("hidden");
              state.lastFitResult = result.result;
              state.modelSummary = result.summary;
              state.datasetSize = result.datasetSize;

              state.futureSteps = steps;
              $("#stepsInput").value = steps;
              $("#stepsSlider").value = Math.min(100, steps);

              const pred = await sendToWorker("predict", {
                futureSteps: steps,
              });
              state.predictions = pred.result;

              addLog(
                "success",
                "Test Complete",
                `${nSamples} samples, ${nFeatures} features, ${nTargets} targets`,
              );
              setView("focus");
              updateUI();
              showToast("success", "Test completed!");
            } catch (err) {
              state.trainingInProgress = false;
              $("#trainProgress").classList.add("hidden");
              addLog("error", "Test Failed", err.message);
              showToast("error", err.message);
            }
            hideLoading();
          };
        }

        function showPredictModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Forecast Settings</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="mb-6">
          <label class="text-sm font-medium mb-2 block">Future Steps</label>
          <input type="number" id="modalSteps" class="input-field" value="${state.futureSteps}" min="1" max="1000">
          <p class="text-xs text-slate-500 mt-1">Number of time steps to predict into the future.</p>
        </div>
        
        <button id="modalPredictBtn" class="btn-primary w-full" ${
            !state.hasModel ? "disabled" : ""
          }>Run Prediction</button>
      </div>
    `);

          $("#modalPredictBtn").onclick = async () => {
            state.futureSteps = parseInt($("#modalSteps").value) || 10;
            $("#stepsInput").value = state.futureSteps;
            $("#stepsSlider").value = Math.min(100, state.futureSteps);
            hideModal();
            await runPrediction();
          };
        }

        function showAdvancedModal() {
          showModal(`
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Advanced Settings</h2>
          <button onclick="hideModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        
        <div class="mb-6">
          <label class="text-sm font-medium mb-2 block">Module URL</label>
          <input type="text" id="moduleUrl" class="input-field font-mono text-sm" value="${state.moduleUrl}">
          <p class="text-xs text-slate-500 mt-1">ESNRegression module URL. Change only if needed.</p>
        </div>
        
        <div class="flex items-center justify-between mb-6 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
          <span class="text-sm font-medium">Performance Mode</span>
          <button id="perfToggle" class="w-12 h-6 rounded-full transition-colors ${
            state.performanceMode
              ? "bg-brand-500"
              : "bg-slate-300 dark:bg-slate-600"
          }">
            <span class="block w-5 h-5 bg-white rounded-full shadow transform transition-transform ${
            state.performanceMode ? "translate-x-6" : "translate-x-0.5"
          }"></span>
          </button>
        </div>
        
        <button id="updateModuleBtn" class="btn-primary w-full mb-3">Update Module URL</button>
        <button id="resetEverything" class="btn-secondary w-full text-red-500">Reset Everything</button>
      </div>
    `);

          $("#perfToggle").onclick = () => {
            state.performanceMode = !state.performanceMode;
            localStorage.setItem(
              "performanceMode",
              state.performanceMode,
            );
            $("#perfToggle").className =
              `w-12 h-6 rounded-full transition-colors ${
                state.performanceMode
                  ? "bg-brand-500"
                  : "bg-slate-300 dark:bg-slate-600"
              }`;
            $("#perfToggle").querySelector("span").className =
              `block w-5 h-5 bg-white rounded-full shadow transform transition-transform ${
                state.performanceMode
                  ? "translate-x-6"
                  : "translate-x-0.5"
              }`;
          };

          $("#updateModuleBtn").onclick = async () => {
            const url = $("#moduleUrl").value.trim();
            if (!url) return;

            hideModal();
            showLoading("Updating module...");
            try {
              await sendToWorker("setModuleUrl", { url });
              state.moduleUrl = url;
              localStorage.setItem("moduleUrl", url);
              addLog("success", "Module Updated", "New module URL set");
              showToast("success", "Module URL updated");
            } catch (err) {
              addLog("error", "Module Update Failed", err.message);
              showToast("error", err.message);
            }
            hideLoading();
          };

          $("#resetEverything").onclick = async () => {
            hideModal();
            await clearAll();
          };
        }

        // Make functions global for inline handlers
        window.hideModal = hideModal;

        // Initialize
        setupEventListeners();
        initWorker();
        updateUI();

        addLog(
          "info",
          "App Started",
          "ESN Regression Studio initialized",
        );
      })();
    </script>
  </body>
</html>
