<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-in-right": "slideInRight 0.3s ease-out",
              "slide-in-bottom": "slideInBottom 0.3s ease-out",
              "pulse-subtle": "pulseSubtle 2s ease-in-out infinite",
              "skeleton": "skeleton 1.5s ease-in-out infinite",
              "spin-slow": "spin 3s linear infinite",
              "bounce-gentle": "bounceGentle 2s ease-in-out infinite",
              "float": "float 6s ease-in-out infinite",
              "glow": "glow 2s ease-in-out infinite alternate",
            },
          },
        },
      };
    </script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }
      @keyframes slideInBottom {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }
      @keyframes pulseSubtle {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      @keyframes skeleton {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }
      @keyframes bounceGentle {
        0%, 100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }
      @keyframes float {
        0%, 100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(5deg);
        }
      }
      @keyframes glow {
        from {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        to {
          box-shadow: 0 0 40px rgba(139, 92, 246, 0.5);
        }
      }
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      .glass {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.85);
      }
      .glass-strong {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }
      .dark .glass-strong {
        background: rgba(15, 23, 42, 0.95);
      }

      .touch-target {
        min-width: 44px;
        min-height: 44px;
      }
      .gradient-text {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .gradient-border {
        background: linear-gradient(135deg, #3b82f6, #6366f1, #8b5cf6)
          border-box;
        border: 2px solid transparent;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 3px;
      }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
      }

      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #cbd5e1;
        transition: 0.3s;
        border-radius: 26px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      input:checked + .toggle-slider {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
      }
      input:checked + .toggle-slider:before {
        transform: translateX(22px);
      }
      .dark .toggle-slider {
        background-color: #475569;
      }

      .blob {
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      }
      .chart-tooltip {
        pointer-events: none;
        z-index: 100;
      }

      .shimmer {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
      }
      .dark .shimmer {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        background-size: 1000px 100%;
      }

      .perspective-card {
        transform-style: preserve-3d;
        perspective: 1000px;
      }
      .perspective-card:hover {
        transform: rotateY(5deg) rotateX(5deg);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen transition-colors duration-300 overflow-x-hidden"
  >
    <!-- ========== HEADER ========== -->
    <header
      id="header"
      class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200/50 dark:border-slate-700/50 transition-all duration-300"
    >
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
        <div class="flex items-center justify-between h-16 sm:h-18">
          <!-- Logo & Title -->
          <div class="flex items-center gap-3">
            <div class="relative">
              <div
                class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30 animate-glow"
              >
                <span class="text-xl sm:text-2xl">ğŸ“Š</span>
              </div>
              <div
                class="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full border-2 border-white dark:border-slate-800 animate-pulse"
                id="headerDot"
              >
              </div>
            </div>
            <div class="hidden xs:block">
              <h1
                class="text-lg sm:text-xl font-bold text-slate-800 dark:text-white"
              >
                ESN Studio
              </h1>
              <p class="text-xs text-slate-500 dark:text-slate-400 -mt-0.5">
                Autoregressive Forecasting
              </p>
            </div>
          </div>

          <!-- Status Badge -->
          <div
            id="statusBadge"
            class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600"
          >
            <span
              class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
              id="statusDot"
            ></span>
            <span
              class="text-xs font-medium text-slate-600 dark:text-slate-300"
              id="statusText"
            >No Model</span>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-2">
            <button
              id="predictBtn"
              class="hidden touch-target items-center justify-center gap-1.5 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-semibold rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-105 active:scale-95 transition-all duration-200"
              aria-label="Run Prediction"
            >
              <span>âš¡</span>
              <span class="hidden sm:inline">Predict</span>
            </button>
            <button
              id="configBtn"
              class="touch-target flex items-center justify-center w-10 h-10 sm:w-11 sm:h-11 rounded-xl bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 hover:scale-105 active:scale-95 transition-all duration-200 border border-slate-200/50 dark:border-slate-600/50"
              aria-label="Configure Model"
            >
              <span class="text-lg">âš™ï¸</span>
            </button>
            <button
              id="menuBtn"
              class="touch-target flex items-center justify-center w-10 h-10 sm:w-11 sm:h-11 rounded-xl bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 hover:scale-105 active:scale-95 transition-all duration-200 border border-slate-200/50 dark:border-slate-600/50"
              aria-label="Open Menu"
            >
              <span class="text-lg">â˜°</span>
            </button>
            <button
              id="themeToggle"
              class="touch-target flex items-center justify-center w-10 h-10 sm:w-11 sm:h-11 rounded-xl bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 hover:scale-105 active:scale-95 transition-all duration-200 border border-slate-200/50 dark:border-slate-600/50"
              aria-label="Toggle Theme"
            >
              <span class="text-lg" id="themeIcon">ğŸŒ™</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ========== MAIN CONTENT ========== -->
    <main
      class="pt-20 sm:pt-24 pb-24 lg:pb-8 lg:pr-80 xl:pr-96 transition-all duration-300"
    >
      <div class="max-w-6xl mx-auto px-3 sm:px-4 lg:px-6">
        <!-- Visualization Tabs -->
        <div
          class="mb-4 overflow-x-auto custom-scrollbar pb-2 -mx-3 px-3 sm:mx-0 sm:px-0"
        >
          <div class="flex gap-2 min-w-max" id="vizTabs">
            <button
              data-mode="grid"
              class="viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/30"
            >
              <span>ğŸ“Š</span><span>Grid</span>
            </button>
            <button
              data-mode="focus"
              class="viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              <span>ğŸ”</span><span>Focus</span>
            </button>
            <button
              data-mode="heatmap"
              class="viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              <span>ğŸŒ¡ï¸</span><span>Heatmap</span>
            </button>
            <button
              data-mode="ci"
              class="viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              <span>ğŸ“ˆ</span><span>CI</span>
            </button>
            <button
              data-mode="snapshot"
              class="viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600"
            >
              <span>ğŸ“·</span><span>Snapshot</span>
            </button>
          </div>
        </div>

        <!-- Dimension Selector (Focus Mode) -->
        <div
          id="dimSelector"
          class="hidden mb-4 overflow-x-auto custom-scrollbar pb-2 -mx-3 px-3 sm:mx-0 sm:px-0"
        >
          <div class="flex gap-2 min-w-max" id="dimButtons"></div>
        </div>

        <!-- Step Selector (Snapshot Mode) -->
        <div id="stepSelector" class="hidden mb-4 flex items-center gap-3">
          <label class="text-sm font-medium text-slate-600 dark:text-slate-300"
          >Step:</label>
          <input
            type="number"
            id="stepInput"
            min="1"
            value="1"
            class="w-24 px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-800 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
          >
          <span
            class="text-xs text-slate-500 dark:text-slate-400"
            id="stepTotal"
          >/ 0</span>
        </div>

        <!-- Chart Container -->
        <div
          class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden transition-all duration-300"
          style="min-height: 400px"
        >
          <!-- Chart Canvas -->
          <canvas
            id="chartCanvas"
            class="w-full h-full"
            style="min-height: 400px"
          ></canvas>

          <!-- Empty State -->
          <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center"
          >
            <!-- Decorative Elements -->
            <div class="relative mb-8">
              <div
                class="absolute -inset-8 bg-gradient-to-r from-blue-500/20 via-purple-500/20 to-pink-500/20 rounded-full blur-2xl animate-pulse"
              >
              </div>
              <div class="relative">
                <div
                  class="w-24 h-24 sm:w-32 sm:h-32 bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-3xl rotate-6 animate-float"
                >
                </div>
                <div
                  class="absolute inset-0 w-24 h-24 sm:w-32 sm:h-32 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-3xl -rotate-6 animate-float"
                  style="animation-delay: 0.5s"
                >
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span
                    class="text-5xl sm:text-6xl drop-shadow-lg animate-bounce-gentle"
                  >ğŸ“Š</span>
                </div>
              </div>
            </div>
            <h2
              class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-white mb-2"
            >
              Create a Model to Begin
            </h2>
            <p
              class="text-sm sm:text-base text-slate-500 dark:text-slate-400 max-w-md mb-6"
            >
              Build powerful Echo State Networks for multivariate time series
              forecasting with uncertainty estimation
            </p>
            <div class="flex flex-col sm:flex-row items-center gap-3">
              <button
                id="startDefaultBtn"
                class="touch-target flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-105 active:scale-95 transition-all duration-200"
              >
                <span>âš¡</span>
                <span>Start with Defaults</span>
              </button>
              <div class="flex gap-2">
                <button
                  id="loadDemoBtn"
                  class="touch-target flex items-center gap-2 px-4 py-2.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-medium rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-all duration-200 border border-slate-200 dark:border-slate-600"
                >
                  <span>ğŸ“¤</span><span>Load</span>
                </button>
                <button
                  id="runDemoBtn"
                  class="touch-target flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-xl shadow-lg shadow-purple-500/30 hover:shadow-xl hover:scale-105 active:scale-95 transition-all duration-200"
                >
                  <span>âœ¨</span><span>Demo</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Zoom Controls -->
          <div
            id="chartControls"
            class="hidden absolute top-3 right-3 flex flex-col gap-1.5 animate-fade-in"
          >
            <button
              id="zoomInBtn"
              class="touch-target w-10 h-10 flex items-center justify-center bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 transition-all border border-slate-200/50 dark:border-slate-600/50 hover:scale-105 active:scale-95"
            >
              <span>â•</span>
            </button>
            <button
              id="zoomOutBtn"
              class="touch-target w-10 h-10 flex items-center justify-center bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 transition-all border border-slate-200/50 dark:border-slate-600/50 hover:scale-105 active:scale-95"
            >
              <span>â–</span>
            </button>
            <button
              id="zoomResetBtn"
              class="touch-target w-10 h-10 flex items-center justify-center bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 transition-all border border-slate-200/50 dark:border-slate-600/50 hover:scale-105 active:scale-95"
            >
              <span>ğŸ”„</span>
            </button>
          </div>

          <!-- Zoom Badge -->
          <div
            id="zoomBadge"
            class="hidden absolute top-3 left-3 px-2.5 py-1 bg-slate-800/80 dark:bg-slate-200/90 text-white dark:text-slate-800 text-xs font-bold rounded-lg animate-fade-in"
          >
            100%
          </div>

          <!-- Export Buttons -->
          <div
            id="exportControls"
            class="hidden absolute bottom-3 right-3 flex gap-1.5 animate-fade-in"
          >
            <button
              id="exportPngBtn"
              class="touch-target flex items-center gap-1 px-3 py-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 text-xs font-medium text-slate-700 dark:text-slate-200 transition-all border border-slate-200/50 dark:border-slate-600/50"
            >
              <span>ğŸ–¼ï¸</span><span class="hidden sm:inline">PNG</span>
            </button>
            <button
              id="exportSvgBtn"
              class="touch-target flex items-center gap-1 px-3 py-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 text-xs font-medium text-slate-700 dark:text-slate-200 transition-all border border-slate-200/50 dark:border-slate-600/50"
            >
              <span>ğŸ“„</span><span class="hidden sm:inline">SVG</span>
            </button>
            <button
              id="copyChartBtn"
              class="touch-target flex items-center gap-1 px-3 py-2 bg-white/90 dark:bg-slate-700/90 rounded-lg shadow-md hover:bg-white dark:hover:bg-slate-600 text-xs font-medium text-slate-700 dark:text-slate-200 transition-all border border-slate-200/50 dark:border-slate-600/50"
            >
              <span>ğŸ“‹</span><span class="hidden sm:inline">Copy</span>
            </button>
          </div>

          <!-- Chart Tooltip -->
          <div
            id="chartTooltip"
            class="chart-tooltip hidden absolute bg-slate-900/95 dark:bg-slate-100/95 text-white dark:text-slate-800 px-4 py-3 rounded-xl shadow-2xl text-sm max-w-xs animate-fade-in backdrop-blur-sm"
          >
            <div
              class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-700 dark:border-slate-300"
            >
              <span class="text-lg">ğŸ“</span>
              <span class="font-bold" id="tooltipStep">Step 1</span>
            </div>
            <div class="space-y-1.5" id="tooltipContent"></div>
          </div>

          <!-- Loading Overlay -->
          <div
            id="loadingOverlay"
            class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center z-30 animate-fade-in"
          >
            <div class="relative mb-4">
              <div
                class="w-16 h-16 border-4 border-blue-200 dark:border-blue-800 rounded-full"
              >
              </div>
              <div
                class="absolute inset-0 w-16 h-16 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"
              >
              </div>
            </div>
            <p
              class="text-sm font-medium text-slate-600 dark:text-slate-300 mb-3"
              id="loadingText"
            >
              Processing...
            </p>
            <div
              class="w-48 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"
            >
              <div
                id="loadingProgress"
                class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300 rounded-full"
                style="width: 0%"
              >
              </div>
            </div>
            <span
              class="text-xs text-slate-500 dark:text-slate-400"
              id="loadingPercent"
            >0%</span>
            <button
              id="cancelLoadingBtn"
              class="mt-4 px-4 py-2 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>

        <!-- Statistics Bar (Focus Mode) -->
        <div
          id="statsBar"
          class="hidden mt-4 grid grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3 animate-slide-up"
        >
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Min
            </p>
            <p
              class="text-lg font-bold text-slate-800 dark:text-white"
              id="statMin"
            >
              -
            </p>
          </div>
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Max
            </p>
            <p
              class="text-lg font-bold text-slate-800 dark:text-white"
              id="statMax"
            >
              -
            </p>
          </div>
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Mean
            </p>
            <p
              class="text-lg font-bold text-slate-800 dark:text-white"
              id="statMean"
            >
              -
            </p>
          </div>
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Final
            </p>
            <p
              class="text-lg font-bold text-slate-800 dark:text-white"
              id="statFinal"
            >
              -
            </p>
          </div>
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Trend
            </p>
            <p class="text-lg font-bold" id="statTrend">-</p>
          </div>
          <div
            class="glass rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <p
              class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold mb-1"
            >
              Confidence
            </p>
            <p
              class="text-lg font-bold text-emerald-600 dark:text-emerald-400"
              id="statConfidence"
            >
              -
            </p>
          </div>
        </div>
      </div>
    </main>

    <!-- ========== SIDE PANEL ========== -->
    <aside
      id="sidePanel"
      class="fixed top-0 right-0 bottom-0 w-80 xl:w-96 bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl border-l border-slate-200/50 dark:border-slate-700/50 transform lg:translate-x-0 translate-x-full transition-transform duration-300 z-40 flex flex-col overflow-hidden"
    >
      <!-- Panel Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-slate-200/50 dark:border-slate-700/50 lg:mt-16"
      >
        <h2 class="text-lg font-bold text-slate-800 dark:text-white">
          Control Panel
        </h2>
        <button
          id="closePanelBtn"
          class="lg:hidden touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors"
        >
          <span class="text-xl">âœ–ï¸</span>
        </button>
      </div>

      <!-- Panel Content -->
      <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
        <!-- Model Metrics -->
        <section class="animate-slide-up">
          <h3
            class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>ğŸ“ˆ</span> Model Metrics
          </h3>
          <div class="space-y-2">
            <div
              class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl"
            >
              <span class="text-sm text-slate-600 dark:text-slate-300"
              >Samples Trained</span>
              <span
                class="text-sm font-bold text-blue-600 dark:text-blue-400"
                id="metricSamples"
              >0</span>
            </div>
            <div
              class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl"
            >
              <span class="text-sm text-slate-600 dark:text-slate-300"
              >Avg Loss</span>
              <span
                class="text-sm font-mono text-slate-800 dark:text-slate-200"
                id="metricLoss"
              >-</span>
            </div>
            <div
              class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl"
            >
              <span class="text-sm text-slate-600 dark:text-slate-300"
              >Gradient Norm</span>
              <span
                class="text-sm font-mono text-slate-800 dark:text-slate-200"
                id="metricGradient"
              >-</span>
            </div>
            <div
              class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl"
            >
              <span class="text-sm text-slate-600 dark:text-slate-300"
              >Sample Weight</span>
              <span
                class="text-sm font-mono text-slate-800 dark:text-slate-200"
                id="metricWeight"
              >-</span>
            </div>
          </div>
        </section>

        <!-- Prediction -->
        <section class="animate-slide-up" style="animation-delay: 0.1s">
          <h3
            class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>ğŸ”®</span> Prediction
          </h3>
          <div class="space-y-3">
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block"
              >Future Steps</label>
              <input
                type="number"
                id="futureStepsInput"
                value="50"
                min="1"
                class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              >
            </div>
            <button
              id="runPredictBtn"
              disabled
              class="w-full touch-target py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:shadow-none flex items-center justify-center gap-2"
            >
              <span>âš¡</span>
              <span>Run Prediction</span>
            </button>
          </div>
        </section>

        <!-- Event Log -->
        <section class="animate-slide-up" style="animation-delay: 0.2s">
          <div class="flex items-center justify-between mb-3">
            <h3
              class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold flex items-center gap-2"
            >
              <span>ğŸ“‹</span> Event Log
            </h3>
            <select
              id="logFilter"
              class="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300"
            >
              <option value="all">All</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>
          <input
            type="text"
            id="logSearch"
            placeholder="Search logs..."
            class="w-full px-3 py-2 mb-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm text-slate-800 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
          >
          <div
            id="logContainer"
            class="h-48 overflow-y-auto custom-scrollbar space-y-1.5 bg-slate-50 dark:bg-slate-700/50 rounded-xl p-2"
          >
          </div>
        </section>
      </div>
    </aside>

    <!-- Side Panel Overlay (Mobile) -->
    <div
      id="panelOverlay"
      class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden"
      aria-hidden="true"
    >
    </div>

    <!-- ========== MAIN MENU (Slide-out) ========== -->
    <div
      id="mainMenu"
      class="fixed top-0 right-0 bottom-0 w-[85%] max-w-sm bg-white dark:bg-slate-800 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col overflow-hidden"
    >
      <!-- Menu Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-500/10 to-purple-500/10 dark:from-blue-500/5 dark:to-purple-500/5"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center"
          >
            <span class="text-lg">ğŸ“Š</span>
          </div>
          <div>
            <h2 class="font-bold text-slate-800 dark:text-white">ESN Studio</h2>
            <p class="text-xs text-slate-500 dark:text-slate-400">Menu</p>
          </div>
        </div>
        <button
          id="closeMenuBtn"
          class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors"
        >
          <span class="text-xl">âœ–ï¸</span>
        </button>
      </div>

      <!-- Menu Content -->
      <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
        <!-- Model Section -->
        <section>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>ğŸ“</span> Model
          </h3>
          <div class="space-y-2">
            <button
              id="menuConfigBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ›ï¸</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Create & Configure
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Set up model parameters
                </p>
              </div>
            </button>
            <button
              id="menuSaveLoadBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ’¾</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Save & Load
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Persist your models
                </p>
              </div>
            </button>
          </div>
        </section>

        <!-- Data Section -->
        <section>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>ğŸ“‚</span> Data
          </h3>
          <div class="space-y-2">
            <button
              id="menuUploadBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ“¤</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Upload Dataset
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Import time series data
                </p>
              </div>
            </button>
            <button
              id="menuInsertBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">â•</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Manual Insert
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Add individual time steps
                </p>
              </div>
            </button>
          </div>
        </section>

        <!-- Test Section -->
        <section>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>ğŸ§ª</span> Test
          </h3>
          <div class="space-y-2">
            <button
              id="menuRandomBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-pink-100 dark:bg-pink-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ’¡</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Random Test
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Generate synthetic time series
                </p>
              </div>
            </button>
          </div>
        </section>

        <!-- Advanced Section -->
        <section>
          <h3
            class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-3 flex items-center gap-2"
          >
            <span>âš™ï¸</span> Advanced
          </h3>
          <div class="space-y-2">
            <button
              id="menuSettingsBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ”§</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Settings
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Module URL & preferences
                </p>
              </div>
            </button>
            <button
              id="menuTableBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">ğŸ“‹</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  View Data Table
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Raw prediction values
                </p>
              </div>
            </button>
            <button
              id="menuHelpBtn"
              class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group"
            >
              <div
                class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="text-lg">â“</span>
              </div>
              <div class="text-left">
                <p class="font-semibold text-slate-800 dark:text-white text-sm">
                  Help & Docs
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Library documentation
                </p>
              </div>
            </button>
          </div>
        </section>
      </div>
    </div>
    <div
      id="menuOverlay"
      class="fixed inset-0 bg-black/50 z-40 hidden"
      aria-hidden="true"
    >
    </div>

    <!-- ========== MOBILE BOTTOM BAR ========== -->
    <div
      class="fixed bottom-0 left-0 right-0 lg:hidden glass border-t border-slate-200/50 dark:border-slate-700/50 z-30"
    >
      <div class="flex items-center justify-around p-2">
        <button
          id="mobileConfigBtn"
          class="touch-target flex flex-col items-center justify-center p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          <span class="text-xl">âš™ï¸</span>
          <span class="text-[10px] text-slate-500 dark:text-slate-400 mt-0.5"
          >Config</span>
        </button>
        <button
          id="mobilePredictBtn"
          class="touch-target flex flex-col items-center justify-center p-2 px-6 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
          aria-label="Predict"
        >
          <span class="text-xl">âš¡</span>
          <span class="text-[10px] mt-0.5">Predict</span>
        </button>
        <button
          id="mobilePanelBtn"
          class="touch-target flex flex-col items-center justify-center p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
        >
          <span class="text-xl">ğŸ“Š</span>
          <span class="text-[10px] text-slate-500 dark:text-slate-400 mt-0.5"
          >Panel</span>
        </button>
      </div>
    </div>

    <!-- ========== CONFIGURATION MODAL ========== -->
    <div
      id="configModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="configModalTitle"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="configModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 overflow-y-auto custom-scrollbar">
        <div
          class="min-h-full flex items-start justify-center p-0 md:p-4 lg:p-8"
        >
          <div
            class="relative w-full max-w-3xl bg-white dark:bg-slate-800 md:rounded-2xl shadow-2xl animate-slide-up md:my-8"
          >
            <!-- Modal Header -->
            <div
              class="sticky top-0 z-10 flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 md:rounded-t-2xl"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center"
                >
                  <span class="text-lg">ğŸ›ï¸</span>
                </div>
                <div>
                  <h2
                    id="configModalTitle"
                    class="text-lg font-bold text-slate-800 dark:text-white"
                  >
                    Model Configuration
                  </h2>
                  <p class="text-xs text-slate-500 dark:text-slate-400">
                    Configure your ESN parameters
                  </p>
                </div>
              </div>
              <button
                id="closeConfigBtn"
                class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors"
              >
                <span class="text-xl">âœ–ï¸</span>
              </button>
            </div>

            <!-- Presets -->
            <div
              class="p-4 md:px-6 border-b border-slate-200 dark:border-slate-700 overflow-x-auto custom-scrollbar"
            >
              <div class="flex gap-2 min-w-max" id="presetButtons">
                <button
                  data-preset="default"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md transition-all hover:scale-105"
                >
                  Start Here
                </button>
                <button
                  data-preset="fast"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all"
                >
                  Fast
                </button>
                <button
                  data-preset="balanced"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all"
                >
                  Balanced
                </button>
                <button
                  data-preset="accurate"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all"
                >
                  Accurate
                </button>
                <button
                  data-preset="adaptive"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all"
                >
                  Adaptive
                </button>
                <button
                  data-preset="robust"
                  class="preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all"
                >
                  Robust
                </button>
              </div>
            </div>

            <!-- Configuration Sections -->
            <div class="p-4 md:p-6 space-y-4" id="configSections">
              <!-- Reservoir Architecture -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="reservoir"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ§ </span> Reservoir Architecture
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform"
                  >â–¼</span>
                </button>
                <div
                  class="section-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >reservoirSize <span class="text-xs text-slate-400"
                      >(Neurons)</span></label>
                    <input
                      type="number"
                      id="cfg_reservoirSize"
                      value="256"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >spectralRadius <span class="text-xs text-slate-400"
                      >(Memory)</span></label>
                    <input
                      type="number"
                      id="cfg_spectralRadius"
                      value="0.9"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >leakRate <span class="text-xs text-slate-400"
                      >(Smoothing)</span></label>
                    <input
                      type="number"
                      id="cfg_leakRate"
                      value="0.3"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >inputScale</label>
                    <input
                      type="number"
                      id="cfg_inputScale"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >biasScale</label>
                    <input
                      type="number"
                      id="cfg_biasScale"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >reservoirSparsity</label>
                    <input
                      type="number"
                      id="cfg_reservoirSparsity"
                      value="0.9"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >inputSparsity</label>
                    <input
                      type="number"
                      id="cfg_inputSparsity"
                      value="0.0"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >activation</label>
                    <select
                      id="cfg_activation"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="tanh">tanh</option>
                      <option value="relu">relu</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Readout Configuration -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="readout"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ“–</span> Readout Configuration
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform"
                  >â–¼</span>
                </button>
                <div
                  class="section-content p-4 space-y-4 bg-white dark:bg-slate-800"
                >
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium text-slate-700 dark:text-slate-300">
                        useInputInReadout
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Append input to state
                      </p>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="cfg_useInputInReadout" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="font-medium text-slate-700 dark:text-slate-300">
                        useBiasInReadout
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Include bias term
                      </p>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="cfg_useBiasInReadout" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Training (RLS) -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="training"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ“</span> Training (RLS)
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform rotate-180"
                  >â–¼</span>
                </button>
                <div
                  class="section-content hidden p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >readoutTraining</label>
                    <input
                      type="text"
                      value="rls"
                      disabled
                      class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-600 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-500 dark:text-slate-400"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >rlsLambda <span class="text-xs text-slate-400"
                      >(Forgetting)</span></label>
                    <input
                      type="number"
                      id="cfg_rlsLambda"
                      value="0.999"
                      step="0.001"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >rlsDelta</label>
                    <input
                      type="number"
                      id="cfg_rlsDelta"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >epsilon</label>
                    <input
                      type="number"
                      id="cfg_epsilon"
                      value="1e-8"
                      step="any"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >l2Lambda <span class="text-xs text-slate-400"
                      >(L2 reg)</span></label>
                    <input
                      type="number"
                      id="cfg_l2Lambda"
                      value="0.0001"
                      step="any"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >gradientClipNorm</label>
                    <input
                      type="number"
                      id="cfg_gradientClipNorm"
                      value="1.0"
                      step="0.1"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                </div>
              </div>

              <!-- Normalization -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="normalization"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ“</span> Normalization
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform rotate-180"
                  >â–¼</span>
                </button>
                <div
                  class="section-content hidden p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >normalizationEpsilon</label>
                    <input
                      type="number"
                      id="cfg_normalizationEpsilon"
                      value="1e-8"
                      step="any"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >normalizationWarmup</label>
                    <input
                      type="number"
                      id="cfg_normalizationWarmup"
                      value="10"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                </div>
              </div>

              <!-- Outlier Handling -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="outlier"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ¯</span> Outlier Handling
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform rotate-180"
                  >â–¼</span>
                </button>
                <div
                  class="section-content hidden p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >outlierThreshold <span class="text-xs text-slate-400"
                      >(Z-score)</span></label>
                    <input
                      type="number"
                      id="cfg_outlierThreshold"
                      value="3.0"
                      step="0.1"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >outlierMinWeight</label>
                    <input
                      type="number"
                      id="cfg_outlierMinWeight"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                </div>
              </div>

              <!-- Uncertainty -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="uncertainty"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ“Š</span> Uncertainty
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform rotate-180"
                  >â–¼</span>
                </button>
                <div
                  class="section-content hidden p-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >uncertaintyMultiplier <span class="text-xs text-slate-400"
                      >(1.96 = 95% CI)</span></label>
                    <input
                      type="number"
                      id="cfg_uncertaintyMultiplier"
                      value="1.96"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                </div>
              </div>

              <!-- Initialization -->
              <div
                class="config-section border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden"
              >
                <button
                  class="section-toggle w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
                  data-section="init"
                >
                  <span
                    class="font-semibold text-slate-800 dark:text-white flex items-center gap-2"
                  >
                    <span>ğŸ²</span> Initialization
                  </span>
                  <span
                    class="section-chevron text-slate-400 transition-transform rotate-180"
                  >â–¼</span>
                </button>
                <div
                  class="section-content hidden p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white dark:bg-slate-800"
                >
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >weightInitScale</label>
                    <input
                      type="number"
                      id="cfg_weightInitScale"
                      value="0.1"
                      step="0.01"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div>
                    <label
                      class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
                    >seed</label>
                    <input
                      type="number"
                      id="cfg_seed"
                      value="42"
                      class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                    >
                  </div>
                  <div class="md:col-span-2 flex items-center justify-between">
                    <div>
                      <p class="font-medium text-slate-700 dark:text-slate-300">
                        verbose
                      </p>
                      <p class="text-xs text-slate-500 dark:text-slate-400">
                        Detailed logging
                      </p>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="cfg_verbose">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal Footer -->
            <div
              class="sticky bottom-0 flex flex-wrap items-center justify-between gap-3 p-4 md:p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 md:rounded-b-2xl"
            >
              <div class="flex gap-2">
                <button
                  id="resetDefaultsBtn"
                  class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                  Reset Defaults
                </button>
                <button
                  id="resetAllBtn"
                  class="px-4 py-2 text-sm font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors"
                >
                  Reset All
                </button>
              </div>
              <div class="flex gap-2">
                <button
                  id="cancelConfigBtn"
                  class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  id="createModelBtn"
                  class="px-6 py-2 text-sm font-semibold text-white bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg shadow-lg shadow-blue-500/30 hover:shadow-xl hover:scale-105 active:scale-95 transition-all"
                >
                  Create Model
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== UPLOAD MODAL ========== -->
    <div
      id="uploadModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="uploadModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>ğŸ“¤</span> Upload Dataset
            </h2>
            <button
              id="closeUploadBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-4 space-y-4">
            <div
              id="dropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors"
            >
              <span class="text-4xl mb-3 block">ğŸ“</span>
              <p class="text-sm text-slate-600 dark:text-slate-300">
                Drop JSON file here or tap to browse
              </p>
              <input type="file" id="fileInput" accept=".json" class="hidden">
            </div>
            <div class="text-center text-xs text-slate-400">
              or paste JSON directly
            </div>
            <textarea
              id="jsonInput"
              rows="4"
              placeholder='{"coordinates": [[1,2,3], [1.1,2.1,3.1], ...]}'
              class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm text-slate-800 dark:text-white font-mono resize-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
            <details class="text-sm">
              <summary
                class="cursor-pointer text-blue-600 dark:text-blue-400 font-medium"
              >
                View format example
              </summary>
              <div
                class="mt-2 p-3 bg-slate-100 dark:bg-slate-700 rounded-lg font-mono text-xs overflow-x-auto"
              >
                <pre>
{"coordinates": [
  [1.0, 2.0, 3.0],
  [1.1, 2.1, 3.1],
  [1.2, 2.2, 3.2]
]}</pre>
              </div>
              <button
                id="copyExampleBtn"
                class="mt-2 px-3 py-1 text-xs bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
              >
                ğŸ“‹ Copy example
              </button>
            </details>
            <div
              id="uploadPreview"
              class="hidden p-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-xl text-sm text-emerald-700 dark:text-emerald-300"
            >
              <p>
                <strong>âœ… Valid:</strong> <span id="previewDims">3</span>
                dimensions, <span id="previewSteps">100</span> time steps
              </p>
            </div>
            <div
              id="uploadError"
              class="hidden p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-sm text-red-700 dark:text-red-300"
            >
            </div>
          </div>
          <div
            class="flex justify-end gap-2 p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 rounded-b-2xl"
          >
            <button
              id="cancelUploadBtn"
              class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
            >
              Cancel
            </button>
            <button
              id="validateUploadBtn"
              class="px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors"
            >
              Validate
            </button>
            <button
              id="applyUploadBtn"
              disabled
              class="px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transition-all"
            >
              Apply & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== RANDOM TEST MODAL ========== -->
    <div
      id="randomModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="randomModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>ğŸ’¡</span> Random Test
            </h2>
            <button
              id="closeRandomBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-4 grid grid-cols-2 gap-4">
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Seed</label>
              <input
                type="number"
                id="rand_seed"
                value="42"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Dimensions</label>
              <input
                type="number"
                id="rand_dims"
                value="3"
                min="1"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Time Steps</label>
              <input
                type="number"
                id="rand_steps"
                value="200"
                min="10"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Noise</label>
              <input
                type="number"
                id="rand_noise"
                value="0.1"
                step="0.01"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Outliers Rate</label>
              <input
                type="number"
                id="rand_outliers"
                value="0.02"
                step="0.01"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Difficulty</label>
              <select
                id="rand_difficulty"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>
          <div
            class="flex justify-end gap-2 p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 rounded-b-2xl"
          >
            <button
              id="cancelRandomBtn"
              class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
            >
              Cancel
            </button>
            <button
              id="generateRandomBtn"
              class="px-6 py-2 text-sm font-semibold text-white bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow-lg shadow-purple-500/30 hover:shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center gap-2"
            >
              <span>âœ¨</span> Generate & Run
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== SAVE/LOAD MODAL ========== -->
    <div
      id="saveLoadModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="saveLoadModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>ğŸ’¾</span> Save & Load
            </h2>
            <button
              id="closeSaveLoadBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-4 space-y-6">
            <section>
              <h3 class="text-sm font-bold text-slate-800 dark:text-white mb-3">
                Save Model
              </h3>
              <div class="flex gap-2">
                <button
                  id="downloadModelBtn"
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                  <span class="text-lg">ğŸ“¥</span>
                  <span class="font-medium text-slate-700 dark:text-slate-200"
                  >Download</span>
                </button>
                <button
                  id="browserSaveBtn"
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                  <span class="text-lg">ğŸ’¾</span>
                  <span class="font-medium text-slate-700 dark:text-slate-200"
                  >Browser</span>
                </button>
              </div>
            </section>
            <section>
              <h3 class="text-sm font-bold text-slate-800 dark:text-white mb-3">
                Load Model
              </h3>
              <div
                id="loadDropZone"
                class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors mb-3"
              >
                <span class="text-2xl">ğŸ“¤</span>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">
                  Tap to upload model file
                </p>
                <input
                  type="file"
                  id="loadFileInput"
                  accept=".json"
                  class="hidden"
                >
              </div>
              <div
                id="savedModelsList"
                class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"
              >
              </div>
              <button
                id="clearSavedBtn"
                class="mt-3 text-xs text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300"
              >
                Clear all saved models
              </button>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== MANUAL INSERT MODAL ========== -->
    <div
      id="insertModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="insertModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>â•</span> Manual Insert
            </h2>
            <button
              id="closeInsertBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-4 space-y-4">
            <p class="text-sm text-slate-600 dark:text-slate-400">
              Add individual time steps for online training. Each coordinate
              array represents one time step.
            </p>
            <button
              id="genTemplateBtn"
              class="px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors"
            >
              ğŸ“ Generate Template
            </button>
            <textarea
              id="insertJsonInput"
              rows="6"
              placeholder='{"coordinates": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1]]}'
              class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm text-slate-800 dark:text-white font-mono resize-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
            <div id="insertFeedback" class="hidden p-3 rounded-xl text-sm">
            </div>
          </div>
          <div
            class="flex justify-end gap-2 p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 rounded-b-2xl"
          >
            <button
              id="cancelInsertBtn"
              class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
            >
              Cancel
            </button>
            <button
              id="applyInsertBtn"
              class="px-6 py-2 text-sm font-semibold text-white bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg shadow-lg hover:shadow-xl transition-all"
            >
              Insert & Train
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== DATA TABLE MODAL ========== -->
    <div
      id="tableModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="tableModalBackdrop"
      >
      </div>
      <div
        class="absolute inset-0 flex flex-col bg-white dark:bg-slate-800 md:p-4 lg:p-8"
      >
        <div
          class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 md:rounded-t-2xl bg-white dark:bg-slate-800"
        >
          <h2
            class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
          >
            <span>ğŸ“‹</span> Data Table
          </h2>
          <div class="flex items-center gap-2">
            <input
              type="text"
              id="tableSearch"
              placeholder="Search..."
              class="px-3 py-1.5 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
            <button
              id="exportCsvBtn"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-1"
            >
              <span>ğŸ“Š</span> CSV
            </button>
            <button
              id="copyAllBtn"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-1"
            >
              <span>ğŸ“‹</span> Copy
            </button>
            <button
              id="closeTableBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-auto custom-scrollbar p-4">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700">
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody" class="font-mono"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== SETTINGS MODAL ========== -->
    <div
      id="settingsModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="settingsModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>ğŸ”§</span> Settings
            </h2>
            <button
              id="closeSettingsBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-4 space-y-4">
            <div>
              <label
                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 block"
              >Module URL</label>
              <input
                type="text"
                id="moduleUrlInput"
                value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-mono text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <button
              id="reinitWorkerBtn"
              class="w-full px-4 py-2 text-sm font-medium text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors"
            >
              ğŸ”„ Reinitialize Worker
            </button>
            <button
              id="clearPrefsBtn"
              class="w-full px-4 py-2 text-sm font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors"
            >
              ğŸ—‘ï¸ Clear All Preferences
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== HELP MODAL ========== -->
    <div
      id="helpModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        id="helpModalBackdrop"
      >
      </div>
      <div class="absolute inset-0 overflow-y-auto custom-scrollbar p-4 md:p-8">
        <div
          class="max-w-3xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-2xl animate-slide-up"
        >
          <div
            class="sticky top-0 z-10 flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-t-2xl"
          >
            <h2
              class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"
            >
              <span>â“</span> Help & Documentation
            </h2>
            <button
              id="closeHelpBtn"
              class="touch-target w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="text-xl">âœ–ï¸</span>
            </button>
          </div>
          <div class="p-6 space-y-8 prose dark:prose-invert max-w-none">
            <section>
              <h3 class="text-lg font-bold flex items-center gap-2">
                <span>ğŸŒ</span> Worker Setup
              </h3>
              <p class="text-slate-600 dark:text-slate-400 text-sm">
                The ESNRegression library runs in a Web Worker for non-blocking
                performance.
              </p>
              <pre
                class="bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-xs overflow-x-auto"
              >Module URL: https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0</pre>
            </section>
            <section>
              <h3 class="text-lg font-bold flex items-center gap-2">
                <span>ğŸ“–</span> Method Calls
              </h3>
              <div class="space-y-4">
                <div>
                  <h4 class="font-semibold text-sm">1. Creating a Model</h4>
                  <pre
                    class="bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-xs overflow-x-auto"
                  >
const model = new ESNRegression(config);
// config contains all parameters from Configuration Modal</pre>
                </div>
                <div>
                  <h4 class="font-semibold text-sm">
                    2. Online Training (fitOnline)
                  </h4>
                  <pre
                    class="bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-xs overflow-x-auto"
                  >
model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Returns: { averageLoss, gradientNorm, sampleWeight }</pre>
                </div>
                <div>
                  <h4 class="font-semibold text-sm">3. Prediction</h4>
                  <pre
                    class="bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-xs overflow-x-auto"
                  >
const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }</pre>
                </div>
                <div>
                  <h4 class="font-semibold text-sm">4. Save/Load</h4>
                  <pre
                    class="bg-slate-100 dark:bg-slate-700 p-3 rounded-xl text-xs overflow-x-auto"
                  >
const state = model.save(); // Returns serialized model
model.load(state); // Restores from serialized string</pre>
                </div>
              </div>
            </section>
            <section>
              <h3 class="text-lg font-bold flex items-center gap-2">
                <span>âš¡</span> Presets
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                  <strong class="text-blue-600 dark:text-blue-400"
                  >Start Here/Default</strong>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    reservoirSize=256, spectralRadius=0.9, leakRate=0.3
                  </p>
                </div>
                <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                  <strong class="text-emerald-600 dark:text-emerald-400"
                  >Fast</strong>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    reservoirSize=64, reservoirSparsity=0.95
                  </p>
                </div>
                <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                  <strong class="text-purple-600 dark:text-purple-400"
                  >Accurate</strong>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    reservoirSize=512, spectralRadius=0.95, leakRate=0.2
                  </p>
                </div>
                <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                  <strong class="text-amber-600 dark:text-amber-400"
                  >Robust</strong>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                    outlierThreshold=2.0, l2Lambda=0.01
                  </p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TOAST CONTAINER ========== -->
    <div
      id="toastContainer"
      class="fixed bottom-20 lg:bottom-4 left-4 right-4 lg:left-auto lg:right-4 lg:w-96 z-50 space-y-2"
    >
    </div>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
      (function () {
        "use strict";

        // ===== DIMENSION COLORS =====
        const DIM_COLORS = [
          "#3B82F6",
          "#10B981",
          "#F59E0B",
          "#EF4444",
          "#8B5CF6",
          "#EC4899",
          "#06B6D4",
          "#84CC16",
          "#F97316",
          "#14B8A6",
        ];

        // ===== DEFAULT CONFIG =====
        const DEFAULT_CONFIG = {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          readoutTraining: "rls",
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
        };

        // ===== PRESETS =====
        const PRESETS = {
          default: { ...DEFAULT_CONFIG },
          fast: {
            ...DEFAULT_CONFIG,
            reservoirSize: 64,
            reservoirSparsity: 0.95,
          },
          balanced: {
            ...DEFAULT_CONFIG,
            reservoirSize: 256,
            spectralRadius: 0.9,
          },
          accurate: {
            ...DEFAULT_CONFIG,
            reservoirSize: 512,
            spectralRadius: 0.95,
            leakRate: 0.2,
          },
          adaptive: {
            ...DEFAULT_CONFIG,
            rlsLambda: 0.97,
            spectralRadius: 0.85,
            leakRate: 0.5,
          },
          robust: {
            ...DEFAULT_CONFIG,
            outlierThreshold: 2.0,
            outlierMinWeight: 0.05,
            l2Lambda: 0.01,
            leakRate: 0.2,
          },
        };

        // ===== APPLICATION STATE =====
        const state = {
          config: { ...DEFAULT_CONFIG },
          modelExists: false,
          nDimensions: 0,
          sampleCount: 0,
          predictions: null,
          vizMode: "grid",
          selectedDim: 0,
          selectedStep: 1,
          isDark: localStorage.getItem("esn_dark") === "true",
          logs: [],
          metrics: {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          },
          zoom: { level: 1, offsetX: 0, panStart: null },
          hover: { active: false, x: 0, y: 0, step: -1, dim: -1 },
          worker: null,
          requestId: 0,
          pendingRequests: {},
          moduleUrl: localStorage.getItem("esn_moduleUrl") ||
            "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.0",
        };

        // ===== DOM ELEMENTS =====
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => document.querySelectorAll(sel);

        // ===== WORKER CREATION =====
        function createWorker() {
          const workerCode = `
                let ESNRegression = null;
                let model = null;
                let moduleUrl = '';

                self.onmessage = async function(e) {
                    const { type, payload, requestId } = e.data;
                    try {
                        switch(type) {
                            case 'init':
                                moduleUrl = payload.moduleUrl;
                                const module = await import(moduleUrl);
                                ESNRegression = module.ESNRegression;
                                self.postMessage({ type: 'ready', requestId });
                                break;
                            case 'createModel':
                                model = new ESNRegression(payload.config);
                                self.postMessage({ type: 'modelCreated', requestId });
                                break;
                            case 'train':
                                if (!model) throw new Error('No model');
                                const coords = payload.coordinates;
                                let result;
                                for (let i = 0; i < coords.length; i++) {
                                    result = model.fitOnline({ coordinates: [coords[i]] });
                                    if (i % 10 === 0) {
                                        self.postMessage({ type: 'progress', progress: (i+1)/coords.length, requestId });
                                    }
                                }
                                const summary = model.getModelSummary();
                                self.postMessage({ type: 'trained', result, summary, requestId });
                                break;
                            case 'predict':
                                if (!model) throw new Error('No model');
                                const pred = model.predict(payload.steps);
                                self.postMessage({ type: 'predicted', result: pred, requestId });
                                break;
                            case 'save':
                                if (!model) throw new Error('No model');
                                const saved = model.save();
                                self.postMessage({ type: 'saved', result: saved, requestId });
                                break;
                            case 'load':
                                if (!model) model = new ESNRegression({});
                                model.load(payload.data);
                                const loadSummary = model.getModelSummary();
                                self.postMessage({ type: 'loaded', summary: loadSummary, requestId });
                                break;
                            case 'getSummary':
                                if (!model) throw new Error('No model');
                                const summ = model.getModelSummary();
                                self.postMessage({ type: 'summary', result: summ, requestId });
                                break;
                            case 'reset':
                                model = null;
                                self.postMessage({ type: 'reset', requestId });
                                break;
                        }
                    } catch (err) {
                        self.postMessage({ type: 'error', error: err.message, requestId });
                    }
                };
            `;
          const blob = new Blob([workerCode], {
            type: "application/javascript",
          });
          return new Worker(URL.createObjectURL(blob), {
            type: "module",
          });
        }

        function initWorker() {
          if (state.worker) state.worker.terminate();
          state.worker = createWorker();
          state.worker.onmessage = handleWorkerMessage;
          sendWorkerMessage("init", { moduleUrl: state.moduleUrl });
        }

        function sendWorkerMessage(type, payload = {}) {
          return new Promise((resolve, reject) => {
            const requestId = ++state.requestId;
            state.pendingRequests[requestId] = { resolve, reject };
            state.worker.postMessage({ type, payload, requestId });
          });
        }

        function handleWorkerMessage(e) {
          const { type, requestId, error, ...data } = e.data;
          const pending = state.pendingRequests[requestId];

          if (type === "error") {
            if (pending) {
              pending.reject(new Error(error));
              delete state.pendingRequests[requestId];
            }
            addLog("error", error);
            showToast(error, "error");
            return;
          }

          if (type === "progress") {
            updateLoadingProgress(data.progress);
            return;
          }

          if (pending) {
            pending.resolve(data);
            delete state.pendingRequests[requestId];
          }
        }

        // ===== LOGGING =====
        function addLog(level, message) {
          const entry = {
            level,
            message,
            timestamp: new Date().toLocaleTimeString(),
          };
          state.logs.unshift(entry);
          if (state.logs.length > 200) state.logs.pop();
          renderLogs();
        }

        function renderLogs() {
          const container = $("logContainer");
          const filter = $("logFilter").value;
          const search = $("logSearch").value.toLowerCase();
          const filtered = state.logs.filter((log) => {
            if (filter !== "all" && log.level !== filter) return false;
            if (search && !log.message.toLowerCase().includes(search)) {
              return false;
            }
            return true;
          }).slice(0, 50);

          container.innerHTML = filtered.map((log) => {
            const colors = {
              info:
                "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
              success:
                "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
              warning:
                "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
              error:
                "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
            };
            return `<div class="p-2 rounded-lg bg-white dark:bg-slate-700/50 text-xs">
                    <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold ${
              colors[log.level]
            } mr-2">${log.level.toUpperCase()}</span>
                    <span class="text-slate-400">${log.timestamp}</span>
                    <p class="text-slate-700 dark:text-slate-200 mt-1">${log.message}</p>
                </div>`;
          }).join("");
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = "info") {
          const colors = {
            info: "bg-blue-500",
            success: "bg-emerald-500",
            warning: "bg-amber-500",
            error: "bg-red-500",
          };
          const toast = document.createElement("div");
          toast.className = `${
            colors[type]
          } text-white px-4 py-3 rounded-xl shadow-lg flex items-center justify-between gap-3 animate-slide-up`;
          toast.innerHTML =
            `<span>${message}</span><button class="text-white/80 hover:text-white text-lg">âœ–ï¸</button>`;
          $("toastContainer").appendChild(toast);
          toast.querySelector("button").onclick = () => toast.remove();
          setTimeout(
            () => toast.remove(),
            type === "error" ? 6000 : 4000,
          );
        }

        // ===== THEME =====
        function applyTheme() {
          document.documentElement.classList.toggle(
            "dark",
            state.isDark,
          );
          $("themeIcon").textContent = state.isDark ? "â˜€ï¸" : "ğŸŒ™";
          localStorage.setItem("esn_dark", state.isDark);
        }

        // ===== UI UPDATES =====
        function updateUI() {
          // Status badge
          const dot = $("statusDot");
          const text = $("statusText");
          const headerDot = $("headerDot");
          if (state.modelExists) {
            dot.className =
              "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            headerDot.className =
              "absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full border-2 border-white dark:border-slate-800 animate-pulse";
            text.textContent = `${state.sampleCount} steps`;
          } else {
            dot.className =
              "w-2 h-2 rounded-full bg-slate-400 animate-pulse";
            headerDot.className =
              "absolute -top-1 -right-1 w-3 h-3 bg-slate-400 rounded-full border-2 border-white dark:border-slate-800";
            text.textContent = "No Model";
          }

          // Predict buttons
          const show = state.modelExists && state.sampleCount > 0;
          $("predictBtn").classList.toggle("hidden", !show);
          $("predictBtn").classList.toggle("flex", show);
          $("runPredictBtn").disabled = !show;

          // Empty state & controls
          $("emptyState").classList.toggle(
            "hidden",
            state.predictions !== null,
          );
          $("chartControls").classList.toggle(
            "hidden",
            !state.predictions,
          );
          $("exportControls").classList.toggle(
            "hidden",
            !state.predictions,
          );
          $("zoomBadge").classList.toggle(
            "hidden",
            state.zoom.level === 1,
          );
          $("zoomBadge").textContent = `${
            Math.round(state.zoom.level * 100)
          }%`;

          // Dimension selector (focus mode)
          $("dimSelector").classList.toggle(
            "hidden",
            state.vizMode !== "focus" || !state.predictions,
          );
          $("statsBar").classList.toggle(
            "hidden",
            state.vizMode !== "focus" || !state.predictions,
          );
          $("stepSelector").classList.toggle(
            "hidden",
            state.vizMode !== "snapshot" || !state.predictions,
          );

          // Metrics
          $("metricSamples").textContent = state.sampleCount;
          $("metricLoss").textContent = state.metrics.avgLoss !== null
            ? state.metrics.avgLoss.toExponential(2)
            : "-";
          $("metricGradient").textContent =
            state.metrics.gradientNorm !== null
              ? state.metrics.gradientNorm.toExponential(2)
              : "-";
          $("metricWeight").textContent =
            state.metrics.sampleWeight !== null
              ? state.metrics.sampleWeight.toFixed(3)
              : "-";

          renderDimensionButtons();
          updateStats();
          renderChart();
        }

        function renderDimensionButtons() {
          if (!state.predictions || state.nDimensions === 0) return;
          const container = $("dimButtons");
          container.innerHTML = "";
          for (let i = 0; i < state.nDimensions; i++) {
            const btn = document.createElement("button");
            btn.className =
              `touch-target px-4 py-2 rounded-xl text-sm font-semibold transition-all ${
                i === state.selectedDim
                  ? "text-white shadow-lg"
                  : "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
              }`;
            if (i === state.selectedDim) {
              btn.style.background = DIM_COLORS[i % DIM_COLORS.length];
            }
            btn.textContent = `D${i + 1}`;
            btn.onclick = () => {
              state.selectedDim = i;
              updateUI();
            };
            container.appendChild(btn);
          }
        }

        function updateStats() {
          if (!state.predictions || state.vizMode !== "focus") return;
          const preds = state.predictions.predictions.map((s) =>
            s[state.selectedDim]
          );
          const lowers = state.predictions.lowerBounds.map((s) =>
            s[state.selectedDim]
          );
          const uppers = state.predictions.upperBounds.map((s) =>
            s[state.selectedDim]
          );

          const min = Math.min(...preds);
          const max = Math.max(...preds);
          const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
          const final = preds[preds.length - 1];
          const first = preds[0];
          const trend = final - first;
          const avgSpread =
            uppers.reduce((a, v, i) => a + (v - lowers[i]), 0) /
            preds.length;
          const avgPred = Math.abs(mean) || 1;
          const confidence = Math.max(
            0,
            Math.min(100, 100 * (1 - avgSpread / avgPred)),
          );

          $("statMin").textContent = min.toFixed(3);
          $("statMax").textContent = max.toFixed(3);
          $("statMean").textContent = mean.toFixed(3);
          $("statFinal").textContent = final.toFixed(3);
          $("statTrend").innerHTML = `<span class="${
            trend >= 0 ? "text-emerald-600" : "text-red-600"
          }">${trend >= 0 ? "â†‘" : "â†“"} ${
            Math.abs(trend).toFixed(3)
          }</span>`;
          $("statConfidence").textContent = `${confidence.toFixed(1)}%`;
          $("stepTotal").textContent = `/ ${preds.length}`;
        }

        // ===== LOADING STATE =====
        function showLoading(text = "Processing...") {
          $("loadingOverlay").classList.remove("hidden");
          $("loadingText").textContent = text;
          $("loadingProgress").style.width = "0%";
          $("loadingPercent").textContent = "0%";
        }

        function hideLoading() {
          $("loadingOverlay").classList.add("hidden");
        }

        function updateLoadingProgress(progress) {
          const pct = Math.round(progress * 100);
          $("loadingProgress").style.width = `${pct}%`;
          $("loadingPercent").textContent = `${pct}%`;
        }

        // ===== CHART RENDERING =====
        function renderChart() {
          const canvas = $("chartCanvas");
          const ctx = canvas.getContext("2d");
          const rect = canvas.parentElement.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          canvas.width = rect.width * dpr;
          canvas.height = Math.max(400, rect.height) * dpr;
          canvas.style.width = rect.width + "px";
          canvas.style.height = Math.max(400, rect.height) + "px";
          ctx.scale(dpr, dpr);

          const w = rect.width;
          const h = Math.max(400, rect.height);
          const isDark = state.isDark;

          ctx.fillStyle = isDark ? "#1e293b" : "#ffffff";
          ctx.fillRect(0, 0, w, h);

          if (!state.predictions) return;

          const padding = { top: 40, right: 20, bottom: 50, left: 60 };
          const chartW = w - padding.left - padding.right;
          const chartH = h - padding.top - padding.bottom;

          switch (state.vizMode) {
            case "grid":
              renderGridChart(ctx, padding, chartW, chartH, isDark);
              break;
            case "focus":
              renderFocusChart(ctx, padding, chartW, chartH, isDark);
              break;
            case "heatmap":
              renderHeatmap(ctx, padding, chartW, chartH, isDark);
              break;
            case "ci":
              renderCIChart(ctx, padding, chartW, chartH, isDark);
              break;
            case "snapshot":
              renderSnapshotChart(ctx, padding, chartW, chartH, isDark);
              break;
          }
        }

        function renderGridChart(ctx, padding, chartW, chartH, isDark) {
          const preds = state.predictions.predictions;
          const nSteps = preds.length;
          const nDims = state.nDimensions;
          const cols = Math.ceil(Math.sqrt(nDims));
          const rows = Math.ceil(nDims / cols);
          const cellW = chartW / cols;
          const cellH = chartH / rows;
          const cellPad = 10;

          for (let d = 0; d < nDims; d++) {
            const col = d % cols;
            const row = Math.floor(d / cols);
            const x = padding.left + col * cellW + cellPad;
            const y = padding.top + row * cellH + cellPad;
            const cw = cellW - cellPad * 2;
            const ch = cellH - cellPad * 2;

            // Background
            ctx.fillStyle = isDark
              ? "rgba(51,65,85,0.5)"
              : "rgba(248,250,252,1)";
            ctx.fillRect(x, y, cw, ch);
            ctx.strokeStyle = isDark
              ? "rgba(71,85,105,0.5)"
              : "rgba(226,232,240,1)";
            ctx.strokeRect(x, y, cw, ch);

            // Title
            ctx.fillStyle = DIM_COLORS[d % DIM_COLORS.length];
            ctx.font = "bold 11px system-ui";
            ctx.fillText(`D${d + 1}`, x + 5, y + 15);

            // Data
            const vals = preds.map((s) => s[d]);
            const min = Math.min(...vals);
            const max = Math.max(...vals);
            const range = max - min || 1;

            ctx.strokeStyle = DIM_COLORS[d % DIM_COLORS.length];
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < nSteps; i++) {
              const px = x + 5 + (i / (nSteps - 1)) * (cw - 10);
              const py = y + ch - 5 -
                ((vals[i] - min) / range) * (ch - 25);
              i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
            }
            ctx.stroke();
          }
        }

        function renderFocusChart(
          ctx,
          padding,
          chartW,
          chartH,
          isDark,
        ) {
          const preds = state.predictions.predictions;
          const lowers = state.predictions.lowerBounds;
          const uppers = state.predictions.upperBounds;
          const d = state.selectedDim;
          const color = DIM_COLORS[d % DIM_COLORS.length];

          const vals = preds.map((s) => s[d]);
          const lVals = lowers.map((s) => s[d]);
          const uVals = uppers.map((s) => s[d]);
          const allVals = [...vals, ...lVals, ...uVals];
          const min = Math.min(...allVals);
          const max = Math.max(...allVals);
          const range = max - min || 1;
          const nSteps = vals.length;

          // Zoom
          const visibleSteps = Math.ceil(nSteps / state.zoom.level);
          const start = Math.max(
            0,
            Math.min(
              nSteps - visibleSteps,
              Math.floor(state.zoom.offsetX),
            ),
          );
          const end = Math.min(nSteps, start + visibleSteps);

          // Grid
          ctx.strokeStyle = isDark
            ? "rgba(71,85,105,0.3)"
            : "rgba(226,232,240,1)";
          ctx.lineWidth = 1;
          for (let i = 0; i <= 5; i++) {
            const y = padding.top + (i / 5) * chartH;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + chartW, y);
            ctx.stroke();
          }

          // Y axis labels
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          for (let i = 0; i <= 5; i++) {
            const v = max - (i / 5) * range;
            const y = padding.top + (i / 5) * chartH;
            ctx.fillText(v.toFixed(2), padding.left - 8, y + 3);
          }

          // CI fill
          ctx.fillStyle = color + "20";
          ctx.beginPath();
          for (let i = start; i < end; i++) {
            const px = padding.left +
              ((i - start) / (end - start - 1)) * chartW;
            const py = padding.top +
              (1 - (uVals[i] - min) / range) * chartH;
            i === start ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          }
          for (let i = end - 1; i >= start; i--) {
            const px = padding.left +
              ((i - start) / (end - start - 1)) * chartW;
            const py = padding.top +
              (1 - (lVals[i] - min) / range) * chartH;
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Main line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          for (let i = start; i < end; i++) {
            const px = padding.left +
              ((i - start) / (end - start - 1)) * chartW;
            const py = padding.top +
              (1 - (vals[i] - min) / range) * chartH;
            i === start ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          }
          ctx.stroke();

          // X axis labels
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.textAlign = "center";
          const stepLabels = 6;
          for (let i = 0; i < stepLabels; i++) {
            const step = Math.round(
              start + (i / (stepLabels - 1)) * (end - start - 1),
            );
            const px = padding.left + (i / (stepLabels - 1)) * chartW;
            ctx.fillText(
              `Step ${step + 1}`,
              px,
              padding.top + chartH + 20,
            );
          }

          // Hover point
          if (
            state.hover.active && state.hover.step >= start &&
            state.hover.step < end
          ) {
            const i = state.hover.step;
            const px = padding.left +
              ((i - start) / (end - start - 1)) * chartW;
            const py = padding.top +
              (1 - (vals[i] - min) / range) * chartH;

            ctx.beginPath();
            ctx.arc(px, py, 6, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.stroke();
          }

          // Title
          ctx.fillStyle = color;
          ctx.font = "bold 14px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(
            `Dimension ${d + 1}`,
            padding.left,
            padding.top - 15,
          );
        }

        function renderHeatmap(ctx, padding, chartW, chartH, isDark) {
          const preds = state.predictions.predictions;
          const nSteps = preds.length;
          const nDims = state.nDimensions;

          // Find global min/max
          let globalMin = Infinity, globalMax = -Infinity;
          for (const step of preds) {
            for (const v of step) {
              if (v < globalMin) globalMin = v;
              if (v > globalMax) globalMax = v;
            }
          }
          const range = globalMax - globalMin || 1;

          const cellW = chartW / nSteps;
          const cellH = chartH / nDims;

          for (let d = 0; d < nDims; d++) {
            for (let s = 0; s < nSteps; s++) {
              const v = (preds[s][d] - globalMin) / range;
              const hue = (1 - v) * 240; // Blue to red
              ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
              ctx.fillRect(
                padding.left + s * cellW,
                padding.top + d * cellH,
                cellW + 0.5,
                cellH + 0.5,
              );
            }
          }

          // Y labels
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          for (let d = 0; d < nDims; d++) {
            ctx.fillText(
              `D${d + 1}`,
              padding.left - 8,
              padding.top + d * cellH + cellH / 2 + 3,
            );
          }

          // X labels
          ctx.textAlign = "center";
          const labels = Math.min(10, nSteps);
          for (let i = 0; i < labels; i++) {
            const step = Math.floor((i / (labels - 1)) * (nSteps - 1));
            const px = padding.left + step * cellW + cellW / 2;
            ctx.fillText(step + 1, px, padding.top + chartH + 15);
          }

          // Legend
          const legW = 150, legH = 15;
          const legX = padding.left + chartW - legW;
          const legY = padding.top - 25;
          const grad = ctx.createLinearGradient(
            legX,
            0,
            legX + legW,
            0,
          );
          grad.addColorStop(0, "hsl(240, 70%, 50%)");
          grad.addColorStop(0.5, "hsl(120, 70%, 50%)");
          grad.addColorStop(1, "hsl(0, 70%, 50%)");
          ctx.fillStyle = grad;
          ctx.fillRect(legX, legY, legW, legH);
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "9px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(globalMin.toFixed(2), legX, legY + legH + 10);
          ctx.textAlign = "right";
          ctx.fillText(
            globalMax.toFixed(2),
            legX + legW,
            legY + legH + 10,
          );
        }

        function renderCIChart(ctx, padding, chartW, chartH, isDark) {
          const preds = state.predictions.predictions;
          const lowers = state.predictions.lowerBounds;
          const uppers = state.predictions.upperBounds;
          const nSteps = preds.length;
          const nDims = state.nDimensions;

          // Compute uncertainty per step
          const uncertainties = [];
          for (let s = 0; s < nSteps; s++) {
            let sum = 0;
            for (let d = 0; d < nDims; d++) {
              sum += uppers[s][d] - lowers[s][d];
            }
            uncertainties.push(sum / nDims);
          }

          const maxU = Math.max(...uncertainties);
          const minU = Math.min(...uncertainties);
          const range = maxU - minU || 1;

          // Bars
          const barW = chartW / nSteps;
          for (let s = 0; s < nSteps; s++) {
            const u = (uncertainties[s] - minU) / range;
            const barH = u * chartH;
            const hue = (1 - u) * 120;
            ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
            ctx.fillRect(
              padding.left + s * barW,
              padding.top + chartH - barH,
              barW - 1,
              barH,
            );
          }

          // Axis
          ctx.strokeStyle = isDark ? "#475569" : "#cbd5e1";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(padding.left, padding.top + chartH);
          ctx.lineTo(padding.left + chartW, padding.top + chartH);
          ctx.stroke();

          // Labels
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(
            "Step",
            padding.left + chartW / 2,
            padding.top + chartH + 30,
          );
          ctx.save();
          ctx.translate(15, padding.top + chartH / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.fillText("Avg Uncertainty", 0, 0);
          ctx.restore();

          // Title
          ctx.fillStyle = isDark ? "#e2e8f0" : "#1e293b";
          ctx.font = "bold 14px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(
            "Uncertainty by Step",
            padding.left,
            padding.top - 15,
          );
        }

        function renderSnapshotChart(
          ctx,
          padding,
          chartW,
          chartH,
          isDark,
        ) {
          const step = Math.min(
            state.selectedStep - 1,
            state.predictions.predictions.length - 1,
          );
          const preds = state.predictions.predictions[step];
          const lowers = state.predictions.lowerBounds[step];
          const uppers = state.predictions.upperBounds[step];
          const nDims = state.nDimensions;

          const allVals = [...preds, ...lowers, ...uppers];
          const min = Math.min(...allVals, 0);
          const max = Math.max(...allVals);
          const range = max - min || 1;

          const barW = chartW / (nDims * 2);
          const barGap = barW;

          for (let d = 0; d < nDims; d++) {
            const x = padding.left + d * (barW + barGap) + barGap / 2;
            const v = preds[d];
            const l = lowers[d];
            const u = uppers[d];

            const barH = ((v - min) / range) * chartH;
            const y = padding.top + chartH - barH;

            // Error bar
            const ly = padding.top + chartH -
              ((l - min) / range) * chartH;
            const uy = padding.top + chartH -
              ((u - min) / range) * chartH;
            ctx.strokeStyle = isDark ? "#94a3b8" : "#64748b";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + barW / 2, ly);
            ctx.lineTo(x + barW / 2, uy);
            ctx.moveTo(x + barW / 4, ly);
            ctx.lineTo(x + barW * 3 / 4, ly);
            ctx.moveTo(x + barW / 4, uy);
            ctx.lineTo(x + barW * 3 / 4, uy);
            ctx.stroke();

            // Bar
            ctx.fillStyle = DIM_COLORS[d % DIM_COLORS.length];
            ctx.fillRect(x, y, barW, barH);

            // Label
            ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
            ctx.font = "10px system-ui";
            ctx.textAlign = "center";
            ctx.fillText(
              `D${d + 1}`,
              x + barW / 2,
              padding.top + chartH + 15,
            );
          }

          // Y axis
          ctx.fillStyle = isDark ? "#94a3b8" : "#64748b";
          ctx.textAlign = "right";
          for (let i = 0; i <= 5; i++) {
            const v = min + (1 - i / 5) * range;
            const y = padding.top + (i / 5) * chartH;
            ctx.fillText(v.toFixed(2), padding.left - 8, y + 3);
          }

          // Title
          ctx.fillStyle = isDark ? "#e2e8f0" : "#1e293b";
          ctx.font = "bold 14px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(
            `Step ${step + 1} Snapshot`,
            padding.left,
            padding.top - 15,
          );
        }

        // ===== CHART INTERACTIONS =====
        function setupChartInteractions() {
          const canvas = $("chartCanvas");

          canvas.addEventListener("mousemove", (e) => {
            if (!state.predictions) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            handleChartHover(x, y, rect.width, rect.height);
          });

          canvas.addEventListener("mouseleave", () => {
            state.hover.active = false;
            $("chartTooltip").classList.add("hidden");
            renderChart();
          });

          canvas.addEventListener("wheel", (e) => {
            if (!state.predictions || !e.ctrlKey) return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            state.zoom.level = Math.max(
              1,
              Math.min(10, state.zoom.level * delta),
            );
            updateUI();
          }, { passive: false });

          // Touch interactions
          let touchStart = null;
          let initialDistance = 0;
          let initialZoom = 1;

          canvas.addEventListener("touchstart", (e) => {
            if (e.touches.length === 2) {
              initialDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY,
              );
              initialZoom = state.zoom.level;
            } else if (e.touches.length === 1) {
              touchStart = e.touches[0].clientX;
            }
          });

          canvas.addEventListener("touchmove", (e) => {
            if (!state.predictions) return;
            if (e.touches.length === 2) {
              e.preventDefault();
              const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY,
              );
              state.zoom.level = Math.max(
                1,
                Math.min(10, initialZoom * (dist / initialDistance)),
              );
              updateUI();
            } else if (
              e.touches.length === 1 && touchStart !== null &&
              state.zoom.level > 1
            ) {
              const delta = touchStart - e.touches[0].clientX;
              const maxOffset = state.predictions.predictions.length *
                (1 - 1 / state.zoom.level);
              state.zoom.offsetX = Math.max(
                0,
                Math.min(maxOffset, state.zoom.offsetX + delta * 0.1),
              );
              touchStart = e.touches[0].clientX;
              renderChart();
            }
          }, { passive: false });

          // Zoom buttons
          $("zoomInBtn").onclick = () => {
            state.zoom.level = Math.min(10, state.zoom.level * 1.2);
            updateUI();
          };
          $("zoomOutBtn").onclick = () => {
            state.zoom.level = Math.max(1, state.zoom.level / 1.2);
            updateUI();
          };
          $("zoomResetBtn").onclick = () => {
            state.zoom.level = 1;
            state.zoom.offsetX = 0;
            updateUI();
          };
        }

        function handleChartHover(x, y, w, h) {
          if (state.vizMode !== "focus" || !state.predictions) {
            state.hover.active = false;
            $("chartTooltip").classList.add("hidden");
            return;
          }

          const padding = { top: 40, right: 20, bottom: 50, left: 60 };
          const chartW = w - padding.left - padding.right;
          const chartH = h - padding.top - padding.bottom;

          if (
            x < padding.left || x > w - padding.right ||
            y < padding.top || y > h - padding.bottom
          ) {
            state.hover.active = false;
            $("chartTooltip").classList.add("hidden");
            renderChart();
            return;
          }

          const nSteps = state.predictions.predictions.length;
          const visibleSteps = Math.ceil(nSteps / state.zoom.level);
          const start = Math.max(0, Math.floor(state.zoom.offsetX));
          const end = Math.min(nSteps, start + visibleSteps);

          const relX = (x - padding.left) / chartW;
          const step = Math.round(start + relX * (end - start - 1));

          if (step < 0 || step >= nSteps) {
            state.hover.active = false;
            $("chartTooltip").classList.add("hidden");
            renderChart();
            return;
          }

          state.hover.active = true;
          state.hover.step = step;
          state.hover.dim = state.selectedDim;

          const d = state.selectedDim;
          const pred = state.predictions.predictions[step][d];
          const lower = state.predictions.lowerBounds[step][d];
          const upper = state.predictions.upperBounds[step][d];
          const spread = upper - lower;

          const tooltip = $("chartTooltip");
          tooltip.classList.remove("hidden");
          $("tooltipStep").textContent = `Step ${step + 1}`;
          $("tooltipContent").innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background:${
            DIM_COLORS[d % DIM_COLORS.length]
          }"></span>
                    <span class="font-bold">D${d + 1}</span>
                </div>
                <div class="mt-1 space-y-0.5">
                    <div>Predicted: <span class="font-bold">${
            pred.toFixed(4)
          }</span></div>
                    <div class="text-xs opacity-75">CI: [${
            lower.toFixed(4)
          }, ${upper.toFixed(4)}]</div>
                    <div class="text-xs opacity-75">Spread: ${
            spread.toFixed(4)
          }</div>
                </div>
            `;

          // Position tooltip
          const tooltipW = tooltip.offsetWidth;
          const tooltipH = tooltip.offsetHeight;
          let tx = x + 15;
          let ty = y - tooltipH / 2;
          if (tx + tooltipW > w - 10) tx = x - tooltipW - 15;
          if (ty < 10) ty = 10;
          if (ty + tooltipH > h - 10) ty = h - tooltipH - 10;
          tooltip.style.left = tx + "px";
          tooltip.style.top = ty + "px";

          renderChart();
        }

        // ===== EXPORT FUNCTIONS =====
        function setupExportButtons() {
          $("exportPngBtn").onclick = () => {
            const canvas = $("chartCanvas");
            const link = document.createElement("a");
            link.download = `esn-chart-${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            showToast("Chart exported as PNG", "success");
          };

          $("exportSvgBtn").onclick = () => {
            showToast("SVG export not implemented yet", "info");
          };

          $("copyChartBtn").onclick = async () => {
            try {
              const canvas = $("chartCanvas");
              const blob = await new Promise((resolve) =>
                canvas.toBlob(resolve)
              );
              await navigator.clipboard.write([
                new ClipboardItem({ "image/png": blob }),
              ]);
              showToast("Chart copied to clipboard", "success");
            } catch {
              showToast("Failed to copy chart", "error");
            }
          };
        }

        // ===== MODALS =====
        function openModal(id) {
          $(id).classList.remove("hidden");
          document.body.style.overflow = "hidden";
        }

        function closeModal(id) {
          $(id).classList.add("hidden");
          document.body.style.overflow = "";
        }

        function setupModals() {
          // Config modal
          $("configBtn").onclick = () => openModal("configModal");
          $("mobileConfigBtn").onclick = () => openModal("configModal");
          $("menuConfigBtn").onclick = () => {
            closeMenu();
            openModal("configModal");
          };
          $("closeConfigBtn").onclick = () => closeModal("configModal");
          $("cancelConfigBtn").onclick = () =>
            closeModal("configModal");
          $("configModalBackdrop").onclick = () =>
            closeModal("configModal");

          // Upload modal
          $("menuUploadBtn").onclick = () => {
            closeMenu();
            openModal("uploadModal");
          };
          $("closeUploadBtn").onclick = () => closeModal("uploadModal");
          $("cancelUploadBtn").onclick = () =>
            closeModal("uploadModal");
          $("uploadModalBackdrop").onclick = () =>
            closeModal("uploadModal");

          // Random modal
          $("menuRandomBtn").onclick = () => {
            closeMenu();
            openModal("randomModal");
          };
          $("runDemoBtn").onclick = () => openModal("randomModal");
          $("closeRandomBtn").onclick = () => closeModal("randomModal");
          $("cancelRandomBtn").onclick = () =>
            closeModal("randomModal");
          $("randomModalBackdrop").onclick = () =>
            closeModal("randomModal");

          // Save/Load modal
          $("menuSaveLoadBtn").onclick = () => {
            closeMenu();
            openModal("saveLoadModal");
          };
          $("loadDemoBtn").onclick = () => openModal("saveLoadModal");
          $("closeSaveLoadBtn").onclick = () =>
            closeModal("saveLoadModal");
          $("saveLoadModalBackdrop").onclick = () =>
            closeModal("saveLoadModal");

          // Insert modal
          $("menuInsertBtn").onclick = () => {
            closeMenu();
            openModal("insertModal");
          };
          $("closeInsertBtn").onclick = () => closeModal("insertModal");
          $("cancelInsertBtn").onclick = () =>
            closeModal("insertModal");
          $("insertModalBackdrop").onclick = () =>
            closeModal("insertModal");

          // Table modal
          $("menuTableBtn").onclick = () => {
            closeMenu();
            openTableModal();
          };
          $("closeTableBtn").onclick = () => closeModal("tableModal");
          $("tableModalBackdrop").onclick = () =>
            closeModal("tableModal");

          // Settings modal
          $("menuSettingsBtn").onclick = () => {
            closeMenu();
            openModal("settingsModal");
          };
          $("closeSettingsBtn").onclick = () =>
            closeModal("settingsModal");
          $("settingsModalBackdrop").onclick = () =>
            closeModal("settingsModal");

          // Help modal
          $("menuHelpBtn").onclick = () => {
            closeMenu();
            openModal("helpModal");
          };
          $("closeHelpBtn").onclick = () => closeModal("helpModal");
          $("helpModalBackdrop").onclick = () =>
            closeModal("helpModal");
        }

        // ===== CONFIG MODAL =====
        function setupConfigModal() {
          // Section toggles
          $$(".section-toggle").forEach((btn) => {
            btn.onclick = () => {
              const content = btn.nextElementSibling;
              const chevron = btn.querySelector(".section-chevron");
              content.classList.toggle("hidden");
              chevron.classList.toggle("rotate-180");
            };
          });

          // Presets
          $$(".preset-btn").forEach((btn) => {
            btn.onclick = () => {
              const preset = btn.dataset.preset;
              applyPreset(preset);
              $$(".preset-btn").forEach((b) => {
                b.className = b === btn
                  ? "preset-btn px-4 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md transition-all hover:scale-105"
                  : "preset-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all";
              });
            };
          });

          $("resetDefaultsBtn").onclick = () => applyPreset("default");
          $("resetAllBtn").onclick = () => {
            applyPreset("default");
            state.modelExists = false;
            state.predictions = null;
            state.sampleCount = 0;
            updateUI();
          };
          $("createModelBtn").onclick = createModel;
        }

        function applyPreset(name) {
          const preset = PRESETS[name] || PRESETS.default;
          state.config = { ...preset };

          // Update form
          $("cfg_reservoirSize").value = preset.reservoirSize;
          $("cfg_spectralRadius").value = preset.spectralRadius;
          $("cfg_leakRate").value = preset.leakRate;
          $("cfg_inputScale").value = preset.inputScale;
          $("cfg_biasScale").value = preset.biasScale;
          $("cfg_reservoirSparsity").value = preset.reservoirSparsity;
          $("cfg_inputSparsity").value = preset.inputSparsity;
          $("cfg_activation").value = preset.activation;
          $("cfg_useInputInReadout").checked = preset.useInputInReadout;
          $("cfg_useBiasInReadout").checked = preset.useBiasInReadout;
          $("cfg_rlsLambda").value = preset.rlsLambda;
          $("cfg_rlsDelta").value = preset.rlsDelta;
          $("cfg_epsilon").value = preset.epsilon;
          $("cfg_l2Lambda").value = preset.l2Lambda;
          $("cfg_gradientClipNorm").value = preset.gradientClipNorm;
          $("cfg_normalizationEpsilon").value =
            preset.normalizationEpsilon;
          $("cfg_normalizationWarmup").value =
            preset.normalizationWarmup;
          $("cfg_outlierThreshold").value = preset.outlierThreshold;
          $("cfg_outlierMinWeight").value = preset.outlierMinWeight;
          $("cfg_uncertaintyMultiplier").value =
            preset.uncertaintyMultiplier;
          $("cfg_weightInitScale").value = preset.weightInitScale;
          $("cfg_seed").value = preset.seed;
          $("cfg_verbose").checked = preset.verbose;
        }

        function getConfigFromForm() {
          return {
            reservoirSize: parseInt($("cfg_reservoirSize").value),
            spectralRadius: parseFloat($("cfg_spectralRadius").value),
            leakRate: parseFloat($("cfg_leakRate").value),
            inputScale: parseFloat($("cfg_inputScale").value),
            biasScale: parseFloat($("cfg_biasScale").value),
            reservoirSparsity: parseFloat(
              $("cfg_reservoirSparsity").value,
            ),
            inputSparsity: parseFloat($("cfg_inputSparsity").value),
            activation: $("cfg_activation").value,
            useInputInReadout: $("cfg_useInputInReadout").checked,
            useBiasInReadout: $("cfg_useBiasInReadout").checked,
            readoutTraining: "rls",
            rlsLambda: parseFloat($("cfg_rlsLambda").value),
            rlsDelta: parseFloat($("cfg_rlsDelta").value),
            epsilon: parseFloat($("cfg_epsilon").value),
            l2Lambda: parseFloat($("cfg_l2Lambda").value),
            gradientClipNorm: parseFloat(
              $("cfg_gradientClipNorm").value,
            ),
            normalizationEpsilon: parseFloat(
              $("cfg_normalizationEpsilon").value,
            ),
            normalizationWarmup: parseInt(
              $("cfg_normalizationWarmup").value,
            ),
            outlierThreshold: parseFloat(
              $("cfg_outlierThreshold").value,
            ),
            outlierMinWeight: parseFloat(
              $("cfg_outlierMinWeight").value,
            ),
            uncertaintyMultiplier: parseFloat(
              $("cfg_uncertaintyMultiplier").value,
            ),
            weightInitScale: parseFloat($("cfg_weightInitScale").value),
            seed: parseInt($("cfg_seed").value),
            verbose: $("cfg_verbose").checked,
          };
        }

        async function createModel() {
          try {
            state.config = getConfigFromForm();
            showLoading("Creating model...");
            await sendWorkerMessage("createModel", {
              config: state.config,
            });
            state.modelExists = true;
            state.sampleCount = 0;
            state.predictions = null;
            closeModal("configModal");
            addLog("success", "Model created successfully");
            showToast(
              "Model created! Upload data to train.",
              "success",
            );
            updateUI();
          } catch (err) {
            addLog("error", err.message);
            showToast(err.message, "error");
          } finally {
            hideLoading();
          }
        }

        // ===== UPLOAD MODAL =====
        function setupUploadModal() {
          const dropZone = $("dropZone");
          const fileInput = $("fileInput");
          const jsonInput = $("jsonInput");
          let validatedData = null;

          dropZone.onclick = () => fileInput.click();
          dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add(
              "border-blue-500",
              "bg-blue-50",
              "dark:bg-blue-900/20",
            );
          };
          dropZone.ondragleave = () =>
            dropZone.classList.remove(
              "border-blue-500",
              "bg-blue-50",
              "dark:bg-blue-900/20",
            );
          dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove(
              "border-blue-500",
              "bg-blue-50",
              "dark:bg-blue-900/20",
            );
            const file = e.dataTransfer.files[0];
            if (file) readFile(file);
          };

          fileInput.onchange = () => {
            if (fileInput.files[0]) readFile(fileInput.files[0]);
          };

          function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              jsonInput.value = e.target.result;
              validateData();
            };
            reader.readAsText(file);
          }

          $("copyExampleBtn").onclick = () => {
            navigator.clipboard.writeText(
              '{"coordinates": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1], [1.2, 2.2, 3.2]]}',
            );
            showToast("Example copied!", "success");
          };

          $("validateUploadBtn").onclick = validateData;
          $("applyUploadBtn").onclick = applyData;

          function validateData() {
            const text = jsonInput.value.trim();
            $("uploadPreview").classList.add("hidden");
            $("uploadError").classList.add("hidden");
            $("applyUploadBtn").disabled = true;
            validatedData = null;

            if (!text) return;

            try {
              const data = JSON.parse(text);
              if (
                !data.coordinates || !Array.isArray(data.coordinates) ||
                data.coordinates.length < 2
              ) {
                throw new Error(
                  "Need at least 2 time steps in coordinates array",
                );
              }
              const dims = data.coordinates[0].length;
              if (
                !dims || data.coordinates.some((s) => s.length !== dims)
              ) {
                throw new Error(
                  "All time steps must have the same number of dimensions",
                );
              }

              validatedData = data;
              $("previewDims").textContent = dims;
              $("previewSteps").textContent = data.coordinates.length;
              $("uploadPreview").classList.remove("hidden");
              $("applyUploadBtn").disabled = false;
            } catch (err) {
              $("uploadError").textContent = err.message;
              $("uploadError").classList.remove("hidden");
            }
          }

          async function applyData() {
            if (!validatedData) return;
            if (!state.modelExists) {
              await createModel();
            }
            await trainOnData(validatedData.coordinates);
            closeModal("uploadModal");
            jsonInput.value = "";
            validatedData = null;
          }
        }

        // ===== TRAINING =====
        async function trainOnData(coordinates) {
          try {
            showLoading(
              `Training on ${coordinates.length} time steps...`,
            );
            state.nDimensions = coordinates[0].length;
            const result = await sendWorkerMessage("train", {
              coordinates,
            });
            state.sampleCount = result.summary?.sampleCount ||
              coordinates.length - 1;
            state.metrics = {
              avgLoss: result.result?.averageLoss || null,
              gradientNorm: result.result?.gradientNorm || null,
              sampleWeight: result.result?.sampleWeight || null,
            };
            addLog(
              "success",
              `Trained on ${coordinates.length} time steps`,
            );
            showToast("Training complete!", "success");
            updateUI();
          } catch (err) {
            addLog("error", err.message);
            showToast(err.message, "error");
          } finally {
            hideLoading();
          }
        }

        // ===== PREDICTION =====
        async function runPrediction() {
          if (!state.modelExists || state.sampleCount === 0) return;
          try {
            const steps = parseInt($("futureStepsInput").value) || 50;
            showLoading(`Predicting ${steps} steps...`);
            const result = await sendWorkerMessage("predict", {
              steps,
            });
            state.predictions = result.result;
            state.zoom = { level: 1, offsetX: 0 };
            addLog("success", `Predicted ${steps} future steps`);
            showToast("Prediction complete!", "success");
            updateUI();
          } catch (err) {
            addLog("error", err.message);
            showToast(err.message, "error");
          } finally {
            hideLoading();
          }
        }

        // ===== RANDOM TEST =====
        function setupRandomModal() {
          $("generateRandomBtn").onclick = async () => {
            const seed = parseInt($("rand_seed").value);
            const dims = parseInt($("rand_dims").value);
            const steps = parseInt($("rand_steps").value);
            const noise = parseFloat($("rand_noise").value);
            const outliers = parseFloat($("rand_outliers").value);
            const difficulty = $("rand_difficulty").value;

            const coordinates = generateSyntheticData(
              seed,
              dims,
              steps,
              noise,
              outliers,
              difficulty,
            );
            closeModal("randomModal");

            if (!state.modelExists) await createModel();
            await trainOnData(coordinates);
            await runPrediction();
          };
        }

        function generateSyntheticData(
          seed,
          dims,
          steps,
          noise,
          outlierRate,
          difficulty,
        ) {
          const rng = seedRandom(seed);
          const freqMult = difficulty === "easy"
            ? 1
            : difficulty === "hard"
            ? 3
            : 2;
          const data = [];

          for (let t = 0; t < steps; t++) {
            const row = [];
            for (let d = 0; d < dims; d++) {
              let v = Math.sin((t + d) * 0.1 * freqMult) *
                (1 + d * 0.2);
              v += Math.cos(t * 0.05 * freqMult + d) * 0.5;
              v += (rng() - 0.5) * noise * 2;
              if (rng() < outlierRate) v += (rng() - 0.5) * 5;
              row.push(v);
            }
            data.push(row);
          }
          return data;
        }

        function seedRandom(seed) {
          let s = seed;
          return () => {
            s = (s * 1103515245 + 12345) & 0x7fffffff;
            return s / 0x7fffffff;
          };
        }

        // ===== SAVE/LOAD =====
        function setupSaveLoadModal() {
          $("downloadModelBtn").onclick = async () => {
            if (!state.modelExists) {
              showToast("No model to save", "warning");
              return;
            }
            try {
              const result = await sendWorkerMessage("save");
              const blob = new Blob([result.result], {
                type: "application/json",
              });
              const link = document.createElement("a");
              link.download = `esn-model-${Date.now()}.json`;
              link.href = URL.createObjectURL(blob);
              link.click();
              showToast("Model downloaded", "success");
            } catch (err) {
              showToast(err.message, "error");
            }
          };

          $("browserSaveBtn").onclick = async () => {
            if (!state.modelExists) {
              showToast("No model to save", "warning");
              return;
            }
            const name = prompt("Model name:", `Model ${Date.now()}`);
            if (!name) return;
            try {
              const result = await sendWorkerMessage("save");
              const saved = JSON.parse(
                localStorage.getItem("esn_models") || "{}",
              );
              saved[name] = {
                data: result.result,
                dims: state.nDimensions,
                date: new Date().toISOString(),
              };
              localStorage.setItem("esn_models", JSON.stringify(saved));
              showToast("Model saved to browser", "success");
              renderSavedModels();
            } catch (err) {
              showToast(err.message, "error");
            }
          };

          const loadDropZone = $("loadDropZone");
          const loadFileInput = $("loadFileInput");
          loadDropZone.onclick = () => loadFileInput.click();
          loadFileInput.onchange = () => {
            if (loadFileInput.files[0]) {
              const reader = new FileReader();
              reader.onload = (e) => loadModel(e.target.result);
              reader.readAsText(loadFileInput.files[0]);
            }
          };

          $("clearSavedBtn").onclick = () => {
            if (confirm("Clear all saved models?")) {
              localStorage.removeItem("esn_models");
              renderSavedModels();
              showToast("Saved models cleared", "success");
            }
          };

          renderSavedModels();
        }

        function renderSavedModels() {
          const saved = JSON.parse(
            localStorage.getItem("esn_models") || "{}",
          );
          const container = $("savedModelsList");
          container.innerHTML =
            Object.entries(saved).map(([name, info]) => `
                <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <div>
                        <p class="font-medium text-sm text-slate-800 dark:text-white">${name}</p>
                        <p class="text-xs text-slate-500">${info.dims} dims</p>
                    </div>
                    <button class="load-saved-btn px-3 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50" data-name="${name}">Load</button>
                </div>
            `).join("") ||
            '<p class="text-sm text-slate-500 text-center py-4">No saved models</p>';

          container.querySelectorAll(".load-saved-btn").forEach(
            (btn) => {
              btn.onclick = () => {
                const name = btn.dataset.name;
                const model = saved[name];
                if (model) loadModel(model.data);
              };
            },
          );
        }

        async function loadModel(data) {
          try {
            showLoading("Loading model...");
            await sendWorkerMessage("load", { data });
            const summary = await sendWorkerMessage("getSummary");
            state.modelExists = true;
            state.nDimensions = summary.result?.nFeatures || 0;
            state.sampleCount = summary.result?.sampleCount || 0;
            state.predictions = null;
            closeModal("saveLoadModal");
            addLog("success", "Model loaded successfully");
            showToast("Model loaded!", "success");
            updateUI();
          } catch (err) {
            addLog("error", err.message);
            showToast(err.message, "error");
          } finally {
            hideLoading();
          }
        }

        // ===== INSERT MODAL =====
        function setupInsertModal() {
          $("genTemplateBtn").onclick = () => {
            const dims = state.nDimensions || 3;
            const template = {
              coordinates: [Array(dims).fill(0), Array(dims).fill(0)],
            };
            $("insertJsonInput").value = JSON.stringify(
              template,
              null,
              2,
            );
          };

          $("applyInsertBtn").onclick = async () => {
            const text = $("insertJsonInput").value.trim();
            if (!text) return;
            try {
              const data = JSON.parse(text);
              if (
                !data.coordinates || !Array.isArray(data.coordinates)
              ) {
                throw new Error("Invalid format");
              }
              if (!state.modelExists) await createModel();
              state.nDimensions = data.coordinates[0].length;
              await trainOnData(data.coordinates);
              closeModal("insertModal");
              $("insertJsonInput").value = "";
            } catch (err) {
              $("insertFeedback").className =
                "p-3 rounded-xl text-sm bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400";
              $("insertFeedback").textContent = err.message;
              $("insertFeedback").classList.remove("hidden");
            }
          };
        }

        // ===== TABLE MODAL =====
        function openTableModal() {
          if (!state.predictions) {
            showToast("No predictions to display", "warning");
            return;
          }
          openModal("tableModal");
          renderTable();
        }

        function renderTable() {
          const preds = state.predictions.predictions;
          const lowers = state.predictions.lowerBounds;
          const uppers = state.predictions.upperBounds;
          const nDims = state.nDimensions;

          // Header
          let headerHtml =
            '<th class="px-3 py-2 text-left text-xs font-bold text-slate-600 dark:text-slate-300 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">Step</th>';
          for (let d = 0; d < nDims; d++) {
            headerHtml +=
              `<th class="px-3 py-2 text-left text-xs font-bold cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600" style="color:${
                DIM_COLORS[d % DIM_COLORS.length]
              }">P${d + 1}</th>`;
          }
          for (let d = 0; d < nDims; d++) {
            headerHtml +=
              `<th class="px-3 py-2 text-left text-xs font-bold text-slate-500 dark:text-slate-400 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">L${
                d + 1
              }</th>`;
          }
          for (let d = 0; d < nDims; d++) {
            headerHtml +=
              `<th class="px-3 py-2 text-left text-xs font-bold text-slate-500 dark:text-slate-400 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">U${
                d + 1
              }</th>`;
          }
          $("tableHeader").innerHTML = headerHtml;

          // Body
          const search = $("tableSearch").value.toLowerCase();
          let bodyHtml = "";
          for (let s = 0; s < preds.length; s++) {
            const rowText = `${s + 1} ${preds[s].join(" ")}`
              .toLowerCase();
            if (search && !rowText.includes(search)) continue;

            bodyHtml += `<tr class="${
              s % 2 ? "bg-slate-50 dark:bg-slate-700/30" : ""
            } hover:bg-blue-50 dark:hover:bg-blue-900/20">`;
            bodyHtml +=
              `<td class="px-3 py-2 text-slate-600 dark:text-slate-300">${
                s + 1
              }</td>`;
            for (let d = 0; d < nDims; d++) {
              bodyHtml += `<td class="px-3 py-2" style="color:${
                DIM_COLORS[d % DIM_COLORS.length]
              }">${preds[s][d].toFixed(4)}</td>`;
            }
            for (let d = 0; d < nDims; d++) {
              bodyHtml +=
                `<td class="px-3 py-2 text-slate-500 dark:text-slate-400">${
                  lowers[s][d].toFixed(4)
                }</td>`;
            }
            for (let d = 0; d < nDims; d++) {
              bodyHtml +=
                `<td class="px-3 py-2 text-slate-500 dark:text-slate-400">${
                  uppers[s][d].toFixed(4)
                }</td>`;
            }
            bodyHtml += "</tr>";
          }
          $("tableBody").innerHTML = bodyHtml;
        }

        function setupTableModal() {
          $("tableSearch").oninput = () => renderTable();

          $("exportCsvBtn").onclick = () => {
            if (!state.predictions) return;
            const preds = state.predictions.predictions;
            const lowers = state.predictions.lowerBounds;
            const uppers = state.predictions.upperBounds;
            const nDims = state.nDimensions;

            let csv = "Step," +
              Array.from({ length: nDims }, (_, i) => `P${i + 1}`).join(
                ",",
              );
            csv += "," +
              Array.from({ length: nDims }, (_, i) => `L${i + 1}`).join(
                ",",
              );
            csv += "," +
              Array.from({ length: nDims }, (_, i) => `U${i + 1}`).join(
                ",",
              ) +
              "\n";

            for (let s = 0; s < preds.length; s++) {
              csv += `${s + 1},${preds[s].join(",")},${
                lowers[s].join(",")
              },${uppers[s].join(",")}\n`;
            }

            const blob = new Blob([csv], { type: "text/csv" });
            const link = document.createElement("a");
            link.download = `esn-predictions-${Date.now()}.csv`;
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast("CSV exported", "success");
          };

          $("copyAllBtn").onclick = () => {
            if (!state.predictions) return;
            const text = JSON.stringify(state.predictions, null, 2);
            navigator.clipboard.writeText(text);
            showToast("Data copied to clipboard", "success");
          };
        }

        // ===== SETTINGS =====
        function setupSettingsModal() {
          $("moduleUrlInput").value = state.moduleUrl;

          $("reinitWorkerBtn").onclick = () => {
            state.moduleUrl = $("moduleUrlInput").value;
            localStorage.setItem("esn_moduleUrl", state.moduleUrl);
            initWorker();
            showToast("Worker reinitialized", "success");
          };

          $("clearPrefsBtn").onclick = () => {
            if (confirm("Clear all preferences and reload?")) {
              localStorage.clear();
              location.reload();
            }
          };
        }

        // ===== MENU =====
        function openMenu() {
          $("mainMenu").classList.remove("translate-x-full");
          $("menuOverlay").classList.remove("hidden");
        }

        function closeMenu() {
          $("mainMenu").classList.add("translate-x-full");
          $("menuOverlay").classList.add("hidden");
        }

        function setupMenu() {
          $("menuBtn").onclick = openMenu;
          $("closeMenuBtn").onclick = closeMenu;
          $("menuOverlay").onclick = closeMenu;
        }

        // ===== SIDE PANEL =====
        function setupSidePanel() {
          $("mobilePanelBtn").onclick = () => {
            $("sidePanel").classList.remove("translate-x-full");
            $("panelOverlay").classList.remove("hidden");
          };

          $("closePanelBtn").onclick = () => {
            $("sidePanel").classList.add("translate-x-full");
            $("panelOverlay").classList.add("hidden");
          };

          $("panelOverlay").onclick = () => {
            $("sidePanel").classList.add("translate-x-full");
            $("panelOverlay").classList.add("hidden");
          };

          $("logFilter").onchange = renderLogs;
          $("logSearch").oninput = renderLogs;
        }

        // ===== VIZ TABS =====
        function setupVizTabs() {
          $$(".viz-tab").forEach((btn) => {
            btn.onclick = () => {
              state.vizMode = btn.dataset.mode;
              $$(".viz-tab").forEach((b) => {
                b.className = b === btn
                  ? "viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/30"
                  : "viz-tab touch-target flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold transition-all bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";
              });
              updateUI();
            };
          });

          $("stepInput").oninput = () => {
            state.selectedStep = parseInt($("stepInput").value) || 1;
            renderChart();
          };
        }

        // ===== MAIN ACTIONS =====
        function setupMainActions() {
          $("predictBtn").onclick = runPrediction;
          $("mobilePredictBtn").onclick = runPrediction;
          $("runPredictBtn").onclick = runPrediction;
          $("startDefaultBtn").onclick = async () => {
            await createModel();
          };
          $("themeToggle").onclick = () => {
            state.isDark = !state.isDark;
            applyTheme();
            renderChart();
          };
          $("cancelLoadingBtn").onclick = () => hideLoading();
        }

        // ===== RESIZE HANDLER =====
        function setupResizeHandler() {
          let resizeTimeout;
          window.addEventListener("resize", () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => renderChart(), 100);
          });
        }

        // ===== INIT =====
        function init() {
          applyTheme();
          initWorker();
          setupModals();
          setupConfigModal();
          setupUploadModal();
          setupRandomModal();
          setupSaveLoadModal();
          setupInsertModal();
          setupTableModal();
          setupSettingsModal();
          setupMenu();
          setupSidePanel();
          setupVizTabs();
          setupMainActions();
          setupChartInteractions();
          setupExportButtons();
          setupResizeHandler();
          applyPreset("default");
          updateUI();
          addLog("info", "ESN Regression Studio initialized");
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>
