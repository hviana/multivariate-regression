<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- Toasts -->
    <div
      id="toastHost"
      class="fixed bottom-4 left-0 right-0 z-[60] flex flex-col items-center gap-2 px-4"
      aria-live="polite"
    >
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[55]">
      <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
      <div
        class="relative mx-auto mt-28 w-[92vw] max-w-md rounded-2xl bg-white shadow-2xl border border-slate-200 p-5"
      >
        <div class="flex items-start gap-3">
          <div
            class="mt-0.5 h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xl"
            aria-hidden="true"
          >
            ‚è≥
          </div>
          <div class="flex-1">
            <div class="text-sm font-semibold text-slate-900">Processing‚Ä¶</div>
            <div id="loadingText" class="mt-1 text-sm text-slate-600">
              Working‚Ä¶
            </div>
            <div class="mt-4">
              <div
                class="h-2 w-full rounded-full bg-slate-100 overflow-hidden"
                role="progressbar"
                aria-label="Progress"
              >
                <div
                  id="loadingBar"
                  class="h-2 w-0 bg-gradient-to-r from-blue-500 to-indigo-500"
                >
                </div>
              </div>
              <div
                class="mt-2 flex items-center justify-between text-xs text-slate-500"
              >
                <div id="loadingPct">0%</div>
                <button
                  id="btnCancelOp"
                  class="px-3 py-1.5 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300"
                  aria-label="Cancel operation"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 text-xs text-slate-500">
          If the Worker is unavailable, ESN Studio will attempt a slower in-page
          fallback.
        </div>
      </div>
    </div>

    <!-- Slide-out Menu -->
    <div id="menuWrap" class="hidden fixed inset-0 z-[50]" aria-hidden="true">
      <div
        id="menuBackdrop"
        class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"
      >
      </div>
      <aside
        id="menuPanel"
        class="absolute right-0 top-0 h-full w-[88vw] max-w-sm bg-white shadow-2xl border-l border-slate-200 flex flex-col"
      >
        <div
          class="p-5 border-b border-slate-200 flex items-center justify-between"
        >
          <div>
            <div class="text-sm font-bold tracking-tight">‚ò∞ Menu</div>
            <div class="text-xs text-slate-500">Shortcuts & tools</div>
          </div>
          <button
            id="btnCloseMenu"
            class="h-10 w-10 rounded-xl bg-slate-100 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
            aria-label="Close menu"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <div class="p-4 space-y-5 overflow-auto">
          <section>
            <div
              class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
            >
              üìÅ Model
            </div>
            <div class="mt-2 space-y-2">
              <button
                data-action="openConfig"
                class="w-full text-left p-4 rounded-2xl bg-blue-50 border border-blue-100 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-300"
                aria-label="Create and configure model"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-blue-500 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üéõÔ∏è
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Create & Configure</div>
                    <div class="text-sm text-slate-600">
                      Set up model parameters
                    </div>
                  </div>
                </div>
              </button>
              <button
                data-action="openSaveLoad"
                class="w-full text-left p-4 rounded-2xl bg-emerald-50 border border-emerald-100 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                aria-label="Save and load model"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üíæ
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Save & Load</div>
                    <div class="text-sm text-slate-600">
                      Persist your models
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </section>

          <section>
            <div
              class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
            >
              üìÇ Data
            </div>
            <div class="mt-2 space-y-2">
              <button
                data-action="openUpload"
                class="w-full text-left p-4 rounded-2xl bg-purple-50 border border-purple-100 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-300"
                aria-label="Upload dataset"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-purple-500 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üì§
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Upload Dataset</div>
                    <div class="text-sm text-slate-600">
                      Import time series data
                    </div>
                  </div>
                </div>
              </button>
              <button
                data-action="openManual"
                class="w-full text-left p-4 rounded-2xl bg-amber-50 border border-amber-100 hover:bg-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-300"
                aria-label="Manual insert"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-amber-500 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    ‚ûï
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Manual Insert</div>
                    <div class="text-sm text-slate-600">
                      Add individual time steps
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </section>

          <section>
            <div
              class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
            >
              üß™ Test
            </div>
            <div class="mt-2 space-y-2">
              <button
                data-action="openRandom"
                class="w-full text-left p-4 rounded-2xl bg-pink-50 border border-pink-100 hover:bg-pink-100 focus:outline-none focus:ring-2 focus:ring-pink-300"
                aria-label="Random test"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-pink-500 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üí°
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Random Test</div>
                    <div class="text-sm text-slate-600">
                      Generate synthetic time series
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </section>

          <section>
            <div
              class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
            >
              ‚öôÔ∏è Advanced
            </div>
            <div class="mt-2 space-y-2">
              <button
                data-action="openSettings"
                class="w-full text-left p-4 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300"
                aria-label="Settings"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-slate-700 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üîß
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Settings</div>
                    <div class="text-sm text-slate-600">
                      Module URL & preferences
                    </div>
                  </div>
                </div>
              </button>
              <button
                data-action="openTable"
                class="w-full text-left p-4 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300"
                aria-label="View data table"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-slate-700 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    üìã
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">View Data Table</div>
                    <div class="text-sm text-slate-600">
                      Raw prediction values
                    </div>
                  </div>
                </div>
              </button>
              <button
                data-action="openHelp"
                class="w-full text-left p-4 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-300"
                aria-label="Help"
              >
                <div class="flex gap-3">
                  <div
                    class="h-10 w-10 rounded-xl bg-slate-700 text-white flex items-center justify-center text-xl"
                    aria-hidden="true"
                  >
                    ‚ùì
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold">Help</div>
                    <div class="text-sm text-slate-600">Docs & examples</div>
                  </div>
                </div>
              </button>
            </div>
          </section>
        </div>
      </aside>
    </div>

    <!-- Header -->
    <header
      class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-slate-200/60"
    >
      <div
        class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3"
      >
        <div class="flex items-center gap-3 min-w-0">
          <div
            class="h-12 w-12 rounded-xl shadow-lg shadow-blue-500/30 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center text-white text-2xl"
            aria-hidden="true"
          >
            üìä
          </div>
          <div class="min-w-0">
            <div
              class="font-extrabold tracking-tight text-slate-900 leading-tight"
            >
              ESN Studio
            </div>
            <div class="text-xs text-slate-600">Autoregressive Forecasting</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div
            id="modelBadge"
            class="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 border border-slate-200"
          >
            <span
              id="modelDot"
              class="h-2.5 w-2.5 rounded-full bg-slate-400 animate-pulse"
              aria-hidden="true"
            ></span>
            <span
              id="modelBadgeText"
              class="text-xs font-semibold text-slate-700"
            >No Model</span>
          </div>

          <button
            id="btnPredictHeader"
            class="hidden px-3 py-2 rounded-xl font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
            aria-label="Predict"
          >
            ‚ö° Predict
          </button>

          <button
            id="btnConfig"
            class="h-11 w-11 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
            aria-label="Configure model"
          >
            ‚öôÔ∏è
          </button>

          <button
            id="btnMenu"
            class="h-11 w-11 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
            aria-label="Open menu"
          >
            ‚ò∞
          </button>
        </div>
      </div>
    </header>

    <!-- App -->
    <main class="max-w-7xl mx-auto px-4 py-4">
      <!-- Tabs -->
      <div
        class="flex gap-2 overflow-x-auto pb-2"
        aria-label="Visualization modes"
      >
        <button
          class="vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20 focus:outline-none focus:ring-2 focus:ring-blue-300"
          data-mode="grid"
          aria-label="Small multiples grid"
        >
          üìä Grid
        </button>
        <button
          class="vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
          data-mode="focus"
          aria-label="Focus view"
        >
          üîç Focus
        </button>
        <button
          class="vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
          data-mode="heatmap"
          aria-label="Heatmap"
        >
          üå°Ô∏è Heatmap
        </button>
        <button
          class="vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
          data-mode="ci"
          aria-label="Uncertainty"
        >
          üìà CI
        </button>
        <button
          class="vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
          data-mode="snapshot"
          aria-label="Snapshot"
        >
          üì∑ Snapshot
        </button>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Visualization -->
        <section class="lg:col-span-2">
          <div
            class="rounded-2xl bg-white shadow-xl border border-slate-200 overflow-hidden"
          >
            <div
              class="px-4 py-3 border-b border-slate-200 flex items-center justify-between gap-3"
            >
              <div class="min-w-0">
                <div id="vizTitle" class="font-bold tracking-tight">
                  üìä Small Multiples
                </div>
                <div id="vizSubtitle" class="text-xs text-slate-600">
                  All dimensions at a glance
                </div>
              </div>

              <div id="exportControls" class="hidden items-center gap-2">
                <button
                  id="btnSavePng"
                  class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                  aria-label="Save as PNG"
                >
                  üñºÔ∏è
                </button>
                <button
                  id="btnSaveSvg"
                  class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                  aria-label="Save as SVG"
                >
                  üìÑ
                </button>
                <button
                  id="btnCopy"
                  class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                  aria-label="Copy to clipboard"
                >
                  üìã
                </button>
              </div>
            </div>

            <!-- Focus Mode Dimension Selector -->
            <div
              id="dimSelectorWrap"
              class="hidden px-4 py-3 border-b border-slate-200"
            >
              <div
                class="text-xs uppercase tracking-wider text-slate-500 font-semibold mb-2"
              >
                Dimension
              </div>
              <div
                id="dimSelector"
                class="flex gap-2 overflow-x-auto pb-1"
                aria-label="Dimension selector"
              >
              </div>
            </div>

            <!-- Snapshot Mode Step Selector -->
            <div
              id="stepSelectorWrap"
              class="hidden px-4 py-3 border-b border-slate-200"
            >
              <div class="flex items-center gap-3">
                <div
                  class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
                >
                  Step:
                </div>
                <input
                  id="inputSnapshotStep"
                  type="number"
                  class="w-28 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
                  aria-label="Snapshot step"
                  min="0"
                  value="0"
                />
                <div id="stepHint" class="text-xs text-slate-500"></div>
              </div>
              <div id="stepValidation" class="hidden mt-2 text-sm text-red-600">
              </div>
            </div>

            <!-- Stats Bar (Focus Mode) -->
            <div
              id="statsBar"
              class="hidden px-4 py-3 border-b border-slate-200"
            >
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Min
                  </div>
                  <div id="statMin" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Max
                  </div>
                  <div id="statMax" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Mean
                  </div>
                  <div id="statMean" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Final
                  </div>
                  <div id="statFinal" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Trend
                  </div>
                  <div id="statTrend" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
                <div
                  class="rounded-2xl bg-white/70 backdrop-blur border border-slate-200 p-3"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold"
                  >
                    Confidence
                  </div>
                  <div id="statConf" class="mt-1 text-sm font-bold">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="relative">
              <!-- Canvas -->
              <canvas
                id="chart"
                class="block w-full h-[56vh] sm:h-[58vh] bg-white"
                aria-label="Chart canvas"
              ></canvas>

              <!-- Floating Controls -->
              <div
                id="floatControls"
                class="hidden absolute inset-0 pointer-events-none"
              >
                <div class="absolute top-3 left-3 pointer-events-auto">
                  <div
                    class="px-3 py-2 rounded-xl bg-white/80 backdrop-blur border border-slate-200 shadow-lg"
                  >
                    <div class="text-xs text-slate-500 font-semibold">Zoom</div>
                    <div id="zoomBadge" class="text-sm font-extrabold">
                      100%
                    </div>
                  </div>
                </div>
                <div
                  class="absolute top-3 right-3 flex flex-col gap-2 pointer-events-auto"
                >
                  <button
                    id="btnZoomIn"
                    class="h-11 w-11 rounded-xl bg-white/90 backdrop-blur border border-slate-200 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"
                    aria-label="Zoom in"
                  >
                    ‚ûï
                  </button>
                  <button
                    id="btnZoomOut"
                    class="h-11 w-11 rounded-xl bg-white/90 backdrop-blur border border-slate-200 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"
                    aria-label="Zoom out"
                  >
                    ‚ûñ
                  </button>
                  <button
                    id="btnZoomReset"
                    class="h-11 w-11 rounded-xl bg-white/90 backdrop-blur border border-slate-200 shadow-lg hover:bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"
                    aria-label="Reset zoom"
                  >
                    üîÑ
                  </button>
                </div>
              </div>

              <!-- Tooltip -->
              <div
                id="tooltip"
                class="hidden absolute z-10 pointer-events-none"
              >
                <div
                  class="rounded-2xl bg-slate-900/90 text-white shadow-2xl border border-white/10 px-4 py-3 w-[240px]"
                >
                  <div class="flex items-center justify-between gap-2">
                    <div class="text-xs text-white/70">Step</div>
                    <div id="tipStep" class="text-sm font-extrabold">‚Äî</div>
                  </div>
                  <div class="mt-2 flex items-center gap-2">
                    <div
                      id="tipDot"
                      class="h-2.5 w-2.5 rounded-full bg-blue-400"
                    >
                    </div>
                    <div id="tipDim" class="text-xs text-white/70">D1</div>
                  </div>
                  <div class="mt-2">
                    <div class="text-xs text-white/70">Predicted</div>
                    <div
                      id="tipVal"
                      class="text-lg font-extrabold tracking-tight"
                    >
                      ‚Äî
                    </div>
                  </div>
                  <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                    <div class="rounded-xl bg-white/10 px-2 py-2">
                      <div class="text-white/70">CI</div>
                      <div id="tipCI" class="mt-0.5 font-semibold">‚Äî</div>
                    </div>
                    <div class="rounded-xl bg-white/10 px-2 py-2">
                      <div class="text-white/70">Spread</div>
                      <div id="tipSpread" class="mt-0.5 font-semibold">‚Äî</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div
                id="emptyState"
                class="absolute inset-0 flex items-center justify-center p-6"
              >
                <div class="w-full max-w-md">
                  <div class="relative">
                    <div
                      class="absolute -inset-4 rounded-[32px] bg-gradient-to-br from-blue-500/10 via-indigo-500/10 to-purple-600/10"
                    >
                    </div>
                    <div
                      class="absolute -inset-2 rounded-[28px] bg-gradient-to-br from-emerald-500/10 via-cyan-500/10 to-blue-500/10"
                    >
                    </div>
                    <div
                      class="relative rounded-3xl bg-white border border-slate-200 shadow-2xl p-6"
                    >
                      <div class="text-5xl" aria-hidden="true">üìä</div>
                      <div class="mt-3 text-xl font-extrabold tracking-tight">
                        Create a Model to Begin
                      </div>
                      <div class="mt-2 text-sm text-slate-600">
                        ESN Studio runs an Echo State Network (ESN) readout for
                        multivariate autoregressive forecasting with confidence
                        intervals.
                      </div>
                      <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button
                          id="btnStartDefaults"
                          class="px-4 py-3 rounded-2xl font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-300"
                          aria-label="Start with defaults"
                        >
                          ‚ö° Start
                        </button>
                        <button
                          id="btnLoadQuick"
                          class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                          aria-label="Load"
                        >
                          üì§ Load
                        </button>
                        <button
                          id="btnDemo"
                          class="px-4 py-3 rounded-2xl font-bold text-white bg-gradient-to-r from-purple-600 to-pink-500 shadow-lg shadow-pink-500/20 hover:from-purple-700 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-purple-300"
                          aria-label="Demo"
                        >
                          ‚ú® Demo
                        </button>
                      </div>
                      <div class="mt-4 text-xs text-slate-500">
                        Tip: Upload a JSON dataset or generate a Random Test to
                        train instantly.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Side Panel -->
        <aside class="lg:col-span-1 space-y-4">
          <!-- Model Metrics -->
          <div
            class="rounded-2xl bg-white shadow-xl border border-slate-200 p-4"
          >
            <div class="flex items-center justify-between">
              <div
                class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
              >
                Model Metrics
              </div>
              <button
                id="btnRefreshSummary"
                class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                aria-label="Refresh model summary"
              >
                üîÑ
              </button>
            </div>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex items-center justify-between">
                <div class="text-slate-600">Samples Trained</div>
                <div id="metricSamples" class="font-extrabold text-blue-600">
                  0
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="text-slate-600">Avg Loss</div>
                <div id="metricLoss" class="font-bold tabular-nums">‚Äî</div>
              </div>
              <div class="flex items-center justify-between">
                <div class="text-slate-600">Gradient Norm</div>
                <div id="metricGrad" class="font-bold tabular-nums">‚Äî</div>
              </div>
              <div class="flex items-center justify-between">
                <div class="text-slate-600">Sample Weight</div>
                <div id="metricWeight" class="font-bold tabular-nums">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Prediction -->
          <div
            class="rounded-2xl bg-white shadow-xl border border-slate-200 p-4"
          >
            <div
              class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
            >
              Prediction
            </div>
            <div class="mt-3">
              <label
                class="text-sm font-semibold text-slate-700"
                for="inputFutureSteps"
              >Future Steps</label>
              <input
                id="inputFutureSteps"
                type="number"
                min="1"
                value="150"
                class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
                aria-label="Future steps"
              />
              <div
                id="futureStepsValidation"
                class="hidden mt-2 text-sm text-red-600"
              >
              </div>
            </div>
            <button
              id="btnRunPredict"
              class="mt-3 w-full px-4 py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 hover:from-blue-600 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-300"
              aria-label="Run prediction"
              disabled
            >
              ‚ö° Run Prediction
            </button>
          </div>

          <!-- Event Log -->
          <div
            class="rounded-2xl bg-white shadow-xl border border-slate-200 p-4"
          >
            <div class="flex items-center justify-between gap-2">
              <div
                class="text-xs uppercase tracking-wider text-slate-500 font-semibold"
              >
                Event Log
              </div>
              <button
                id="btnClearLog"
                class="px-3 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
                aria-label="Clear log"
              >
                üßπ
              </button>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <select
                id="logFilter"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
                aria-label="Log filter"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
              <input
                id="logSearch"
                type="text"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
                placeholder="Search‚Ä¶"
                aria-label="Search logs"
              />
            </div>

            <div
              id="logList"
              class="mt-3 h-[240px] overflow-auto space-y-2"
              aria-label="Log entries"
            >
            </div>
            <div class="mt-2 text-[11px] text-slate-500">
              Showing latest 50 (stores up to 200).
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- MODALS -->
    <!-- Modal Shell -->
    <div id="modalHost" class="hidden fixed inset-0 z-[58]" aria-hidden="true">
    </div>

    <script>
      // =========================
      // State + Persistence
      // =========================
      const DIM_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const DEFAULT_MODULE_URL =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.4";

      const DEFAULT_CONFIG = {
        // Reservoir Architecture
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        // Readout Configuration
        useInputInReadout: true,
        useBiasInReadout: true,
        // Training (RLS)
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        // Normalization
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        // Outlier Handling
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        // Uncertainty
        uncertaintyMultiplier: 1.96,
        // Initialization
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        "Start Here": (c) => ({
          ...c,
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
        }),
        "Fast": (c) => ({
          ...c,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        }),
        "Balanced": (c) => ({
          ...c,
          reservoirSize: 256,
          spectralRadius: 0.9,
        }),
        "Accurate": (c) => ({
          ...c,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        }),
        "Adaptive": (c) => ({
          ...c,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        }),
        "Robust": (c) => ({
          ...c,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        }),
      };

      const LS_KEYS = {
        config: "esnStudio.config.v1",
        vizMode: "esnStudio.vizMode.v1",
        moduleUrl: "esnStudio.moduleUrl.v1",
        savedModels: "esnStudio.savedModels.v1",
      };

      const appState = {
        config: loadLS(LS_KEYS.config, DEFAULT_CONFIG),
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null, // {predictions, lowerBounds, upperBounds, confidence}
        vizMode: loadLS(LS_KEYS.vizMode, "grid"),
        selectedDim: 0,
        selectedStep: 0,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        dataset: null, // { coordinates: number[][] }
        moduleUrl: loadLS(LS_KEYS.moduleUrl, DEFAULT_MODULE_URL),
        workerOk: true,
        activeOp: { requestId: null, type: null },
      };

      function loadLS(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return structuredClone(fallback);
          return JSON.parse(raw);
        } catch {
          return structuredClone(fallback);
        }
      }
      function saveLS(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      // =========================
      // DOM helpers
      // =========================
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const chart = $("#chart");
      const ctx = chart.getContext("2d");

      function nowTime() {
        const d = new Date();
        return d.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      // =========================
      // Toasts + Logging
      // =========================
      function pushLog(level, message) {
        const entry = { level, message, ts: new Date().toISOString() };
        appState.logs.push(entry);
        if (appState.logs.length > 200) {
          appState.logs.splice(0, appState.logs.length - 200);
        }
        renderLogs();
      }

      function toast(level, message) {
        const host = $("#toastHost");
        const colors = {
          info: "bg-blue-600",
          success: "bg-emerald-600",
          warning: "bg-amber-600",
          error: "bg-red-600",
        };
        const duration = level === "error" ? 6000 : 4000;

        const el = document.createElement("div");
        el.className = `w-full max-w-md ${
          colors[level] || colors.info
        } text-white shadow-2xl rounded-2xl border border-white/10 px-4 py-3 flex items-start justify-between gap-3`;
        el.setAttribute("role", "status");
        el.innerHTML = `
        <div class="text-sm font-semibold leading-snug">${
          escapeHtml(message)
        }</div>
        <button class="shrink-0 h-9 w-9 rounded-xl bg-white/15 hover:bg-white/25 focus:outline-none focus:ring-2 focus:ring-white/40" aria-label="Close toast">‚úñÔ∏è</button>
      `;
        const btn = el.querySelector("button");
        btn.addEventListener("click", () => el.remove());
        host.appendChild(el);

        setTimeout(() => {
          if (el.isConnected) el.remove();
        }, duration);
      }

      function errorToast(err, context = "Error") {
        const msg = `${context}: ${
          err?.message ? err.message : String(err)
        }`;
        toast("error", msg);
        pushLog("error", msg);
        console.error(err);
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        }[c]));
      }

      // =========================
      // Worker / Fallback Engine
      // =========================
      function createInlineWorker() {
        const workerSrc = `
        let ESNRegression = null;
        let model = null;
        let moduleUrl = null;
        let canceledToken = 0;
        let runningToken = 0;

        function ok(requestId, data) {
          postMessage({ type: "result", requestId, ok: true, data });
        }
        function fail(requestId, error) {
          postMessage({ type: "result", requestId, ok: false, error: error && error.message ? error.message : String(error) });
        }
        function progress(requestId, percent, message, metrics) {
          postMessage({ type: "progress", requestId, percent, message, metrics });
        }

        async function ensureImported(url) {
          if (ESNRegression && moduleUrl === url) return;
          moduleUrl = url;
          const mod = await import(url);
          ESNRegression = mod.ESNRegression || mod.default || mod;
          if (!ESNRegression) throw new Error("ESNRegression export not found in module.");
        }

        self.onmessage = async (e) => {
          const msg = e.data || {};
          const { type, requestId } = msg;
          try {
            if (type === "init") {
              await ensureImported(msg.moduleUrl);
              ok(requestId, { ready: true, moduleUrl });
              return;
            }
            if (type === "reset") {
              model = null;
              ok(requestId, { reset: true });
              return;
            }
            if (type === "cancel") {
              canceledToken++;
              ok(requestId, { canceled: true });
              return;
            }

            if (!moduleUrl) throw new Error("Worker not initialized. Send init first.");
            await ensureImported(moduleUrl);

            if (type === "createModel") {
              model = new ESNRegression(msg.config);
              ok(requestId, { created: true });
              return;
            }
            if (!model) throw new Error("No model exists. Create a model first.");

            if (type === "train") {
              const coords = msg.coordinates;
              if (!Array.isArray(coords) || coords.length < 2) throw new Error("Training requires coordinates with at least 2 time steps.");
              const token = ++runningToken;
              const localCancel = canceledToken;

              const chunkSize = Math.max(2, msg.chunkSize || 32);

              let lastMetrics = null;
              for (let i = 0; i < coords.length - 1; i += chunkSize) {
                if (token !== runningToken) throw new Error("A newer operation replaced this training run.");
                if (canceledToken !== localCancel) throw new Error("Training canceled.");

                const end = Math.min(coords.length, i + chunkSize);
                const slice = coords.slice(i, end);
                if (slice.length < 2) break;

                const res = model.fitOnline({ coordinates: slice });
                lastMetrics = res;

                const pct = Math.round((end / coords.length) * 100);
                progress(requestId, pct, "Training‚Ä¶", {
                  avgLoss: res?.averageLoss ?? null,
                  gradientNorm: res?.gradientNorm ?? null,
                  sampleWeight: res?.sampleWeight ?? null
                });

                await new Promise(r => setTimeout(r, 0));
              }

              ok(requestId, { trained: true, metrics: lastMetrics });
              return;
            }

            if (type === "predict") {
              const steps = msg.futureSteps;
              const res = model.predict(steps);
              ok(requestId, res);
              return;
            }

            if (type === "save") {
              const state = model.save();
              ok(requestId, { state });
              return;
            }

            if (type === "load") {
              model.load(msg.state);
              ok(requestId, { loaded: true });
              return;
            }

            if (type === "getSummary") {
              const summary = model.getModelSummary();
              ok(requestId, { summary });
              return;
            }

            throw new Error("Unknown message type: " + type);
          } catch (err) {
            fail(requestId, err);
          }
        };
      `;
        const blob = new Blob([workerSrc], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const w = new Worker(url, { type: "module" });
        w._revokeUrl = () => URL.revokeObjectURL(url);
        return w;
      }

      // Fallback engine on main thread (same message contract)
      function createFallbackEngine() {
        let ESNRegression = null;
        let model = null;
        let moduleUrl = null;
        let canceledToken = 0;
        let runningToken = 0;

        async function ensureImported(url) {
          if (ESNRegression && moduleUrl === url) return;
          moduleUrl = url;
          const mod = await import(url);
          ESNRegression = mod.ESNRegression || mod.default || mod;
          if (!ESNRegression) {
            throw new Error(
              "ESNRegression export not found in module.",
            );
          }
        }

        const listeners = new Set();
        function emit(msg) {
          listeners.forEach((fn) => fn({ data: msg }));
        }

        return {
          addEventListener(type, fn) {
            if (type === "message") listeners.add(fn);
          },
          removeEventListener(type, fn) {
            if (type === "message") listeners.delete(fn);
          },
          terminate() {},
          async postMessage(msg) {
            const { type, requestId } = msg || {};
            const ok = (data) =>
              emit({ type: "result", requestId, ok: true, data });
            const fail = (error) =>
              emit({
                type: "result",
                requestId,
                ok: false,
                error: error?.message ? error.message : String(error),
              });
            const progress = (percent, message, metrics) =>
              emit({
                type: "progress",
                requestId,
                percent,
                message,
                metrics,
              });

            try {
              if (type === "init") {
                await ensureImported(msg.moduleUrl);
                ok({ ready: true, moduleUrl });
                return;
              }
              if (type === "reset") {
                model = null;
                ok({ reset: true });
                return;
              }
              if (type === "cancel") {
                canceledToken++;
                ok({ canceled: true });
                return;
              }

              if (!moduleUrl) {
                throw new Error(
                  "Engine not initialized. Send init first.",
                );
              }
              await ensureImported(moduleUrl);

              if (type === "createModel") {
                model = new ESNRegression(msg.config);
                ok({ created: true });
                return;
              }
              if (!model) {
                throw new Error(
                  "No model exists. Create a model first.",
                );
              }

              if (type === "train") {
                const coords = msg.coordinates;
                if (!Array.isArray(coords) || coords.length < 2) {
                  throw new Error(
                    "Training requires coordinates with at least 2 time steps.",
                  );
                }
                const token = ++runningToken;
                const localCancel = canceledToken;
                const chunkSize = Math.max(2, msg.chunkSize || 32);
                let lastMetrics = null;

                for (let i = 0; i < coords.length - 1; i += chunkSize) {
                  if (token !== runningToken) {
                    throw new Error(
                      "A newer operation replaced this training run.",
                    );
                  }
                  if (canceledToken !== localCancel) {
                    throw new Error("Training canceled.");
                  }

                  const end = Math.min(coords.length, i + chunkSize);
                  const slice = coords.slice(i, end);
                  if (slice.length < 2) break;

                  const res = model.fitOnline({ coordinates: slice });
                  lastMetrics = res;

                  const pct = Math.round((end / coords.length) * 100);
                  progress(pct, "Training‚Ä¶", {
                    avgLoss: res?.averageLoss ?? null,
                    gradientNorm: res?.gradientNorm ?? null,
                    sampleWeight: res?.sampleWeight ?? null,
                  });

                  await new Promise((r) => setTimeout(r, 0));
                }

                ok({ trained: true, metrics: lastMetrics });
                return;
              }

              if (type === "predict") {
                ok(model.predict(msg.futureSteps));
                return;
              }
              if (type === "save") {
                ok({ state: model.save() });
                return;
              }
              if (type === "load") {
                model.load(msg.state);
                ok({ loaded: true });
                return;
              }
              if (type === "getSummary") {
                ok({ summary: model.getModelSummary() });
                return;
              }

              throw new Error("Unknown message type: " + type);
            } catch (err) {
              fail(err);
            }
          },
        };
      }

      const Engine = {
        worker: null,
        pending: new Map(),
        async init() {
          try {
            if (this.worker && this.worker.terminate) {
              this.worker.terminate();
            }
            appState.workerOk = true;

            let w;
            try {
              w = createInlineWorker();
            } catch (err) {
              appState.workerOk = false;
              pushLog(
                "warning",
                "Worker creation failed; using fallback engine.",
              );
              w = createFallbackEngine();
            }

            this.worker = w;
            w.addEventListener("message", (e) => {
              const msg = e.data || {};
              if (msg.type === "progress") {
                handleProgress(msg);
                return;
              }
              if (msg.type === "result") {
                const { requestId, ok, data, error } = msg;
                const p = this.pending.get(requestId);
                if (!p) return;
                this.pending.delete(requestId);
                if (ok) p.resolve(data);
                else {p.reject(
                    new Error(error || "Unknown worker error"),
                  );}
              }
            });

            await this.request("init", {
              moduleUrl: appState.moduleUrl,
            });
            pushLog(
              "success",
              `Engine initialized (${
                appState.workerOk ? "Worker" : "Fallback"
              })`,
            );
          } catch (err) {
            appState.workerOk = false;
            errorToast(err, "Engine init failed");
            pushLog("warning", "Attempting fallback engine‚Ä¶");
            try {
              this.worker = createFallbackEngine();
              this.worker.addEventListener("message", (e) => {
                const msg = e.data || {};
                if (msg.type === "progress") return handleProgress(msg);
                if (msg.type !== "result") return;
                const p = this.pending.get(msg.requestId);
                if (!p) return;
                this.pending.delete(msg.requestId);
                msg.ok
                  ? p.resolve(msg.data)
                  : p.reject(new Error(msg.error || "Unknown error"));
              });
              await this.request("init", {
                moduleUrl: appState.moduleUrl,
              });
              pushLog("success", "Fallback engine initialized");
              toast(
                "warning",
                "Worker unavailable. Running slower fallback mode.",
              );
            } catch (err2) {
              errorToast(err2, "Fallback init failed");
            }
          }
        },
        request(type, payload = {}) {
          const requestId = crypto.randomUUID
            ? crypto.randomUUID()
            : String(Date.now()) + Math.random();
          const msg = { type, requestId, ...payload };
          return new Promise((resolve, reject) => {
            this.pending.set(requestId, { resolve, reject, type });
            try {
              this.worker.postMessage(msg);
            } catch (err) {
              this.pending.delete(requestId);
              reject(err);
            }
          });
        },
      };

      function handleProgress(
        { requestId, percent, message, metrics },
      ) {
        if (appState.activeOp.requestId !== requestId) return;
        showLoading(true, message || "Working‚Ä¶", percent ?? 0);
        if (metrics) {
          appState.metrics.avgLoss = metrics.avgLoss ??
            appState.metrics.avgLoss;
          appState.metrics.gradientNorm = metrics.gradientNorm ??
            appState.metrics.gradientNorm;
          appState.metrics.sampleWeight = metrics.sampleWeight ??
            appState.metrics.sampleWeight;
          renderMetrics();
        }
      }

      // =========================
      // Loading / Cancel
      // =========================
      function showLoading(on, text = "Working‚Ä¶", pct = 0) {
        const el = $("#loadingOverlay");
        $("#loadingText").textContent = text;
        $("#loadingPct").textContent = `${
          Math.max(0, Math.min(100, Math.round(pct)))
        }%`;
        $("#loadingBar").style.width = `${
          Math.max(0, Math.min(100, pct))
        }%`;
        el.classList.toggle("hidden", !on);
        el.setAttribute("aria-hidden", on ? "false" : "true");
      }

      $("#btnCancelOp").addEventListener("click", async () => {
        try {
          if (!appState.activeOp.requestId) return;
          await Engine.request("cancel", {});
          pushLog(
            "warning",
            `Canceled: ${appState.activeOp.type || "operation"}`,
          );
          toast("warning", "Cancellation requested.");
        } catch (err) {
          errorToast(err, "Cancel failed");
        } finally {
          showLoading(false);
          appState.activeOp = { requestId: null, type: null };
        }
      });

      // =========================
      // Modal system (accessible)
      // =========================
      let lastFocusEl = null;

      function openModal(
        renderFn,
        { title = "Modal", wide = false, fullscreen = false } = {},
      ) {
        const host = $("#modalHost");
        lastFocusEl = document.activeElement;

        host.innerHTML = "";
        host.classList.remove("hidden");
        host.setAttribute("aria-hidden", "false");

        const wrap = document.createElement("div");
        wrap.className = "absolute inset-0";
        wrap.innerHTML = `
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-end sm:items-center justify-center p-0 sm:p-6">
          <div class="${
          fullscreen
            ? "w-full h-full rounded-none"
            : (wide ? "w-full max-w-3xl" : "w-full max-w-md")
        } bg-white ${
          fullscreen ? "" : "rounded-3xl"
        } shadow-2xl border border-slate-200 overflow-hidden" role="dialog" aria-label="${
          escapeHtml(title)
        }">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
              <div class="min-w-0">
                <div class="font-extrabold tracking-tight">${
          escapeHtml(title)
        }</div>
                <div class="text-xs text-slate-500">ESN Regression Studio</div>
              </div>
              <button data-modal-close class="h-10 w-10 rounded-xl bg-slate-100 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Close modal">‚úñÔ∏è</button>
            </div>
            <div class="${
          fullscreen ? "h-[calc(100vh-64px)]" : ""
        } overflow-auto">
              <div class="p-5" data-modal-body></div>
            </div>
          </div>
        </div>
      `;
        host.appendChild(wrap);

        host.querySelector("[data-modal-close]").addEventListener(
          "click",
          closeModal,
        );
        host.addEventListener("click", (e) => {
          if (
            e.target ===
              wrap.querySelector(".absolute.inset-0.bg-slate-900\\/40")
          ) closeModal();
        }, { once: true });

        const body = host.querySelector("[data-modal-body]");
        renderFn(body);

        // focus first focusable element
        setTimeout(() => {
          const focusable = host.querySelector(
            "button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])",
          );
          if (focusable) focusable.focus();
        }, 0);
      }

      function closeModal() {
        const host = $("#modalHost");
        host.classList.add("hidden");
        host.setAttribute("aria-hidden", "true");
        host.innerHTML = "";
        if (lastFocusEl && lastFocusEl.focus) lastFocusEl.focus();
      }

      // =========================
      // Menu open/close
      // =========================
      function openMenu() {
        const wrap = $("#menuWrap");
        wrap.classList.remove("hidden");
        wrap.setAttribute("aria-hidden", "false");
        $("#btnCloseMenu").focus();
      }
      function closeMenu() {
        const wrap = $("#menuWrap");
        wrap.classList.add("hidden");
        wrap.setAttribute("aria-hidden", "true");
        $("#btnMenu").focus();
      }
      $("#btnMenu").addEventListener("click", openMenu);
      $("#btnCloseMenu").addEventListener("click", closeMenu);
      $("#menuBackdrop").addEventListener("click", closeMenu);
      $("#menuPanel").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const a = btn.getAttribute("data-action");
        closeMenu();
        if (a === "openConfig") openConfigModal();
        if (a === "openUpload") openUploadModal();
        if (a === "openManual") openManualModal();
        if (a === "openSaveLoad") openSaveLoadModal();
        if (a === "openRandom") openRandomModal();
        if (a === "openSettings") openSettingsModal();
        if (a === "openTable") openDataTableModal();
        if (a === "openHelp") openHelpModal();
      });

      // =========================
      // UI Rendering
      // =========================
      function renderHeader() {
        const dot = $("#modelDot");
        const text = $("#modelBadgeText");
        const predictHeader = $("#btnPredictHeader");
        if (!appState.modelExists) {
          dot.className =
            "h-2.5 w-2.5 rounded-full bg-slate-400 animate-pulse";
          text.textContent = "No Model";
          predictHeader.classList.add("hidden");
        } else {
          dot.className =
            "h-2.5 w-2.5 rounded-full bg-emerald-500 animate-pulse";
          text.textContent = `${appState.sampleCount} steps`;
          predictHeader.classList.remove("hidden");
        }
        $("#btnRunPredict").disabled = !appState.modelExists;
      }

      function renderMetrics() {
        $("#metricSamples").textContent = String(
          appState.sampleCount || 0,
        );
        $("#metricLoss").textContent = appState.metrics.avgLoss == null
          ? "‚Äî"
          : toExp(appState.metrics.avgLoss);
        $("#metricGrad").textContent =
          appState.metrics.gradientNorm == null
            ? "‚Äî"
            : toExp(appState.metrics.gradientNorm);
        $("#metricWeight").textContent =
          appState.metrics.sampleWeight == null
            ? "‚Äî"
            : Number(appState.metrics.sampleWeight).toFixed(3);
      }

      function toExp(x) {
        const n = Number(x);
        if (!Number.isFinite(n)) return "‚Äî";
        return n.toExponential(2);
      }

      function renderLogs() {
        const filter = $("#logFilter").value;
        const search = $("#logSearch").value.trim().toLowerCase();

        const levels = {
          info: { bg: "bg-blue-600", label: "INFO" },
          success: { bg: "bg-emerald-600", label: "SUCCESS" },
          warning: { bg: "bg-amber-600", label: "WARN" },
          error: { bg: "bg-red-600", label: "ERROR" },
        };

        let items = appState.logs.slice(-50).reverse();
        if (filter !== "all") {
          items = items.filter((x) => x.level === filter);
        }
        if (search) {
          items = items.filter((x) =>
            x.message.toLowerCase().includes(search)
          );
        }

        const list = $("#logList");
        list.innerHTML = "";
        for (const e of items) {
          const meta = levels[e.level] || levels.info;
          const row = document.createElement("div");
          row.className =
            "rounded-2xl border border-slate-200 bg-slate-50 p-3";
          row.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <span class="px-2 py-1 rounded-lg text-[10px] font-extrabold tracking-wider text-white ${meta.bg}">${meta.label}</span>
              <span class="text-[11px] text-slate-500">${
            escapeHtml(new Date(e.ts).toLocaleString())
          }</span>
            </div>
            <span class="text-[11px] text-slate-500">${
            escapeHtml(nowTime())
          }</span>
          </div>
          <div class="mt-2 text-sm text-slate-800 leading-snug break-words">${
            escapeHtml(e.message)
          }</div>
        `;
          list.appendChild(row);
        }
      }

      $("#logFilter").addEventListener("change", renderLogs);
      $("#logSearch").addEventListener("input", renderLogs);
      $("#btnClearLog").addEventListener("click", () => {
        appState.logs = [];
        renderLogs();
      });

      // =========================
      // Validation
      // =========================
      function validatePositiveInt(inputEl, msgEl, label) {
        const v = Number(inputEl.value);
        if (!Number.isFinite(v) || v <= 0 || Math.floor(v) !== v) {
          msgEl.textContent = `${label} must be a positive integer.`;
          msgEl.classList.remove("hidden");
          return null;
        }
        msgEl.classList.add("hidden");
        msgEl.textContent = "";
        return v;
      }

      // =========================
      // Core actions
      // =========================
      async function createModel(config) {
        try {
          showLoading(true, "Creating model‚Ä¶", 0);
          const req = crypto.randomUUID
            ? crypto.randomUUID()
            : String(Date.now());
          appState.activeOp = { requestId: req, type: "createModel" };

          // Use Engine.request's requestId (internal), but keep our own to tie overlay.
          // We'll instead call Engine.request and immediately set activeOp to that requestId via wrapper:
          const data = await Engine.request("createModel", { config });
          appState.modelExists = true;
          appState.sampleCount = 0;
          appState.metrics = {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          };
          appState.predictions = null;
          appState.nDimensions = 0;

          pushLog("success", "Model created.");
          toast("success", "Model created.");
          showLoading(false);
          renderHeader();
          renderMetrics();
          updateModeUI();
          render();
        } catch (err) {
          showLoading(false);
          errorToast(err, "Create model failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      async function trainOnDataset(coords) {
        try {
          if (!appState.modelExists) {
            throw new Error("Create a model before training.");
          }
          if (!Array.isArray(coords) || coords.length < 2) {
            throw new Error(
              "Dataset must include at least 2 time steps.",
            );
          }

          appState.dataset = { coordinates: coords };
          appState.nDimensions = coords[0].length;

          const requestPromise = Engine.request("train", {
            coordinates: coords,
            chunkSize: 48,
          });
          const pendingId = [...Engine.pending.keys()].slice(-1)[0];
          appState.activeOp = { requestId: pendingId, type: "train" };

          showLoading(true, "Training on uploaded data‚Ä¶", 1);
          pushLog(
            "info",
            `Training started (steps=${coords.length}, dims=${appState.nDimensions}).`,
          );

          const res = await requestPromise;
          showLoading(false);

          if (res?.metrics) {
            appState.metrics.avgLoss = res.metrics.averageLoss ??
              appState.metrics.avgLoss;
            appState.metrics.gradientNorm = res.metrics.gradientNorm ??
              appState.metrics.gradientNorm;
            appState.metrics.sampleWeight = res.metrics.sampleWeight ??
              appState.metrics.sampleWeight;
          }

          // get summary
          try {
            const summary = await Engine.request("getSummary", {});
            if (summary?.summary?.sampleCount != null) {
              appState.sampleCount = summary.summary.sampleCount;
            }
          } catch {}

          pushLog("success", "Training complete.");
          toast("success", "Training complete.");
          renderHeader();
          renderMetrics();
          buildDimSelector();
          updateModeUI();
          render();
        } catch (err) {
          showLoading(false);
          errorToast(err, "Training failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      async function runPrediction(futureSteps) {
        try {
          if (!appState.modelExists) {
            throw new Error("No model exists.");
          }
          const reqP = Engine.request("predict", { futureSteps });
          const pendingId = [...Engine.pending.keys()].slice(-1)[0];
          appState.activeOp = { requestId: pendingId, type: "predict" };

          showLoading(true, "Predicting‚Ä¶", 0);
          const res = await reqP;
          showLoading(false);

          appState.predictions = res;
          appState.selectedStep = 0;

          appState.zoom.level = 1;
          appState.zoom.offsetX = 0;

          pushLog(
            "success",
            `Prediction ready (futureSteps=${futureSteps}).`,
          );
          toast("success", "Prediction complete.");
          updateModeUI();
          render();
        } catch (err) {
          showLoading(false);
          errorToast(err, "Prediction failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      async function refreshSummary() {
        try {
          if (!appState.modelExists) return;
          const res = await Engine.request("getSummary", {});
          const s = res?.summary || {};
          appState.sampleCount = s.sampleCount ?? appState.sampleCount;
          pushLog("info", "Model summary refreshed.");
          renderHeader();
          renderMetrics();
        } catch (err) {
          errorToast(err, "Summary failed");
        }
      }

      $("#btnRefreshSummary").addEventListener("click", refreshSummary);

      // =========================
      // Tabs / Mode UI
      // =========================
      function setMode(mode) {
        appState.vizMode = mode;
        saveLS(LS_KEYS.vizMode, mode);
        $$(".vizTab").forEach((b) => {
          const active = b.dataset.mode === mode;
          b.className = active
            ? "vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20 focus:outline-none focus:ring-2 focus:ring-blue-300"
            : "vizTab shrink-0 px-4 py-2 rounded-xl font-semibold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300";
        });
        updateModeUI();
        render();
      }

      $$(".vizTab").forEach((btn) =>
        btn.addEventListener("click", () => setMode(btn.dataset.mode))
      );

      function updateModeUI() {
        const hasPred =
          !!(appState.predictions && appState.predictions.predictions);
        $("#emptyState").classList.toggle(
          "hidden",
          appState.modelExists,
        ); // empty state: "create model"
        $("#exportControls").classList.toggle("hidden", !hasPred);
        $("#exportControls").classList.toggle("flex", hasPred);
        $("#floatControls").classList.toggle("hidden", !hasPred);

        const mode = appState.vizMode;
        $("#dimSelectorWrap").classList.toggle(
          "hidden",
          mode !== "focus" || !hasPred,
        );
        $("#statsBar").classList.toggle(
          "hidden",
          mode !== "focus" || !hasPred,
        );
        $("#stepSelectorWrap").classList.toggle(
          "hidden",
          mode !== "snapshot" || !hasPred,
        );

        const titles = {
          grid: ["üìä Small Multiples", "All dimensions at a glance"],
          focus: [
            "üîç Focus View",
            "Single dimension + confidence intervals",
          ],
          heatmap: ["üå°Ô∏è Heatmap", "Color-coded prediction matrix"],
          ci: ["üìà Uncertainty", "Confidence spread visualization"],
          snapshot: ["üì∑ Snapshot", "Bar view for one time step"],
        };
        const t = titles[mode] || titles.grid;
        $("#vizTitle").textContent = t[0];
        $("#vizSubtitle").textContent = t[1];

        $("#btnPredictHeader").onclick = () =>
          $("#btnRunPredict").click();
      }

      // =========================
      // Dimension selector
      // =========================
      function buildDimSelector() {
        const host = $("#dimSelector");
        host.innerHTML = "";
        const n = appState.nDimensions ||
          (appState.predictions?.predictions?.[0]?.length || 0);
        if (!n) return;

        for (let i = 0; i < n; i++) {
          const b = document.createElement("button");
          const isActive = i === appState.selectedDim;
          const color = DIM_COLORS[i % DIM_COLORS.length];
          b.className = isActive
            ? "shrink-0 px-4 py-2 rounded-xl font-extrabold text-white shadow-lg focus:outline-none focus:ring-2 focus:ring-slate-300"
            : "shrink-0 px-4 py-2 rounded-xl font-bold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300";
          b.style.background = isActive ? color : "";
          b.textContent = `D${i + 1}`;
          b.setAttribute("aria-label", `Select dimension ${i + 1}`);
          b.addEventListener("click", () => {
            appState.selectedDim = i;
            buildDimSelector();
            render();
          });
          host.appendChild(b);
        }
      }

      // =========================
      // Snapshot step input
      // =========================
      $("#inputSnapshotStep").addEventListener("input", () => {
        const maxStep =
          (appState.predictions?.predictions?.length || 0) - 1;
        const v = Number($("#inputSnapshotStep").value);
        if (
          !Number.isFinite(v) || Math.floor(v) !== v || v < 0 ||
          v > maxStep
        ) {
          $("#stepValidation").textContent =
            `Step must be an integer from 0 to ${
              Math.max(0, maxStep)
            }.`;
          $("#stepValidation").classList.remove("hidden");
          return;
        }
        $("#stepValidation").classList.add("hidden");
        appState.selectedStep = v;
        render();
      });

      // =========================
      // Prediction button
      // =========================
      $("#btnRunPredict").addEventListener("click", async () => {
        try {
          const steps = validatePositiveInt(
            $("#inputFutureSteps"),
            $("#futureStepsValidation"),
            "Future steps",
          );
          if (steps == null) return;
          await runPrediction(steps);
        } catch (err) {
          errorToast(err, "Run prediction failed");
        }
      });

      // =========================
      // Exports
      // =========================
      $("#btnSavePng").addEventListener("click", () => {
        try {
          const url = chart.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-studio-${appState.vizMode}.png`;
          a.click();
          pushLog("success", "PNG exported.");
        } catch (err) {
          errorToast(err, "PNG export failed");
        }
      });

      $("#btnCopy").addEventListener("click", async () => {
        try {
          const blob = await new Promise((resolve) =>
            chart.toBlob(resolve, "image/png")
          );
          if (!blob) throw new Error("Could not create image blob.");
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          toast("success", "Copied image to clipboard.");
          pushLog("success", "Copied to clipboard.");
        } catch (err) {
          errorToast(err, "Copy failed");
        }
      });

      // Minimal SVG export (polyline for focus mode, otherwise heatmap bitmap fallback via PNG-in-SVG)
      $("#btnSaveSvg").addEventListener("click", () => {
        try {
          if (!appState.predictions?.predictions) {
            throw new Error("No predictions to export.");
          }
          const w = chart.width || 1200;
          const h = chart.height || 700;

          let svg = "";
          if (appState.vizMode === "focus") {
            const dim = appState.selectedDim;
            const series = appState.predictions.predictions.map((r) =>
              r[dim]
            );
            const lb = appState.predictions.lowerBounds?.map((r) =>
              r[dim]
            ) || null;
            const ub = appState.predictions.upperBounds?.map((r) =>
              r[dim]
            ) || null;

            const pad = 40;
            const { minV, maxV } = minMax(series, lb, ub);
            const xScale = (i) =>
              pad +
              (i * (w - 2 * pad)) / Math.max(1, series.length - 1);
            const yScale = (v) =>
              pad +
              (maxV - v) * (h - 2 * pad) / Math.max(1e-9, maxV - minV);

            const points = series.map((v, i) =>
              `${xScale(i).toFixed(2)},${yScale(v).toFixed(2)}`
            ).join(" ");
            const color = DIM_COLORS[dim % DIM_COLORS.length];

            let ciPath = "";
            if (lb && ub) {
              const top = ub.map((v, i) =>
                `${xScale(i).toFixed(2)},${yScale(v).toFixed(2)}`
              ).join(" ");
              const bot = lb.map((v, i) =>
                `${xScale(i).toFixed(2)},${yScale(v).toFixed(2)}`
              ).reverse().join(" ");
              ciPath =
                `<polygon points="${top} ${bot}" fill="${color}" fill-opacity="0.15" />`;
            }

            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
              <rect width="100%" height="100%" fill="white"/>
              <text x="${pad}" y="${
              pad - 14
            }" font-family="ui-monospace, SFMono-Regular, Menlo, monospace" font-size="12" fill="#334155">ESN Studio ‚Ä¢ Focus D${
              dim + 1
            }</text>
              ${ciPath}
              <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2" />
            </svg>
          `.trim();
          } else {
            // Embed current PNG inside SVG
            const png = chart.toDataURL("image/png");
            svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
              <image href="${png}" width="${w}" height="${h}" />
            </svg>
          `.trim();
          }

          const blob = new Blob([svg], { type: "image/svg+xml" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-studio-${appState.vizMode}.svg`;
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 500);
          pushLog("success", "SVG exported.");
        } catch (err) {
          errorToast(err, "SVG export failed");
        }
      });

      // =========================
      // Canvas sizing
      // =========================
      function resizeCanvas() {
        const rect = chart.getBoundingClientRect();
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        chart.width = Math.floor(rect.width * dpr);
        chart.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        render();
      }
      window.addEventListener("resize", resizeCanvas);

      // =========================
      // Chart interactions: zoom/pan + touch pinch + tooltip
      // =========================
      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function applyZoom(delta, anchorX = 0.5) {
        const hasPred = !!appState.predictions?.predictions;
        if (!hasPred) return;

        const old = appState.zoom.level;
        const next = clamp(old * delta, 1, 20);

        // keep anchor point stable by adjusting offsetX
        const seriesLen = appState.predictions.predictions.length;
        const viewCountOld = Math.max(10, Math.floor(seriesLen / old));
        const viewCountNew = Math.max(10, Math.floor(seriesLen / next));
        const centerIndex = appState.zoom.offsetX +
          anchorX * viewCountOld;
        const newOffset = centerIndex - anchorX * viewCountNew;

        appState.zoom.level = next;
        appState.zoom.offsetX = clamp(
          newOffset,
          0,
          Math.max(0, seriesLen - viewCountNew),
        );
        render();
      }

      function resetZoom() {
        appState.zoom.level = 1;
        appState.zoom.offsetX = 0;
        render();
      }

      $("#btnZoomIn").addEventListener(
        "click",
        () => applyZoom(1.25, 0.5),
      );
      $("#btnZoomOut").addEventListener(
        "click",
        () => applyZoom(1 / 1.25, 0.5),
      );
      $("#btnZoomReset").addEventListener("click", resetZoom);

      let dragging = false;
      let dragStartX = 0;
      let dragStartOffset = 0;
      let lastMoveT = 0;
      let velocity = 0;
      let momentumRaf = null;

      function stopMomentum() {
        if (momentumRaf) cancelAnimationFrame(momentumRaf);
        momentumRaf = null;
        velocity = 0;
      }

      function startMomentum() {
        stopMomentum();
        const step = () => {
          if (!appState.predictions?.predictions) return;
          const seriesLen = appState.predictions.predictions.length;
          const viewCount = Math.max(
            10,
            Math.floor(seriesLen / appState.zoom.level),
          );
          const maxOffset = Math.max(0, seriesLen - viewCount);

          if (Math.abs(velocity) < 0.001) return;

          appState.zoom.offsetX = clamp(
            appState.zoom.offsetX + velocity * viewCount,
            0,
            maxOffset,
          );
          velocity *= 0.92;
          render();
          momentumRaf = requestAnimationFrame(step);
        };
        momentumRaf = requestAnimationFrame(step);
      }

      chart.addEventListener("wheel", (e) => {
        try {
          if (!appState.predictions?.predictions) return;
          e.preventDefault();
          stopMomentum();
          const rect = chart.getBoundingClientRect();
          const ax = clamp((e.clientX - rect.left) / rect.width, 0, 1);
          const delta = e.deltaY < 0 ? 1.15 : 1 / 1.15;
          applyZoom(delta, ax);
        } catch (err) {
          errorToast(err, "Zoom failed");
        }
      }, { passive: false });

      chart.addEventListener("pointerdown", (e) => {
        if (!appState.predictions?.predictions) return;
        dragging = true;
        dragStartX = e.clientX;
        dragStartOffset = appState.zoom.offsetX;
        lastMoveT = performance.now();
        velocity = 0;
        stopMomentum();
        chart.setPointerCapture(e.pointerId);
      });

      chart.addEventListener("pointermove", (e) => {
        try {
          const rect = chart.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          appState.hover.active = true;
          appState.hover.x = x;
          appState.hover.y = y;

          if (!appState.predictions?.predictions) {
            renderTooltip(false);
            return;
          }

          if (dragging && appState.zoom.level > 1) {
            const seriesLen = appState.predictions.predictions.length;
            const viewCount = Math.max(
              10,
              Math.floor(seriesLen / appState.zoom.level),
            );
            const dx = (e.clientX - dragStartX) / rect.width;
            const offset = dragStartOffset - dx * viewCount;

            const now = performance.now();
            const dt = Math.max(1, now - lastMoveT);
            const newVel = (appState.zoom.offsetX - offset) /
              viewCount / dt;
            velocity = 0.8 * velocity + 0.2 * newVel;
            lastMoveT = now;

            appState.zoom.offsetX = clamp(
              offset,
              0,
              Math.max(0, seriesLen - viewCount),
            );
            render();
          } else {
            render(); // keep tooltip/crosshair fresh
          }
        } catch (err) {
          errorToast(err, "Pointer move failed");
        }
      });

      chart.addEventListener("pointerup", () => {
        dragging = false;
        if (appState.zoom.level > 1) startMomentum();
      });
      chart.addEventListener("pointercancel", () => {
        dragging = false;
      });

      chart.addEventListener("pointerleave", () => {
        appState.hover.active = false;
        renderTooltip(false);
        render();
      });

      // Touch-and-hold tooltip trigger
      let holdTimer = null;
      chart.addEventListener("pointerdown", (e) => {
        if (e.pointerType !== "touch") return;
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = setTimeout(() => {
          appState.hover.active = true;
          render();
        }, 350);
      });
      chart.addEventListener("pointerup", () => {
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = null;
      });

      // Pinch-to-zoom using touch events (two pointers)
      const activeTouches = new Map();
      let pinchStartDist = null;
      let pinchStartZoom = null;

      chart.addEventListener("pointerdown", (e) => {
        if (e.pointerType !== "touch") return;
        activeTouches.set(e.pointerId, { x: e.clientX, y: e.clientY });
        if (activeTouches.size === 2) {
          const pts = [...activeTouches.values()];
          pinchStartDist = Math.hypot(
            pts[0].x - pts[1].x,
            pts[0].y - pts[1].y,
          );
          pinchStartZoom = appState.zoom.level;
          stopMomentum();
        }
      });

      chart.addEventListener("pointermove", (e) => {
        if (e.pointerType !== "touch") return;
        if (!activeTouches.has(e.pointerId)) return;
        activeTouches.set(e.pointerId, { x: e.clientX, y: e.clientY });
        if (
          activeTouches.size === 2 && pinchStartDist &&
          pinchStartZoom && appState.predictions?.predictions
        ) {
          const pts = [...activeTouches.values()];
          const dist = Math.hypot(
            pts[0].x - pts[1].x,
            pts[0].y - pts[1].y,
          );
          const ratio = dist / pinchStartDist;
          const target = clamp(pinchStartZoom * ratio, 1, 20);
          const delta = target / appState.zoom.level;
          const rect = chart.getBoundingClientRect();
          const centerX = (pts[0].x + pts[1].x) / 2;
          const ax = clamp((centerX - rect.left) / rect.width, 0, 1);
          applyZoom(delta, ax);
        }
      });

      chart.addEventListener("pointerup", (e) => {
        if (e.pointerType !== "touch") return;
        activeTouches.delete(e.pointerId);
        if (activeTouches.size < 2) {
          pinchStartDist = null;
          pinchStartZoom = null;
        }
      });
      chart.addEventListener("pointercancel", (e) => {
        if (e.pointerType !== "touch") return;
        activeTouches.clear();
        pinchStartDist = null;
        pinchStartZoom = null;
      });

      // =========================
      // Rendering (Canvas)
      // =========================
      function clear() {
        const rect = chart.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
      }

      function minMax(series, lb = null, ub = null) {
        let minV = Infinity, maxV = -Infinity;
        const push = (v) => {
          if (!Number.isFinite(v)) return;
          minV = Math.min(minV, v);
          maxV = Math.max(maxV, v);
        };
        for (const v of series) push(v);
        if (lb) { for (const v of lb) push(v); }
        if (ub) { for (const v of ub) push(v); }
        if (
          !Number.isFinite(minV) || !Number.isFinite(maxV) ||
          minV === maxV
        ) {
          minV = Number.isFinite(minV) ? minV - 1 : -1;
          maxV = Number.isFinite(maxV) ? maxV + 1 : 1;
        }
        return { minV, maxV };
      }

      function getViewport() {
        const seriesLen = appState.predictions?.predictions?.length ||
          0;
        const viewCount = seriesLen
          ? Math.max(10, Math.floor(seriesLen / appState.zoom.level))
          : 0;
        const start = clamp(
          Math.floor(appState.zoom.offsetX),
          0,
          Math.max(0, seriesLen - viewCount),
        );
        const end = Math.min(seriesLen, start + viewCount);
        return { start, end, viewCount };
      }

      function renderTooltip(show, payload) {
        const tip = $("#tooltip");
        if (!show) {
          tip.classList.add("hidden");
          return;
        }
        $("#tipStep").textContent = String(payload.step);
        $("#tipDim").textContent = `D${payload.dim + 1}`;
        $("#tipVal").textContent = formatNum(payload.value);
        $("#tipCI").textContent = `${formatNum(payload.lower)} ‚Äî ${
          formatNum(payload.upper)
        }`;
        $("#tipSpread").textContent = formatNum(payload.spread);
        $("#tipDot").style.background = payload.color;

        const rect = chart.getBoundingClientRect();
        const left = clamp(payload.screenX + 12, 10, rect.width - 250);
        const top = clamp(payload.screenY + 12, 10, rect.height - 170);
        tip.style.left = `${left}px`;
        tip.style.top = `${top}px`;
        tip.classList.remove("hidden");
      }

      function formatNum(x) {
        const n = Number(x);
        if (!Number.isFinite(n)) return "‚Äî";
        const abs = Math.abs(n);
        if (abs >= 1000) return n.toFixed(0);
        if (abs >= 10) return n.toFixed(2);
        return n.toFixed(4);
      }

      function drawAxes(pad, w, h) {
        ctx.save();
        ctx.strokeStyle = "#E2E8F0";
        ctx.lineWidth = 1;

        // grid lines
        for (let i = 0; i <= 4; i++) {
          const y = pad + i * (h - 2 * pad) / 4;
          ctx.beginPath();
          ctx.moveTo(pad, y);
          ctx.lineTo(w - pad, y);
          ctx.stroke();
        }
        ctx.restore();
      }

      function renderFocus() {
        const rect = chart.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        clear();

        const pad = 40;
        const dim = appState.selectedDim;

        const preds = appState.predictions.predictions;
        const lbAll = appState.predictions.lowerBounds || null;
        const ubAll = appState.predictions.upperBounds || null;

        const { start, end } = getViewport();
        const series = preds.slice(start, end).map((r) => r[dim]);
        const lb = lbAll
          ? lbAll.slice(start, end).map((r) => r[dim])
          : null;
        const ub = ubAll
          ? ubAll.slice(start, end).map((r) => r[dim])
          : null;

        const { minV, maxV } = minMax(series, lb, ub);
        const color = DIM_COLORS[dim % DIM_COLORS.length];

        drawAxes(pad, w, h);

        // CI band
        if (lb && ub) {
          ctx.save();
          ctx.fillStyle = color + "26"; // ~15% (best-effort)
          ctx.beginPath();
          for (let i = 0; i < series.length; i++) {
            const x = pad +
              (i * (w - 2 * pad)) / Math.max(1, series.length - 1);
            const y = pad +
              (maxV - ub[i]) * (h - 2 * pad) /
                Math.max(1e-9, maxV - minV);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          for (let i = series.length - 1; i >= 0; i--) {
            const x = pad +
              (i * (w - 2 * pad)) / Math.max(1, series.length - 1);
            const y = pad +
              (maxV - lb[i]) * (h - 2 * pad) /
                Math.max(1e-9, maxV - minV);
            ctx.lineTo(x, y);
          }
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }

        // main line
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < series.length; i++) {
          const x = pad +
            (i * (w - 2 * pad)) / Math.max(1, series.length - 1);
          const y = pad +
            (maxV - series[i]) * (h - 2 * pad) /
              Math.max(1e-9, maxV - minV);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.restore();

        // crosshair + highlight on hover
        const hover = appState.hover;
        if (hover.active) {
          const rx = clamp(hover.x, pad, w - pad);
          const t = (rx - pad) / Math.max(1, w - 2 * pad);
          const idx = Math.round(t * (series.length - 1));
          const x = pad +
            (idx * (w - 2 * pad)) / Math.max(1, series.length - 1);
          const y = pad +
            (maxV - series[idx]) * (h - 2 * pad) /
              Math.max(1e-9, maxV - minV);

          ctx.save();
          ctx.strokeStyle = "#0F172A55";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, pad);
          ctx.lineTo(x, h - pad);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(pad, y);
          ctx.lineTo(w - pad, y);
          ctx.stroke();
          ctx.restore();

          // glow point (no CSS animation)
          ctx.save();
          ctx.shadowColor = color;
          ctx.shadowBlur = 12;
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x, y, 4.5, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();

          const globalIndex = start + idx;
          const lower = lb ? lb[idx] : series[idx];
          const upper = ub ? ub[idx] : series[idx];
          renderTooltip(true, {
            step: globalIndex,
            dim,
            value: series[idx],
            lower,
            upper,
            spread: Math.abs(upper - lower),
            color,
            screenX: x,
            screenY: y,
          });
        } else {
          renderTooltip(false);
        }

        // stats
        updateFocusStats(series, lb, ub);
      }

      function updateFocusStats(series, lb, ub) {
        const finite = series.filter(Number.isFinite);
        if (!finite.length) return;

        const min = Math.min(...finite);
        const max = Math.max(...finite);
        const mean = finite.reduce((a, b) => a + b, 0) / finite.length;
        const final = finite[finite.length - 1];
        const first = finite[0];
        const delta = final - first;

        $("#statMin").textContent = formatNum(min);
        $("#statMax").textContent = formatNum(max);
        $("#statMean").textContent = formatNum(mean);
        $("#statFinal").textContent = formatNum(final);

        const arrow = delta >= 0 ? "‚Üë" : "‚Üì";
        const trendColor = delta >= 0
          ? "text-emerald-600"
          : "text-red-600";
        $("#statTrend").innerHTML =
          `<span class="${trendColor} font-extrabold">${arrow} ${
            formatNum(Math.abs(delta))
          }</span>`;

        const conf = appState.predictions?.confidence;
        const confPct = conf == null
          ? "‚Äî"
          : `${Math.round(Number(conf) * 100)}%`;
        $("#statConf").textContent = confPct;
      }

      function renderGrid() {
        const rect = chart.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        clear();
        renderTooltip(false);

        const preds = appState.predictions.predictions;
        const { start, end } = getViewport();
        const view = preds.slice(start, end);
        const nDims = view[0]?.length || 0;

        const cols = nDims <= 2 ? 1 : (nDims <= 4 ? 2 : 3);
        const rows = Math.ceil(nDims / cols);
        const pad = 18;
        const cellW = (w - pad * (cols + 1)) / cols;
        const cellH = (h - pad * (rows + 1)) / rows;

        ctx.save();
        ctx.fillStyle = "#0F172A";
        ctx.font = "12px ui-sans-serif, system-ui, -apple-system";
        ctx.restore();

        for (let d = 0; d < nDims; d++) {
          const r = Math.floor(d / cols);
          const c = d % cols;
          const x0 = pad + c * (cellW + pad);
          const y0 = pad + r * (cellH + pad);

          // card
          ctx.save();
          ctx.fillStyle = "#F8FAFC";
          ctx.strokeStyle = "#E2E8F0";
          ctx.lineWidth = 1;
          roundRect(ctx, x0, y0, cellW, cellH, 14);
          ctx.fill();
          ctx.stroke();
          ctx.restore();

          // title
          ctx.save();
          ctx.fillStyle = "#334155";
          ctx.font =
            "11px ui-monospace, SFMono-Regular, Menlo, monospace";
          ctx.fillText(`D${d + 1}`, x0 + 12, y0 + 18);
          ctx.restore();

          const series = view.map((r) => r[d]);
          const { minV, maxV } = minMax(series);
          const color = DIM_COLORS[d % DIM_COLORS.length];

          // line
          ctx.save();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < series.length; i++) {
            const x = x0 + 12 +
              (i * (cellW - 24)) / Math.max(1, series.length - 1);
            const y = y0 + 28 +
              (maxV - series[i]) * (cellH - 40) /
                Math.max(1e-9, maxV - minV);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.restore();
        }

        // hint overlay
        ctx.save();
        ctx.fillStyle = "#64748B";
        ctx.font = "12px ui-sans-serif, system-ui";
        ctx.fillText(
          "Pinch/scroll to zoom ‚Ä¢ Drag to pan when zoomed",
          16,
          h - 16,
        );
        ctx.restore();
      }

      function renderHeatmap() {
        const rect = chart.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        clear();
        renderTooltip(false);

        const preds = appState.predictions.predictions;
        const { start, end } = getViewport();
        const view = preds.slice(start, end);
        const nSteps = view.length;
        const nDims = view[0]?.length || 0;
        const pad = 40;

        // compute min/max overall
        let minV = Infinity, maxV = -Infinity;
        for (const row of view) {
          for (const v of row) {
            if (!Number.isFinite(v)) continue;
            minV = Math.min(minV, v);
            maxV = Math.max(maxV, v);
          }
        }
        if (
          !Number.isFinite(minV) || !Number.isFinite(maxV) ||
          minV === maxV
        ) {
          minV = -1;
          maxV = 1;
        }

        // axes labels
        ctx.save();
        ctx.fillStyle = "#334155";
        ctx.font =
          "12px ui-monospace, SFMono-Regular, Menlo, monospace";
        ctx.fillText("Steps ‚Üí", pad, 20);
        ctx.fillText("Dims ‚Üì", 8, pad);
        ctx.restore();

        const gridW = w - 2 * pad;
        const gridH = h - 2 * pad;
        const cellW = gridW / Math.max(1, nSteps);
        const cellH = gridH / Math.max(1, nDims);

        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < nSteps; s++) {
            const v = view[s][d];
            const t = (v - minV) / Math.max(1e-9, maxV - minV);
            // simple blue->cyan->emerald->amber->red ramp
            const col = rampColor(t);
            ctx.fillStyle = col;
            ctx.fillRect(
              pad + s * cellW,
              pad + d * cellH,
              Math.ceil(cellW),
              Math.ceil(cellH),
            );
          }
        }

        // hover tooltip
        if (appState.hover.active) {
          const x = clamp(appState.hover.x - pad, 0, gridW - 1);
          const y = clamp(appState.hover.y - pad, 0, gridH - 1);
          const s = Math.floor(x / cellW);
          const d = Math.floor(y / cellH);
          const step = start + clamp(s, 0, nSteps - 1);
          const dim = clamp(d, 0, nDims - 1);
          const value = preds[step]?.[dim];

          // crosshair rectangle
          ctx.save();
          ctx.strokeStyle = "#0F172A55";
          ctx.lineWidth = 1;
          ctx.strokeRect(
            pad + s * cellW,
            pad + d * cellH,
            cellW,
            cellH,
          );
          ctx.restore();

          const lb = appState.predictions.lowerBounds?.[step]?.[dim] ??
            value;
          const ub = appState.predictions.upperBounds?.[step]?.[dim] ??
            value;

          renderTooltip(true, {
            step,
            dim,
            value,
            lower: lb,
            upper: ub,
            spread: Math.abs(ub - lb),
            color: DIM_COLORS[dim % DIM_COLORS.length],
            screenX: pad + s * cellW,
            screenY: pad + d * cellH,
          });
        } else {
          renderTooltip(false);
        }
      }

      function renderCI() {
        const rect = chart.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        clear();
        renderTooltip(false);

        const lbAll = appState.predictions.lowerBounds;
        const ubAll = appState.predictions.upperBounds;
        if (!lbAll || !ubAll) {
          ctx.save();
          ctx.fillStyle = "#334155";
          ctx.font = "14px ui-sans-serif, system-ui";
          ctx.fillText("No confidence bounds available.", 20, 30);
          ctx.restore();
          return;
        }

        // visualize spread as area by dimension: average spread over time (visible window)
        const { start, end } = getViewport();
        const nDims = lbAll[0]?.length || 0;

        const spreads = new Array(nDims).fill(0);
        const count = Math.max(1, end - start);
        for (let s = start; s < end; s++) {
          for (let d = 0; d < nDims; d++) {
            spreads[d] += Math.abs(
              (ubAll[s][d] ?? 0) - (lbAll[s][d] ?? 0),
            );
          }
        }
        for (let d = 0; d < nDims; d++) spreads[d] /= count;

        const maxS = Math.max(...spreads, 1e-9);

        const pad = 50;
        ctx.save();
        ctx.fillStyle = "#334155";
        ctx.font =
          "12px ui-monospace, SFMono-Regular, Menlo, monospace";
        ctx.fillText(
          "Average uncertainty (spread) per dimension",
          pad,
          22,
        );
        ctx.restore();

        const barW = (w - 2 * pad) / Math.max(1, nDims);
        for (let d = 0; d < nDims; d++) {
          const t = spreads[d] / maxS;
          const bh = t * (h - 2 * pad);
          const x = pad + d * barW + barW * 0.15;
          const y = h - pad - bh;
          const bw = barW * 0.7;

          ctx.save();
          ctx.fillStyle = DIM_COLORS[d % DIM_COLORS.length];
          ctx.globalAlpha = 0.85;
          roundRect(ctx, x, y, bw, bh, 10);
          ctx.fill();
          ctx.restore();

          ctx.save();
          ctx.fillStyle = "#475569";
          ctx.font =
            "10px ui-monospace, SFMono-Regular, Menlo, monospace";
          ctx.fillText(`D${d + 1}`, x, h - pad + 14);
          ctx.restore();
        }
      }

      function renderSnapshot() {
        const rect = chart.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        clear();
        renderTooltip(false);

        const preds = appState.predictions.predictions;
        const step = clamp(appState.selectedStep, 0, preds.length - 1);
        $("#stepHint").textContent = `0 ‚Äî ${
          Math.max(0, preds.length - 1)
        } (current: ${step})`;
        $("#inputSnapshotStep").max = String(
          Math.max(0, preds.length - 1),
        );
        $("#inputSnapshotStep").value = String(step);

        const row = preds[step];
        const lbRow = appState.predictions.lowerBounds?.[step] || null;
        const ubRow = appState.predictions.upperBounds?.[step] || null;

        const nDims = row.length;
        let minV = Infinity, maxV = -Infinity;
        for (let d = 0; d < nDims; d++) {
          const v = row[d];
          if (!Number.isFinite(v)) continue;
          minV = Math.min(minV, v);
          maxV = Math.max(maxV, v);
          if (lbRow) {
            minV = Math.min(minV, lbRow[d]);
            maxV = Math.max(maxV, ubRow[d]);
          }
        }
        if (
          !Number.isFinite(minV) || !Number.isFinite(maxV) ||
          minV === maxV
        ) {
          minV -= 1;
          maxV += 1;
        }

        const pad = 60;
        const axisY = h - pad;
        ctx.save();
        ctx.strokeStyle = "#E2E8F0";
        ctx.beginPath();
        ctx.moveTo(pad, axisY);
        ctx.lineTo(w - pad, axisY);
        ctx.stroke();
        ctx.restore();

        ctx.save();
        ctx.fillStyle = "#334155";
        ctx.font =
          "12px ui-monospace, SFMono-Regular, Menlo, monospace";
        ctx.fillText(`Snapshot at step ${step}`, pad, 24);
        ctx.restore();

        const barW = (w - 2 * pad) / Math.max(1, nDims);
        for (let d = 0; d < nDims; d++) {
          const v = row[d];
          const t = (v - minV) / Math.max(1e-9, maxV - minV);
          const bh = t * (h - 2 * pad);
          const x = pad + d * barW + barW * 0.15;
          const y = axisY - bh;
          const bw = barW * 0.7;
          const color = DIM_COLORS[d % DIM_COLORS.length];

          ctx.save();
          ctx.fillStyle = color;
          ctx.globalAlpha = 0.85;
          roundRect(ctx, x, y, bw, bh, 10);
          ctx.fill();
          ctx.restore();

          // CI whiskers
          if (lbRow && ubRow) {
            const l = lbRow[d], u = ubRow[d];
            const yL = pad +
              (maxV - l) * (h - 2 * pad) / Math.max(1e-9, maxV - minV);
            const yU = pad +
              (maxV - u) * (h - 2 * pad) / Math.max(1e-9, maxV - minV);
            ctx.save();
            ctx.strokeStyle = "#0F172A66";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + bw / 2, yU);
            ctx.lineTo(x + bw / 2, yL);
            ctx.stroke();
            ctx.restore();
          }

          ctx.save();
          ctx.fillStyle = "#475569";
          ctx.font =
            "10px ui-monospace, SFMono-Regular, Menlo, monospace";
          ctx.fillText(`D${d + 1}`, x, axisY + 14);
          ctx.restore();
        }
      }

      function roundRect(ctx, x, y, w, h, r) {
        const rr = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }

      function rampColor(t) {
        // clamp
        t = clamp(t, 0, 1);
        // simple 5-stop palette mapping:
        const stops = [
          { p: 0.00, c: [59, 130, 246] }, // blue
          { p: 0.25, c: [6, 182, 212] }, // cyan
          { p: 0.50, c: [16, 185, 129] }, // emerald
          { p: 0.75, c: [245, 158, 11] }, // amber
          { p: 1.00, c: [239, 68, 68] }, // red
        ];
        let a = stops[0], b = stops[stops.length - 1];
        for (let i = 0; i < stops.length - 1; i++) {
          if (t >= stops[i].p && t <= stops[i + 1].p) {
            a = stops[i];
            b = stops[i + 1];
            break;
          }
        }
        const u = (t - a.p) / Math.max(1e-9, b.p - a.p);
        const r = Math.round(a.c[0] + (b.c[0] - a.c[0]) * u);
        const g = Math.round(a.c[1] + (b.c[1] - a.c[1]) * u);
        const bl = Math.round(a.c[2] + (b.c[2] - a.c[2]) * u);
        return `rgb(${r},${g},${bl})`;
      }

      function render() {
        const hasPred = !!appState.predictions?.predictions;
        $("#zoomBadge").textContent = `${
          Math.round(appState.zoom.level * 100)
        }%`;
        renderHeader();

        if (!appState.modelExists) {
          // Empty background hint
          const rect = chart.getBoundingClientRect();
          clear();
          ctx.save();
          ctx.fillStyle = "#94A3B8";
          ctx.font = "14px ui-sans-serif, system-ui";
          ctx.fillText("Create a model to begin.", 20, 30);
          ctx.restore();
          renderTooltip(false);
          return;
        }

        if (!hasPred) {
          const rect = chart.getBoundingClientRect();
          clear();
          ctx.save();
          ctx.fillStyle = "#334155";
          ctx.font = "14px ui-sans-serif, system-ui";
          ctx.fillText(
            "Train and run a prediction to visualize results.",
            20,
            30,
          );
          ctx.fillStyle = "#64748B";
          ctx.font = "12px ui-sans-serif, system-ui";
          ctx.fillText(
            "Use ‚ò∞ Menu ‚Üí Upload Dataset / Random Test.",
            20,
            52,
          );
          ctx.restore();
          renderTooltip(false);
          return;
        }

        const mode = appState.vizMode;
        if (mode === "focus") renderFocus();
        else if (mode === "heatmap") renderHeatmap();
        else if (mode === "ci") renderCI();
        else if (mode === "snapshot") renderSnapshot();
        else renderGrid();
      }

      // =========================
      // Configuration Modal
      // =========================
      function openConfigModal() {
        openModal((body) => {
          const cfg = structuredClone(appState.config);

          const sections = [
            {
              key: "reservoir",
              title: "Reservoir Architecture",
              fields: [
                num(
                  "reservoirSize",
                  "Reservoir Size",
                  1,
                  100000,
                  "Neurons in reservoir",
                ),
                num(
                  "spectralRadius",
                  "Spectral Radius",
                  0,
                  10,
                  "Memory length control",
                ),
                num(
                  "leakRate",
                  "Leak Rate",
                  0,
                  1,
                  "Temporal smoothing",
                ),
                num(
                  "inputScale",
                  "Input Scale",
                  0,
                  10,
                  "Input scaling factor",
                ),
                num("biasScale", "Bias Scale", 0, 10, "Bias scaling"),
                num(
                  "reservoirSparsity",
                  "Reservoir Sparsity",
                  0,
                  1,
                  "Zero connections",
                ),
                num(
                  "inputSparsity",
                  "Input Sparsity",
                  0,
                  1,
                  "Input sparsity",
                ),
                sel(
                  "activation",
                  "Activation",
                  ["tanh", "relu"],
                  "Activation function",
                ),
              ],
            },
            {
              key: "readout",
              title: "Readout Configuration",
              fields: [
                tog(
                  "useInputInReadout",
                  "Use Input In Readout",
                  "Append input to state",
                ),
                tog(
                  "useBiasInReadout",
                  "Use Bias In Readout",
                  "Include bias term",
                ),
              ],
            },
            {
              key: "training",
              title: "Training (RLS)",
              fields: [
                fixed(
                  "readoutTraining",
                  "Readout Training",
                  "rls",
                  "RLS training",
                ),
                num(
                  "rlsLambda",
                  "RLS Lambda",
                  0.0,
                  1.0,
                  "Forgetting factor",
                ),
                num(
                  "rlsDelta",
                  "RLS Delta",
                  0.0,
                  1e9,
                  "Initial P diagonal",
                ),
                num(
                  "epsilon",
                  "Epsilon",
                  0.0,
                  1,
                  "Numerical stability",
                ),
                num(
                  "l2Lambda",
                  "L2 Lambda",
                  0.0,
                  1,
                  "L2 regularization",
                ),
                num(
                  "gradientClipNorm",
                  "Gradient Clip Norm",
                  0.0,
                  1e9,
                  "Max update norm",
                ),
              ],
            },
            {
              key: "norm",
              title: "Normalization",
              fields: [
                num(
                  "normalizationEpsilon",
                  "Normalization Epsilon",
                  0.0,
                  1,
                  "Stability constant",
                ),
                num(
                  "normalizationWarmup",
                  "Normalization Warmup",
                  0,
                  100000,
                  "Warmup samples",
                ),
              ],
            },
            {
              key: "outliers",
              title: "Outlier Handling",
              fields: [
                num(
                  "outlierThreshold",
                  "Outlier Threshold",
                  0.0,
                  1e9,
                  "Z-score threshold",
                ),
                num(
                  "outlierMinWeight",
                  "Outlier Min Weight",
                  0.0,
                  1.0,
                  "Outlier min weight",
                ),
              ],
            },
            {
              key: "unc",
              title: "Uncertainty",
              fields: [
                num(
                  "uncertaintyMultiplier",
                  "Uncertainty Multiplier",
                  0.0,
                  1e9,
                  "CI Multiplier (1.96 = 95% CI)",
                ),
              ],
            },
            {
              key: "init",
              title: "Initialization",
              fields: [
                num(
                  "weightInitScale",
                  "Weight Init Scale",
                  0.0,
                  1e9,
                  "Initial weight scale",
                ),
                num("seed", "Seed", -1e9, 1e9, "Random seed"),
                tog("verbose", "Verbose", "Detailed logging"),
              ],
            },
          ];

          body.innerHTML = `
          <div class="space-y-5">
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Presets</div>
              <div class="mt-2 flex gap-2 overflow-x-auto pb-1">
                ${
            Object.keys(PRESETS).map((k) => {
              const bg = k === "Start Here"
                ? "bg-blue-600"
                : k === "Fast"
                ? "bg-amber-600"
                : k === "Balanced"
                ? "bg-emerald-600"
                : k === "Accurate"
                ? "bg-indigo-600"
                : k === "Adaptive"
                ? "bg-cyan-600"
                : "bg-purple-600";
              return `<button data-preset="${
                escapeHtml(k)
              }" class="shrink-0 px-3 py-2 rounded-xl text-white font-extrabold ${bg} hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-slate-300" aria-label="Preset ${
                escapeHtml(k)
              }">${escapeHtml(k)}</button>`;
            }).join("")
          }
              </div>
            </div>

            <div id="cfgValidation" class="hidden rounded-2xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"></div>

            <div id="cfgSections" class="space-y-3"></div>

            <div class="pt-2 border-t border-slate-200 flex flex-col sm:flex-row gap-2">
              <button id="cfgResetDefaults" class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Reset defaults">Reset Defaults</button>
              <button id="cfgResetAll" class="px-4 py-3 rounded-2xl font-bold bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300" aria-label="Reset all">Reset All</button>
              <button id="cfgCancel" class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Cancel">Cancel</button>
              <button id="cfgCreate" class="sm:ml-auto px-4 py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Create model">Create Model</button>
            </div>
          </div>
        `;

          const sectionsHost = body.querySelector("#cfgSections");

          const openState = new Map(sections.map((s) => [s.key, true]));
          function renderSections() {
            sectionsHost.innerHTML = "";
            for (const s of sections) {
              const open = openState.get(s.key);
              const card = document.createElement("div");
              card.className =
                "rounded-2xl border border-slate-200 overflow-hidden";
              card.innerHTML = `
              <button data-sec="${
                escapeHtml(s.key)
              }" class="w-full px-4 py-3 bg-white hover:bg-slate-50 flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Toggle ${
                escapeHtml(s.title)
              }">
                <div class="font-extrabold">${escapeHtml(s.title)}</div>
                <div class="text-slate-600">${open ? "‚ñ≤" : "‚ñº"}</div>
              </button>
              <div class="${
                open ? "block" : "hidden"
              } px-4 py-4 bg-slate-50 border-t border-slate-200" data-sec-body="${
                escapeHtml(s.key)
              }"></div>
            `;
              sectionsHost.appendChild(card);

              const secBody = card.querySelector(
                `[data-sec-body="${s.key}"]`,
              );
              for (const f of s.fields) {
                secBody.appendChild(f.render(cfg));
              }
            }

            sectionsHost.querySelectorAll("button[data-sec]").forEach(
              (btn) => {
                btn.addEventListener("click", () => {
                  const k = btn.getAttribute("data-sec");
                  openState.set(k, !openState.get(k));
                  renderSections();
                });
              },
            );
          }

          renderSections();

          body.querySelectorAll("button[data-preset]").forEach(
            (btn) => {
              btn.addEventListener("click", () => {
                const k = btn.getAttribute("data-preset");
                const fn = PRESETS[k];
                const next = fn ? fn(cfg) : cfg;
                Object.assign(cfg, next);
                renderSections();
                toast("info", `Preset applied: ${k}`);
                pushLog("info", `Preset applied: ${k}`);
              });
            },
          );

          body.querySelector("#cfgResetDefaults").addEventListener(
            "click",
            () => {
              Object.assign(cfg, structuredClone(DEFAULT_CONFIG));
              renderSections();
              toast("info", "Defaults restored.");
            },
          );

          body.querySelector("#cfgResetAll").addEventListener(
            "click",
            async () => {
              try {
                Object.assign(cfg, structuredClone(DEFAULT_CONFIG));
                appState.config = structuredClone(DEFAULT_CONFIG);
                saveLS(LS_KEYS.config, appState.config);
                await Engine.request("reset", {});
                appState.modelExists = false;
                appState.sampleCount = 0;
                appState.nDimensions = 0;
                appState.predictions = null;
                appState.dataset = null;
                pushLog(
                  "warning",
                  "Reset all: model cleared and defaults restored.",
                );
                toast("warning", "Reset all complete.");
                closeModal();
                updateModeUI();
                renderHeader();
                renderMetrics();
                render();
              } catch (err) {
                errorToast(err, "Reset all failed");
              }
            },
          );

          body.querySelector("#cfgCancel").addEventListener(
            "click",
            closeModal,
          );

          body.querySelector("#cfgCreate").addEventListener(
            "click",
            async () => {
              try {
                const errors = validateConfig(cfg);
                const box = body.querySelector("#cfgValidation");
                if (errors.length) {
                  box.innerHTML = errors.map((e) =>
                    `<div>‚Ä¢ ${escapeHtml(e)}</div>`
                  ).join("");
                  box.classList.remove("hidden");
                  toast("error", "Fix configuration errors.");
                  pushLog("error", "Config validation failed.");
                  return;
                }
                box.classList.add("hidden");

                appState.config = structuredClone(cfg);
                saveLS(LS_KEYS.config, appState.config);
                closeModal();
                await createModel(appState.config);
              } catch (err) {
                errorToast(err, "Create model failed");
              }
            },
          );
        }, { title: "‚öôÔ∏è Configuration", wide: true });
      }

      function validateConfig(cfg) {
        const errs = [];
        const numFields = [
          ["reservoirSize", 1, 100000],
          ["spectralRadius", 0, 10],
          ["leakRate", 0, 1],
          ["reservoirSparsity", 0, 1],
          ["inputSparsity", 0, 1],
          ["rlsLambda", 0, 1],
          ["outlierMinWeight", 0, 1],
        ];
        for (const [k, a, b] of numFields) {
          const v = Number(cfg[k]);
          if (!Number.isFinite(v) || v < a || v > b) {
            errs.push(`${k} must be between ${a} and ${b}.`);
          }
        }
        if (!["tanh", "relu"].includes(cfg.activation)) {
          errs.push("activation must be tanh or relu.");
        }
        return errs;
      }

      function fieldRow(label, desc, inputEl) {
        const wrap = document.createElement("div");
        wrap.className =
          "rounded-2xl bg-white border border-slate-200 p-4";
        const top = document.createElement("div");
        top.className = "flex items-start justify-between gap-3";
        const left = document.createElement("div");
        left.innerHTML = `
        <div class="font-bold">${escapeHtml(label)}</div>
        <div class="mt-1 text-sm text-slate-600">${
          escapeHtml(desc || "")
        }</div>
      `;
        top.appendChild(left);
        top.appendChild(inputEl);
        wrap.appendChild(top);
        return wrap;
      }

      function num(key, label, min, max, desc) {
        return {
          render(cfg) {
            const box = document.createElement("div");
            const input = document.createElement("input");
            input.type = "number";
            input.className =
              "w-32 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300 text-right tabular-nums";
            input.value = String(cfg[key]);
            input.min = String(min);
            input.max = String(max);
            input.setAttribute("aria-label", label);
            const help = document.createElement("div");
            help.className = "hidden mt-2 text-sm text-red-600";

            input.addEventListener("input", () => {
              try {
                const v = Number(input.value);
                if (!Number.isFinite(v) || v < min || v > max) {
                  help.textContent =
                    `Must be between ${min} and ${max}.`;
                  help.classList.remove("hidden");
                } else {
                  help.classList.add("hidden");
                  cfg[key] = v;
                }
              } catch (err) {
                help.textContent = "Invalid number.";
                help.classList.remove("hidden");
              }
            });

            box.appendChild(fieldRow(label, desc, input));
            box.appendChild(help);
            return box;
          },
        };
      }

      function sel(key, label, options, desc) {
        return {
          render(cfg) {
            const select = document.createElement("select");
            select.className =
              "w-32 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300";
            select.setAttribute("aria-label", label);
            select.innerHTML = options.map((o) =>
              `<option value="${escapeHtml(o)}">${
                escapeHtml(o)
              }</option>`
            ).join("");
            select.value = cfg[key];
            select.addEventListener(
              "change",
              () => cfg[key] = select.value,
            );
            return fieldRow(label, desc, select);
          },
        };
      }

      function tog(key, label, desc) {
        return {
          render(cfg) {
            const btn = document.createElement("button");
            btn.className =
              "px-3 py-2 rounded-xl font-extrabold border focus:outline-none focus:ring-2 focus:ring-blue-300";
            btn.setAttribute("aria-label", label);
            const update = () => {
              const on = !!cfg[key];
              btn.textContent = on ? "‚úÖ On" : "‚¨ú Off";
              btn.classList.toggle("bg-emerald-50", on);
              btn.classList.toggle("border-emerald-200", on);
              btn.classList.toggle("text-emerald-700", on);
              btn.classList.toggle("bg-slate-100", !on);
              btn.classList.toggle("border-slate-200", !on);
              btn.classList.toggle("text-slate-700", !on);
            };
            btn.addEventListener("click", () => {
              cfg[key] = !cfg[key];
              update();
            });
            update();
            return fieldRow(label, desc, btn);
          },
        };
      }

      function fixed(key, label, value, desc) {
        return {
          render(cfg) {
            cfg[key] = value;
            const pill = document.createElement("div");
            pill.className =
              "px-3 py-2 rounded-xl bg-slate-900 text-white font-extrabold text-sm";
            pill.textContent = value;
            return fieldRow(label, desc, pill);
          },
        };
      }

      // =========================
      // Upload Dataset Modal
      // =========================
      function openUploadModal() {
        openModal((body) => {
          let parsed = null;

          body.innerHTML = `
          <div class="space-y-4">
            <div id="dropZone" class="rounded-3xl border-2 border-dashed border-slate-300 bg-slate-50 p-6 text-center hover:bg-slate-100">
              <div class="text-4xl" aria-hidden="true">üìÅ</div>
              <div class="mt-2 font-extrabold">Drop JSON file here or tap to browse</div>
              <div class="mt-1 text-sm text-slate-600">Expected: {"coordinates":[[...],[...]]}</div>
              <input id="fileInput" type="file" accept=".json,application/json" class="hidden" aria-label="Upload JSON file" />
              <button id="btnBrowse" class="mt-4 px-4 py-3 rounded-2xl font-bold bg-slate-900 text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Browse files">Browse</button>
            </div>

            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Or paste JSON</div>
              <textarea id="pasteArea" class="mt-2 w-full h-40 rounded-2xl border border-slate-200 bg-white p-3 font-mono text-xs focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Paste JSON"></textarea>
            </div>

            <details class="rounded-2xl border border-slate-200 bg-white p-4">
              <summary class="font-extrabold cursor-pointer">Format example</summary>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code id="fmtExample">{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
              <button id="btnCopyExample" class="mt-3 px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Copy example">Copy example</button>
            </details>

            <div id="previewOk" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-800">
              <div class="font-extrabold">‚úÖ Valid dataset</div>
              <div class="mt-1 text-sm">Dimensions: <span id="pDims" class="font-bold"></span> ‚Ä¢ Steps: <span id="pSteps" class="font-bold"></span></div>
            </div>

            <div id="previewErr" class="hidden rounded-2xl border border-red-200 bg-red-50 p-4 text-red-800">
              <div class="font-extrabold">‚ùå Invalid dataset</div>
              <div id="pErr" class="mt-1 text-sm"></div>
            </div>

            <div class="pt-2 border-t border-slate-200 flex flex-col sm:flex-row gap-2">
              <button id="upCancel" class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Cancel">Cancel</button>
              <button id="upValidate" class="px-4 py-3 rounded-2xl font-bold bg-slate-900 text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Validate">Validate</button>
              <button id="upApplyTrain" class="sm:ml-auto px-4 py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Apply and train" disabled>Apply & Train</button>
            </div>
          </div>
        `;

          const dz = body.querySelector("#dropZone");
          const fileInput = body.querySelector("#fileInput");
          const browse = body.querySelector("#btnBrowse");
          const paste = body.querySelector("#pasteArea");
          const btnCopyExample = body.querySelector("#btnCopyExample");
          const upCancel = body.querySelector("#upCancel");
          const upValidate = body.querySelector("#upValidate");
          const upApplyTrain = body.querySelector("#upApplyTrain");

          browse.addEventListener("click", () => fileInput.click());

          dz.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            fileInput.click();
          });

          dz.addEventListener("dragover", (e) => {
            e.preventDefault();
            dz.classList.add("bg-slate-100");
          });
          dz.addEventListener(
            "dragleave",
            () => dz.classList.remove("bg-slate-100"),
          );
          dz.addEventListener("drop", async (e) => {
            e.preventDefault();
            dz.classList.remove("bg-slate-100");
            const f = e.dataTransfer.files?.[0];
            if (!f) return;
            try {
              const text = await f.text();
              paste.value = text;
              validate();
            } catch (err) {
              errorToast(err, "File read failed");
            }
          });

          fileInput.addEventListener("change", async () => {
            try {
              const f = fileInput.files?.[0];
              if (!f) return;
              const text = await f.text();
              paste.value = text;
              validate();
            } catch (err) {
              errorToast(err, "File read failed");
            }
          });

          btnCopyExample.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(
                body.querySelector("#fmtExample").textContent,
              );
              toast("success", "Example copied.");
            } catch (err) {
              errorToast(err, "Copy example failed");
            }
          });

          function setPreview(ok, dims, steps, errMsg) {
            body.querySelector("#previewOk").classList.toggle(
              "hidden",
              !ok,
            );
            body.querySelector("#previewErr").classList.toggle(
              "hidden",
              ok,
            );
            upApplyTrain.disabled = !ok;

            if (ok) {
              body.querySelector("#pDims").textContent = String(dims);
              body.querySelector("#pSteps").textContent = String(steps);
            } else {
              body.querySelector("#pErr").textContent = errMsg ||
                "Invalid JSON.";
            }
          }

          function validate() {
            try {
              const text = paste.value.trim();
              if (!text) {
                setPreview(false, 0, 0, "Paste JSON or upload a file.");
                parsed = null;
                return;
              }
              const obj = JSON.parse(text);
              const coords = obj?.coordinates;
              validateCoordinates(coords);
              const dims = coords[0].length;
              setPreview(true, dims, coords.length, "");
              parsed = coords;
            } catch (err) {
              parsed = null;
              setPreview(false, 0, 0, err.message || String(err));
            }
          }

          upValidate.addEventListener("click", () => {
            try {
              validate();
              if (parsed) toast("success", "Dataset validated.");
            } catch (err) {
              errorToast(err, "Validate failed");
            }
          });

          upApplyTrain.addEventListener("click", async () => {
            try {
              validate();
              if (!parsed) return;
              closeModal();
              if (!appState.modelExists) {
                await createModel(appState.config);
              }
              await trainOnDataset(parsed);
            } catch (err) {
              errorToast(err, "Apply & Train failed");
            }
          });

          upCancel.addEventListener("click", closeModal);
        }, { title: "üì§ Upload Dataset", wide: true });
      }

      function validateCoordinates(coords) {
        if (!Array.isArray(coords) || coords.length < 2) {
          throw new Error(
            "coordinates must be an array with at least 2 rows.",
          );
        }
        const dims = coords[0];
        if (!Array.isArray(dims) || dims.length < 1) {
          throw new Error(
            "Each coordinate row must be a non-empty array.",
          );
        }
        const n = dims.length;
        for (let i = 0; i < coords.length; i++) {
          const row = coords[i];
          if (!Array.isArray(row) || row.length !== n) {
            throw new Error(`Row ${i} must have exactly ${n} values.`);
          }
          for (let d = 0; d < n; d++) {
            const v = Number(row[d]);
            if (!Number.isFinite(v)) {
              throw new Error(
                `Row ${i}, col ${d} is not a finite number.`,
              );
            }
          }
        }
      }

      // =========================
      // Manual Insert Modal
      // =========================
      function openManualModal() {
        openModal((body) => {
          const dims = appState.nDimensions || 3;
          body.innerHTML = `
          <div class="space-y-4">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
              Insert time steps as JSON. You can paste one dataset object or just { "coordinates": [...] }.
            </div>

            <button id="btnGenTemplate" class="px-4 py-3 rounded-2xl font-bold bg-amber-500 text-white hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-300" aria-label="Generate template">
              üß© Generate Template
            </button>

            <textarea id="manualArea" class="w-full h-48 rounded-2xl border border-slate-200 bg-white p-3 font-mono text-xs focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Manual JSON"></textarea>

            <div id="manualValidation" class="hidden rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-800"></div>

            <div class="pt-2 border-t border-slate-200 flex flex-col sm:flex-row gap-2">
              <button id="manualCancel" class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Cancel">Cancel</button>
              <button id="manualApply" class="sm:ml-auto px-4 py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Insert and train">Insert & Train</button>
            </div>
          </div>
        `;

          const area = body.querySelector("#manualArea");
          const box = body.querySelector("#manualValidation");

          body.querySelector("#btnGenTemplate").addEventListener(
            "click",
            async () => {
              try {
                const template = {
                  coordinates: [
                    Array.from({ length: dims }, (_, i) => i + 1),
                    Array.from({ length: dims }, (_, i) => i + 1.1),
                  ],
                };
                area.value = JSON.stringify(template, null, 2);
                toast("info", "Template generated.");
              } catch (err) {
                errorToast(err, "Template failed");
              }
            },
          );

          body.querySelector("#manualCancel").addEventListener(
            "click",
            closeModal,
          );

          body.querySelector("#manualApply").addEventListener(
            "click",
            async () => {
              try {
                box.classList.add("hidden");
                const obj = JSON.parse(area.value);
                const coords = obj?.coordinates ??
                  obj?.dataset?.coordinates ?? null;
                validateCoordinates(coords);

                // append into existing dataset if present
                const merged = appState.dataset?.coordinates
                  ? appState.dataset.coordinates.concat(coords)
                  : coords;

                closeModal();
                if (!appState.modelExists) {
                  await createModel(appState.config);
                }
                await trainOnDataset(merged);
              } catch (err) {
                box.textContent = err.message || String(err);
                box.classList.remove("hidden");
                toast("error", "Invalid manual JSON.");
                pushLog("error", "Manual insert validation failed.");
              }
            },
          );
        }, { title: "‚ûï Manual Insert", wide: true });
      }

      // =========================
      // Save & Load Modal
      // =========================
      function getSavedModels() {
        return loadLS(LS_KEYS.savedModels, []);
      }
      function setSavedModels(list) {
        saveLS(LS_KEYS.savedModels, list);
      }

      async function saveToDownload() {
        try {
          if (!appState.modelExists) {
            throw new Error("No model to save.");
          }
          showLoading(true, "Saving model‚Ä¶", 0);
          const p = Engine.request("save", {});
          const pendingId = [...Engine.pending.keys()].slice(-1)[0];
          appState.activeOp = { requestId: pendingId, type: "save" };

          const res = await p;
          showLoading(false);

          const payload = {
            moduleUrl: appState.moduleUrl,
            config: appState.config,
            state: res.state,
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "esn-model.json";
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 500);

          toast("success", "Model downloaded.");
          pushLog("success", "Model downloaded.");
        } catch (err) {
          showLoading(false);
          errorToast(err, "Save failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      async function saveToBrowser() {
        try {
          if (!appState.modelExists) {
            throw new Error("No model to save.");
          }
          const name = prompt(
            "Name this model:",
            `Model ${new Date().toLocaleString()}`,
          ) || "";
          if (!name.trim()) return;

          showLoading(true, "Saving model to browser‚Ä¶", 0);
          const p = Engine.request("save", {});
          const pendingId = [...Engine.pending.keys()].slice(-1)[0];
          appState.activeOp = { requestId: pendingId, type: "save" };

          const res = await p;
          showLoading(false);

          const list = getSavedModels();
          list.unshift({
            id: crypto.randomUUID
              ? crypto.randomUUID()
              : String(Date.now()) + Math.random(),
            name: name.trim(),
            savedAt: new Date().toISOString(),
            moduleUrl: appState.moduleUrl,
            config: appState.config,
            state: res.state,
          });
          setSavedModels(list.slice(0, 50));

          toast("success", "Saved in browser.");
          pushLog("success", "Model saved to localStorage.");
        } catch (err) {
          showLoading(false);
          errorToast(err, "Save to browser failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      async function loadModelPayload(payload) {
        try {
          if (!payload?.state) {
            throw new Error("Invalid model payload.");
          }

          if (
            payload.moduleUrl &&
            payload.moduleUrl !== appState.moduleUrl
          ) {
            appState.moduleUrl = payload.moduleUrl;
            saveLS(LS_KEYS.moduleUrl, appState.moduleUrl);
            await Engine.init();
          }

          // Apply config first
          if (payload.config) {
            appState.config = payload.config;
            saveLS(LS_KEYS.config, appState.config);
          }

          if (!appState.modelExists) {
            await createModel(appState.config);
          }

          showLoading(true, "Loading model‚Ä¶", 0);
          const p = Engine.request("load", { state: payload.state });
          const pendingId = [...Engine.pending.keys()].slice(-1)[0];
          appState.activeOp = { requestId: pendingId, type: "load" };

          await p;
          showLoading(false);

          appState.modelExists = true;
          await refreshSummary();

          toast("success", "Model loaded.");
          pushLog("success", "Model loaded.");
          updateModeUI();
          render();
        } catch (err) {
          showLoading(false);
          errorToast(err, "Load failed");
        } finally {
          appState.activeOp = { requestId: null, type: null };
        }
      }

      function openSaveLoadModal() {
        openModal((body) => {
          body.innerHTML = `
          <div class="space-y-5">
            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Save</div>
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button id="btnDl" class="px-4 py-3 rounded-2xl font-extrabold bg-slate-900 text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Download model">üì• Download</button>
                <button id="btnLs" class="px-4 py-3 rounded-2xl font-extrabold bg-emerald-500 text-white hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-300" aria-label="Save to browser">üíæ Browser</button>
              </div>
              <div class="mt-2 text-xs text-slate-500">Saves include module URL + config + model state.</div>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Load</div>

              <div id="loadZone" class="mt-3 rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 p-4 text-center hover:bg-slate-100">
                <div class="text-3xl" aria-hidden="true">üì§</div>
                <div class="mt-2 font-extrabold">Tap-to-upload zone</div>
                <div class="mt-1 text-sm text-slate-600">Select an .json model export</div>
                <input id="loadFile" type="file" accept=".json,application/json" class="hidden" aria-label="Upload model JSON" />
                <button id="btnBrowseModel" class="mt-3 px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Browse model file">Browse</button>
              </div>

              <div class="mt-4">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-extrabold">Saved in Browser</div>
                  <button id="btnClearSaved" class="text-sm font-bold text-red-600 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-300 rounded-lg px-2 py-1" aria-label="Clear all saved models">Clear all saved models</button>
                </div>
                <div id="savedList" class="mt-3 space-y-2"></div>
              </div>
            </section>
          </div>
        `;

          body.querySelector("#btnDl").addEventListener(
            "click",
            saveToDownload,
          );
          body.querySelector("#btnLs").addEventListener(
            "click",
            saveToBrowser,
          );

          const loadFile = body.querySelector("#loadFile");
          body.querySelector("#btnBrowseModel").addEventListener(
            "click",
            () => loadFile.click(),
          );
          body.querySelector("#loadZone").addEventListener(
            "click",
            (e) => {
              if (e.target.closest("button")) return;
              loadFile.click();
            },
          );

          loadFile.addEventListener("change", async () => {
            try {
              const f = loadFile.files?.[0];
              if (!f) return;
              const text = await f.text();
              const payload = JSON.parse(text);
              closeModal();
              await loadModelPayload(payload);
            } catch (err) {
              errorToast(err, "Model file load failed");
            }
          });

          body.querySelector("#btnClearSaved").addEventListener(
            "click",
            () => {
              if (!confirm("Clear all saved models?")) return;
              setSavedModels([]);
              toast("warning", "Saved models cleared.");
              pushLog("warning", "Saved models cleared.");
              renderSaved();
            },
          );

          function renderSaved() {
            const list = getSavedModels();
            const host = body.querySelector("#savedList");
            host.innerHTML = "";
            if (!list.length) {
              host.innerHTML =
                `<div class="text-sm text-slate-500">No saved models.</div>`;
              return;
            }
            for (const m of list) {
              const row = document.createElement("div");
              row.className =
                "rounded-2xl border border-slate-200 bg-slate-50 p-3 flex items-center justify-between gap-3";
              row.innerHTML = `
              <div class="min-w-0">
                <div class="font-extrabold truncate">${
                escapeHtml(m.name)
              }</div>
                <div class="text-xs text-slate-500">Saved: ${
                escapeHtml(new Date(m.savedAt).toLocaleString())
              }</div>
              </div>
              <button class="px-3 py-2 rounded-xl font-extrabold bg-emerald-500 text-white hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-300" aria-label="Load saved model">Load</button>
            `;
              row.querySelector("button").addEventListener(
                "click",
                async () => {
                  closeModal();
                  await loadModelPayload(m);
                },
              );
              host.appendChild(row);
            }
          }
          renderSaved();
        }, { title: "üíæ Save & Load", wide: true });
      }

      // =========================
      // Random Test Modal
      // =========================
      function mulberry32(seed) {
        let t = seed >>> 0;
        return function () {
          t += 0x6D2B79F5;
          let r = Math.imul(t ^ t >>> 15, 1 | t);
          r ^= r + Math.imul(r ^ r >>> 7, 61 | r);
          return ((r ^ r >>> 14) >>> 0) / 4294967296;
        };
      }

      function openRandomModal() {
        openModal((body) => {
          body.innerHTML = `
          <div class="space-y-4">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
              Generates a synthetic multivariate time series with noise/outliers, then trains and predicts.
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtSeed">Seed</label>
                <input id="rtSeed" type="number" value="42" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Seed" />
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtDims">Dimensions</label>
                <input id="rtDims" type="number" min="1" value="3" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Dimensions" />
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtSteps">Time Steps</label>
                <input id="rtSteps" type="number" min="2" value="200" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Time steps" />
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtNoise">Noise</label>
                <input id="rtNoise" type="number" min="0" value="0.1" step="0.01" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Noise" />
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtOut">Outliers rate</label>
                <input id="rtOut" type="number" min="0" max="1" value="0.02" step="0.01" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Outliers rate" />
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700" for="rtDiff">Difficulty</label>
                <select id="rtDiff" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Difficulty">
                  <option>Easy</option>
                  <option selected>Medium</option>
                  <option>Hard</option>
                </select>
              </div>
            </div>

            <div id="rtValidation" class="hidden rounded-2xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"></div>

            <div class="pt-2 border-t border-slate-200 flex flex-col sm:flex-row gap-2">
              <button id="rtCancel" class="px-4 py-3 rounded-2xl font-bold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Cancel">Cancel</button>
              <button id="rtRun" class="sm:ml-auto px-4 py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-purple-300" aria-label="Generate and run">‚ú® Generate & Run</button>
            </div>
          </div>
        `;

          const vbox = body.querySelector("#rtValidation");

          body.querySelector("#rtCancel").addEventListener(
            "click",
            closeModal,
          );

          body.querySelector("#rtRun").addEventListener(
            "click",
            async () => {
              try {
                vbox.classList.add("hidden");
                const seed = Number(
                  body.querySelector("#rtSeed").value,
                );
                const dims = Number(
                  body.querySelector("#rtDims").value,
                );
                const steps = Number(
                  body.querySelector("#rtSteps").value,
                );
                const noise = Number(
                  body.querySelector("#rtNoise").value,
                );
                const outRate = Number(
                  body.querySelector("#rtOut").value,
                );
                const diff = body.querySelector("#rtDiff").value;

                if (!Number.isFinite(seed)) {
                  throw new Error("Seed must be a number.");
                }
                if (
                  !Number.isFinite(dims) || dims < 1 ||
                  Math.floor(dims) !== dims
                ) {
                  throw new Error(
                    "Dimensions must be a positive integer.",
                  );
                }
                if (
                  !Number.isFinite(steps) || steps < 2 ||
                  Math.floor(steps) !== steps
                ) {
                  throw new Error(
                    "Time steps must be an integer >= 2.",
                  );
                }
                if (
                  !Number.isFinite(noise) || noise < 0
                ) throw new Error("Noise must be >= 0.");
                if (
                  !Number.isFinite(outRate) || outRate < 0 ||
                  outRate > 1
                ) {
                  throw new Error(
                    "Outliers rate must be between 0 and 1.",
                  );
                }

                closeModal();

                const coords = generateRandomSeries(
                  seed,
                  dims,
                  steps,
                  noise,
                  outRate,
                  diff,
                );
                if (!appState.modelExists) {
                  await createModel(appState.config);
                }
                await trainOnDataset(coords);

                const future = validatePositiveInt(
                  $("#inputFutureSteps"),
                  $("#futureStepsValidation"),
                  "Future steps",
                ) || 150;
                await runPrediction(future);

                toast("success", "Random test complete.");
                pushLog("success", "Random test complete.");
              } catch (err) {
                vbox.textContent = err.message || String(err);
                vbox.classList.remove("hidden");
                toast("error", "Random test failed.");
                pushLog("error", "Random test failed.");
              }
            },
          );
        }, { title: "üß™ Random Test", wide: true });
      }

      function generateRandomSeries(
        seed,
        dims,
        steps,
        noise,
        outRate,
        diff,
      ) {
        const rnd = mulberry32(Math.floor(seed));
        const coords = [];
        const baseFreq = diff === "Easy"
          ? 0.06
          : diff === "Medium"
          ? 0.09
          : 0.13;
        const drift = diff === "Hard" ? 0.006 : 0.003;

        const phases = Array.from(
          { length: dims },
          () => rnd() * Math.PI * 2,
        );
        const amps = Array.from(
          { length: dims },
          (_, i) => 1 + i * 0.35,
        );

        let state = Array.from(
          { length: dims },
          () => (rnd() - 0.5) * 0.5,
        );

        for (let t = 0; t < steps; t++) {
          const row = [];
          for (let d = 0; d < dims; d++) {
            const s = Math.sin((t * baseFreq) + phases[d]) * amps[d];
            const c = Math.cos((t * baseFreq * 0.7) + phases[d] * 0.7) *
              (amps[d] * 0.6);
            state[d] = 0.86 * state[d] + 0.14 * (s + c) +
              (rnd() - 0.5) * drift;
            let v = state[d] + (rnd() - 0.5) * 2 * noise;

            if (rnd() < outRate) {
              v += (rnd() - 0.5) * 10 * (diff === "Hard" ? 1.6 : 1.0);
            }
            row.push(v);
          }
          coords.push(row);
        }
        return coords;
      }

      // =========================
      // Settings Modal
      // =========================
      function openSettingsModal() {
        openModal((body) => {
          body.innerHTML = `
          <div class="space-y-4">
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 font-semibold">Module URL</div>
              <input id="modUrl" type="text" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 font-mono text-xs focus:outline-none focus:ring-2 focus:ring-amber-300" aria-label="Module URL" />
              <div class="mt-2 text-xs text-slate-500">Default: ${
            escapeHtml(DEFAULT_MODULE_URL)
          }</div>
              <div id="modUrlErr" class="hidden mt-2 text-sm text-red-600"></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <button id="btnReinit" class="px-4 py-3 rounded-2xl font-extrabold bg-amber-500 text-white hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-300" aria-label="Reinitialize worker">üîÑ Reinitialize Worker</button>
              <button id="btnClearPrefs" class="px-4 py-3 rounded-2xl font-extrabold bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300" aria-label="Clear all preferences">üß® Clear Preferences</button>
            </div>
          </div>
        `;

          const input = body.querySelector("#modUrl");
          input.value = appState.moduleUrl;

          body.querySelector("#btnReinit").addEventListener(
            "click",
            async () => {
              try {
                const url = input.value.trim();
                if (!url.startsWith("http")) {
                  throw new Error(
                    "Module URL must start with http(s).",
                  );
                }
                appState.moduleUrl = url;
                saveLS(LS_KEYS.moduleUrl, appState.moduleUrl);
                await Engine.init();
                toast("success", "Worker reinitialized.");
                pushLog("success", "Worker reinitialized.");
                closeModal();
              } catch (err) {
                body.querySelector("#modUrlErr").textContent =
                  err.message || String(err);
                body.querySelector("#modUrlErr").classList.remove(
                  "hidden",
                );
                errorToast(err, "Reinitialize failed");
              }
            },
          );

          body.querySelector("#btnClearPrefs").addEventListener(
            "click",
            () => {
              if (
                !confirm(
                  "Clear stored config + vizMode + module URL preferences?",
                )
              ) return;
              localStorage.removeItem(LS_KEYS.config);
              localStorage.removeItem(LS_KEYS.vizMode);
              localStorage.removeItem(LS_KEYS.moduleUrl);
              appState.config = structuredClone(DEFAULT_CONFIG);
              appState.vizMode = "grid";
              appState.moduleUrl = DEFAULT_MODULE_URL;
              toast("warning", "Preferences cleared.");
              pushLog("warning", "Preferences cleared.");
              closeModal();
              setMode(appState.vizMode);
            },
          );
        }, { title: "üîß Settings", wide: true });
      }

      // =========================
      // Data Table Modal (full-screen)
      // =========================
      function openDataTableModal() {
        openModal((body) => {
          const pred = appState.predictions;
          if (!pred?.predictions) {
            body.innerHTML =
              `<div class="text-sm text-slate-600">No predictions available.</div>`;
            return;
          }

          let sortKey = "step";
          let sortDir = "asc";
          let filter = "";

          body.innerHTML = `
          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
              <div class="flex items-center gap-2">
                <button id="btnCsv" class="px-4 py-3 rounded-2xl font-extrabold bg-slate-900 text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Export CSV">üìä Export CSV</button>
                <button id="btnCopyAll" class="px-4 py-3 rounded-2xl font-extrabold bg-slate-100 border border-slate-200 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Copy all">üìã Copy All</button>
              </div>
              <input id="tblSearch" type="text" class="w-full sm:w-72 rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Search step/value‚Ä¶" aria-label="Search table" />
            </div>

            <div class="rounded-2xl border border-slate-200 overflow-hidden">
              <div class="max-h-[65vh] overflow-auto">
                <table class="w-full text-xs font-mono">
                  <thead class="sticky top-0 bg-slate-900 text-white">
                    <tr id="tblHead"></tr>
                  </thead>
                  <tbody id="tblBody" class="bg-white"></tbody>
                </table>
              </div>
            </div>
          </div>
        `;

          const nDims = pred.predictions[0].length;
          const head = body.querySelector("#tblHead");
          const tbody = body.querySelector("#tblBody");
          const search = body.querySelector("#tblSearch");

          const cols = [
            { key: "step", label: "Step" },
            ...Array.from(
              { length: nDims },
              (_, i) => ({ key: `p${i}`, label: `P${i + 1}` }),
            ),
            ...Array.from(
              { length: nDims },
              (_, i) => ({ key: `l${i}`, label: `L${i + 1}` }),
            ),
            ...Array.from(
              { length: nDims },
              (_, i) => ({ key: `u${i}`, label: `U${i + 1}` }),
            ),
          ];

          function buildRows() {
            const rows = [];
            for (let s = 0; s < pred.predictions.length; s++) {
              const row = { step: s };
              for (let d = 0; d < nDims; d++) {
                row[`p${d}`] = pred.predictions[s][d];
                row[`l${d}`] = pred.lowerBounds?.[s]?.[d];
                row[`u${d}`] = pred.upperBounds?.[s]?.[d];
              }
              rows.push(row);
            }
            return rows;
          }
          const allRows = buildRows();

          function renderTable() {
            filter = search.value.trim().toLowerCase();

            let rows = allRows;
            if (filter) {
              rows = rows.filter((r) => {
                if (String(r.step).includes(filter)) return true;
                for (let d = 0; d < nDims; d++) {
                  const p = r[`p${d}`], l = r[`l${d}`], u = r[`u${d}`];
                  if (String(p).toLowerCase().includes(filter)) {
                    return true;
                  }
                  if (String(l).toLowerCase().includes(filter)) {
                    return true;
                  }
                  if (String(u).toLowerCase().includes(filter)) {
                    return true;
                  }
                }
                return false;
              });
            }

            rows = rows.slice().sort((a, b) => {
              const av = a[sortKey], bv = b[sortKey];
              const na = Number(av), nb = Number(bv);
              const cmp = (Number.isFinite(na) && Number.isFinite(nb))
                ? (na - nb)
                : String(av).localeCompare(String(bv));
              return sortDir === "asc" ? cmp : -cmp;
            });

            // head
            head.innerHTML = "";
            for (const c of cols) {
              const th = document.createElement("th");
              th.className =
                "px-3 py-3 text-left cursor-pointer select-none";
              th.textContent = c.label +
                (sortKey === c.key
                  ? (sortDir === "asc" ? " ‚ñ≤" : " ‚ñº")
                  : "");
              th.setAttribute("aria-label", `Sort by ${c.label}`);
              th.addEventListener("click", () => {
                if (sortKey === c.key) {
                  sortDir = sortDir === "asc" ? "desc" : "asc";
                } else {
                  sortKey = c.key;
                  sortDir = "asc";
                }
                renderTable();
              });
              head.appendChild(th);
            }

            // body
            tbody.innerHTML = "";
            rows.forEach((r, idx) => {
              const tr = document.createElement("tr");
              tr.className = idx % 2 === 0
                ? "bg-white hover:bg-blue-50"
                : "bg-slate-50 hover:bg-blue-50";
              tr.title = "Tap row for details";
              tr.addEventListener("click", () => {
                const details = cols.map((c) =>
                  `${c.label}: ${r[c.key] ?? "‚Äî"}`
                ).join("\n");
                toast(
                  "info",
                  details.slice(0, 120) +
                    (details.length > 120 ? "‚Ä¶" : ""),
                );
              });

              for (const c of cols) {
                const td = document.createElement("td");
                td.className = "px-3 py-2 text-slate-900 tabular-nums";
                const v = r[c.key];
                td.textContent = c.key === "step"
                  ? String(v)
                  : (v == null ? "‚Äî" : formatNum(v));
                tr.appendChild(td);
              }
              tbody.appendChild(tr);
            });
          }

          search.addEventListener("input", renderTable);

          body.querySelector("#btnCsv").addEventListener(
            "click",
            () => {
              try {
                const header = cols.map((c) => c.label).join(",");
                const lines = [header];
                for (const r of allRows) {
                  lines.push(
                    cols.map((c) => {
                      const v = r[c.key];
                      const s = (v == null) ? "" : String(v);
                      return `"${s.replaceAll('"', '""')}"`;
                    }).join(","),
                  );
                }
                const blob = new Blob([lines.join("\n")], {
                  type: "text/csv",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "esn-predictions.csv";
                a.click();
                setTimeout(() => URL.revokeObjectURL(url), 500);
                pushLog("success", "CSV exported.");
              } catch (err) {
                errorToast(err, "CSV export failed");
              }
            },
          );

          body.querySelector("#btnCopyAll").addEventListener(
            "click",
            async () => {
              try {
                const header = cols.map((c) => c.label).join("\t");
                const lines = [header];
                for (const r of allRows) {
                  lines.push(
                    cols.map((c) => {
                      const v = r[c.key];
                      return v == null ? "" : String(v);
                    }).join("\t"),
                  );
                }
                await navigator.clipboard.writeText(lines.join("\n"));
                toast("success", "Table copied.");
                pushLog("success", "Table copied to clipboard.");
              } catch (err) {
                errorToast(err, "Copy table failed");
              }
            },
          );

          renderTable();
        }, { title: "üìã Data Table", fullscreen: true });
      }

      // =========================
      // Help Modal
      // =========================
      function openHelpModal() {
        openModal((body) => {
          body.innerHTML = `
          <div class="space-y-5">
            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Worker Setup</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>The ESNRegression library runs in a Web Worker for non-blocking performance.
Module URL: ${escapeHtml(DEFAULT_MODULE_URL)}</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Creating a Model</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>const model = new ESNRegression(config);</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Online Training (fitOnline)</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call (t, t+1), (t+2, t+3)...
// Returns: { averageLoss, gradientNorm, sampleWeight }</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Prediction</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Save/Load</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>const state = model.save();
model.load(state);</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Model Summary</div>
              <pre class="mt-3 rounded-2xl bg-slate-900 text-white p-4 overflow-auto text-xs"><code>const summary = model.getModelSummary();
// Returns: { nFeatures, sampleCount, ... }</code></pre>
            </section>

            <section class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="font-extrabold">Preset Configurations</div>
              <div class="mt-2 text-sm text-slate-700 space-y-1">
                <div>‚Ä¢ Start Here/Default: reservoirSize=256, spectralRadius=0.9, leakRate=0.3</div>
                <div>‚Ä¢ Fast: reservoirSize=64, reservoirSparsity=0.95</div>
                <div>‚Ä¢ Balanced: reservoirSize=256, spectralRadius=0.9</div>
                <div>‚Ä¢ Accurate: reservoirSize=512, spectralRadius=0.95, leakRate=0.2</div>
                <div>‚Ä¢ Adaptive: rlsLambda=0.97, spectralRadius=0.85, leakRate=0.5</div>
                <div>‚Ä¢ Robust: outlierThreshold=2.0, outlierMinWeight=0.05, l2Lambda=0.01, leakRate=0.2</div>
              </div>
            </section>
          </div>
        `;
        }, { title: "‚ùì Help", wide: true });
      }

      // =========================
      // Header/Buttons wiring
      // =========================
      $("#btnConfig").addEventListener("click", openConfigModal);
      $("#btnLoadQuick").addEventListener("click", openSaveLoadModal);

      $("#btnStartDefaults").addEventListener("click", async () => {
        try {
          appState.config = structuredClone(DEFAULT_CONFIG);
          saveLS(LS_KEYS.config, appState.config);
          await createModel(appState.config);
          toast(
            "success",
            "Defaults applied. Upload data or run Random Test next.",
          );
          pushLog("success", "Started with defaults.");
        } catch (err) {
          errorToast(err, "Start failed");
        }
      });

      $("#btnDemo").addEventListener("click", async () => {
        try {
          closeModal();
          // demo: create model + random dataset + train + predict
          if (!appState.modelExists) await createModel(appState.config);
          const coords = generateRandomSeries(
            42,
            3,
            220,
            0.08,
            0.02,
            "Medium",
          );
          await trainOnDataset(coords);
          await runPrediction(
            validatePositiveInt(
              $("#inputFutureSteps"),
              $("#futureStepsValidation"),
              "Future steps",
            ) || 150,
          );
          setMode("focus");
          buildDimSelector();
          toast("success", "Demo loaded.");
          pushLog("success", "Demo loaded.");
        } catch (err) {
          errorToast(err, "Demo failed");
        }
      });

      // =========================
      // Init
      // =========================
      (async function boot() {
        try {
          pushLog("info", "Booting ESN Regression Studio‚Ä¶");
          updateModeUI();
          renderHeader();
          renderMetrics();
          renderLogs();

          await Engine.init();

          // Set initial mode tab state
          setMode(appState.vizMode);

          // Canvas sizing
          resizeCanvas();

          // Predict header button wiring (also toggles by renderHeader)
          $("#btnPredictHeader").addEventListener(
            "click",
            () => $("#btnRunPredict").click(),
          );

          // Global keyboard escape for modal/menu
          window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              if (!$("#modalHost").classList.contains("hidden")) {
                closeModal();
              }
              if (!$("#menuWrap").classList.contains("hidden")) {
                closeMenu();
              }
            }
          });

          // Extra: future steps validate
          $("#inputFutureSteps").addEventListener(
            "input",
            () =>
              validatePositiveInt(
                $("#inputFutureSteps"),
                $("#futureStepsValidation"),
                "Future steps",
              ),
          );

          // Graceful baseline render
          render();
        } catch (err) {
          errorToast(err, "Boot failed");
        }
      })();
    </script>
  </body>
</html>
