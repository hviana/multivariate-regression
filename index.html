<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
                950: "#082f49",
              },
              surface: {
                50: "#fafafa",
                100: "#f4f4f5",
                200: "#e4e4e7",
                300: "#d4d4d8",
                400: "#a1a1aa",
                500: "#71717a",
                600: "#52525b",
                700: "#3f3f46",
                800: "#27272a",
                900: "#18181b",
                950: "#09090b",
              },
            },
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-right": "slideRight 0.3s ease-out",
              "pulse-soft": "pulseSoft 2s infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
              slideUp: {
                "0%": { transform: "translateY(10px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              slideRight: {
                "0%": { transform: "translateX(-100%)" },
                "100%": { transform: "translateX(0)" },
              },
              pulseSoft: {
                "0%,100%": { opacity: "1" },
                "50%": { opacity: "0.7" },
              },
            },
          },
        },
      };
    </script>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      body {
        font-family: system-ui, -apple-system, sans-serif;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #a1a1aa;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #52525b;
      }
      .modal-overlay {
        backdrop-filter: blur(4px);
      }
      .chart-container {
        image-rendering: crisp-edges;
      }
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #0ea5e9, #38bdf8);
      }
      .dark input[type="range"]::-webkit-slider-runnable-track {
        background: linear-gradient(to right, #0369a1, #0ea5e9);
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        margin-top: -6px;
        cursor: pointer;
      }
      .animate-spin-slow {
        animation: spin 2s linear infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #e4e4e7 25%,
          #f4f4f5 50%,
          #e4e4e7 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #3f3f46 25%,
          #52525b 50%,
          #3f3f46 75%
        );
        background-size: 200% 100%;
      }
    </style>
  </head>
  <body
    class="bg-surface-50 dark:bg-surface-950 text-surface-900 dark:text-surface-100 transition-colors duration-300"
  >
    <div id="app" class="h-full flex flex-col">
      <header
        class="flex-shrink-0 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800 shadow-sm z-30"
      >
        <div class="flex items-center justify-between px-4 py-3">
          <div class="flex items-center gap-3">
            <button
              id="menuBtn"
              class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
              aria-label="Open menu"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-gradient-to-br from-brand-500 to-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/25"
              >
                <svg
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <div class="hidden sm:block">
                <h1
                  class="text-lg font-bold bg-gradient-to-r from-brand-600 to-brand-500 bg-clip-text text-transparent"
                >
                  ESN Regression Studio
                </h1>
                <p class="text-xs text-surface-500 dark:text-surface-400">
                  Multivariate Time Series Forecasting
                </p>
              </div>
            </div>
          </div>
          <div
            id="statusChips"
            class="hidden md:flex items-center gap-2 flex-wrap justify-center"
          >
            <span
              id="modelChip"
              class="px-2.5 py-1 text-xs font-medium rounded-full bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-400"
            >No Model</span>
            <span
              id="dataChip"
              class="px-2.5 py-1 text-xs font-medium rounded-full bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-400"
            >0 samples</span>
            <span
              id="dimChip"
              class="hidden px-2.5 py-1 text-xs font-medium rounded-full bg-brand-100 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300"
            ></span>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="quickUpload"
              class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
              aria-label="Upload data"
              title="Upload Data (U)"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
            </button>
            <button
              id="quickPredict"
              class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors disabled:opacity-40"
              aria-label="Run prediction"
              title="Predict (P)"
              disabled
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
            </button>
            <button
              id="themeToggle"
              class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
              aria-label="Toggle dark mode"
            >
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <svg
                class="w-5 h-5 block dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>
      <div class="flex-1 flex overflow-hidden">
        <aside
          id="sidebar"
          class="fixed inset-y-0 left-0 z-40 w-72 bg-white dark:bg-surface-900 border-r border-surface-200 dark:border-surface-800 transform -translate-x-full transition-transform duration-300 lg:relative lg:translate-x-0 flex flex-col shadow-xl lg:shadow-none"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800 lg:hidden"
          >
            <span class="font-semibold">Menu</span>
            <button
              id="closeSidebar"
              class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <nav class="flex-1 overflow-y-auto p-3 space-y-1">
            <div class="mb-3">
              <p
                class="px-3 py-2 text-xs font-semibold text-surface-400 dark:text-surface-500 uppercase tracking-wider"
              >
                Model
              </p>
              <button
                data-action="openConfig"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-brand-100 dark:bg-brand-900/30 flex items-center justify-center text-brand-600 dark:text-brand-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                </span>
                <span class="font-medium">Create / Configure</span>
              </button>
              <button
                data-action="showSummary"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                </span>
                <span class="font-medium">Model Summary</span>
              </button>
              <button
                data-action="openSaveLoad"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center text-violet-600 dark:text-violet-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                    />
                  </svg>
                </span>
                <span class="font-medium">Save / Load</span>
              </button>
            </div>
            <div class="mb-3">
              <p
                class="px-3 py-2 text-xs font-semibold text-surface-400 dark:text-surface-500 uppercase tracking-wider"
              >
                Data
              </p>
              <button
                data-action="openUpload"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                    />
                  </svg>
                </span>
                <span class="font-medium">Upload Dataset</span>
              </button>
              <button
                data-action="openInsert"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center text-cyan-600 dark:text-cyan-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                </span>
                <span class="font-medium">Manual Insert</span>
              </button>
              <button
                data-action="exportData"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center text-rose-600 dark:text-rose-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    />
                  </svg>
                </span>
                <span class="font-medium">Export Dataset</span>
              </button>
            </div>
            <div class="mb-3">
              <p
                class="px-3 py-2 text-xs font-semibold text-surface-400 dark:text-surface-500 uppercase tracking-wider"
              >
                Train & Predict
              </p>
              <button
                data-action="batchTrain"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                    />
                  </svg>
                </span>
                <span class="font-medium">Batch Train</span>
              </button>
              <button
                data-action="openPredict"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-fuchsia-100 dark:bg-fuchsia-900/30 flex items-center justify-center text-fuchsia-600 dark:text-fuchsia-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                  </svg>
                </span>
                <span class="font-medium">Forecast</span>
              </button>
            </div>
            <div class="mb-3">
              <p
                class="px-3 py-2 text-xs font-semibold text-surface-400 dark:text-surface-500 uppercase tracking-wider"
              >
                Quick Actions
              </p>
              <button
                data-action="openTest"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left bg-gradient-to-r from-brand-500 to-brand-600 text-white shadow-lg shadow-brand-500/25 hover:shadow-brand-500/40 transition-all group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                </span>
                <span class="font-medium">Run Standard Test</span>
              </button>
            </div>
            <div>
              <p
                class="px-3 py-2 text-xs font-semibold text-surface-400 dark:text-surface-500 uppercase tracking-wider"
              >
                Advanced
              </p>
              <button
                data-action="openAdvanced"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-surface-200 dark:bg-surface-700 flex items-center justify-center text-surface-600 dark:text-surface-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                    />
                  </svg>
                </span>
                <span class="font-medium">Advanced Settings</span>
              </button>
              <button
                data-action="openLogs"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-surface-200 dark:bg-surface-700 flex items-center justify-center text-surface-600 dark:text-surface-400 group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                </span>
                <span class="font-medium">Event Log</span>
              </button>
              <button
                data-action="resetAll"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors group"
              >
                <span
                  class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center group-hover:scale-110 transition-transform"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                </span>
                <span class="font-medium">Reset Everything</span>
              </button>
            </div>
          </nav>
        </aside>
        <div
          id="sidebarOverlay"
          class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"
        >
        </div>
        <main class="flex-1 flex flex-col overflow-hidden">
          <div id="mainContent" class="flex-1 overflow-y-auto p-4 lg:p-6">
            <div id="onboarding" class="max-w-2xl mx-auto">
              <div class="text-center mb-8">
                <div
                  class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-brand-500 to-brand-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-brand-500/30"
                >
                  <svg
                    class="w-10 h-10 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                    />
                  </svg>
                </div>
                <h2 class="text-3xl font-bold mb-2">
                  Welcome to ESN Regression Studio
                </h2>
                <p
                  class="text-surface-500 dark:text-surface-400 max-w-md mx-auto"
                >
                  A powerful tool for multivariate time series forecasting using
                  Echo State Networks with online learning.
                </p>
              </div>
              <div class="grid sm:grid-cols-3 gap-4">
                <button
                  data-action="quickStart"
                  class="group p-6 bg-white dark:bg-surface-900 rounded-2xl border-2 border-brand-200 dark:border-brand-800 hover:border-brand-500 dark:hover:border-brand-500 shadow-lg hover:shadow-xl transition-all text-center"
                >
                  <div
                    class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-brand-500 to-brand-600 rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30 group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>
                  </div>
                  <h3 class="font-bold text-lg mb-1">Start Here</h3>
                  <p class="text-sm text-surface-500 dark:text-surface-400">
                    Create a model with recommended settings
                  </p>
                </button>
                <button
                  data-action="openSaveLoad"
                  class="group p-6 bg-white dark:bg-surface-900 rounded-2xl border-2 border-surface-200 dark:border-surface-700 hover:border-brand-500 dark:hover:border-brand-500 shadow-lg hover:shadow-xl transition-all text-center"
                >
                  <div
                    class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-violet-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-500/30 group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                      />
                    </svg>
                  </div>
                  <h3 class="font-bold text-lg mb-1">Load Model</h3>
                  <p class="text-sm text-surface-500 dark:text-surface-400">
                    Resume from a saved model state
                  </p>
                </button>
                <button
                  data-action="openTest"
                  class="group p-6 bg-white dark:bg-surface-900 rounded-2xl border-2 border-surface-200 dark:border-surface-700 hover:border-brand-500 dark:hover:border-brand-500 shadow-lg hover:shadow-xl transition-all text-center"
                >
                  <div
                    class="w-14 h-14 mx-auto mb-3 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                      />
                    </svg>
                  </div>
                  <h3 class="font-bold text-lg mb-1">Standard Test</h3>
                  <p class="text-sm text-surface-500 dark:text-surface-400">
                    Generate data, train, and visualize
                  </p>
                </button>
              </div>
              <div
                class="mt-8 p-4 bg-surface-100 dark:bg-surface-800 rounded-xl"
              >
                <p
                  class="text-sm text-surface-600 dark:text-surface-400 text-center"
                >
                  <span class="font-medium">Keyboard shortcuts:</span>
                  <kbd
                    class="px-1.5 py-0.5 bg-white dark:bg-surface-700 rounded text-xs font-mono mx-1"
                  >M</kbd> Menu
                  <kbd
                    class="px-1.5 py-0.5 bg-white dark:bg-surface-700 rounded text-xs font-mono mx-1"
                  >C</kbd> Config
                  <kbd
                    class="px-1.5 py-0.5 bg-white dark:bg-surface-700 rounded text-xs font-mono mx-1"
                  >U</kbd> Upload
                  <kbd
                    class="px-1.5 py-0.5 bg-white dark:bg-surface-700 rounded text-xs font-mono mx-1"
                  >P</kbd> Predict
                </p>
              </div>
            </div>
            <div id="dashboard" class="hidden">
              <div class="flex flex-col lg:flex-row gap-6 h-full">
                <div class="flex-1 flex flex-col min-w-0">
                  <div
                    class="bg-white dark:bg-surface-900 rounded-2xl shadow-xl border border-surface-200 dark:border-surface-800 flex flex-col flex-1 overflow-hidden"
                  >
                    <div
                      class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800"
                    >
                      <div class="flex items-center gap-3">
                        <h3 class="font-bold text-lg">Visualization</h3>
                        <select
                          id="viewMode"
                          class="text-sm bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-brand-500"
                        >
                          <option value="grid">Small Multiples</option>
                          <option value="focus">Focus View</option>
                          <option value="heatmap">Heatmap</option>
                          <option value="uncertainty">Uncertainty</option>
                          <option value="snapshot">Snapshot</option>
                        </select>
                      </div>
                      <div class="flex items-center gap-2">
                        <button
                          id="exportChart"
                          class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                          title="Export as PNG"
                        >
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                          </svg>
                        </button>
                        <label
                          class="flex items-center gap-2 text-sm cursor-pointer"
                        >
                          <input
                            type="checkbox"
                            id="normalizeDisplay"
                            class="rounded text-brand-500 focus:ring-brand-500"
                          >
                          <span>Normalize</span>
                        </label>
                      </div>
                    </div>
                    <div class="flex-1 p-4 relative min-h-[400px]">
                      <canvas id="mainChart" class="w-full h-full"></canvas>
                      <div
                        id="chartEmpty"
                        class="absolute inset-0 flex items-center justify-center bg-surface-50/80 dark:bg-surface-950/80"
                      >
                        <div class="text-center p-8">
                          <div
                            class="w-16 h-16 mx-auto mb-4 bg-surface-200 dark:bg-surface-700 rounded-full flex items-center justify-center"
                          >
                            <svg
                              class="w-8 h-8 text-surface-400"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                              />
                            </svg>
                          </div>
                          <p
                            class="text-surface-600 dark:text-surface-400 font-medium mb-2"
                          >
                            No predictions yet
                          </p>
                          <p
                            class="text-sm text-surface-500 dark:text-surface-500 mb-4"
                          >
                            Train your model and run a forecast to see results
                          </p>
                          <button
                            data-action="openPredict"
                            class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white rounded-lg font-medium transition-colors"
                          >
                            Run Forecast
                          </button>
                        </div>
                      </div>
                      <div
                        id="tooltip"
                        class="hidden absolute z-10 bg-white dark:bg-surface-800 border border-surface-200 dark:border-surface-700 rounded-lg shadow-xl p-3 pointer-events-none text-sm"
                      >
                      </div>
                    </div>
                    <div
                      id="dimSelector"
                      class="border-t border-surface-200 dark:border-surface-800 p-3 hidden"
                    >
                      <div class="flex items-center gap-2 mb-2">
                        <span class="text-sm font-medium"
                        >Target Dimension:</span>
                        <input
                          type="text"
                          id="dimSearch"
                          placeholder="Search..."
                          class="flex-1 max-w-xs text-sm bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-brand-500"
                        >
                        <button
                          id="selectAllDims"
                          class="text-xs px-2 py-1 bg-surface-100 dark:bg-surface-800 rounded hover:bg-surface-200 dark:hover:bg-surface-700"
                        >
                          All
                        </button>
                        <button
                          id="clearDims"
                          class="text-xs px-2 py-1 bg-surface-100 dark:bg-surface-800 rounded hover:bg-surface-200 dark:hover:bg-surface-700"
                        >
                          Clear
                        </button>
                      </div>
                      <div
                        id="dimList"
                        class="flex flex-wrap gap-2 max-h-24 overflow-y-auto"
                      >
                      </div>
                    </div>
                  </div>
                </div>
                <div class="w-full lg:w-80 flex-shrink-0">
                  <div
                    class="bg-white dark:bg-surface-900 rounded-2xl shadow-xl border border-surface-200 dark:border-surface-800 p-4 space-y-4"
                  >
                    <div>
                      <h4 class="font-bold mb-3 flex items-center gap-2">
                        <svg
                          class="w-4 h-4 text-brand-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"
                          />
                        </svg>
                        Quick Predict
                      </h4>
                      <div class="space-y-3">
                        <div>
                          <label
                            class="text-sm text-surface-600 dark:text-surface-400 mb-1 block"
                          >Future Steps</label>
                          <div class="flex items-center gap-3">
                            <input
                              type="range"
                              id="futureStepsRange"
                              min="1"
                              max="100"
                              value="10"
                              class="flex-1"
                            >
                            <input
                              type="number"
                              id="futureStepsInput"
                              min="1"
                              max="1000"
                              value="10"
                              class="w-16 text-sm bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-2 py-1.5 text-center focus:ring-2 focus:ring-brand-500"
                            >
                          </div>
                        </div>
                        <button
                          id="runPredict"
                          class="w-full py-2.5 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-lg font-medium shadow-lg shadow-brand-500/25 hover:shadow-brand-500/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                          disabled
                        >
                          <span class="flex items-center justify-center gap-2">
                            <svg
                              class="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"
                              />
                            </svg>
                            Run Forecast
                          </span>
                        </button>
                      </div>
                    </div>
                    <div
                      class="border-t border-surface-200 dark:border-surface-800 pt-4"
                    >
                      <h4 class="font-bold mb-3 flex items-center gap-2">
                        <svg
                          class="w-4 h-4 text-emerald-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                          />
                        </svg>
                        Metrics
                      </h4>
                      <div id="metricsPanel" class="space-y-2 text-sm">
                        <div
                          class="flex justify-between py-1.5 border-b border-surface-100 dark:border-surface-800"
                        >
                          <span class="text-surface-500 dark:text-surface-400"
                          >Samples Trained</span>
                          <span id="metricSamples" class="font-medium">0</span>
                        </div>
                        <div
                          class="flex justify-between py-1.5 border-b border-surface-100 dark:border-surface-800"
                        >
                          <span class="text-surface-500 dark:text-surface-400"
                          >Features</span>
                          <span id="metricFeatures" class="font-medium">-</span>
                        </div>
                        <div
                          class="flex justify-between py-1.5 border-b border-surface-100 dark:border-surface-800"
                        >
                          <span class="text-surface-500 dark:text-surface-400"
                          >Targets</span>
                          <span id="metricTargets" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between py-1.5">
                          <span class="text-surface-500 dark:text-surface-400"
                          >Avg Confidence</span>
                          <span id="metricConfidence" class="font-medium"
                          >-</span>
                        </div>
                      </div>
                    </div>
                    <div
                      class="border-t border-surface-200 dark:border-surface-800 pt-4"
                    >
                      <h4 class="font-bold mb-3 flex items-center gap-2">
                        <svg
                          class="w-4 h-4 text-amber-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                          />
                        </svg>
                        Recent Activity
                      </h4>
                      <div
                        id="recentActivity"
                        class="space-y-2 text-sm max-h-40 overflow-y-auto"
                      >
                        <p
                          class="text-surface-400 dark:text-surface-500 italic"
                        >
                          No activity yet
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            id="progressBar"
            class="fixed bottom-0 left-0 right-0 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-800 p-4 transform translate-y-full transition-transform z-20"
          >
            <div class="max-w-2xl mx-auto flex items-center gap-4">
              <div class="flex-1">
                <div class="flex items-center justify-between mb-2">
                  <span id="progressLabel" class="text-sm font-medium"
                  >Processing...</span>
                  <span id="progressPercent" class="text-sm text-surface-500"
                  >0%</span>
                </div>
                <div
                  class="h-2 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden"
                >
                  <div
                    id="progressFill"
                    class="h-full bg-gradient-to-r from-brand-500 to-brand-400 rounded-full transition-all duration-300"
                    style="width: 0%"
                  >
                  </div>
                </div>
                <p id="progressDetail" class="text-xs text-surface-500 mt-1">
                  0 / 0
                </p>
              </div>
              <button
                id="cancelProgress"
                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>
    <div id="modals"></div>
    <div id="toasts" class="fixed top-20 right-4 z-50 space-y-2"></div>
    <script>
      const APP_VERSION = "1.0.0";
      const MODULE_URL_DEFAULT =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression";
      let state = {
        hasModel: false,
        nFeatures: 0,
        nTargets: 0,
        samplesTrained: 0,
        predictions: null,
        config: null,
        moduleUrl: MODULE_URL_DEFAULT,
        selectedDims: [],
        viewMode: "grid",
        theme: "light",
        performanceMode: false,
        logs: [],
      };
      let worker = null;
      let pendingRequests = new Map();
      let requestIdCounter = 0;
      let currentCancelId = null;

      const presets = {
        "start": {
          name: "Start Here",
          desc: "Recommended for most use cases",
          config: {
            reservoirSize: 100,
            spectralRadius: 0.9,
            inputScaling: 0.5,
            leakingRate: 0.3,
            regularization: 1e-6,
            sparsity: 0.1,
          },
        },
        "fast": {
          name: "Fast/Light",
          desc: "Smaller reservoir, quicker training",
          config: {
            reservoirSize: 50,
            spectralRadius: 0.8,
            inputScaling: 0.4,
            leakingRate: 0.5,
            regularization: 1e-5,
            sparsity: 0.2,
          },
        },
        "balanced": {
          name: "Balanced",
          desc: "Good accuracy/speed tradeoff",
          config: {
            reservoirSize: 150,
            spectralRadius: 0.95,
            inputScaling: 0.5,
            leakingRate: 0.3,
            regularization: 1e-6,
            sparsity: 0.1,
          },
        },
        "accurate": {
          name: "Accurate/Stable",
          desc: "Larger reservoir, better for complex patterns",
          config: {
            reservoirSize: 300,
            spectralRadius: 0.99,
            inputScaling: 0.3,
            leakingRate: 0.2,
            regularization: 1e-7,
            sparsity: 0.05,
          },
        },
        "adaptive": {
          name: "Adaptive/Drift",
          desc: "Good for non-stationary data",
          config: {
            reservoirSize: 100,
            spectralRadius: 0.85,
            inputScaling: 0.6,
            leakingRate: 0.5,
            regularization: 1e-5,
            sparsity: 0.15,
          },
        },
        "noisy": {
          name: "Noisy/Robust",
          desc: "Higher regularization for noisy data",
          config: {
            reservoirSize: 150,
            spectralRadius: 0.9,
            inputScaling: 0.3,
            leakingRate: 0.4,
            regularization: 1e-4,
            sparsity: 0.1,
          },
        },
      };

      function initWorker() {
        const workerCode = `
const MODULE_URL = '${state.moduleUrl}';
let ESNRegression = null;
let model = null;
let dataset = { x: [], y: [] };
let nFeatures = 0;
let nTargets = 0;
let config = null;
let cancelTokens = new Set();

async function loadModule() {
  try {
    const mod = await import(MODULE_URL);
    ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module exports');
    return { success: true };
  } catch (e) {
    try {
      const res = await fetch(MODULE_URL);
      let text = await res.text();
      const match = text.match(/export\\s*{([^}]+)}/);
      if (match) {
        const fn = new Function('exports', text.replace(/export\\s*{[^}]+}/, '') + ';return exports;');
        const exports = fn({});
        ESNRegression = exports.ESNRegression || exports.default;
      }
      if (!ESNRegression) throw new Error('Could not extract ESNRegression from fetched module');
      return { success: true };
    } catch (e2) {
      return { success: false, error: 'Failed to load module: ' + e2.message };
    }
  }
}

function createModel(cfg) {
  try {
    config = cfg;
    model = new ESNRegression(cfg);
    return { success: true };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function trainOnline(x, y) {
  if (!model) return { success: false, error: 'No model created' };
  try {
    model.fitOnline([x], [y]);
    nFeatures = x.length;
    nTargets = y.length;
    dataset.x.push(x);
    dataset.y.push(y);
    return { success: true, nFeatures, nTargets, samplesTrained: dataset.x.length };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

async function trainBatch(samples, requestId) {
  if (!model) return { success: false, error: 'No model created' };
  cancelTokens.add(requestId);
  try {
    const total = samples.length;
    for (let i = 0; i < total; i++) {
      if (!cancelTokens.has(requestId)) {
        return { success: false, error: 'Cancelled', cancelled: true };
      }
      const s = samples[i];
      model.fitOnline([s.x], [s.y]);
      if (i === 0) { nFeatures = s.x.length; nTargets = s.y.length; }
      dataset.x.push(s.x);
      dataset.y.push(s.y);
      if (i % 10 === 0 || i === total - 1) {
        self.postMessage({ type: 'progress', requestId, processed: i + 1, total, percent: Math.round(((i + 1) / total) * 100) });
      }
    }
    cancelTokens.delete(requestId);
    return { success: true, nFeatures, nTargets, samplesTrained: dataset.x.length };
  } catch (e) {
    cancelTokens.delete(requestId);
    return { success: false, error: e.message };
  }
}

function predict(futureSteps) {
  if (!model) return { success: false, error: 'No model created' };
  if (dataset.x.length === 0) return { success: false, error: 'No training data' };
  try {
    const result = model.predict(futureSteps);
    return { success: true, predictions: result.predictions, lowerBounds: result.lowerBounds, upperBounds: result.upperBounds, confidence: result.confidence };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function saveModel() {
  if (!model) return { success: false, error: 'No model to save' };
  try {
    const modelState = model.save();
    return { success: true, data: { modelState, meta: { config, nFeatures, nTargets, createdAt: new Date().toISOString(), appVersion: '1.0.0', samplesTrained: dataset.x.length } } };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function loadModel(data) {
  try {
    let modelState, meta;
    if (typeof data === 'string') {
      modelState = data;
      meta = {};
    } else if (data.modelState) {
      modelState = data.modelState;
      meta = data.meta || {};
    } else {
      return { success: false, error: 'Invalid model format' };
    }
    config = meta.config || presets['start'].config;
    model = new ESNRegression(config);
    model.load(modelState);
    nFeatures = meta.nFeatures || 0;
    nTargets = meta.nTargets || 0;
    return { success: true, config, nFeatures, nTargets };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function getSummary() {
  return { hasModel: !!model, config, nFeatures, nTargets, samplesTrained: dataset.x.length };
}

function getDataset() {
  return { x: dataset.x, y: dataset.y };
}

function resetModel() {
  model = null;
  dataset = { x: [], y: [] };
  nFeatures = 0;
  nTargets = 0;
  config = null;
  return { success: true };
}

function cancel(requestId) {
  cancelTokens.delete(requestId);
  return { success: true };
}

self.onmessage = async function(e) {
  const { type, payload, requestId } = e.data;
  let result;
  switch (type) {
    case 'init': result = await loadModule(); break;
    case 'createModel': result = createModel(payload); break;
    case 'trainOnline': result = trainOnline(payload.x, payload.y); break;
    case 'trainBatch': result = await trainBatch(payload.samples, requestId); break;
    case 'predict': result = predict(payload.futureSteps); break;
    case 'save': result = saveModel(); break;
    case 'load': result = loadModel(payload); break;
    case 'summary': result = getSummary(); break;
    case 'getDataset': result = getDataset(); break;
    case 'reset': result = resetModel(); break;
    case 'cancel': result = cancel(payload.requestId); break;
    default: result = { success: false, error: 'Unknown action' };
  }
  self.postMessage({ type: 'response', requestId, result });
};
`;
        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        const url = URL.createObjectURL(blob);
        worker = new Worker(url, { type: "module" });
        worker.onmessage = handleWorkerMessage;
        worker.onerror = (e) => {
          showToast("Worker error: " + e.message, "error");
          log("Worker Error", e.message, "error");
        };
        return sendToWorker("init");
      }

      function handleWorkerMessage(e) {
        const { type, requestId, result } = e.data;
        if (type === "progress") {
          updateProgress(e.data);
          return;
        }
        if (type === "response" && pendingRequests.has(requestId)) {
          const { resolve, reject } = pendingRequests.get(requestId);
          pendingRequests.delete(requestId);
          if (result.success === false && !result.cancelled) {
            reject(new Error(result.error));
          } else {
            resolve(result);
          }
        }
      }

      function sendToWorker(type, payload = {}) {
        return new Promise((resolve, reject) => {
          const requestId = ++requestIdCounter;
          pendingRequests.set(requestId, { resolve, reject });
          worker.postMessage({ type, payload, requestId });
        });
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toasts");
        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };
        const icons = {
          info:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
          success:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
          warning:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
          error:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
        };
        const toast = document.createElement("div");
        toast.className =
          `flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg ${
            colors[type]
          } text-white animate-slide-up max-w-sm`;
        toast.innerHTML =
          `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${
            icons[type]
          }</svg><p class="text-sm font-medium">${message}</p>`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          toast.style.transition = "all 0.3s";
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      function log(action, detail, type = "info") {
        const entry = {
          timestamp: new Date().toISOString(),
          action,
          detail,
          type,
        };
        state.logs.unshift(entry);
        if (state.logs.length > 200) state.logs.pop();
        updateRecentActivity();
      }

      function updateRecentActivity() {
        const container = document.getElementById("recentActivity");
        const recent = state.logs.slice(0, 5);
        if (recent.length === 0) {
          container.innerHTML =
            '<p class="text-surface-400 dark:text-surface-500 italic">No activity yet</p>';
          return;
        }
        container.innerHTML = recent.map((e) => {
          const colors = {
            info: "text-blue-500",
            success: "text-emerald-500",
            warning: "text-amber-500",
            error: "text-red-500",
          };
          const time = new Date(e.timestamp).toLocaleTimeString();
          return `<div class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full ${
            colors[e.type]
          } mt-1.5 flex-shrink-0"></span><div class="flex-1 min-w-0"><p class="font-medium truncate">${e.action}</p><p class="text-xs text-surface-400">${time}</p></div></div>`;
        }).join("");
      }

      function updateUI() {
        const modelChip = document.getElementById("modelChip");
        const dataChip = document.getElementById("dataChip");
        const dimChip = document.getElementById("dimChip");
        const quickPredict = document.getElementById("quickPredict");
        const runPredict = document.getElementById("runPredict");
        const onboarding = document.getElementById("onboarding");
        const dashboard = document.getElementById("dashboard");

        if (state.hasModel) {
          modelChip.className =
            "px-2.5 py-1 text-xs font-medium rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300";
          modelChip.textContent = "Model Ready";
          onboarding.classList.add("hidden");
          dashboard.classList.remove("hidden");
        } else {
          modelChip.className =
            "px-2.5 py-1 text-xs font-medium rounded-full bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-400";
          modelChip.textContent = "No Model";
          onboarding.classList.remove("hidden");
          dashboard.classList.add("hidden");
        }

        dataChip.textContent = `${state.samplesTrained} samples`;

        if (state.nFeatures > 0 && state.nTargets > 0) {
          dimChip.classList.remove("hidden");
          dimChip.textContent =
            `${state.nFeatures}${state.nTargets} dims`;
        } else {
          dimChip.classList.add("hidden");
        }

        const canPredict = state.hasModel && state.samplesTrained > 0;
        quickPredict.disabled = !canPredict;
        runPredict.disabled = !canPredict;

        document.getElementById("metricSamples").textContent =
          state.samplesTrained;
        document.getElementById("metricFeatures").textContent =
          state.nFeatures || "-";
        document.getElementById("metricTargets").textContent =
          state.nTargets || "-";

        if (
          state.predictions &&
          state.predictions.confidence !== undefined
        ) {
          document.getElementById("metricConfidence").textContent =
            (state.predictions.confidence * 100).toFixed(1) + "%";
        }

        updateDimSelector();
        renderChart();
      }

      function updateDimSelector() {
        const container = document.getElementById("dimList");
        const selector = document.getElementById("dimSelector");

        if (state.nTargets <= 1) {
          selector.classList.add("hidden");
          return;
        }

        if (
          ["focus", "uncertainty", "snapshot"].includes(state.viewMode)
        ) {
          selector.classList.remove("hidden");
        } else {
          selector.classList.add("hidden");
        }

        if (state.selectedDims.length === 0 && state.nTargets > 0) {
          state.selectedDims = [0];
        }

        const search = document.getElementById("dimSearch").value
          .toLowerCase();
        let html = "";
        for (let i = 0; i < state.nTargets; i++) {
          const name = `Target ${i}`;
          if (
            search && !name.toLowerCase().includes(search) &&
            !String(i).includes(search)
          ) continue;
          const selected = state.selectedDims.includes(i);
          html +=
            `<button data-dim="${i}" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
              selected
                ? "bg-brand-500 text-white"
                : "bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700"
            }">${name}</button>`;
        }
        container.innerHTML = html;
      }

      function showProgress(show = true) {
        const bar = document.getElementById("progressBar");
        bar.style.transform = show
          ? "translateY(0)"
          : "translateY(100%)";
      }

      function updateProgress(data) {
        document.getElementById("progressLabel").textContent =
          data.stage || "Processing...";
        document.getElementById("progressPercent").textContent =
          data.percent + "%";
        document.getElementById("progressFill").style.width =
          data.percent + "%";
        document.getElementById("progressDetail").textContent =
          `${data.processed} / ${data.total}`;
      }

      async function createModel(config) {
        try {
          const result = await sendToWorker("createModel", config);
          if (result.success) {
            state.hasModel = true;
            state.config = config;
            state.samplesTrained = 0;
            state.nFeatures = 0;
            state.nTargets = 0;
            state.predictions = null;
            showToast("Model created successfully", "success");
            log(
              "Model Created",
              `Reservoir: ${config.reservoirSize}, SR: ${config.spectralRadius}`,
              "success",
            );
            updateUI();
          }
        } catch (e) {
          showToast(e.message, "error");
          log("Model Creation Failed", e.message, "error");
        }
      }

      async function trainOnline(x, y) {
        try {
          const result = await sendToWorker("trainOnline", { x, y });
          if (result.success) {
            state.nFeatures = result.nFeatures;
            state.nTargets = result.nTargets;
            state.samplesTrained = result.samplesTrained;
            log(
              "Sample Trained",
              `Sample #${state.samplesTrained}`,
              "info",
            );
            updateUI();
          }
          return result;
        } catch (e) {
          showToast(e.message, "error");
          log("Training Failed", e.message, "error");
          return { success: false, error: e.message };
        }
      }

      async function trainBatch(samples) {
        currentCancelId = requestIdCounter + 1;
        showProgress(true);
        try {
          const result = await sendToWorker("trainBatch", { samples });
          showProgress(false);
          if (result.success) {
            state.nFeatures = result.nFeatures;
            state.nTargets = result.nTargets;
            state.samplesTrained = result.samplesTrained;
            showToast(`Trained ${samples.length} samples`, "success");
            log(
              "Batch Training Complete",
              `${samples.length} samples processed`,
              "success",
            );
            updateUI();
          } else if (result.cancelled) {
            showToast("Training cancelled", "warning");
            log("Training Cancelled", "", "warning");
          }
          return result;
        } catch (e) {
          showProgress(false);
          showToast(e.message, "error");
          log("Batch Training Failed", e.message, "error");
          return { success: false, error: e.message };
        }
      }

      async function predict(futureSteps) {
        try {
          const result = await sendToWorker("predict", { futureSteps });
          if (result.success) {
            state.predictions = result;
            document.getElementById("chartEmpty").classList.add(
              "hidden",
            );
            showToast(
              `Forecast generated (${futureSteps} steps)`,
              "success",
            );
            log(
              "Prediction Complete",
              `${futureSteps} future steps`,
              "success",
            );
            updateUI();
          }
          return result;
        } catch (e) {
          showToast(e.message, "error");
          log("Prediction Failed", e.message, "error");
          return { success: false, error: e.message };
        }
      }

      function validateData(data) {
        const errors = [];

        if (!data || typeof data !== "object") {
          return {
            valid: false,
            errors: ["Input must be a valid JSON object"],
          };
        }

        let samples = [];

        // Format A: { xCoordinates, yCoordinates }
        if (data.xCoordinates && data.yCoordinates) {
          if (
            !Array.isArray(data.xCoordinates) ||
            !Array.isArray(data.yCoordinates)
          ) {
            errors.push("xCoordinates and yCoordinates must be arrays");
          } else if (
            data.xCoordinates.length !== data.yCoordinates.length
          ) {
            errors.push(
              `Length mismatch: xCoordinates (${data.xCoordinates.length}) vs yCoordinates (${data.yCoordinates.length})`,
            );
          } else {
            for (let i = 0; i < data.xCoordinates.length; i++) {
              samples.push({
                x: data.xCoordinates[i],
                y: data.yCoordinates[i],
              });
            }
          }
        } // Format B: { samples: [...] }
        else if (data.samples && Array.isArray(data.samples)) {
          samples = data.samples;
        } // Format C: { x, y }
        else if (data.x !== undefined && data.y !== undefined) {
          samples = [{ x: data.x, y: data.y }];
        } else {
          errors.push(
            "Unrecognized format. Expected xCoordinates/yCoordinates, samples array, or x/y object.",
          );
        }

        if (samples.length === 0 && errors.length === 0) {
          errors.push("No samples found in data");
        }

        let nFeatures = 0, nTargets = 0;

        for (let i = 0; i < samples.length; i++) {
          const s = samples[i];
          if (!s.x || !s.y) {
            errors.push(`Sample ${i}: missing x or y`);
            continue;
          }
          if (!Array.isArray(s.x) || !Array.isArray(s.y)) {
            errors.push(`Sample ${i}: x and y must be arrays`);
            continue;
          }
          if (i === 0) {
            nFeatures = s.x.length;
            nTargets = s.y.length;
          } else {
            if (s.x.length !== nFeatures) {
              errors.push(
                `Sample ${i}: x length ${s.x.length} differs from expected ${nFeatures}`,
              );
            }
            if (s.y.length !== nTargets) {
              errors.push(
                `Sample ${i}: y length ${s.y.length} differs from expected ${nTargets}`,
              );
            }
          }
          for (let j = 0; j < s.x.length; j++) {
            if (typeof s.x[j] !== "number" || isNaN(s.x[j])) {
              errors.push(`Sample ${i}: x[${j}] is not a valid number`);
            }
          }
          for (let j = 0; j < s.y.length; j++) {
            if (typeof s.y[j] !== "number" || isNaN(s.y[j])) {
              errors.push(`Sample ${i}: y[${j}] is not a valid number`);
            }
          }
        }

        return {
          valid: errors.length === 0,
          errors: errors.slice(0, 10),
          samples,
          nFeatures,
          nTargets,
        };
      }

      function seededRandom(seed) {
        let s = seed;
        return function () {
          s = Math.sin(s * 9999) * 10000;
          return s - Math.floor(s);
        };
      }

      function generateTestData(opts) {
        const {
          seed,
          nFeatures,
          nTargets,
          nSamples,
          noise,
          difficulty,
          outlierRate,
        } = opts;
        const rand = seededRandom(seed);
        const samples = [];

        const weights = [];
        for (let t = 0; t < nTargets; t++) {
          const w = [];
          for (let f = 0; f < nFeatures; f++) {
            w.push((rand() - 0.5) * 2 * difficulty);
          }
          weights.push(w);
        }

        for (let i = 0; i < nSamples; i++) {
          const x = [];
          for (let f = 0; f < nFeatures; f++) {
            x.push(Math.sin(i * 0.1 + f) + (rand() - 0.5) * noise);
          }

          const y = [];
          for (let t = 0; t < nTargets; t++) {
            let val = 0;
            for (let f = 0; f < nFeatures; f++) {
              val += weights[t][f] * x[f];
              if (difficulty > 1) {
                val += Math.sin(x[f] * weights[t][f]) * 0.5;
              }
            }
            val += (rand() - 0.5) * noise;
            if (rand() < outlierRate) val *= 3;
            y.push(val);
          }

          samples.push({ x, y });
        }

        return {
          samples,
          desc: `${nFeatures}D${nTargets}D, ${
            difficulty > 1.5 ? "nonlinear" : "linear"
          } with ${(noise * 100).toFixed(0)}% noise`,
        };
      }

      const chartColors = [
        "#0ea5e9",
        "#10b981",
        "#f59e0b",
        "#ef4444",
        "#8b5cf6",
        "#ec4899",
        "#14b8a6",
        "#f97316",
        "#6366f1",
        "#84cc16",
      ];

      function renderChart() {
        const canvas = document.getElementById("mainChart");
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        const width = rect.width;
        const height = rect.height;
        const isDark = document.documentElement.classList.contains(
          "dark",
        );

        ctx.fillStyle = isDark ? "#18181b" : "#ffffff";
        ctx.fillRect(0, 0, width, height);

        if (!state.predictions || !state.predictions.predictions) {
          document.getElementById("chartEmpty").classList.remove(
            "hidden",
          );
          return;
        }

        document.getElementById("chartEmpty").classList.add("hidden");

        const preds = state.predictions.predictions;
        const lower = state.predictions.lowerBounds;
        const upper = state.predictions.upperBounds;
        const nSteps = preds.length;
        const nTargets = preds[0]?.length || 0;

        const normalize =
          document.getElementById("normalizeDisplay").checked;

        switch (state.viewMode) {
          case "grid":
            renderGridView(
              ctx,
              width,
              height,
              preds,
              lower,
              upper,
              nSteps,
              nTargets,
              normalize,
              isDark,
            );
            break;
          case "focus":
            renderFocusView(
              ctx,
              width,
              height,
              preds,
              lower,
              upper,
              nSteps,
              normalize,
              isDark,
            );
            break;
          case "heatmap":
            renderHeatmapView(
              ctx,
              width,
              height,
              preds,
              nSteps,
              nTargets,
              isDark,
            );
            break;
          case "uncertainty":
            renderUncertaintyView(
              ctx,
              width,
              height,
              lower,
              upper,
              nSteps,
              isDark,
            );
            break;
          case "snapshot":
            renderSnapshotView(
              ctx,
              width,
              height,
              preds,
              lower,
              upper,
              nSteps,
              nTargets,
              isDark,
            );
            break;
          default:
            renderGridView(
              ctx,
              width,
              height,
              preds,
              lower,
              upper,
              nSteps,
              nTargets,
              normalize,
              isDark,
            );
        }
      }

      function normalizeData(data, min, max) {
        if (max === min) return data.map(() => 0.5);
        return data.map((v) => (v - min) / (max - min));
      }

      function niceAxis(min, max, steps = 5) {
        const range = max - min || 1;
        const roughStep = range / steps;
        const magnitude = Math.pow(
          10,
          Math.floor(Math.log10(roughStep)),
        );
        const residual = roughStep / magnitude;
        let niceStep;
        if (residual > 5) niceStep = 10 * magnitude;
        else if (residual > 2) niceStep = 5 * magnitude;
        else if (residual > 1) niceStep = 2 * magnitude;
        else niceStep = magnitude;

        const niceMin = Math.floor(min / niceStep) * niceStep;
        const niceMax = Math.ceil(max / niceStep) * niceStep;
        const ticks = [];
        for (let v = niceMin; v <= niceMax; v += niceStep) {
          ticks.push(+v.toFixed(10));
        }
        return { min: niceMin, max: niceMax, ticks };
      }

      function renderGridView(
        ctx,
        width,
        height,
        preds,
        lower,
        upper,
        nSteps,
        nTargets,
        normalize,
        isDark,
      ) {
        const cols = Math.ceil(Math.sqrt(nTargets));
        const rows = Math.ceil(nTargets / cols);
        const padding = 8;
        const cellW = (width - padding * (cols + 1)) / cols;
        const cellH = (height - padding * (rows + 1)) / rows;

        for (let t = 0; t < nTargets; t++) {
          const col = t % cols;
          const row = Math.floor(t / cols);
          const x = padding + col * (cellW + padding);
          const y = padding + row * (cellH + padding);

          const data = preds.map((p) => p[t]);
          const lb = lower.map((p) => p[t]);
          const ub = upper.map((p) => p[t]);

          let min = Math.min(...data, ...lb);
          let max = Math.max(...data, ...ub);
          if (normalize) {
            min = 0;
            max = 1;
          }
          const yPad = (max - min) * 0.1 || 0.1;
          min -= yPad;
          max += yPad;

          // Background
          ctx.fillStyle = isDark ? "#27272a" : "#f4f4f5";
          ctx.beginPath();
          ctx.roundRect(x, y, cellW, cellH, 8);
          ctx.fill();

          const chartX = x + 40;
          const chartY = y + 20;
          const chartW = cellW - 50;
          const chartH = cellH - 35;

          // Confidence band
          ctx.fillStyle = isDark
            ? "rgba(14, 165, 233, 0.15)"
            : "rgba(14, 165, 233, 0.1)";
          ctx.beginPath();
          for (let i = 0; i < nSteps; i++) {
            const px = chartX + (i / (nSteps - 1)) * chartW;
            const py = chartY + chartH -
              ((ub[i] - min) / (max - min)) * chartH;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          for (let i = nSteps - 1; i >= 0; i--) {
            const px = chartX + (i / (nSteps - 1)) * chartW;
            const py = chartY + chartH -
              ((lb[i] - min) / (max - min)) * chartH;
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Line
          ctx.strokeStyle = chartColors[t % chartColors.length];
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < nSteps; i++) {
            const px = chartX + (i / (nSteps - 1)) * chartW;
            const py = chartY + chartH -
              ((data[i] - min) / (max - min)) * chartH;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();

          // Title
          ctx.fillStyle = isDark ? "#e4e4e7" : "#3f3f46";
          ctx.font = "11px system-ui";
          ctx.fillText(`Target ${t}`, x + 8, y + 14);
        }
      }

      function renderFocusView(
        ctx,
        width,
        height,
        preds,
        lower,
        upper,
        nSteps,
        normalize,
        isDark,
      ) {
        const dim = state.selectedDims[0] || 0;
        const data = preds.map((p) => p[dim] || 0);
        const lb = lower.map((p) => p[dim] || 0);
        const ub = upper.map((p) => p[dim] || 0);

        let min = Math.min(...data, ...lb);
        let max = Math.max(...data, ...ub);
        if (normalize) {
          min = 0;
          max = 1;
        }
        const yPad = (max - min) * 0.1 || 0.1;

        const axis = niceAxis(min - yPad, max + yPad);

        const chartX = 60;
        const chartY = 30;
        const chartW = width - 80;
        const chartH = height - 60;

        // Gridlines
        ctx.strokeStyle = isDark ? "#3f3f46" : "#e4e4e7";
        ctx.lineWidth = 1;
        axis.ticks.forEach((v) => {
          const y = chartY + chartH -
            ((v - axis.min) / (axis.max - axis.min)) * chartH;
          ctx.beginPath();
          ctx.moveTo(chartX, y);
          ctx.lineTo(chartX + chartW, y);
          ctx.stroke();

          ctx.fillStyle = isDark ? "#a1a1aa" : "#71717a";
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(v.toFixed(2), chartX - 8, y + 4);
        });

        // X axis labels
        ctx.textAlign = "center";
        const xTicks = Math.min(10, nSteps);
        for (let i = 0; i <= xTicks; i++) {
          const step = Math.round((i / xTicks) * (nSteps - 1));
          const x = chartX + (step / (nSteps - 1)) * chartW;
          ctx.fillText(step.toString(), x, chartY + chartH + 20);
        }

        // Confidence band
        ctx.fillStyle = isDark
          ? "rgba(14, 165, 233, 0.2)"
          : "rgba(14, 165, 233, 0.15)";
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const px = chartX + (i / (nSteps - 1)) * chartW;
          const py = chartY + chartH -
            ((ub[i] - axis.min) / (axis.max - axis.min)) * chartH;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        for (let i = nSteps - 1; i >= 0; i--) {
          const px = chartX + (i / (nSteps - 1)) * chartW;
          const py = chartY + chartH -
            ((lb[i] - axis.min) / (axis.max - axis.min)) * chartH;
          ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Main line with glow
        ctx.shadowColor = "#0ea5e9";
        ctx.shadowBlur = 8;
        ctx.strokeStyle = "#0ea5e9";
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const px = chartX + (i / (nSteps - 1)) * chartW;
          const py = chartY + chartH -
            ((data[i] - axis.min) / (axis.max - axis.min)) * chartH;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
        ctx.shadowBlur = 0;

        // Title
        ctx.fillStyle = isDark ? "#fafafa" : "#18181b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Target ${dim} - Forecast`, chartX, 20);
      }

      function renderHeatmapView(
        ctx,
        width,
        height,
        preds,
        nSteps,
        nTargets,
        isDark,
      ) {
        const cellW = (width - 60) / nSteps;
        const cellH = (height - 40) / nTargets;
        const offsetX = 50;
        const offsetY = 20;

        let min = Infinity, max = -Infinity;
        for (const p of preds) {
          for (const v of p) {
            if (v < min) min = v;
            if (v > max) max = v;
          }
        }

        for (let t = 0; t < nTargets; t++) {
          for (let s = 0; s < nSteps; s++) {
            const val = preds[s][t];
            const norm = (val - min) / (max - min || 1);
            const hue = (1 - norm) * 240;
            ctx.fillStyle = `hsl(${hue}, 70%, ${isDark ? 40 : 50}%)`;
            ctx.fillRect(
              offsetX + s * cellW,
              offsetY + t * cellH,
              cellW - 1,
              cellH - 1,
            );
          }

          ctx.fillStyle = isDark ? "#a1a1aa" : "#71717a";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(
            `T${t}`,
            offsetX - 5,
            offsetY + t * cellH + cellH / 2 + 3,
          );
        }

        // X labels
        ctx.textAlign = "center";
        for (let s = 0; s < nSteps; s += Math.ceil(nSteps / 10)) {
          ctx.fillText(
            s.toString(),
            offsetX + s * cellW + cellW / 2,
            height - 5,
          );
        }

        // Legend
        const legW = 100, legH = 10;
        const legX = width - legW - 10, legY = 5;
        const grad = ctx.createLinearGradient(legX, 0, legX + legW, 0);
        grad.addColorStop(0, "hsl(240, 70%, 50%)");
        grad.addColorStop(1, "hsl(0, 70%, 50%)");
        ctx.fillStyle = grad;
        ctx.fillRect(legX, legY, legW, legH);
        ctx.fillStyle = isDark ? "#a1a1aa" : "#71717a";
        ctx.font = "9px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(min.toFixed(1), legX, legY + legH + 10);
        ctx.textAlign = "right";
        ctx.fillText(max.toFixed(1), legX + legW, legY + legH + 10);
      }

      function renderUncertaintyView(
        ctx,
        width,
        height,
        lower,
        upper,
        nSteps,
        isDark,
      ) {
        const dim = state.selectedDims[0] || 0;
        const bandWidth = upper.map((u, i) => u[dim] - lower[i][dim]);

        let max = Math.max(...bandWidth);
        const axis = niceAxis(0, max * 1.1);

        const chartX = 60;
        const chartY = 30;
        const chartW = width - 80;
        const chartH = height - 60;

        // Bars
        const barW = chartW / nSteps - 2;
        for (let i = 0; i < nSteps; i++) {
          const h = (bandWidth[i] / axis.max) * chartH;
          const x = chartX + (i / nSteps) * chartW + 1;
          const y = chartY + chartH - h;

          const grad = ctx.createLinearGradient(x, y, x, y + h);
          grad.addColorStop(0, isDark ? "#f59e0b" : "#fbbf24");
          grad.addColorStop(1, isDark ? "#d97706" : "#f59e0b");
          ctx.fillStyle = grad;
          ctx.beginPath();
          ctx.roundRect(x, y, barW, h, 2);
          ctx.fill();
        }

        // Axis
        ctx.strokeStyle = isDark ? "#3f3f46" : "#e4e4e7";
        axis.ticks.forEach((v) => {
          const y = chartY + chartH - (v / axis.max) * chartH;
          ctx.beginPath();
          ctx.moveTo(chartX, y);
          ctx.lineTo(chartX + chartW, y);
          ctx.stroke();

          ctx.fillStyle = isDark ? "#a1a1aa" : "#71717a";
          ctx.font = "11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(v.toFixed(2), chartX - 8, y + 4);
        });

        ctx.fillStyle = isDark ? "#fafafa" : "#18181b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Target ${dim} - Uncertainty Width`, chartX, 20);
      }

      function renderSnapshotView(
        ctx,
        width,
        height,
        preds,
        lower,
        upper,
        nSteps,
        nTargets,
        isDark,
      ) {
        const step = Math.min(Math.floor(nSteps / 2), nSteps - 1);
        const data = preds[step];
        const lb = lower[step];
        const ub = upper[step];

        let max = Math.max(...data.map(Math.abs), ...ub.map(Math.abs));
        const axis = niceAxis(-max * 0.1, max * 1.1);

        const chartX = 60;
        const chartY = 30;
        const chartW = width - 80;
        const chartH = height - 60;

        const barW = chartW / nTargets - 4;

        for (let t = 0; t < nTargets; t++) {
          const x = chartX + (t / nTargets) * chartW + 2;
          const val = data[t];
          const h = Math.abs((val / axis.max) * chartH);
          const y = val >= 0 ? chartY + chartH - h : chartY + chartH;

          ctx.fillStyle = chartColors[t % chartColors.length];
          ctx.beginPath();
          ctx.roundRect(x, y, barW, h, 3);
          ctx.fill();

          // Error bar
          ctx.strokeStyle = isDark ? "#fafafa" : "#18181b";
          ctx.lineWidth = 2;
          const cx = x + barW / 2;
          const yLow = chartY + chartH - ((lb[t] / axis.max) * chartH);
          const yHigh = chartY + chartH - ((ub[t] / axis.max) * chartH);
          ctx.beginPath();
          ctx.moveTo(cx, yLow);
          ctx.lineTo(cx, yHigh);
          ctx.moveTo(cx - 4, yLow);
          ctx.lineTo(cx + 4, yLow);
          ctx.moveTo(cx - 4, yHigh);
          ctx.lineTo(cx + 4, yHigh);
          ctx.stroke();

          ctx.fillStyle = isDark ? "#a1a1aa" : "#71717a";
          ctx.font = "9px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(`T${t}`, cx, chartY + chartH + 15);
        }

        ctx.fillStyle = isDark ? "#fafafa" : "#18181b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Step ${step} Snapshot (All Targets)`, chartX, 20);
      }

      function openModal(id) {
        const container = document.getElementById("modals");
        const existing = document.getElementById(id);
        if (existing) {
          existing.classList.remove("hidden");
          existing.querySelector("[data-focus]")?.focus();
          return;
        }

        let content = "";

        switch (id) {
          case "configModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Model Configuration</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Preset</label>
              <select id="configPreset" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-brand-500">
                ${
              Object.entries(presets).map(([k, v]) =>
                `<option value="${k}">${v.name} - ${v.desc}</option>`
              ).join("")
            }
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Reservoir Size</label>
                <input type="number" id="cfgReservoir" value="100" min="10" max="1000" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">Larger = more capacity. 50-300 typical.</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Spectral Radius</label>
                <input type="number" id="cfgSpectral" value="0.9" min="0.1" max="1.5" step="0.05" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">Memory length. 0.8-0.99 stable.</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Input Scaling</label>
                <input type="number" id="cfgInputScale" value="0.5" min="0.01" max="2" step="0.1" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">Scale inputs. 0.3-1.0 typical.</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Leaking Rate</label>
                <input type="number" id="cfgLeak" value="0.3" min="0.01" max="1" step="0.05" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">State update speed. Lower = smoother.</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Regularization</label>
                <input type="number" id="cfgReg" value="0.000001" min="0" max="0.01" step="0.000001" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">Prevents overfitting. 1e-6 to 1e-4.</p>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Sparsity</label>
                <input type="number" id="cfgSparsity" value="0.1" min="0" max="0.9" step="0.05" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
                <p class="text-xs text-surface-500 mt-1">Connection density. 0.05-0.2 typical.</p>
              </div>
            </div>
          </div>
          <div class="p-4 border-t border-surface-200 dark:border-surface-800 flex gap-3">
            <button data-close class="flex-1 py-2.5 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-lg font-medium transition-colors">Cancel</button>
            <button id="createModelBtn" class="flex-1 py-2.5 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-lg font-medium shadow-lg transition-all">Create Model</button>
          </div>
        </div>`;
            break;

          case "uploadModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Upload Dataset</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="border-2 border-dashed border-surface-300 dark:border-surface-700 rounded-xl p-6 text-center hover:border-brand-500 transition-colors">
              <input type="file" id="uploadFile" accept=".json" class="hidden">
              <label for="uploadFile" class="cursor-pointer">
                <svg class="w-12 h-12 mx-auto mb-3 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <p class="font-medium">Click to upload JSON file</p>
                <p class="text-sm text-surface-500">or drag and drop</p>
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Or paste JSON</label>
              <textarea id="uploadText" rows="6" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-brand-500" placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'></textarea>
            </div>
            <div class="bg-surface-100 dark:bg-surface-800 rounded-lg p-3 text-sm">
              <p class="font-medium mb-2">Accepted formats:</p>
              <p class="text-surface-600 dark:text-surface-400 mb-1"><code class="bg-surface-200 dark:bg-surface-700 px-1 rounded">{"xCoordinates": [[]], "yCoordinates": [[]]}</code></p>
              <p class="text-surface-600 dark:text-surface-400"><code class="bg-surface-200 dark:bg-surface-700 px-1 rounded">{"samples": [{"x": [], "y": []}]}</code></p>
            </div>
            <div id="uploadPreview" class="hidden bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-lg p-3">
              <p class="font-medium text-emerald-700 dark:text-emerald-300 mb-2">Preview</p>
              <div id="uploadPreviewContent" class="text-sm"></div>
            </div>
            <div id="uploadError" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 text-red-700 dark:text-red-300 text-sm"></div>
          </div>
          <div class="p-4 border-t border-surface-200 dark:border-surface-800 flex gap-3">
            <button data-close class="flex-1 py-2.5 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-lg font-medium transition-colors">Cancel</button>
            <button id="applyUpload" disabled class="flex-1 py-2.5 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-lg font-medium shadow-lg transition-all disabled:opacity-50">Apply & Train</button>
          </div>
        </div>`;
            break;

          case "insertModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Manual Insert</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Sample JSON</label>
              <textarea id="insertText" rows="6" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-brand-500" placeholder='{"x": [1, 2, 3], "y": [0.5, 0.7]}'></textarea>
            </div>
            ${
              state.nFeatures > 0
                ? `<button id="genTemplate" class="text-sm text-brand-500 hover:text-brand-600">Generate template (${state.nFeatures}${state.nTargets})</button>`
                : ""
            }
            <div id="insertError" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 text-red-700 dark:text-red-300 text-sm"></div>
          </div>
          <div class="p-4 border-t border-surface-200 dark:border-surface-800 flex gap-3">
            <button data-close class="flex-1 py-2.5 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-lg font-medium transition-colors">Cancel</button>
            <button id="applyInsert" class="flex-1 py-2.5 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-lg font-medium shadow-lg transition-all">Insert Sample</button>
          </div>
        </div>`;
            break;

          case "saveLoadModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Save / Load Model</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <button id="saveToFile" class="p-4 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-xl text-center transition-colors" ${
              !state.hasModel ? "disabled" : ""
            }>
                <svg class="w-8 h-8 mx-auto mb-2 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                <p class="font-medium">Save to File</p>
              </button>
              <button id="saveToStorage" class="p-4 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-xl text-center transition-colors" ${
              !state.hasModel ? "disabled" : ""
            }>
                <svg class="w-8 h-8 mx-auto mb-2 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                <p class="font-medium">Save to Browser</p>
              </button>
            </div>
            <div class="border-t border-surface-200 dark:border-surface-800 pt-4">
              <p class="font-medium mb-3">Load Model</p>
              <div class="border-2 border-dashed border-surface-300 dark:border-surface-700 rounded-xl p-4 text-center hover:border-brand-500 transition-colors">
                <input type="file" id="loadFile" accept=".json" class="hidden">
                <label for="loadFile" class="cursor-pointer block">
                  <svg class="w-8 h-8 mx-auto mb-2 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  <p class="font-medium">Load from File</p>
                </label>
              </div>
              <button id="loadFromStorage" class="w-full mt-3 p-3 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-xl font-medium transition-colors">Load from Browser Storage</button>
              <button id="clearStorage" class="w-full mt-2 p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-sm transition-colors">Clear Saved Data</button>
            </div>
          </div>
        </div>`;
            break;

          case "testModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Standard Test</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <p class="text-surface-600 dark:text-surface-400">Generate synthetic data, train the model, and visualize predictions in one click.</p>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Seed</label>
                <input type="number" id="testSeed" value="42" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Samples</label>
                <input type="number" id="testSamples" value="200" min="20" max="5000" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Features</label>
                <input type="number" id="testFeatures" value="5" min="1" max="50" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Targets</label>
                <input type="number" id="testTargets" value="3" min="1" max="20" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Difficulty</label>
                <input type="range" id="testDifficulty" value="1.5" min="0.5" max="3" step="0.5" class="w-full">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Noise</label>
                <input type="range" id="testNoise" value="0.1" min="0" max="0.5" step="0.05" class="w-full">
              </div>
            </div>
          </div>
          <div class="p-4 border-t border-surface-200 dark:border-surface-800">
            <button id="runTest" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg font-bold shadow-lg transition-all flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              Generate + Train + Predict
            </button>
          </div>
        </div>`;
            break;

          case "logsModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Event Log</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="p-4 border-b border-surface-200 dark:border-surface-800 flex gap-2">
            <select id="logFilter" class="bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500">
              <option value="all">All</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
            <input type="text" id="logSearch" placeholder="Search..." class="flex-1 bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500">
          </div>
          <div id="logsList" class="flex-1 overflow-y-auto p-4 space-y-2 max-h-96">
            ${
              state.logs.length === 0
                ? '<p class="text-surface-400 text-center">No logs yet</p>'
                : state.logs.map((e) => {
                  const colors = {
                    info: "border-blue-500",
                    success: "border-emerald-500",
                    warning: "border-amber-500",
                    error: "border-red-500",
                  };
                  const time = new Date(e.timestamp).toLocaleString();
                  return `<div class="p-3 bg-surface-50 dark:bg-surface-800 rounded-lg border-l-4 ${
                    colors[e.type]
                  }"><div class="flex justify-between"><span class="font-medium">${e.action}</span><span class="text-xs text-surface-400">${time}</span></div>${
                    e.detail
                      ? `<p class="text-sm text-surface-600 dark:text-surface-400 mt-1">${e.detail}</p>`
                      : ""
                  }</div>`;
                }).join("")
            }
          </div>
        </div>`;
            break;

          case "advancedModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Advanced Settings</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Module URL</label>
              <input type="text" id="moduleUrl" value="${state.moduleUrl}" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-brand-500">
              <p class="text-xs text-surface-500 mt-1">Change if default CDN fails. Requires worker restart.</p>
            </div>
            <button id="reinitWorker" class="w-full py-2.5 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-lg font-medium transition-colors">Reinitialize Worker</button>
            <label class="flex items-center gap-3 p-3 bg-surface-100 dark:bg-surface-800 rounded-lg cursor-pointer">
              <input type="checkbox" id="perfMode" ${
              state.performanceMode ? "checked" : ""
            } class="rounded text-brand-500 focus:ring-brand-500">
              <div>
                <p class="font-medium">Performance Mode</p>
                <p class="text-sm text-surface-500">Reduce visual effects for better performance</p>
              </div>
            </label>
          </div>
        </div>`;
            break;

          case "summaryModal":
            const summary = state.hasModel
              ? `
        <div class="space-y-3">
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Status</span><span class="text-emerald-500 font-medium">Ready</span></div>
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Features</span><span class="font-medium">${
                state.nFeatures || "-"
              }</span></div>
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Targets</span><span class="font-medium">${
                state.nTargets || "-"
              }</span></div>
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Samples Trained</span><span class="font-medium">${state.samplesTrained}</span></div>
          ${
                state.config
                  ? `
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Reservoir Size</span><span class="font-medium">${state.config.reservoirSize}</span></div>
          <div class="flex justify-between py-2 border-b border-surface-200 dark:border-surface-800"><span class="text-surface-500">Spectral Radius</span><span class="font-medium">${state.config.spectralRadius}</span></div>
          <div class="flex justify-between py-2"><span class="text-surface-500">Leaking Rate</span><span class="font-medium">${state.config.leakingRate}</span></div>
          `
                  : ""
              }
        </div>`
              : '<p class="text-center text-surface-400 py-8">No model created yet</p>';
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-md w-full mx-4">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Model Summary</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="p-4">${summary}</div>
        </div>`;
            break;

          case "predictModal":
            content = `
        <div class="bg-white dark:bg-surface-900 rounded-2xl shadow-2xl max-w-md w-full mx-4">
          <div class="flex items-center justify-between p-4 border-b border-surface-200 dark:border-surface-800">
            <h2 class="text-xl font-bold">Forecast</h2>
            <button data-close class="p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
          </div>
          <div class="p-4 space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Future Steps</label>
              <input type="number" id="predictSteps" value="20" min="1" max="1000" class="w-full bg-surface-100 dark:bg-surface-800 border-0 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500">
              <p class="text-xs text-surface-500 mt-1">Number of time steps to forecast into the future</p>
            </div>
            <button id="runPredictModal" class="w-full py-3 bg-gradient-to-r from-brand-500 to-brand-600 hover:from-brand-600 hover:to-brand-700 text-white rounded-lg font-bold shadow-lg transition-all" ${
              !state.hasModel || state.samplesTrained === 0
                ? "disabled"
                : ""
            }>Run Forecast</button>
            ${
              state.predictions
                ? `
            <div class="border-t border-surface-200 dark:border-surface-800 pt-4">
              <button id="exportPredictions" class="w-full py-2.5 bg-surface-100 dark:bg-surface-800 hover:bg-surface-200 dark:hover:bg-surface-700 rounded-lg font-medium transition-colors">Export Predictions (JSON)</button>
            </div>
            `
                : ""
            }
          </div>
        </div>`;
            break;
        }

        const modal = document.createElement("div");
        modal.id = id;
        modal.className =
          "fixed inset-0 z-50 flex items-center justify-center modal-overlay bg-black/50 animate-fade-in";
        modal.innerHTML = content;
        container.appendChild(modal);

        modal.addEventListener("click", (e) => {
          if (e.target === modal || e.target.closest("[data-close]")) {
            closeModal(id);
          }
        });

        modal.querySelector("[data-focus]")?.focus();

        // Setup modal-specific handlers
        setupModalHandlers(id);
      }

      function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
          modal.style.opacity = "0";
          setTimeout(() => modal.remove(), 200);
        }
      }

      function closeAllModals() {
        document.querySelectorAll("#modals > div").forEach((m) =>
          m.remove()
        );
      }

      function setupModalHandlers(id) {
        switch (id) {
          case "configModal":
            const presetSelect = document.getElementById(
              "configPreset",
            );
            presetSelect?.addEventListener("change", () => {
              const p = presets[presetSelect.value];
              if (p) {
                document.getElementById("cfgReservoir").value =
                  p.config.reservoirSize;
                document.getElementById("cfgSpectral").value =
                  p.config.spectralRadius;
                document.getElementById("cfgInputScale").value =
                  p.config.inputScaling;
                document.getElementById("cfgLeak").value =
                  p.config.leakingRate;
                document.getElementById("cfgReg").value =
                  p.config.regularization;
                document.getElementById("cfgSparsity").value =
                  p.config.sparsity;
              }
            });
            presetSelect?.dispatchEvent(new Event("change"));

            document.getElementById("createModelBtn")?.addEventListener(
              "click",
              async () => {
                const config = {
                  reservoirSize: parseInt(
                    document.getElementById("cfgReservoir").value,
                  ),
                  spectralRadius: parseFloat(
                    document.getElementById("cfgSpectral").value,
                  ),
                  inputScaling: parseFloat(
                    document.getElementById("cfgInputScale").value,
                  ),
                  leakingRate: parseFloat(
                    document.getElementById("cfgLeak").value,
                  ),
                  regularization: parseFloat(
                    document.getElementById("cfgReg").value,
                  ),
                  sparsity: parseFloat(
                    document.getElementById("cfgSparsity").value,
                  ),
                };
                await createModel(config);
                closeModal("configModal");
              },
            );
            break;

          case "uploadModal":
            let uploadedData = null;

            const validateAndPreview = (text) => {
              const preview = document.getElementById("uploadPreview");
              const error = document.getElementById("uploadError");
              const applyBtn = document.getElementById("applyUpload");

              try {
                const data = JSON.parse(text);
                const result = validateData(data);

                if (result.valid) {
                  uploadedData = result.samples;
                  preview.classList.remove("hidden");
                  error.classList.add("hidden");
                  document.getElementById("uploadPreviewContent")
                    .innerHTML = `
              <p>Samples: ${result.samples.length}</p>
              <p>Features: ${result.nFeatures}</p>
              <p>Targets: ${result.nTargets}</p>
            `;
                  applyBtn.disabled = false;
                } else {
                  preview.classList.add("hidden");
                  error.classList.remove("hidden");
                  error.innerHTML =
                    '<p class="font-medium mb-1">Validation errors:</p><ul class="list-disc list-inside">' +
                    result.errors.map((e) => `<li>${e}</li>`).join("") +
                    "</ul>";
                  applyBtn.disabled = true;
                }
              } catch (e) {
                preview.classList.add("hidden");
                error.classList.remove("hidden");
                error.textContent = "Invalid JSON: " + e.message;
                applyBtn.disabled = true;
              }
            };

            document.getElementById("uploadFile")?.addEventListener(
              "change",
              (e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = (ev) => {
                    document.getElementById("uploadText").value =
                      ev.target.result;
                    validateAndPreview(ev.target.result);
                  };
                  reader.readAsText(file);
                }
              },
            );

            document.getElementById("uploadText")?.addEventListener(
              "input",
              (e) => {
                if (e.target.value.trim()) {
                  validateAndPreview(
                    e.target.value,
                  );
                }
              },
            );

            document.getElementById("applyUpload")?.addEventListener(
              "click",
              async () => {
                if (uploadedData) {
                  if (!state.hasModel) {
                    await createModel(presets["start"].config);
                  }
                  await trainBatch(uploadedData);
                  closeModal("uploadModal");
                }
              },
            );
            break;

          case "insertModal":
            document.getElementById("genTemplate")?.addEventListener(
              "click",
              () => {
                const template = {
                  x: Array(state.nFeatures).fill(0),
                  y: Array(state.nTargets).fill(0),
                };
                document.getElementById("insertText").value = JSON
                  .stringify(template, null, 2);
              },
            );

            document.getElementById("applyInsert")?.addEventListener(
              "click",
              async () => {
                const text =
                  document.getElementById("insertText").value;
                const error = document.getElementById("insertError");
                try {
                  const data = JSON.parse(text);
                  const result = validateData(data);
                  if (result.valid && result.samples.length > 0) {
                    if (!state.hasModel) {
                      await createModel(presets["start"].config);
                    }
                    for (const s of result.samples) {
                      await trainOnline(s.x, s.y);
                    }
                    showToast(
                      `Inserted ${result.samples.length} sample(s)`,
                      "success",
                    );
                    closeModal("insertModal");
                  } else {
                    error.classList.remove("hidden");
                    error.textContent = result.errors[0];
                  }
                } catch (e) {
                  error.classList.remove("hidden");
                  error.textContent = "Invalid JSON: " + e.message;
                }
              },
            );
            break;

          case "saveLoadModal":
            document.getElementById("saveToFile")?.addEventListener(
              "click",
              async () => {
                try {
                  const result = await sendToWorker("save");
                  if (result.success) {
                    const blob = new Blob([
                      JSON.stringify(result.data, null, 2),
                    ], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `esn-model-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast("Model saved to file", "success");
                    log("Model Saved", "Exported to file", "success");
                  }
                } catch (e) {
                  showToast(e.message, "error");
                }
              },
            );

            document.getElementById("saveToStorage")?.addEventListener(
              "click",
              async () => {
                try {
                  const result = await sendToWorker("save");
                  if (result.success) {
                    localStorage.setItem(
                      "esn-model",
                      JSON.stringify(result.data),
                    );
                    showToast("Model saved to browser", "success");
                    log(
                      "Model Saved",
                      "Saved to localStorage",
                      "success",
                    );
                  }
                } catch (e) {
                  showToast(e.message, "error");
                }
              },
            );

            document.getElementById("loadFile")?.addEventListener(
              "change",
              async (e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = async (ev) => {
                    try {
                      const data = JSON.parse(ev.target.result);
                      const result = await sendToWorker("load", data);
                      if (result.success) {
                        state.hasModel = true;
                        state.config = result.config;
                        state.nFeatures = result.nFeatures;
                        state.nTargets = result.nTargets;
                        showToast(
                          "Model loaded successfully",
                          "success",
                        );
                        log("Model Loaded", "From file", "success");
                        updateUI();
                        closeModal("saveLoadModal");
                      }
                    } catch (e) {
                      showToast(
                        "Failed to load: " + e.message,
                        "error",
                      );
                    }
                  };
                  reader.readAsText(file);
                }
              },
            );

            document.getElementById("loadFromStorage")
              ?.addEventListener("click", async () => {
                const saved = localStorage.getItem("esn-model");
                if (saved) {
                  try {
                    const data = JSON.parse(saved);
                    const result = await sendToWorker("load", data);
                    if (result.success) {
                      state.hasModel = true;
                      state.config = result.config;
                      state.nFeatures = result.nFeatures;
                      state.nTargets = result.nTargets;
                      showToast("Model loaded from browser", "success");
                      log(
                        "Model Loaded",
                        "From localStorage",
                        "success",
                      );
                      updateUI();
                      closeModal("saveLoadModal");
                    }
                  } catch (e) {
                    showToast("Failed to load: " + e.message, "error");
                  }
                } else {
                  showToast("No saved model found", "warning");
                }
              });

            document.getElementById("clearStorage")?.addEventListener(
              "click",
              () => {
                localStorage.removeItem("esn-model");
                showToast("Browser storage cleared", "success");
              },
            );
            break;

          case "testModal":
            document.getElementById("runTest")?.addEventListener(
              "click",
              async () => {
                const opts = {
                  seed: parseInt(
                    document.getElementById("testSeed").value,
                  ),
                  nFeatures: parseInt(
                    document.getElementById("testFeatures").value,
                  ),
                  nTargets: parseInt(
                    document.getElementById("testTargets").value,
                  ),
                  nSamples: parseInt(
                    document.getElementById("testSamples").value,
                  ),
                  difficulty: parseFloat(
                    document.getElementById("testDifficulty").value,
                  ),
                  noise: parseFloat(
                    document.getElementById("testNoise").value,
                  ),
                  outlierRate: 0.02,
                };

                closeModal("testModal");

                const { samples, desc } = generateTestData(opts);

                await createModel(presets["start"].config);
                await trainBatch(samples);
                await predict(Math.min(50, opts.nSamples / 4));

                state.viewMode = "grid";
                document.getElementById("viewMode").value = "grid";

                showToast(`Test complete: ${desc}`, "success");
                log("Standard Test", desc, "success");
              },
            );
            break;

          case "advancedModal":
            document.getElementById("reinitWorker")?.addEventListener(
              "click",
              async () => {
                state.moduleUrl =
                  document.getElementById("moduleUrl").value;
                worker?.terminate();
                try {
                  await initWorker();
                  showToast("Worker reinitialized", "success");
                  log(
                    "Worker Reinitialized",
                    state.moduleUrl,
                    "success",
                  );
                } catch (e) {
                  showToast(
                    "Worker init failed: " + e.message,
                    "error",
                  );
                }
              },
            );

            document.getElementById("perfMode")?.addEventListener(
              "change",
              (e) => {
                state.performanceMode = e.target.checked;
                localStorage.setItem(
                  "esn-perf-mode",
                  state.performanceMode,
                );
              },
            );
            break;

          case "predictModal":
            document.getElementById("runPredictModal")
              ?.addEventListener("click", async () => {
                const steps = parseInt(
                  document.getElementById("predictSteps").value,
                );
                await predict(steps);
                closeModal("predictModal");
              });

            document.getElementById("exportPredictions")
              ?.addEventListener("click", () => {
                if (state.predictions) {
                  const blob = new Blob([
                    JSON.stringify(state.predictions, null, 2),
                  ], { type: "application/json" });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `predictions-${Date.now()}.json`;
                  a.click();
                  URL.revokeObjectURL(url);
                  showToast("Predictions exported", "success");
                }
              });
            break;
        }
      }

      // Event listeners
      document.getElementById("menuBtn")?.addEventListener(
        "click",
        () => {
          document.getElementById("sidebar").classList.remove(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.remove(
            "hidden",
          );
        },
      );

      document.getElementById("closeSidebar")?.addEventListener(
        "click",
        () => {
          document.getElementById("sidebar").classList.add(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.add(
            "hidden",
          );
        },
      );

      document.getElementById("sidebarOverlay")?.addEventListener(
        "click",
        () => {
          document.getElementById("sidebar").classList.add(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.add(
            "hidden",
          );
        },
      );

      document.getElementById("themeToggle")?.addEventListener(
        "click",
        () => {
          document.documentElement.classList.toggle("dark");
          state.theme =
            document.documentElement.classList.contains("dark")
              ? "dark"
              : "light";
          localStorage.setItem("esn-theme", state.theme);
          renderChart();
        },
      );

      document.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.dataset.action;
          document.getElementById("sidebar").classList.add(
            "-translate-x-full",
          );
          document.getElementById("sidebarOverlay").classList.add(
            "hidden",
          );

          switch (action) {
            case "openConfig":
              openModal("configModal");
              break;
            case "openUpload":
              openModal("uploadModal");
              break;
            case "openInsert":
              openModal("insertModal");
              break;
            case "openSaveLoad":
              openModal("saveLoadModal");
              break;
            case "openTest":
              openModal("testModal");
              break;
            case "openLogs":
              openModal("logsModal");
              break;
            case "openAdvanced":
              openModal("advancedModal");
              break;
            case "openPredict":
              openModal("predictModal");
              break;
            case "showSummary":
              openModal("summaryModal");
              break;
            case "quickStart":
              createModel(presets["start"].config);
              break;
            case "batchTrain":
              if (!state.hasModel) {
                showToast("Create a model first", "warning");
              } else {
                openModal("uploadModal");
              }
              break;
            case "exportData":
              sendToWorker("getDataset").then((result) => {
                if (result.x.length === 0) {
                  showToast("No data to export", "warning");
                  return;
                }
                const blob = new Blob([
                  JSON.stringify(
                    { xCoordinates: result.x, yCoordinates: result.y },
                    null,
                    2,
                  ),
                ], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `dataset-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast("Dataset exported", "success");
              });
              break;
            case "resetAll":
              if (
                confirm(
                  "This will reset everything including the model, data, and logs. Continue?",
                )
              ) {
                sendToWorker("reset").then(() => {
                  state = {
                    ...state,
                    hasModel: false,
                    nFeatures: 0,
                    nTargets: 0,
                    samplesTrained: 0,
                    predictions: null,
                    config: null,
                    selectedDims: [],
                    logs: [],
                  };
                  localStorage.removeItem("esn-model");
                  showToast("Everything reset", "success");
                  updateUI();
                });
              }
              break;
          }
        });
      });

      document.getElementById("quickUpload")?.addEventListener(
        "click",
        () => openModal("uploadModal"),
      );
      document.getElementById("quickPredict")?.addEventListener(
        "click",
        () => openModal("predictModal"),
      );

      document.getElementById("viewMode")?.addEventListener(
        "change",
        (e) => {
          state.viewMode = e.target.value;
          updateDimSelector();
          renderChart();
        },
      );

      document.getElementById("normalizeDisplay")?.addEventListener(
        "change",
        renderChart,
      );

      document.getElementById("futureStepsRange")?.addEventListener(
        "input",
        (e) => {
          document.getElementById("futureStepsInput").value =
            e.target.value;
        },
      );
      document.getElementById("futureStepsInput")?.addEventListener(
        "input",
        (e) => {
          document.getElementById("futureStepsRange").value =
            e.target.value;
        },
      );

      document.getElementById("runPredict")?.addEventListener(
        "click",
        async () => {
          const steps = parseInt(
            document.getElementById("futureStepsInput").value,
          );
          await predict(steps);
        },
      );

      document.getElementById("cancelProgress")?.addEventListener(
        "click",
        async () => {
          if (currentCancelId) {
            await sendToWorker("cancel", {
              requestId: currentCancelId,
            });
            showProgress(false);
          }
        },
      );

      document.getElementById("dimList")?.addEventListener(
        "click",
        (e) => {
          const btn = e.target.closest("[data-dim]");
          if (btn) {
            const dim = parseInt(btn.dataset.dim);
            if (state.selectedDims.includes(dim)) {
              state.selectedDims = state.selectedDims.filter((d) =>
                d !== dim
              );
            } else {
              state.selectedDims = [dim];
            }
            updateDimSelector();
            renderChart();
          }
        },
      );

      document.getElementById("dimSearch")?.addEventListener(
        "input",
        updateDimSelector,
      );

      document.getElementById("selectAllDims")?.addEventListener(
        "click",
        () => {
          state.selectedDims = Array.from(
            { length: state.nTargets },
            (_, i) => i,
          );
          updateDimSelector();
          renderChart();
        },
      );

      document.getElementById("clearDims")?.addEventListener(
        "click",
        () => {
          state.selectedDims = [0];
          updateDimSelector();
          renderChart();
        },
      );

      document.getElementById("exportChart")?.addEventListener(
        "click",
        () => {
          const canvas = document.getElementById("mainChart");
          const url = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = url;
          a.download = `chart-${state.viewMode}-${Date.now()}.png`;
          a.click();
          showToast("Chart exported as PNG", "success");
        },
      );

      // Chart interactivity
      const canvas = document.getElementById("mainChart");
      const tooltip = document.getElementById("tooltip");

      canvas?.addEventListener("mousemove", (e) => {
        if (!state.predictions || state.viewMode !== "focus") return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const chartX = 60;
        const chartW = rect.width - 80;
        const nSteps = state.predictions.predictions.length;

        if (x >= chartX && x <= chartX + chartW) {
          const stepRatio = (x - chartX) / chartW;
          const step = Math.round(stepRatio * (nSteps - 1));
          const dim = state.selectedDims[0] || 0;

          const pred = state.predictions.predictions[step]?.[dim];
          const lower = state.predictions.lowerBounds[step]?.[dim];
          const upper = state.predictions.upperBounds[step]?.[dim];

          if (pred !== undefined) {
            tooltip.classList.remove("hidden");
            tooltip.style.left = (e.clientX - rect.left + 10) + "px";
            tooltip.style.top = (e.clientY - rect.top - 10) + "px";
            tooltip.innerHTML =
              `<div class="font-medium">Step ${step}</div><div>Prediction: ${
                pred.toFixed(4)
              }</div><div class="text-surface-500">Range: [${
                lower.toFixed(4)
              }, ${upper.toFixed(4)}]</div>`;
          }
        }
      });

      canvas?.addEventListener("mouseleave", () => {
        tooltip.classList.add("hidden");
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (
          e.target.tagName === "INPUT" ||
          e.target.tagName === "TEXTAREA"
        ) return;

        switch (e.key.toLowerCase()) {
          case "m":
            e.preventDefault();
            document.getElementById("menuBtn").click();
            break;
          case "c":
            e.preventDefault();
            openModal("configModal");
            break;
          case "u":
            e.preventDefault();
            openModal("uploadModal");
            break;
          case "p":
            e.preventDefault();
            if (state.hasModel && state.samplesTrained > 0) {
              predict(
                parseInt(
                  document.getElementById("futureStepsInput").value,
                ),
              );
            }
            break;
          case "escape":
            closeAllModals();
            break;
        }
      });

      // Resize handler
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(renderChart, 100);
      });

      // Initialize
      async function init() {
        // Load preferences
        const savedTheme = localStorage.getItem("esn-theme");
        if (savedTheme === "dark") {
          document.documentElement.classList.add("dark");
          state.theme = "dark";
        }

        state.performanceMode =
          localStorage.getItem("esn-perf-mode") === "true";

        // Initialize worker
        try {
          const result = await initWorker();
          if (result.success) {
            log(
              "Worker Initialized",
              "ESNRegression module loaded",
              "success",
            );
          } else {
            showToast(
              "Worker initialization warning: " + result.error,
              "warning",
            );
            log("Worker Warning", result.error, "warning");
          }
        } catch (e) {
          showToast("Failed to initialize worker", "error");
          log("Worker Error", e.message, "error");
        }

        updateUI();
      }

      init();
    </script>
  </body>
</html>
