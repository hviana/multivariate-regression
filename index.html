<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
              surface: { light: "#ffffff", dark: "#1e293b" },
            },
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-in-right": "slideInRight 0.3s ease-out",
              "pulse-soft": "pulseSoft 2s ease-in-out infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
              slideUp: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              slideInRight: {
                "0%": { opacity: "0", transform: "translateX(100%)" },
                "100%": { opacity: "1", transform: "translateX(0)" },
              },
              pulseSoft: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.5" },
              },
            },
          },
        },
      };
    </script>
    <style>
      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes toast-out {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
      }
      .toast-enter {
        animation: toast-in 0.25s ease-out forwards;
      }
      .toast-exit {
        animation: toast-out 0.2s ease-in forwards;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.3);
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 116, 139, 0.5);
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
      }
      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        border: none;
      }
      .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
      }
      [data-loading="true"] {
        pointer-events: none;
        opacity: 0.6;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen transition-colors duration-300"
  >
    <div id="app" class="flex flex-col h-screen overflow-hidden">
      <!-- Header -->
      <header
        class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 shadow-sm z-30"
      >
        <div class="flex items-center justify-between gap-4 max-w-full">
          <div class="flex items-center gap-3 min-w-0">
            <button
              id="menuBtn"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring transition-colors lg:hidden"
              aria-label="Open menu"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-lg"
              >
                <svg
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <div class="hidden sm:block">
                <h1
                  class="text-lg font-bold bg-gradient-to-r from-primary-600 to-primary-400 bg-clip-text text-transparent"
                >
                  ESN Regression Studio
                </h1>
                <p class="text-xs text-slate-500 dark:text-slate-400 -mt-0.5">
                  Multivariate Forecasting
                </p>
              </div>
            </div>
          </div>

          <!-- Status Chips -->
          <div
            id="statusChips"
            class="hidden md:flex items-center gap-2 flex-wrap justify-center"
          >
            <span
              id="modelChip"
              class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span class="w-2 h-2 rounded-full bg-slate-400"></span>
              <span>No Model</span>
            </span>
            <span
              id="dataChip"
              class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
            >
              <span>0 samples</span>
            </span>
          </div>

          <!-- Quick Actions -->
          <div class="flex items-center gap-2">
            <button
              id="quickPredictBtn"
              class="hidden sm:inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-lg transition-colors focus-ring disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Predict
            </button>
            <button
              id="themeToggle"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring transition-colors"
              aria-label="Toggle theme"
            >
              <svg
                class="w-5 h-5 dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </button>
            <button
              id="desktopMenuBtn"
              class="hidden lg:flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors focus-ring"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h7"
                />
              </svg>
              Menu
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar Menu (Desktop) -->
        <aside
          id="sidebar"
          class="hidden lg:flex flex-col w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 overflow-hidden transition-all duration-300"
        >
          <nav class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin">
            <div class="mb-4">
              <h3
                class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 px-2"
              >
                Model
              </h3>
              <button
                data-action="config"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                Create / Configure
              </button>
              <button
                data-action="saveload"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                Save / Load
              </button>
            </div>
            <div class="mb-4">
              <h3
                class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 px-2"
              >
                Data
              </h3>
              <button
                data-action="upload"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                Upload Dataset
              </button>
              <button
                data-action="insert"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                Manual Insert
              </button>
            </div>
            <div class="mb-4">
              <h3
                class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 px-2"
              >
                Test
              </h3>
              <button
                data-action="randomtest"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
                Random Test
              </button>
            </div>
            <div>
              <h3
                class="text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 px-2"
              >
                Advanced
              </h3>
              <button
                data-action="settings"
                class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                  />
                </svg>
                Settings
              </button>
            </div>
          </nav>
        </aside>

        <!-- Main Panel -->
        <main class="flex-1 flex flex-col overflow-hidden">
          <!-- Toolbar -->
          <div
            class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-2"
          >
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <select
                  id="viewModeSelect"
                  class="px-3 py-1.5 text-sm bg-slate-100 dark:bg-slate-700 border-0 rounded-lg focus-ring"
                >
                  <option value="focus">Focus View</option>
                  <option value="grid">Small Multiples</option>
                  <option value="heatmap">Heatmap</option>
                  <option value="uncertainty">Uncertainty</option>
                  <option value="snapshot">Snapshot</option>
                </select>
                <select
                  id="dimSelect"
                  class="px-3 py-1.5 text-sm bg-slate-100 dark:bg-slate-700 border-0 rounded-lg focus-ring min-w-[120px]"
                >
                  <option value="0">Dimension 0</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <div
                  class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 rounded-lg p-1"
                >
                  <button
                    id="zoomOutBtn"
                    class="p-1 hover:bg-slate-200 dark:hover:bg-slate-600 rounded focus-ring"
                    aria-label="Zoom out"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"
                      />
                    </svg>
                  </button>
                  <span id="zoomLevel" class="text-xs font-medium px-2"
                  >100%</span>
                  <button
                    id="zoomInBtn"
                    class="p-1 hover:bg-slate-200 dark:hover:bg-slate-600 rounded focus-ring"
                    aria-label="Zoom in"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"
                      />
                    </svg>
                  </button>
                  <button
                    id="zoomResetBtn"
                    class="p-1 hover:bg-slate-200 dark:hover:bg-slate-600 rounded focus-ring"
                    aria-label="Reset zoom"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                      />
                    </svg>
                  </button>
                </div>
                <button
                  id="exportBtn"
                  class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg focus-ring"
                  aria-label="Export chart"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Chart Area -->
          <div
            id="chartContainer"
            class="flex-1 relative overflow-hidden bg-white dark:bg-slate-800"
          >
            <!-- Onboarding -->
            <div
              id="onboarding"
              class="absolute inset-0 flex items-center justify-center p-8"
            >
              <div class="text-center max-w-lg animate-fade-in">
                <div class="mb-8 relative">
                  <div class="w-32 h-32 mx-auto relative">
                    <div
                      class="absolute inset-0 bg-gradient-to-br from-primary-400 to-primary-600 rounded-3xl rotate-6 opacity-20"
                    >
                    </div>
                    <div
                      class="absolute inset-2 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl flex items-center justify-center shadow-xl"
                    >
                      <svg
                        class="w-16 h-16 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                        />
                      </svg>
                    </div>
                  </div>
                </div>
                <h2
                  class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-3"
                >
                  Welcome to ESN Regression Studio
                </h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8">
                  Online multivariate regression and multi-horizon forecasting
                  with Echo State Networks
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                  <button
                    data-action="quickstart"
                    class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 rounded-xl shadow-lg shadow-primary-500/25 transition-all focus-ring"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>
                    Quick Start
                  </button>
                  <button
                    data-action="config"
                    class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-xl transition-all focus-ring"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                      />
                    </svg>
                    Create Model
                  </button>
                  <button
                    data-action="randomtest"
                    class="inline-flex items-center justify-center gap-2 px-6 py-3 text-base font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-xl transition-all focus-ring"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                      />
                    </svg>
                    Run Demo
                  </button>
                </div>
              </div>
            </div>

            <!-- Loading State -->
            <div
              id="loadingOverlay"
              class="absolute inset-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm flex items-center justify-center z-20 hidden"
            >
              <div class="text-center">
                <div
                  class="w-12 h-12 border-4 border-primary-200 dark:border-primary-800 border-t-primary-500 rounded-full animate-spin mx-auto mb-4"
                >
                </div>
                <p
                  id="loadingText"
                  class="text-sm font-medium text-slate-600 dark:text-slate-300"
                >
                  Processing...
                </p>
                <p id="loadingProgress" class="text-xs text-slate-400 mt-1"></p>
                <button
                  id="cancelBtn"
                  class="mt-4 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors hidden"
                >
                  Cancel
                </button>
              </div>
            </div>

            <!-- Focus Chart Canvas -->
            <canvas
              id="focusCanvas"
              class="absolute inset-0 w-full h-full hidden"
            ></canvas>

            <!-- Grid View -->
            <div
              id="gridView"
              class="absolute inset-0 overflow-auto p-4 hidden"
            >
              <div
                id="gridContainer"
                class="grid gap-4"
                style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))"
              >
              </div>
            </div>

            <!-- Heatmap View -->
            <div id="heatmapView" class="absolute inset-0 overflow-auto hidden">
              <canvas id="heatmapCanvas" class="w-full h-full"></canvas>
            </div>

            <!-- Uncertainty View -->
            <div id="uncertaintyView" class="absolute inset-0 hidden">
              <canvas id="uncertaintyCanvas" class="w-full h-full"></canvas>
            </div>

            <!-- Snapshot View -->
            <div
              id="snapshotView"
              class="absolute inset-0 overflow-auto p-4 hidden"
            >
              <div class="max-w-4xl mx-auto">
                <div class="mb-4 flex items-center gap-4">
                  <label class="text-sm font-medium">Step:</label>
                  <input
                    type="range"
                    id="snapshotStep"
                    min="0"
                    max="10"
                    value="0"
                    class="flex-1"
                  >
                  <span id="snapshotStepValue" class="text-sm font-mono w-12"
                  >0</span>
                </div>
                <div id="snapshotBars"></div>
              </div>
            </div>
          </div>

          <!-- Prediction Controls -->
          <div
            class="flex-shrink-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-4 py-3"
          >
            <div class="flex items-center gap-4 flex-wrap">
              <div class="flex items-center gap-2 flex-1 min-w-[200px]">
                <label class="text-sm font-medium whitespace-nowrap"
                >Future Steps:</label>
                <input
                  type="range"
                  id="futureStepsSlider"
                  min="1"
                  max="100"
                  value="20"
                  class="flex-1 h-2 bg-slate-200 dark:bg-slate-600 rounded-lg appearance-none cursor-pointer"
                >
                <input
                  type="number"
                  id="futureStepsInput"
                  min="1"
                  max="1000"
                  value="20"
                  class="w-16 px-2 py-1 text-sm text-center bg-slate-100 dark:bg-slate-700 border-0 rounded-lg focus-ring"
                >
              </div>
              <button
                id="predictBtn"
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-primary-500 hover:bg-primary-600 disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg transition-colors focus-ring"
                disabled
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
                Run Prediction
              </button>
            </div>
          </div>
        </main>

        <!-- Right Panel -->
        <aside
          id="rightPanel"
          class="hidden xl:flex flex-col w-80 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 overflow-hidden"
        >
          <!-- Metrics -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700">
            <h3
              class="text-sm font-semibold text-slate-800 dark:text-slate-100 mb-3"
            >
              Model Metrics
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Samples
                </p>
                <p
                  id="metricSamples"
                  class="text-xl font-bold text-slate-800 dark:text-slate-100"
                >
                  0
                </p>
              </div>
              <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Confidence
                </p>
                <p
                  id="metricConfidence"
                  class="text-xl font-bold text-emerald-500"
                >
                  --
                </p>
              </div>
              <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Features
                </p>
                <p
                  id="metricFeatures"
                  class="text-xl font-bold text-slate-800 dark:text-slate-100"
                >
                  --
                </p>
              </div>
              <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  Targets
                </p>
                <p
                  id="metricTargets"
                  class="text-xl font-bold text-slate-800 dark:text-slate-100"
                >
                  --
                </p>
              </div>
            </div>
          </div>

          <!-- Prediction Stats -->
          <div
            id="predictionStats"
            class="p-4 border-b border-slate-200 dark:border-slate-700 hidden"
          >
            <h3
              class="text-sm font-semibold text-slate-800 dark:text-slate-100 mb-3"
            >
              Prediction Summary
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-slate-500">Steps:</span><span
                  id="statSteps"
                  class="font-medium"
                >--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-500">Min Value:</span><span
                  id="statMin"
                  class="font-medium"
                >--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-500">Max Value:</span><span
                  id="statMax"
                  class="font-medium"
                >--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-500">Avg Uncertainty:</span><span
                  id="statUncertainty"
                  class="font-medium"
                >--</span>
              </div>
            </div>
          </div>

          <!-- Event Log -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between p-4 pb-2">
              <h3
                class="text-sm font-semibold text-slate-800 dark:text-slate-100"
              >
                Event Log
              </h3>
              <select
                id="logFilter"
                class="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 border-0 rounded focus-ring"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <div
              id="eventLog"
              class="flex-1 overflow-y-auto px-4 pb-4 space-y-2 scrollbar-thin"
            >
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenu" class="fixed inset-0 z-50 hidden">
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-menu
      >
      </div>
      <div
        class="absolute left-0 top-0 bottom-0 w-72 bg-white dark:bg-slate-800 shadow-2xl animate-slide-in-right"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="text-lg font-semibold">Menu</h2>
          <button
            data-close-menu
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <nav class="p-4 space-y-1">
          <p
            class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-2"
          >
            Model
          </p>
          <button
            data-action="config"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            Create / Configure
          </button>
          <button
            data-action="saveload"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
              />
            </svg>
            Save / Load
          </button>
          <p
            class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2 px-2"
          >
            Data
          </p>
          <button
            data-action="upload"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            Upload Dataset
          </button>
          <button
            data-action="insert"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            Manual Insert
          </button>
          <p
            class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2 px-2"
          >
            Test
          </p>
          <button
            data-action="randomtest"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
              />
            </svg>
            Random Test
          </button>
          <p
            class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-4 mb-2 px-2"
          >
            Advanced
          </p>
          <button
            data-action="settings"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
              />
            </svg>
            Settings
          </button>
        </nav>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"
    >
    </div>

    <!-- Config Modal -->
    <div
      id="configModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-4xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">
              Model Configuration
            </h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">
              Configure and create your ESN model
            </p>
          </div>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Presets -->
        <div
          class="p-4 md:px-6 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/30"
        >
          <p
            class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            Quick Presets
          </p>
          <div class="flex flex-wrap gap-2">
            <button
              data-preset="start"
              class="px-3 py-1.5 text-sm font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-900/50 rounded-lg transition-colors"
            >
              Start Here
            </button>
            <button
              data-preset="fast"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Fast/Light
            </button>
            <button
              data-preset="balanced"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Balanced
            </button>
            <button
              data-preset="accurate"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Accurate
            </button>
            <button
              data-preset="adaptive"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Adaptive
            </button>
            <button
              data-preset="noisy"
              class="px-3 py-1.5 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Noisy/Robust
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scrollbar-thin">
          <form id="configForm" class="space-y-6">
            <!-- Reservoir Architecture -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸ”„</span> Reservoir Architecture
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Max Sequence Length</label>
                  <input
                    type="number"
                    name="maxSequenceLength"
                    value="64"
                    min="1"
                    max="1000"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Memory window size. Higher = more context but slower. Range:
                    16-256
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Reservoir Size</label>
                  <input
                    type="number"
                    name="reservoirSize"
                    value="256"
                    min="8"
                    max="4096"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Number of reservoir nodes. Larger = more capacity but
                    slower. Range: 64-1024
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Spectral Radius</label>
                  <input
                    type="number"
                    name="spectralRadius"
                    value="0.9"
                    min="0.1"
                    max="2"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Echo memory decay. &lt;1 stable, &gt;1 chaotic. Range:
                    0.5-0.99
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Leak Rate</label>
                  <input
                    type="number"
                    name="leakRate"
                    value="0.3"
                    min="0.01"
                    max="1"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    State update speed. Lower = more memory, higher = faster
                    adaptation. Range: 0.1-0.8
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Input Scale</label>
                  <input
                    type="number"
                    name="inputScale"
                    value="1.0"
                    min="0.01"
                    max="10"
                    step="0.1"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Input signal amplification. Increase for weak signals.
                    Range: 0.1-2.0
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Bias Scale</label>
                  <input
                    type="number"
                    name="biasScale"
                    value="0.1"
                    min="0"
                    max="2"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Internal bias strength. Helps with asymmetric data. Range:
                    0-0.5
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Reservoir Sparsity</label>
                  <input
                    type="number"
                    name="reservoirSparsity"
                    value="0.9"
                    min="0"
                    max="0.99"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Connection sparsity (0=full, 1=empty). Higher = faster, less
                    overfitting. Range: 0.8-0.95
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Input Sparsity</label>
                  <input
                    type="number"
                    name="inputSparsity"
                    value="0.0"
                    min="0"
                    max="0.99"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Input connection sparsity. Usually keep at 0. Range: 0-0.5
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Activation</label>
                  <select
                    name="activation"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                    <option value="tanh" selected>tanh (default)</option>
                    <option value="relu">relu</option>
                  </select>
                  <p class="text-xs text-slate-400 mt-1">
                    tanh: smooth, bounded. relu: faster, unbounded.
                  </p>
                </div>
              </div>
            </fieldset>

            <!-- Readout Configuration -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸ“¤</span> Readout Configuration
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div class="flex items-center gap-3">
                  <input
                    type="checkbox"
                    name="useInputInReadout"
                    id="useInputInReadout"
                    checked
                    class="w-4 h-4 rounded border-slate-300 text-primary-500 focus-ring"
                  >
                  <label for="useInputInReadout" class="text-sm font-medium"
                  >Use Input in Readout</label>
                </div>
                <div class="flex items-center gap-3">
                  <input
                    type="checkbox"
                    name="useBiasInReadout"
                    id="useBiasInReadout"
                    checked
                    class="w-4 h-4 rounded border-slate-300 text-primary-500 focus-ring"
                  >
                  <label for="useBiasInReadout" class="text-sm font-medium"
                  >Use Bias in Readout</label>
                </div>
              </div>
              <p class="text-xs text-slate-400 mt-2">
                Enable for better accuracy. Disable for speed or to reduce
                overfitting.
              </p>
            </fieldset>

            <!-- Training (RLS) -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸŽ¯</span> Training (RLS)
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >RLS Lambda</label>
                  <input
                    type="number"
                    name="rlsLambda"
                    value="0.999"
                    min="0.9"
                    max="1"
                    step="0.001"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Forgetting factor. Lower = faster adaptation, higher =
                    stability. Range: 0.95-0.9999
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >RLS Delta</label>
                  <input
                    type="number"
                    name="rlsDelta"
                    value="1.0"
                    min="0.01"
                    max="100"
                    step="0.1"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Initial covariance diagonal. Higher = more uncertain start.
                    Range: 0.1-10
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Epsilon</label>
                  <input
                    type="number"
                    name="epsilon"
                    value="1e-8"
                    min="1e-12"
                    max="1e-4"
                    step="1e-9"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Numerical stability constant. Keep small. Range: 1e-10 to
                    1e-6
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >L2 Lambda</label>
                  <input
                    type="number"
                    name="l2Lambda"
                    value="0.0001"
                    min="0"
                    max="1"
                    step="0.0001"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Regularization strength. Higher = less overfitting but may
                    underfit. Range: 0-0.01
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Gradient Clip Norm</label>
                  <input
                    type="number"
                    name="gradientClipNorm"
                    value="1.0"
                    min="0.1"
                    max="100"
                    step="0.1"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Max gradient magnitude. Prevents exploding updates. Range:
                    0.5-10
                  </p>
                </div>
              </div>
            </fieldset>

            <!-- Normalization -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸ“Š</span> Normalization
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Normalization Epsilon</label>
                  <input
                    type="number"
                    name="normalizationEpsilon"
                    value="1e-8"
                    min="1e-12"
                    max="1e-4"
                    step="1e-9"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Prevents division by zero in normalization.
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Normalization Warmup</label>
                  <input
                    type="number"
                    name="normalizationWarmup"
                    value="10"
                    min="1"
                    max="1000"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Samples before normalization stabilizes. Range: 5-50
                  </p>
                </div>
              </div>
            </fieldset>

            <!-- Outlier Handling -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸ›¡ï¸</span> Outlier Handling
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Outlier Threshold</label>
                  <input
                    type="number"
                    name="outlierThreshold"
                    value="3.0"
                    min="1"
                    max="10"
                    step="0.1"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Standard deviations for outlier detection. Lower = more
                    aggressive. Range: 2-5
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Outlier Min Weight</label>
                  <input
                    type="number"
                    name="outlierMinWeight"
                    value="0.1"
                    min="0"
                    max="1"
                    step="0.05"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Minimum weight for outliers. 0 = ignore completely, 1 = no
                    downweighting. Range: 0.05-0.3
                  </p>
                </div>
              </div>
            </fieldset>

            <!-- Uncertainty -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>ðŸ“ˆ</span> Uncertainty
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Residual Window Size</label>
                  <input
                    type="number"
                    name="residualWindowSize"
                    value="100"
                    min="10"
                    max="1000"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Recent samples for uncertainty estimation. Range: 50-200
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Uncertainty Multiplier</label>
                  <input
                    type="number"
                    name="uncertaintyMultiplier"
                    value="1.96"
                    min="0.5"
                    max="5"
                    step="0.01"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Confidence interval width. 1.96 = 95% CI, 2.576 = 99% CI.
                    Range: 1-3
                  </p>
                </div>
              </div>
            </fieldset>

            <!-- Initialization -->
            <fieldset
              class="border border-slate-200 dark:border-slate-600 rounded-xl p-4"
            >
              <legend
                class="px-2 text-sm font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"
              >
                <span>âš™ï¸</span> Initialization
              </legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Weight Init Scale</label>
                  <input
                    type="number"
                    name="weightInitScale"
                    value="0.1"
                    min="0.001"
                    max="1"
                    step="0.01"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Initial weight magnitude. Range: 0.01-0.5
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Seed</label>
                  <input
                    type="number"
                    name="seed"
                    value="42"
                    min="0"
                    max="999999"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                  <p class="text-xs text-slate-400 mt-1">
                    Random seed for reproducibility.
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1"
                  >Rollforward Mode</label>
                  <select
                    name="rollforwardMode"
                    class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                  >
                    <option value="holdLastX" selected>holdLastX</option>
                    <option value="autoregressive">autoregressive</option>
                  </select>
                  <p class="text-xs text-slate-400 mt-1">
                    holdLastX: use last input. autoregressive: use predictions
                    as input.
                  </p>
                </div>
                <div class="flex items-center gap-3 pt-6">
                  <input
                    type="checkbox"
                    name="verbose"
                    id="verbose"
                    class="w-4 h-4 rounded border-slate-300 text-primary-500 focus-ring"
                  >
                  <label for="verbose" class="text-sm font-medium"
                  >Verbose Logging</label>
                </div>
              </div>
            </fieldset>
          </form>
        </div>

        <div
          class="flex items-center justify-between p-4 md:p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/30"
        >
          <div class="flex gap-2">
            <button
              id="resetDefaultsBtn"
              class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Reset Defaults
            </button>
            <button
              id="resetEverythingBtn"
              class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
            >
              Reset Everything
            </button>
          </div>
          <div class="flex gap-2">
            <button
              data-close-modal
              class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors"
            >
              Cancel
            </button>
            <button
              id="createModelBtn"
              class="px-6 py-2 text-sm font-semibold text-white bg-primary-500 hover:bg-primary-600 rounded-lg transition-colors focus-ring"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div
      id="uploadModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-bold">Upload Dataset</h2>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2"
            >Upload JSON File</label>
            <div
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-primary-400 transition-colors cursor-pointer"
              id="dropZone"
            >
              <input type="file" id="fileInput" accept=".json" class="hidden">
              <svg
                class="w-12 h-12 mx-auto text-slate-400 mb-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              <p class="text-sm text-slate-600 dark:text-slate-300">
                Drop JSON file here or click to browse
              </p>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Or Paste JSON</label>
            <textarea
              id="jsonInput"
              rows="6"
              placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'
              class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring font-mono text-sm"
            ></textarea>
          </div>
          <details class="mb-6">
            <summary
              class="text-sm font-medium cursor-pointer text-primary-600 dark:text-primary-400"
            >
              Supported Formats
            </summary>
            <div
              class="mt-2 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-xs font-mono space-y-2"
            >
              <p>
                <strong>Format A:</strong> {"xCoordinates": [[f1,f2,...], ...],
                "yCoordinates": [[t1,t2,...], ...]}
              </p>
              <p>
                <strong>Format B:</strong> {"samples": [{"x": [f1,...], "y":
                [t1,...]}, ...]}
              </p>
            </div>
          </details>
          <div id="uploadPreview" class="hidden">
            <h3 class="text-sm font-semibold mb-2">Validation Preview</h3>
            <div
              id="previewContent"
              class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
            >
            </div>
          </div>
        </div>
        <div
          class="flex justify-end gap-2 p-4 md:p-6 border-t border-slate-200 dark:border-slate-700"
        >
          <button
            data-close-modal
            class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg"
          >
            Cancel
          </button>
          <button
            id="uploadApplyBtn"
            class="px-6 py-2 text-sm font-semibold text-white bg-primary-500 hover:bg-primary-600 rounded-lg disabled:opacity-50"
            disabled
          >
            Train with Dataset
          </button>
        </div>
      </div>
    </div>

    <!-- Insert Modal -->
    <div
      id="insertModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-bold">Manual Insert</h2>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <div class="mb-4">
            <button
              id="genTemplateBtn"
              class="text-sm text-primary-600 dark:text-primary-400 hover:underline"
            >
              Generate template from model dimensions
            </button>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Sample JSON</label>
            <textarea
              id="insertInput"
              rows="6"
              placeholder='{"x": [0.1, 0.2, ...], "y": [0.5, 0.6, ...]}'
              class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring font-mono text-sm"
            ></textarea>
          </div>
          <div id="insertValidation" class="text-sm"></div>
        </div>
        <div
          class="flex justify-end gap-2 p-4 md:p-6 border-t border-slate-200 dark:border-slate-700"
        >
          <button
            data-close-modal
            class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg"
          >
            Cancel
          </button>
          <button
            id="insertApplyBtn"
            class="px-6 py-2 text-sm font-semibold text-white bg-primary-500 hover:bg-primary-600 rounded-lg disabled:opacity-50"
            disabled
          >
            Insert Sample
          </button>
        </div>
      </div>
    </div>

    <!-- Save/Load Modal -->
    <div
      id="saveLoadModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-bold">Save / Load Model</h2>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
          <div>
            <h3 class="text-sm font-semibold mb-3">Save Model</h3>
            <div class="flex gap-2">
              <button
                id="saveFileBtn"
                class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                disabled
              >
                Save to File
              </button>
              <button
                id="saveLocalBtn"
                class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                disabled
              >
                Save to Browser
              </button>
            </div>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-3">Load Model</h3>
            <div class="flex gap-2 mb-3">
              <button
                id="loadFileBtn"
                class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors"
              >
                Load from File
              </button>
              <button
                id="loadLocalBtn"
                class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                disabled
              >
                Load from Browser
              </button>
            </div>
            <input type="file" id="loadFileInput" accept=".json" class="hidden">
            <div id="localStorageInfo" class="text-xs text-slate-500"></div>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-3">Clear Data</h3>
            <button
              id="clearLocalBtn"
              class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
            >
              Clear Browser Storage
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomTestModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-lg bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-bold">Random Test</h2>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <form id="randomTestForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Seed</label>
                <input
                  type="number"
                  name="testSeed"
                  value="42"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Samples</label>
                <input
                  type="number"
                  name="testSamples"
                  value="200"
                  min="10"
                  max="5000"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Features</label>
                <input
                  type="number"
                  name="testFeatures"
                  value="5"
                  min="1"
                  max="50"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Targets</label>
                <input
                  type="number"
                  name="testTargets"
                  value="3"
                  min="1"
                  max="30"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                >Noise Level</label>
                <input
                  type="number"
                  name="testNoise"
                  value="0.1"
                  min="0"
                  max="1"
                  step="0.05"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                >Outlier Rate</label>
                <input
                  type="number"
                  name="testOutlierRate"
                  value="0.02"
                  min="0"
                  max="0.3"
                  step="0.01"
                  class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
                >
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Difficulty</label>
              <select
                name="testDifficulty"
                class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring"
              >
                <option value="easy">Easy (linear + simple nonlinear)</option>
                <option value="medium" selected>
                  Medium (polynomial + trig)
                </option>
                <option value="hard">Hard (complex interactions)</option>
              </select>
            </div>
          </form>
          <div
            id="testSummary"
            class="mt-4 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-sm hidden"
          >
            <h4 class="font-semibold mb-2">
              Generated Function Characteristics:
            </h4>
            <p id="testSummaryText" class="text-slate-600 dark:text-slate-300">
            </p>
          </div>
        </div>
        <div
          class="flex justify-end gap-2 p-4 md:p-6 border-t border-slate-200 dark:border-slate-700"
        >
          <button
            data-close-modal
            class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg"
          >
            Cancel
          </button>
          <button
            id="runTestBtn"
            class="px-6 py-2 text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 rounded-lg focus-ring"
          >
            Generate + Train + Predict
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        data-close-modal
      >
      </div>
      <div
        class="absolute inset-4 md:inset-8 lg:inset-y-8 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
      >
        <div
          class="flex items-center justify-between p-4 md:p-6 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-bold">Advanced Settings</h2>
          <button
            data-close-modal
            class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Module URL</label>
            <input
              type="text"
              id="moduleUrlInput"
              value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression"
              class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus-ring font-mono text-sm"
            >
            <p class="text-xs text-slate-400 mt-1">
              ESNRegression module source. Change and reinitialize if needed.
            </p>
          </div>
          <button
            id="reinitWorkerBtn"
            class="w-full px-4 py-2 text-sm font-medium text-amber-600 bg-amber-50 dark:bg-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/30 rounded-lg transition-colors"
          >
            Reinitialize Worker
          </button>
        </div>
      </div>
    </div>

    <script>
      const APP_VERSION = "1.0.0";
      const COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
      ];

      const PRESETS = {
        start: {
          maxSequenceLength: 64,
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          residualWindowSize: 100,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
          rollforwardMode: "holdLastX",
        },
        fast: {
          maxSequenceLength: 32,
          reservoirSize: 128,
          spectralRadius: 0.9,
          leakRate: 0.5,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.95,
          inputSparsity: 0.0,
          activation: "relu",
          useInputInReadout: false,
          useBiasInReadout: true,
          rlsLambda: 0.99,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 5,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          residualWindowSize: 50,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
          rollforwardMode: "holdLastX",
        },
        balanced: {
          maxSequenceLength: 64,
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.999,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 3.0,
          outlierMinWeight: 0.1,
          residualWindowSize: 100,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
          rollforwardMode: "holdLastX",
        },
        accurate: {
          maxSequenceLength: 128,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.85,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.9999,
          rlsDelta: 0.5,
          epsilon: 1e-10,
          l2Lambda: 0.00001,
          gradientClipNorm: 0.5,
          normalizationEpsilon: 1e-10,
          normalizationWarmup: 20,
          outlierThreshold: 3.5,
          outlierMinWeight: 0.1,
          residualWindowSize: 200,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.05,
          seed: 42,
          verbose: false,
          rollforwardMode: "holdLastX",
        },
        adaptive: {
          maxSequenceLength: 64,
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.4,
          inputScale: 1.0,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.99,
          rlsDelta: 1.0,
          epsilon: 1e-8,
          l2Lambda: 0.0001,
          gradientClipNorm: 1.0,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 10,
          outlierThreshold: 2.5,
          outlierMinWeight: 0.2,
          residualWindowSize: 50,
          uncertaintyMultiplier: 1.96,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
          rollforwardMode: "autoregressive",
        },
        noisy: {
          maxSequenceLength: 64,
          reservoirSize: 256,
          spectralRadius: 0.85,
          leakRate: 0.3,
          inputScale: 0.8,
          biasScale: 0.1,
          reservoirSparsity: 0.9,
          inputSparsity: 0.0,
          activation: "tanh",
          useInputInReadout: true,
          useBiasInReadout: true,
          rlsLambda: 0.995,
          rlsDelta: 2.0,
          epsilon: 1e-8,
          l2Lambda: 0.001,
          gradientClipNorm: 0.5,
          normalizationEpsilon: 1e-8,
          normalizationWarmup: 20,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          residualWindowSize: 150,
          uncertaintyMultiplier: 2.576,
          weightInitScale: 0.1,
          seed: 42,
          verbose: false,
          rollforwardMode: "holdLastX",
        },
      };

      let state = {
        modelReady: false,
        nFeatures: null,
        nTargets: null,
        sampleCount: 0,
        config: { ...PRESETS.start },
        predictions: null,
        viewMode: "focus",
        selectedDim: 0,
        zoom: 1,
        panOffset: 0,
        moduleUrl:
          "https://cdn.esm.sh/jsr/@hviana/multivariate-regression",
        pendingRequests: new Map(),
        currentCancel: null,
      };

      let worker = null;
      let requestId = 0;
      const logs = [];

      function initWorker() {
        const workerCode = `
let ESNRegression = null;
let model = null;
let modelConfig = null;
let nFeatures = null;
let nTargets = null;
let sampleCount = 0;
let moduleUrl = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression';
let cancelled = new Set();

async function loadModule(url) {
  try {
    const mod = await import(url);
    if (mod.ESNRegression) return mod.ESNRegression;
    if (mod.default?.ESNRegression) return mod.default.ESNRegression;
    if (mod.default) return mod.default;
    throw new Error('ESNRegression not found in module');
  } catch (e1) {
    console.warn('Dynamic import failed, trying fetch fallback:', e1.message);
    try {
      const resp = await fetch(url);
      const text = await resp.text();
      const blobUrl = URL.createObjectURL(new Blob([text], { type: 'application/javascript' }));
      const mod = await import(blobUrl);
      URL.revokeObjectURL(blobUrl);
      if (mod.ESNRegression) return mod.ESNRegression;
      if (mod.default?.ESNRegression) return mod.default.ESNRegression;
      if (mod.default) return mod.default;
      throw new Error('ESNRegression not found after fetch fallback');
    } catch (e2) {
      throw new Error('Failed to load module: ' + e2.message);
    }
  }
}

async function init(url) {
  moduleUrl = url || moduleUrl;
  ESNRegression = await loadModule(moduleUrl);
  return { success: true };
}

function createModel(config) {
  if (!ESNRegression) throw new Error('Module not loaded');
  model = new ESNRegression({ readoutTraining: 'rls', ...config });
  modelConfig = config;
  nFeatures = null;
  nTargets = null;
  sampleCount = 0;
  return { success: true };
}

function trainBatch(data, reqId) {
  if (!model) throw new Error('Model not created');
  const samples = data.samples || data.xCoordinates?.map((x, i) => ({ x, y: data.yCoordinates[i] }));
  if (!samples?.length) throw new Error('No samples');
  
  const total = samples.length;
  for (let i = 0; i < total; i++) {
    if (cancelled.has(reqId)) {
      cancelled.delete(reqId);
      return { cancelled: true, processed: i };
    }
    const s = samples[i];
    if (!nFeatures) { nFeatures = s.x.length; nTargets = s.y.length; }
    model.fitOnline(s.x, s.y);
    sampleCount++;
    if (i % 10 === 0 || i === total - 1) {
      self.postMessage({ type: 'progress', requestId: reqId, processed: i + 1, total, percent: ((i + 1) / total * 100).toFixed(1) });
    }
  }
  return { success: true, sampleCount, nFeatures, nTargets };
}

function trainSingle(sample) {
  if (!model) throw new Error('Model not created');
  if (!nFeatures) { nFeatures = sample.x.length; nTargets = sample.y.length; }
  const result = model.fitOnline(sample.x, sample.y);
  sampleCount++;
  return { success: true, sampleCount, nFeatures, nTargets, result };
}

function predict(futureSteps) {
  if (!model) throw new Error('Model not created');
  if (sampleCount < 1) throw new Error('No training data');
  const result = model.predict(futureSteps);
  return { success: true, ...result };
}

function saveModel() {
  if (!model) throw new Error('Model not created');
  const modelState = model.save();
  return {
    modelState,
    meta: { config: modelConfig, nFeatures, nTargets, sampleCount, createdAt: new Date().toISOString(), appVersion: '1.0.0' }
  };
}

function loadModel(data) {
  if (!ESNRegression) throw new Error('Module not loaded');
  let modelState, meta;
  if (typeof data === 'string') {
    modelState = data;
    meta = {};
  } else if (data.modelState) {
    modelState = data.modelState;
    meta = data.meta || {};
  } else {
    throw new Error('Invalid model format');
  }
  model = ESNRegression.load(modelState);
  modelConfig = meta.config || {};
  nFeatures = meta.nFeatures || null;
  nTargets = meta.nTargets || null;
  sampleCount = meta.sampleCount || 0;
  return { success: true, nFeatures, nTargets, sampleCount, config: modelConfig };
}

function getStatus() {
  return { modelReady: !!model, nFeatures, nTargets, sampleCount, config: modelConfig };
}

self.onmessage = async (e) => {
  const { type, payload, requestId } = e.data;
  try {
    let result;
    switch (type) {
      case 'init': result = await init(payload?.url); break;
      case 'create': result = createModel(payload); break;
      case 'trainBatch': result = trainBatch(payload, requestId); break;
      case 'trainSingle': result = trainSingle(payload); break;
      case 'predict': result = predict(payload.futureSteps); break;
      case 'save': result = saveModel(); break;
      case 'load': result = loadModel(payload); break;
      case 'status': result = getStatus(); break;
      case 'cancel': cancelled.add(payload.cancelId); result = { cancelled: true }; break;
      default: throw new Error('Unknown action: ' + type);
    }
    self.postMessage({ type: 'result', requestId, result });
  } catch (err) {
    self.postMessage({ type: 'error', requestId, error: err.message });
  }
};
`;
        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });
        worker.onmessage = handleWorkerMessage;
      }

      function handleWorkerMessage(e) {
        const {
          type,
          requestId: rid,
          result,
          error,
          processed,
          total,
          percent,
        } = e.data;
        if (type === "progress") {
          updateProgress(processed, total, percent);
          return;
        }
        const pending = state.pendingRequests.get(rid);
        if (!pending) return;
        state.pendingRequests.delete(rid);
        if (type === "error") {
          pending.reject(new Error(error));
        } else {
          pending.resolve(result);
        }
      }

      function sendWorker(type, payload) {
        return new Promise((resolve, reject) => {
          const rid = ++requestId;
          state.pendingRequests.set(rid, { resolve, reject });
          worker.postMessage({ type, payload, requestId: rid });
        });
      }

      function sendWorkerCancellable(type, payload) {
        const rid = ++requestId;
        state.currentCancel = rid;
        return new Promise((resolve, reject) => {
          state.pendingRequests.set(rid, { resolve, reject });
          worker.postMessage({ type, payload, requestId: rid });
        });
      }

      function cancelCurrent() {
        if (state.currentCancel) {
          worker.postMessage({
            type: "cancel",
            payload: { cancelId: state.currentCancel },
            requestId: ++requestId,
          });
          state.currentCancel = null;
        }
      }

      // UI Elements
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      // Toast system
      function showToast(message, type = "info") {
        const container = $("#toastContainer");
        const toast = document.createElement("div");
        const colors = {
          success: "bg-emerald-500",
          error: "bg-red-500",
          warning: "bg-amber-500",
          info: "bg-primary-500",
        };
        toast.className =
          `pointer-events-auto px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium ${
            colors[type]
          } toast-enter flex items-center gap-2`;
        const icons = {
          success:
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
          error:
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
          warning:
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
          info:
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        };
        toast.innerHTML = icons[type] + `<span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.remove("toast-enter");
          toast.classList.add("toast-exit");
          setTimeout(() => toast.remove(), 200);
        }, 3000);
      }

      function addLog(action, details, type = "info") {
        const time = new Date().toLocaleTimeString();
        logs.unshift({ time, action, details, type });
        if (logs.length > 200) logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const filter = $("#logFilter").value;
        const container = $("#eventLog");
        const filtered = filter === "all"
          ? logs
          : logs.filter((l) => l.type === filter);
        container.innerHTML = filtered.slice(0, 50).map((l) => {
          const colors = {
            success: "text-emerald-500",
            error: "text-red-500",
            warning: "text-amber-500",
            info: "text-slate-400",
          };
          return `<div class="text-xs p-2 bg-slate-50 dark:bg-slate-700/50 rounded"><span class="${
            colors[l.type]
          }">[${l.time}]</span> <span class="font-medium">${l.action}</span><span class="text-slate-500 dark:text-slate-400 block truncate">${l.details}</span></div>`;
        }).join("");
      }

      function updateUI() {
        const modelChip = $("#modelChip");
        const dataChip = $("#dataChip");
        const predBtn = $("#predictBtn");
        const quickPredBtn = $("#quickPredictBtn");
        const saveFileBtn = $("#saveFileBtn");
        const saveLocalBtn = $("#saveLocalBtn");

        if (state.modelReady) {
          modelChip.innerHTML =
            '<span class="w-2 h-2 rounded-full bg-emerald-500"></span><span>Model Ready</span>';
          modelChip.className = modelChip.className.replace(
            "bg-slate-100 dark:bg-slate-700",
            "bg-emerald-100 dark:bg-emerald-900/30",
          );
        } else {
          modelChip.innerHTML =
            '<span class="w-2 h-2 rounded-full bg-slate-400"></span><span>No Model</span>';
          modelChip.className = modelChip.className.replace(
            "bg-emerald-100 dark:bg-emerald-900/30",
            "bg-slate-100 dark:bg-slate-700",
          );
        }

        dataChip.textContent = `${state.sampleCount} samples`;

        const canPredict = state.modelReady && state.sampleCount > 0;
        predBtn.disabled = !canPredict;
        quickPredBtn.disabled = !canPredict;
        saveFileBtn.disabled = !state.modelReady;
        saveLocalBtn.disabled = !state.modelReady;

        $("#metricSamples").textContent = state.sampleCount;
        $("#metricFeatures").textContent = state.nFeatures ?? "--";
        $("#metricTargets").textContent = state.nTargets ?? "--";

        updateDimSelect();

        if (state.modelReady || state.predictions) {
          $("#onboarding").classList.add("hidden");
        } else {
          $("#onboarding").classList.remove("hidden");
        }

        checkLocalStorage();
      }

      function updateDimSelect() {
        const select = $("#dimSelect");
        const n = state.nTargets || 1;
        select.innerHTML = Array.from(
          { length: n },
          (_, i) => `<option value="${i}">Dimension ${i}</option>`,
        ).join("");
        select.value = state.selectedDim;
      }

      function showLoading(
        text = "Processing...",
        cancellable = false,
      ) {
        $("#loadingOverlay").classList.remove("hidden");
        $("#loadingText").textContent = text;
        $("#loadingProgress").textContent = "";
        $("#cancelBtn").classList.toggle("hidden", !cancellable);
      }

      function hideLoading() {
        $("#loadingOverlay").classList.add("hidden");
        state.currentCancel = null;
      }

      function updateProgress(processed, total, percent) {
        $("#loadingProgress").textContent =
          `${processed} / ${total} (${percent}%)`;
      }

      function openModal(id) {
        $(id).classList.remove("hidden");
        $(id).querySelector("[data-close-modal]")?.focus();
        closeMobileMenu();
      }

      function closeModal(id) {
        $(id).classList.add("hidden");
      }

      function closeMobileMenu() {
        $("#mobileMenu").classList.add("hidden");
      }

      function checkLocalStorage() {
        const saved = localStorage.getItem("esn_model");
        const info = $("#localStorageInfo");
        const loadBtn = $("#loadLocalBtn");
        if (saved) {
          try {
            const data = JSON.parse(saved);
            const meta = data.meta || {};
            info.textContent = `Saved: ${
              meta.createdAt
                ? new Date(meta.createdAt).toLocaleDateString()
                : "Unknown"
            }, ${meta.sampleCount || "?"} samples`;
            loadBtn.disabled = false;
          } catch {
            info.textContent = "Invalid saved data";
            loadBtn.disabled = true;
          }
        } else {
          info.textContent = "No saved model";
          loadBtn.disabled = true;
        }
      }

      // Form helpers
      function getFormData(form) {
        const data = {};
        const formData = new FormData(form);
        for (const [key, value] of formData) {
          const input = form.querySelector(`[name="${key}"]`);
          if (input?.type === "checkbox") {
            data[key] = input.checked;
          } else if (input?.type === "number") {
            data[key] = parseFloat(value);
          } else {
            data[key] = value;
          }
        }
        return data;
      }

      function setFormData(form, data) {
        for (const [key, value] of Object.entries(data)) {
          const input = form.querySelector(`[name="${key}"]`);
          if (!input) continue;
          if (input.type === "checkbox") {
            input.checked = !!value;
          } else {
            input.value = value;
          }
        }
      }

      // Data validation
      function validateDataset(data) {
        const errors = [];
        let samples = null;

        if (data.xCoordinates && data.yCoordinates) {
          if (!Array.isArray(data.xCoordinates)) {
            errors.push("xCoordinates must be an array");
          }
          if (!Array.isArray(data.yCoordinates)) {
            errors.push("yCoordinates must be an array");
          }
          if (
            errors.length === 0 &&
            data.xCoordinates.length !== data.yCoordinates.length
          ) {
            errors.push(
              `Length mismatch: xCoordinates has ${data.xCoordinates.length}, yCoordinates has ${data.yCoordinates.length}`,
            );
          }
          if (errors.length === 0) {
            samples = data.xCoordinates.map((x, i) => ({
              x,
              y: data.yCoordinates[i],
            }));
          }
        } else if (data.samples) {
          if (!Array.isArray(data.samples)) {
            errors.push("samples must be an array");
          } else samples = data.samples;
        } else if (data.x && data.y) {
          samples = [{ x: data.x, y: data.y }];
        } else {
          errors.push(
            "Invalid format. Expected xCoordinates/yCoordinates or samples array",
          );
        }

        if (samples && errors.length === 0) {
          let nFeatures = null, nTargets = null;
          for (let i = 0; i < samples.length; i++) {
            const s = samples[i];
            if (!s.x || !s.y) {
              errors.push(`Sample ${i}: missing x or y`);
              continue;
            }
            if (!Array.isArray(s.x) || !Array.isArray(s.y)) {
              errors.push(`Sample ${i}: x and y must be arrays`);
              continue;
            }
            if (nFeatures === null) {
              nFeatures = s.x.length;
              nTargets = s.y.length;
            } else {
              if (s.x.length !== nFeatures) {
                errors.push(
                  `Sample ${i}: feature dimension mismatch (expected ${nFeatures}, got ${s.x.length})`,
                );
              }
              if (s.y.length !== nTargets) {
                errors.push(
                  `Sample ${i}: target dimension mismatch (expected ${nTargets}, got ${s.y.length})`,
                );
              }
            }
            for (let j = 0; j < s.x.length; j++) {
              if (typeof s.x[j] !== "number" || isNaN(s.x[j])) {
                errors.push(
                  `Sample ${i}: x[${j}] is not a valid number`,
                );
              }
            }
            for (let j = 0; j < s.y.length; j++) {
              if (typeof s.y[j] !== "number" || isNaN(s.y[j])) {
                errors.push(
                  `Sample ${i}: y[${j}] is not a valid number`,
                );
              }
            }
            if (errors.length > 10) {
              errors.push("...and more errors");
              break;
            }
          }
          if (errors.length === 0) {
            return {
              valid: true,
              samples,
              nFeatures,
              nTargets,
              count: samples.length,
            };
          }
        }
        return { valid: false, errors };
      }

      // Charting engine
      class ChartEngine {
        constructor(canvas) {
          this.canvas = canvas;
          this.ctx = canvas.getContext("2d");
          this.dpr = window.devicePixelRatio || 1;
          this.margin = { left: 60, right: 20, top: 20, bottom: 40 };
          this.animationProgress = 1;
          this.animationFrame = null;
          this.hoverX = null;
          this.hoverY = null;
          this.tooltip = null;
          this.setupEvents();
        }

        setupEvents() {
          this.canvas.addEventListener("mousemove", (e) => {
            const rect = this.canvas.getBoundingClientRect();
            this.hoverX = e.clientX - rect.left;
            this.hoverY = e.clientY - rect.top;
            this.render();
          });
          this.canvas.addEventListener("mouseleave", () => {
            this.hoverX = null;
            this.hoverY = null;
            this.render();
          });
        }

        resize() {
          const rect = this.canvas.parentElement
            .getBoundingClientRect();
          this.width = rect.width;
          this.height = rect.height;
          this.canvas.width = this.width * this.dpr;
          this.canvas.height = this.height * this.dpr;
          this.canvas.style.width = this.width + "px";
          this.canvas.style.height = this.height + "px";
          this.ctx.scale(this.dpr, this.dpr);
        }

        getThemeColors() {
          const dark = document.documentElement.classList.contains(
            "dark",
          );
          return {
            bg: dark ? "#1E293B" : "#FFFFFF",
            grid: dark ? "rgba(255,255,255,0.06)" : "rgba(0,0,0,0.06)",
            axis: dark ? "rgba(255,255,255,0.15)" : "rgba(0,0,0,0.15)",
            text: dark ? "#94A3B8" : "#64748B",
            bandAlpha: dark ? 0.15 : 0.12,
          };
        }

        niceNum(range, round) {
          const exp = Math.floor(Math.log10(range));
          const frac = range / Math.pow(10, exp);
          let nice;
          if (round) {
            if (frac < 1.5) nice = 1;
            else if (frac < 3) nice = 2;
            else if (frac < 7) nice = 5;
            else nice = 10;
          } else {
            if (frac <= 1) nice = 1;
            else if (frac <= 2) nice = 2;
            else if (frac <= 5) nice = 5;
            else nice = 10;
          }
          return nice * Math.pow(10, exp);
        }

        getTicks(min, max, count = 6) {
          const range = this.niceNum(max - min, false);
          const spacing = this.niceNum(range / (count - 1), true);
          const niceMin = Math.floor(min / spacing) * spacing;
          const niceMax = Math.ceil(max / spacing) * spacing;
          const ticks = [];
          for (
            let v = niceMin;
            v <= niceMax + spacing * 0.5;
            v += spacing
          ) {
            ticks.push(v);
          }
          return ticks;
        }

        formatNum(n) {
          if (Math.abs(n) >= 1000) return n.toExponential(2);
          if (Math.abs(n) < 0.01 && n !== 0) return n.toExponential(2);
          return n.toPrecision(4).replace(/\.?0+$/, "");
        }

        render() {
          if (!state.predictions) return;
          const { ctx, width, height, margin } = this;
          const colors = this.getThemeColors();
          const dim = state.selectedDim;
          const data = state.predictions;

          const predictions = data.predictions.map((p) => p[dim]);
          const lower = data.lowerBounds.map((p) => p[dim]);
          const upper = data.upperBounds.map((p) => p[dim]);

          ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);
          ctx.fillStyle = colors.bg;
          ctx.fillRect(0, 0, width, height);
          ctx.translate(0.5, 0.5);

          const chartW = width - margin.left - margin.right;
          const chartH = height - margin.top - margin.bottom;

          const allVals = [...predictions, ...lower, ...upper];
          let yMin = Math.min(...allVals);
          let yMax = Math.max(...allVals);
          const yPad = (yMax - yMin) * 0.1 || 1;
          yMin -= yPad;
          yMax += yPad;

          const xScale = (i) =>
            margin.left + (i / (predictions.length - 1)) * chartW;
          const yScale = (v) =>
            margin.top + chartH - ((v - yMin) / (yMax - yMin)) * chartH;

          // Grid
          ctx.strokeStyle = colors.grid;
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          const yTicks = this.getTicks(yMin, yMax, 6);
          for (const tick of yTicks) {
            const y = yScale(tick);
            ctx.beginPath();
            ctx.moveTo(margin.left, y);
            ctx.lineTo(width - margin.right, y);
            ctx.stroke();
          }
          ctx.setLineDash([]);

          // Axis lines
          ctx.strokeStyle = colors.axis;
          ctx.beginPath();
          ctx.moveTo(margin.left, margin.top);
          ctx.lineTo(margin.left, height - margin.bottom);
          ctx.lineTo(width - margin.right, height - margin.bottom);
          ctx.stroke();

          // Axis labels
          ctx.fillStyle = colors.text;
          ctx.font = "11px system-ui, -apple-system, sans-serif";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          for (const tick of yTicks) {
            ctx.fillText(
              this.formatNum(tick),
              margin.left - 8,
              yScale(tick),
            );
          }

          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          const xStep = Math.max(1, Math.ceil(predictions.length / 10));
          for (let i = 0; i < predictions.length; i += xStep) {
            ctx.fillText(
              String(i),
              xScale(i),
              height - margin.bottom + 8,
            );
          }

          const color = COLORS[dim % COLORS.length];
          const progress = this.animationProgress;
          const visibleLen = Math.ceil(predictions.length * progress);

          // Confidence band
          ctx.beginPath();
          for (let i = 0; i < visibleLen; i++) {
            const x = xScale(i);
            const y = yScale(upper[i]);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          for (let i = visibleLen - 1; i >= 0; i--) {
            ctx.lineTo(xScale(i), yScale(lower[i]));
          }
          ctx.closePath();
          const grad = ctx.createLinearGradient(
            0,
            margin.top,
            0,
            height - margin.bottom,
          );
          grad.addColorStop(0, color + "26");
          grad.addColorStop(1, color + "0D");
          ctx.fillStyle = grad;
          ctx.fill();

          // Band borders
          ctx.strokeStyle = color + "66";
          ctx.lineWidth = 1;
          ctx.setLineDash([3, 3]);
          ctx.beginPath();
          for (let i = 0; i < visibleLen; i++) {
            const x = xScale(i);
            if (i === 0) ctx.moveTo(x, yScale(upper[i]));
            else ctx.lineTo(x, yScale(upper[i]));
          }
          ctx.stroke();
          ctx.beginPath();
          for (let i = 0; i < visibleLen; i++) {
            const x = xScale(i);
            if (i === 0) ctx.moveTo(x, yScale(lower[i]));
            else ctx.lineTo(x, yScale(lower[i]));
          }
          ctx.stroke();
          ctx.setLineDash([]);

          // Glow
          ctx.strokeStyle = color + "26";
          ctx.lineWidth = 6;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          for (let i = 0; i < visibleLen; i++) {
            const x = xScale(i);
            const y = yScale(predictions[i]);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Main line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          for (let i = 0; i < visibleLen; i++) {
            const x = xScale(i);
            const y = yScale(predictions[i]);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // Hover
          if (
            this.hoverX !== null && this.hoverX >= margin.left &&
            this.hoverX <= width - margin.right
          ) {
            const idx = Math.round(
              (this.hoverX - margin.left) / chartW *
                (predictions.length - 1),
            );
            if (idx >= 0 && idx < predictions.length) {
              const px = xScale(idx);
              const py = yScale(predictions[idx]);

              // Crosshair
              ctx.strokeStyle = colors.text + "80";
              ctx.lineWidth = 1;
              ctx.setLineDash([4, 4]);
              ctx.beginPath();
              ctx.moveTo(px, margin.top);
              ctx.lineTo(px, height - margin.bottom);
              ctx.moveTo(margin.left, py);
              ctx.lineTo(px, py);
              ctx.stroke();
              ctx.setLineDash([]);

              // Point
              ctx.fillStyle = color + "4D";
              ctx.beginPath();
              ctx.arc(px, py, 8, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = color;
              ctx.beginPath();
              ctx.arc(px, py, 5, 0, Math.PI * 2);
              ctx.fill();

              // Tooltip
              this.drawTooltip(
                px,
                py,
                idx,
                predictions[idx],
                lower[idx],
                upper[idx],
                colors,
              );
            }
          }
        }

        drawTooltip(x, y, step, pred, lower, upper, colors) {
          const { ctx, width, height } = this;
          const text = [
            `Step: ${step}`,
            `Predicted: ${this.formatNum(pred)}`,
            `Lower: ${this.formatNum(lower)}`,
            `Upper: ${this.formatNum(upper)}`,
            `Band: ${this.formatNum(upper - lower)}`,
          ];

          ctx.font = "12px system-ui, -apple-system, sans-serif";
          const maxW = Math.max(
            ...text.map((t) => ctx.measureText(t).width),
          );
          const pad = 12;
          const lineH = 18;
          const boxW = maxW + pad * 2;
          const boxH = text.length * lineH + pad * 2;

          let tx = x + 15;
          let ty = y - boxH / 2;
          if (tx + boxW > width - 10) tx = x - boxW - 15;
          if (ty < 10) ty = 10;
          if (ty + boxH > height - 10) ty = height - boxH - 10;

          const dark = document.documentElement.classList.contains(
            "dark",
          );
          ctx.fillStyle = dark ? "#334155" : "#FFFFFF";
          ctx.shadowColor = "rgba(0,0,0,0.15)";
          ctx.shadowBlur = 20;
          ctx.shadowOffsetY = 4;
          ctx.beginPath();
          ctx.roundRect(tx, ty, boxW, boxH, 8);
          ctx.fill();
          ctx.shadowColor = "transparent";

          ctx.fillStyle = colors.text;
          ctx.textAlign = "left";
          ctx.textBaseline = "top";
          text.forEach((t, i) => {
            ctx.fillText(t, tx + pad, ty + pad + i * lineH);
          });
        }

        animate() {
          if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
          }
          this.animationProgress = 0;
          const start = performance.now();
          const duration = 600;
          const step = (now) => {
            const elapsed = now - start;
            this.animationProgress = Math.min(
              1,
              this.easeOutCubic(elapsed / duration),
            );
            this.render();
            if (this.animationProgress < 1) {
              this.animationFrame = requestAnimationFrame(step);
            }
          };
          this.animationFrame = requestAnimationFrame(step);
        }

        easeOutCubic(t) {
          return 1 - Math.pow(1 - t, 3);
        }
      }

      let focusChart = null;

      function initCharts() {
        const focusCanvas = $("#focusCanvas");
        focusChart = new ChartEngine(focusCanvas);

        const observer = new ResizeObserver(() => {
          focusChart.resize();
          focusChart.render();
          renderCurrentView();
        });
        observer.observe($("#chartContainer"));
      }

      function renderCurrentView() {
        const mode = state.viewMode;
        $("#focusCanvas").classList.toggle("hidden", mode !== "focus");
        $("#gridView").classList.toggle("hidden", mode !== "grid");
        $("#heatmapView").classList.toggle(
          "hidden",
          mode !== "heatmap",
        );
        $("#uncertaintyView").classList.toggle(
          "hidden",
          mode !== "uncertainty",
        );
        $("#snapshotView").classList.toggle(
          "hidden",
          mode !== "snapshot",
        );

        if (!state.predictions) return;

        switch (mode) {
          case "focus":
            focusChart.resize();
            focusChart.animate();
            break;
          case "grid":
            renderGridView();
            break;
          case "heatmap":
            renderHeatmap();
            break;
          case "uncertainty":
            renderUncertainty();
            break;
          case "snapshot":
            renderSnapshot();
            break;
        }

        updatePredictionStats();
      }

      function renderGridView() {
        const container = $("#gridContainer");
        const nDims = state.nTargets || 1;
        const data = state.predictions;

        container.innerHTML = "";

        for (let d = 0; d < nDims; d++) {
          const div = document.createElement("div");
          div.className =
            "bg-slate-50 dark:bg-slate-700/50 rounded-xl p-3 cursor-pointer hover:ring-2 hover:ring-primary-500 transition-all";
          div.onclick = () => {
            state.selectedDim = d;
            state.viewMode = "focus";
            $("#viewModeSelect").value = "focus";
            $("#dimSelect").value = d;
            renderCurrentView();
          };

          const canvas = document.createElement("canvas");
          canvas.width = 280;
          canvas.height = 120;
          canvas.className = "w-full rounded";
          div.appendChild(canvas);

          const label = document.createElement("div");
          label.className = "mt-2 flex items-center justify-between";
          label.innerHTML =
            `<span class="text-sm font-medium">Dim ${d}</span><span class="text-xs px-2 py-0.5 rounded-full" style="background:${
              COLORS[d % COLORS.length]
            }22;color:${COLORS[d % COLORS.length]}">${
              data.predictions[data.predictions.length - 1][d].toFixed(
                2,
              )
            }</span>`;
          div.appendChild(label);

          container.appendChild(div);

          // Draw mini chart
          const ctx = canvas.getContext("2d");
          const preds = data.predictions.map((p) => p[d]);
          const lower = data.lowerBounds.map((p) => p[d]);
          const upper = data.upperBounds.map((p) => p[d]);
          const allVals = [...preds, ...lower, ...upper];
          const yMin = Math.min(...allVals);
          const yMax = Math.max(...allVals);
          const range = yMax - yMin || 1;

          const w = 280, h = 120;
          const color = COLORS[d % COLORS.length];

          const dark = document.documentElement.classList.contains(
            "dark",
          );
          ctx.fillStyle = dark ? "#334155" : "#F8FAFC";
          ctx.fillRect(0, 0, w, h);

          // Band
          ctx.beginPath();
          for (let i = 0; i < preds.length; i++) {
            const x = (i / (preds.length - 1)) * w;
            const y = h - ((upper[i] - yMin) / range) * h;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          for (let i = preds.length - 1; i >= 0; i--) {
            const x = (i / (preds.length - 1)) * w;
            const y = h - ((lower[i] - yMin) / range) * h;
            ctx.lineTo(x, y);
          }
          ctx.closePath();
          ctx.fillStyle = color + "26";
          ctx.fill();

          // Line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < preds.length; i++) {
            const x = (i / (preds.length - 1)) * w;
            const y = h - ((preds[i] - yMin) / range) * h;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        }
      }

      function renderHeatmap() {
        const canvas = $("#heatmapCanvas");
        const ctx = canvas.getContext("2d");
        const data = state.predictions;
        const nDims = state.nTargets;
        const nSteps = data.predictions.length;

        const container = canvas.parentElement;
        const w = container.clientWidth;
        const h = container.clientHeight;
        canvas.width = w;
        canvas.height = h;

        const dark = document.documentElement.classList.contains(
          "dark",
        );
        ctx.fillStyle = dark ? "#1E293B" : "#FFFFFF";
        ctx.fillRect(0, 0, w, h);

        const marginL = 60, marginT = 30, marginR = 80, marginB = 40;
        const chartW = w - marginL - marginR;
        const chartH = h - marginT - marginB;
        const cellW = chartW / nSteps;
        const cellH = chartH / nDims;

        // Find range
        let minVal = Infinity, maxVal = -Infinity;
        for (const p of data.predictions) {
          for (const v of p) {
            if (v < minVal) minVal = v;
            if (v > maxVal) maxVal = v;
          }
        }
        const range = maxVal - minVal || 1;

        // Draw cells
        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < nSteps; s++) {
            const val = data.predictions[s][d];
            const norm = (val - minVal) / range;
            const hue = dark ? (200 + norm * 60) : (240 - norm * 60);
            const sat = dark ? (70 + norm * 30) : (60 + norm * 30);
            const light = dark ? (20 + norm * 50) : (95 - norm * 45);
            ctx.fillStyle = `hsl(${hue}, ${sat}%, ${light}%)`;
            ctx.fillRect(
              marginL + s * cellW,
              marginT + d * cellH,
              cellW - 1,
              cellH - 1,
            );
          }
        }

        // Labels
        ctx.fillStyle = dark ? "#94A3B8" : "#64748B";
        ctx.font = "10px system-ui";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (let d = 0; d < nDims; d++) {
          ctx.fillText(
            `D${d}`,
            marginL - 5,
            marginT + d * cellH + cellH / 2,
          );
        }
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        const xStep = Math.max(1, Math.ceil(nSteps / 15));
        for (let s = 0; s < nSteps; s += xStep) {
          ctx.fillText(
            String(s),
            marginL + s * cellW + cellW / 2,
            h - marginB + 5,
          );
        }

        // Legend
        const legW = 15, legH = chartH;
        const legX = w - marginR + 20;
        const grad = ctx.createLinearGradient(
          0,
          marginT,
          0,
          marginT + legH,
        );
        if (dark) {
          grad.addColorStop(0, "hsl(260, 100%, 70%)");
          grad.addColorStop(1, "hsl(200, 70%, 20%)");
        } else {
          grad.addColorStop(0, "hsl(180, 90%, 50%)");
          grad.addColorStop(1, "hsl(240, 60%, 95%)");
        }
        ctx.fillStyle = grad;
        ctx.fillRect(legX, marginT, legW, legH);

        ctx.fillStyle = dark ? "#94A3B8" : "#64748B";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText(maxVal.toFixed(2), legX + legW + 5, marginT);
        ctx.textBaseline = "bottom";
        ctx.fillText(
          minVal.toFixed(2),
          legX + legW + 5,
          marginT + legH,
        );
      }

      function renderUncertainty() {
        const canvas = $("#uncertaintyCanvas");
        const ctx = canvas.getContext("2d");
        const data = state.predictions;

        const container = canvas.parentElement;
        const w = container.clientWidth;
        const h = container.clientHeight;
        canvas.width = w;
        canvas.height = h;

        const dark = document.documentElement.classList.contains(
          "dark",
        );
        ctx.fillStyle = dark ? "#1E293B" : "#FFFFFF";
        ctx.fillRect(0, 0, w, h);

        const margin = { left: 60, right: 20, top: 60, bottom: 40 };
        const chartW = w - margin.left - margin.right;
        const chartH = h - margin.top - margin.bottom;

        const dim = state.selectedDim;
        const bandWidths = data.predictions.map((_, i) =>
          data.upperBounds[i][dim] - data.lowerBounds[i][dim]
        );
        const maxBand = Math.max(...bandWidths);
        const minBand = Math.min(...bandWidths);
        const avgBand = bandWidths.reduce((a, b) => a + b, 0) /
          bandWidths.length;

        // Stats
        ctx.fillStyle = dark ? "#94A3B8" : "#64748B";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(
          `Uncertainty Analysis - Dimension ${dim}`,
          margin.left,
          25,
        );
        ctx.font = "12px system-ui";
        ctx.fillText(
          `Avg: ${avgBand.toFixed(4)} | Max: ${
            maxBand.toFixed(4)
          } | Min: ${minBand.toFixed(4)}`,
          margin.left,
          45,
        );

        // Draw area
        const yMax = maxBand * 1.1 || 1;
        ctx.beginPath();
        for (let i = 0; i < bandWidths.length; i++) {
          const x = margin.left +
            (i / (bandWidths.length - 1)) * chartW;
          const y = margin.top + chartH -
            (bandWidths[i] / yMax) * chartH;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.lineTo(margin.left + chartW, margin.top + chartH);
        ctx.lineTo(margin.left, margin.top + chartH);
        ctx.closePath();

        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          margin.top + chartH,
        );
        grad.addColorStop(0, "#EF444466");
        grad.addColorStop(0.5, "#F59E0B66");
        grad.addColorStop(1, "#10B98166");
        ctx.fillStyle = grad;
        ctx.fill();

        ctx.strokeStyle = "#F59E0B";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < bandWidths.length; i++) {
          const x = margin.left +
            (i / (bandWidths.length - 1)) * chartW;
          const y = margin.top + chartH -
            (bandWidths[i] / yMax) * chartH;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Confidence score
        const conf = data.confidence ?? 0.5;
        const confX = w - 100, confY = 30;
        ctx.fillStyle = dark ? "#334155" : "#F1F5F9";
        ctx.beginPath();
        ctx.arc(confX, confY, 25, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = conf > 0.7
          ? "#10B981"
          : conf > 0.4
          ? "#F59E0B"
          : "#EF4444";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(
          confX,
          confY,
          25,
          -Math.PI / 2,
          -Math.PI / 2 + Math.PI * 2 * conf,
        );
        ctx.stroke();
        ctx.fillStyle = dark ? "#E2E8F0" : "#1E293B";
        ctx.font = "bold 12px system-ui";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText((conf * 100).toFixed(0) + "%", confX, confY);
      }

      function renderSnapshot() {
        const container = $("#snapshotBars");
        const slider = $("#snapshotStep");
        const stepVal = $("#snapshotStepValue");
        const data = state.predictions;

        slider.max = data.predictions.length - 1;
        const step = parseInt(slider.value);
        stepVal.textContent = step;

        const preds = data.predictions[step];
        const lower = data.lowerBounds[step];
        const upper = data.upperBounds[step];

        const maxAbs = Math.max(...preds.map(Math.abs), 0.001);
        const dark = document.documentElement.classList.contains(
          "dark",
        );

        container.innerHTML = preds.map((v, d) => {
          const pct = Math.abs(v) / maxAbs * 100;
          const err = (upper[d] - lower[d]) / 2;
          const color = COLORS[d % COLORS.length];
          return `
      <div class="flex items-center gap-3 mb-2">
        <span class="w-12 text-xs text-slate-500">D${d}</span>
        <div class="flex-1 h-6 bg-slate-100 dark:bg-slate-700 rounded-full relative overflow-hidden">
          <div class="h-full rounded-full transition-all" style="width:${pct}%;background:${color}"></div>
          <div class="absolute inset-y-0 flex items-center" style="left:${
            Math.max(0, pct - 5)
          }%">
            <div class="w-px h-4 bg-slate-800 dark:bg-white opacity-50"></div>
          </div>
        </div>
        <span class="w-24 text-xs text-right font-mono">${
            v.toFixed(3)
          } Â±${err.toFixed(3)}</span>
      </div>
    `;
        }).join("");
      }

      function updatePredictionStats() {
        if (!state.predictions) {
          $("#predictionStats").classList.add("hidden");
          return;
        }
        $("#predictionStats").classList.remove("hidden");
        const data = state.predictions;
        const dim = state.selectedDim;
        const preds = data.predictions.map((p) => p[dim]);
        const bands = preds.map((_, i) =>
          data.upperBounds[i][dim] - data.lowerBounds[i][dim]
        );

        $("#statSteps").textContent = preds.length;
        $("#statMin").textContent = Math.min(...preds).toFixed(4);
        $("#statMax").textContent = Math.max(...preds).toFixed(4);
        $("#statUncertainty").textContent =
          (bands.reduce((a, b) => a + b, 0) / bands.length).toFixed(4);
        $("#metricConfidence").textContent =
          ((data.confidence ?? 0.5) * 100).toFixed(0) + "%";
      }

      // Random data generation
      function seededRandom(seed) {
        let s = seed;
        return () => {
          s = (s * 1103515245 + 12345) & 0x7fffffff;
          return s / 0x7fffffff;
        };
      }

      function generateTestData(params) {
        const {
          testSeed,
          testSamples,
          testFeatures,
          testTargets,
          testNoise,
          testOutlierRate,
          testDifficulty,
        } = params;
        const rng = seededRandom(parseInt(testSeed));
        const samples = [];

        const funcs = [];
        for (let t = 0; t < testTargets; t++) {
          const coeffs = Array.from(
            { length: testFeatures },
            () => (rng() - 0.5) * 2,
          );
          funcs.push({
            coeffs,
            phase: rng() * Math.PI * 2,
            freq: 0.5 + rng() * 2,
          });
        }

        for (let i = 0; i < testSamples; i++) {
          const x = Array.from(
            { length: testFeatures },
            () => rng() * 2 - 1,
          );
          const y = funcs.map((f, t) => {
            let val = 0;
            for (let j = 0; j < testFeatures; j++) {
              val += f.coeffs[j] * x[j];
              if (testDifficulty !== "easy") {
                val += 0.3 * Math.sin(f.freq * x[j] + f.phase);
              }
              if (testDifficulty === "hard") {
                val += 0.2 * x[j] * x[(j + 1) % testFeatures];
              }
            }
            val += (rng() - 0.5) * 2 * testNoise;
            if (rng() < testOutlierRate) {
              val += (rng() - 0.5) * 10;
            }
            return val;
          });
          samples.push({ x, y });
        }

        return {
          samples,
          nFeatures: testFeatures,
          nTargets: testTargets,
        };
      }

      // Event handlers
      async function handleCreateModel() {
        const config = getFormData($("#configForm"));
        try {
          showLoading("Creating model...");
          await sendWorker("create", config);
          state.modelReady = true;
          state.config = config;
          state.sampleCount = 0;
          state.nFeatures = null;
          state.nTargets = null;
          state.predictions = null;
          closeModal("#configModal");
          showToast("Model created successfully", "success");
          addLog(
            "Model Created",
            `Reservoir: ${config.reservoirSize}, Seq: ${config.maxSequenceLength}`,
            "success",
          );
          updateUI();
        } catch (err) {
          showToast(err.message, "error");
          addLog("Create Failed", err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleTrainBatch(data) {
        try {
          showLoading("Training...", true);
          const result = await sendWorkerCancellable(
            "trainBatch",
            data,
          );
          if (result.cancelled) {
            showToast("Training cancelled", "warning");
            addLog(
              "Training Cancelled",
              `Processed ${result.processed || 0} samples`,
              "warning",
            );
          } else {
            state.sampleCount = result.sampleCount;
            state.nFeatures = result.nFeatures;
            state.nTargets = result.nTargets;
            showToast(
              `Trained on ${
                data.samples?.length || data.xCoordinates?.length
              } samples`,
              "success",
            );
            addLog(
              "Training Complete",
              `${state.sampleCount} total samples`,
              "success",
            );
          }
          updateUI();
        } catch (err) {
          showToast(err.message, "error");
          addLog("Training Failed", err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handlePredict() {
        const futureSteps = parseInt($("#futureStepsInput").value) ||
          20;
        try {
          showLoading("Predicting...");
          const result = await sendWorker("predict", { futureSteps });
          state.predictions = result;
          showToast(`Predicted ${futureSteps} steps`, "success");
          addLog(
            "Prediction",
            `${futureSteps} steps, confidence: ${
              ((result.confidence ?? 0.5) * 100).toFixed(1)
            }%`,
            "success",
          );
          renderCurrentView();
        } catch (err) {
          showToast(err.message, "error");
          addLog("Prediction Failed", err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleRandomTest() {
        const params = getFormData($("#randomTestForm"));
        closeModal("#randomTestModal");

        try {
          showLoading("Generating data...");
          const data = generateTestData(params);

          // Create model with start preset
          showLoading("Creating model...");
          await sendWorker("create", PRESETS.start);
          state.modelReady = true;
          state.config = { ...PRESETS.start };

          // Train
          showLoading("Training...", true);
          const result = await sendWorkerCancellable(
            "trainBatch",
            data,
          );
          if (result.cancelled) {
            showToast("Test cancelled", "warning");
            return;
          }
          state.sampleCount = result.sampleCount;
          state.nFeatures = result.nFeatures;
          state.nTargets = result.nTargets;

          // Predict
          showLoading("Predicting...");
          const pred = await sendWorker("predict", { futureSteps: 30 });
          state.predictions = pred;

          showToast("Random test complete!", "success");
          addLog(
            "Random Test",
            `${data.samples.length} samples, ${data.nFeatures} features, ${data.nTargets} targets`,
            "success",
          );

          state.viewMode = "focus";
          $("#viewModeSelect").value = "focus";
          updateUI();
          renderCurrentView();
        } catch (err) {
          showToast(err.message, "error");
          addLog("Random Test Failed", err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleSaveFile() {
        try {
          showLoading("Saving...");
          const data = await sendWorker("save");
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-model-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showToast("Model saved to file", "success");
          addLog("Save to File", "Model exported", "success");
        } catch (err) {
          showToast(err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleSaveLocal() {
        try {
          showLoading("Saving...");
          const data = await sendWorker("save");
          localStorage.setItem("esn_model", JSON.stringify(data));
          showToast("Model saved to browser", "success");
          addLog("Save to Browser", "Model stored locally", "success");
          checkLocalStorage();
        } catch (err) {
          showToast(err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleLoadFile(file) {
        try {
          showLoading("Loading...");
          const text = await file.text();
          const data = JSON.parse(text);
          const result = await sendWorker("load", data);
          state.modelReady = true;
          state.nFeatures = result.nFeatures;
          state.nTargets = result.nTargets;
          state.sampleCount = result.sampleCount;
          state.config = result.config || {};
          state.predictions = null;
          closeModal("#saveLoadModal");
          showToast("Model loaded from file", "success");
          addLog(
            "Load from File",
            `${state.sampleCount} samples, ${state.nFeatures} features`,
            "success",
          );
          updateUI();
        } catch (err) {
          showToast("Failed to load: " + err.message, "error");
          addLog("Load Failed", err.message, "error");
        } finally {
          hideLoading();
        }
      }

      async function handleLoadLocal() {
        try {
          showLoading("Loading...");
          const saved = localStorage.getItem("esn_model");
          if (!saved) throw new Error("No saved model found");
          const data = JSON.parse(saved);
          const result = await sendWorker("load", data);
          state.modelReady = true;
          state.nFeatures = result.nFeatures;
          state.nTargets = result.nTargets;
          state.sampleCount = result.sampleCount;
          state.config = result.config || {};
          state.predictions = null;
          closeModal("#saveLoadModal");
          showToast("Model loaded from browser", "success");
          addLog(
            "Load from Browser",
            `${state.sampleCount} samples`,
            "success",
          );
          updateUI();
        } catch (err) {
          showToast("Failed to load: " + err.message, "error");
        } finally {
          hideLoading();
        }
      }

      // Initialize
      async function init() {
        // Theme
        const savedTheme = localStorage.getItem("theme");
        if (
          savedTheme === "dark" ||
          (!savedTheme &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        }

        // Worker
        initWorker();
        try {
          showLoading("Initializing...");
          await sendWorker("init", { url: state.moduleUrl });
          addLog(
            "Worker Ready",
            "ESNRegression module loaded",
            "success",
          );
        } catch (err) {
          showToast("Failed to load module: " + err.message, "error");
          addLog("Init Failed", err.message, "error");
        } finally {
          hideLoading();
        }

        initCharts();
        updateUI();
        renderLogs();

        // Event listeners
        $("#themeToggle").onclick = () => {
          document.documentElement.classList.toggle("dark");
          localStorage.setItem(
            "theme",
            document.documentElement.classList.contains("dark")
              ? "dark"
              : "light",
          );
          renderCurrentView();
        };

        $("#menuBtn").onclick = () =>
          $("#mobileMenu").classList.remove("hidden");
        $("#desktopMenuBtn").onclick = () =>
          $("#sidebar").classList.toggle("hidden");
        $$("[data-close-menu]").forEach((el) =>
          el.onclick = closeMobileMenu
        );

        $$("[data-action]").forEach((el) => {
          el.onclick = () => {
            const action = el.dataset.action;
            switch (action) {
              case "config":
                openModal("#configModal");
                break;
              case "upload":
                openModal("#uploadModal");
                break;
              case "insert":
                openModal("#insertModal");
                break;
              case "saveload":
                openModal("#saveLoadModal");
                break;
              case "randomtest":
                openModal("#randomTestModal");
                break;
              case "settings":
                openModal("#settingsModal");
                break;
              case "quickstart":
                handleRandomTest();
                break;
            }
          };
        });

        $$("[data-close-modal]").forEach((el) => {
          el.onclick = (e) => {
            if (e.target === el) {
              el.closest('[role="dialog"]').classList.add("hidden");
            }
          };
        });

        $$("[data-preset]").forEach((el) => {
          el.onclick = () => {
            const preset = PRESETS[el.dataset.preset];
            if (preset) setFormData($("#configForm"), preset);
          };
        });

        $("#createModelBtn").onclick = handleCreateModel;
        $("#resetDefaultsBtn").onclick = () =>
          setFormData($("#configForm"), PRESETS.start);
        $("#resetEverythingBtn").onclick = () => {
          if (
            confirm(
              "This will clear all data, model, and localStorage. Continue?",
            )
          ) {
            localStorage.clear();
            location.reload();
          }
        };

        // Upload
        const dropZone = $("#dropZone");
        const fileInput = $("#fileInput");
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => {
          e.preventDefault();
          dropZone.classList.add("border-primary-500");
        };
        dropZone.ondragleave = () =>
          dropZone.classList.remove("border-primary-500");
        dropZone.ondrop = (e) => {
          e.preventDefault();
          dropZone.classList.remove("border-primary-500");
          const file = e.dataTransfer.files[0];
          if (file) handleUploadFile(file);
        };
        fileInput.onchange = () => {
          if (fileInput.files[0]) handleUploadFile(fileInput.files[0]);
        };

        let uploadData = null;
        async function handleUploadFile(file) {
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            const validation = validateDataset(data);

            const preview = $("#uploadPreview");
            const content = $("#previewContent");
            const applyBtn = $("#uploadApplyBtn");

            if (validation.valid) {
              preview.classList.remove("hidden");
              content.innerHTML = `
          <p class="text-emerald-600 dark:text-emerald-400 font-medium mb-2">âœ“ Valid dataset</p>
          <p>Samples: ${validation.count}</p>
          <p>Features: ${validation.nFeatures}</p>
          <p>Targets: ${validation.nTargets}</p>
        `;
              uploadData = data;
              applyBtn.disabled = false;
            } else {
              preview.classList.remove("hidden");
              content.innerHTML = `
          <p class="text-red-600 dark:text-red-400 font-medium mb-2">âœ— Validation failed</p>
          <ul class="list-disc list-inside text-sm">${
                validation.errors.slice(0, 5).map((e) =>
                  `<li>${e}</li>`
                ).join("")
              }</ul>
        `;
              uploadData = null;
              applyBtn.disabled = true;
            }
          } catch (err) {
            showToast("Failed to parse JSON: " + err.message, "error");
          }
        }

        $("#jsonInput").oninput = () => {
          const text = $("#jsonInput").value.trim();
          if (!text) return;
          try {
            const data = JSON.parse(text);
            handleUploadFile(new Blob([text]));
          } catch {}
        };

        $("#uploadApplyBtn").onclick = async () => {
          if (!uploadData) return;
          if (!state.modelReady) {
            showToast("Please create a model first", "warning");
            return;
          }
          closeModal("#uploadModal");
          await handleTrainBatch(uploadData);
          uploadData = null;
          $("#uploadPreview").classList.add("hidden");
          $("#uploadApplyBtn").disabled = true;
          $("#jsonInput").value = "";
        };

        // Insert
        $("#insertInput").oninput = () => {
          const text = $("#insertInput").value.trim();
          const validation = $("#insertValidation");
          const applyBtn = $("#insertApplyBtn");
          if (!text) {
            validation.innerHTML = "";
            applyBtn.disabled = true;
            return;
          }
          try {
            const data = JSON.parse(text);
            const result = validateDataset(data);
            if (result.valid) {
              validation.innerHTML =
                `<p class="text-emerald-600">âœ“ Valid: ${result.count} sample(s), ${result.nFeatures} features, ${result.nTargets} targets</p>`;
              applyBtn.disabled = false;
            } else {
              validation.innerHTML = `<p class="text-red-600">âœ— ${
                result.errors[0]
              }</p>`;
              applyBtn.disabled = true;
            }
          } catch (err) {
            validation.innerHTML =
              `<p class="text-red-600">âœ— Invalid JSON: ${err.message}</p>`;
            applyBtn.disabled = true;
          }
        };

        $("#genTemplateBtn").onclick = () => {
          const nF = state.nFeatures || 3;
          const nT = state.nTargets || 2;
          const template = {
            x: Array(nF).fill(0),
            y: Array(nT).fill(0),
          };
          $("#insertInput").value = JSON.stringify(template, null, 2);
          $("#insertInput").dispatchEvent(new Event("input"));
        };

        $("#insertApplyBtn").onclick = async () => {
          const text = $("#insertInput").value.trim();
          if (!text || !state.modelReady) return;
          try {
            const data = JSON.parse(text);
            const samples = data.samples || (data.x ? [data] : []);
            showLoading("Inserting...");
            for (const s of samples) {
              const result = await sendWorker("trainSingle", s);
              state.sampleCount = result.sampleCount;
              state.nFeatures = result.nFeatures;
              state.nTargets = result.nTargets;
            }
            closeModal("#insertModal");
            showToast(
              `Inserted ${samples.length} sample(s)`,
              "success",
            );
            addLog(
              "Insert",
              `${samples.length} sample(s) added`,
              "success",
            );
            $("#insertInput").value = "";
            updateUI();
          } catch (err) {
            showToast(err.message, "error");
          } finally {
            hideLoading();
          }
        };

        // Save/Load
        $("#saveFileBtn").onclick = handleSaveFile;
        $("#saveLocalBtn").onclick = handleSaveLocal;
        $("#loadFileBtn").onclick = () => $("#loadFileInput").click();
        $("#loadFileInput").onchange = () => {
          if ($("#loadFileInput").files[0]) {
            handleLoadFile($("#loadFileInput").files[0]);
          }
        };
        $("#loadLocalBtn").onclick = handleLoadLocal;
        $("#clearLocalBtn").onclick = () => {
          if (confirm("Clear all browser storage?")) {
            localStorage.clear();
            showToast("Browser storage cleared", "success");
            checkLocalStorage();
          }
        };

        // Random test
        $("#runTestBtn").onclick = handleRandomTest;

        // Settings
        $("#moduleUrlInput").value = state.moduleUrl;
        $("#reinitWorkerBtn").onclick = async () => {
          state.moduleUrl = $("#moduleUrlInput").value;
          worker.terminate();
          initWorker();
          try {
            showLoading("Reinitializing...");
            await sendWorker("init", { url: state.moduleUrl });
            showToast("Worker reinitialized", "success");
            state.modelReady = false;
            state.predictions = null;
            updateUI();
          } catch (err) {
            showToast("Failed: " + err.message, "error");
          } finally {
            hideLoading();
          }
        };

        // Prediction
        const futureSlider = $("#futureStepsSlider");
        const futureInput = $("#futureStepsInput");
        futureSlider.oninput = () =>
          futureInput.value = futureSlider.value;
        futureInput.oninput = () =>
          futureSlider.value = futureInput.value;
        $("#predictBtn").onclick = handlePredict;
        $("#quickPredictBtn").onclick = handlePredict;

        // View controls
        $("#viewModeSelect").onchange = () => {
          state.viewMode = $("#viewModeSelect").value;
          renderCurrentView();
        };
        $("#dimSelect").onchange = () => {
          state.selectedDim = parseInt($("#dimSelect").value);
          renderCurrentView();
        };

        $("#snapshotStep").oninput = renderSnapshot;

        // Cancel
        $("#cancelBtn").onclick = cancelCurrent;

        // Log filter
        $("#logFilter").onchange = renderLogs;

        // Export
        $("#exportBtn").onclick = () => {
          if (!state.predictions) return;
          const canvas = state.viewMode === "focus"
            ? $("#focusCanvas")
            : state.viewMode === "heatmap"
            ? $("#heatmapCanvas")
            : state.viewMode === "uncertainty"
            ? $("#uncertaintyCanvas")
            : null;
          if (!canvas) return;
          const link = document.createElement("a");
          link.download = `esn-chart-${Date.now()}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
          showToast("Chart exported", "success");
        };

        // Zoom
        $("#zoomInBtn").onclick = () => {
          state.zoom = Math.min(state.zoom * 1.2, 5);
          $("#zoomLevel").textContent = Math.round(state.zoom * 100) +
            "%";
        };
        $("#zoomOutBtn").onclick = () => {
          state.zoom = Math.max(state.zoom / 1.2, 0.5);
          $("#zoomLevel").textContent = Math.round(state.zoom * 100) +
            "%";
        };
        $("#zoomResetBtn").onclick = () => {
          state.zoom = 1;
          $("#zoomLevel").textContent = "100%";
        };

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA"
          ) return;
          switch (e.key.toLowerCase()) {
            case "m":
              e.preventDefault();
              $("#mobileMenu").classList.toggle("hidden");
              break;
            case "c":
              e.preventDefault();
              openModal("#configModal");
              break;
            case "u":
              e.preventDefault();
              openModal("#uploadModal");
              break;
            case "p":
              if (state.modelReady && state.sampleCount > 0) {
                e.preventDefault();
                handlePredict();
              }
              break;
            case "escape":
              $$('[role="dialog"]:not(.hidden)').forEach((m) =>
                m.classList.add("hidden")
              );
              closeMobileMenu();
              break;
          }
        });
      }

      init();
    </script>
  </body>
</html>
