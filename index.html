<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              brand: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
              chart: {
                blue: "#3B82F6",
                emerald: "#10B981",
                amber: "#F59E0B",
                red: "#EF4444",
                violet: "#8B5CF6",
                pink: "#EC4899",
                cyan: "#06B6D4",
                lime: "#84CC16",
              },
            },
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-right": "slideRight 0.3s ease-out",
              "pulse-soft": "pulseSoft 2s ease-in-out infinite",
              "shimmer": "shimmer 1.5s ease-in-out infinite",
            },
          },
        },
      };
    </script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideRight {
        from {
          opacity: 0;
          transform: translateX(-100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes pulseSoft {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          transparent 25%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.3);
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: rgba(100, 116, 139, 0.5);
      }
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 116, 139, 0.3) transparent;
      }
      .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .chart-container {
        position: relative;
      }
      .tooltip-arrow::before {
        content: "";
        position: absolute;
        width: 8px;
        height: 8px;
        background: inherit;
        transform: rotate(45deg);
      }
      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.8);
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-300"
  >
    <div id="app" class="flex flex-col h-screen overflow-hidden">
      <!-- Header -->
      <header
        class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 z-40"
      >
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <button
              id="menuBtn"
              class="lg:hidden p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
              aria-label="Open menu"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <div>
                <h1 class="text-lg font-bold leading-tight">ESN Studio</h1>
                <p
                  class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block"
                >
                  Multivariate Regression
                </p>
              </div>
            </div>
          </div>

          <div
            id="statusChips"
            class="hidden md:flex items-center gap-2 flex-wrap"
          >
            <span
              id="modelChip"
              class="px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
            >No Model</span>
            <span
              id="dataChip"
              class="px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
            >No Data</span>
          </div>

          <div class="flex items-center gap-2">
            <button
              id="quickPredict"
              class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-ring"
              disabled
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Predict
            </button>
            <button
              id="themeToggle"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
              aria-label="Toggle theme"
            >
              <svg
                class="w-5 h-5 dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Menu -->
        <aside
          id="sidebar"
          class="fixed inset-y-0 left-0 z-50 w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 transform -translate-x-full lg:translate-x-0 lg:static lg:w-64 transition-transform duration-300 flex flex-col"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 lg:hidden"
          >
            <span class="font-semibold">Menu</span>
            <button
              id="closeSidebar"
              class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <nav class="flex-1 overflow-y-auto scrollbar-thin p-3 space-y-1">
            <div class="mb-4">
              <p
                class="px-3 py-2 text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider"
              >
                Model
              </p>
              <button
                data-action="openConfig"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <span>Create / Configure</span>
              </button>
              <button
                data-action="openSaveLoad"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                <span>Save / Load</span>
              </button>
            </div>

            <div class="mb-4">
              <p
                class="px-3 py-2 text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider"
              >
                Data
              </p>
              <button
                data-action="openUpload"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                <span>Upload Dataset</span>
              </button>
              <button
                data-action="openManualInsert"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  />
                </svg>
                <span>Manual Insert</span>
              </button>
            </div>

            <div class="mb-4">
              <p
                class="px-3 py-2 text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider"
              >
                Test
              </p>
              <button
                data-action="openRandomTest"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
                <span>Random Test</span>
              </button>
            </div>

            <div class="mb-4">
              <p
                class="px-3 py-2 text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider"
              >
                Advanced
              </p>
              <button
                data-action="openSettings"
                class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              >
                <svg
                  class="w-5 h-5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                  />
                </svg>
                <span>Settings</span>
              </button>
            </div>
          </nav>

          <div class="p-3 border-t border-slate-200 dark:border-slate-700">
            <div class="px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
              <p class="text-xs text-slate-500 dark:text-slate-400">
                Keyboard Shortcuts
              </p>
              <div class="mt-1 text-xs space-y-0.5">
                <p>
                  <kbd
                    class="px-1 py-0.5 bg-white dark:bg-slate-600 rounded text-[10px]"
                  >M</kbd> Menu
                </p>
                <p>
                  <kbd
                    class="px-1 py-0.5 bg-white dark:bg-slate-600 rounded text-[10px]"
                  >C</kbd> Config
                </p>
                <p>
                  <kbd
                    class="px-1 py-0.5 bg-white dark:bg-slate-600 rounded text-[10px]"
                  >P</kbd> Predict
                </p>
              </div>
            </div>
          </div>
        </aside>

        <!-- Sidebar Overlay -->
        <div
          id="sidebarOverlay"
          class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
          aria-hidden="true"
        >
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
          <div class="flex-1 overflow-y-auto scrollbar-thin p-4 lg:p-6">
            <!-- Onboarding (shown when no model) -->
            <div id="onboarding" class="max-w-2xl mx-auto py-12">
              <div class="text-center mb-8">
                <div
                  class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center shadow-lg shadow-brand-500/30"
                >
                  <svg
                    class="w-10 h-10 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold mb-2">
                  Welcome to ESN Regression Studio
                </h2>
                <p class="text-slate-600 dark:text-slate-400 max-w-md mx-auto">
                  Build powerful multivariate regression models with Echo State
                  Networks. Get started with one of the options below.
                </p>
              </div>

              <div class="grid sm:grid-cols-3 gap-4">
                <button
                  data-action="quickStart"
                  class="group p-6 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-brand-500 dark:hover:border-brand-500 transition-all hover:shadow-lg focus-ring text-left"
                >
                  <div
                    class="w-12 h-12 mb-4 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      />
                    </svg>
                  </div>
                  <h3 class="font-semibold mb-1">Start Here</h3>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Create a model with recommended settings
                  </p>
                </button>

                <button
                  data-action="openSaveLoad"
                  class="group p-6 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-brand-500 dark:hover:border-brand-500 transition-all hover:shadow-lg focus-ring text-left"
                >
                  <div
                    class="w-12 h-12 mb-4 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                      />
                    </svg>
                  </div>
                  <h3 class="font-semibold mb-1">Load Model</h3>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Resume from a saved model state
                  </p>
                </button>

                <button
                  data-action="openRandomTest"
                  class="group p-6 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-brand-500 dark:hover:border-brand-500 transition-all hover:shadow-lg focus-ring text-left"
                >
                  <div
                    class="w-12 h-12 mb-4 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center group-hover:scale-110 transition-transform"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                      />
                    </svg>
                  </div>
                  <h3 class="font-semibold mb-1">Random Test</h3>
                  <p class="text-sm text-slate-500 dark:text-slate-400">
                    Generate data and see it in action
                  </p>
                </button>
              </div>
            </div>

            <!-- Main Dashboard (shown when model exists) -->
            <div id="dashboard" class="hidden">
              <!-- Prediction Controls -->
              <div class="mb-6 flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                  <label class="text-sm font-medium">Future Steps:</label>
                  <input
                    type="number"
                    id="futureSteps"
                    min="1"
                    max="500"
                    value="20"
                    class="w-20 px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 focus-ring"
                  >
                  <button
                    id="runPredict"
                    class="flex items-center gap-1.5 px-4 py-1.5 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-ring"
                    disabled
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    Run Prediction
                  </button>
                </div>

                <div class="flex items-center gap-2 ml-auto">
                  <span class="text-sm text-slate-500">View:</span>
                  <div
                    class="flex rounded-lg border border-slate-300 dark:border-slate-600 overflow-hidden"
                  >
                    <button
                      data-view="grid"
                      class="view-btn px-3 py-1.5 text-sm bg-brand-600 text-white"
                      title="Grid View"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                        />
                      </svg>
                    </button>
                    <button
                      data-view="focus"
                      class="view-btn px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Focus View"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                        />
                      </svg>
                    </button>
                    <button
                      data-view="heatmap"
                      class="view-btn px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Heatmap"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"
                        />
                      </svg>
                    </button>
                    <button
                      data-view="uncertainty"
                      class="view-btn px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Uncertainty"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    </button>
                    <button
                      data-view="bars"
                      class="view-btn px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-700"
                      title="Bar Chart"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Chart Area -->
              <div
                id="chartArea"
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden"
              >
                <div
                  id="chartHeader"
                  class="flex items-center justify-between px-4 py-3 border-b border-slate-200 dark:border-slate-700"
                >
                  <div class="flex items-center gap-3">
                    <h3 id="chartTitle" class="font-semibold">Predictions</h3>
                    <select
                      id="dimSelector"
                      class="hidden text-sm border border-slate-300 dark:border-slate-600 rounded-lg px-2 py-1 bg-white dark:bg-slate-700 focus-ring"
                    >
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      id="zoomIn"
                      class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
                      title="Zoom In"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"
                        />
                      </svg>
                    </button>
                    <button
                      id="zoomOut"
                      class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
                      title="Zoom Out"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"
                        />
                      </svg>
                    </button>
                    <button
                      id="zoomReset"
                      class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
                      title="Reset Zoom"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        />
                      </svg>
                    </button>
                    <button
                      id="exportChart"
                      class="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
                      title="Export PNG"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
                <div
                  id="chartContainer"
                  class="chart-container relative"
                  style="height: 450px"
                >
                  <canvas id="mainChart"></canvas>
                  <div
                    id="chartTooltip"
                    class="absolute pointer-events-none opacity-0 transition-opacity duration-150 z-10"
                  >
                  </div>
                  <div
                    id="chartEmpty"
                    class="absolute inset-0 flex items-center justify-center"
                  >
                    <div class="text-center p-8">
                      <svg
                        class="w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1"
                          d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
                        />
                      </svg>
                      <p class="text-slate-500 dark:text-slate-400">
                        Run a prediction to visualize results
                      </p>
                    </div>
                  </div>
                  <div
                    id="chartLoading"
                    class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 hidden"
                  >
                    <div class="flex items-center gap-3">
                      <svg
                        class="w-6 h-6 animate-spin text-brand-600"
                        fill="none"
                        viewBox="0 0 24 24"
                      >
                        <circle
                          class="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          stroke-width="4"
                        />
                        <path
                          class="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        />
                      </svg>
                      <span class="text-slate-600 dark:text-slate-300"
                      >Processing...</span>
                    </div>
                  </div>
                </div>

                <!-- Stats Bar -->
                <div
                  id="statsBar"
                  class="hidden px-4 py-3 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50"
                >
                  <div class="flex flex-wrap gap-4 text-sm">
                    <div>
                      <span class="text-slate-500">Min:</span> <span
                        id="statMin"
                        class="font-medium"
                      >-</span>
                    </div>
                    <div>
                      <span class="text-slate-500">Max:</span> <span
                        id="statMax"
                        class="font-medium"
                      >-</span>
                    </div>
                    <div>
                      <span class="text-slate-500">Mean:</span> <span
                        id="statMean"
                        class="font-medium"
                      >-</span>
                    </div>
                    <div>
                      <span class="text-slate-500">Confidence:</span> <span
                        id="statConf"
                        class="font-medium"
                      >-</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Model Info Cards -->
              <div class="grid md:grid-cols-3 gap-4 mt-6">
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4"
                >
                  <div
                    class="flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-2"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span class="text-xs font-medium uppercase tracking-wider"
                    >Samples Processed</span>
                  </div>
                  <p id="samplesCount" class="text-2xl font-bold">0</p>
                </div>
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4"
                >
                  <div
                    class="flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-2"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                      />
                    </svg>
                    <span class="text-xs font-medium uppercase tracking-wider"
                    >Dimensions</span>
                  </div>
                  <p class="text-2xl font-bold">
                    <span id="featCount">-</span> â†’ <span id="targCount"
                    >-</span>
                  </p>
                </div>
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4"
                >
                  <div
                    class="flex items-center gap-2 text-slate-500 dark:text-slate-400 mb-2"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                      />
                    </svg>
                    <span class="text-xs font-medium uppercase tracking-wider"
                    >Reservoir Size</span>
                  </div>
                  <p id="reservoirInfo" class="text-2xl font-bold">-</p>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Right Panel (Logs) -->
        <aside
          id="rightPanel"
          class="hidden xl:block w-80 border-l border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex-shrink-0 overflow-hidden flex flex-col"
        >
          <div
            class="flex items-center justify-between px-4 py-3 border-b border-slate-200 dark:border-slate-700"
          >
            <h3 class="font-semibold">Event Log</h3>
            <div class="flex items-center gap-1">
              <select
                id="logFilter"
                class="text-xs border border-slate-300 dark:border-slate-600 rounded px-1.5 py-1 bg-white dark:bg-slate-700 focus-ring"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
              <button
                id="clearLogs"
                class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 focus-ring"
                title="Clear Logs"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div
            id="logList"
            class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-1"
          >
          </div>
        </aside>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toasts" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden">
      <div
        id="modalBackdrop"
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
      >
      </div>
      <div
        class="absolute inset-0 overflow-y-auto p-4 flex items-start justify-center"
      >
        <div
          id="modalContent"
          class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl my-8 animate-slide-up"
        >
        </div>
      </div>
    </div>

    <!-- Progress Overlay -->
    <div
      id="progressOverlay"
      class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-4"
      >
        <h3 id="progressTitle" class="font-semibold text-lg mb-4">
          Processing...
        </h3>
        <div
          class="relative h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2"
        >
          <div
            id="progressBar"
            class="absolute inset-y-0 left-0 bg-brand-600 transition-all duration-300"
            style="width: 0%"
          >
          </div>
        </div>
        <div
          class="flex items-center justify-between text-sm text-slate-500 mb-4"
        >
          <span id="progressText">0 / 0</span>
          <span id="progressPercent">0%</span>
        </div>
        <button
          id="cancelProgress"
          class="w-full px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors focus-ring"
        >
          Cancel
        </button>
      </div>
    </div>

    <script>
      const APP_VERSION = "1.0.0";

      // Worker Source Code
      const workerSource = `
const MODULE_URL = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression';
let ESNRegression = null;
let model = null;
let dataset = [];
let modelConfig = null;
let nFeatures = 0;
let nTargets = 0;
let samplesProcessed = 0;
let cancelRequests = new Set();

async function loadModule(customUrl) {
  const url = customUrl || MODULE_URL;
  try {
    const module = await import(url);
    ESNRegression = module.ESNRegression || module.default?.ESNRegression || module.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module');
    return { success: true };
  } catch (e1) {
    try {
      const resp = await fetch(url);
      const text = await resp.text();
      const blob = new Blob([text], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      const module = await import(blobUrl);
      URL.revokeObjectURL(blobUrl);
      ESNRegression = module.ESNRegression || module.default?.ESNRegression || module.default;
      if (!ESNRegression) throw new Error('ESNRegression not found in fallback');
      return { success: true };
    } catch (e2) {
      return { success: false, error: 'Failed to load module: ' + e1.message + ' / ' + e2.message };
    }
  }
}

function createModel(config) {
  if (!ESNRegression) throw new Error('Module not loaded');
  model = new ESNRegression(config);
  modelConfig = config;
  dataset = [];
  nFeatures = 0;
  nTargets = 0;
  samplesProcessed = 0;
  return { success: true };
}

function trainSingle(x, y) {
function trainSingle(x, y) {
  if (!model) throw new Error('No model created');
  if (!Array.isArray(x) || !Array.isArray(y)) {
    throw new Error('Invalid sample: x and y must be arrays');
  }
  if (nFeatures === 0) { nFeatures = x.length; nTargets = y.length; }
  if (x.length !== nFeatures) throw new Error('Feature dim mismatch: expected ' + nFeatures + ', got ' + x.length);
  if (y.length !== nTargets) throw new Error('Target dim mismatch: expected ' + nTargets + ', got ' + y.length);
  model.fitOnline(x, y);
  dataset.push({ x, y });
  samplesProcessed++;
  return { samplesProcessed, nFeatures, nTargets };
}

function trainBatch(samples, requestId) {
  if (!model) throw new Error('No model created');
  const results = [];
  for (let i = 0; i < samples.length; i++) {
    if (cancelRequests.has(requestId)) {
      cancelRequests.delete(requestId);
      return { cancelled: true, processed: i };
    }
    const { x, y } = samples[i];
    trainSingle(x, y);
    if (i % 10 === 0 || i === samples.length - 1) {
      self.postMessage({ type: 'progress', requestId, processed: i + 1, total: samples.length, percent: Math.round((i + 1) / samples.length * 100), stage: 'training' });
    }
  }
  return { processed: samples.length, samplesProcessed, nFeatures, nTargets };
}

function predict(futureSteps) {
  if (!model) throw new Error('No model created');
  if (samplesProcessed === 0) throw new Error('No training data');
  const result = model.predict(futureSteps);
  return result;
}

function saveModel() {
  if (!model) throw new Error('No model created');
  const stateStr = model.save();
  const meta = { config: modelConfig, nFeatures, nTargets, samplesProcessed, createdAt: new Date().toISOString(), appVersion: '${APP_VERSION}' };
  return { modelState: stateStr, meta };
}

function loadModel(data) {
  if (!ESNRegression) throw new Error('Module not loaded');
  let stateStr, meta;
  if (typeof data === 'string') {
    stateStr = data;
    meta = null;
  } else if (data.modelState) {
    stateStr = data.modelState;
    meta = data.meta || null;
  } else {
    throw new Error('Invalid model data format');
  }
  model = ESNRegression.load(stateStr);
  if (meta) {
    modelConfig = meta.config;
    nFeatures = meta.nFeatures || 0;
    nTargets = meta.nTargets || 0;
    samplesProcessed = meta.samplesProcessed || 0;
  }
  dataset = [];
  return { success: true, meta };
}

function getStatus() {
  return { hasModel: !!model, hasModule: !!ESNRegression, samplesProcessed, nFeatures, nTargets, config: modelConfig };
}

self.onmessage = async (e) => {
  const { type, payload, requestId } = e.data;
  try {
    let result;
    switch (type) {
      case 'loadModule':
        result = await loadModule(payload?.url);
        break;
      case 'create':
        result = createModel(payload);
        break;
      case 'trainSingle':
        result = trainSingle(payload.x, payload.y);
        break;
      case 'trainBatch':
        result = trainBatch(payload.samples, requestId);
        break;
      case 'predict':
        result = predict(payload.futureSteps);
        break;
      case 'save':
        result = saveModel();
        break;
      case 'load':
        result = loadModel(payload);
        break;
      case 'status':
        result = getStatus();
        break;
      case 'cancel':
        cancelRequests.add(payload.requestId);
        result = { cancelled: true };
        break;
      default:
        throw new Error('Unknown action: ' + type);
    }
    self.postMessage({ type: 'response', requestId, success: true, data: result });
  } catch (err) {
    self.postMessage({ type: 'response', requestId, success: false, error: err.message });
  }
};
`;

      // Create Worker from Blob
      const workerBlob = new Blob([workerSource], {
        type: "application/javascript",
      });
      const workerUrl = URL.createObjectURL(workerBlob);
      const worker = new Worker(workerUrl, { type: "module" });

      // App State
      const state = {
        theme: localStorage.getItem("esn-theme") || "light",
        moduleLoaded: false,
        hasModel: false,
        samplesProcessed: 0,
        nFeatures: 0,
        nTargets: 0,
        config: null,
        predictions: null,
        currentView: "grid",
        focusDim: 0,
        logs: [],
        pendingRequests: new Map(),
        requestCounter: 0,
        moduleUrl:
          "https://cdn.esm.sh/jsr/@hviana/multivariate-regression",
        zoom: { scale: 1, offsetX: 0, offsetY: 0 },
      };

      // Chart Colors
      const CHART_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
      ];

      // DOM Elements
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      // Initialize Theme
      function initTheme() {
        if (state.theme === "dark") {
          document.documentElement.classList.add("dark");
        } else document.documentElement.classList.remove("dark");
      }

      // Worker Communication
      function sendWorker(type, payload = null) {
        return new Promise((resolve, reject) => {
          const requestId = ++state.requestCounter;
          state.pendingRequests.set(requestId, { resolve, reject });
          worker.postMessage({ type, payload, requestId });
        });
      }

      worker.onmessage = (e) => {
        const {
          type,
          requestId,
          success,
          data,
          error,
          processed,
          total,
          percent,
          stage,
        } = e.data;
        if (type === "progress") {
          updateProgress(processed, total, percent);
          return;
        }
        const pending = state.pendingRequests.get(requestId);
        if (pending) {
          state.pendingRequests.delete(requestId);
          if (success) pending.resolve(data);
          else pending.reject(new Error(error));
        }
      };

      // Toast Notifications
      function showToast(message, type = "info", duration = 4000) {
        const colors = {
          info:
            "bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800",
          success: "bg-emerald-600 text-white",
          warning: "bg-amber-500 text-white",
          error: "bg-red-600 text-white",
        };
        const icons = {
          info:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
          success:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
          warning:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
          error:
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
        };
        const toast = document.createElement("div");
        toast.className =
          `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg ${
            colors[type]
          } animate-slide-up`;
        toast.innerHTML =
          `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${
            icons[type]
          }</svg><span class="text-sm font-medium">${message}</span>`;
        $("#toasts").appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Logging
      function log(message, type = "info", details = null) {
        const entry = {
          id: Date.now(),
          time: new Date().toLocaleTimeString(),
          message,
          type,
          details,
        };
        state.logs.unshift(entry);
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const filter = $("#logFilter")?.value || "all";
        const filtered = filter === "all"
          ? state.logs
          : state.logs.filter((l) => l.type === filter);
        const colors = {
          info: "text-slate-500",
          success: "text-emerald-600",
          warning: "text-amber-600",
          error: "text-red-600",
        };
        $("#logList").innerHTML = filtered.slice(0, 50).map((l) => `
    <div class="px-2 py-1.5 rounded text-xs hover:bg-slate-50 dark:hover:bg-slate-700/50">
      <div class="flex items-center gap-2">
        <span class="text-slate-400">${l.time}</span>
        <span class="${colors[l.type]} font-medium">${l.message}</span>
      </div>
      ${
          l.details
            ? `<div class="mt-1 text-slate-400 truncate">${l.details}</div>`
            : ""
        }
    </div>
  `).join("");
      }

      // UI Updates
      function updateUI() {
        const hasModel = state.hasModel;
        const hasPredictions = state.predictions !== null;

        $("#onboarding").classList.toggle("hidden", hasModel);
        $("#dashboard").classList.toggle("hidden", !hasModel);

        $("#modelChip").textContent = hasModel
          ? `Model: ${state.nFeatures}â†’${state.nTargets}`
          : "No Model";
        $("#modelChip").className =
          `px-2.5 py-1 rounded-full text-xs font-medium ${
            hasModel
              ? "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300"
              : "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
          }`;

        $("#dataChip").textContent = state.samplesProcessed > 0
          ? `${state.samplesProcessed} samples`
          : "No Data";
        $("#dataChip").className =
          `px-2.5 py-1 rounded-full text-xs font-medium ${
            state.samplesProcessed > 0
              ? "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300"
              : "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"
          }`;

        $("#quickPredict").disabled = !hasModel ||
          state.samplesProcessed === 0;
        $("#runPredict").disabled = !hasModel ||
          state.samplesProcessed === 0;

        $("#samplesCount").textContent = state.samplesProcessed
          .toLocaleString();
        $("#featCount").textContent = state.nFeatures || "-";
        $("#targCount").textContent = state.nTargets || "-";
        $("#reservoirInfo").textContent = state.config?.reservoirSize ||
          "-";

        $("#chartEmpty").classList.toggle("hidden", hasPredictions);
        $("#statsBar").classList.toggle("hidden", !hasPredictions);

        updateDimSelector();
      }

      function updateDimSelector() {
        const sel = $("#dimSelector");
        sel.innerHTML = "";
        for (let i = 0; i < state.nTargets; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `Target ${i + 1}`;
          sel.appendChild(opt);
        }
        sel.value = state.focusDim;
      }

      // Progress UI
      function showProgress(title) {
        $("#progressTitle").textContent = title;
        $("#progressBar").style.width = "0%";
        $("#progressText").textContent = "0 / 0";
        $("#progressPercent").textContent = "0%";
        $("#progressOverlay").classList.remove("hidden");
      }

      function updateProgress(processed, total, percent) {
        $("#progressBar").style.width = percent + "%";
        $("#progressText").textContent = `${processed} / ${total}`;
        $("#progressPercent").textContent = percent + "%";
      }

      function hideProgress() {
        $("#progressOverlay").classList.add("hidden");
      }

      // Modal System
      function openModal(content) {
        $("#modalContent").innerHTML = content;
        $("#modalContainer").classList.remove("hidden");
        document.body.style.overflow = "hidden";
        const firstInput = $("#modalContent").querySelector(
          "input, select, button",
        );
        if (firstInput) firstInput.focus();
      }

      function closeModal() {
        $("#modalContainer").classList.add("hidden");
        document.body.style.overflow = "";
      }

      // Presets
      const PRESETS = {
        startHere: {
          name: "Start Here",
          desc: "Recommended defaults",
          config: {
            maxSequenceLength: 64,
            reservoirSize: 256,
            spectralRadius: 0.9,
            leakRate: 0.3,
            inputScale: 1.0,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0.0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.999,
            rlsDelta: 1.0,
            epsilon: 1e-8,
            l2Lambda: 0.0001,
            gradientClipNorm: 1.0,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 3.0,
            outlierMinWeight: 0.1,
            residualWindowSize: 100,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        },
        fast: {
          name: "Fast/Light",
          desc: "Quick training, smaller model",
          config: {
            maxSequenceLength: 32,
            reservoirSize: 128,
            spectralRadius: 0.95,
            leakRate: 0.5,
            inputScale: 1.0,
            biasScale: 0.1,
            reservoirSparsity: 0.95,
            inputSparsity: 0.3,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.99,
            rlsDelta: 1.0,
            epsilon: 1e-8,
            l2Lambda: 0.001,
            gradientClipNorm: 1.0,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 5,
            outlierThreshold: 3.0,
            outlierMinWeight: 0.1,
            residualWindowSize: 50,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        },
        balanced: {
          name: "Balanced",
          desc: "Good balance of speed and accuracy",
          config: {
            maxSequenceLength: 64,
            reservoirSize: 384,
            spectralRadius: 0.9,
            leakRate: 0.3,
            inputScale: 1.0,
            biasScale: 0.1,
            reservoirSparsity: 0.85,
            inputSparsity: 0.1,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.9995,
            rlsDelta: 1.0,
            epsilon: 1e-8,
            l2Lambda: 0.0001,
            gradientClipNorm: 1.0,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 10,
            outlierThreshold: 3.0,
            outlierMinWeight: 0.1,
            residualWindowSize: 100,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        },
        accurate: {
          name: "Accurate/Stable",
          desc: "Best accuracy, slower",
          config: {
            maxSequenceLength: 128,
            reservoirSize: 512,
            spectralRadius: 0.85,
            leakRate: 0.2,
            inputScale: 0.8,
            biasScale: 0.05,
            reservoirSparsity: 0.8,
            inputSparsity: 0.0,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.9999,
            rlsDelta: 0.1,
            epsilon: 1e-10,
            l2Lambda: 0.00001,
            gradientClipNorm: 0.5,
            normalizationEpsilon: 1e-10,
            normalizationWarmup: 20,
            outlierThreshold: 2.5,
            outlierMinWeight: 0.2,
            residualWindowSize: 200,
            uncertaintyMultiplier: 1.96,
            weightInitScale: 0.05,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        },
        adaptive: {
          name: "Adaptive/Drift",
          desc: "For changing data distributions",
          config: {
            maxSequenceLength: 48,
            reservoirSize: 256,
            spectralRadius: 0.92,
            leakRate: 0.4,
            inputScale: 1.2,
            biasScale: 0.1,
            reservoirSparsity: 0.9,
            inputSparsity: 0.1,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.995,
            rlsDelta: 1.0,
            epsilon: 1e-8,
            l2Lambda: 0.0005,
            gradientClipNorm: 1.0,
            normalizationEpsilon: 1e-8,
            normalizationWarmup: 5,
            outlierThreshold: 3.5,
            outlierMinWeight: 0.05,
            residualWindowSize: 50,
            uncertaintyMultiplier: 2.0,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "autoregressive",
          },
        },
        noisy: {
          name: "Noisy/Robust",
          desc: "For noisy data with outliers",
          config: {
            maxSequenceLength: 64,
            reservoirSize: 320,
            spectralRadius: 0.88,
            leakRate: 0.25,
            inputScale: 0.8,
            biasScale: 0.1,
            reservoirSparsity: 0.85,
            inputSparsity: 0.1,
            activation: "tanh",
            useInputInReadout: true,
            useBiasInReadout: true,
            readoutTraining: "rls",
            rlsLambda: 0.998,
            rlsDelta: 10.0,
            epsilon: 1e-6,
            l2Lambda: 0.001,
            gradientClipNorm: 0.5,
            normalizationEpsilon: 1e-6,
            normalizationWarmup: 20,
            outlierThreshold: 2.0,
            outlierMinWeight: 0.3,
            residualWindowSize: 150,
            uncertaintyMultiplier: 2.5,
            weightInitScale: 0.1,
            seed: 42,
            verbose: false,
            rollforwardMode: "holdLastX",
          },
        },
      };

      // Config Modal
      function openConfigModal() {
        const cfg = state.config || PRESETS.startHere.config;
        const paramHelp = {
          maxSequenceLength: {
            desc: "Maximum sequence length for temporal processing",
            range: "16-256",
            advice:
              "Longer = more temporal context but slower. Start with 64.",
          },
          reservoirSize: {
            desc: "Number of neurons in reservoir",
            range: "64-1024",
            advice:
              "Larger = more capacity but slower. 256 is good starting point.",
          },
          spectralRadius: {
            desc: "Controls reservoir dynamics stability",
            range: "0.1-1.5",
            advice:
              "<1 for stable, >1 for chaotic. 0.9 is usually good.",
          },
          leakRate: {
            desc: "Neuron state leakage rate",
            range: "0.01-1.0",
            advice:
              "Lower = longer memory. Higher = faster adaptation.",
          },
          inputScale: {
            desc: "Input signal scaling factor",
            range: "0.1-5.0",
            advice: "Scale based on input magnitude. Usually 0.5-2.0.",
          },
          biasScale: {
            desc: "Bias term scaling",
            range: "0.0-1.0",
            advice: "Small bias helps. 0.1 is typical.",
          },
          reservoirSparsity: {
            desc: "Fraction of zero weights in reservoir",
            range: "0.0-0.99",
            advice:
              "Higher = faster, potentially more diverse dynamics.",
          },
          inputSparsity: {
            desc: "Fraction of zero weights in input",
            range: "0.0-0.9",
            advice: "Can help with high-dimensional inputs.",
          },
          activation: {
            desc: "Neuron activation function",
            range: "tanh/relu",
            advice: "tanh is standard and stable.",
          },
          useInputInReadout: {
            desc: "Include raw input in readout",
            range: "true/false",
            advice:
              "Usually helps. Disable for pure temporal modeling.",
          },
          useBiasInReadout: {
            desc: "Include bias in readout layer",
            range: "true/false",
            advice: "Generally keep enabled.",
          },
          rlsLambda: {
            desc: "RLS forgetting factor",
            range: "0.9-0.9999",
            advice: "Higher = more stable. Lower = faster adaptation.",
          },
          rlsDelta: {
            desc: "RLS initial covariance",
            range: "0.01-100",
            advice: "Higher = faster initial learning. 1.0 is typical.",
          },
          epsilon: {
            desc: "Numerical stability constant",
            range: "1e-10 to 1e-6",
            advice: "Decrease if unstable, increase for noisy data.",
          },
          l2Lambda: {
            desc: "L2 regularization strength",
            range: "0-0.01",
            advice: "Increase to prevent overfitting.",
          },
          gradientClipNorm: {
            desc: "Maximum gradient norm",
            range: "0.1-10",
            advice: "Lower for stability, higher for faster learning.",
          },
          normalizationWarmup: {
            desc: "Samples before normalization stabilizes",
            range: "5-50",
            advice: "More for noisy data.",
          },
          outlierThreshold: {
            desc: "Std deviations for outlier detection",
            range: "2-5",
            advice: "Lower = more aggressive filtering.",
          },
          outlierMinWeight: {
            desc: "Minimum weight for outliers",
            range: "0-0.5",
            advice: "Higher = outliers still influence.",
          },
          residualWindowSize: {
            desc: "Window for uncertainty estimation",
            range: "20-500",
            advice: "Larger = smoother uncertainty.",
          },
          uncertaintyMultiplier: {
            desc: "Confidence interval width",
            range: "1.0-3.0",
            advice: "1.96 = 95% CI.",
          },
          weightInitScale: {
            desc: "Initial weight magnitude",
            range: "0.01-0.5",
            advice: "Smaller = more stable start.",
          },
          seed: {
            desc: "Random seed for reproducibility",
            range: "any integer",
            advice: "Same seed = same results.",
          },
          rollforwardMode: {
            desc: "How to handle multi-step prediction",
            range: "holdLastX/autoregressive",
            advice: "autoregressive for longer forecasts.",
          },
        };

        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Model Configuration</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Preset</label>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          ${
          Object.entries(PRESETS).map(([k, v]) =>
            `<button onclick="applyPreset('${k}')" class="preset-btn px-3 py-2 text-sm text-left rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-500 hover:bg-brand-50 dark:hover:bg-brand-900/20 transition-colors"><div class="font-medium">${v.name}</div><div class="text-xs text-slate-500">${v.desc}</div></button>`
          ).join("")
        }
        </div>
      </div>
      
      <form id="configForm" class="space-y-6 max-h-[50vh] overflow-y-auto scrollbar-thin pr-2">
        <details class="group" open>
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸ”„ Reservoir Architecture
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          [
            "maxSequenceLength",
            "reservoirSize",
            "spectralRadius",
            "leakRate",
            "inputScale",
            "biasScale",
            "reservoirSparsity",
            "inputSparsity",
          ].map((p) => renderConfigField(p, cfg[p], paramHelp[p])).join(
            "",
          )
        }
            <div class="sm:col-span-2"><label class="block text-sm font-medium mb-1">activation</label><select name="activation" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"><option value="tanh" ${
          cfg.activation === "tanh" ? "selected" : ""
        }>tanh</option><option value="relu" ${
          cfg.activation === "relu" ? "selected" : ""
        }>relu</option></select></div>
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸ“¤ Readout Configuration
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            <div><label class="flex items-center gap-2"><input type="checkbox" name="useInputInReadout" ${
          cfg.useInputInReadout ? "checked" : ""
        } class="rounded"><span class="text-sm">useInputInReadout</span></label></div>
            <div><label class="flex items-center gap-2"><input type="checkbox" name="useBiasInReadout" ${
          cfg.useBiasInReadout ? "checked" : ""
        } class="rounded"><span class="text-sm">useBiasInReadout</span></label></div>
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸŽ¯ Training (RLS)
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          [
            "rlsLambda",
            "rlsDelta",
            "epsilon",
            "l2Lambda",
            "gradientClipNorm",
          ].map((p) => renderConfigField(p, cfg[p], paramHelp[p])).join(
            "",
          )
        }
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸ“Š Normalization
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          ["normalizationEpsilon", "normalizationWarmup"].map((p) =>
            renderConfigField(p, cfg[p], paramHelp[p])
          ).join("")
        }
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸ›¡ï¸ Outlier Handling
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          ["outlierThreshold", "outlierMinWeight"].map((p) =>
            renderConfigField(p, cfg[p], paramHelp[p])
          ).join("")
        }
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            ðŸ“ˆ Uncertainty
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          ["residualWindowSize", "uncertaintyMultiplier"].map((p) =>
            renderConfigField(p, cfg[p], paramHelp[p])
          ).join("")
        }
          </div>
        </details>
        
        <details class="group">
          <summary class="cursor-pointer flex items-center gap-2 text-sm font-semibold text-brand-600 mb-3">
            <svg class="w-4 h-4 group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            âš™ï¸ Initialization
          </summary>
          <div class="grid sm:grid-cols-2 gap-4 pl-6">
            ${
          ["weightInitScale", "seed"].map((p) =>
            renderConfigField(p, cfg[p], paramHelp[p])
          ).join("")
        }
            <div><label class="flex items-center gap-2"><input type="checkbox" name="verbose" ${
          cfg.verbose ? "checked" : ""
        } class="rounded"><span class="text-sm">verbose</span></label></div>
            <div><label class="block text-sm font-medium mb-1">rollforwardMode</label><select name="rollforwardMode" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"><option value="holdLastX" ${
          cfg.rollforwardMode === "holdLastX" ? "selected" : ""
        }>holdLastX</option><option value="autoregressive" ${
          cfg.rollforwardMode === "autoregressive" ? "selected" : ""
        }>autoregressive</option></select></div>
          </div>
        </details>
      </form>
      
      <div class="flex flex-col sm:flex-row gap-3 mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
        <button onclick="resetDefaults()" class="px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Reset to Defaults</button>
        <div class="flex-1"></div>
        <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
        <button onclick="createModel()" class="px-6 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors">Create Model</button>
      </div>
    </div>
  `);
      }

      function renderConfigField(name, value, help) {
        return `<div><label class="block text-sm font-medium mb-1">${name}</label><input type="number" name="${name}" value="${value}" step="any" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm" title="${
          help?.desc || ""
        }"></div>`;
      }

      window.applyPreset = (key) => {
        const preset = PRESETS[key];
        if (!preset) return;
        const form = $("#configForm");
        Object.entries(preset.config).forEach(([k, v]) => {
          const el = form.elements[k];
          if (el) {
            if (el.type === "checkbox") el.checked = v;
            else el.value = v;
          }
        });
        showToast(`Applied "${preset.name}" preset`, "info");
      };

      window.resetDefaults = () => {
        applyPreset("startHere");
      };

      window.createModel = async () => {
        const form = $("#configForm");
        const config = {};
        const numFields = [
          "maxSequenceLength",
          "reservoirSize",
          "spectralRadius",
          "leakRate",
          "inputScale",
          "biasScale",
          "reservoirSparsity",
          "inputSparsity",
          "rlsLambda",
          "rlsDelta",
          "epsilon",
          "l2Lambda",
          "gradientClipNorm",
          "normalizationEpsilon",
          "normalizationWarmup",
          "outlierThreshold",
          "outlierMinWeight",
          "residualWindowSize",
          "uncertaintyMultiplier",
          "weightInitScale",
          "seed",
        ];
        const boolFields = [
          "useInputInReadout",
          "useBiasInReadout",
          "verbose",
        ];
        const strFields = ["activation", "rollforwardMode"];

        numFields.forEach((k) => {
          config[k] = parseFloat(form.elements[k].value);
        });
        boolFields.forEach((k) => {
          config[k] = form.elements[k].checked;
        });
        strFields.forEach((k) => {
          config[k] = form.elements[k].value;
        });
        config.readoutTraining = "rls";

        if (
          [
            "maxSequenceLength",
            "reservoirSize",
            "seed",
            "normalizationWarmup",
            "residualWindowSize",
          ].some((k) => !Number.isInteger(config[k]) || config[k] < 1)
        ) {
          showToast("Invalid integer parameters", "error");
          return;
        }
        if (
          ["spectralRadius", "leakRate", "inputScale", "biasScale"]
            .some((k) => isNaN(config[k]) || config[k] <= 0)
        ) {
          showToast("Invalid positive number parameters", "error");
          return;
        }

        try {
          await sendWorker("create", config);
          state.hasModel = true;
          state.config = config;
          state.samplesProcessed = 0;
          state.nFeatures = 0;
          state.nTargets = 0;
          state.predictions = null;
          localStorage.setItem("esn-config", JSON.stringify(config));
          closeModal();
          updateUI();
          renderChart();
          log(
            "Model created",
            "success",
            `Reservoir: ${config.reservoirSize}, Seq: ${config.maxSequenceLength}`,
          );
          showToast("Model created successfully!", "success");
        } catch (e) {
          log("Create failed: " + e.message, "error");
          showToast("Failed to create model: " + e.message, "error");
        }
      };

      // Upload Modal
      function openUploadModal() {
        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Upload Dataset</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="mb-6">
        <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-brand-500 transition-colors cursor-pointer" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileUpload(event)">
          <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          <p class="text-slate-600 dark:text-slate-300 font-medium">Click to upload or drag & drop</p>
          <p class="text-sm text-slate-500">JSON file</p>
        </div>
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Or paste JSON:</label>
        <textarea id="pasteJson" class="w-full h-32 px-3 py-2 border rounded-lg font-mono text-sm dark:bg-slate-700 dark:border-slate-600 resize-none" placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'></textarea>
        <button onclick="handlePasteUpload()" class="mt-2 px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors">Parse JSON</button>
      </div>
      
      <details class="mb-4">
        <summary class="cursor-pointer text-sm text-brand-600 font-medium">Supported Formats</summary>
        <div class="mt-2 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-xs font-mono space-y-2">
          <div><strong>Format A:</strong> {"xCoordinates": number[][], "yCoordinates": number[][]}</div>
          <div><strong>Format B:</strong> {"samples": [{"x": number[], "y": number[]}, ...]}</div>
        </div>
      </details>
      
      <div id="uploadPreview" class="hidden">
        <h3 class="font-semibold mb-3">Validation Preview</h3>
        <div id="previewContent" class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg"></div>
        <div class="flex gap-3 mt-4">
          <button onclick="confirmUpload()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors">Confirm & Train</button>
          <button onclick="cancelUpload()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
        </div>
      </div>
    </div>
  `);
      }

      let pendingUploadData = null;

      window.handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            validateAndPreviewUpload(data);
          } catch (err) {
            showToast("Invalid JSON file: " + err.message, "error");
          }
        };
        reader.readAsText(file);
      };

      window.handlePasteUpload = () => {
        const text = $("#pasteJson").value.trim();
        if (!text) {
          showToast("Please enter JSON data", "warning");
          return;
        }
        try {
          const data = JSON.parse(text);
          validateAndPreviewUpload(data);
        } catch (err) {
          showToast("Invalid JSON: " + err.message, "error");
        }
      };

      function validateAndPreviewUpload(data) {
        let samples;
        if (data.xCoordinates && data.yCoordinates) {
          if (
            !Array.isArray(data.xCoordinates) ||
            !Array.isArray(data.yCoordinates)
          ) {
            showToast(
              "xCoordinates and yCoordinates must be arrays",
              "error",
            );
            return;
          }
          if (data.xCoordinates.length !== data.yCoordinates.length) {
            showToast(
              "xCoordinates and yCoordinates must have same length",
              "error",
            );
            return;
          }
          samples = data.xCoordinates.map((x, i) => ({
            x,
            y: data.yCoordinates[i],
          }));
        } else if (data.samples) {
          if (!Array.isArray(data.samples)) {
            showToast("samples must be array", "error");
            return;
          }
          samples = data.samples;
        } else {
          showToast(
            "Unrecognized format. Use xCoordinates/yCoordinates or samples.",
            "error",
          );
          return;
        }

        if (samples.length === 0) {
          showToast("Dataset is empty", "error");
          return;
        }

        const nFeat = samples[0].x?.length;
        const nTarg = samples[0].y?.length;
        if (!nFeat || !nTarg) {
          showToast("Invalid sample structure", "error");
          return;
        }

        for (let i = 0; i < samples.length; i++) {
          const s = samples[i];
          if (!Array.isArray(s.x) || !Array.isArray(s.y)) {
            showToast(`Sample ${i}: x and y must be arrays`, "error");
            return;
          }
          if (s.x.length !== nFeat) {
            showToast(
              `Sample ${i}: feature dim mismatch (expected ${nFeat}, got ${s.x.length})`,
              "error",
            );
            return;
          }
          if (s.y.length !== nTarg) {
            showToast(
              `Sample ${i}: target dim mismatch (expected ${nTarg}, got ${s.y.length})`,
              "error",
            );
            return;
          }
          if (
            s.x.some((v) => typeof v !== "number" || isNaN(v)) ||
            s.y.some((v) => typeof v !== "number" || isNaN(v))
          ) {
            showToast(
              `Sample ${i}: contains non-number or NaN values`,
              "error",
            );
            return;
          }
        }

        pendingUploadData = samples;
        $("#uploadPreview").classList.remove("hidden");
        $("#previewContent").innerHTML = `
    <div class="grid grid-cols-3 gap-4 text-sm">
      <div><span class="text-slate-500">Samples:</span> <strong>${samples.length}</strong></div>
      <div><span class="text-slate-500">Features:</span> <strong>${nFeat}</strong></div>
      <div><span class="text-slate-500">Targets:</span> <strong>${nTarg}</strong></div>
    </div>
    <div class="mt-3 text-xs">
      <p class="text-slate-500 mb-1">First sample preview:</p>
      <p class="font-mono truncate">x: [${
          samples[0].x.slice(0, 5).map((v) => v.toFixed(3)).join(", ")
        }${samples[0].x.length > 5 ? "..." : ""}]</p>
      <p class="font-mono truncate">y: [${
          samples[0].y.slice(0, 5).map((v) => v.toFixed(3)).join(", ")
        }${samples[0].y.length > 5 ? "..." : ""}]</p>
    </div>
  `;
      }

      window.confirmUpload = async () => {
        if (!pendingUploadData) return;
        if (!state.hasModel) {
          showToast("Create a model first", "warning");
          return;
        }

        closeModal();
        showProgress("Training on dataset...");

        try {
          const result = await sendWorker("trainBatch", {
            samples: pendingUploadData,
          });
          if (result.cancelled) {
            showToast("Training cancelled", "warning");
          } else {
            state.samplesProcessed = result.samplesProcessed;
            state.nFeatures = result.nFeatures;
            state.nTargets = result.nTargets;
            log(`Trained on ${result.processed} samples`, "success");
            showToast(
              `Trained on ${result.processed} samples`,
              "success",
            );
          }
        } catch (e) {
          log("Training failed: " + e.message, "error");
          showToast("Training failed: " + e.message, "error");
        }

        hideProgress();
        updateUI();
        pendingUploadData = null;
      };

      window.cancelUpload = () => {
        pendingUploadData = null;
        $("#uploadPreview").classList.add("hidden");
      };

      // Manual Insert Modal
      function openManualInsertModal() {
        const template = state.nFeatures > 0
          ? `{"x": [${
            Array(state.nFeatures).fill("0").join(", ")
          }], "y": [${Array(state.nTargets).fill("0").join(", ")}]}`
          : '{"x": [0.5, 0.3], "y": [1.2]}';

        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Manual Insert</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Sample JSON</label>
        <textarea id="manualJson" class="w-full h-32 px-3 py-2 border rounded-lg font-mono text-sm dark:bg-slate-700 dark:border-slate-600 resize-none" oninput="validateManualInput()">${template}</textarea>
        <div id="manualValidation" class="mt-2 text-sm"></div>
      </div>
      
      <div class="flex gap-3">
        <button onclick="submitManualInsert()" id="submitManual" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg transition-colors disabled:opacity-50" disabled>Insert Sample</button>
        <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
      </div>
    </div>
  `);
        validateManualInput();
      }

      window.validateManualInput = () => {
        const text = $("#manualJson").value.trim();
        const validDiv = $("#manualValidation");
        const submitBtn = $("#submitManual");

        try {
          const data = JSON.parse(text);
          let samples;
          if (data.samples) samples = data.samples;
          else if (data.x && data.y) samples = [data];
          else throw new Error('Use {"x": [...], "y": [...]} format');

          if (samples.length === 0) throw new Error("No samples");

          for (const s of samples) {
            if (!Array.isArray(s.x) || !Array.isArray(s.y)) {
              throw new Error("x and y must be arrays");
            }
            if (s.x.some((v) => typeof v !== "number" || isNaN(v))) {
              throw new Error("Invalid x values");
            }
            if (s.y.some((v) => typeof v !== "number" || isNaN(v))) {
              throw new Error("Invalid y values");
            }
            if (state.nFeatures > 0 && s.x.length !== state.nFeatures) {
              throw new Error(
                `Feature dim mismatch: expected ${state.nFeatures}`,
              );
            }
            if (state.nTargets > 0 && s.y.length !== state.nTargets) {
              throw new Error(
                `Target dim mismatch: expected ${state.nTargets}`,
              );
            }
          }

          validDiv.innerHTML =
            `<span class="text-emerald-600">âœ“ Valid: ${samples.length} sample(s), ${
              samples[0].x.length
            } features, ${samples[0].y.length} targets</span>`;
          submitBtn.disabled = false;
        } catch (e) {
          validDiv.innerHTML =
            `<span class="text-red-600">âœ— ${e.message}</span>`;
          submitBtn.disabled = true;
        }
      };

      window.submitManualInsert = async () => {
        if (!state.hasModel) {
          showToast("Create model first", "warning");
          return;
        }

        const text = $("#manualJson").value.trim();
        try {
          const data = JSON.parse(text);
          let samples = data.samples || [data];

          for (const s of samples) {
            const result = await sendWorker("trainSingle", {
              x: s.x,
              y: s.y,
            });
            state.samplesProcessed = result.samplesProcessed;
            state.nFeatures = result.nFeatures;
            state.nTargets = result.nTargets;
          }

          closeModal();
          log(`Inserted ${samples.length} sample(s)`, "success");
          showToast(`Inserted ${samples.length} sample(s)`, "success");
          updateUI();
        } catch (e) {
          showToast("Insert failed: " + e.message, "error");
        }
      };

      // Save/Load Modal
      function openSaveLoadModal() {
        const hasSaved = !!localStorage.getItem("esn-model");

        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Save / Load Model</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold mb-3">Save</h3>
          <div class="space-y-3">
            <button onclick="saveToFile()" class="w-full flex items-center gap-3 px-4 py-3 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${
          !state.hasModel ? "opacity-50 cursor-not-allowed" : ""
        }" ${!state.hasModel ? "disabled" : ""}>
              <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              <span>Download as File</span>
            </button>
            <button onclick="saveToLocal()" class="w-full flex items-center gap-3 px-4 py-3 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${
          !state.hasModel ? "opacity-50 cursor-not-allowed" : ""
        }" ${!state.hasModel ? "disabled" : ""}>
              <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              <span>Save to Browser</span>
            </button>
          </div>
        </div>
        
        <div>
          <h3 class="font-semibold mb-3">Load</h3>
          <div class="space-y-3">
            <button onclick="document.getElementById('loadFileInput').click()" class="w-full flex items-center gap-3 px-4 py-3 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
              <input type="file" id="loadFileInput" accept=".json" class="hidden" onchange="loadFromFile(event)">
              <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
              <span>Load from File</span>
            </button>
            <button onclick="loadFromLocal()" class="w-full flex items-center gap-3 px-4 py-3 border border-slate-200 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${
          !hasSaved ? "opacity-50 cursor-not-allowed" : ""
        }" ${!hasSaved ? "disabled" : ""}>
              <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
              <span>Load from Browser</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
        <button onclick="clearAllData()" class="text-sm text-red-600 hover:underline">Clear all saved data</button>
      </div>
    </div>
  `);
      }

      window.saveToFile = async () => {
        try {
          const data = await sendWorker("save");
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-model-${
            new Date().toISOString().slice(0, 10)
          }.json`;
          a.click();
          URL.revokeObjectURL(url);
          log("Model saved to file", "success");
          showToast("Model downloaded", "success");
        } catch (e) {
          showToast("Save failed: " + e.message, "error");
        }
      };

      window.saveToLocal = async () => {
        try {
          const data = await sendWorker("save");
          localStorage.setItem("esn-model", JSON.stringify(data));
          log("Model saved to browser", "success");
          showToast("Saved to browser storage", "success");
        } catch (e) {
          showToast("Save failed: " + e.message, "error");
        }
      };

      window.loadFromFile = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            await loadModelData(data);
          } catch (err) {
            showToast("Load failed: " + err.message, "error");
          }
        };
        reader.readAsText(file);
      };

      window.loadFromLocal = async () => {
        const saved = localStorage.getItem("esn-model");
        if (!saved) {
          showToast("No saved model found", "warning");
          return;
        }
        try {
          const data = JSON.parse(saved);
          await loadModelData(data);
        } catch (err) {
          showToast("Load failed: " + err.message, "error");
        }
      };

      async function loadModelData(data) {
        try {
          const result = await sendWorker("load", data);
          state.hasModel = true;
          if (result.meta) {
            state.config = result.meta.config;
            state.nFeatures = result.meta.nFeatures;
            state.nTargets = result.meta.nTargets;
            state.samplesProcessed = result.meta.samplesProcessed;
          }
          closeModal();
          state.predictions = null;
          updateUI();
          renderChart();
          log("Model loaded", "success");
          showToast("Model loaded successfully", "success");
        } catch (e) {
          throw e;
        }
      }

      window.clearAllData = () => {
        if (
          confirm(
            "Clear all saved data including model, config, and logs?",
          )
        ) {
          localStorage.removeItem("esn-model");
          localStorage.removeItem("esn-config");
          localStorage.removeItem("esn-theme");
          state.logs = [];
          renderLogs();
          showToast("All data cleared", "info");
        }
      };

      // Random Test Modal
      function openRandomTestModal() {
        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Random Standard Test</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="grid sm:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium mb-1">Seed</label>
          <input type="number" id="testSeed" value="42" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Samples</label>
          <input type="number" id="testSamples" value="200" min="10" max="5000" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Features</label>
          <input type="number" id="testFeatures" value="5" min="1" max="50" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Targets</label>
          <input type="number" id="testTargets" value="3" min="1" max="20" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Noise Level</label>
          <input type="range" id="testNoise" value="0.1" min="0" max="0.5" step="0.05" class="w-full">
          <span class="text-xs text-slate-500" id="noiseVal">0.1</span>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Outlier Rate</label>
          <input type="range" id="testOutlier" value="0.02" min="0" max="0.2" step="0.02" class="w-full">
          <span class="text-xs text-slate-500" id="outlierVal">0.02</span>
        </div>
      </div>
      
      <div class="flex gap-3">
        <button onclick="runRandomTest()" class="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-brand-600 hover:from-purple-700 hover:to-brand-700 rounded-lg transition-all shadow-md hover:shadow-lg">
          Generate + Train + Predict
        </button>
        <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
      </div>
    </div>
  `);

        $("#testNoise").oninput = (e) =>
          $("#noiseVal").textContent = e.target.value;
        $("#testOutlier").oninput = (e) =>
          $("#outlierVal").textContent = e.target.value;
      }

      function seededRandom(seed) {
        let s = seed;
        return () => {
          s = (s * 1103515245 + 12345) & 0x7fffffff;
          return s / 0x7fffffff;
        };
      }

      window.runRandomTest = async () => {
        const seed = parseInt($("#testSeed").value) || 42;
        const nSamples = parseInt($("#testSamples").value) || 200;
        const nFeat = parseInt($("#testFeatures").value) || 5;
        const nTarg = parseInt($("#testTargets").value) || 3;
        const noise = parseFloat($("#testNoise").value) || 0.1;
        const outlierRate = parseFloat($("#testOutlier").value) || 0.02;

        closeModal();

        const rand = seededRandom(seed);
        const samples = [];

        for (let i = 0; i < nSamples; i++) {
          const t = i / nSamples;
          const x = [];
          for (let f = 0; f < nFeat; f++) {
            x.push(
              Math.sin(2 * Math.PI * t * (f + 1)) +
                Math.cos(4 * Math.PI * t * (f + 0.5)) +
                (rand() - 0.5) * noise,
            );
          }

          const y = [];
          for (let g = 0; g < nTarg; g++) {
            let val = 0;
            for (let f = 0; f < Math.min(nFeat, 3); f++) {
              val += x[f] * Math.sin((g + 1) * Math.PI * 0.5);
            }
            val = Math.tanh(val) + (rand() - 0.5) * noise;
            if (rand() < outlierRate) val += rand() > 0.5 ? 3 : -3;
            y.push(val);
          }
          samples.push({ x, y });
        }

        log(
          `Generated ${nSamples} samples (${nFeat}â†’${nTarg})`,
          "info",
          `Noise: ${noise}, Outliers: ${outlierRate}`,
        );

        if (!state.moduleLoaded) {
          showToast("Loading module...", "info");
          try {
            await sendWorker("loadModule");
            state.moduleLoaded = true;
          } catch (e) {
            showToast("Module load failed: " + e.message, "error");
            return;
          }
        }

        try {
          await sendWorker("create", PRESETS.startHere.config);
          state.hasModel = true;
          state.config = PRESETS.startHere.config;
        } catch (e) {
          showToast("Create failed: " + e.message, "error");
          return;
        }

        if (!samples || samples.length === 0) {
          showToast("No samples generated", "error");
          return;
        }
        showProgress("Training...");
        try {
          const result = await sendWorker("trainBatch", { samples });
          state.samplesProcessed = result.samplesProcessed;
          state.nFeatures = result.nFeatures;
          state.nTargets = result.nTargets;
          hideProgress();
          log(`Trained on ${result.processed} samples`, "success");
        } catch (e) {
          hideProgress();
          showToast("Training failed: " + e.message, "error");
          return;
        }

        updateUI();

        try {
          const futureSteps = 30;
          state.predictions = await sendWorker("predict", {
            futureSteps,
          });
          state.currentView = "focus";
          updateViewButtons();
          renderChart();
          log(`Prediction: ${futureSteps} steps`, "success");
          showToast("Test complete! View predictions.", "success");
        } catch (e) {
          showToast("Prediction failed: " + e.message, "error");
        }
      };

      // Settings Modal
      function openSettingsModal() {
        openModal(`
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Settings</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium mb-2">Module URL</label>
          <input type="text" id="moduleUrl" value="${state.moduleUrl}" class="w-full px-3 py-2 border rounded-lg font-mono text-sm dark:bg-slate-700 dark:border-slate-600">
          <p class="text-xs text-slate-500 mt-1">Change if default CDN doesn't work</p>
          <button onclick="reloadModule()" class="mt-2 px-3 py-1.5 text-sm text-brand-600 border border-brand-600 rounded-lg hover:bg-brand-50 dark:hover:bg-brand-900/20 transition-colors">Reload Module</button>
        </div>
        
        <div>
          <h3 class="font-medium mb-2">Reset</h3>
          <button onclick="resetEverything()" class="px-4 py-2 text-sm text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">Reset Everything</button>
          <p class="text-xs text-slate-500 mt-1">Clears model, data, logs, and localStorage</p>
        </div>
      </div>
    </div>
  `);
      }

      window.reloadModule = async () => {
        const url = $("#moduleUrl").value.trim();
        state.moduleUrl = url;
        showToast("Reloading module...", "info");
        try {
          await sendWorker("loadModule", { url });
          state.moduleLoaded = true;
          showToast("Module reloaded", "success");
        } catch (e) {
          showToast("Module load failed: " + e.message, "error");
        }
      };

      window.resetEverything = () => {
        if (confirm("Reset everything? This will clear all data.")) {
          localStorage.clear();
          location.reload();
        }
      };

      // Prediction
      async function runPrediction() {
        if (!state.hasModel || state.samplesProcessed === 0) return;

        const steps = parseInt($("#futureSteps").value) || 20;
        if (steps < 1 || steps > 500) {
          showToast("Future steps must be 1-500", "warning");
          return;
        }

        $("#chartLoading").classList.remove("hidden");
        $("#runPredict").disabled = true;

        try {
          state.predictions = await sendWorker("predict", {
            futureSteps: steps,
          });
          log(`Prediction: ${steps} steps`, "success");
          renderChart();
        } catch (e) {
          log("Prediction failed: " + e.message, "error");
          showToast("Prediction failed: " + e.message, "error");
        }

        $("#chartLoading").classList.add("hidden");
        $("#runPredict").disabled = false;
      }

      // View Switching
      function updateViewButtons() {
        $$(".view-btn").forEach((btn) => {
          const isActive = btn.dataset.view === state.currentView;
          btn.classList.toggle("bg-brand-600", isActive);
          btn.classList.toggle("text-white", isActive);
          btn.classList.toggle("hover:bg-slate-100", !isActive);
          btn.classList.toggle("dark:hover:bg-slate-700", !isActive);
        });

        $("#dimSelector").classList.toggle(
          "hidden",
          state.currentView !== "focus",
        );
        $("#chartTitle").textContent = {
          grid: "All Targets Overview",
          focus: `Target ${state.focusDim + 1}`,
          heatmap: "Prediction Heatmap",
          uncertainty: "Uncertainty Analysis",
          bars: "Snapshot Comparison",
        }[state.currentView];
      }

      // Chart Rendering
      const chartState = {
        canvas: null,
        ctx: null,
        width: 0,
        height: 0,
        dpr: 1,
        margin: { left: 60, right: 20, top: 20, bottom: 40 },
        hover: { x: -1, y: -1, idx: -1 },
        animProgress: 1,
      };

      function initChart() {
        chartState.canvas = $("#mainChart");
        chartState.ctx = chartState.canvas.getContext("2d");
        chartState.dpr = window.devicePixelRatio || 1;
        resizeChart();

        const container = $("#chartContainer");
        new ResizeObserver(() => {
          clearTimeout(chartState.resizeTimer);
          chartState.resizeTimer = setTimeout(resizeChart, 150);
        }).observe(container);

        chartState.canvas.addEventListener(
          "mousemove",
          handleChartHover,
        );
        chartState.canvas.addEventListener("mouseleave", () => {
          chartState.hover = { x: -1, y: -1, idx: -1 };
          renderChart();
          hideTooltip();
        });
      }

      function resizeChart() {
        const container = $("#chartContainer");
        const rect = container.getBoundingClientRect();
        chartState.width = rect.width;
        chartState.height = rect.height;
        chartState.canvas.width = chartState.width * chartState.dpr;
        chartState.canvas.height = chartState.height * chartState.dpr;
        chartState.canvas.style.width = chartState.width + "px";
        chartState.canvas.style.height = chartState.height + "px";
        renderChart();
      }

      function renderChart() {
        const { ctx, width, height, dpr, margin } = chartState;
        if (!ctx || !width || !height) return;

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);

        const isDark = document.documentElement.classList.contains(
          "dark",
        );
        const bg = isDark ? "#1E293B" : "#FFFFFF";
        const gridColor = isDark
          ? "rgba(255,255,255,0.06)"
          : "rgba(0,0,0,0.06)";
        const axisColor = isDark
          ? "rgba(255,255,255,0.15)"
          : "rgba(0,0,0,0.15)";
        const textColor = isDark ? "#94A3B8" : "#64748B";

        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, width, height);

        if (!state.predictions) return;

        const pred = state.predictions;
        const preds = pred.predictions || [];
        const lower = pred.lowerBounds || [];
        const upper = pred.upperBounds || [];

        if (preds.length === 0) return;

        const chartW = width - margin.left - margin.right;
        const chartH = height - margin.top - margin.bottom;

        if (state.currentView === "focus") {
          renderFocusChart(
            ctx,
            margin,
            chartW,
            chartH,
            preds,
            lower,
            upper,
            gridColor,
            axisColor,
            textColor,
            isDark,
          );
        } else if (state.currentView === "grid") {
          renderGridChart(
            ctx,
            width,
            height,
            preds,
            lower,
            upper,
            isDark,
          );
        } else if (state.currentView === "heatmap") {
          renderHeatmap(
            ctx,
            margin,
            chartW,
            chartH,
            preds,
            isDark,
            textColor,
          );
        } else if (state.currentView === "uncertainty") {
          renderUncertainty(
            ctx,
            margin,
            chartW,
            chartH,
            preds,
            lower,
            upper,
            gridColor,
            axisColor,
            textColor,
            isDark,
          );
        } else if (state.currentView === "bars") {
          renderBarChart(
            ctx,
            margin,
            chartW,
            chartH,
            preds,
            lower,
            upper,
            isDark,
            textColor,
          );
        }

        updateStats();
      }

      function renderFocusChart(
        ctx,
        margin,
        chartW,
        chartH,
        preds,
        lower,
        upper,
        gridColor,
        axisColor,
        textColor,
        isDark,
      ) {
        const dim = state.focusDim;
        const data = preds.map((p) => p[dim] || 0);
        const lo = lower.map((p) => p?.[dim] ?? data[0]);
        const hi = upper.map((p) => p?.[dim] ?? data[0]);

        const allVals = [...data, ...lo, ...hi].filter((v) =>
          !isNaN(v)
        );
        let minY = Math.min(...allVals);
        let maxY = Math.max(...allVals);
        const pad = (maxY - minY) * 0.1 || 1;
        minY -= pad;
        maxY += pad;

        const nSteps = data.length;
        const xScale = (i) =>
          margin.left + (i / (nSteps - 1 || 1)) * chartW;
        const yScale = (v) =>
          margin.top + chartH - ((v - minY) / (maxY - minY)) * chartH;

        // Grid
        ctx.save();
        ctx.translate(0.5, 0.5);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);

        const nTicks = 6;
        for (let i = 0; i <= nTicks; i++) {
          const y = margin.top + (i / nTicks) * chartH;
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(margin.left + chartW, y);
          ctx.stroke();
        }

        ctx.setLineDash([]);
        ctx.strokeStyle = axisColor;
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, margin.top + chartH);
        ctx.lineTo(margin.left + chartW, margin.top + chartH);
        ctx.stroke();
        ctx.restore();

        // Axis labels
        ctx.fillStyle = textColor;
        ctx.font = "11px system-ui, -apple-system, sans-serif";
        ctx.textAlign = "right";
        for (let i = 0; i <= nTicks; i++) {
          const val = maxY - (i / nTicks) * (maxY - minY);
          const y = margin.top + (i / nTicks) * chartH;
          ctx.fillText(val.toPrecision(3), margin.left - 8, y + 4);
        }

        ctx.textAlign = "center";
        const xLabels = Math.floor(chartW / 60);
        for (let i = 0; i <= xLabels; i++) {
          const idx = Math.round((i / xLabels) * (nSteps - 1));
          const x = xScale(idx);
          ctx.fillText(idx + 1, x, margin.top + chartH + 20);
        }

        // Confidence band
        const color = CHART_COLORS[dim % CHART_COLORS.length];
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(hi[0]));
        for (let i = 1; i < nSteps; i++) {
          const x = xScale(i);
          const cx = (xScale(i - 1) + x) / 2;
          ctx.quadraticCurveTo(cx, yScale(hi[i - 1]), x, yScale(hi[i]));
        }
        for (let i = nSteps - 1; i >= 0; i--) {
          const x = xScale(i);
          const cx = i > 0 ? (xScale(i - 1) + x) / 2 : x;
          ctx.quadraticCurveTo(
            cx,
            yScale(lo[i]),
            xScale(Math.max(0, i - 1)),
            yScale(lo[Math.max(0, i - 1)]),
          );
        }
        ctx.closePath();

        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          margin.top + chartH,
        );
        grad.addColorStop(0, color + (isDark ? "26" : "1F"));
        grad.addColorStop(1, color + "0D");
        ctx.fillStyle = grad;
        ctx.fill();

        // Band stroke
        ctx.strokeStyle = color + "66";
        ctx.lineWidth = 1;
        ctx.setLineDash([3, 3]);
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const x = xScale(i);
          i === 0
            ? ctx.moveTo(x, yScale(hi[i]))
            : ctx.lineTo(x, yScale(hi[i]));
        }
        ctx.stroke();
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const x = xScale(i);
          i === 0
            ? ctx.moveTo(x, yScale(lo[i]))
            : ctx.lineTo(x, yScale(lo[i]));
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // Main line with glow
        ctx.strokeStyle = color + "26";
        ctx.lineWidth = 6;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const x = xScale(i);
          const y = yScale(data[i]);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.stroke();

        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let i = 0; i < nSteps; i++) {
          const x = xScale(i);
          const y = yScale(data[i]);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Hover
        if (chartState.hover.idx >= 0) {
          const idx = chartState.hover.idx;
          const x = xScale(idx);
          const y = yScale(data[idx]);

          ctx.strokeStyle = textColor + "80";
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(x, margin.top);
          ctx.lineTo(x, margin.top + chartH);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.setLineDash([]);

          ctx.fillStyle = color + "4D";
          ctx.beginPath();
          ctx.arc(x, y, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();

          showTooltip(
            chartState.hover.x,
            chartState.hover.y,
            idx,
            data[idx],
            lo[idx],
            hi[idx],
            dim,
          );
        }
      }

      function renderGridChart(
        ctx,
        width,
        height,
        preds,
        lower,
        upper,
        isDark,
      ) {
        const nDims = preds[0]?.length || 0;
        const cols = Math.min(5, Math.ceil(Math.sqrt(nDims)));
        const rows = Math.ceil(nDims / cols);
        const cellW = width / cols;
        const cellH = height / rows;
        const padding = 8;

        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x0 = col * cellW + padding;
          const y0 = row * cellH + padding;
          const w = cellW - padding * 2;
          const h = cellH - padding * 2;

          const data = preds.map((p) => p[d]);
          const lo = lower.map((p) => p?.[d] ?? data[0]);
          const hi = upper.map((p) => p?.[d] ?? data[0]);

          const allVals = [...data, ...lo, ...hi];
          let minY = Math.min(...allVals);
          let maxY = Math.max(...allVals);
          const pad = (maxY - minY) * 0.15 || 1;
          minY -= pad;
          maxY += pad;

          const nSteps = data.length;
          const xS = (i) => x0 + (i / (nSteps - 1 || 1)) * w;
          const yS = (v) => y0 + h - ((v - minY) / (maxY - minY)) * h;

          // Background
          ctx.fillStyle = isDark ? "#334155" : "#F8FAFC";
          ctx.fillRect(x0, y0, w, h);
          ctx.strokeStyle = isDark ? "#475569" : "#E2E8F0";
          ctx.lineWidth = 1;
          ctx.strokeRect(x0, y0, w, h);

          const color = CHART_COLORS[d % CHART_COLORS.length];

          // Band
          ctx.fillStyle = color + (isDark ? "26" : "1A");
          ctx.beginPath();
          ctx.moveTo(xS(0), yS(hi[0]));
          for (let i = 1; i < nSteps; i++) ctx.lineTo(xS(i), yS(hi[i]));
          for (let i = nSteps - 1; i >= 0; i--) {
            ctx.lineTo(xS(i), yS(lo[i]));
          }
          ctx.closePath();
          ctx.fill();

          // Line
          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          for (let i = 0; i < nSteps; i++) {
            i === 0
              ? ctx.moveTo(xS(i), yS(data[i]))
              : ctx.lineTo(xS(i), yS(data[i]));
          }
          ctx.stroke();

          // Label
          ctx.fillStyle = isDark ? "#CBD5E1" : "#475569";
          ctx.font = "bold 10px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(`T${d + 1}`, x0 + 4, y0 + 12);

          // Final value
          ctx.textAlign = "right";
          ctx.fillText(
            data[data.length - 1].toFixed(2),
            x0 + w - 4,
            y0 + 12,
          );
        }
      }

      function renderHeatmap(
        ctx,
        margin,
        chartW,
        chartH,
        preds,
        isDark,
        textColor,
      ) {
        const nSteps = preds.length;
        const nDims = preds[0]?.length || 0;
        if (!nDims) return;

        const cellW = chartW / nSteps;
        const cellH = chartH / nDims;

        let minVal = Infinity, maxVal = -Infinity;
        preds.forEach((row) =>
          row.forEach((v) => {
            minVal = Math.min(minVal, v);
            maxVal = Math.max(maxVal, v);
          })
        );

        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < nSteps; s++) {
            const val = preds[s][d];
            const norm = (val - minVal) / (maxVal - minVal || 1);

            let r, g, b;
            if (isDark) {
              r = Math.round(norm * 255);
              g = Math.round(200 + norm * 55);
              b = Math.round(100 + (1 - norm) * 155);
            } else {
              r = Math.round((1 - norm) * 255);
              g = Math.round((1 - norm * 0.5) * 200);
              b = Math.round(norm * 255);
            }

            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(
              margin.left + s * cellW,
              margin.top + d * cellH,
              cellW - 1,
              cellH - 1,
            );
          }
        }

        // Labels
        ctx.fillStyle = textColor;
        ctx.font = "10px system-ui";
        ctx.textAlign = "right";
        for (let d = 0; d < Math.min(nDims, 15); d++) {
          ctx.fillText(
            `T${d + 1}`,
            margin.left - 4,
            margin.top + d * cellH + cellH / 2 + 3,
          );
        }

        ctx.textAlign = "center";
        const stepLabels = Math.min(10, nSteps);
        for (let i = 0; i < stepLabels; i++) {
          const s = Math.round((i / (stepLabels - 1)) * (nSteps - 1));
          ctx.fillText(
            s + 1,
            margin.left + s * cellW + cellW / 2,
            margin.top + chartH + 15,
          );
        }
      }

      function renderUncertainty(
        ctx,
        margin,
        chartW,
        chartH,
        preds,
        lower,
        upper,
        gridColor,
        axisColor,
        textColor,
        isDark,
      ) {
        const nSteps = preds.length;
        const uncertainties = preds.map((p, i) => {
          const bandWidths = p.map((v, d) =>
            (upper[i]?.[d] ?? v) - (lower[i]?.[d] ?? v)
          );
          return bandWidths.reduce((a, b) => a + b, 0) /
            bandWidths.length;
        });

        const minU = Math.min(...uncertainties) * 0.9;
        const maxU = Math.max(...uncertainties) * 1.1 || 1;

        const xScale = (i) =>
          margin.left + (i / (nSteps - 1 || 1)) * chartW;
        const yScale = (v) =>
          margin.top + chartH - ((v - minU) / (maxU - minU)) * chartH;

        // Grid
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        for (let i = 0; i <= 5; i++) {
          const y = margin.top + (i / 5) * chartH;
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(margin.left + chartW, y);
          ctx.stroke();
        }
        ctx.setLineDash([]);

        // Gradient fill
        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          margin.top + chartH,
        );
        grad.addColorStop(0, "#EF444440");
        grad.addColorStop(0.5, "#F59E0B40");
        grad.addColorStop(1, "#10B98140");

        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(xScale(0), margin.top + chartH);
        for (let i = 0; i < nSteps; i++) {
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
        }
        ctx.lineTo(xScale(nSteps - 1), margin.top + chartH);
        ctx.closePath();
        ctx.fill();

        // Line with color gradient
        for (let i = 1; i < nSteps; i++) {
          const norm = (uncertainties[i] - minU) / (maxU - minU);
          const r = Math.round(norm * 239 + (1 - norm) * 16);
          const g = Math.round(norm * 68 + (1 - norm) * 185);
          const b = Math.round(norm * 68 + (1 - norm) * 129);

          ctx.strokeStyle = `rgb(${r},${g},${b})`;
          ctx.lineWidth = 3;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(xScale(i - 1), yScale(uncertainties[i - 1]));
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
          ctx.stroke();
        }

        // Labels
        ctx.fillStyle = textColor;
        ctx.font = "11px system-ui";
        ctx.textAlign = "right";
        for (let i = 0; i <= 5; i++) {
          const val = maxU - (i / 5) * (maxU - minU);
          ctx.fillText(
            val.toFixed(3),
            margin.left - 8,
            margin.top + (i / 5) * chartH + 4,
          );
        }

        // Confidence indicator
        const avgUncert = uncertainties.reduce((a, b) => a + b, 0) /
          uncertainties.length;
        const confidence = Math.max(0, 1 - avgUncert / maxU);

        ctx.fillStyle = isDark ? "#1E293B" : "#FFFFFF";
        ctx.fillRect(
          margin.left + chartW - 120,
          margin.top + 10,
          110,
          50,
        );
        ctx.strokeStyle = isDark ? "#475569" : "#E2E8F0";
        ctx.strokeRect(
          margin.left + chartW - 120,
          margin.top + 10,
          110,
          50,
        );

        ctx.fillStyle = textColor;
        ctx.font = "10px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(
          "Avg Confidence",
          margin.left + chartW - 112,
          margin.top + 24,
        );

        ctx.font = "bold 20px system-ui";
        ctx.fillStyle = confidence > 0.7
          ? "#10B981"
          : confidence > 0.4
          ? "#F59E0B"
          : "#EF4444";
        ctx.fillText(
          (confidence * 100).toFixed(0) + "%",
          margin.left + chartW - 112,
          margin.top + 48,
        );
      }

      function renderBarChart(
        ctx,
        margin,
        chartW,
        chartH,
        preds,
        lower,
        upper,
        isDark,
        textColor,
      ) {
        const stepIdx = Math.min(
          Math.floor(preds.length / 2),
          preds.length - 1,
        );
        const values = preds[stepIdx] || [];
        const nDims = values.length;
        if (!nDims) return;

        const barH = Math.min(30, (chartH - 20) / nDims);
        const gap = 4;

        let minVal = Math.min(...values, ...lower[stepIdx] || []);
        let maxVal = Math.max(...values, ...upper[stepIdx] || []);
        const pad = (maxVal - minVal) * 0.1 || 1;
        minVal -= pad;
        maxVal += pad;

        const xScale = (v) =>
          margin.left + ((v - minVal) / (maxVal - minVal)) * chartW;

        // Zero line
        if (minVal < 0 && maxVal > 0) {
          ctx.strokeStyle = textColor + "40";
          ctx.lineWidth = 1;
          ctx.beginPath();
          const zeroX = xScale(0);
          ctx.moveTo(zeroX, margin.top);
          ctx.lineTo(zeroX, margin.top + nDims * (barH + gap));
          ctx.stroke();
        }

        for (let d = 0; d < nDims; d++) {
          const y = margin.top + d * (barH + gap);
          const val = values[d];
          const lo = lower[stepIdx]?.[d] ?? val;
          const hi = upper[stepIdx]?.[d] ?? val;
          const color = CHART_COLORS[d % CHART_COLORS.length];

          // Error bar
          ctx.strokeStyle = color + "60";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(xScale(lo), y + barH / 2);
          ctx.lineTo(xScale(hi), y + barH / 2);
          ctx.stroke();

          // Whiskers
          ctx.beginPath();
          ctx.moveTo(xScale(lo), y + barH * 0.3);
          ctx.lineTo(xScale(lo), y + barH * 0.7);
          ctx.moveTo(xScale(hi), y + barH * 0.3);
          ctx.lineTo(xScale(hi), y + barH * 0.7);
          ctx.stroke();

          // Main bar
          const barStart = xScale(Math.min(0, val));
          const barEnd = xScale(Math.max(0, val));
          const grad = ctx.createLinearGradient(barStart, 0, barEnd, 0);
          grad.addColorStop(0, color + "CC");
          grad.addColorStop(1, color);
          ctx.fillStyle = grad;
          ctx.beginPath();
          ctx.roundRect(
            barStart,
            y + 4,
            barEnd - barStart,
            barH - 8,
            3,
          );
          ctx.fill();

          // Label
          ctx.fillStyle = textColor;
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(`T${d + 1}`, margin.left - 6, y + barH / 2 + 3);

          // Value
          ctx.textAlign = "left";
          ctx.fillText(
            val.toFixed(3),
            xScale(hi) + 6,
            y + barH / 2 + 3,
          );
        }

        // Step indicator
        ctx.fillStyle = textColor;
        ctx.font = "bold 12px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(
          `Step ${stepIdx + 1}`,
          margin.left + chartW / 2,
          margin.top + chartH - 10,
        );
      }

      function handleChartHover(e) {
        if (!state.predictions || state.currentView !== "focus") {
          chartState.hover = { x: -1, y: -1, idx: -1 };
          return;
        }

        const rect = chartState.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const { margin } = chartState;
        const chartW = chartState.width - margin.left - margin.right;
        const nSteps = state.predictions.predictions.length;

        if (x >= margin.left && x <= margin.left + chartW) {
          const relX = (x - margin.left) / chartW;
          const idx = Math.round(relX * (nSteps - 1));
          chartState.hover = { x: e.clientX, y: e.clientY, idx };
        } else {
          chartState.hover = { x: -1, y: -1, idx: -1 };
        }

        renderChart();
      }

      function showTooltip(x, y, idx, val, lo, hi, dim) {
        const tooltip = $("#chartTooltip");
        const isDark = document.documentElement.classList.contains(
          "dark",
        );

        tooltip.innerHTML = `
    <div class="px-3 py-2 rounded-lg shadow-lg ${
          isDark ? "bg-slate-700 text-white" : "bg-white text-slate-900"
        }" style="min-width: 140px">
      <div class="text-xs text-slate-500 mb-1">Step ${
          idx + 1
        } â€¢ Target ${dim + 1}</div>
      <div class="font-semibold">${val.toFixed(4)}</div>
      <div class="text-xs mt-1">
        <span class="text-slate-500">Range:</span> ${lo.toFixed(3)} â€“ ${
          hi.toFixed(3)
        }
      </div>
      <div class="text-xs">
        <span class="text-slate-500">Width:</span> ${
          (hi - lo).toFixed(4)
        }
      </div>
    </div>
  `;

        const rect = $("#chartContainer").getBoundingClientRect();
        let left = x - rect.left + 15;
        let top = y - rect.top - 30;

        if (left + 160 > chartState.width) left = x - rect.left - 160;
        if (top < 0) top = y - rect.top + 20;

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";
        tooltip.style.opacity = "1";
      }

      function hideTooltip() {
        $("#chartTooltip").style.opacity = "0";
      }

      function updateStats() {
        if (!state.predictions || state.currentView !== "focus") return;

        const dim = state.focusDim;
        const data = state.predictions.predictions.map((p) => p[dim]);
        const lower =
          state.predictions.lowerBounds?.map((p) => p?.[dim]) || data;
        const upper =
          state.predictions.upperBounds?.map((p) => p?.[dim]) || data;

        const min = Math.min(...data);
        const max = Math.max(...data);
        const mean = data.reduce((a, b) => a + b, 0) / data.length;
        const avgBand =
          data.map((v, i) => (upper[i] - lower[i])).reduce(
            (a, b) => a + b,
            0,
          ) / data.length;

        $("#statMin").textContent = min.toFixed(4);
        $("#statMax").textContent = max.toFixed(4);
        $("#statMean").textContent = mean.toFixed(4);
        $("#statConf").textContent = `Â±${(avgBand / 2).toFixed(4)}`;
      }

      // Export Chart
      window.exportChart = () => {
        if (!chartState.canvas) return;
        const link = document.createElement("a");
        link.download = `esn-chart-${
          new Date().toISOString().slice(0, 10)
        }.png`;
        link.href = chartState.canvas.toDataURL("image/png");
        link.click();
        showToast("Chart exported", "success");
      };

      // Zoom Controls
      $("#zoomIn")?.addEventListener("click", () => {
        state.zoom.scale = Math.min(5, state.zoom.scale * 1.2);
        renderChart();
      });
      $("#zoomOut")?.addEventListener("click", () => {
        state.zoom.scale = Math.max(0.5, state.zoom.scale / 1.2);
        renderChart();
      });
      $("#zoomReset")?.addEventListener("click", () => {
        state.zoom = { scale: 1, offsetX: 0, offsetY: 0 };
        renderChart();
      });

      // Event Listeners
      document.addEventListener("DOMContentLoaded", async () => {
        initTheme();
        initChart();

        // Load module
        try {
          await sendWorker("loadModule");
          state.moduleLoaded = true;
          log("Module loaded", "success");
        } catch (e) {
          log("Module load failed", "error", e.message);
          showToast("Module load failed. Check settings.", "warning");
        }

        // Load saved config
        const savedConfig = localStorage.getItem("esn-config");
        if (savedConfig) {
          try {
            state.config = JSON.parse(savedConfig);
          } catch {}
        }

        updateUI();
        renderLogs();
      });

      // Sidebar
      $("#menuBtn").addEventListener("click", () => {
        $("#sidebar").classList.remove("-translate-x-full");
        $("#sidebarOverlay").classList.remove("hidden");
      });
      $("#closeSidebar").addEventListener("click", closeSidebar);
      $("#sidebarOverlay").addEventListener("click", closeSidebar);

      function closeSidebar() {
        $("#sidebar").classList.add("-translate-x-full");
        $("#sidebarOverlay").classList.add("hidden");
      }

      // Theme Toggle
      $("#themeToggle").addEventListener("click", () => {
        state.theme = state.theme === "dark" ? "light" : "dark";
        localStorage.setItem("esn-theme", state.theme);
        initTheme();
        renderChart();
      });

      // Modal backdrop
      $("#modalBackdrop").addEventListener("click", closeModal);

      // Navigation actions
      document.addEventListener("click", (e) => {
        const action = e.target.closest("[data-action]")?.dataset
          .action;
        if (!action) return;

        closeSidebar();

        switch (action) {
          case "openConfig":
            openConfigModal();
            break;
          case "openSaveLoad":
            openSaveLoadModal();
            break;
          case "openUpload":
            openUploadModal();
            break;
          case "openManualInsert":
            openManualInsertModal();
            break;
          case "openRandomTest":
            openRandomTestModal();
            break;
          case "openSettings":
            openSettingsModal();
            break;
          case "quickStart":
            if (!state.moduleLoaded) {
              showToast("Module not loaded", "warning");
              return;
            }
            sendWorker("create", PRESETS.startHere.config).then(() => {
              state.hasModel = true;
              state.config = PRESETS.startHere.config;
              state.samplesProcessed = 0;
              localStorage.setItem(
                "esn-config",
                JSON.stringify(state.config),
              );
              updateUI();
              renderChart();
              log("Model created with Start Here preset", "success");
              showToast(
                "Model created! Upload data or run a test.",
                "success",
              );
            }).catch((e) => showToast("Failed: " + e.message, "error"));
            break;
        }
      });

      // View switching
      $$(".view-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          state.currentView = btn.dataset.view;
          updateViewButtons();
          renderChart();
        });
      });

      // Dimension selector
      $("#dimSelector").addEventListener("change", (e) => {
        state.focusDim = parseInt(e.target.value) || 0;
        renderChart();
      });

      // Prediction buttons
      $("#runPredict").addEventListener("click", runPrediction);
      $("#quickPredict").addEventListener("click", runPrediction);

      // Log filter
      $("#logFilter").addEventListener("change", renderLogs);
      $("#clearLogs").addEventListener("click", () => {
        state.logs = [];
        renderLogs();
      });

      // Cancel progress
      $("#cancelProgress").addEventListener("click", () => {
        sendWorker("cancel", { requestId: state.requestCounter });
        hideProgress();
        showToast("Operation cancelled", "warning");
      });

      // Export
      $("#exportChart").addEventListener("click", exportChart);

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (
          e.target.tagName === "INPUT" ||
          e.target.tagName === "TEXTAREA" ||
          e.target.tagName === "SELECT"
        ) return;

        switch (e.key.toLowerCase()) {
          case "m":
            e.preventDefault();
            $("#menuBtn").click();
            break;
          case "c":
            e.preventDefault();
            openConfigModal();
            break;
          case "u":
            e.preventDefault();
            openUploadModal();
            break;
          case "p":
            e.preventDefault();
            if (!$("#runPredict").disabled) runPrediction();
            break;
          case "escape":
            closeModal();
            closeSidebar();
            break;
        }
      });

      // Focus trap for modals
      $("#modalContainer").addEventListener("keydown", (e) => {
        if (e.key === "Tab") {
          const focusable = $("#modalContent").querySelectorAll(
            'button, input, select, textarea, [tabindex]:not([tabindex="-1"])',
          );
          if (focusable.length === 0) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      });
    </script>
  </body>
</html>
