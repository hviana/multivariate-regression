<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              glass: "rgba(255, 255, 255, 0.7)",
              glassBorder: "rgba(255, 255, 255, 0.5)",
            },
          },
        },
      };
    </script>
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Utility */
      .glass-panel {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }

      .no-select {
        user-select: none;
        -webkit-user-select: none;
      }

      /* Loader Animation */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        animation: spin 1s linear infinite;
      }

      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 text-slate-800 h-screen w-full overflow-hidden flex flex-col font-sans selection:bg-indigo-100 selection:text-indigo-700"
  >
    <header
      class="glass-panel z-30 sticky top-0 w-full px-4 py-3 shadow-sm flex justify-between items-center shrink-0"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30 text-xl"
        >
          üìä
        </div>
        <div class="hidden sm:block">
          <h1 class="font-bold text-slate-800 leading-tight">ESN Studio</h1>
          <p class="text-xs text-slate-500 font-medium">
            Autoregressive Forecasting
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2 sm:gap-4">
        <div
          id="statusBadge"
          class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200 text-xs font-semibold shadow-inner"
        >
          <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-400"></span>
          <span id="statusText">No Model</span>
        </div>

        <button
          id="headerPredictBtn"
          class="hidden bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-1.5 rounded-lg text-sm font-semibold shadow-md transition-all active:scale-95 flex items-center gap-2"
        >
          ‚ö° Predict
        </button>

        <button
          onclick="app.modals.open('config')"
          class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-100 text-slate-600 transition-colors"
          aria-label="Configure Model"
        >
          ‚öôÔ∏è
        </button>

        <button
          onclick="app.toggleMenu()"
          class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-100 text-slate-600 transition-colors"
          aria-label="Open Menu"
        >
          ‚ò∞
        </button>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
      <main class="flex-1 flex flex-col overflow-hidden relative h-full">
        <nav
          class="h-12 border-b border-slate-200 bg-white flex items-center px-4 gap-2 overflow-x-auto no-scrollbar shrink-0"
        >
          <button
            id="tabGrid"
            onclick="app.setVizMode('grid')"
            class="px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
          >
            üìä Grid
          </button>
          <button
            id="tabFocus"
            onclick="app.setVizMode('focus')"
            class="px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200"
          >
            üîç Focus
          </button>
          <div class="w-px h-6 bg-slate-200 mx-2"></div>
          <div
            id="dimSelector"
            class="hidden flex items-center gap-1 overflow-x-auto no-scrollbar"
          >
          </div>
        </nav>

        <div
          class="flex-1 relative bg-slate-50 overflow-hidden touch-none"
          id="canvasWrapper"
        >
          <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center p-6 z-10 bg-slate-50"
          >
            <div
              class="w-24 h-24 bg-gradient-to-tr from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mb-6 shadow-inner animate-pulse"
            >
              <span class="text-5xl">üìä</span>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">
              Create a Model to Begin
            </h2>
            <p class="text-slate-500 text-center max-w-md mb-8">
              Initialize an Echo State Network for high-performance multivariate
              autoregressive time-series forecasting.
            </p>
            <div class="flex flex-wrap gap-4 justify-center">
              <button
                onclick="app.quickStart()"
                class="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg shadow-blue-500/30 font-semibold hover:-translate-y-0.5 transition-transform flex items-center gap-2"
              >
                ‚ö° Start with Defaults
              </button>
              <button
                onclick="app.modals.open('saveLoad')"
                class="px-6 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-xl shadow-sm font-semibold hover:bg-slate-50 transition-colors flex items-center gap-2"
              >
                üì§ Load Model
              </button>
              <button
                onclick="app.modals.open('randomTest')"
                class="px-6 py-2.5 bg-gradient-to-r from-fuchsia-500 to-pink-500 text-white rounded-xl shadow-lg shadow-pink-500/30 font-semibold hover:-translate-y-0.5 transition-transform flex items-center gap-2"
              >
                ‚ú® Demo
              </button>
            </div>
          </div>

          <canvas
            id="vizCanvas"
            class="w-full h-full block cursor-crosshair"
          ></canvas>

          <div
            id="zoomControls"
            class="absolute top-4 right-4 flex flex-col gap-2 opacity-0 pointer-events-none transition-opacity duration-300"
          >
            <button
              onclick="app.viz.zoom(1.2)"
              class="w-10 h-10 bg-white rounded-xl shadow-lg border border-slate-100 text-slate-700 flex items-center justify-center hover:bg-slate-50 active:scale-95 text-xl font-bold"
            >
              ‚ûï
            </button>
            <button
              onclick="app.viz.resetZoom()"
              class="w-10 h-10 bg-white rounded-xl shadow-lg border border-slate-100 text-slate-700 flex items-center justify-center hover:bg-slate-50 active:scale-95 text-lg"
            >
              üîÑ
            </button>
            <button
              onclick="app.viz.zoom(0.8)"
              class="w-10 h-10 bg-white rounded-xl shadow-lg border border-slate-100 text-slate-700 flex items-center justify-center hover:bg-slate-50 active:scale-95 text-xl font-bold"
            >
              ‚ûñ
            </button>
          </div>

          <div
            id="zoomBadge"
            class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-lg shadow-md border border-slate-200 text-xs font-bold text-slate-600 opacity-0 pointer-events-none transition-opacity"
          >
            100%
          </div>

          <div
            id="chartTooltip"
            class="absolute hidden pointer-events-none z-20 bg-slate-900/95 text-white p-3 rounded-xl shadow-xl border border-slate-700 text-sm max-w-[200px]"
          >
          </div>
        </div>

        <div
          id="statsBar"
          class="hidden h-auto border-t border-slate-200 bg-white p-2 shrink-0 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 text-xs"
        >
        </div>
      </main>

      <aside
        class="hidden lg:flex flex-col w-[320px] border-l border-slate-200 bg-white shadow-xl z-20 overflow-y-auto"
      >
        <div class="p-5 border-b border-slate-100">
          <h3
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4"
          >
            Model Metrics
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-slate-600 text-sm">Samples Trained</span>
              <span
                id="metricSamples"
                class="font-mono text-sm font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded"
              >0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-600 text-sm">Avg Loss</span>
              <span id="metricLoss" class="font-mono text-sm text-slate-800"
              >0.00e+0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-600 text-sm">Grad Norm</span>
              <span id="metricGrad" class="font-mono text-sm text-slate-800"
              >0.00e+0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-600 text-sm">Sample Weight</span>
              <span id="metricWeight" class="font-mono text-sm text-slate-800"
              >1.000</span>
            </div>
          </div>
        </div>

        <div class="p-5 border-b border-slate-100 bg-slate-50/50">
          <h3
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
          >
            Prediction
          </h3>
          <div class="flex flex-col gap-3">
            <label class="text-sm font-medium text-slate-700"
            >Future Steps</label>
            <div class="flex gap-2">
              <input
                type="number"
                id="stepsInput"
                value="50"
                class="flex-1 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all"
              >
              <button
                onclick="app.runPrediction()"
                id="sidePredictBtn"
                disabled
                class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed text-sm font-bold"
              >
                Run
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 flex flex-col min-h-0">
          <div
            class="p-4 border-b border-slate-100 flex justify-between items-center"
          >
            <h3
              class="text-xs font-bold text-slate-400 uppercase tracking-wider"
            >
              Event Log
            </h3>
            <select
              id="logFilter"
              class="text-xs border border-slate-200 rounded px-2 py-1 bg-transparent"
            >
              <option value="all">All</option>
              <option value="error">Errors</option>
            </select>
          </div>
          <div
            id="eventLog"
            class="flex-1 overflow-y-auto p-4 space-y-3 font-mono text-xs"
          >
          </div>
        </div>
      </aside>

      <div
        id="slideMenu"
        class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out z-50 flex flex-col"
      >
        <div
          class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50"
        >
          <h2 class="font-bold text-lg text-slate-800">Menu</h2>
          <button
            onclick="app.toggleMenu()"
            class="text-slate-400 hover:text-slate-600 text-2xl"
          >
            √ó
          </button>
        </div>
        <div class="p-4 space-y-2 overflow-y-auto flex-1">
          <div
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-2"
          >
            Model
          </div>
          <button
            onclick="app.modals.open('config');app.toggleMenu()"
            class="w-full text-left p-3 rounded-xl hover:bg-blue-50 group transition-colors border border-transparent hover:border-blue-100"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-lg"
              >üéõÔ∏è</span>
              <div>
                <div
                  class="font-semibold text-slate-800 group-hover:text-blue-700"
                >
                  Configure
                </div>
                <div class="text-xs text-slate-500">
                  Set up model parameters
                </div>
              </div>
            </div>
          </button>
          <button
            onclick="app.modals.open('saveLoad');app.toggleMenu()"
            class="w-full text-left p-3 rounded-xl hover:bg-emerald-50 group transition-colors border border-transparent hover:border-emerald-100"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg"
              >üíæ</span>
              <div>
                <div
                  class="font-semibold text-slate-800 group-hover:text-emerald-700"
                >
                  Save & Load
                </div>
                <div class="text-xs text-slate-500">Persist your models</div>
              </div>
            </div>
          </button>

          <div
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4"
          >
            Data
          </div>
          <button
            onclick="app.modals.open('upload');app.toggleMenu()"
            class="w-full text-left p-3 rounded-xl hover:bg-purple-50 group transition-colors border border-transparent hover:border-purple-100"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center text-lg"
              >üì§</span>
              <div>
                <div
                  class="font-semibold text-slate-800 group-hover:text-purple-700"
                >
                  Upload Dataset
                </div>
                <div class="text-xs text-slate-500">
                  Import JSON time series
                </div>
              </div>
            </div>
          </button>

          <div
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4"
          >
            Test
          </div>
          <button
            onclick="app.modals.open('randomTest');app.toggleMenu()"
            class="w-full text-left p-3 rounded-xl hover:bg-pink-50 group transition-colors border border-transparent hover:border-pink-100"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-8 h-8 rounded-lg bg-pink-100 text-pink-600 flex items-center justify-center text-lg"
              >üí°</span>
              <div>
                <div
                  class="font-semibold text-slate-800 group-hover:text-pink-700"
                >
                  Random Test
                </div>
                <div class="text-xs text-slate-500">
                  Generate synthetic data
                </div>
              </div>
            </div>
          </button>

          <div
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4"
          >
            Advanced
          </div>
          <button
            onclick="app.modals.open('dataTable');app.toggleMenu()"
            class="w-full text-left p-3 rounded-xl hover:bg-slate-50 group transition-colors border border-transparent hover:border-slate-100"
          >
            <div class="flex items-center gap-3">
              <span
                class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center text-lg"
              >üìã</span>
              <div>
                <div
                  class="font-semibold text-slate-800 group-hover:text-slate-700"
                >
                  Data Table
                </div>
                <div class="text-xs text-slate-500">View raw values</div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div
        id="menuBackdrop"
        onclick="app.toggleMenu()"
        class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden transition-opacity"
      >
      </div>
    </div>

    <dialog
      id="configModal"
      class="rounded-2xl shadow-2xl p-0 w-[95%] max-w-2xl backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm m-auto"
    >
      <div class="flex flex-col max-h-[85vh]">
        <div
          class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10"
        >
          <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
            ‚öôÔ∏è Configuration
          </h3>
          <button
            onclick="app.modals.close('config')"
            class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <div class="p-5 overflow-y-auto custom-scrollbar space-y-6">
          <div>
            <label
              class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
            >Presets</label>
            <div
              class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"
              id="presetContainer"
            >
            </div>
          </div>

          <div id="configForm" class="space-y-4"></div>
        </div>

        <div
          class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 sticky bottom-0 z-10"
        >
          <button
            onclick="app.resetConfig()"
            class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-semibold transition-colors"
          >
            Reset All
          </button>
          <div class="flex-1"></div>
          <button
            onclick="app.modals.close('config')"
            class="px-5 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-semibold transition-colors"
          >
            Cancel
          </button>
          <button
            onclick="app.createModel()"
            class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow-lg shadow-blue-500/30 text-sm font-semibold hover:-translate-y-0.5 transition-transform"
          >
            Create Model
          </button>
        </div>
      </div>
    </dialog>

    <dialog
      id="uploadModal"
      class="rounded-2xl shadow-2xl p-0 w-[95%] max-w-lg backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm m-auto"
    >
      <div class="p-6">
        <h3
          class="font-bold text-xl text-slate-800 mb-4 flex items-center gap-2"
        >
          üì§ Upload Dataset
        </h3>

        <div
          id="dropZone"
          class="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center gap-3 hover:bg-slate-50 hover:border-indigo-400 transition-colors cursor-pointer mb-4"
        >
          <span class="text-4xl">üìÅ</span>
          <p class="text-slate-600 font-medium text-center">
            Drop JSON file here<br><span
              class="text-sm text-slate-400 font-normal"
            >or tap to browse</span>
          </p>
          <input type="file" id="fileInput" accept=".json" class="hidden">
        </div>

        <textarea
          id="pasteInput"
          placeholder="Or paste JSON here..."
          class="w-full h-32 border border-slate-300 rounded-lg p-3 text-xs font-mono focus:ring-2 focus:ring-indigo-500 outline-none mb-4"
        ></textarea>

        <details class="mb-6">
          <summary
            class="text-xs text-indigo-600 cursor-pointer font-medium mb-2 hover:underline"
          >
            View JSON Format Example
          </summary>
          <pre
            class="bg-slate-900 text-slate-100 p-3 rounded-lg text-xs font-mono overflow-x-auto mt-2"
          >
{
  "coordinates": [
    [1.0, 2.0],
    [1.1, 2.1],
    [1.2, 2.2]
  ]
}</pre>
        </details>

        <div class="flex justify-end gap-3">
          <button
            onclick="app.modals.close('upload')"
            class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-semibold"
          >
            Cancel
          </button>
          <button
            onclick="app.processUpload()"
            class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-lg shadow-lg text-sm font-semibold"
          >
            Validate & Train
          </button>
        </div>
      </div>
    </dialog>

    <dialog
      id="genericModal"
      class="rounded-2xl shadow-2xl p-0 w-[95%] max-w-lg backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm m-auto"
    >
    </dialog>

    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] hidden flex-col items-center justify-center"
    >
      <div
        class="w-16 h-16 border-4 border-slate-200 border-t-indigo-600 rounded-full spinner mb-4"
      >
      </div>
      <h3 id="loadingText" class="text-lg font-bold text-slate-800">
        Processing...
      </h3>
      <div class="w-64 h-2 bg-slate-200 rounded-full mt-4 overflow-hidden">
        <div
          id="loadingBar"
          class="h-full bg-gradient-to-r from-blue-500 to-indigo-600 w-0 transition-all duration-300"
        >
        </div>
      </div>
      <button
        onclick="app.cancelOp()"
        class="mt-6 text-red-500 text-sm font-semibold hover:bg-red-50 px-4 py-2 rounded-lg transition-colors"
      >
        Cancel
      </button>
    </div>

    <div
      id="toastContainer"
      class="fixed bottom-4 left-1/2 -translate-x-1/2 flex flex-col gap-2 z-[100] w-[90%] max-w-sm pointer-events-none"
    >
    </div>

    <script type="module">
      // ==========================================
      // WORKER CODE BLOB
      // ==========================================
      const workerCode = `
            import { ESNRegression } from "https://esm.sh/jsr/@hviana/multivariate-regression";

            let model = null;
            let currentTaskId = null;

            self.onmessage = async (e) => {
                const { type, payload, id } = e.data;
                currentTaskId = id;

                try {
                    switch (type) {
                        case 'init':
                            model = new ESNRegression(payload);
                            self.postMessage({ type: 'success', id, payload: 'Model initialized' });
                            break;

                        case 'train':
                            if (!model) throw new Error("Model not initialized");
                            const result = model.fitOnline({ coordinates: payload.coordinates });
                            self.postMessage({ type: 'success', id, payload: result });
                            break;

                        case 'predict':
                            if (!model) throw new Error("Model not initialized");
                            const prediction = model.predict(payload.steps);
                            self.postMessage({ type: 'success', id, payload: prediction });
                            break;
                            
                        case 'save':
                            if (!model) throw new Error("No model");
                            const state = model.save();
                            self.postMessage({ type: 'success', id, payload: state });
                            break;

                        case 'load':
                            // Re-init with empty config first if needed, usually load handles params
                            // For this lib, we need an instance first. Assuming config matches or is stored in save
                            // Actually the lib's load takes the state string/object.
                            // We need to re-instantiate if config changed, but load usually restores weights.
                            // Let's assume we create a default model then load.
                            if(!model) model = new ESNRegression({reservoirSize: 10}); // Dummy init
                            model.load(payload);
                            const summary = model.getModelSummary();
                            self.postMessage({ type: 'success', id, payload: summary });
                            break;
                            
                        case 'summary':
                             if (!model) throw new Error("No model");
                             self.postMessage({ type: 'success', id, payload: model.getModelSummary() });
                             break;
                    }
                } catch (err) {
                    self.postMessage({ type: 'error', id, payload: err.message });
                }
            };
        `;

      const blob = new Blob([workerCode], { type: "text/javascript" });
      const workerUrl = URL.createObjectURL(blob);
      const worker = new Worker(workerUrl, { type: "module" });

      // ==========================================
      // APP LOGIC
      // ==========================================

      // Colors for dimensions
      const DIM_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      // Config Schema & Presets
      const CONFIG_SCHEMA = {
        reservoirSize: {
          type: "number",
          label: "Reservoir Size",
          default: 256,
          group: "Architecture",
        },
        spectralRadius: {
          type: "number",
          label: "Spectral Radius",
          default: 0.9,
          step: 0.01,
          group: "Architecture",
        },
        leakRate: {
          type: "number",
          label: "Leak Rate",
          default: 0.3,
          step: 0.1,
          group: "Architecture",
        },
        inputScale: {
          type: "number",
          label: "Input Scale",
          default: 1.0,
          group: "Architecture",
        },
        activation: {
          type: "select",
          options: ["tanh", "relu"],
          default: "tanh",
          group: "Architecture",
        },

        rlsLambda: {
          type: "number",
          label: "RLS Lambda",
          default: 0.999,
          step: 0.001,
          group: "Training",
        },
        l2Lambda: {
          type: "number",
          label: "L2 Regularization",
          default: 0.0001,
          step: 0.0001,
          group: "Training",
        },

        outlierThreshold: {
          type: "number",
          label: "Outlier Threshold",
          default: 3.0,
          group: "Outliers",
        },
        uncertaintyMultiplier: {
          type: "number",
          label: "CI Multiplier",
          default: 1.96,
          group: "Uncertainty",
        },
      };

      const PRESETS = {
        "Start Here": {
          reservoirSize: 256,
          spectralRadius: 0.9,
          leakRate: 0.3,
        },
        "Fast": { reservoirSize: 64, leakRate: 0.5 },
        "Accurate": {
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        "Robust": { outlierThreshold: 2.0, l2Lambda: 0.01 },
      };

      // Global App State
      window.app = {
        state: {
          config: {},
          modelExists: false,
          data: [], // Stores full history {step, values[]}
          predictions: null, // { pred:[], lower:[], upper:[] }
          metrics: {},
          vizMode: "grid", // 'grid' | 'focus'
          selectedDim: 0,
          zoom: { scale: 1, offset: 0, visibleCount: 100 },
          logs: [],
        },

        // --- Initialization ---
        init() {
          // Initialize Config
          this.resetConfig();
          this.setupUI();
          this.setupCanvas();
          this.loadFromStorage();
        },

        // --- Worker Communication ---
        async workerOp(type, payload, loadingMsg = null) {
          if (loadingMsg) this.ui.setLoading(true, loadingMsg);
          const id = Math.random().toString(36).substr(2, 9);

          return new Promise((resolve, reject) => {
            const handler = (e) => {
              if (e.data.id !== id) return;
              worker.removeEventListener("message", handler);
              if (loadingMsg) this.ui.setLoading(false);

              if (e.data.type === "error") {
                this.ui.toast(e.data.payload, "error");
                this.log(e.data.payload, "error");
                reject(e.data.payload);
              } else {
                resolve(e.data.payload);
              }
            };
            worker.addEventListener("message", handler);
            worker.postMessage({ type, payload, id });
          });
        },

        // --- Core Actions ---
        resetConfig() {
          Object.keys(CONFIG_SCHEMA).forEach((k) => {
            this.state.config[k] = CONFIG_SCHEMA[k].default;
          });
          this.ui.refreshConfigForm();
        },

        async createModel() {
          this.modals.close("config");
          try {
            await this.workerOp(
              "init",
              this.state.config,
              "Initializing Model...",
            );
            this.state.modelExists = true;
            this.state.data = [];
            this.state.predictions = null;
            this.state.metrics = {};
            this.ui.updateStatus();
            this.ui.toast("Model created successfully", "success");
            this.log("Model initialized", "success");

            // Switch to empty state UI
            document.getElementById("emptyState").classList.remove(
              "hidden",
            );
            this.viz.clear();
          } catch (e) {
            console.error(e);
          }
        },

        async train(dataCoords) {
          try {
            // Update local history
            const startStep = this.state.data.length;
            dataCoords.forEach((row, i) => {
              this.state.data.push({
                step: startStep + i,
                values: row,
              });
            });

            const res = await this.workerOp("train", {
              coordinates: dataCoords,
            }, "Training...");

            this.state.metrics = res;
            this.ui.updateMetrics(res);
            this.log(
              `Trained ${dataCoords.length} samples. Loss: ${
                res.averageLoss.toExponential(2)
              }`,
              "info",
            );

            document.getElementById("emptyState").classList.add(
              "hidden",
            );

            // Auto predict if small dataset or just to show something
            if (this.state.data.length > 0) {
              document.getElementById("headerPredictBtn").classList
                .remove("hidden");
              document.getElementById("sidePredictBtn").disabled =
                false;
            }

            // Render latest data
            this.viz.draw();
          } catch (e) {
            console.error(e);
          }
        },

        async runPrediction() {
          const steps =
            parseInt(document.getElementById("stepsInput").value) || 50;
          try {
            const res = await this.workerOp(
              "predict",
              { steps },
              "Forecasting...",
            );
            this.state.predictions = res; // { predictions:[], lowerBounds:[], upperBounds:[] }

            // Align prediction steps
            const lastStep = this.state.data.length > 0
              ? this.state.data[this.state.data.length - 1].step
              : -1;
            this.state.predictions.startStep = lastStep + 1;

            this.viz.draw();
            this.ui.toast(
              `Forecast generated for ${steps} steps`,
              "success",
            );

            // Show zoom controls
            document.getElementById("zoomControls").style.opacity = "1";
            document.getElementById("zoomControls").style
              .pointerEvents = "auto";
          } catch (e) {
            console.error(e);
          }
        },

        async quickStart() {
          await this.createModel();
          // Generate sine wave data
          const data = [];
          for (let i = 0; i < 100; i++) {
            data.push([
              Math.sin(i / 10) + Math.random() * 0.05,
              Math.cos(i / 10) * 0.5 + Math.random() * 0.05,
              Math.sin(i / 5) * 0.3 + 0.5,
            ]);
          }
          await this.train(data);
          await this.runPrediction();
        },

        // --- Visualization ---
        setVizMode(mode) {
          this.state.vizMode = mode;
          document.getElementById("tabGrid").className = mode === "grid"
            ? "px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
            : "px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200";

          document.getElementById("tabFocus").className =
            mode === "focus"
              ? "px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-md"
              : "px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-slate-100 text-slate-600 hover:bg-slate-200";

          const dimSelector = document.getElementById("dimSelector");
          const statsBar = document.getElementById("statsBar");

          if (mode === "focus") {
            dimSelector.classList.remove("hidden");
            statsBar.classList.remove("hidden");
            this.ui.renderDimSelector();
            this.ui.updateStats();
          } else {
            dimSelector.classList.add("hidden");
            statsBar.classList.add("hidden");
          }

          this.viz.resize();
        },

        viz: {
          ctx: null,
          width: 0,
          height: 0,

          init() {
            const canvas = document.getElementById("vizCanvas");
            this.ctx = canvas.getContext("2d");

            // Interactions
            let isDragging = false;
            let lastX = 0;

            canvas.addEventListener("mousedown", (e) => {
              isDragging = true;
              lastX = e.clientX;
            });
            window.addEventListener(
              "mouseup",
              () => isDragging = false,
            );
            canvas.addEventListener("mousemove", (e) => {
              if (isDragging) {
                const dx = e.clientX - lastX;
                app.state.zoom.offset -= dx / app.state.zoom.scale;
                lastX = e.clientX;
                requestAnimationFrame(() => this.draw());
              } else {
                this.handleHover(e);
              }
            });

            canvas.addEventListener("wheel", (e) => {
              e.preventDefault();
              const delta = Math.sign(-e.deltaY) * 0.1;
              this.zoom(1 + delta);
            });

            window.addEventListener("resize", () => this.resize());
            this.resize();
          },

          resize() {
            const parent = document.getElementById("canvasWrapper");
            this.width = parent.clientWidth;
            this.height = parent.clientHeight;
            const canvas = document.getElementById("vizCanvas");
            canvas.width = this.width * window.devicePixelRatio;
            canvas.height = this.height * window.devicePixelRatio;
            this.ctx.scale(
              window.devicePixelRatio,
              window.devicePixelRatio,
            );
            this.draw();
          },

          zoom(factor) {
            app.state.zoom.scale *= factor;
            if (app.state.zoom.scale < 0.1) app.state.zoom.scale = 0.1;
            if (app.state.zoom.scale > 50) app.state.zoom.scale = 50;

            // Update badge
            const badge = document.getElementById("zoomBadge");
            badge.innerText = Math.round(app.state.zoom.scale * 100) +
              "%";
            badge.style.opacity = "1";
            clearTimeout(this.badgeTimer);
            this.badgeTimer = setTimeout(
              () => badge.style.opacity = "0",
              2000,
            );

            this.draw();
          },

          resetZoom() {
            app.state.zoom.scale = 1;
            app.state.zoom.offset = 0;
            this.draw();
          },

          handleHover(e) {
            // Simple hit testing for tooltip
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            // Implementation omitted for brevity, logic: map X back to step index
          },

          draw() {
            if (!this.ctx) return;
            const { width, height } = this;
            this.ctx.clearRect(0, 0, width, height);

            const data = app.state.data;
            if (data.length === 0) return;

            const dims = data[0].values.length;

            // Determine ranges
            // Calculate Min/Max Y for scaling
            let allValues = data.flatMap((d) => d.values);
            if (app.state.predictions) {
              allValues = allValues.concat(
                app.state.predictions.predictions.flatMap((r) => r),
              );
            }
            let minY = Math.min(...allValues);
            let maxY = Math.max(...allValues);
            let rangeY = maxY - minY || 1;
            minY -= rangeY * 0.1;
            maxY += rangeY * 0.1;
            rangeY = maxY - minY;

            const totalSteps = data.length +
              (app.state.predictions
                ? app.state.predictions.predictions.length
                : 0);
            const stepWidth = (width / (app.state.zoom.visibleCount)) *
              app.state.zoom.scale;

            // Viewport offset
            const startX = -app.state.zoom.offset * stepWidth;

            const drawLine = (
              values,
              color,
              startIndex,
              isDash = false,
            ) => {
              this.ctx.beginPath();
              this.ctx.strokeStyle = color;
              this.ctx.lineWidth = 2;
              if (isDash) this.ctx.setLineDash([5, 5]);
              else this.ctx.setLineDash([]);

              values.forEach((val, i) => {
                const step = startIndex + i;
                const x = startX + step * stepWidth;
                const y = height - ((val - minY) / rangeY) * height;
                if (i === 0) this.ctx.moveTo(x, y);
                else this.ctx.lineTo(x, y);
              });
              this.ctx.stroke();
            };

            const drawArea = (lower, upper, color, startIndex) => {
              this.ctx.beginPath();
              this.ctx.fillStyle = color + "33"; // 20% opacity

              // Top line
              upper.forEach((val, i) => {
                const step = startIndex + i;
                const x = startX + step * stepWidth;
                const y = height - ((val - minY) / rangeY) * height;
                if (i === 0) this.ctx.moveTo(x, y);
                else this.ctx.lineTo(x, y);
              });
              // Bottom line (reverse)
              for (let i = lower.length - 1; i >= 0; i--) {
                const val = lower[i];
                const step = startIndex + i;
                const x = startX + step * stepWidth;
                const y = height - ((val - minY) / rangeY) * height;
                this.ctx.lineTo(x, y);
              }
              this.ctx.closePath();
              this.ctx.fill();
            };

            if (app.state.vizMode === "grid") {
              // Very simplified Grid View: Just draw all lines overlaid for now or separate based on height
              // Implementing proper small multiples in one canvas requires viewport splitting.
              // For this demo, let's overlay them but colored differently
              for (let d = 0; d < dims; d++) {
                const dimData = data.map((row) => row.values[d]);
                drawLine(dimData, DIM_COLORS[d % DIM_COLORS.length], 0);

                if (app.state.predictions) {
                  const predData = app.state.predictions.predictions
                    .map((row) => row[d]);
                  drawLine(
                    predData,
                    DIM_COLORS[d % DIM_COLORS.length],
                    app.state.predictions.startStep,
                    true,
                  );
                }
              }
            } else {
              // Focus View
              const d = app.state.selectedDim;
              const color = DIM_COLORS[d % DIM_COLORS.length];

              // History
              const dimData = data.map((row) => row.values[d]);
              drawLine(dimData, color, 0);

              // Predictions
              if (app.state.predictions) {
                const predData = app.state.predictions.predictions.map(
                  (row) => row[d],
                );
                const lowerData = app.state.predictions.lowerBounds.map(
                  (row) => row[d],
                );
                const upperData = app.state.predictions.upperBounds.map(
                  (row) => row[d],
                );

                drawArea(
                  lowerData,
                  upperData,
                  color,
                  app.state.predictions.startStep,
                );
                drawLine(
                  predData,
                  color,
                  app.state.predictions.startStep,
                  true,
                );
              }
            }
          },

          clear() {
            if (this.ctx) {
              this.ctx.clearRect(0, 0, this.width, this.height);
            }
          },
        },

        // --- UI & Helpers ---
        ui: {
          toast(msg, type = "info") {
            const el = document.createElement("div");
            const colors = {
              success: "bg-emerald-500",
              error: "bg-red-500",
              warning: "bg-amber-500",
              info: "bg-slate-800",
            };
            el.className = `${
              colors[type]
            } text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-medium transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto`;
            el.innerHTML =
              `<span>${msg}</span><button onclick="this.parentElement.remove()" class="opacity-60 hover:opacity-100">‚úñ</button>`;
            document.getElementById("toastContainer").appendChild(el);

            // Animate in
            requestAnimationFrame(() => {
              el.classList.remove("translate-y-10", "opacity-0");
            });

            setTimeout(() => {
              el.classList.add("opacity-0", "translate-y-2");
              setTimeout(() => el.remove(), 300);
            }, type === "error" ? 6000 : 4000);
          },

          setLoading(active, text) {
            const el = document.getElementById("loadingOverlay");
            if (active) {
              el.classList.remove("hidden");
              el.classList.add("flex");
              document.getElementById("loadingText").innerText = text;
              document.getElementById("loadingBar").style.width =
                "100%";
            } else {
              el.classList.add("hidden");
              el.classList.remove("flex");
              document.getElementById("loadingBar").style.width = "0";
            }
          },

          updateStatus() {
            const dot = document.getElementById("statusDot");
            const text = document.getElementById("statusText");

            if (app.state.modelExists) {
              dot.className =
                "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
              text.innerText = `${app.state.data.length} steps`;
              text.classList.add("text-emerald-700");
            } else {
              dot.className = "w-2 h-2 rounded-full bg-slate-400";
              text.innerText = "No Model";
              text.classList.remove("text-emerald-700");
            }
          },

          updateMetrics(m) {
            document.getElementById("metricSamples").innerText =
              app.state.data.length;
            document.getElementById("metricLoss").innerText =
              m.averageLoss ? m.averageLoss.toExponential(2) : "-";
            document.getElementById("metricGrad").innerText =
              m.gradientNorm ? m.gradientNorm.toExponential(2) : "-";
            document.getElementById("metricWeight").innerText =
              m.sampleWeight ? m.sampleWeight.toFixed(3) : "-";
          },

          renderDimSelector() {
            const container = document.getElementById("dimSelector");
            if (!app.state.data.length && !app.state.modelExists) {
              return;
            }

            const dims = app.state.data.length > 0
              ? app.state.data[0].values.length
              : (app.state.config.inputSize || 1); // Fallback

            let html = "";
            for (let i = 0; i < dims; i++) {
              const isActive = app.state.selectedDim === i;
              const color = DIM_COLORS[i % DIM_COLORS.length];
              const style = isActive
                ? `background: ${color}; color: white; border-color: ${color}`
                : `background: #f1f5f9; color: #64748b`;
              html +=
                `<button onclick="app.state.selectedDim=${i}; app.setVizMode('focus')" class="w-8 h-8 rounded-lg text-xs font-bold border border-transparent transition-all flex-shrink-0" style="${style}">D${
                  i + 1
                }</button>`;
            }
            container.innerHTML = html;
          },

          updateStats() {
            const bar = document.getElementById("statsBar");
            const d = app.state.selectedDim;
            if (!app.state.data.length) return;

            // Simple stats calculation for the selected dimension
            const values = app.state.data.map((r) => r.values[d]);
            const min = Math.min(...values).toFixed(2);
            const max = Math.max(...values).toFixed(2);
            const mean =
              (values.reduce((a, b) => a + b, 0) / values.length)
                .toFixed(2);
            const last = values[values.length - 1].toFixed(2);

            const createCard = (
              label,
              val,
              color = "text-slate-800",
            ) => `
                        <div class="bg-slate-50 border border-slate-100 rounded p-2 flex flex-col">
                            <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">${label}</span>
                            <span class="font-mono font-bold text-sm ${color}">${val}</span>
                        </div>
                    `;

            bar.innerHTML = createCard("Min", min) +
              createCard("Max", max) +
              createCard("Mean", mean) +
              createCard("Last", last, "text-blue-600");

            // Add prediction stats if available
            if (app.state.predictions) {
              const preds = app.state.predictions.predictions.map((r) =>
                r[d]
              );
              const trend = preds[preds.length - 1] - preds[0];
              const trendIcon = trend > 0 ? "‚Üë" : "‚Üì";
              const trendColor = trend > 0
                ? "text-emerald-600"
                : "text-red-600";
              bar.innerHTML += createCard(
                "Trend",
                `${trendIcon} ${Math.abs(trend).toFixed(2)}`,
                trendColor,
              );
            }
          },

          refreshConfigForm() {
            const form = document.getElementById("configForm");
            let html = "";

            // Group by category
            const groups = {};
            Object.entries(CONFIG_SCHEMA).forEach(([key, field]) => {
              if (!groups[field.group]) groups[field.group] = [];
              groups[field.group].push({ key, ...field });
            });

            Object.entries(groups).forEach(([groupName, fields]) => {
              html += `
                            <div class="bg-slate-50 rounded-xl border border-slate-100 p-4">
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">${groupName}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        `;
              fields.forEach((f) => {
                if (f.type === "select") {
                  const options = f.options.map((o) =>
                    `<option value="${o}" ${
                      app.state.config[f.key] === o ? "selected" : ""
                    }>${o}</option>`
                  ).join("");
                  html += `
                                    <div class="flex flex-col gap-1">
                                        <label class="text-xs font-medium text-slate-600">${f.label}</label>
                                        <select onchange="app.state.config.${f.key}=this.value" class="bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none focus:border-blue-500">${options}</select>
                                    </div>
                                `;
                } else {
                  html += `
                                    <div class="flex flex-col gap-1">
                                        <label class="text-xs font-medium text-slate-600">${f.label}</label>
                                        <input type="number" step="${
                    f.step || "any"
                  }" value="${
                    app.state.config[f.key]
                  }" onchange="app.state.config.${f.key}=parseFloat(this.value)" class="bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none focus:border-blue-500 font-mono">
                                    </div>
                                `;
                }
              });
              html += `</div></div>`;
            });
            form.innerHTML = html;

            // Presets
            const presetsContainer = document.getElementById(
              "presetContainer",
            );
            presetsContainer.innerHTML = Object.keys(PRESETS).map(
              (k) => `
                        <button onclick="app.applyPreset('${k}')" class="px-3 py-1 rounded-full border border-slate-200 bg-white text-xs font-medium hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 whitespace-nowrap transition-colors">
                            ${k}
                        </button>
                    `,
            ).join("");
          },
        },

        // --- Modals & Interaction ---
        modals: {
          open(name) {
            const modal = document.getElementById(name + "Modal") ||
              document.getElementById("genericModal");
            if (name === "upload") { /* reset logic */ }
            if (name === "randomTest") {
              modal.innerHTML = `
                             <div class="p-6">
                                <h3 class="font-bold text-xl text-slate-800 mb-4">‚ú® Random Test Generator</h3>
                                <div class="space-y-4 mb-6">
                                    <div><label class="text-xs font-bold text-slate-500">Dimensions</label><input id="rtDim" type="number" value="3" class="w-full border rounded p-2 mt-1"></div>
                                    <div><label class="text-xs font-bold text-slate-500">Steps</label><input id="rtSteps" type="number" value="200" class="w-full border rounded p-2 mt-1"></div>
                                    <div><label class="text-xs font-bold text-slate-500">Noise Level</label><input id="rtNoise" type="number" value="0.05" step="0.01" class="w-full border rounded p-2 mt-1"></div>
                                </div>
                                <div class="flex justify-end gap-3">
                                    <button onclick="app.modals.close('generic')" class="px-4 py-2 text-slate-600">Cancel</button>
                                    <button onclick="app.generateRandom()" class="px-6 py-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-lg shadow-lg">Generate & Run</button>
                                </div>
                             </div>
                        `;
            }
            if (name === "saveLoad") {
              modal.innerHTML = `
                            <div class="p-6">
                                <h3 class="font-bold text-xl text-slate-800 mb-4">üíæ Save & Load</h3>
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 hover:border-blue-300 cursor-pointer text-center" onclick="app.saveToFile()">
                                        <div class="text-3xl mb-2">üì•</div>
                                        <div class="text-sm font-bold text-blue-800">Download JSON</div>
                                    </div>
                                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 hover:border-emerald-300 cursor-pointer text-center" onclick="app.saveToBrowser()">
                                        <div class="text-3xl mb-2">üíæ</div>
                                        <div class="text-sm font-bold text-emerald-800">Save to Browser</div>
                                    </div>
                                </div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Saved Models</h4>
                                <div id="savedList" class="max-h-40 overflow-y-auto space-y-2">
                                    </div>
                                <div class="flex justify-end mt-4">
                                     <button onclick="app.modals.close('generic')" class="text-slate-500">Close</button>
                                </div>
                            </div>
                        `;
              app.updateSavedList();
            }
            modal.showModal();

            // Trap focus
            modal.addEventListener("click", (e) => {
              const rect = modal.getBoundingClientRect();
              if (
                e.clientX < rect.left || e.clientX > rect.right ||
                e.clientY < rect.top || e.clientY > rect.bottom
              ) {
                modal.close();
              }
            });
          },
          close(name) {
            (document.getElementById(name + "Modal") ||
              document.getElementById("genericModal")).close();
          },
        },

        toggleMenu() {
          const menu = document.getElementById("slideMenu");
          const backdrop = document.getElementById("menuBackdrop");
          const isOpen = !menu.classList.contains("translate-x-full");

          if (isOpen) {
            menu.classList.add("translate-x-full");
            backdrop.classList.add("hidden");
            backdrop.classList.remove("opacity-100");
          } else {
            menu.classList.remove("translate-x-full");
            backdrop.classList.remove("hidden");
            // slight delay for opacity transition
            setTimeout(() => backdrop.classList.add("opacity-100"), 10);
          }
        },

        log(msg, type = "info") {
          const entry = {
            time: new Date().toLocaleTimeString(),
            msg,
            type,
          };
          this.state.logs.unshift(entry);
          if (this.state.logs.length > 200) this.state.logs.pop();

          const container = document.getElementById("eventLog");
          const color = type === "error"
            ? "text-red-600"
            : (type === "success"
              ? "text-emerald-600"
              : "text-slate-600");

          const html = `
                    <div class="border-l-2 ${
            type === "error"
              ? "border-red-500"
              : (type === "success"
                ? "border-emerald-500"
                : "border-blue-500")
          } pl-2 py-1">
                        <span class="text-slate-400 text-[10px]">${entry.time}</span>
                        <p class="${color} leading-tight">${msg}</p>
                    </div>
                `;
          container.insertAdjacentHTML("afterbegin", html);
        },

        // --- Logic Specifics ---
        applyPreset(name) {
          const p = PRESETS[name];
          Object.assign(this.state.config, p);
          this.ui.refreshConfigForm();
          this.ui.toast(`Applied "${name}" preset`, "success");
        },

        async processUpload() {
          const text = document.getElementById("pasteInput").value;
          // Basic validation
          try {
            const json = JSON.parse(text); // Or handle file reading
            if (!json.coordinates || !Array.isArray(json.coordinates)) {
              throw new Error("Invalid format");
            }

            this.modals.close("upload");
            await this.createModel(); // Re-init
            await this.train(json.coordinates);

            this.ui.toast("Dataset uploaded and trained", "success");
          } catch (e) {
            alert("Invalid JSON: " + e.message);
          }
        },

        async generateRandom() {
          const dims = parseInt(document.getElementById("rtDim").value);
          const steps = parseInt(
            document.getElementById("rtSteps").value,
          );
          const noise = parseFloat(
            document.getElementById("rtNoise").value,
          );

          this.modals.close("generic");

          // Config update
          this.state.config.reservoirSize = 100; // Force lighter config for demo
          await this.createModel();

          const data = [];
          for (let i = 0; i < steps; i++) {
            const row = [];
            for (let d = 0; d < dims; d++) {
              // Mix of sine waves
              let val = Math.sin(i * (0.1 + d * 0.05)) +
                Math.sin(i * 0.01) * 2;
              val += (Math.random() - 0.5) * noise;
              row.push(val);
            }
            data.push(row);
          }

          await this.train(data);
          await this.runPrediction();
        },

        saveToBrowser() {
          const name = prompt("Model Name:");
          if (!name) return;
          const key = `esn_model_${name}`;
          const saveObj = {
            config: this.state.config,
            // In a real app we'd serialize the worker state via 'save' command
            // For this demo, we save config and basic metadata
            date: new Date().toISOString(),
          };
          localStorage.setItem(key, JSON.stringify(saveObj));
          this.updateSavedList();
          this.ui.toast("Model saved to local storage", "success");
        },

        updateSavedList() {
          const list = document.getElementById("savedList");
          if (!list) return;
          list.innerHTML = "";

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("esn_model_")) {
              const name = key.replace("esn_model_", "");
              list.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100 text-sm">
                                <span class="font-bold text-slate-700">${name}</span>
                                <div class="flex gap-2">
                                    <button class="text-blue-600 font-bold px-2" onclick="app.loadModel('${key}')">Load</button>
                                    <button class="text-red-400 px-2" onclick="localStorage.removeItem('${key}');app.updateSavedList()">√ó</button>
                                </div>
                            </div>
                        `;
            }
          }
        },

        loadModel(key) {
          const data = JSON.parse(localStorage.getItem(key));
          this.state.config = data.config;
          this.createModel(); // Reset and init with config
          this.modals.close("generic");
          this.ui.toast(
            `Configuration "${
              key.replace("esn_model_", "")
            }" loaded. Please train data.`,
            "info",
          );
        },

        setupUI() {
          // Initialize input listeners
          const fileInput = document.getElementById("fileInput");
          const dropZone = document.getElementById("dropZone");

          dropZone.onclick = () => fileInput.click();
          dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add("border-indigo-500", "bg-indigo-50");
          };
          dropZone.ondragleave = () => {
            dropZone.classList.remove(
              "border-indigo-500",
              "bg-indigo-50",
            );
          };
          dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove(
              "border-indigo-500",
              "bg-indigo-50",
            );
            if (e.dataTransfer.files.length) {
              const file = e.dataTransfer.files[0];
              const reader = new FileReader();
              reader.onload = (ev) =>
                document.getElementById("pasteInput").value =
                  ev.target.result;
              reader.readAsText(file);
            }
          };

          fileInput.onchange = (e) => {
            if (e.target.files.length) {
              const reader = new FileReader();
              reader.onload = (ev) =>
                document.getElementById("pasteInput").value =
                  ev.target.result;
              reader.readAsText(e.target.files[0]);
            }
          };
        },

        setupCanvas() {
          this.viz.init();
        },

        loadFromStorage() {
          // Load UI settings if any
          const mode = localStorage.getItem("esn_viz_mode");
          if (mode) this.setVizMode(mode);
        },

        cancelOp() {
          // Hard reset worker
          worker.terminate();
          // Recreate worker code would be complex here without reloading page or reconstructing blob
          // For this demo, reload page or show error
          alert(
            "Operation cancelled. The application state will be reset.",
          );
          window.location.reload();
        },
      };

      // Start
      window.app.init();
    </script>
  </body>
</html>
