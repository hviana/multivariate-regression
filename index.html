<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div id="app"></div>

    <script>
      // ================================================================================
      // STATE MANAGEMENT
      // ================================================================================

      const DIMENSION_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        default: { ...DEFAULT_CONFIG },
        fast: {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        balanced: {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        accurate: {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      let state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 0,
        logs: [],
        metrics: {
          samplesProcessed: 0,
          averageLoss: 0,
          gradientNorm: 0,
          driftDetected: false,
          sampleWeight: 1.0,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: {
          active: false,
          x: 0,
          y: 0,
          dataIndex: -1,
        },
        futureSteps: 50,
        isLoading: false,
        loadingText: "",
        loadingProgress: 0,
        menuOpen: false,
        activeModal: null,
        logFilter: "all",
        logSearch: "",
        currentRequestId: null,
      };

      // Load persisted state
      try {
        const saved = localStorage.getItem("esn_studio_state");
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed.config) {
            state.config = { ...DEFAULT_CONFIG, ...parsed.config };
          }
          if (parsed.vizMode) state.vizMode = parsed.vizMode;
        }
      } catch (e) {
        console.warn("Failed to load persisted state:", e);
      }

      function persistState() {
        try {
          localStorage.setItem(
            "esn_studio_state",
            JSON.stringify({
              config: state.config,
              vizMode: state.vizMode,
            }),
          );
        } catch (e) {
          console.warn("Failed to persist state:", e);
        }
      }

      // ================================================================================
      // WEB WORKER
      // ================================================================================

      let worker = null;
      let requestIdCounter = 0;
      const pendingRequests = new Map();

      function createWorker() {
        const workerCode = `
            let ESNRegression = null;
            let model = null;
            let currentRequestId = null;
            let cancelled = false;

            self.onmessage = async function(e) {
                const { type, data, requestId } = e.data;
                currentRequestId = requestId;
                cancelled = false;

                try {
                    switch (type) {
                        case 'init':
                            try {
                                const module = await import(data.moduleUrl);
                                ESNRegression = module.ESNRegression;
                                self.postMessage({ type: 'init', requestId, success: true });
                            } catch (err) {
                                self.postMessage({ type: 'init', requestId, success: false, error: err.message });
                            }
                            break;

                        case 'createModel':
                            if (!ESNRegression) {
                                self.postMessage({ type: 'createModel', requestId, success: false, error: 'Module not initialized' });
                                return;
                            }
                            model = new ESNRegression(data.config);
                            self.postMessage({ type: 'createModel', requestId, success: true });
                            break;

                        case 'train':
                            if (!model) {
                                self.postMessage({ type: 'train', requestId, success: false, error: 'No model exists' });
                                return;
                            }
                            const coords = data.coordinates;
                            const batchSize = 10;
                            let result = null;
                            
                            for (let i = 0; i < coords.length - 1; i += batchSize) {
                                if (cancelled) {
                                    self.postMessage({ type: 'train', requestId, success: false, error: 'Cancelled' });
                                    return;
                                }
                                const batch = coords.slice(i, Math.min(i + batchSize + 1, coords.length));
                                if (batch.length >= 2) {
                                    result = model.fitOnline({ coordinates: batch });
                                }
                                const progress = Math.min(100, Math.round(((i + batchSize) / coords.length) * 100));
                                self.postMessage({ type: 'progress', requestId, progress });
                            }
                            
                            self.postMessage({ type: 'train', requestId, success: true, result });
                            break;

                        case 'predict':
                            if (!model) {
                                self.postMessage({ type: 'predict', requestId, success: false, error: 'No model exists' });
                                return;
                            }
                            const prediction = model.predict(data.futureSteps);
                            self.postMessage({ type: 'predict', requestId, success: true, result: prediction });
                            break;

                        case 'save':
                            if (!model) {
                                self.postMessage({ type: 'save', requestId, success: false, error: 'No model exists' });
                                return;
                            }
                            const savedState = model.save();
                            self.postMessage({ type: 'save', requestId, success: true, result: savedState });
                            break;

                        case 'load':
                            if (!ESNRegression) {
                                self.postMessage({ type: 'load', requestId, success: false, error: 'Module not initialized' });
                                return;
                            }
                            model = new ESNRegression(data.config || {});
                            model.load(data.state);
                            self.postMessage({ type: 'load', requestId, success: true });
                            break;

                        case 'getSummary':
                            if (!model) {
                                self.postMessage({ type: 'getSummary', requestId, success: false, error: 'No model exists' });
                                return;
                            }
                            const summary = model.getModelSummary();
                            self.postMessage({ type: 'getSummary', requestId, success: true, result: summary });
                            break;

                        case 'reset':
                            model = null;
                            self.postMessage({ type: 'reset', requestId, success: true });
                            break;

                        case 'cancel':
                            cancelled = true;
                            self.postMessage({ type: 'cancel', requestId, success: true });
                            break;
                    }
                } catch (err) {
                    self.postMessage({ type, requestId, success: false, error: err.message });
                }
            };
        `;

        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        worker.onmessage = function (e) {
          const { type, requestId, success, result, error, progress } =
            e.data;

          if (type === "progress") {
            state.loadingProgress = progress;
            render();
            return;
          }

          const pending = pendingRequests.get(requestId);
          if (pending) {
            pendingRequests.delete(requestId);
            if (success) {
              pending.resolve(result);
            } else {
              pending.reject(new Error(error));
            }
          }
        };

        worker.onerror = function (e) {
          console.error("Worker error:", e);
          showToast("Worker error: " + e.message, "error");
          addLog("Worker error: " + e.message, "error");
        };
      }

      function sendWorkerMessage(type, data = {}) {
        return new Promise((resolve, reject) => {
          const requestId = ++requestIdCounter;
          state.currentRequestId = requestId;
          pendingRequests.set(requestId, { resolve, reject });
          worker.postMessage({ type, data, requestId });
        });
      }

      async function initWorker() {
        try {
          createWorker();
          await sendWorkerMessage("init", {
            moduleUrl:
              "https://cdn.jsdelivr.net/npm/esn-regression@latest/dist/esn-regression.esm.js",
          });
          addLog("ESN module initialized", "success");
        } catch (e) {
          addLog(
            "Failed to initialize ESN module: " + e.message,
            "error",
          );
          showToast("Failed to initialize ESN module", "error");
        }
      }

      // ================================================================================
      // LOGGING & NOTIFICATIONS
      // ================================================================================

      function addLog(message, type = "info") {
        const entry = {
          id: Date.now(),
          message,
          type,
          timestamp: new Date().toLocaleTimeString(),
        };
        state.logs.unshift(entry);
        if (state.logs.length > 200) {
          state.logs = state.logs.slice(0, 200);
        }
        render();
      }

      let toastTimeout = null;
      let currentToast = null;

      function showToast(message, type = "info") {
        currentToast = { message, type };
        render();
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          currentToast = null;
          render();
        }, type === "error" ? 6000 : 4000);
      }

      function hideToast() {
        currentToast = null;
        if (toastTimeout) clearTimeout(toastTimeout);
        render();
      }

      // ================================================================================
      // MODEL OPERATIONS
      // ================================================================================

      async function createModel(config) {
        try {
          state.isLoading = true;
          state.loadingText = "Creating model...";
          state.loadingProgress = 0;
          render();

          await sendWorkerMessage("createModel", { config });

          state.config = config;
          state.modelExists = true;
          state.sampleCount = 0;
          state.predictions = null;

          persistState();
          addLog("Model created successfully", "success");
          showToast("Model created!", "success");
        } catch (e) {
          addLog("Failed to create model: " + e.message, "error");
          showToast("Failed to create model: " + e.message, "error");
        } finally {
          state.isLoading = false;
          render();
        }
      }

      async function trainModel(coordinates) {
        if (!state.modelExists) {
          showToast("Create a model first", "warning");
          return;
        }

        try {
          state.isLoading = true;
          state.loadingText = "Training on uploaded data...";
          state.loadingProgress = 0;
          render();

          const result = await sendWorkerMessage("train", {
            coordinates,
          });

          if (result) {
            state.metrics = {
              samplesProcessed: result.samplesProcessed || 0,
              averageLoss: result.averageLoss || 0,
              gradientNorm: result.gradientNorm || 0,
              driftDetected: result.driftDetected || false,
              sampleWeight: result.sampleWeight || 1.0,
            };
            state.sampleCount = result.samplesProcessed ||
              coordinates.length - 1;
            state.nDimensions = coordinates[0]?.length || 0;
          }

          addLog(
            `Trained on ${coordinates.length} time steps`,
            "success",
          );
          showToast("Training complete!", "success");
        } catch (e) {
          if (e.message !== "Cancelled") {
            addLog("Training failed: " + e.message, "error");
            showToast("Training failed: " + e.message, "error");
          }
        } finally {
          state.isLoading = false;
          render();
        }
      }

      async function runPrediction() {
        if (!state.modelExists) {
          showToast("Create a model first", "warning");
          return;
        }

        try {
          state.isLoading = true;
          state.loadingText = "Generating predictions...";
          state.loadingProgress = 0;
          render();

          const result = await sendWorkerMessage("predict", {
            futureSteps: state.futureSteps,
          });

          state.predictions = result;
          if (result.predictions && result.predictions.length > 0) {
            state.nDimensions = result.predictions[0].length;
          }

          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: state.futureSteps,
          };

          addLog(
            `Generated ${state.futureSteps} prediction steps`,
            "success",
          );
          showToast("Prediction complete!", "success");
        } catch (e) {
          addLog("Prediction failed: " + e.message, "error");
          showToast("Prediction failed: " + e.message, "error");
        } finally {
          state.isLoading = false;
          render();
        }
      }

      async function saveModelToFile() {
        try {
          const savedState = await sendWorkerMessage("save");
          const blob = new Blob([JSON.stringify(savedState, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn_model_${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          addLog("Model downloaded", "success");
          showToast("Model saved!", "success");
        } catch (e) {
          addLog("Failed to save model: " + e.message, "error");
          showToast("Failed to save model", "error");
        }
      }

      async function saveModelToBrowser() {
        try {
          const name = prompt(
            "Enter model name:",
            `Model_${Date.now()}`,
          );
          if (!name) return;

          const savedState = await sendWorkerMessage("save");
          const models = JSON.parse(
            localStorage.getItem("esn_saved_models") || "{}",
          );
          models[name] = {
            state: savedState,
            dimensions: state.nDimensions,
            samples: state.sampleCount,
            config: state.config,
            savedAt: Date.now(),
          };
          localStorage.setItem(
            "esn_saved_models",
            JSON.stringify(models),
          );

          addLog(`Model saved as "${name}"`, "success");
          showToast("Model saved to browser!", "success");
          render();
        } catch (e) {
          addLog("Failed to save model: " + e.message, "error");
          showToast("Failed to save model", "error");
        }
      }

      async function loadModelFromState(savedData) {
        try {
          state.isLoading = true;
          state.loadingText = "Loading model...";
          render();

          await sendWorkerMessage("load", {
            state: savedData.state,
            config: savedData.config,
          });

          state.modelExists = true;
          state.config = savedData.config || state.config;
          state.nDimensions = savedData.dimensions || 0;
          state.sampleCount = savedData.samples || 0;
          state.predictions = null;

          addLog("Model loaded successfully", "success");
          showToast("Model loaded!", "success");
        } catch (e) {
          addLog("Failed to load model: " + e.message, "error");
          showToast("Failed to load model", "error");
        } finally {
          state.isLoading = false;
          state.activeModal = null;
          render();
        }
      }

      async function resetModel() {
        try {
          await sendWorkerMessage("reset");
          state.modelExists = false;
          state.predictions = null;
          state.sampleCount = 0;
          state.nDimensions = 0;
          state.metrics = {
            samplesProcessed: 0,
            averageLoss: 0,
            gradientNorm: 0,
            driftDetected: false,
            sampleWeight: 1.0,
          };
          addLog("Model reset", "info");
          showToast("Model reset", "info");
        } catch (e) {
          addLog("Failed to reset: " + e.message, "error");
        }
        render();
      }

      function cancelOperation() {
        sendWorkerMessage("cancel");
        state.isLoading = false;
        addLog("Operation cancelled", "warning");
        showToast("Operation cancelled", "warning");
        render();
      }

      // ================================================================================
      // DATA GENERATION
      // ================================================================================

      function generateRandomData(
        seed,
        dimensions,
        steps,
        noise,
        outlierRate,
        difficulty,
      ) {
        const rng = seededRandom(seed);
        const data = [];

        const freqMultiplier = difficulty === "easy"
          ? 1
          : difficulty === "medium"
          ? 2
          : 3;
        const complexityMultiplier = difficulty === "easy"
          ? 1
          : difficulty === "medium"
          ? 2
          : 4;

        for (let t = 0; t < steps; t++) {
          const point = [];
          for (let d = 0; d < dimensions; d++) {
            let value = Math.sin(
              t * 0.05 * freqMultiplier + d * Math.PI / dimensions,
            );
            value += Math.cos(t * 0.03 * freqMultiplier + d) * 0.5;

            for (let c = 0; c < complexityMultiplier; c++) {
              value += Math.sin(t * (0.02 + c * 0.01) + d + c) *
                (0.3 / (c + 1));
            }

            value += (rng() - 0.5) * noise * 2;

            if (rng() < outlierRate) {
              value += (rng() > 0.5 ? 1 : -1) * (2 + rng() * 3);
            }

            point.push(value);
          }
          data.push(point);
        }

        return data;
      }

      function seededRandom(seed) {
        let s = seed;
        return function () {
          s = (s * 1103515245 + 12345) & 0x7fffffff;
          return s / 0x7fffffff;
        };
      }

      // ================================================================================
      // CANVAS RENDERING
      // ================================================================================

      let canvasRef = null;
      let touchState = {
        startDistance: 0,
        startZoom: 1,
        isDragging: false,
        startX: 0,
        startOffsetX: 0,
        lastTapTime: 0,
        holdTimer: null,
      };

      function renderChart() {
        if (!canvasRef) return;
        const ctx = canvasRef.getContext("2d");
        const { width, height } = canvasRef;
        const dpr = window.devicePixelRatio || 1;

        ctx.clearRect(0, 0, width, height);

        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        if (!predictions || predictions.length === 0) return;

        const padding = { top: 30, right: 20, bottom: 40, left: 50 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        if (state.vizMode === "grid") {
          renderGridView(
            ctx,
            predictions,
            lowerBounds,
            upperBounds,
            padding,
            chartWidth,
            chartHeight,
            width,
            height,
          );
        } else {
          renderFocusView(
            ctx,
            predictions,
            lowerBounds,
            upperBounds,
            padding,
            chartWidth,
            chartHeight,
          );
        }
      }

      function renderGridView(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        padding,
        chartWidth,
        chartHeight,
        width,
        height,
      ) {
        const nDims = predictions[0].length;
        const cols = Math.ceil(Math.sqrt(nDims));
        const rows = Math.ceil(nDims / cols);

        const cellWidth = chartWidth / cols;
        const cellHeight = chartHeight / rows;
        const cellPadding = 10;

        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);

          const x = padding.left + col * cellWidth + cellPadding;
          const y = padding.top + row * cellHeight + cellPadding;
          const w = cellWidth - cellPadding * 2;
          const h = cellHeight - cellPadding * 2;

          const dimData = predictions.map((p) => p[d]);
          const dimLower = lowerBounds.map((l) => l[d]);
          const dimUpper = upperBounds.map((u) => u[d]);

          const allVals = [...dimData, ...dimLower, ...dimUpper];
          const minVal = Math.min(...allVals);
          const maxVal = Math.max(...allVals);
          const range = maxVal - minVal || 1;

          ctx.fillStyle = "#f8fafc";
          ctx.fillRect(x, y, w, h);
          ctx.strokeStyle = "#e2e8f0";
          ctx.strokeRect(x, y, w, h);

          const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

          // Confidence interval
          ctx.fillStyle = color + "20";
          ctx.beginPath();
          for (let i = 0; i < dimData.length; i++) {
            const px = x + (i / (dimData.length - 1)) * w;
            const py = y + h - ((dimUpper[i] - minVal) / range) * h;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          for (let i = dimData.length - 1; i >= 0; i--) {
            const px = x + (i / (dimData.length - 1)) * w;
            const py = y + h - ((dimLower[i] - minVal) / range) * h;
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Main line
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < dimData.length; i++) {
            const px = x + (i / (dimData.length - 1)) * w;
            const py = y + h - ((dimData[i] - minVal) / range) * h;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();

          // Label
          ctx.fillStyle = color;
          ctx.font = "bold 12px system-ui";
          ctx.fillText(`D${d + 1}`, x + 5, y + 15);
        }
      }

      function renderFocusView(
        ctx,
        predictions,
        lowerBounds,
        upperBounds,
        padding,
        chartWidth,
        chartHeight,
      ) {
        const d = state.selectedDim;
        const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

        const visibleStart = Math.floor(state.zoom.offsetX);
        const visibleCount = Math.ceil(
          predictions.length / state.zoom.level,
        );
        const visibleEnd = Math.min(
          visibleStart + visibleCount,
          predictions.length,
        );

        const dimData = predictions.slice(visibleStart, visibleEnd).map(
          (p) => p[d],
        );
        const dimLower = lowerBounds.slice(visibleStart, visibleEnd)
          .map((l) => l[d]);
        const dimUpper = upperBounds.slice(visibleStart, visibleEnd)
          .map((u) => u[d]);

        if (dimData.length === 0) return;

        const allVals = [...dimData, ...dimLower, ...dimUpper];
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;
        const yPadding = range * 0.1;

        const toX = (i) =>
          padding.left + (i / (dimData.length - 1 || 1)) * chartWidth;
        const toY = (v) =>
          padding.top + chartHeight -
          ((v - minVal + yPadding) / (range + yPadding * 2)) *
            chartHeight;

        // Grid lines
        ctx.strokeStyle = "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();

          const val = maxVal + yPadding -
            (i / 5) * (range + yPadding * 2);
          ctx.fillStyle = "#94a3b8";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 5, y + 3);
        }

        // X-axis labels
        ctx.textAlign = "center";
        const labelStep = Math.ceil(dimData.length / 10);
        for (let i = 0; i < dimData.length; i += labelStep) {
          const x = toX(i);
          ctx.fillText(
            (visibleStart + i).toString(),
            x,
            padding.top + chartHeight + 15,
          );
        }

        // Confidence interval
        ctx.fillStyle = color + "30";
        ctx.beginPath();
        for (let i = 0; i < dimData.length; i++) {
          const x = toX(i);
          const y = toY(dimUpper[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        for (let i = dimData.length - 1; i >= 0; i--) {
          ctx.lineTo(toX(i), toY(dimLower[i]));
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < dimData.length; i++) {
          const x = toX(i);
          const y = toY(dimData[i]);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Hover state
        if (
          state.hover.active && state.hover.dataIndex >= 0 &&
          state.hover.dataIndex < dimData.length
        ) {
          const i = state.hover.dataIndex;
          const x = toX(i);
          const y = toY(dimData[i]);

          // Crosshair
          ctx.strokeStyle = "#94a3b8";
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(x, padding.top);
          ctx.lineTo(x, padding.top + chartHeight);
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + chartWidth, y);
          ctx.stroke();
          ctx.setLineDash([]);

          // Highlight point with glow
          ctx.shadowColor = color;
          ctx.shadowBlur = 15;
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        // Dimension label
        ctx.fillStyle = color;
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Dimension ${d + 1}`, padding.left, 20);
      }

      // ================================================================================
      // UI COMPONENTS
      // ================================================================================

      function Header() {
        return `
            <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-xl border-b border-slate-200/50">
                <div class="flex items-center justify-between px-4 py-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                            <span class="text-xl">üìä</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-slate-800">ESN Studio</h1>
                            <p class="text-xs text-slate-500">Autoregressive Forecasting</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100">
                            <span class="w-2 h-2 rounded-full ${
          state.modelExists
            ? "bg-emerald-500 animate-pulse"
            : "bg-slate-400"
        }"></span>
                            <span class="text-xs font-medium text-slate-600">
                                ${
          state.modelExists ? `${state.sampleCount} steps` : "No Model"
        }
                            </span>
                        </div>
                        ${
          state.modelExists
            ? `
                            <button onclick="runPrediction()" class="px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium shadow-lg shadow-blue-500/30" aria-label="Run prediction">
                                ‚ö° Predict
                            </button>
                        `
            : ""
        }
                        <button onclick="openModal('config')" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Configure model">
                            ‚öôÔ∏è
                        </button>
                        <button onclick="toggleMenu()" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Open menu">
                            ‚ò∞
                        </button>
                    </div>
                </div>
            </header>
        `;
      }

      function TabNavigation() {
        const tabs = [
          { id: "grid", label: "üìä Grid", title: "Small Multiples" },
          { id: "focus", label: "üîç Focus", title: "Focus View" },
        ];

        return `
            <div class="flex gap-2 px-4 py-3 overflow-x-auto">
                ${
          tabs.map((tab) => `
                    <button 
                        onclick="setVizMode('${tab.id}')" 
                        class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
            state.vizMode === tab.id
              ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"
              : "bg-slate-100 text-slate-600 hover:bg-slate-200"
          }"
                        aria-label="${tab.title}"
                        aria-pressed="${state.vizMode === tab.id}"
                    >
                        ${tab.label}
                    </button>
                `).join("")
        }
            </div>
        `;
      }

      function DimensionSelector() {
        if (state.vizMode !== "focus" || !state.predictions) return "";

        const nDims = state.predictions.predictions[0]?.length || 0;

        return `
            <div class="flex gap-2 px-4 py-2 overflow-x-auto">
                ${
          Array.from({ length: nDims }, (_, i) => `
                    <button 
                        onclick="setSelectedDim(${i})"
                        class="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
            state.selectedDim === i
              ? "text-white shadow-lg"
              : "bg-slate-100 text-slate-600"
          }"
                        style="${
            state.selectedDim === i
              ? `background-color: ${
                DIMENSION_COLORS[i % DIMENSION_COLORS.length]
              }`
              : ""
          }"
                        aria-label="Dimension ${i + 1}"
                    >
                        D${i + 1}
                    </button>
                `).join("")
        }
            </div>
        `;
      }

      function StatisticsBar() {
        if (state.vizMode !== "focus" || !state.predictions) return "";

        const d = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[d]);
        const lowers = state.predictions.lowerBounds.map((l) => l[d]);
        const uppers = state.predictions.upperBounds.map((u) => u[d]);

        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const trend = preds.length > 1
          ? preds[preds.length - 1] - preds[preds.length - 2]
          : 0;
        const avgSpread =
          uppers.reduce((a, u, i) => a + (u - lowers[i]), 0) /
          uppers.length;
        const confidence = Math.max(0, 100 - avgSpread * 10);

        const stats = [
          { label: "MIN", value: min.toFixed(3) },
          { label: "MAX", value: max.toFixed(3) },
          { label: "MEAN", value: mean.toFixed(3) },
          { label: "FINAL", value: final.toFixed(3) },
          {
            label: "TREND",
            value: `${trend >= 0 ? "‚Üë" : "‚Üì"} ${
              Math.abs(trend).toFixed(3)
            }`,
            color: trend >= 0 ? "text-emerald-600" : "text-red-600",
          },
          { label: "CONF", value: `${confidence.toFixed(1)}%` },
        ];

        return `
            <div class="grid grid-cols-3 gap-2 px-4 py-2">
                ${
          stats.map((stat) => `
                    <div class="bg-white/70 backdrop-blur rounded-lg p-2 text-center">
                        <div class="text-xs text-slate-500 uppercase">${stat.label}</div>
                        <div class="text-sm font-bold ${
            stat.color || "text-slate-800"
          }">${stat.value}</div>
                    </div>
                `).join("")
        }
            </div>
        `;
      }

      function ChartContainer() {
        return `
            <div class="px-4 py-2">
                <div class="relative bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                    ${
          state.predictions
            ? `
                        <div class="absolute top-2 right-2 flex gap-1 z-10">
                            <button onclick="zoomIn()" class="w-8 h-8 rounded-lg bg-white/90 shadow border border-slate-200 text-sm" aria-label="Zoom in">‚ûï</button>
                            <button onclick="zoomOut()" class="w-8 h-8 rounded-lg bg-white/90 shadow border border-slate-200 text-sm" aria-label="Zoom out">‚ûñ</button>
                            <button onclick="resetZoom()" class="w-8 h-8 rounded-lg bg-white/90 shadow border border-slate-200 text-sm" aria-label="Reset zoom">üîÑ</button>
                        </div>
                        <div class="absolute top-2 left-2 px-2 py-1 rounded-lg bg-white/90 shadow border border-slate-200 text-xs font-medium">
                            ${Math.round(state.zoom.level * 100)}%
                        </div>
                        <div class="absolute bottom-2 right-2 flex gap-1 z-10">
                            <button onclick="exportPNG()" class="px-2 py-1 rounded-lg bg-white/90 shadow border border-slate-200 text-xs" aria-label="Save as PNG">üñºÔ∏è PNG</button>
                            <button onclick="exportSVG()" class="px-2 py-1 rounded-lg bg-white/90 shadow border border-slate-200 text-xs" aria-label="Save as SVG">üìÑ SVG</button>
                            <button onclick="copyToClipboard()" class="px-2 py-1 rounded-lg bg-white/90 shadow border border-slate-200 text-xs" aria-label="Copy to clipboard">üìã</button>
                        </div>
                    `
            : ""
        }
                    <canvas 
                        id="mainChart" 
                        class="w-full touch-none" 
                        style="height: 300px;"
                        aria-label="Time series visualization chart"
                    ></canvas>
                    ${
          state.hover.active && state.predictions &&
            state.vizMode === "focus"
            ? Tooltip()
            : ""
        }
                </div>
            </div>
        `;
      }

      function Tooltip() {
        const i = state.hover.dataIndex;
        if (i < 0 || !state.predictions) return "";

        const d = state.selectedDim;
        const pred = state.predictions
          .predictions[i + Math.floor(state.zoom.offsetX)]?.[d];
        const lower = state.predictions
          .lowerBounds[i + Math.floor(state.zoom.offsetX)]?.[d];
        const upper = state.predictions
          .upperBounds[i + Math.floor(state.zoom.offsetX)]?.[d];

        if (pred === undefined) return "";

        const color = DIMENSION_COLORS[d % DIMENSION_COLORS.length];

        return `
            <div class="absolute bg-slate-800 text-white rounded-lg shadow-xl p-3 text-sm z-20 pointer-events-none"
                 style="left: ${Math.min(state.hover.x, 200)}px; top: ${
          Math.max(state.hover.y - 100, 10)
        }px;">
                <div class="text-lg font-bold">Step ${
          i + Math.floor(state.zoom.offsetX)
        }</div>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-3 h-3 rounded-full" style="background: ${color}"></span>
                    <span>D${d + 1}</span>
                </div>
                <div class="mt-2">
                    <span class="text-slate-400">Value:</span>
                    <span class="font-bold ml-1">${
          pred.toFixed(4)
        }</span>
                </div>
                <div class="text-xs text-slate-400 mt-1">
                    CI: ${lower.toFixed(4)} - ${upper.toFixed(4)}
                </div>
                <div class="text-xs text-slate-400">
                    Spread: ${(upper - lower).toFixed(4)}
                </div>
            </div>
        `;
      }

      function EmptyState() {
        return `
            <div class="flex flex-col items-center justify-center py-12 px-4">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-purple-500 rounded-3xl blur-2xl opacity-20"></div>
                    <div class="relative bg-gradient-to-br from-blue-50 to-indigo-100 rounded-3xl p-8">
                        <div class="text-6xl mb-4 text-center">üìä</div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mt-6">Create a Model to Begin</h2>
                <p class="text-slate-500 text-center mt-2 max-w-sm">
                    ESN Studio uses Echo State Networks for autoregressive time series forecasting with uncertainty quantification.
                </p>
                <div class="flex gap-3 mt-6">
                    <button onclick="quickStart()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg shadow-blue-500/30">
                        ‚ö° Start with Defaults
                    </button>
                    <button onclick="openModal('load')" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-medium">
                        üì§ Load
                    </button>
                    <button onclick="runDemo()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium shadow-lg shadow-purple-500/30">
                        ‚ú® Demo
                    </button>
                </div>
            </div>
        `;
      }

      function LoadingOverlay() {
        if (!state.isLoading) return "";

        return `
            <div class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-slate-600 font-medium">${
          state.loadingText || "Processing..."
        }</p>
                <div class="w-64 h-2 bg-slate-200 rounded-full mt-4 overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" 
                         style="width: ${state.loadingProgress}%"></div>
                </div>
                <span class="text-sm text-slate-500 mt-2">${state.loadingProgress}%</span>
                <button onclick="cancelOperation()" class="mt-4 px-4 py-2 rounded-lg bg-red-500 text-white font-medium">
                    Cancel
                </button>
            </div>
        `;
      }

      function SidePanel() {
        return `
            <div class="px-4 py-4 space-y-4">
                <!-- Model Metrics -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Model Metrics</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center py-1">
                            <span class="text-sm text-slate-600">Samples Trained</span>
                            <span class="text-sm font-bold text-blue-600">${state.metrics.samplesProcessed}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-sm text-slate-600">Avg Loss</span>
                            <span class="text-sm font-mono">${
          state.metrics.averageLoss.toExponential(3)
        }</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-sm text-slate-600">Gradient Norm</span>
                            <span class="text-sm font-mono">${
          state.metrics.gradientNorm.toExponential(3)
        }</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-sm text-slate-600">Sample Weight</span>
                            <span class="text-sm font-mono">${
          state.metrics.sampleWeight.toFixed(3)
        }</span>
                        </div>
                    </div>
                </div>

                <!-- Prediction -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Prediction</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-slate-600 block mb-1">Future Steps</label>
                            <input 
                                type="number" 
                                value="${state.futureSteps}" 
                                min="1" 
                                onchange="setFutureSteps(this.value)"
                                class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                aria-label="Number of future steps to predict"
                            />
                        </div>
                        <button 
                            onclick="runPrediction()" 
                            class="w-full px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            ${!state.modelExists ? "disabled" : ""}
                        >
                            Run Prediction
                        </button>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Event Log</h3>
                    <div class="flex gap-2 mb-3">
                        <select 
                            onchange="setLogFilter(this.value)" 
                            class="flex-1 px-2 py-1 rounded-lg border border-slate-300 text-sm"
                            aria-label="Filter log entries"
                        >
                            <option value="all" ${
          state.logFilter === "all" ? "selected" : ""
        }>All</option>
                            <option value="info" ${
          state.logFilter === "info" ? "selected" : ""
        }>Info</option>
                            <option value="success" ${
          state.logFilter === "success" ? "selected" : ""
        }>Success</option>
                            <option value="warning" ${
          state.logFilter === "warning" ? "selected" : ""
        }>Warning</option>
                            <option value="error" ${
          state.logFilter === "error" ? "selected" : ""
        }>Error</option>
                        </select>
                        <input 
                            type="text" 
                            placeholder="Search..." 
                            value="${state.logSearch}"
                            oninput="setLogSearch(this.value)"
                            class="flex-1 px-2 py-1 rounded-lg border border-slate-300 text-sm"
                            aria-label="Search log entries"
                        />
                    </div>
                    <div class="h-48 overflow-y-auto space-y-1">
                        ${
          getFilteredLogs().slice(0, 50).map((log) => `
                            <div class="flex items-start gap-2 py-1 text-xs">
                                <span class="px-1.5 py-0.5 rounded text-white font-medium ${
            log.type === "error"
              ? "bg-red-500"
              : log.type === "success"
              ? "bg-emerald-500"
              : log.type === "warning"
              ? "bg-amber-500"
              : "bg-blue-500"
          }">${log.type}</span>
                                <span class="text-slate-400">${log.timestamp}</span>
                                <span class="text-slate-600 flex-1">${log.message}</span>
                            </div>
                        `).join("")
        }
                    </div>
                </div>
            </div>
        `;
      }

      function SlideOutMenu() {
        if (!state.menuOpen) return "";

        const menuItems = [
          {
            section: "üìÅ Model",
            items: [
              {
                id: "config",
                icon: "üéõÔ∏è",
                title: "Create & Configure",
                desc: "Set up model parameters",
                color: "blue",
              },
              {
                id: "load",
                icon: "üíæ",
                title: "Save & Load",
                desc: "Persist your models",
                color: "emerald",
              },
            ],
          },
          {
            section: "üìÇ Data",
            items: [
              {
                id: "upload",
                icon: "üì§",
                title: "Upload Dataset",
                desc: "Import time series data",
                color: "purple",
              },
              {
                id: "manual",
                icon: "‚ûï",
                title: "Manual Insert",
                desc: "Add individual time steps",
                color: "amber",
              },
            ],
          },
          {
            section: "üß™ Test",
            items: [
              {
                id: "random",
                icon: "üí°",
                title: "Random Test",
                desc: "Generate synthetic time series",
                color: "pink",
              },
            ],
          },
          {
            section: "‚öôÔ∏è Advanced",
            items: [
              {
                id: "table",
                icon: "üìã",
                title: "View Data Table",
                desc: "Raw prediction values",
                color: "slate",
              },
            ],
          },
        ];

        return `
            <div class="fixed inset-0 z-50" onclick="toggleMenu()">
                <div class="absolute inset-0 bg-black/50"></div>
                <div class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-2xl overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">Menu</h2>
                        <button onclick="toggleMenu()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close menu">‚úñÔ∏è</button>
                    </div>
                    <div class="p-4 space-y-6">
                        ${
          menuItems.map((section) => `
                            <div>
                                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">${section.section}</h3>
                                <div class="space-y-2">
                                    ${
            section.items.map((item) => `
                                        <button 
                                            onclick="openModal('${item.id}')"
                                            class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors text-left"
                                        >
                                            <div class="w-10 h-10 rounded-lg bg-${item.color}-100 flex items-center justify-center text-xl">
                                                ${item.icon}
                                            </div>
                                            <div>
                                                <div class="font-medium text-slate-800">${item.title}</div>
                                                <div class="text-xs text-slate-500">${item.desc}</div>
                                            </div>
                                        </button>
                                    `).join("")
          }
                                </div>
                            </div>
                        `).join("")
        }
                    </div>
                </div>
            </div>
        `;
      }

      function ToastNotification() {
        if (!currentToast) return "";

        const bgColors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        return `
            <div class="fixed bottom-4 left-4 right-4 z-50">
                <div class="${
          bgColors[currentToast.type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex justify-between items-center">
                    <span>${currentToast.message}</span>
                    <button onclick="hideToast()" class="ml-2 hover:opacity-80" aria-label="Close notification">‚úñÔ∏è</button>
                </div>
            </div>
        `;
      }

      // ================================================================================
      // MODALS
      // ================================================================================

      function ConfigModal() {
        const presets = [
          { id: "default", label: "Start Here", color: "blue" },
          { id: "fast", label: "Fast", color: "slate" },
          { id: "balanced", label: "Balanced", color: "slate" },
          { id: "accurate", label: "Accurate", color: "slate" },
          { id: "adaptive", label: "Adaptive", color: "slate" },
          { id: "robust", label: "Robust", color: "slate" },
        ];

        const sections = [
          {
            id: "reservoir",
            title: "Reservoir Architecture",
            icon: "üß†",
            fields: [
              {
                key: "reservoirSize",
                label: "Reservoir Size",
                type: "number",
                desc: "Neurons in reservoir",
              },
              {
                key: "spectralRadius",
                label: "Spectral Radius",
                type: "number",
                step: "0.01",
                desc: "Memory length control",
              },
              {
                key: "leakRate",
                label: "Leak Rate",
                type: "number",
                step: "0.1",
                desc: "Temporal smoothing",
              },
              {
                key: "inputScale",
                label: "Input Scale",
                type: "number",
                step: "0.1",
                desc: "Input scaling factor",
              },
              {
                key: "biasScale",
                label: "Bias Scale",
                type: "number",
                step: "0.01",
                desc: "Bias scaling",
              },
              {
                key: "reservoirSparsity",
                label: "Reservoir Sparsity",
                type: "number",
                step: "0.01",
                desc: "Zero connections",
              },
              {
                key: "inputSparsity",
                label: "Input Sparsity",
                type: "number",
                step: "0.1",
                desc: "Input sparsity",
              },
              {
                key: "activation",
                label: "Activation",
                type: "select",
                options: ["tanh", "relu"],
                desc: "Activation function",
              },
            ],
          },
          {
            id: "readout",
            title: "Readout Configuration",
            icon: "üì§",
            fields: [
              {
                key: "useInputInReadout",
                label: "Use Input in Readout",
                type: "toggle",
                desc: "Append input to state",
              },
              {
                key: "useBiasInReadout",
                label: "Use Bias in Readout",
                type: "toggle",
                desc: "Include bias term",
              },
            ],
          },
          {
            id: "training",
            title: "Training (RLS)",
            icon: "üéì",
            fields: [
              {
                key: "readoutTraining",
                label: "Training Method",
                type: "display",
                desc: "RLS training",
              },
              {
                key: "rlsLambda",
                label: "RLS Lambda",
                type: "number",
                step: "0.001",
                desc: "Forgetting factor",
              },
              {
                key: "rlsDelta",
                label: "RLS Delta",
                type: "number",
                step: "0.1",
                desc: "Initial P diagonal",
              },
              {
                key: "epsilon",
                label: "Epsilon",
                type: "number",
                step: "1e-9",
                desc: "Numerical stability",
              },
              {
                key: "l2Lambda",
                label: "L2 Lambda",
                type: "number",
                step: "0.0001",
                desc: "L2 regularization",
              },
              {
                key: "gradientClipNorm",
                label: "Gradient Clip Norm",
                type: "number",
                step: "0.1",
                desc: "Max update norm",
              },
            ],
          },
          {
            id: "normalization",
            title: "Normalization",
            icon: "üìä",
            fields: [
              {
                key: "normalizationEpsilon",
                label: "Normalization Epsilon",
                type: "number",
                step: "1e-9",
                desc: "Stability constant",
              },
              {
                key: "normalizationWarmup",
                label: "Normalization Warmup",
                type: "number",
                desc: "Warmup samples",
              },
            ],
          },
          {
            id: "outlier",
            title: "Outlier Handling",
            icon: "‚ö†Ô∏è",
            fields: [
              {
                key: "outlierThreshold",
                label: "Outlier Threshold",
                type: "number",
                step: "0.1",
                desc: "Z-score threshold",
              },
              {
                key: "outlierMinWeight",
                label: "Outlier Min Weight",
                type: "number",
                step: "0.01",
                desc: "Outlier min weight",
              },
            ],
          },
          {
            id: "uncertainty",
            title: "Uncertainty",
            icon: "üìà",
            fields: [
              {
                key: "uncertaintyMultiplier",
                label: "Uncertainty Multiplier",
                type: "number",
                step: "0.01",
                desc: "CI Multiplier (1.96 = 95% CI)",
              },
            ],
          },
          {
            id: "init",
            title: "Initialization",
            icon: "üîß",
            fields: [
              {
                key: "weightInitScale",
                label: "Weight Init Scale",
                type: "number",
                step: "0.01",
                desc: "Initial weight scale",
              },
              {
                key: "seed",
                label: "Seed",
                type: "number",
                desc: "Random seed",
              },
              {
                key: "verbose",
                label: "Verbose",
                type: "toggle",
                desc: "Detailed logging",
              },
            ],
          },
        ];

        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="config-title">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 id="config-title" class="text-lg font-bold">‚öôÔ∏è Model Configuration</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Presets -->
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            ${
          presets.map((p) => `
                                <button 
                                    onclick="applyPreset('${p.id}')"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap ${
            p.id === "default"
              ? "bg-blue-500 text-white"
              : "bg-slate-100 text-slate-700 hover:bg-slate-200"
          }"
                                >
                                    ${p.label}
                                </button>
                            `).join("")
        }
                        </div>

                        <!-- Sections -->
                        ${
          sections.map((section) => `
                            <div class="border border-slate-200 rounded-xl overflow-hidden">
                                <button 
                                    onclick="toggleSection('${section.id}')"
                                    class="w-full flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100"
                                >
                                    <span class="font-medium">${section.icon} ${section.title}</span>
                                    <span id="section-toggle-${section.id}">‚ñº</span>
                                </button>
                                <div id="section-${section.id}" class="p-3 space-y-3">
                                    ${
            section.fields.map((field) => renderConfigField(field))
              .join("")
          }
                                </div>
                            </div>
                        `).join("")
        }
                    </div>

                    <div class="p-4 border-t border-slate-200 flex gap-2 flex-wrap">
                        <button onclick="resetDefaults()" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Reset Defaults</button>
                        <button onclick="resetAll()" class="px-3 py-2 rounded-lg bg-red-100 text-red-700 text-sm">Reset All</button>
                        <div class="flex-1"></div>
                        <button onclick="closeModal()" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Cancel</button>
                        <button onclick="submitConfig()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium">Create Model</button>
                    </div>
                </div>
            </div>
        `;
      }

      function renderConfigField(field) {
        const value = state.config[field.key];

        if (field.type === "display") {
          return `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-slate-700">${field.label}</div>
                        <div class="text-xs text-slate-500">${field.desc}</div>
                    </div>
                    <span class="text-sm text-slate-600">${value}</span>
                </div>
            `;
        }

        if (field.type === "toggle") {
          return `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-slate-700">${field.label}</div>
                        <div class="text-xs text-slate-500">${field.desc}</div>
                    </div>
                    <button 
                        onclick="toggleConfig('${field.key}')"
                        class="w-12 h-6 rounded-full transition-colors ${
            value ? "bg-blue-500" : "bg-slate-300"
          }"
                        aria-pressed="${value}"
                        aria-label="${field.label}"
                    >
                        <div class="w-5 h-5 rounded-full bg-white shadow transform transition-transform ${
            value ? "translate-x-6" : "translate-x-0.5"
          }"></div>
                    </button>
                </div>
            `;
        }

        if (field.type === "select") {
          return `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-slate-700">${field.label}</div>
                        <div class="text-xs text-slate-500">${field.desc}</div>
                    </div>
                    <select 
                        onchange="updateConfig('${field.key}', this.value)"
                        class="px-2 py-1 rounded-lg border border-slate-300 text-sm"
                        aria-label="${field.label}"
                    >
                        ${
            field.options.map((opt) => `
                            <option value="${opt}" ${
              value === opt ? "selected" : ""
            }>${opt}</option>
                        `).join("")
          }
                    </select>
                </div>
            `;
        }

        return `
            <div class="flex justify-between items-center gap-4">
                <div class="flex-1">
                    <div class="text-sm font-medium text-slate-700">${field.label}</div>
                    <div class="text-xs text-slate-500">${field.desc}</div>
                </div>
                <input 
                    type="number"
                    value="${value}"
                    step="${field.step || "1"}"
                    onchange="updateConfig('${field.key}', parseFloat(this.value))"
                    class="w-24 px-2 py-1 rounded-lg border border-slate-300 text-sm text-right"
                    aria-label="${field.label}"
                />
            </div>
        `;
      }

      function UploadModal() {
        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">üì§ Upload Dataset</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div 
                            id="dropzone"
                            class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-colors cursor-pointer"
                            onclick="document.getElementById('fileInput').click()"
                            ondragover="event.preventDefault(); this.classList.add('border-blue-500', 'bg-blue-50')"
                            ondragleave="this.classList.remove('border-blue-500', 'bg-blue-50')"
                            ondrop="handleFileDrop(event)"
                        >
                            <div class="text-4xl mb-2">üìÅ</div>
                            <p class="text-slate-600">Drop JSON file here or tap to browse</p>
                            <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileSelect(event)" />
                        </div>

                        <div class="text-center text-slate-400">or</div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 block mb-2">Paste JSON</label>
                            <textarea 
                                id="jsonPaste"
                                class="w-full h-32 px-3 py-2 rounded-lg border border-slate-300 text-sm font-mono resize-none"
                                placeholder='{"coordinates": [[1.0, 2.0], [1.1, 2.1], ...]}'
                            ></textarea>
                        </div>

                        <details class="border border-slate-200 rounded-lg">
                            <summary class="p-3 cursor-pointer text-sm font-medium text-slate-700">üìã Format Example</summary>
                            <div class="p-3 pt-0">
                                <button onclick="copyExample()" class="text-xs text-blue-600 hover:underline mb-2">Copy example</button>
                                <pre class="text-xs bg-slate-50 p-2 rounded overflow-x-auto">{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</pre>
                            </div>
                        </details>

                        <div id="uploadValidation"></div>
                    </div>

                    <div class="p-4 border-t border-slate-200 flex gap-2">
                        <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700">Cancel</button>
                        <button onclick="validateUpload()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700">Validate</button>
                        <button id="applyUploadBtn" onclick="applyUpload()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white disabled:opacity-50" disabled>Apply & Train</button>
                    </div>
                </div>
            </div>
        `;
      }

      function ManualInsertModal() {
        const template = state.nDimensions > 0
          ? `{"coordinates": [${
            Array(state.nDimensions).fill("0.0").join(", ")
          }]}`
          : '{"coordinates": [[0.0, 0.0, 0.0]]}';

        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">‚ûï Manual Insert</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <p class="text-sm text-slate-600">Add time step data points in JSON format. Each point should have ${
          state.nDimensions || "N"
        } dimensions.</p>
                        
                        <button onclick="generateTemplate()" class="px-3 py-1.5 rounded-lg bg-slate-100 text-sm text-slate-700">
                            Generate Template
                        </button>

                        <textarea 
                            id="manualJson"
                            class="w-full h-48 px-3 py-2 rounded-lg border border-slate-300 text-sm font-mono resize-none"
                            placeholder='${template}'
                        ></textarea>

                        <div id="manualValidation"></div>
                    </div>

                    <div class="p-4 border-t border-slate-200 flex gap-2">
                        <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700">Cancel</button>
                        <button onclick="applyManualInsert()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white">Insert & Train</button>
                    </div>
                </div>
            </div>
        `;
      }

      function SaveLoadModal() {
        const savedModels = JSON.parse(
          localStorage.getItem("esn_saved_models") || "{}",
        );

        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">üíæ Save & Load</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-6">
                        <!-- Save Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-slate-500 uppercase mb-3">Save Model</h3>
                            <div class="flex gap-2">
                                <button onclick="saveModelToFile()" class="flex-1 px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors text-center" ${
          !state.modelExists ? "disabled" : ""
        }>
                                    <div class="text-2xl mb-1">üì•</div>
                                    <div class="text-sm font-medium">Download</div>
                                </button>
                                <button onclick="saveModelToBrowser()" class="flex-1 px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors text-center" ${
          !state.modelExists ? "disabled" : ""
        }>
                                    <div class="text-2xl mb-1">üíæ</div>
                                    <div class="text-sm font-medium">Browser</div>
                                </button>
                            </div>
                        </div>

                        <!-- Load Section -->
                        <div>
                            <h3 class="text-sm font-semibold text-slate-500 uppercase mb-3">Load Model</h3>
                            
                            <div 
                                class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors mb-4"
                                onclick="document.getElementById('loadFileInput').click()"
                            >
                                <div class="text-2xl mb-1">üì§</div>
                                <p class="text-sm text-slate-600">Tap to upload model file</p>
                                <input type="file" id="loadFileInput" accept=".json" class="hidden" onchange="loadModelFromFile(event)" />
                            </div>

                            ${
          Object.keys(savedModels).length > 0
            ? `
                                <div class="space-y-2">
                                    <h4 class="text-xs text-slate-500">Saved Models</h4>
                                    ${
              Object.entries(savedModels).map(([name, data]) => `
                                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                            <div>
                                                <div class="font-medium text-sm">${name}</div>
                                                <div class="text-xs text-slate-500">${data.dimensions}D ‚Ä¢ ${data.samples} samples</div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="loadSavedModel('${name}')" class="px-3 py-1 rounded-lg bg-blue-500 text-white text-sm">Load</button>
                                                <button onclick="deleteSavedModel('${name}')" class="px-3 py-1 rounded-lg bg-red-100 text-red-700 text-sm">Delete</button>
                                            </div>
                                        </div>
                                    `).join("")
            }
                                </div>
                            `
            : '<p class="text-sm text-slate-500 text-center">No saved models</p>'
        }
                        </div>
                    </div>
                </div>
            </div>
        `;
      }

      function RandomTestModal() {
        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">üí° Random Test</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Seed</label>
                                <input type="number" id="testSeed" value="42" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Dimensions</label>
                                <input type="number" id="testDims" value="3" min="1" max="10" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Time Steps</label>
                                <input type="number" id="testSteps" value="200" min="10" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Noise</label>
                                <input type="number" id="testNoise" value="0.1" step="0.01" min="0" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Outlier Rate</label>
                                <input type="number" id="testOutliers" value="0.02" step="0.01" min="0" max="0.5" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 block mb-1">Difficulty</label>
                                <select id="testDifficulty" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-200 flex gap-2">
                        <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700">Cancel</button>
                        <button onclick="runRandomTest()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium">Generate & Run</button>
                    </div>
                </div>
            </div>
        `;
      }

      function DataTableModal() {
        if (!state.predictions) {
          return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                    <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                    <div class="relative bg-white rounded-2xl shadow-2xl w-full h-full max-h-[95vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="text-lg font-bold">üìã Data Table</h2>
                            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                        </div>
                        <div class="flex-1 flex items-center justify-center">
                            <p class="text-slate-500">No prediction data available</p>
                        </div>
                    </div>
                </div>
            `;
        }

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const nDims = predictions[0].length;

        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true">
                <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
                <div class="relative bg-white rounded-2xl shadow-2xl w-full h-full max-h-[95vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="text-lg font-bold">üìã Data Table</h2>
                        <div class="flex gap-2">
                            <button onclick="exportCSV()" class="px-3 py-1.5 rounded-lg bg-slate-100 text-sm">üìä Export CSV</button>
                            <button onclick="copyAllData()" class="px-3 py-1.5 rounded-lg bg-slate-100 text-sm">üìã Copy All</button>
                            <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="Close">‚úñÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <input 
                            type="text" 
                            placeholder="Search..." 
                            id="tableSearch"
                            oninput="filterTable()"
                            class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm"
                        />
                    </div>
                    
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-sm" id="dataTable">
                            <thead class="sticky top-0 bg-slate-100">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-slate-700 cursor-pointer" onclick="sortTable(0)">Step</th>
                                    ${
          Array.from({ length: nDims }, (_, i) => `
                                        <th class="px-3 py-2 text-left font-medium cursor-pointer" style="color: ${
            DIMENSION_COLORS[i]
          }" onclick="sortTable(${i + 1})">P${i + 1}</th>
                                    `).join("")
        }
                                    ${
          Array.from({ length: nDims }, (_, i) => `
                                        <th class="px-3 py-2 text-left font-medium text-slate-500 cursor-pointer" onclick="sortTable(${
            nDims + i + 1
          })">L${i + 1}</th>
                                    `).join("")
        }
                                    ${
          Array.from({ length: nDims }, (_, i) => `
                                        <th class="px-3 py-2 text-left font-medium text-slate-500 cursor-pointer" onclick="sortTable(${
            nDims * 2 + i + 1
          })">U${i + 1}</th>
                                    `).join("")
        }
                                </tr>
                            </thead>
                            <tbody class="font-mono">
                                ${
          predictions.map((pred, step) => `
                                    <tr class="${
            step % 2 === 0 ? "bg-white" : "bg-slate-50"
          } hover:bg-blue-50">
                                        <td class="px-3 py-2 font-medium">${step}</td>
                                        ${
            pred.map((v) =>
              `<td class="px-3 py-2">${v.toFixed(4)}</td>`
            ).join("")
          }
                                        ${
            lowerBounds[step].map((v) =>
              `<td class="px-3 py-2 text-slate-500">${
                v.toFixed(4)
              }</td>`
            ).join("")
          }
                                        ${
            upperBounds[step].map((v) =>
              `<td class="px-3 py-2 text-slate-500">${
                v.toFixed(4)
              }</td>`
            ).join("")
          }
                                    </tr>
                                `).join("")
        }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
      }

      function Modal() {
        switch (state.activeModal) {
          case "config":
            return ConfigModal();
          case "upload":
            return UploadModal();
          case "manual":
            return ManualInsertModal();
          case "load":
            return SaveLoadModal();
          case "random":
            return RandomTestModal();
          case "table":
            return DataTableModal();
          default:
            return "";
        }
      }

      // ================================================================================
      // EVENT HANDLERS
      // ================================================================================

      function setVizMode(mode) {
        state.vizMode = mode;
        persistState();
        render();
        setTimeout(renderChart, 0);
      }

      function setSelectedDim(dim) {
        state.selectedDim = dim;
        render();
        setTimeout(renderChart, 0);
      }

      function setFutureSteps(value) {
        const v = parseInt(value);
        if (v > 0) state.futureSteps = v;
        render();
      }

      function setLogFilter(value) {
        state.logFilter = value;
        render();
      }

      function setLogSearch(value) {
        state.logSearch = value;
        render();
      }

      function getFilteredLogs() {
        return state.logs.filter((log) => {
          if (
            state.logFilter !== "all" && log.type !== state.logFilter
          ) return false;
          if (
            state.logSearch &&
            !log.message.toLowerCase().includes(
              state.logSearch.toLowerCase(),
            )
          ) return false;
          return true;
        });
      }

      function toggleMenu() {
        state.menuOpen = !state.menuOpen;
        render();
      }

      function openModal(modal) {
        state.activeModal = modal;
        state.menuOpen = false;
        render();
      }

      function closeModal() {
        state.activeModal = null;
        render();
      }

      function toggleSection(id) {
        const section = document.getElementById(`section-${id}`);
        const toggle = document.getElementById(`section-toggle-${id}`);
        if (section && toggle) {
          section.classList.toggle("hidden");
          toggle.textContent = section.classList.contains("hidden")
            ? "‚ñ∂"
            : "‚ñº";
        }
      }

      function applyPreset(presetId) {
        state.config = { ...PRESETS[presetId] };
        render();
      }

      function updateConfig(key, value) {
        state.config[key] = value;
      }

      function toggleConfig(key) {
        state.config[key] = !state.config[key];
        render();
      }

      function resetDefaults() {
        state.config = { ...DEFAULT_CONFIG };
        render();
      }

      async function resetAll() {
        if (confirm("Reset model and all settings?")) {
          await resetModel();
          state.config = { ...DEFAULT_CONFIG };
          render();
        }
      }

      async function submitConfig() {
        await createModel(state.config);
        closeModal();
      }

      async function quickStart() {
        await createModel({ ...DEFAULT_CONFIG });
      }

      async function runDemo() {
        await createModel({ ...DEFAULT_CONFIG });
        const data = generateRandomData(
          42,
          3,
          200,
          0.1,
          0.02,
          "medium",
        );
        await trainModel(data);
        state.futureSteps = 50;
        await runPrediction();
      }

      // Upload handlers
      let uploadedData = null;

      function handleFileDrop(e) {
        e.preventDefault();
        e.target.classList.remove("border-blue-500", "bg-blue-50");
        const file = e.dataTransfer.files[0];
        if (file) processFile(file);
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) processFile(file);
      }

      function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("jsonPaste").value = e.target.result;
          validateUpload();
        };
        reader.readAsText(file);
      }

      function validateUpload() {
        const json = document.getElementById("jsonPaste").value;
        const validation = document.getElementById("uploadValidation");
        const btn = document.getElementById("applyUploadBtn");

        try {
          const data = JSON.parse(json);
          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            throw new Error('Missing or invalid "coordinates" array');
          }
          if (data.coordinates.length < 2) {
            throw new Error("Need at least 2 time steps");
          }
          const dims = data.coordinates[0].length;
          if (
            !dims || !data.coordinates.every((c) => c.length === dims)
          ) {
            throw new Error(
              "All coordinates must have same dimensions",
            );
          }

          uploadedData = data.coordinates;
          validation.innerHTML = `
                <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm">
                    ‚úÖ Valid: ${dims} dimensions, ${data.coordinates.length} time steps
                </div>
            `;
          btn.disabled = false;
        } catch (err) {
          uploadedData = null;
          validation.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    ‚ùå ${err.message}
                </div>
            `;
          btn.disabled = true;
        }
      }

      async function applyUpload() {
        if (!uploadedData) return;

        if (!state.modelExists) {
          await createModel(state.config);
        }

        await trainModel(uploadedData);
        closeModal();
      }

      function copyExample() {
        const example = `{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}`;
        navigator.clipboard.writeText(example);
        showToast("Example copied!", "success");
      }

      // Manual insert handlers
      function generateTemplate() {
        const dims = state.nDimensions || 3;
        const point = Array(dims).fill("0.0").join(", ");
        document.getElementById("manualJson").value =
          `{"coordinates": [[${point}], [${point}]]}`;
      }

      async function applyManualInsert() {
        const json = document.getElementById("manualJson").value;
        const validation = document.getElementById("manualValidation");

        try {
          const data = JSON.parse(json);
          if (!data.coordinates || !Array.isArray(data.coordinates)) {
            throw new Error('Missing or invalid "coordinates" array');
          }

          if (!state.modelExists) {
            await createModel(state.config);
          }

          await trainModel(data.coordinates);
          closeModal();
        } catch (err) {
          validation.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    ‚ùå ${err.message}
                </div>
            `;
        }
      }

      // Save/Load handlers
      async function loadModelFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            await loadModelFromState({
              state: data,
              config: data.config,
            });
          } catch (err) {
            showToast("Invalid model file", "error");
          }
        };
        reader.readAsText(file);
      }

      async function loadSavedModel(name) {
        const models = JSON.parse(
          localStorage.getItem("esn_saved_models") || "{}",
        );
        if (models[name]) {
          await loadModelFromState(models[name]);
        }
      }

      function deleteSavedModel(name) {
        if (!confirm(`Delete model "${name}"?`)) return;
        const models = JSON.parse(
          localStorage.getItem("esn_saved_models") || "{}",
        );
        delete models[name];
        localStorage.setItem(
          "esn_saved_models",
          JSON.stringify(models),
        );
        addLog(`Deleted model "${name}"`, "info");
        render();
      }

      // Random test handlers
      async function runRandomTest() {
        const seed =
          parseInt(document.getElementById("testSeed").value) || 42;
        const dims =
          parseInt(document.getElementById("testDims").value) || 3;
        const steps =
          parseInt(document.getElementById("testSteps").value) || 200;
        const noise =
          parseFloat(document.getElementById("testNoise").value) || 0.1;
        const outliers =
          parseFloat(document.getElementById("testOutliers").value) ||
          0.02;
        const difficulty =
          document.getElementById("testDifficulty").value || "medium";

        closeModal();

        await createModel(state.config);
        const data = generateRandomData(
          seed,
          dims,
          steps,
          noise,
          outliers,
          difficulty,
        );
        await trainModel(data);
        state.futureSteps = 50;
        await runPrediction();
      }

      // Zoom handlers
      function zoomIn() {
        state.zoom.level = Math.min(state.zoom.level * 1.5, 10);
        render();
        setTimeout(renderChart, 0);
      }

      function zoomOut() {
        state.zoom.level = Math.max(state.zoom.level / 1.5, 1);
        if (state.zoom.level === 1) state.zoom.offsetX = 0;
        render();
        setTimeout(renderChart, 0);
      }

      function resetZoom() {
        state.zoom = {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        };
        render();
        setTimeout(renderChart, 0);
      }

      // Export handlers
      function exportPNG() {
        if (!canvasRef) return;
        const link = document.createElement("a");
        link.download = `esn_chart_${Date.now()}.png`;
        link.href = canvasRef.toDataURL("image/png");
        link.click();
        addLog("Chart exported as PNG", "success");
      }

      function exportSVG() {
        showToast("SVG export coming soon", "info");
      }

      function copyToClipboard() {
        if (!canvasRef) return;
        canvasRef.toBlob((blob) => {
          navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          showToast("Chart copied to clipboard!", "success");
        });
      }

      function exportCSV() {
        if (!state.predictions) return;

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const nDims = predictions[0].length;

        let csv = "Step," +
          Array.from({ length: nDims }, (_, i) => `P${i + 1}`).join(
            ",",
          ) + "," +
          Array.from({ length: nDims }, (_, i) => `L${i + 1}`).join(
            ",",
          ) + "," +
          Array.from({ length: nDims }, (_, i) => `U${i + 1}`).join(
            ",",
          ) + "\n";

        predictions.forEach((pred, step) => {
          csv += step + "," +
            pred.join(",") + "," +
            lowerBounds[step].join(",") + "," +
            upperBounds[step].join(",") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.download = `esn_data_${Date.now()}.csv`;
        link.href = URL.createObjectURL(blob);
        link.click();
        addLog("Data exported as CSV", "success");
      }

      function copyAllData() {
        if (!state.predictions) return;
        navigator.clipboard.writeText(
          JSON.stringify(state.predictions, null, 2),
        );
        showToast("Data copied to clipboard!", "success");
      }

      function filterTable() {
        const search = document.getElementById("tableSearch").value
          .toLowerCase();
        const rows = document.querySelectorAll("#dataTable tbody tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? "" : "none";
        });
      }

      let sortColumn = -1;
      let sortAsc = true;

      function sortTable(col) {
        if (sortColumn === col) {
          sortAsc = !sortAsc;
        } else {
          sortColumn = col;
          sortAsc = true;
        }

        const tbody = document.querySelector("#dataTable tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a, b) => {
          const aVal = parseFloat(a.cells[col].textContent);
          const bVal = parseFloat(b.cells[col].textContent);
          return sortAsc ? aVal - bVal : bVal - aVal;
        });

        rows.forEach((row) => tbody.appendChild(row));
      }

      // ================================================================================
      // CANVAS INTERACTION HANDLERS
      // ================================================================================

      function setupCanvasInteractions() {
        const canvas = document.getElementById("mainChart");
        if (!canvas) return;

        canvasRef = canvas;
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext("2d");
        ctx.scale(dpr, dpr);

        renderChart();

        // Mouse events
        canvas.addEventListener("mousemove", handleMouseMove);
        canvas.addEventListener("mouseleave", handleMouseLeave);
        canvas.addEventListener("wheel", handleWheel, {
          passive: false,
        });

        // Touch events
        canvas.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });
        canvas.addEventListener("touchmove", handleTouchMove, {
          passive: false,
        });
        canvas.addEventListener("touchend", handleTouchEnd);

        // Click for grid selection
        canvas.addEventListener("click", handleCanvasClick);
      }

      function handleMouseMove(e) {
        if (!state.predictions || state.vizMode !== "focus") return;

        const rect = canvasRef.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const padding = { left: 50, right: 20 };
        const chartWidth = rect.width - padding.left - padding.right;

        const visibleCount = Math.ceil(
          state.predictions.predictions.length / state.zoom.level,
        );
        const dataIndex = Math.round(
          ((x - padding.left) / chartWidth) * (visibleCount - 1),
        );

        if (dataIndex >= 0 && dataIndex < visibleCount) {
          state.hover = { active: true, x, y, dataIndex };
          render();
          setTimeout(renderChart, 0);
        }
      }

      function handleMouseLeave() {
        state.hover = { active: false, x: 0, y: 0, dataIndex: -1 };
        render();
        setTimeout(renderChart, 0);
      }

      function handleWheel(e) {
        e.preventDefault();
        if (e.deltaY < 0) {
          zoomIn();
        } else {
          zoomOut();
        }
      }

      function handleTouchStart(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          touchState.startDistance = getTouchDistance(e.touches);
          touchState.startZoom = state.zoom.level;
        } else if (e.touches.length === 1) {
          touchState.isDragging = true;
          touchState.startX = e.touches[0].clientX;
          touchState.startOffsetX = state.zoom.offsetX;

          // Hold for tooltip
          touchState.holdTimer = setTimeout(() => {
            const rect = canvasRef.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;

            if (state.vizMode === "focus" && state.predictions) {
              const padding = { left: 50, right: 20 };
              const chartWidth = rect.width - padding.left -
                padding.right;
              const visibleCount = Math.ceil(
                state.predictions.predictions.length / state.zoom.level,
              );
              const dataIndex = Math.round(
                ((x - padding.left) / chartWidth) * (visibleCount - 1),
              );

              state.hover = { active: true, x, y, dataIndex };
              render();
              setTimeout(renderChart, 0);
            }
          }, 500);
        }
      }

      function handleTouchMove(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          const distance = getTouchDistance(e.touches);
          const scale = distance / touchState.startDistance;
          state.zoom.level = Math.max(
            1,
            Math.min(10, touchState.startZoom * scale),
          );
          render();
          setTimeout(renderChart, 0);
        } else if (touchState.isDragging && state.zoom.level > 1) {
          clearTimeout(touchState.holdTimer);
          const deltaX = e.touches[0].clientX - touchState.startX;
          const maxOffset = state.predictions
            ? state.predictions.predictions.length *
              (1 - 1 / state.zoom.level)
            : 0;
          state.zoom.offsetX = Math.max(
            0,
            Math.min(maxOffset, touchState.startOffsetX - deltaX / 5),
          );
          render();
          setTimeout(renderChart, 0);
        }
      }

      function handleTouchEnd() {
        touchState.isDragging = false;
        clearTimeout(touchState.holdTimer);
        state.hover = { active: false, x: 0, y: 0, dataIndex: -1 };
        render();
        setTimeout(renderChart, 0);
      }

      function getTouchDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function handleCanvasClick(e) {
        if (state.vizMode !== "grid" || !state.predictions) return;

        const rect = canvasRef.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const padding = { top: 30, right: 20, bottom: 40, left: 50 };
        const chartWidth = rect.width - padding.left - padding.right;
        const chartHeight = rect.height - padding.top - padding.bottom;

        const nDims = state.predictions.predictions[0].length;
        const cols = Math.ceil(Math.sqrt(nDims));
        const rows = Math.ceil(nDims / cols);

        const cellWidth = chartWidth / cols;
        const cellHeight = chartHeight / rows;

        const col = Math.floor((x - padding.left) / cellWidth);
        const row = Math.floor((y - padding.top) / cellHeight);
        const dim = row * cols + col;

        if (dim >= 0 && dim < nDims) {
          state.selectedDim = dim;
          state.vizMode = "focus";
          persistState();
          render();
          setTimeout(renderChart, 0);
        }
      }

      // ================================================================================
      // RENDER
      // ================================================================================

      function render() {
        const app = document.getElementById("app");

        app.innerHTML = `
            ${Header()}
            
            <main class="pb-20">
                ${TabNavigation()}
                ${DimensionSelector()}
                ${StatisticsBar()}
                
                ${
          !state.predictions && !state.modelExists
            ? EmptyState()
            : ChartContainer()
        }
                
                ${SidePanel()}
            </main>
            
            ${SlideOutMenu()}
            ${Modal()}
            ${LoadingOverlay()}
            ${ToastNotification()}
        `;

        // Re-setup canvas after render
        requestAnimationFrame(setupCanvasInteractions);
      }

      // ================================================================================
      // INITIALIZATION
      // ================================================================================

      window.onload = async function () {
        render();
        await initWorker();
        addLog("ESN Studio initialized", "info");
      };

      // Expose functions to global scope for onclick handlers
      window.runPrediction = runPrediction;
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.toggleMenu = toggleMenu;
      window.setVizMode = setVizMode;
      window.setSelectedDim = setSelectedDim;
      window.setFutureSteps = setFutureSteps;
      window.setLogFilter = setLogFilter;
      window.setLogSearch = setLogSearch;
      window.applyPreset = applyPreset;
      window.updateConfig = updateConfig;
      window.toggleConfig = toggleConfig;
      window.toggleSection = toggleSection;
      window.resetDefaults = resetDefaults;
      window.resetAll = resetAll;
      window.submitConfig = submitConfig;
      window.quickStart = quickStart;
      window.runDemo = runDemo;
      window.handleFileDrop = handleFileDrop;
      window.handleFileSelect = handleFileSelect;
      window.validateUpload = validateUpload;
      window.applyUpload = applyUpload;
      window.copyExample = copyExample;
      window.generateTemplate = generateTemplate;
      window.applyManualInsert = applyManualInsert;
      window.saveModelToFile = saveModelToFile;
      window.saveModelToBrowser = saveModelToBrowser;
      window.loadModelFromFile = loadModelFromFile;
      window.loadSavedModel = loadSavedModel;
      window.deleteSavedModel = deleteSavedModel;
      window.runRandomTest = runRandomTest;
      window.zoomIn = zoomIn;
      window.zoomOut = zoomOut;
      window.resetZoom = resetZoom;
      window.exportPNG = exportPNG;
      window.exportSVG = exportSVG;
      window.copyToClipboard = copyToClipboard;
      window.exportCSV = exportCSV;
      window.copyAllData = copyAllData;
      window.filterTable = filterTable;
      window.sortTable = sortTable;
      window.cancelOperation = cancelOperation;
      window.hideToast = hideToast;
    </script>
  </body>
</html>
