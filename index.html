<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "system-ui",
                "-apple-system",
                "BlinkMacSystemFont",
                "Segoe UI",
                "Roboto",
                "sans-serif",
              ],
            },
            animation: {
              "fade-in": "fadeIn 0.2s ease-out",
              "slide-up": "slideUp 0.3s ease-out",
              "slide-in-right": "slideInRight 0.3s ease-out",
              "pulse-subtle": "pulseSubtle 2s ease-in-out infinite",
            },
          },
        },
      };
    </script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes pulseSubtle {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #e5e7eb 25%,
          #f3f4f6 50%,
          #e5e7eb 75%
        );
        background-size: 200% 100%;
        animation: skeleton 1.5s infinite;
      }
      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #374151 25%,
          #4b5563 50%,
          #374151 75%
        );
        background-size: 200% 100%;
      }
      @keyframes skeleton {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
      input[type="number"]::-webkit-inner-spin-button {
        opacity: 0.5;
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .collapsible-content.open {
        max-height: 2000px;
      }
      .toast-enter {
        animation: slideInRight 0.3s ease-out;
      }
      .focus-ring:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
      .dark .focus-ring:focus {
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5);
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans min-h-screen transition-colors duration-200"
  >
    <div id="app" class="flex flex-col h-screen overflow-hidden">
      <!-- Header -->
      <header
        class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 shadow-sm"
      >
        <div class="flex items-center justify-between max-w-full">
          <div class="flex items-center gap-3">
            <div
              class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/25"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <div>
              <h1 class="text-lg font-semibold tracking-tight">
                ESN Regression Studio
              </h1>
              <p
                class="text-xs text-slate-500 dark:text-slate-400 hidden sm:block"
              >
                Online Multivariate Forecasting
              </p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <!-- Model Status -->
            <div
              id="model-status"
              class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm"
            >
              <span
                class="w-2 h-2 rounded-full bg-slate-400"
                id="status-dot"
              ></span>
              <span id="status-text">No Model</span>
            </div>

            <!-- Config Chips -->
            <div id="config-chips" class="hidden md:flex items-center gap-2">
            </div>

            <!-- Quick Actions -->
            <button
              onclick="openModal('config-modal')"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              title="Configure (C)"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>

            <button
              onclick="toggleMainMenu()"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              title="Menu (M)"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>

            <button
              onclick="toggleTheme()"
              class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
              title="Toggle theme"
            >
              <svg
                class="w-5 h-5 dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
              <svg
                class="w-5 h-5 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="flex-1 flex overflow-hidden">
        <!-- Main Area -->
        <main class="flex-1 flex flex-col overflow-hidden p-4 gap-4">
          <!-- Visualization Tabs -->
          <div class="flex items-center gap-2 overflow-x-auto pb-1">
            <button
              onclick="setVisualizationMode('grid')"
              class="viz-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all"
              data-mode="grid"
            >
              Small Multiples
            </button>
            <button
              onclick="setVisualizationMode('focus')"
              class="viz-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all"
              data-mode="focus"
            >
              Focus View
            </button>
            <button
              onclick="setVisualizationMode('heatmap')"
              class="viz-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all"
              data-mode="heatmap"
            >
              Heatmap
            </button>
            <button
              onclick="setVisualizationMode('uncertainty')"
              class="viz-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all"
              data-mode="uncertainty"
            >
              Uncertainty
            </button>
            <button
              onclick="setVisualizationMode('bar')"
              class="viz-tab px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all"
              data-mode="bar"
            >
              Snapshot
            </button>
            <div class="ml-auto flex items-center gap-2">
              <button
                onclick="runPrediction()"
                id="predict-btn"
                class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors focus-ring"
                title="Predict (P)"
              >
                Predict
              </button>
            </div>
          </div>

          <!-- Chart Container -->
          <div
            class="overflow-scroll flex-1 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200/50 dark:border-slate-700/50 overflow-hidden relative"
          >
            <div id="chart-container" class="w-full h-full relative">
              <canvas id="main-canvas" class="w-full h-full"></canvas>

              <!-- Chart Controls -->
              <div
                id="chart-controls"
                class="absolute top-3 right-3 flex flex-col gap-1 hidden"
              >
                <button
                  onclick="chartZoomIn()"
                  class="p-2 bg-white dark:bg-slate-700 rounded-lg shadow-md hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v12m6-6H6"
                    />
                  </svg>
                </button>
                <button
                  onclick="chartZoomOut()"
                  class="p-2 bg-white dark:bg-slate-700 rounded-lg shadow-md hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M18 12H6"
                    />
                  </svg>
                </button>
                <button
                  onclick="chartResetZoom()"
                  class="p-2 bg-white dark:bg-slate-700 rounded-lg shadow-md hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                    />
                  </svg>
                </button>
              </div>

              <!-- Zoom Level Badge -->
              <div
                id="zoom-badge"
                class="absolute top-3 left-3 px-2 py-1 bg-white/90 dark:bg-slate-700/90 rounded text-xs font-medium hidden"
              >
                100%
              </div>

              <!-- Empty State -->
              <div
                id="empty-state"
                class="absolute inset-0 flex items-center justify-center"
              >
                <div class="text-center px-6 max-w-md">
                  <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div
                      class="absolute inset-0 bg-gradient-to-br from-blue-400/20 to-indigo-400/20 rounded-3xl rotate-6"
                    >
                    </div>
                    <div
                      class="absolute inset-0 bg-gradient-to-br from-blue-500/30 to-indigo-500/30 rounded-3xl -rotate-6"
                    >
                    </div>
                    <div
                      class="absolute inset-2 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center"
                    >
                      <svg
                        class="w-10 h-10 text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        />
                      </svg>
                    </div>
                  </div>
                  <h3 class="text-xl font-semibold mb-2" id="empty-title">
                    Create a Model to Begin
                  </h3>
                  <p
                    class="text-slate-500 dark:text-slate-400 mb-6"
                    id="empty-subtitle"
                  >
                    Configure your Echo State Network for multivariate
                    regression and forecasting
                  </p>
                  <div
                    id="onboarding-actions"
                    class="flex flex-col sm:flex-row gap-3 justify-center"
                  >
                    <button
                      onclick="applyPreset('start-here');createModel()"
                      class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors focus-ring flex items-center justify-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 10V3L4 14h7v7l9-11h-7z"
                        />
                      </svg>
                      Start with Defaults
                    </button>
                    <button
                      onclick="openModal('load-modal')"
                      class="px-5 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-xl font-medium transition-colors focus-ring flex items-center justify-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                        />
                      </svg>
                      Load Model
                    </button>
                    <button
                      onclick="runRandomTest()"
                      class="px-5 py-2.5 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl font-medium transition-colors focus-ring flex items-center justify-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                        />
                      </svg>
                      Try Demo
                    </button>
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div
                id="loading-state"
                class="absolute inset-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm flex items-center justify-center hidden"
              >
                <div class="text-center">
                  <div
                    class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"
                  >
                  </div>
                  <p class="text-sm font-medium" id="loading-text">
                    Processing...
                  </p>
                  <div id="progress-container" class="mt-4 hidden">
                    <div
                      class="w-64 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"
                    >
                      <div
                        id="progress-bar"
                        class="h-full bg-blue-500 transition-all duration-200"
                        style="width: 0%"
                      >
                      </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2" id="progress-text">
                      0%
                    </p>
                    <button
                      onclick="cancelOperation()"
                      class="mt-3 px-4 py-1.5 text-sm bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>

              <!-- Tooltip -->
              <div
                id="chart-tooltip"
                class="absolute pointer-events-none opacity-0 transition-opacity duration-100 z-50"
              >
                <div
                  class="bg-white dark:bg-slate-800 rounded-xl shadow-xl shadow-slate-900/20 dark:shadow-slate-900/50 border border-slate-200/80 dark:border-slate-700/80 px-4 py-3 min-w-[180px]"
                >
                  <div id="tooltip-content"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Dimension Selector (Focus View) -->
          <div
            id="dimension-selector"
            class="hidden bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
          >
            <div class="flex items-center gap-3 overflow-x-auto pb-1">
              <span
                class="text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap"
              >Target:</span>
              <div id="dim-buttons" class="flex items-center gap-2"></div>
            </div>
          </div>

          <!-- Stats Bar -->
          <div
            id="stats-bar"
            class="hidden grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3"
          >
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">Min</p>
              <p class="text-lg font-semibold" id="stat-min">-</p>
            </div>
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">Max</p>
              <p class="text-lg font-semibold" id="stat-max">-</p>
            </div>
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">Mean</p>
              <p class="text-lg font-semibold" id="stat-mean">-</p>
            </div>
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">Final</p>
              <p class="text-lg font-semibold" id="stat-final">-</p>
            </div>
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">Trend</p>
              <p
                class="text-lg font-semibold flex items-center gap-1"
                id="stat-trend"
              >
                -
              </p>
            </div>
            <div
              class="bg-white dark:bg-slate-800 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50"
            >
              <p class="text-xs text-slate-500 dark:text-slate-400">
                Confidence
              </p>
              <p class="text-lg font-semibold" id="stat-confidence">-</p>
            </div>
          </div>
        </main>

        <!-- Side Panel -->
        <aside
          id="side-panel"
          class="w-80 flex-shrink-0 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden transition-all duration-300 hidden lg:flex"
        >
          <div
            class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
          >
            <h2 class="font-semibold">Details</h2>
            <button
              onclick="toggleSidePanel()"
              class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Metrics -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700">
            <h3
              class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3"
            >
              Model Metrics
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm">Samples Trained</span>
                <span class="font-medium" id="metric-samples">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm">Avg Loss</span>
                <span class="font-medium" id="metric-loss">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm">Last Gradient Norm</span>
                <span class="font-medium" id="metric-gradient">-</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm">Last Sample Weight</span>
                <span class="font-medium" id="metric-weight">-</span>
              </div>
            </div>
          </div>

          <!-- Prediction Controls -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700">
            <h3
              class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3"
            >
              Prediction
            </h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm mb-1 block">Future Steps</label>
                <div class="flex items-center gap-2">
                  <input
                    type="range"
                    id="future-steps-range"
                    min="1"
                    max="64"
                    value="10"
                    class="flex-1"
                    oninput="syncFutureSteps(this.value)"
                  >
                  <input
                    type="number"
                    id="future-steps-input"
                    min="1"
                    max="64"
                    value="10"
                    class="w-16 px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
                    oninput="syncFutureSteps(this.value)"
                  >
                </div>
              </div>
              <button
                onclick="runPrediction()"
                id="predict-btn-side"
                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 dark:disabled:bg-slate-600 text-white rounded-lg font-medium transition-colors focus-ring disabled:cursor-not-allowed"
                disabled
              >
                Run Prediction
              </button>
            </div>
          </div>

          <!-- Event Log -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <div class="flex items-center gap-2 p-4 pb-2">
              <h3
                class="text-sm font-medium text-slate-500 dark:text-slate-400"
              >
                Event Log
              </h3>
              <select
                id="log-filter"
                class="ml-auto text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg focus-ring"
                onchange="filterLogs()"
              >
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="success">Success</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <div class="px-4 pb-2">
              <input
                type="text"
                id="log-search"
                placeholder="Search..."
                class="w-full px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
                oninput="filterLogs()"
              >
            </div>
            <div
              id="event-log"
              class="flex-1 overflow-y-auto px-4 pb-4 space-y-2"
            >
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Main Menu Overlay -->
    <div
      id="main-menu-overlay"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden"
      onclick="toggleMainMenu()"
    >
    </div>
    <div
      id="main-menu"
      class="fixed top-0 right-0 w-80 h-full bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300"
    >
      <div
        class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700"
      >
        <h2 class="font-semibold">Menu</h2>
        <button
          onclick="toggleMainMenu()"
          class="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-60px)]">
        <!-- Model Section -->
        <div>
          <h3
            class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2"
          >
            Model
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('config-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                />
              </svg>
              <span>Create & Configure</span>
              <span class="ml-auto text-xs text-slate-400">C</span>
            </button>
            <button
              onclick="openModal('load-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                />
              </svg>
              <span>Save & Load</span>
            </button>
          </div>
        </div>

        <!-- Data Section -->
        <div>
          <h3
            class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2"
          >
            Data
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('upload-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              <span>Upload Dataset</span>
              <span class="ml-auto text-xs text-slate-400">U</span>
            </button>
            <button
              onclick="openModal('insert-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Manual Insert</span>
            </button>
          </div>
        </div>

        <!-- Test Section -->
        <div>
          <h3
            class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2"
          >
            Test
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('random-test-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                />
              </svg>
              <span>Random Test</span>
            </button>
          </div>
        </div>

        <!-- Advanced Section -->
        <div>
          <h3
            class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2"
          >
            Advanced
          </h3>
          <div class="space-y-1">
            <button
              onclick="openModal('settings-modal');toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <span>Settings</span>
            </button>
            <button
              onclick="showDataTable();toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
              </svg>
              <span>View Data Table</span>
            </button>
            <button
              onclick="showKeyboardShortcuts();toggleMainMenu()"
              class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left focus-ring"
            >
              <svg
                class="w-5 h-5 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Keyboard Shortcuts</span>
              <span class="ml-auto text-xs text-slate-400">?</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div
      id="config-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="config-modal-title"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('config-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-3xl sm:max-h-[90vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 id="config-modal-title" class="text-xl font-semibold">
            Model Configuration
          </h2>
          <button
            onclick="closeModal('config-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Presets -->
        <div
          class="px-5 py-3 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700"
        >
          <div class="flex items-center gap-2 overflow-x-auto pb-1">
            <span
              class="text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap"
            >Presets:</span>
            <button
              onclick="applyPreset('start-here')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors whitespace-nowrap"
            >
              Start Here
            </button>
            <button
              onclick="applyPreset('fast')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap"
            >
              Fast & Light
            </button>
            <button
              onclick="applyPreset('balanced')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap"
            >
              Balanced
            </button>
            <button
              onclick="applyPreset('accurate')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap"
            >
              Accurate
            </button>
            <button
              onclick="applyPreset('adaptive')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap"
            >
              Adaptive
            </button>
            <button
              onclick="applyPreset('robust')"
              class="preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap"
            >
              Noisy & Robust
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-4" id="config-sections">
        </div>

        <div
          class="p-5 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex flex-wrap items-center gap-3"
        >
          <button
            onclick="resetConfigToDefaults()"
            class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring"
          >
            Reset to Defaults
          </button>
          <button
            onclick="resetEverything()"
            class="px-4 py-2 text-sm rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors focus-ring"
          >
            Reset Everything
          </button>
          <div class="flex-1"></div>
          <button
            onclick="closeModal('config-modal')"
            class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            onclick="createModel()"
            class="px-6 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-colors focus-ring"
          >
            Create Model
          </button>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div
      id="upload-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('upload-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-xl sm:max-h-[90vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Upload Dataset</h2>
          <button
            onclick="closeModal('upload-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <!-- Drop Zone -->
          <div
            id="upload-dropzone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 dark:hover:border-blue-500 transition-colors"
            ondragover="handleDragOver(event)"
            ondrop="handleDrop(event)"
            onclick="document.getElementById('file-input').click()"
          >
            <svg
              class="w-12 h-12 mx-auto text-slate-400 mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="font-medium mb-1">
              Drop JSON file here or click to browse
            </p>
            <p class="text-sm text-slate-500 dark:text-slate-400">
              Supports .json files
            </p>
            <input
              type="file"
              id="file-input"
              accept=".json"
              class="hidden"
              onchange="handleFileSelect(event)"
            >
          </div>

          <div class="text-center text-sm text-slate-500 dark:text-slate-400">
            or
          </div>

          <!-- JSON Input -->
          <div>
            <label class="block text-sm font-medium mb-2"
            >Paste JSON directly:</label>
            <textarea
              id="upload-json-input"
              class="w-full h-40 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm font-mono resize-none focus-ring"
              placeholder='{"xCoordinates": [[1,2],[3,4]], "yCoordinates": [[5],[6]]}'
            ></textarea>
          </div>

          <!-- Format Example -->
          <details class="bg-slate-50 dark:bg-slate-900/50 rounded-xl">
            <summary class="px-4 py-3 cursor-pointer text-sm font-medium">
              View format example
            </summary>
            <div class="px-4 pb-4">
              <pre
                class="text-xs bg-slate-100 dark:bg-slate-700 p-3 rounded-lg overflow-x-auto"
              >
<code>{
  "xCoordinates": [
    [1.0, 2.0, 3.0],  // Sample 1: 3 features
    [1.1, 2.1, 3.1],  // Sample 2
    [1.2, 2.2, 3.2]   // Sample 3
  ],
  "yCoordinates": [
    [4.0, 5.0],       // Sample 1: 2 targets
    [4.1, 5.1],       // Sample 2
    [4.2, 5.2]        // Sample 3
  ]
}</code></pre>
              <button
                onclick="copyFormatExample()"
                class="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:underline"
              >
                Copy example
              </button>
            </div>
          </details>

          <!-- Validation Preview -->
          <div
            id="upload-preview"
            class="hidden bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-xl p-4"
          >
            <h4
              class="font-medium text-emerald-700 dark:text-emerald-300 mb-3 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Validation Passed
            </h4>
            <div class="grid grid-cols-2 gap-2 text-sm" id="preview-stats">
            </div>
          </div>

          <!-- Error Display -->
          <div
            id="upload-error"
            class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4"
          >
            <h4
              class="font-medium text-red-700 dark:text-red-300 mb-2 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Validation Error
            </h4>
            <p
              class="text-sm text-red-600 dark:text-red-400"
              id="upload-error-text"
            >
            </p>
          </div>
        </div>
        <div
          class="p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
        >
          <button
            onclick="closeModal('upload-modal')"
            class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            onclick="validateAndPreviewUpload()"
            class="px-4 py-2 text-sm rounded-lg bg-slate-600 hover:bg-slate-700 text-white transition-colors focus-ring"
          >
            Validate
          </button>
          <button
            onclick="applyUploadedData()"
            id="apply-upload-btn"
            class="px-6 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-colors focus-ring disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="insert-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('insert-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[90vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Manual Insert</h2>
          <button
            onclick="closeModal('insert-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Add a single sample or small batch to the training data.
          </p>
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">Sample JSON:</label>
              <button
                onclick="generateInsertTemplate()"
                class="text-xs text-blue-600 dark:text-blue-400 hover:underline"
              >
                Generate Template
              </button>
            </div>
            <textarea
              id="insert-json-input"
              class="w-full h-48 px-4 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl text-sm font-mono resize-none focus-ring"
              placeholder='{"xCoordinates": [[...]], "yCoordinates": [[...]]}'
            ></textarea>
          </div>
          <div id="insert-validation" class="text-sm"></div>
        </div>
        <div
          class="p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
        >
          <button
            onclick="closeModal('insert-modal')"
            class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            onclick="applyManualInsert()"
            class="px-6 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-colors focus-ring"
          >
            Insert & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Save/Load Modal -->
    <div
      id="load-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('load-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-lg sm:max-h-[90vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Save & Load Model</h2>
          <button
            onclick="closeModal('load-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-6">
          <!-- Save Section -->
          <div class="space-y-3">
            <h3 class="font-medium">Save Model</h3>
            <div class="flex gap-2">
              <button
                onclick="downloadModel()"
                class="flex-1 px-4 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors focus-ring flex items-center justify-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                  />
                </svg>
                Download File
              </button>
              <button
                onclick="saveToLocalStorage()"
                class="flex-1 px-4 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors focus-ring flex items-center justify-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                  />
                </svg>
                Save to Browser
              </button>
            </div>
          </div>

          <!-- Load Section -->
          <div class="space-y-3">
            <h3 class="font-medium">Load Model</h3>
            <div
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center cursor-pointer hover:border-blue-400 dark:hover:border-blue-500 transition-colors"
              onclick="document.getElementById('load-file-input').click()"
            >
              <svg
                class="w-10 h-10 mx-auto text-slate-400 mb-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              <p class="text-sm font-medium">Click to load from file</p>
              <input
                type="file"
                id="load-file-input"
                accept=".json"
                class="hidden"
                onchange="loadModelFromFile(event)"
              >
            </div>

            <!-- Saved Models List -->
            <div id="saved-models-list" class="space-y-2"></div>
          </div>

          <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
            <button
              onclick="clearLocalStorageModels()"
              class="text-sm text-red-600 dark:text-red-400 hover:underline"
            >
              Clear all saved models
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="random-test-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('random-test-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md sm:max-h-[90vh] bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Random Test</h2>
          <button
            onclick="closeModal('random-test-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Generate synthetic data to test the model's capabilities.
          </p>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Seed</label>
              <input
                type="number"
                id="test-seed"
                value="42"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Features</label>
              <input
                type="number"
                id="test-features"
                value="5"
                min="1"
                max="50"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Targets</label>
              <input
                type="number"
                id="test-targets"
                value="3"
                min="1"
                max="20"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Samples</label>
              <input
                type="number"
                id="test-samples"
                value="200"
                min="10"
                max="5000"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Noise Level</label>
              <input
                type="number"
                id="test-noise"
                value="0.1"
                min="0"
                max="1"
                step="0.05"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Outlier Rate</label>
              <input
                type="number"
                id="test-outliers"
                value="0.02"
                min="0"
                max="0.2"
                step="0.01"
                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
              >
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Difficulty</label>
            <select
              id="test-difficulty"
              class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring"
            >
              <option value="easy">Easy (Linear + Noise)</option>
              <option value="medium" selected>Medium (Nonlinear)</option>
              <option value="hard">Hard (Multi-scale)</option>
            </select>
          </div>
        </div>
        <div
          class="p-5 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
        >
          <button
            onclick="closeModal('random-test-modal')"
            class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors focus-ring"
          >
            Cancel
          </button>
          <button
            onclick="runRandomTest();closeModal('random-test-modal')"
            class="px-6 py-2 text-sm rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-medium transition-colors focus-ring"
          >
            Generate & Train & Predict
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settings-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('settings-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-md bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Settings</h2>
          <button
            onclick="closeModal('settings-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2"
            >ESNRegression Module URL</label>
            <input
              type="text"
              id="module-url-input"
              value="https://cdn.esm.sh/jsr/@hviana/multivariate-regression"
              class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm font-mono focus-ring"
            >
            <p class="text-xs text-slate-500 mt-1">
              Change if the default URL is unavailable
            </p>
          </div>
          <button
            onclick="reinitializeWorker()"
            class="w-full px-4 py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-lg text-sm font-medium hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors focus-ring"
          >
            Reinitialize Worker
          </button>

          <hr class="border-slate-200 dark:border-slate-700">

          <button
            onclick="clearAllPreferences()"
            class="w-full px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-sm font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors focus-ring"
          >
            Clear All Preferences
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="data-table-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('data-table-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-8 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Prediction Data Table</h2>
          <button
            onclick="closeModal('data-table-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex-1 overflow-auto p-5">
          <table class="w-full text-sm">
            <thead
              id="data-table-head"
              class="bg-slate-100 dark:bg-slate-700 sticky top-0"
            >
            </thead>
            <tbody id="data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div
      id="shortcuts-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onclick="closeModal('shortcuts-modal')"
      >
      </div>
      <div
        class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-full sm:max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in"
      >
        <div
          class="flex items-center justify-between p-5 border-b border-slate-200 dark:border-slate-700"
        >
          <h2 class="text-xl font-semibold">Keyboard Shortcuts</h2>
          <button
            onclick="closeModal('shortcuts-modal')"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus-ring"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="p-5 space-y-3">
          <div class="flex justify-between">
            <span>Open Menu</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >M</kbd>
          </div>
          <div class="flex justify-between">
            <span>Configure Model</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >C</kbd>
          </div>
          <div class="flex justify-between">
            <span>Upload Data</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >U</kbd>
          </div>
          <div class="flex justify-between">
            <span>Run Prediction</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >P</kbd>
          </div>
          <div class="flex justify-between">
            <span>Close Modal</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >Esc</kbd>
          </div>
          <div class="flex justify-between">
            <span>Show Shortcuts</span><kbd
              class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs font-mono"
            >?</kbd>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toast-container"
      class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"
      aria-live="polite"
    >
    </div>

    <script>
      const APP_VERSION = "1.0.0";
      const COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const DEFAULT_CONFIG = {
        maxSequenceLength: 64,
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        residualWindowSize: 100,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
        rollforwardMode: "holdLastX",
      };

      const PRESETS = {
        "start-here": { ...DEFAULT_CONFIG },
        "fast": {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          maxSequenceLength: 32,
          reservoirSparsity: 0.95,
        },
        "balanced": {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        "accurate": {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          maxSequenceLength: 128,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        "adaptive": {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        "robust": {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      const CONFIG_SECTIONS = [
        {
          id: "reservoir",
          title: "Reservoir Architecture",
          params: [
            {
              key: "maxSequenceLength",
              type: "number",
              label: "Max Sequence Length",
              min: 8,
              max: 512,
              step: 8,
              desc:
                "Maximum temporal context window and prediction horizon limit",
            },
            {
              key: "reservoirSize",
              type: "number",
              label: "Reservoir Size",
              min: 16,
              max: 2048,
              step: 16,
              desc: "Number of neurons in the reservoir hidden layer",
            },
            {
              key: "spectralRadius",
              type: "number",
              label: "Spectral Radius",
              min: 0.1,
              max: 1.5,
              step: 0.01,
              desc: "Controls memory length (0.8-0.99 typical)",
            },
            {
              key: "leakRate",
              type: "number",
              label: "Leak Rate",
              min: 0.01,
              max: 1.0,
              step: 0.01,
              desc:
                "Temporal smoothing (1=fast updates, 0=more smoothing)",
            },
            {
              key: "inputScale",
              type: "number",
              label: "Input Scale",
              min: 0.01,
              max: 10.0,
              step: 0.1,
              desc: "Scaling factor for input",
            },
            {
              key: "biasScale",
              type: "number",
              label: "Bias Scale",
              min: 0.0,
              max: 1.0,
              step: 0.01,
              desc: "Scaling for random bias values",
            },
            {
              key: "reservoirSparsity",
              type: "number",
              label: "Reservoir Sparsity",
              min: 0.0,
              max: 0.99,
              step: 0.01,
              desc: "Proportion of zero connections",
            },
            {
              key: "inputSparsity",
              type: "number",
              label: "Input Sparsity",
              min: 0.0,
              max: 0.99,
              step: 0.01,
              desc: "Sparsity of input connections",
            },
            {
              key: "activation",
              type: "select",
              label: "Activation",
              options: ["tanh", "relu"],
              desc: "Non-linear activation function",
            },
          ],
        },
        {
          id: "readout",
          title: "Readout Configuration",
          params: [
            {
              key: "useInputInReadout",
              type: "boolean",
              label: "Use Input in Readout",
              desc: "Append input to reservoir state for output",
            },
            {
              key: "useBiasInReadout",
              type: "boolean",
              label: "Use Bias in Readout",
              desc: "Include bias term in readout",
            },
          ],
        },
        {
          id: "training",
          title: "Training (RLS)",
          params: [
            {
              key: "readoutTraining",
              type: "fixed",
              label: "Training Algorithm",
              value: "rls",
              desc: "Recursive Least Squares",
            },
            {
              key: "rlsLambda",
              type: "number",
              label: "RLS Lambda",
              min: 0.9,
              max: 0.9999,
              step: 0.001,
              desc: "Forgetting factor (lower=faster adaptation)",
            },
            {
              key: "rlsDelta",
              type: "number",
              label: "RLS Delta",
              min: 0.01,
              max: 100.0,
              step: 0.1,
              desc: "Initial P matrix diagonal value",
            },
            {
              key: "epsilon",
              type: "number",
              label: "Epsilon",
              min: 1e-12,
              max: 1e-4,
              step: 1e-9,
              desc: "Numerical stability constant",
            },
            {
              key: "l2Lambda",
              type: "number",
              label: "L2 Lambda",
              min: 0.0,
              max: 0.1,
              step: 0.0001,
              desc: "L2 regularization strength",
            },
            {
              key: "gradientClipNorm",
              type: "number",
              label: "Gradient Clip Norm",
              min: 0.0,
              max: 10.0,
              step: 0.1,
              desc: "Maximum norm for updates",
            },
          ],
        },
        {
          id: "normalization",
          title: "Normalization",
          params: [
            {
              key: "normalizationEpsilon",
              type: "number",
              label: "Normalization Epsilon",
              min: 1e-12,
              max: 1e-4,
              step: 1e-9,
              desc: "Stability constant",
            },
            {
              key: "normalizationWarmup",
              type: "number",
              label: "Normalization Warmup",
              min: 1,
              max: 100,
              step: 1,
              desc: "Samples before normalization activates",
            },
          ],
        },
        {
          id: "outlier",
          title: "Outlier Handling",
          params: [
            {
              key: "outlierThreshold",
              type: "number",
              label: "Outlier Threshold",
              min: 1.0,
              max: 5.0,
              step: 0.1,
              desc: "Z-score threshold for outliers",
            },
            {
              key: "outlierMinWeight",
              type: "number",
              label: "Outlier Min Weight",
              min: 0.0,
              max: 1.0,
              step: 0.01,
              desc: "Minimum weight for outliers",
            },
          ],
        },
        {
          id: "uncertainty",
          title: "Uncertainty",
          params: [
            {
              key: "residualWindowSize",
              type: "number",
              label: "Residual Window Size",
              min: 10,
              max: 500,
              step: 10,
              desc: "Recent residuals for uncertainty",
            },
            {
              key: "uncertaintyMultiplier",
              type: "number",
              label: "Uncertainty Multiplier",
              min: 1.0,
              max: 3.5,
              step: 0.01,
              desc: "CI width multiplier (1.96=95%)",
            },
          ],
        },
        {
          id: "init",
          title: "Initialization",
          params: [
            {
              key: "weightInitScale",
              type: "number",
              label: "Weight Init Scale",
              min: 0.01,
              max: 1.0,
              step: 0.01,
              desc: "Initial weight scale factor",
            },
            {
              key: "seed",
              type: "number",
              label: "Seed",
              min: 0,
              max: 999999,
              step: 1,
              desc: "Random seed for reproducibility",
            },
            {
              key: "verbose",
              type: "boolean",
              label: "Verbose",
              desc: "Enable detailed logging",
            },
            {
              key: "rollforwardMode",
              type: "select",
              label: "Rollforward Mode",
              options: ["holdLastX", "autoregressive"],
              desc: "Multi-step prediction strategy",
            },
          ],
        },
      ];

      let state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nFeatures: 0,
        nTargets: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: "focus",
        selectedDim: 0,
        selectedStep: 0,
        isDark: false,
        logs: [],
        pendingRequests: new Map(),
        currentRequestId: null,
        uploadedData: null,
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        animation: { active: false, startTime: 0, duration: 0 },
      };

      let worker = null;
      let canvas, ctx;
      let resizeObserver;
      let animationFrameId;

      function initApp() {
        loadPreferences();
        initTheme();
        initWorker();
        initCanvas();
        initConfigSections();
        updateUI();
        setupEventListeners();
        log("info", "App", "ESN Regression Studio initialized");
      }

      function loadPreferences() {
        try {
          const prefs = localStorage.getItem("esn-prefs");
          if (prefs) {
            const p = JSON.parse(prefs);
            if (p.config) {
              state.config = { ...DEFAULT_CONFIG, ...p.config };
            }
            if (p.vizMode) state.vizMode = p.vizMode;
            if (p.isDark !== undefined) state.isDark = p.isDark;
          }
        } catch (e) {
          console.warn("Failed to load preferences:", e);
        }
      }

      function savePreferences() {
        try {
          localStorage.setItem(
            "esn-prefs",
            JSON.stringify({
              config: state.config,
              vizMode: state.vizMode,
              isDark: state.isDark,
            }),
          );
        } catch (e) {
          console.warn("Failed to save preferences:", e);
        }
      }

      function initTheme() {
        if (state.isDark) {
          document.documentElement.classList.add("dark");
        } else document.documentElement.classList.remove("dark");
      }

      function toggleTheme() {
        state.isDark = !state.isDark;
        initTheme();
        savePreferences();
        renderChart();
      }

      function getModuleUrl() {
        const input = document.getElementById("module-url-input");
        return input
          ? input.value
          : "https://cdn.esm.sh/jsr/@hviana/multivariate-regression";
      }

      function initWorker() {
        const workerCode = `
let ESNRegression = null;
let model = null;
let modelConfig = null;
let moduleUrl = 'https://cdn.esm.sh/jsr/@hviana/multivariate-regression';
let cancelled = new Set();

async function loadModule(url) {
  moduleUrl = url || moduleUrl;
  try {
    const mod = await import(moduleUrl);
    ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
    if (!ESNRegression) throw new Error('ESNRegression not found in module');
    return { success: true };
  } catch (e1) {
    try {
      const resp = await fetch(moduleUrl);
      const text = await resp.text();
      const blob = new Blob([text], { type: 'application/javascript' });
      const blobUrl = URL.createObjectURL(blob);
      const mod = await import(blobUrl);
      ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default;
      URL.revokeObjectURL(blobUrl);
      if (!ESNRegression) throw new Error('ESNRegression not found');
      return { success: true };
    } catch (e2) {
      return { success: false, error: 'Failed to load ESNRegression module: ' + e1.message + ' | Fallback: ' + e2.message };
    }
  }
}

function emitProgress(requestId, processed, total, stage) {
  self.postMessage({ type: 'progress', requestId, processed, total, percent: Math.round(processed/total*100), stage });
}

self.onmessage = async function(e) {
  const { requestId, type, payload } = e.data;
  
  if (type === 'cancel') {
    cancelled.add(payload.requestId);
    return;
  }
  
  try {
    let result;
    
    if (type === 'init') {
      const loadResult = await loadModule(payload.moduleUrl);
      if (!loadResult.success) {
        self.postMessage({ requestId, type: 'error', payload: { error: loadResult.error }});
        return;
      }
      result = { initialized: true };
    }
    
    else if (type === 'createModel') {
      if (!ESNRegression) {
        self.postMessage({ requestId, type: 'error', payload: { error: 'Module not loaded' }});
        return;
      }
      modelConfig = payload.config;
      model = new ESNRegression(modelConfig);
      result = { created: true, config: modelConfig };
    }
    
    else if (type === 'train') {
      if (!model) {
        self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }});
        return;
      }
      const { xCoordinates, yCoordinates } = payload;
      const total = xCoordinates.length;
      let lastResult = null;
      
      for (let i = 0; i < total; i++) {
        if (cancelled.has(requestId)) {
          cancelled.delete(requestId);
          self.postMessage({ requestId, type: 'cancelled', payload: { processed: i }});
          return;
        }
        lastResult = model.fitOnline({ xCoordinates: [xCoordinates[i]], yCoordinates: [yCoordinates[i]] });
        if (total > 10 && i % Math.max(1, Math.floor(total/50)) === 0) {
          emitProgress(requestId, i+1, total, 'Training samples');
        }
      }
      const summary = model.getModelSummary();
      result = { trained: true, samplesProcessed: total, summary, fitResult: lastResult };
    }
    
    else if (type === 'predict') {
      if (!model) {
        self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }});
        return;
      }
      const prediction = model.predict(payload.futureSteps);
      result = { predictions: prediction.predictions.slice(0, payload.futureSteps), lowerBounds: prediction.lowerBounds.slice(0, payload.futureSteps), upperBounds: prediction.upperBounds.slice(0, payload.futureSteps), confidence: prediction.confidence };
    }
    
    else if (type === 'save') {
      if (!model) {
        self.postMessage({ requestId, type: 'error', payload: { error: 'No model exists' }});
        return;
      }
      const savedState = model.save();
      const summary = model.getModelSummary();
      result = { modelState: savedState, meta: { config: modelConfig, nFeatures: summary.nFeatures, nTargets: summary.nTargets, sampleCount: summary.sampleCount, createdAt: new Date().toISOString(), appVersion: '1.0.0' }};
    }
    
    else if (type === 'load') {
      if (!ESNRegression) {
        self.postMessage({ requestId, type: 'error', payload: { error: 'Module not loaded' }});
        return;
      }
      let modelState, meta;
      if (typeof payload.data === 'string') {
        modelState = payload.data;
        meta = null;
      } else if (payload.data.modelState) {
        modelState = payload.data.modelState;
        meta = payload.data.meta;
      } else {
        self.postMessage({ requestId, type: 'error', payload: { error: 'Invalid model format' }});
        return;
      }
      model = new ESNRegression();
      model.load(modelState);
      const summary = model.getModelSummary();
      modelConfig = meta?.config || {};
      result = { loaded: true, summary, meta };
    }
    
    else if (type === 'getSummary') {
      if (!model) {
        result = { exists: false };
      } else {
        const summary = model.getModelSummary();
        result = { exists: true, summary };
      }
    }
    
    else if (type === 'reset') {
      if (model) model.reset();
      result = { reset: true };
    }
    
    self.postMessage({ requestId, type: 'result', payload: result });
  } catch (err) {
    self.postMessage({ requestId, type: 'error', payload: { error: err.message || String(err) }});
  }
};
`;

        const blob = new Blob([workerCode], {
          type: "application/javascript",
        });
        worker = new Worker(URL.createObjectURL(blob), {
          type: "module",
        });

        worker.onmessage = (e) => {
          const { requestId, type, payload } = e.data;

          if (type === "progress") {
            updateProgress(
              payload.processed,
              payload.total,
              payload.stage,
            );
            return;
          }

          const pending = state.pendingRequests.get(requestId);
          if (pending) {
            state.pendingRequests.delete(requestId);
            if (type === "error") {
              pending.reject(new Error(payload.error));
            } else if (type === "cancelled") {
              pending.resolve({ cancelled: true, ...payload });
            } else pending.resolve(payload);
          }

          if (state.pendingRequests.size === 0) hideLoading();
        };

        worker.onerror = (e) => {
          console.error("Worker error:", e);
          showToast("error", "Worker error: " + e.message);
        };

        workerRequest("init", { moduleUrl: getModuleUrl() })
          .then(() =>
            log("success", "Worker", "ESNRegression module loaded")
          )
          .catch((err) => {
            log("error", "Worker", err.message);
            showToast(
              "error",
              "Failed to load ESNRegression module. Check Settings.",
            );
          });
      }

      function reinitializeWorker() {
        if (worker) worker.terminate();
        initWorker();
        showToast("info", "Worker reinitialized");
        closeModal("settings-modal");
      }

      function workerRequest(type, payload = {}) {
        return new Promise((resolve, reject) => {
          const requestId = crypto.randomUUID();
          state.pendingRequests.set(requestId, { resolve, reject });
          state.currentRequestId = requestId;
          worker.postMessage({ requestId, type, payload });
        });
      }

      function cancelOperation() {
        if (state.currentRequestId) {
          worker.postMessage({
            requestId: "",
            type: "cancel",
            payload: { requestId: state.currentRequestId },
          });
          log("warning", "Operation", "Cancelled by user");
        }
      }

      function initCanvas() {
        canvas = document.getElementById("main-canvas");
        ctx = canvas.getContext("2d");

        resizeObserver = new ResizeObserver(debounce(() => {
          resizeCanvas();
          renderChart();
        }, 150));
        resizeObserver.observe(canvas.parentElement);

        canvas.addEventListener("mousemove", handleCanvasHover);
        canvas.addEventListener("mouseleave", handleCanvasLeave);
        canvas.addEventListener("wheel", handleCanvasWheel, {
          passive: false,
        });
        canvas.addEventListener("click", handleCanvasClick);

        resizeCanvas();
      }

      function resizeCanvas() {
        const container = canvas.parentElement;
        const rect = container.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
      }

      function initConfigSections() {
        const container = document.getElementById("config-sections");
        container.innerHTML = CONFIG_SECTIONS.map((section) => `
    <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
      <button onclick="toggleSection('${section.id}')" class="w-full flex items-center justify-between px-4 py-3 bg-slate-50 dark:bg-slate-900/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors text-left">
        <span class="font-medium">${section.title}</span>
        <svg class="w-5 h-5 transform transition-transform section-chevron-${section.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div class="collapsible-content open section-content-${section.id}">
        <div class="p-4 space-y-4">
          ${section.params.map((p) => renderConfigParam(p)).join("")}
        </div>
      </div>
    </div>
  `).join("");

        updateConfigValues();
      }

      function renderConfigParam(p) {
        const value = state.config[p.key];
        if (p.type === "number") {
          return `
      <div class="space-y-1">
        <div class="flex items-center justify-between">
          <label class="text-sm font-medium">${p.label}</label>
          <input type="number" id="cfg-${p.key}" value="${value}" min="${p.min}" max="${p.max}" step="${p.step}" class="w-24 px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-sm text-right focus-ring" onchange="updateConfigValue('${p.key}', this.value)">
        </div>
        <p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p>
      </div>`;
        } else if (p.type === "boolean") {
          return `
      <div class="flex items-center justify-between">
        <div>
          <label class="text-sm font-medium">${p.label}</label>
          <p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p>
        </div>
        <button onclick="toggleConfigBool('${p.key}')" class="relative w-11 h-6 rounded-full transition-colors ${
            value ? "bg-blue-600" : "bg-slate-300 dark:bg-slate-600"
          }" id="cfg-${p.key}-btn">
          <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${
            value ? "translate-x-5" : ""
          }"></span>
        </button>
      </div>`;
        } else if (p.type === "select") {
          return `
      <div class="space-y-1">
        <label class="text-sm font-medium">${p.label}</label>
        <select id="cfg-${p.key}" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm focus-ring" onchange="updateConfigValue('${p.key}', this.value)">
          ${
            p.options.map((o) =>
              `<option value="${o}" ${
                value === o ? "selected" : ""
              }>${o}</option>`
            ).join("")
          }
        </select>
        <p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p>
      </div>`;
        } else if (p.type === "fixed") {
          return `
      <div class="flex items-center justify-between">
        <div>
          <label class="text-sm font-medium">${p.label}</label>
          <p class="text-xs text-slate-500 dark:text-slate-400">${p.desc}</p>
        </div>
        <span class="px-3 py-1 bg-slate-200 dark:bg-slate-600 rounded text-sm font-mono">${p.value}</span>
      </div>`;
        }
        return "";
      }

      function toggleSection(id) {
        const content = document.querySelector(
          `.section-content-${id}`,
        );
        const chevron = document.querySelector(
          `.section-chevron-${id}`,
        );
        content.classList.toggle("open");
        chevron.classList.toggle("rotate-180");
      }

      function updateConfigValue(key, value) {
        const param = CONFIG_SECTIONS.flatMap((s) => s.params).find(
          (p) => p.key === key,
        );
        if (param?.type === "number") {
          state.config[key] = parseFloat(value);
        } else state.config[key] = value;
      }

      function toggleConfigBool(key) {
        state.config[key] = !state.config[key];
        updateConfigValues();
      }

      function updateConfigValues() {
        CONFIG_SECTIONS.flatMap((s) => s.params).forEach((p) => {
          if (p.type === "boolean") {
            // Handle boolean toggles separately - they use -btn suffix
            const btn = document.getElementById(`cfg-${p.key}-btn`);
            if (btn) {
              btn.className =
                `relative w-11 h-6 rounded-full transition-colors ${
                  state.config[p.key]
                    ? "bg-blue-600"
                    : "bg-slate-300 dark:bg-slate-600"
                }`;
              btn.querySelector("span").className =
                `absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${
                  state.config[p.key] ? "translate-x-5" : ""
                }`;
            }
          } else {
            // Handle other input types (number, select)
            const el = document.getElementById(`cfg-${p.key}`);
            if (el) {
              el.value = state.config[p.key];
            }
          }
        });
      }

      function applyPreset(preset) {
        state.config = { ...PRESETS[preset] };
        updateConfigValues();
        log("info", "Config", `Applied preset: ${preset}`);
      }

      function resetConfigToDefaults() {
        state.config = { ...DEFAULT_CONFIG };
        updateConfigValues();
        log("info", "Config", "Reset to defaults");
      }

      function resetEverything() {
        if (
          !confirm(
            "This will clear the model, all data, and all settings. Continue?",
          )
        ) return;
        state = {
          ...state,
          config: { ...DEFAULT_CONFIG },
          modelExists: false,
          nFeatures: 0,
          nTargets: 0,
          sampleCount: 0,
          predictions: null,
          logs: [],
          metrics: {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          },
        };
        localStorage.clear();
        workerRequest("reset");
        updateConfigValues();
        updateUI();
        renderChart();
        log("warning", "Reset", "All data cleared");
        showToast("warning", "All data has been cleared");
      }

      async function createModel() {
        showLoading("Creating model...");
        try {
          const result = await workerRequest("createModel", {
            config: state.config,
          });
          state.modelExists = true;
          state.sampleCount = 0;
          state.predictions = null;
          savePreferences();
          updateUI();
          renderChart();
          closeModal("config-modal");
          log("success", "Model", "Model created successfully");
          showToast("success", "Model created");
        } catch (err) {
          log("error", "Model", err.message);
          showToast("error", "Failed to create model: " + err.message);
        }
      }

      function setupEventListeners() {
        document.addEventListener("keydown", (e) => {
          if (
            e.target.tagName === "INPUT" ||
            e.target.tagName === "TEXTAREA"
          ) return;
          if (e.key === "m" || e.key === "M") toggleMainMenu();
          else if (e.key === "c" || e.key === "C") {
            openModal("config-modal");
          } else if (e.key === "u" || e.key === "U") {
            openModal("upload-modal");
          } else if (
            (e.key === "p" || e.key === "P") && state.modelExists
          ) runPrediction();
          else if (e.key === "Escape") closeAllModals();
          else if (e.key === "?") openModal("shortcuts-modal");
        });

        setVisualizationMode(state.vizMode);
      }

      function toggleMainMenu() {
        const menu = document.getElementById("main-menu");
        const overlay = document.getElementById("main-menu-overlay");
        const isOpen = !menu.classList.contains("translate-x-full");

        if (isOpen) {
          menu.classList.add("translate-x-full");
          overlay.classList.add("hidden");
        } else {
          menu.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        }
      }

      function toggleSidePanel() {
        const panel = document.getElementById("side-panel");
        panel.classList.toggle("hidden");
      }

      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(id).querySelector("button")?.focus();
        if (id === "load-modal") updateSavedModelsList();
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function closeAllModals() {
        [
          "config-modal",
          "upload-modal",
          "insert-modal",
          "load-modal",
          "random-test-modal",
          "settings-modal",
          "data-table-modal",
          "shortcuts-modal",
        ].forEach(closeModal);
        const menu = document.getElementById("main-menu");
        if (!menu.classList.contains("translate-x-full")) {
          toggleMainMenu();
        }
      }

      function showLoading(text = "Processing...") {
        document.getElementById("loading-state").classList.remove(
          "hidden",
        );
        document.getElementById("loading-text").textContent = text;
        document.getElementById("progress-container").classList.add(
          "hidden",
        );
      }

      function hideLoading() {
        document.getElementById("loading-state").classList.add(
          "hidden",
        );
      }

      function updateProgress(processed, total, stage) {
        const container = document.getElementById("progress-container");
        const bar = document.getElementById("progress-bar");
        const text = document.getElementById("progress-text");
        container.classList.remove("hidden");
        const pct = Math.round(processed / total * 100);
        bar.style.width = pct + "%";
        text.textContent = `${stage}: ${processed}/${total} (${pct}%)`;
      }

      function showToast(type, message) {
        const container = document.getElementById("toast-container");
        const colors = {
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };
        const toast = document.createElement("div");
        toast.className =
          `toast-enter px-4 py-3 rounded-xl shadow-lg text-white flex items-center gap-3 ${
            colors[type]
          }`;
        toast.innerHTML = `
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" class="p-1 hover:bg-white/20 rounded">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>`;
        container.appendChild(toast);
        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : 4000,
        );
      }

      function log(type, category, message) {
        const entry = { type, category, message, time: new Date() };
        state.logs.unshift(entry);
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = document.getElementById("event-log");
        const filter = document.getElementById("log-filter").value;
        const search = document.getElementById("log-search").value
          .toLowerCase();

        const filtered = state.logs.filter((l) => {
          if (filter !== "all" && l.type !== filter) return false;
          if (
            search && !l.message.toLowerCase().includes(search) &&
            !l.category.toLowerCase().includes(search)
          ) return false;
          return true;
        });

        container.innerHTML = filtered.slice(0, 50).map((l) => {
          const colors = {
            info: "text-blue-500",
            success: "text-emerald-500",
            warning: "text-amber-500",
            error: "text-red-500",
          };
          return `
      <div class="text-xs p-2 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
        <div class="flex items-center gap-2 mb-1">
          <span class="${
            colors[l.type]
          } font-medium">${l.category}</span>
          <span class="text-slate-400">${l.time.toLocaleTimeString()}</span>
        </div>
        <p class="text-slate-600 dark:text-slate-300">${l.message}</p>
      </div>`;
        }).join("");
      }

      function filterLogs() {
        renderLogs();
      }

      function updateUI() {
        const statusDot = document.getElementById("status-dot");
        const statusText = document.getElementById("status-text");
        const emptyState = document.getElementById("empty-state");
        const chartControls = document.getElementById("chart-controls");
        const predictBtn = document.getElementById("predict-btn");
        const predictBtnSide = document.getElementById(
          "predict-btn-side",
        );

        if (state.modelExists) {
          statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
          statusText.textContent = `${state.sampleCount} samples`;
          emptyState.classList.add("hidden");
          predictBtn.classList.remove("hidden");
          predictBtnSide.disabled = false;
        } else {
          statusDot.className = "w-2 h-2 rounded-full bg-slate-400";
          statusText.textContent = "No Model";
          if (!state.predictions) emptyState.classList.remove("hidden");
          predictBtn.classList.add("hidden");
          predictBtnSide.disabled = true;
        }

        chartControls.classList.toggle("hidden", !state.predictions);

        document.getElementById("metric-samples").textContent =
          state.sampleCount;
        document.getElementById("metric-loss").textContent =
          state.metrics.avgLoss !== null
            ? state.metrics.avgLoss.toExponential(3)
            : "-";
        document.getElementById("metric-gradient").textContent =
          state.metrics.gradientNorm !== null
            ? state.metrics.gradientNorm.toExponential(3)
            : "-";
        document.getElementById("metric-weight").textContent =
          state.metrics.sampleWeight !== null
            ? state.metrics.sampleWeight.toFixed(3)
            : "-";

        updateFutureStepsMax();
        updateDimensionButtons();
        updateStatsBar();
      }

      function updateFutureStepsMax() {
        const max = state.config.maxSequenceLength;
        document.getElementById("future-steps-range").max = max;
        document.getElementById("future-steps-input").max = max;
      }

      function syncFutureSteps(val) {
        const v = Math.max(
          1,
          Math.min(parseInt(val) || 1, state.config.maxSequenceLength),
        );
        document.getElementById("future-steps-range").value = v;
        document.getElementById("future-steps-input").value = v;
      }

      function setVisualizationMode(mode) {
        state.vizMode = mode;
        document.querySelectorAll(".viz-tab").forEach((btn) => {
          btn.classList.toggle(
            "bg-blue-600",
            btn.dataset.mode === mode,
          );
          btn.classList.toggle("text-white", btn.dataset.mode === mode);
          btn.classList.toggle(
            "bg-slate-100",
            btn.dataset.mode !== mode,
          );
          btn.classList.toggle(
            "dark:bg-slate-700",
            btn.dataset.mode !== mode,
          );
        });

        document.getElementById("dimension-selector").classList.toggle(
          "hidden",
          mode !== "focus",
        );
        document.getElementById("stats-bar").classList.toggle(
          "hidden",
          mode !== "focus",
        );

        savePreferences();
        renderChart();
      }

      function updateDimensionButtons() {
        const container = document.getElementById("dim-buttons");
        if (!state.predictions || state.nTargets === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = Array.from(
          { length: state.nTargets },
          (_, i) => `
    <button onclick="selectDimension(${i})" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
            state.selectedDim === i
              ? "text-white"
              : "bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600"
          }" style="${
            state.selectedDim === i ? "background:" + getColor(i) : ""
          }">
      Target ${i + 1}
    </button>
  `,
        ).join("");
      }

      function selectDimension(i) {
        state.selectedDim = i;
        updateDimensionButtons();
        updateStatsBar();
        renderChart();
      }

      function updateStatsBar() {
        if (!state.predictions || state.vizMode !== "focus") return;

        const dim = state.selectedDim;
        const preds = state.predictions.predictions.map((p) => p[dim]);
        const min = Math.min(...preds);
        const max = Math.max(...preds);
        const mean = preds.reduce((a, b) => a + b, 0) / preds.length;
        const final = preds[preds.length - 1];
        const trend = preds.length > 1
          ? (preds[preds.length - 1] - preds[0])
          : 0;

        document.getElementById("stat-min").textContent = formatNumber(
          min,
        );
        document.getElementById("stat-max").textContent = formatNumber(
          max,
        );
        document.getElementById("stat-mean").textContent = formatNumber(
          mean,
        );
        document.getElementById("stat-final").textContent =
          formatNumber(final);
        document.getElementById("stat-trend").innerHTML = `${
          trend >= 0 ? "" : ""
        } <span class="${
          trend >= 0 ? "text-emerald-500" : "text-red-500"
        }">${formatNumber(Math.abs(trend))}</span>`;
        document.getElementById("stat-confidence").textContent = `${
          (state.predictions.confidence * 100).toFixed(1)
        }%`;
      }

      function getColor(index) {
        return COLORS[index % COLORS.length];
      }

      function formatNumber(n) {
        if (Math.abs(n) < 0.01 || Math.abs(n) >= 10000) {
          return n.toExponential(2);
        }
        return n.toFixed(Math.abs(n) < 1 ? 4 : 2);
      }

      function renderChart() {
        if (!canvas || !ctx) return;

        const dpr = window.devicePixelRatio || 1;
        const w = canvas.width / dpr;
        const h = canvas.height / dpr;

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);

        const isDark = state.isDark;
        ctx.fillStyle = isDark ? "#0F172A" : "#FFFFFF";
        ctx.fillRect(0, 0, w, h);

        if (!state.predictions) return;

        switch (state.vizMode) {
          case "grid":
            renderGridView(w, h, isDark);
            break;
          case "focus":
            renderFocusView(w, h, isDark);
            break;
          case "heatmap":
            renderHeatmapView(w, h, isDark);
            break;
          case "uncertainty":
            renderUncertaintyView(w, h, isDark);
            break;
          case "bar":
            renderBarView(w, h, isDark);
            break;
        }
      }

      function renderFocusView(w, h, isDark) {
        const margin = { left: 65, right: 24, top: 24, bottom: 45 };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;

        const dim = state.selectedDim;
        const allPreds = state.predictions.predictions.map((p) =>
          p[dim]
        );
        const allLowers = state.predictions.lowerBounds.map((p) =>
          p[dim]
        );
        const allUppers = state.predictions.upperBounds.map((p) =>
          p[dim]
        );

        const totalPoints = allPreds.length;

        // === ZOOM LOGIC: Calculate visible range ===
        const visibleCount = Math.max(
          2,
          Math.ceil(totalPoints / state.zoom.level),
        );
        const maxStartIndex = Math.max(0, totalPoints - visibleCount);
        const startIndex = Math.min(
          Math.max(0, Math.floor(state.zoom.offsetX)),
          maxStartIndex,
        );
        const endIndex = Math.min(
          startIndex + visibleCount,
          totalPoints,
        );

        // Store for hover calculations
        state.zoom.visibleStart = startIndex;
        state.zoom.visibleCount = endIndex - startIndex;

        const preds = allPreds.slice(startIndex, endIndex);
        const lowers = allLowers.slice(startIndex, endIndex);
        const uppers = allUppers.slice(startIndex, endIndex);
        // === END ZOOM LOGIC ===

        const allVals = [...preds, ...lowers, ...uppers];
        let minY = Math.min(...allVals);
        let maxY = Math.max(...allVals);
        const padding = (maxY - minY) * 0.12 || 1;
        minY -= padding;
        maxY += padding;

        const xScale = (i) =>
          margin.left + (i / (preds.length - 1 || 1)) * plotW;
        const yScale = (v) =>
          margin.top + plotH - ((v - minY) / (maxY - minY)) * plotH;

        // Grid
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.05)"
          : "rgba(0,0,0,0.05)";
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;

        const yTicks = niceScale(minY, maxY, 6);
        yTicks.forEach((tick) => {
          const y = yScale(tick);
          ctx.beginPath();
          ctx.moveTo(margin.left, y);
          ctx.lineTo(w - margin.right, y);
          ctx.stroke();
        });

        ctx.setLineDash([]);

        // Axes
        ctx.strokeStyle = isDark
          ? "rgba(255,255,255,0.12)"
          : "rgba(0,0,0,0.12)";
        ctx.beginPath();
        ctx.moveTo(margin.left, margin.top);
        ctx.lineTo(margin.left, h - margin.bottom);
        ctx.lineTo(w - margin.right, h - margin.bottom);
        ctx.stroke();

        // Y-axis labels
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = "500 11px system-ui";
        ctx.textAlign = "right";
        yTicks.forEach((tick) => {
          ctx.fillText(
            formatNumber(tick),
            margin.left - 8,
            yScale(tick) + 4,
          );
        });

        // X-axis labels (adjusted for zoom offset)
        ctx.textAlign = "center";
        const xStep = Math.max(1, Math.ceil(preds.length / 8));
        for (let i = 0; i < preds.length; i += xStep) {
          ctx.fillText(
            startIndex + i + 1,
            xScale(i),
            h - margin.bottom + 20,
          );
        }

        const color = getColor(dim);

        // Confidence band
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(uppers[0]));
        for (let i = 1; i < preds.length; i++) {
          ctx.lineTo(xScale(i), yScale(uppers[i]));
        }
        for (let i = preds.length - 1; i >= 0; i--) {
          ctx.lineTo(xScale(i), yScale(lowers[i]));
        }
        ctx.closePath();

        const gradient = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          h - margin.bottom,
        );
        gradient.addColorStop(0, color + (isDark ? "1F" : "14"));
        gradient.addColorStop(1, color + (isDark ? "0A" : "05"));
        ctx.fillStyle = gradient;
        ctx.fill();

        // Band borders
        ctx.strokeStyle = color + "40";
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(uppers[0]));
        for (let i = 1; i < preds.length; i++) {
          ctx.lineTo(xScale(i), yScale(uppers[i]));
        }
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(lowers[0]));
        for (let i = 1; i < preds.length; i++) {
          ctx.lineTo(xScale(i), yScale(lowers[i]));
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // Glow effect
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        [8, 4, 2.5].forEach((lw, idx) => {
          ctx.strokeStyle = color + ["1A", "33", "FF"][idx];
          ctx.lineWidth = lw;
          ctx.beginPath();
          ctx.moveTo(xScale(0), yScale(preds[0]));
          for (let i = 1; i < preds.length; i++) {
            const x0 = xScale(i - 1), y0 = yScale(preds[i - 1]);
            const x1 = xScale(i), y1 = yScale(preds[i]);
            const cpx = (x0 + x1) / 2;
            ctx.quadraticCurveTo(
              cpx,
              y0,
              (cpx + x1) / 2,
              (y0 + y1) / 2,
            );
          }
          ctx.lineTo(
            xScale(preds.length - 1),
            yScale(preds[preds.length - 1]),
          );
          ctx.stroke();
        });

        // Hover
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const localIdx = state.hover.dataIndex;
          if (localIdx >= 0 && localIdx < preds.length) {
            const hx = xScale(localIdx);
            const hy = yScale(preds[localIdx]);
            const actualIdx = startIndex + localIdx;

            // Crosshair
            ctx.strokeStyle = isDark
              ? "rgba(255,255,255,0.3)"
              : "rgba(0,0,0,0.2)";
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(hx, margin.top);
            ctx.lineTo(hx, h - margin.bottom);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(margin.left, hy);
            ctx.lineTo(hx, hy);
            ctx.stroke();
            ctx.setLineDash([]);

            // Point highlight
            ctx.strokeStyle = color + "33";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(hx, hy, 6, 0, Math.PI * 2);
            ctx.stroke();

            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(hx, hy, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.stroke();

            // Tooltip (use actualIdx for display)
            updateTooltip(
              hx,
              hy,
              actualIdx,
              dim,
              preds[localIdx],
              lowers[localIdx],
              uppers[localIdx],
              w,
              h,
            );
          }
        }
      }

      function renderGridView(w, h, isDark) {
        const cols = w < 640 ? 2 : w < 1024 ? 3 : w < 1400 ? 4 : 5;
        const rows = Math.ceil(state.nTargets / cols);
        const cellW = Math.floor((w - 20) / cols);
        const cellH = Math.min(110, Math.floor((h - 20) / rows));
        const gap = 10;

        for (let d = 0; d < state.nTargets; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = 10 + col * (cellW + gap);
          const y = 10 + row * (cellH + gap);

          if (y + cellH > h) continue;

          // Cell background
          ctx.fillStyle = isDark ? "#1E293B" : "#F8FAFC";
          ctx.beginPath();
          ctx.roundRect(x, y, cellW, cellH, 8);
          ctx.fill();

          const preds = state.predictions.predictions.map((p) => p[d]);
          const lowers = state.predictions.lowerBounds.map((p) => p[d]);
          const uppers = state.predictions.upperBounds.map((p) => p[d]);

          const margin = 8;
          const pW = cellW - margin * 2;
          const pH = cellH - 30;

          const allVals = [...preds, ...lowers, ...uppers];
          let minY = Math.min(...allVals);
          let maxY = Math.max(...allVals);
          const pad = (maxY - minY) * 0.1 || 1;
          minY -= pad;
          maxY += pad;

          const xs = (i) =>
            x + margin + (i / (preds.length - 1 || 1)) * pW;
          const ys = (v) =>
            y + 20 + pH - ((v - minY) / (maxY - minY)) * pH;

          const color = getColor(d);

          // Band
          ctx.fillStyle = color + "1A";
          ctx.beginPath();
          ctx.moveTo(xs(0), ys(uppers[0]));
          for (let i = 1; i < preds.length; i++) {
            ctx.lineTo(xs(i), ys(uppers[i]));
          }
          for (let i = preds.length - 1; i >= 0; i--) {
            ctx.lineTo(xs(i), ys(lowers[i]));
          }
          ctx.closePath();
          ctx.fill();

          // Line
          ctx.strokeStyle = color;
          ctx.lineWidth = 1.5;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(xs(0), ys(preds[0]));
          for (let i = 1; i < preds.length; i++) {
            ctx.lineTo(xs(i), ys(preds[i]));
          }
          ctx.stroke();

          // Label
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "500 10px system-ui";
          ctx.textAlign = "left";
          ctx.fillText(`T${d + 1}`, x + 6, y + 14);

          // Value
          ctx.textAlign = "right";
          ctx.fillStyle = color;
          ctx.fillText(
            formatNumber(preds[preds.length - 1]),
            x + cellW - 6,
            y + 14,
          );
        }
      }

      function renderHeatmapView(w, h, isDark) {
        const margin = { left: 60, right: 40, top: 24, bottom: 30 };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;

        const steps = state.predictions.predictions.length;
        const dims = state.nTargets;

        const cellW = Math.max(10, plotW / steps);
        const cellH = Math.max(10, plotH / dims);

        // Find range
        const allVals = state.predictions.predictions.flat();
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        // Draw cells
        for (let d = 0; d < dims; d++) {
          for (let s = 0; s < steps; s++) {
            const val = state.predictions.predictions[s][d];
            const norm = (val - minVal) / range;

            const cx = margin.left + s * cellW;
            const cy = margin.top + d * cellH;

            // Color scale
            const r = Math.round(59 + (239 - 59) * norm);
            const g = Math.round(130 + (68 - 130) * norm);
            const b = Math.round(246 + (68 - 246) * norm);
            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(cx, cy, cellW - 1, cellH - 1);
          }
        }

        // Y-axis labels
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = "500 10px system-ui";
        ctx.textAlign = "right";
        for (let d = 0; d < dims; d++) {
          ctx.fillText(
            `T${d + 1}`,
            margin.left - 8,
            margin.top + d * cellH + cellH / 2 + 4,
          );
        }

        // X-axis labels
        ctx.textAlign = "center";
        const xStep = Math.max(1, Math.ceil(steps / 10));
        for (let s = 0; s < steps; s += xStep) {
          ctx.fillText(
            s + 1,
            margin.left + s * cellW + cellW / 2,
            h - margin.bottom + 16,
          );
        }

        // Legend
        const legendW = 20;
        const legendH = plotH;
        const legendX = w - margin.right + 10;
        const legendY = margin.top;

        const grad = ctx.createLinearGradient(
          0,
          legendY,
          0,
          legendY + legendH,
        );
        grad.addColorStop(0, "rgb(239,68,68)");
        grad.addColorStop(0.5, "rgb(59,130,246)");
        grad.addColorStop(1, "rgb(59,130,246)");
        ctx.fillStyle = grad;
        ctx.fillRect(legendX, legendY, legendW, legendH);

        ctx.textAlign = "left";
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.fillText(
          formatNumber(maxVal),
          legendX + legendW + 4,
          legendY + 10,
        );
        ctx.fillText(
          formatNumber(minVal),
          legendX + legendW + 4,
          legendY + legendH,
        );
      }

      function renderUncertaintyView(w, h, isDark) {
        const margin = { left: 65, right: 100, top: 40, bottom: 45 };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;

        // Calculate uncertainty per step (avg across dims)
        const uncertainties = state.predictions.predictions.map(
          (_, i) => {
            let sum = 0;
            for (let d = 0; d < state.nTargets; d++) {
              sum += state.predictions.upperBounds[i][d] -
                state.predictions.lowerBounds[i][d];
            }
            return sum / state.nTargets;
          },
        );

        const maxU = Math.max(...uncertainties);
        const minU = Math.min(...uncertainties);
        const range = maxU - minU || 1;

        const xScale = (i) =>
          margin.left + (i / (uncertainties.length - 1 || 1)) * plotW;
        const yScale = (v) =>
          margin.top + plotH - ((v - minU) / range) * plotH;

        // Area
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(minU));
        for (let i = 0; i < uncertainties.length; i++) {
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
        }
        ctx.lineTo(xScale(uncertainties.length - 1), yScale(minU));
        ctx.closePath();

        const grad = ctx.createLinearGradient(
          0,
          margin.top,
          0,
          h - margin.bottom,
        );
        grad.addColorStop(0, "#EF444480");
        grad.addColorStop(0.5, "#F59E0B60");
        grad.addColorStop(1, "#10B98140");
        ctx.fillStyle = grad;
        ctx.fill();

        // Line
        ctx.strokeStyle = "#F59E0B";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(xScale(0), yScale(uncertainties[0]));
        for (let i = 1; i < uncertainties.length; i++) {
          ctx.lineTo(xScale(i), yScale(uncertainties[i]));
        }
        ctx.stroke();

        // Axes
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.font = "500 11px system-ui";
        ctx.textAlign = "right";
        ctx.fillText(
          formatNumber(maxU),
          margin.left - 8,
          margin.top + 4,
        );
        ctx.fillText(
          formatNumber(minU),
          margin.left - 8,
          h - margin.bottom,
        );

        ctx.textAlign = "center";
        for (
          let i = 0;
          i < uncertainties.length;
          i += Math.max(1, Math.ceil(uncertainties.length / 8))
        ) {
          ctx.fillText(i + 1, xScale(i), h - margin.bottom + 20);
        }

        // Confidence gauge
        const conf = state.predictions.confidence;
        const gaugeX = w - 70;
        const gaugeY = margin.top + 40;
        const gaugeR = 35;

        ctx.beginPath();
        ctx.arc(gaugeX, gaugeY, gaugeR, Math.PI, 2 * Math.PI);
        ctx.strokeStyle = isDark ? "#374151" : "#E5E7EB";
        ctx.lineWidth = 8;
        ctx.stroke();

        const confColor = conf > 0.8
          ? "#10B981"
          : conf > 0.5
          ? "#F59E0B"
          : "#EF4444";
        ctx.beginPath();
        ctx.arc(
          gaugeX,
          gaugeY,
          gaugeR,
          Math.PI,
          Math.PI + conf * Math.PI,
        );
        ctx.strokeStyle = confColor;
        ctx.stroke();

        ctx.fillStyle = isDark ? "#F1F5F9" : "#1E293B";
        ctx.font = "bold 16px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(`${(conf * 100).toFixed(0)}%`, gaugeX, gaugeY + 6);

        ctx.font = "500 10px system-ui";
        ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
        ctx.fillText("Confidence", gaugeX, gaugeY + 25);
      }

      function renderBarView(w, h, isDark) {
        const margin = { left: 80, right: 24, top: 24, bottom: 40 };
        const plotW = w - margin.left - margin.right;
        const plotH = h - margin.top - margin.bottom;

        const step = Math.min(
          state.selectedStep,
          state.predictions.predictions.length - 1,
        );
        const preds = state.predictions.predictions[step];
        const lowers = state.predictions.lowerBounds[step];
        const uppers = state.predictions.upperBounds[step];

        const maxVal = Math.max(...uppers);
        const minVal = Math.min(...lowers, 0);
        const range = maxVal - minVal || 1;

        const barH = Math.min(30, plotH / state.nTargets - 4);

        for (let d = 0; d < state.nTargets; d++) {
          const y = margin.top + d * (barH + 4);
          const val = preds[d];
          const lower = lowers[d];
          const upper = uppers[d];

          const barW = ((val - minVal) / range) * plotW;
          const errorStart = ((lower - minVal) / range) * plotW;
          const errorEnd = ((upper - minVal) / range) * plotW;

          const color = getColor(d);

          // Bar
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.roundRect(margin.left, y, barW, barH, 4);
          ctx.fill();

          // Error bar
          ctx.strokeStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.lineWidth = 1.5;
          const ey = y + barH / 2;
          ctx.beginPath();
          ctx.moveTo(margin.left + errorStart, ey);
          ctx.lineTo(margin.left + errorEnd, ey);
          ctx.moveTo(margin.left + errorStart, ey - 4);
          ctx.lineTo(margin.left + errorStart, ey + 4);
          ctx.moveTo(margin.left + errorEnd, ey - 4);
          ctx.lineTo(margin.left + errorEnd, ey + 4);
          ctx.stroke();

          // Label
          ctx.fillStyle = isDark ? "#94A3B8" : "#64748B";
          ctx.font = "500 11px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(`T${d + 1}`, margin.left - 8, y + barH / 2 + 4);

          // Value
          ctx.textAlign = "left";
          ctx.fillText(
            formatNumber(val),
            margin.left + barW + 8,
            y + barH / 2 + 4,
          );
        }

        // Step indicator
        ctx.fillStyle = isDark ? "#F1F5F9" : "#1E293B";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(`Step ${step + 1}`, w / 2, h - 10);
      }

      function updateTooltip(
        x,
        y,
        idx,
        dim,
        pred,
        lower,
        upper,
        canvasW,
        canvasH,
      ) {
        const tooltip = document.getElementById("chart-tooltip");
        const content = document.getElementById("tooltip-content");

        content.innerHTML = `
    <div class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">Step</div>
    <div class="text-lg font-bold mb-2">${idx + 1}</div>
    <hr class="border-slate-200 dark:border-slate-700 my-2">
    <div class="flex items-center gap-2 mb-1">
      <span class="w-2 h-2 rounded-full" style="background:${
          getColor(dim)
        }"></span>
      <span class="text-sm">Target ${dim + 1}</span>
      <span class="ml-auto font-medium">${formatNumber(pred)}</span>
    </div>
    <div class="text-xs text-slate-500 dark:text-slate-400">
      Bounds: ${formatNumber(lower)}  ${formatNumber(upper)}
    </div>
    <div class="text-xs text-slate-500 dark:text-slate-400">
      Spread: ${formatNumber(upper - lower)}
    </div>
  `;

        let tx = x + 16;
        let ty = y - 20;

        if (tx + 200 > canvasW) tx = x - 200;
        if (ty < 10) ty = y + 20;

        tooltip.style.left = tx + "px";
        tooltip.style.top = ty + "px";
        tooltip.style.opacity = "1";
      }

      function hideTooltip() {
        document.getElementById("chart-tooltip").style.opacity = "0";
      }

      function handleCanvasHover(e) {
        if (!state.predictions || state.vizMode !== "focus") return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const dpr = window.devicePixelRatio || 1;
        const w = canvas.width / dpr;
        const margin = { left: 65, right: 24 };
        const plotW = w - margin.left - margin.right;

        if (x < margin.left || x > w - margin.right) {
          state.hover.active = false;
          hideTooltip();
          renderChart();
          return;
        }

        // Use visible count from zoom state
        const visibleCount = state.zoom.visibleCount ||
          state.predictions.predictions.length;
        const localIdx = Math.round(
          (x - margin.left) / plotW * (visibleCount - 1),
        );

        state.hover = {
          active: true,
          x,
          y,
          dataIndex: Math.max(0, Math.min(visibleCount - 1, localIdx)),
        };
        canvas.style.cursor = "crosshair";
        renderChart();
      }

      function handleCanvasLeave() {
        state.hover.active = false;
        canvas.style.cursor = "default";
        hideTooltip();
        renderChart();
      }

      function handleCanvasWheel(e) {
        if (!e.ctrlKey && !e.metaKey) return;
        e.preventDefault();
      }

      function handleCanvasClick(e) {
        if (state.vizMode === "grid") {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const dpr = window.devicePixelRatio || 1;
          const w = canvas.width / dpr;
          const h = canvas.height / dpr;

          const cols = w < 640 ? 2 : w < 1024 ? 3 : w < 1400 ? 4 : 5;
          const cellW = Math.floor((w - 20) / cols);
          const cellH = Math.min(
            110,
            Math.floor((h - 20) / Math.ceil(state.nTargets / cols)),
          );
          const gap = 10;

          const col = Math.floor((x - 10) / (cellW + gap));
          const row = Math.floor((y - 10) / (cellH + gap));
          const idx = row * cols + col;

          if (idx >= 0 && idx < state.nTargets) {
            state.selectedDim = idx;
            setVisualizationMode("focus");
          }
        }
      }

      function chartZoomIn() {
        state.zoom.level = Math.min(5, state.zoom.level * 1.4);
        document.getElementById("zoom-badge").textContent =
          Math.round(state.zoom.level * 100) + "%";
        document.getElementById("zoom-badge").classList.remove(
          "hidden",
        );
        renderChart();
      }

      function chartZoomOut() {
        state.zoom.level = Math.max(1, state.zoom.level / 1.4);
        document.getElementById("zoom-badge").textContent =
          Math.round(state.zoom.level * 100) + "%";
        if (state.zoom.level <= 1.01) {
          document.getElementById("zoom-badge").classList.add("hidden");
        }
        renderChart();
      }

      function chartResetZoom() {
        state.zoom.level = 1;
        state.zoom.offsetX = 0;
        document.getElementById("zoom-badge").classList.add("hidden");
        renderChart();
      }

      function niceScale(min, max, ticks) {
        const range = max - min;
        const roughStep = range / ticks;
        const magnitude = Math.pow(
          10,
          Math.floor(Math.log10(roughStep)),
        );
        const residual = roughStep / magnitude;

        let niceStep;
        if (residual > 5) niceStep = 10 * magnitude;
        else if (residual > 2) niceStep = 5 * magnitude;
        else if (residual > 1) niceStep = 2 * magnitude;
        else niceStep = magnitude;

        const niceMin = Math.floor(min / niceStep) * niceStep;
        const niceMax = Math.ceil(max / niceStep) * niceStep;

        const result = [];
        for (let v = niceMin; v <= niceMax; v += niceStep) {
          result.push(v);
        }
        return result;
      }

      function validateDataset(data) {
        const errors = [];

        if (!data || typeof data !== "object") {
          return { valid: false, errors: ["Invalid JSON format"] };
        }

        if (!Array.isArray(data.xCoordinates)) {
          errors.push("Missing or invalid xCoordinates array");
        }
        if (!Array.isArray(data.yCoordinates)) {
          errors.push("Missing or invalid yCoordinates array");
        }

        if (errors.length) return { valid: false, errors };

        const xLen = data.xCoordinates.length;
        const yLen = data.yCoordinates.length;

        if (xLen === 0) errors.push("xCoordinates is empty");
        if (yLen === 0) errors.push("yCoordinates is empty");
        if (xLen !== yLen) {
          errors.push(
            `Length mismatch: xCoordinates has ${xLen} samples, yCoordinates has ${yLen}`,
          );
        }

        if (errors.length) return { valid: false, errors };

        let nFeatures = null, nTargets = null;

        for (let i = 0; i < xLen; i++) {
          if (!Array.isArray(data.xCoordinates[i])) {
            errors.push(`xCoordinates[${i}] is not an array`);
            continue;
          }
          if (!Array.isArray(data.yCoordinates[i])) {
            errors.push(`yCoordinates[${i}] is not an array`);
            continue;
          }

          if (nFeatures === null) {
            nFeatures = data.xCoordinates[i].length;
          }
          if (nTargets === null) nTargets = data.yCoordinates[i].length;

          if (data.xCoordinates[i].length !== nFeatures) {
            errors.push(
              `xCoordinates[${i}] has ${
                data.xCoordinates[i].length
              } features, expected ${nFeatures}`,
            );
          }
          if (data.yCoordinates[i].length !== nTargets) {
            errors.push(
              `yCoordinates[${i}] has ${
                data.yCoordinates[i].length
              } targets, expected ${nTargets}`,
            );
          }

          for (let j = 0; j < data.xCoordinates[i].length; j++) {
            const v = data.xCoordinates[i][j];
            if (typeof v !== "number" || !isFinite(v)) {
              errors.push(
                `xCoordinates[${i}][${j}] is not a valid number`,
              );
            }
          }
          for (let j = 0; j < data.yCoordinates[i].length; j++) {
            const v = data.yCoordinates[i][j];
            if (typeof v !== "number" || !isFinite(v)) {
              errors.push(
                `yCoordinates[${i}][${j}] is not a valid number`,
              );
            }
          }

          if (errors.length > 10) {
            errors.push("... and more errors");
            break;
          }
        }

        if (errors.length) return { valid: false, errors };

        return { valid: true, nFeatures, nTargets, sampleCount: xLen };
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add(
          "border-blue-400",
          "dark:border-blue-500",
        );
      }

      function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove(
          "border-blue-400",
          "dark:border-blue-500",
        );
        const file = e.dataTransfer.files[0];
        if (file) readFile(file);
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) readFile(file);
      }

      function readFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("upload-json-input").value =
            e.target.result;
          validateAndPreviewUpload();
        };
        reader.readAsText(file);
      }

      function validateAndPreviewUpload() {
        const input = document.getElementById("upload-json-input").value
          .trim();
        const preview = document.getElementById("upload-preview");
        const error = document.getElementById("upload-error");
        const applyBtn = document.getElementById("apply-upload-btn");

        preview.classList.add("hidden");
        error.classList.add("hidden");
        applyBtn.disabled = true;
        state.uploadedData = null;

        if (!input) return;

        let data;
        try {
          data = JSON.parse(input);
        } catch (e) {
          error.classList.remove("hidden");
          document.getElementById("upload-error-text").textContent =
            "Invalid JSON: " + e.message;
          return;
        }

        const result = validateDataset(data);

        if (!result.valid) {
          error.classList.remove("hidden");
          document.getElementById("upload-error-text").textContent =
            result.errors.join("\n");
          return;
        }

        preview.classList.remove("hidden");
        document.getElementById("preview-stats").innerHTML = `
    <div><span class="text-slate-500">Features:</span> ${result.nFeatures}</div>
    <div><span class="text-slate-500">Targets:</span> ${result.nTargets}</div>
    <div><span class="text-slate-500">Samples:</span> ${result.sampleCount}</div>
    <div><span class="text-slate-500">Dimensions:</span> OK </div>
  `;

        state.uploadedData = data;
        applyBtn.disabled = false;
      }

      async function applyUploadedData() {
        if (!state.uploadedData) return;

        if (!state.modelExists) {
          showToast("warning", "Create a model first");
          return;
        }

        showLoading("Training on uploaded data...");

        try {
          const result = await workerRequest(
            "train",
            state.uploadedData,
          );

          if (result.cancelled) {
            log("warning", "Training", "Cancelled");
            return;
          }

          state.sampleCount = result.summary.sampleCount;
          state.nFeatures = result.summary.nFeatures;
          state.nTargets = result.summary.nTargets;
          state.metrics = {
            avgLoss: result.fitResult?.averageLoss || null,
            gradientNorm: result.fitResult?.gradientNorm || null,
            sampleWeight: result.fitResult?.sampleWeight || null,
          };

          updateUI();
          closeModal("upload-modal");
          log(
            "success",
            "Training",
            `Trained on ${result.samplesProcessed} samples`,
          );
          showToast(
            "success",
            `Trained on ${result.samplesProcessed} samples`,
          );

          // Auto-predict
          await runPrediction();
        } catch (err) {
          log("error", "Training", err.message);
          showToast("error", "Training failed: " + err.message);
        }
      }

      function copyFormatExample() {
        const example = `{
  "xCoordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ],
  "yCoordinates": [
    [4.0, 5.0],
    [4.1, 5.1],
    [4.2, 5.2]
  ]
}`;
        navigator.clipboard.writeText(example);
        showToast("success", "Example copied to clipboard");
      }

      function generateInsertTemplate() {
        const nF = state.nFeatures || 3;
        const nT = state.nTargets || 2;
        const template = {
          xCoordinates: [Array(nF).fill(0)],
          yCoordinates: [Array(nT).fill(0)],
        };
        document.getElementById("insert-json-input").value = JSON
          .stringify(template, null, 2);
      }

      async function applyManualInsert() {
        const input = document.getElementById("insert-json-input").value
          .trim();

        if (!state.modelExists) {
          showToast("warning", "Create a model first");
          return;
        }

        let data;
        try {
          data = JSON.parse(input);
        } catch (e) {
          showToast("error", "Invalid JSON");
          return;
        }

        const result = validateDataset(data);
        if (!result.valid) {
          showToast("error", result.errors[0]);
          return;
        }

        showLoading("Inserting samples...");

        try {
          const trainResult = await workerRequest("train", data);
          state.sampleCount = trainResult.summary.sampleCount;
          state.nFeatures = trainResult.summary.nFeatures;
          state.nTargets = trainResult.summary.nTargets;
          state.metrics = {
            avgLoss: trainResult.fitResult?.averageLoss || null,
            gradientNorm: trainResult.fitResult?.gradientNorm || null,
            sampleWeight: trainResult.fitResult?.sampleWeight || null,
          };
          updateUI();
          closeModal("insert-modal");
          log(
            "success",
            "Insert",
            `Added ${result.sampleCount} samples`,
          );
          showToast("success", `Added ${result.sampleCount} samples`);
        } catch (err) {
          log("error", "Insert", err.message);
          showToast("error", err.message);
        }
      }

      async function runPrediction() {
        if (!state.modelExists) return;

        const steps = parseInt(
          document.getElementById("future-steps-input").value,
        ) || 10;

        showLoading("Running prediction...");

        try {
          const result = await workerRequest("predict", {
            futureSteps: steps,
          });
          state.predictions = result;

          const summary = await workerRequest("getSummary");
          if (summary.exists) {
            state.nTargets = summary.summary.nTargets;
            state.nFeatures = summary.summary.nFeatures;
          }

          document.getElementById("empty-state").classList.add(
            "hidden",
          );
          document.getElementById("chart-controls").classList.remove(
            "hidden",
          );

          updateDimensionButtons();
          updateStatsBar();
          renderChart();

          log(
            "success",
            "Prediction",
            `Generated ${steps}-step forecast`,
          );
        } catch (err) {
          log("error", "Prediction", err.message);
          showToast("error", "Prediction failed: " + err.message);
        }
      }

      async function downloadModel() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }

        try {
          const result = await workerRequest("save");
          const blob = new Blob([
            JSON.stringify(
              { modelState: result.modelState, meta: result.meta },
              null,
              2,
            ),
          ], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `esn-model-${
            new Date().toISOString().slice(0, 10)
          }.json`;
          a.click();
          URL.revokeObjectURL(url);
          log("success", "Save", "Model downloaded");
          showToast("success", "Model downloaded");
        } catch (err) {
          log("error", "Save", err.message);
          showToast("error", err.message);
        }
      }

      async function saveToLocalStorage() {
        if (!state.modelExists) {
          showToast("warning", "No model to save");
          return;
        }

        const name = prompt(
          "Enter a name for this model:",
          `Model ${new Date().toLocaleString()}`,
        );
        if (!name) return;

        try {
          const result = await workerRequest("save");
          const saved = JSON.parse(
            localStorage.getItem("esn-saved-models") || "{}",
          );
          saved[name] = {
            modelState: result.modelState,
            meta: result.meta,
            savedAt: new Date().toISOString(),
          };
          localStorage.setItem(
            "esn-saved-models",
            JSON.stringify(saved),
          );
          log("success", "Save", `Saved as "${name}"`);
          showToast("success", `Model saved as "${name}"`);
          updateSavedModelsList();
        } catch (err) {
          log("error", "Save", err.message);
          showToast("error", err.message);
        }
      }

      function updateSavedModelsList() {
        const container = document.getElementById("saved-models-list");
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        const names = Object.keys(saved);

        if (names.length === 0) {
          container.innerHTML =
            '<p class="text-sm text-slate-500 text-center py-4">No saved models</p>';
          return;
        }

        container.innerHTML = names.map((name) => {
          const model = saved[name];
          return `
      <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
        <div>
          <p class="font-medium text-sm">${name}</p>
          <p class="text-xs text-slate-500">${
            model.meta?.nFeatures || "?"
          } features, ${model.meta?.nTargets || "?"} targets</p>
        </div>
        <button onclick="loadFromLocalStorage('${name}')" class="px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">Load</button>
      </div>`;
        }).join("");
      }

      async function loadFromLocalStorage(name) {
        const saved = JSON.parse(
          localStorage.getItem("esn-saved-models") || "{}",
        );
        const model = saved[name];

        if (!model) {
          showToast("error", "Model not found");
          return;
        }

        showLoading("Loading model...");

        try {
          const result = await workerRequest("load", { data: model });
          state.modelExists = true;
          state.sampleCount = result.summary.sampleCount;
          state.nFeatures = result.summary.nFeatures;
          state.nTargets = result.summary.nTargets;
          if (result.meta?.config) {
            state.config = { ...DEFAULT_CONFIG, ...result.meta.config };
          }

          updateConfigValues();
          updateUI();
          closeModal("load-modal");
          log("success", "Load", `Loaded "${name}"`);
          showToast("success", `Model "${name}" loaded`);
        } catch (err) {
          log("error", "Load", err.message);
          showToast("error", err.message);
        }
      }

      async function loadModelFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (ev) => {
          showLoading("Loading model...");

          try {
            let data;
            try {
              data = JSON.parse(ev.target.result);
            } catch {
              data = ev.target.result;
            }

            const result = await workerRequest("load", { data });
            state.modelExists = true;
            state.sampleCount = result.summary.sampleCount;
            state.nFeatures = result.summary.nFeatures;
            state.nTargets = result.summary.nTargets;
            if (result.meta?.config) {
              state.config = {
                ...DEFAULT_CONFIG,
                ...result.meta.config,
              };
            }

            updateConfigValues();
            updateUI();
            closeModal("load-modal");
            log("success", "Load", "Model loaded from file");
            showToast("success", "Model loaded");
          } catch (err) {
            log("error", "Load", err.message);
            showToast("error", err.message);
          }
        };
        reader.readAsText(file);
      }

      function clearLocalStorageModels() {
        if (!confirm("Delete all saved models?")) return;
        localStorage.removeItem("esn-saved-models");
        updateSavedModelsList();
        showToast("success", "Saved models cleared");
      }

      function seededRandom(seed) {
        let s = seed;
        return () => {
          s = (s * 9301 + 49297) % 233280;
          return s / 233280;
        };
      }

      async function runRandomTest() {
        const seed =
          parseInt(document.getElementById("test-seed").value) || 42;
        const nFeatures =
          parseInt(document.getElementById("test-features").value) || 5;
        const nTargets =
          parseInt(document.getElementById("test-targets").value) || 3;
        const nSamples =
          parseInt(document.getElementById("test-samples").value) ||
          200;
        const noise =
          parseFloat(document.getElementById("test-noise").value) ||
          0.1;
        const outlierRate =
          parseFloat(document.getElementById("test-outliers").value) ||
          0.02;
        const difficulty =
          document.getElementById("test-difficulty").value || "medium";

        const rand = seededRandom(seed);

        const xCoordinates = [];
        const yCoordinates = [];

        // Generate weights for synthetic function
        const weights = Array.from(
          { length: nTargets },
          () =>
            Array.from({ length: nFeatures }, () => (rand() - 0.5) * 2),
        );

        for (let i = 0; i < nSamples; i++) {
          const x = Array.from({ length: nFeatures }, (_, j) => {
            const base = Math.sin(i * 0.1 + j) + rand() * 0.5;
            return base;
          });

          const y = Array.from({ length: nTargets }, (_, t) => {
            let val = 0;
            for (let f = 0; f < nFeatures; f++) {
              val += weights[t][f] * x[f];
              if (difficulty !== "easy") {
                val += 0.3 * Math.sin(x[f] * 3) * weights[t][f];
              }
              if (difficulty === "hard") {
                val += 0.2 *
                  Math.cos(x[f] * x[(f + 1) % nFeatures] * 2);
              }
            }
            val += (rand() - 0.5) * noise * 2;

            if (rand() < outlierRate) {
              val += (rand() > 0.5 ? 1 : -1) * (3 + rand() * 2);
            }

            return val;
          });

          xCoordinates.push(x);
          yCoordinates.push(y);
        }

        // Create model with appropriate preset
        applyPreset("balanced");

        showLoading("Running demo...");

        try {
          await workerRequest("createModel", { config: state.config });
          state.modelExists = true;

          const trainResult = await workerRequest("train", {
            xCoordinates,
            yCoordinates,
          });

          if (trainResult.cancelled) return;

          state.sampleCount = trainResult.summary.sampleCount;
          state.nFeatures = trainResult.summary.nFeatures;
          state.nTargets = trainResult.summary.nTargets;
          state.metrics = {
            avgLoss: trainResult.fitResult?.averageLoss || null,
            gradientNorm: trainResult.fitResult?.gradientNorm || null,
            sampleWeight: trainResult.fitResult?.sampleWeight || null,
          };

          updateUI();

          // Run prediction
          const steps = Math.min(20, state.config.maxSequenceLength);
          const predResult = await workerRequest("predict", {
            futureSteps: steps,
          });
          state.predictions = predResult;

          document.getElementById("empty-state").classList.add(
            "hidden",
          );
          document.getElementById("chart-controls").classList.remove(
            "hidden",
          );

          updateDimensionButtons();
          updateStatsBar();
          setVisualizationMode("focus");
          renderChart();

          log(
            "success",
            "Demo",
            `Generated ${nSamples} samples, trained model, predicted ${steps} steps`,
          );
          showToast(
            "success",
            "Demo complete! Explore the predictions.",
          );
        } catch (err) {
          log("error", "Demo", err.message);
          showToast("error", "Demo failed: " + err.message);
        }
      }

      function showDataTable() {
        if (!state.predictions) {
          showToast("warning", "No predictions to display");
          return;
        }

        const head = document.getElementById("data-table-head");
        const body = document.getElementById("data-table-body");

        const headers = [
          "Step",
          ...Array.from(
            { length: state.nTargets },
            (_, i) => `Pred T${i + 1}`,
          ),
          ...Array.from(
            { length: state.nTargets },
            (_, i) => `Lower T${i + 1}`,
          ),
          ...Array.from(
            { length: state.nTargets },
            (_, i) => `Upper T${i + 1}`,
          ),
        ];

        head.innerHTML = `<tr>${
          headers.map((h) =>
            `<th class="px-3 py-2 text-left">${h}</th>`
          ).join("")
        }</tr>`;

        body.innerHTML = state.predictions.predictions.map(
          (preds, i) => {
            const lowers = state.predictions.lowerBounds[i];
            const uppers = state.predictions.upperBounds[i];
            const cells = [
              i + 1,
              ...preds.map(formatNumber),
              ...lowers.map(formatNumber),
              ...uppers.map(formatNumber),
            ];
            return `<tr class="border-t border-slate-200 dark:border-slate-700">${
              cells.map((c) => `<td class="px-3 py-2">${c}</td>`).join(
                "",
              )
            }</tr>`;
          },
        ).join("");

        openModal("data-table-modal");
      }

      function showKeyboardShortcuts() {
        openModal("shortcuts-modal");
      }

      function clearAllPreferences() {
        if (!confirm("Clear all preferences and reload?")) return;
        localStorage.clear();
        location.reload();
      }

      function debounce(fn, ms) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), ms);
        };
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
