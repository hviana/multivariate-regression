<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="min-h-screen bg-slate-50 text-slate-900 dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 dark:text-slate-100"
  >
    <!-- Toasts -->
    <div
      id="toasts"
      class="fixed bottom-3 left-3 right-3 z-50 space-y-2"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-40 hidden">
      <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
      <div
        class="relative mx-auto mt-28 w-[92%] max-w-md rounded-2xl border border-slate-200/50 bg-white/90 p-5 shadow-2xl dark:border-slate-700/50 dark:bg-slate-800/70"
      >
        <div class="flex items-center gap-3">
          <div
            class="h-9 w-9 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg shadow-blue-500/20 flex items-center justify-center text-white text-lg"
            aria-hidden="true"
          >
            ‚è≥
          </div>
          <div class="flex-1">
            <div id="loadingTitle" class="text-sm font-semibold">
              Processing...
            </div>
            <div
              id="loadingSubtitle"
              class="text-xs text-slate-500 dark:text-slate-400"
            >
              Please wait
            </div>
          </div>
          <div
            class="h-8 w-8 rounded-full border-2 border-slate-300 border-t-transparent animate-spin dark:border-slate-600 dark:border-t-transparent"
            aria-hidden="true"
          >
          </div>
        </div>

        <div class="mt-4">
          <div
            class="flex items-center justify-between text-xs text-slate-600 dark:text-slate-300"
          >
            <div>Progress</div>
            <div id="loadingPct" class="tabular-nums">0%</div>
          </div>
          <div
            class="mt-2 h-2 w-full overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700"
            role="progressbar"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="0"
          >
            <div
              id="loadingBar"
              class="h-full w-0 bg-gradient-to-r from-blue-500 to-indigo-500"
            >
            </div>
          </div>
        </div>

        <button
          id="btnCancelOp"
          class="mt-4 w-full rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-red-500/20 disabled:opacity-50"
          aria-label="Cancel operation"
        >
          Cancel
        </button>
      </div>
    </div>

    <!-- Header -->
    <header
      class="sticky top-0 z-30 border-b border-slate-200/60 bg-white/70 backdrop-blur-xl dark:border-slate-700/60 dark:bg-slate-900/40"
    >
      <div
        class="mx-auto flex max-w-6xl items-center justify-between gap-3 px-4 py-3"
      >
        <div class="flex items-center gap-3">
          <div
            class="h-11 w-11 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg shadow-blue-500/30 flex items-center justify-center text-white text-xl"
            aria-hidden="true"
          >
            üìä
          </div>
          <div>
            <div class="text-base font-extrabold tracking-tight">
              ESN Studio
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400">
              Autoregressive Forecasting
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div
            class="hidden sm:flex items-center gap-2 rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-xs dark:border-slate-700/60 dark:bg-slate-800/50"
          >
            <span
              id="statusDot"
              class="inline-block h-2.5 w-2.5 rounded-full bg-slate-400 animate-pulse"
              aria-hidden="true"
            ></span>
            <span
              id="statusText"
              class="font-semibold text-slate-700 dark:text-slate-200"
            >No Model</span>
          </div>

          <button
            id="btnPredictTop"
            class="hidden items-center gap-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 disabled:opacity-50"
            aria-label="Predict"
          >
            <span aria-hidden="true">‚ö°</span><span class="hidden sm:inline"
            >Predict</span>
          </button>

          <button
            id="btnConfig"
            class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm dark:border-slate-700/60 dark:bg-slate-800/50 dark:text-slate-100"
            aria-label="Configure model"
          >
            ‚öôÔ∏è
          </button>

          <button
            id="btnMenu"
            class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm dark:border-slate-700/60 dark:bg-slate-800/50 dark:text-slate-100"
            aria-label="Open menu"
          >
            ‚ò∞
          </button>

          <button
            id="btnTheme"
            class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm dark:border-slate-700/60 dark:bg-slate-800/50 dark:text-slate-100"
            aria-label="Toggle theme"
          >
            üåô
          </button>
        </div>
      </div>
    </header>

    <!-- App Layout -->
    <main class="mx-auto max-w-6xl px-4 py-4 pb-24">
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-12">
        <!-- Visualization -->
        <section class="lg:col-span-8">
          <!-- Tabs -->
          <div class="mb-3 overflow-x-auto">
            <div
              class="flex w-max gap-2 rounded-2xl border border-slate-200/60 bg-white/60 p-2 backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40"
            >
              <button
                data-mode="grid"
                class="tabBtn rounded-xl px-3 py-2 text-sm font-semibold"
                aria-label="Small Multiples mode"
              >
                üìä Grid
              </button>
              <button
                data-mode="focus"
                class="tabBtn rounded-xl px-3 py-2 text-sm font-semibold"
                aria-label="Focus mode"
              >
                üîç Focus
              </button>
              <button
                data-mode="heatmap"
                class="tabBtn rounded-xl px-3 py-2 text-sm font-semibold"
                aria-label="Heatmap mode"
              >
                üå°Ô∏è Heatmap
              </button>
              <button
                data-mode="ci"
                class="tabBtn rounded-xl px-3 py-2 text-sm font-semibold"
                aria-label="Uncertainty mode"
              >
                üìà CI
              </button>
              <button
                data-mode="snapshot"
                class="tabBtn rounded-xl px-3 py-2 text-sm font-semibold"
                aria-label="Snapshot mode"
              >
                üì∑ Snapshot
              </button>
            </div>
          </div>

          <!-- Focus Mode: Dimension selector -->
          <div id="dimSelectorRow" class="mb-3 hidden overflow-x-auto">
            <div id="dimButtons" class="flex w-max gap-2"></div>
          </div>

          <!-- Focus Mode: Statistics bar -->
          <div
            id="statsBar"
            class="mb-3 hidden grid grid-cols-2 gap-2 sm:grid-cols-3 lg:grid-cols-6"
          >
          </div>

          <!-- Snapshot Step Selector -->
          <div
            id="snapshotControls"
            class="mb-3 hidden items-center gap-3 rounded-2xl border border-slate-200/60 bg-white/70 p-3 backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40"
          >
            <div class="text-sm font-semibold">Step:</div>
            <input
              id="snapshotStep"
              type="number"
              min="0"
              step="1"
              class="w-28 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-100"
              aria-label="Snapshot step"
            />
            <div
              id="snapshotStepHint"
              class="text-xs text-slate-500 dark:text-slate-400"
            >
            </div>
          </div>

          <!-- Chart Card -->
          <div
            class="relative rounded-2xl border border-slate-200/60 bg-white shadow-xl dark:border-slate-700/60 dark:bg-slate-800/50"
          >
            <!-- Empty State -->
            <div id="emptyState" class="p-6 sm:p-10">
              <div class="mx-auto max-w-md text-center">
                <div
                  class="mx-auto mb-4 h-20 w-20 rounded-3xl bg-gradient-to-br from-blue-500/20 via-indigo-500/20 to-purple-600/20 flex items-center justify-center shadow-lg dark:from-blue-500/20 dark:via-indigo-500/20 dark:to-purple-600/20"
                  aria-hidden="true"
                >
                  <div
                    class="h-14 w-14 rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center text-3xl text-white shadow-xl shadow-blue-500/20"
                  >
                    üìä
                  </div>
                </div>
                <div class="text-xl font-extrabold tracking-tight">
                  Create a Model to Begin
                </div>
                <div
                  class="mt-2 text-sm leading-relaxed text-slate-600 dark:text-slate-300"
                >
                  ESN autoregressive forecasting for multivariate time series ‚Äî
                  train online, predict forward, and explore uncertainty.
                </div>
                <div class="mt-6 grid grid-cols-1 gap-2 sm:grid-cols-3">
                  <button
                    id="btnStartDefaults"
                    class="rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/20"
                    aria-label="Start with defaults"
                  >
                    ‚ö° Start with Defaults
                  </button>
                  <button
                    id="btnLoadFromEmpty"
                    class="rounded-xl border border-slate-200 bg-white/70 px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm dark:border-slate-700 dark:bg-slate-800/50 dark:text-slate-100"
                    aria-label="Load model"
                  >
                    üì§ Load
                  </button>
                  <button
                    id="btnDemo"
                    class="rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-purple-500/20"
                    aria-label="Run demo"
                  >
                    ‚ú® Demo
                  </button>
                </div>
              </div>
            </div>

            <!-- Canvas -->
            <div id="canvasWrap" class="hidden p-3 sm:p-4">
              <canvas
                id="chart"
                class="w-full rounded-xl"
                height="520"
                aria-label="Prediction visualization canvas"
              ></canvas>
            </div>

            <!-- Floating Controls -->
            <div
              id="floatControls"
              class="pointer-events-none absolute inset-0 hidden"
            >
              <div
                class="pointer-events-auto absolute left-3 top-3 rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-xs font-semibold text-slate-700 backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-200"
                aria-label="Zoom level"
              >
                üîé <span id="zoomBadge" class="tabular-nums">100%</span>
              </div>

              <div
                class="pointer-events-auto absolute right-3 top-3 flex items-center gap-2"
              >
                <button
                  id="btnZoomIn"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Zoom in"
                >
                  ‚ûï
                </button>
                <button
                  id="btnZoomOut"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Zoom out"
                >
                  ‚ûñ
                </button>
                <button
                  id="btnZoomReset"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Reset zoom"
                >
                  üîÑ
                </button>
              </div>

              <div
                class="pointer-events-auto absolute bottom-3 left-3 right-3 flex flex-wrap gap-2"
              >
                <button
                  id="btnSavePNG"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Save as PNG"
                >
                  üñºÔ∏è PNG
                </button>
                <button
                  id="btnSaveSVG"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Save as SVG"
                >
                  üìÑ SVG
                </button>
                <button
                  id="btnCopy"
                  class="rounded-xl border border-slate-200/60 bg-white/80 px-3 py-2 text-sm font-semibold backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/40"
                  aria-label="Copy to clipboard"
                >
                  üìã Copy
                </button>
              </div>
            </div>

            <!-- Tooltip -->
            <div
              id="tooltip"
              class="hidden absolute z-20 w-64 rounded-2xl border border-slate-200/60 bg-white/90 p-3 text-xs shadow-2xl backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/50"
              role="status"
              aria-label="Chart tooltip"
            >
              <div class="flex items-center justify-between">
                <div
                  class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400"
                >
                  Step
                </div>
                <div id="ttStep" class="text-sm font-extrabold tabular-nums">
                  ‚Äî
                </div>
              </div>
              <div class="mt-2 flex items-center gap-2">
                <div
                  id="ttDot"
                  class="h-2.5 w-2.5 rounded-full bg-blue-500"
                  aria-hidden="true"
                >
                </div>
                <div id="ttDim" class="text-xs font-semibold">D1</div>
              </div>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <div class="rounded-xl bg-slate-100 p-2 dark:bg-slate-800/70">
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400"
                  >
                    Pred
                  </div>
                  <div id="ttPred" class="text-sm font-bold tabular-nums">
                    ‚Äî
                  </div>
                </div>
                <div class="rounded-xl bg-slate-100 p-2 dark:bg-slate-800/70">
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400"
                  >
                    Spread
                  </div>
                  <div id="ttSpread" class="text-sm font-bold tabular-nums">
                    ‚Äî
                  </div>
                </div>
                <div
                  class="col-span-2 rounded-xl bg-slate-100 p-2 dark:bg-slate-800/70"
                >
                  <div
                    class="text-[10px] uppercase tracking-wider text-slate-500 dark:text-slate-400"
                  >
                    CI
                  </div>
                  <div id="ttCI" class="text-sm font-bold tabular-nums">‚Äî</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Side Panel -->
        <aside class="lg:col-span-4 space-y-4">
          <!-- Model Metrics -->
          <div
            class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 shadow-sm backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40"
          >
            <div class="flex items-center justify-between">
              <div
                class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
              >
                Model Metrics
              </div>
              <button
                id="btnSummary"
                class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-xs font-semibold dark:border-slate-700/60 dark:bg-slate-800/50"
                aria-label="Get model summary"
              >
                üßæ Summary
              </button>
            </div>
            <div class="mt-3 space-y-2 text-sm">
              <div
                class="flex items-center justify-between rounded-xl bg-slate-100 px-3 py-2 dark:bg-slate-900/30"
              >
                <div class="text-slate-600 dark:text-slate-300">
                  Samples Trained
                </div>
                <div
                  id="mSamples"
                  class="font-bold tabular-nums text-blue-600 dark:text-blue-300"
                >
                  0
                </div>
              </div>
              <div
                class="flex items-center justify-between rounded-xl bg-slate-100 px-3 py-2 dark:bg-slate-900/30"
              >
                <div class="text-slate-600 dark:text-slate-300">Avg Loss</div>
                <div id="mLoss" class="font-bold tabular-nums">‚Äî</div>
              </div>
              <div
                class="flex items-center justify-between rounded-xl bg-slate-100 px-3 py-2 dark:bg-slate-900/30"
              >
                <div class="text-slate-600 dark:text-slate-300">
                  Gradient Norm
                </div>
                <div id="mGrad" class="font-bold tabular-nums">‚Äî</div>
              </div>
              <div
                class="flex items-center justify-between rounded-xl bg-slate-100 px-3 py-2 dark:bg-slate-900/30"
              >
                <div class="text-slate-600 dark:text-slate-300">
                  Sample Weight
                </div>
                <div id="mWeight" class="font-bold tabular-nums">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Prediction -->
          <div
            class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 shadow-sm backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40"
          >
            <div
              class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
            >
              Prediction
            </div>
            <div class="mt-3">
              <label
                class="text-xs font-semibold text-slate-600 dark:text-slate-300"
                for="futureSteps"
              >Future Steps</label>
              <input
                id="futureSteps"
                type="number"
                min="1"
                step="1"
                value="50"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-100"
                aria-label="Future steps"
              />
              <div
                id="futureStepsErr"
                class="mt-1 hidden text-xs font-semibold text-red-600"
                aria-live="polite"
              >
              </div>
            </div>
            <button
              id="btnPredict"
              class="mt-3 w-full rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/20 disabled:opacity-50"
              aria-label="Run prediction"
            >
              ‚ö° Run Prediction
            </button>
          </div>

          <!-- Event Log -->
          <div
            class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 shadow-sm backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40"
          >
            <div class="flex items-center justify-between gap-2">
              <div
                class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
              >
                Event Log
              </div>
              <div class="flex items-center gap-2">
                <select
                  id="logFilter"
                  class="rounded-xl border border-slate-200 bg-white px-2 py-2 text-xs font-semibold dark:border-slate-700 dark:bg-slate-700"
                  aria-label="Log filter"
                >
                  <option value="all">All</option>
                  <option value="info">Info</option>
                  <option value="success">Success</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
            </div>
            <input
              id="logSearch"
              type="text"
              placeholder="Search..."
              class="mt-3 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-700"
              aria-label="Search logs"
            />
            <div
              id="logList"
              class="mt-3 max-h-64 space-y-2 overflow-auto pr-1"
            >
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Slide-out Menu -->
    <div id="menuOverlay" class="fixed inset-0 z-40 hidden" aria-hidden="true">
      <div class="absolute inset-0 bg-slate-900/40" id="menuBackdrop"></div>
      <div
        id="menuPanel"
        class="absolute right-0 top-0 h-full w-[92%] max-w-sm translate-x-0 border-l border-slate-200/60 bg-white/90 p-4 shadow-2xl backdrop-blur dark:border-slate-700/60 dark:bg-slate-900/60"
        role="dialog"
        aria-modal="true"
        aria-label="Menu"
      >
        <div class="flex items-center justify-between">
          <div class="text-base font-extrabold">Menu</div>
          <button
            id="btnCloseMenu"
            class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-sm font-semibold dark:border-slate-700/60 dark:bg-slate-800/40"
            aria-label="Close menu"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div
            class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
          >
            üìÅ Model
          </div>

          <button
            id="menuCreateConfig"
            class="w-full rounded-2xl border border-slate-200/60 bg-blue-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-blue-500/10"
            aria-label="Create and configure model"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-blue-500 text-white flex items-center justify-center text-xl shadow-lg shadow-blue-500/20"
                aria-hidden="true"
              >
                üéõÔ∏è
              </div>
              <div>
                <div class="text-sm font-extrabold">Create & Configure</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Set up model parameters
                </div>
              </div>
            </div>
          </button>

          <button
            id="menuSaveLoad"
            class="w-full rounded-2xl border border-slate-200/60 bg-emerald-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-emerald-500/10"
            aria-label="Save and load model"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-emerald-500 text-white flex items-center justify-center text-xl shadow-lg shadow-emerald-500/20"
                aria-hidden="true"
              >
                üíæ
              </div>
              <div>
                <div class="text-sm font-extrabold">Save & Load</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Persist your models
                </div>
              </div>
            </div>
          </button>

          <div
            class="pt-2 text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
          >
            üìÇ Data
          </div>

          <button
            id="menuUpload"
            class="w-full rounded-2xl border border-slate-200/60 bg-purple-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-purple-500/10"
            aria-label="Upload dataset"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-purple-600 text-white flex items-center justify-center text-xl shadow-lg shadow-purple-500/20"
                aria-hidden="true"
              >
                üì§
              </div>
              <div>
                <div class="text-sm font-extrabold">Upload Dataset</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Import time series data
                </div>
              </div>
            </div>
          </button>

          <button
            id="menuManualInsert"
            class="w-full rounded-2xl border border-slate-200/60 bg-amber-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-amber-500/10"
            aria-label="Manual insert"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-amber-500 text-white flex items-center justify-center text-xl shadow-lg shadow-amber-500/20"
                aria-hidden="true"
              >
                ‚ûï
              </div>
              <div>
                <div class="text-sm font-extrabold">Manual Insert</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Add individual time steps
                </div>
              </div>
            </div>
          </button>

          <div
            class="pt-2 text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
          >
            üß™ Test
          </div>

          <button
            id="menuRandomTest"
            class="w-full rounded-2xl border border-slate-200/60 bg-pink-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-pink-500/10"
            aria-label="Random test"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-pink-500 text-white flex items-center justify-center text-xl shadow-lg shadow-pink-500/20"
                aria-hidden="true"
              >
                üí°
              </div>
              <div>
                <div class="text-sm font-extrabold">Random Test</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Generate synthetic time series
                </div>
              </div>
            </div>
          </button>

          <div
            class="pt-2 text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400"
          >
            ‚öôÔ∏è Advanced
          </div>

          <button
            id="menuSettings"
            class="w-full rounded-2xl border border-slate-200/60 bg-slate-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-slate-800/40"
            aria-label="Settings"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-slate-600 text-white flex items-center justify-center text-xl shadow-lg shadow-slate-500/20"
                aria-hidden="true"
              >
                üîß
              </div>
              <div>
                <div class="text-sm font-extrabold">Settings</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Module URL & preferences
                </div>
              </div>
            </div>
          </button>

          <button
            id="menuDataTable"
            class="w-full rounded-2xl border border-slate-200/60 bg-slate-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-slate-800/40"
            aria-label="View data table"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-slate-600 text-white flex items-center justify-center text-xl shadow-lg shadow-slate-500/20"
                aria-hidden="true"
              >
                üìã
              </div>
              <div>
                <div class="text-sm font-extrabold">View Data Table</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Raw prediction values
                </div>
              </div>
            </div>
          </button>

          <button
            id="menuHelp"
            class="w-full rounded-2xl border border-slate-200/60 bg-slate-50 p-4 text-left shadow-sm dark:border-slate-700/60 dark:bg-slate-800/40"
            aria-label="Help"
          >
            <div class="flex items-start gap-3">
              <div
                class="h-11 w-11 rounded-2xl bg-slate-600 text-white flex items-center justify-center text-xl shadow-lg shadow-slate-500/20"
                aria-hidden="true"
              >
                ‚ùì
              </div>
              <div>
                <div class="text-sm font-extrabold">Help</div>
                <div class="text-xs text-slate-600 dark:text-slate-300">
                  Documentation & examples
                </div>
              </div>
            </div>
          </button>
        </div>

        <div class="mt-6">
          <button
            id="menuReset"
            class="w-full rounded-xl bg-red-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-red-500/20"
            aria-label="Reset application"
          >
            üßπ Reset App
          </button>
        </div>
      </div>
    </div>

    <!-- Modals root -->
    <div id="modalRoot"></div>

    <script>
      // ---------- Utilities ----------
      const PALETTE = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      const LS_KEYS = {
        config: "esnStudio.config",
        vizMode: "esnStudio.vizMode",
        isDark: "esnStudio.isDark",
        savedModels: "esnStudio.savedModels",
        moduleURL: "esnStudio.moduleURL",
      };

      const DEFAULT_MODULE_URL =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3";
      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",

        useInputInReadout: true,
        useBiasInReadout: true,

        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,

        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,

        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,

        uncertaintyMultiplier: 1.96,

        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        "Start Here": { ...DEFAULT_CONFIG },
        "Fast": {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        "Balanced": {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        "Accurate": {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        "Adaptive": {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        "Robust": {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      const $ = (id) => document.getElementById(id);
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const nowTs = () =>
        new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      function safeJSONParse(str) {
        try {
          return { ok: true, value: JSON.parse(str) };
        } catch (e) {
          return { ok: false, error: e };
        }
      }

      // ---------- App State ----------
      const state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null, // {predictions, lowerBounds, upperBounds, confidence}
        vizMode: "grid",
        selectedDim: 0,
        selectedStep: 0,
        isDark: false,
        logs: [],
        metrics: {
          avgLoss: null,
          gradientNorm: null,
          sampleWeight: null,
        },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        moduleURL: DEFAULT_MODULE_URL,
        lastDataset: null, // {coordinates: [...]}
        workerHealthy: false,
        requestSeq: 1,
        inFlight: new Map(), // requestId => {resolve,reject,type}
        lastOpRequestId: null,
      };

      // Persist: config, vizMode, isDark
      function loadPrefs() {
        try {
          const cfg = localStorage.getItem(LS_KEYS.config);
          const vm = localStorage.getItem(LS_KEYS.vizMode);
          const d = localStorage.getItem(LS_KEYS.isDark);
          const mu = localStorage.getItem(LS_KEYS.moduleURL);

          if (cfg) {
            state.config = { ...state.config, ...JSON.parse(cfg) };
          }
          if (vm) state.vizMode = vm;
          if (d) state.isDark = d === "1";
          if (mu) state.moduleURL = mu;
        } catch (e) {
          addLog("warning", "Preferences could not be loaded.");
        }
      }
      function savePrefs() {
        try {
          localStorage.setItem(
            LS_KEYS.config,
            JSON.stringify(state.config),
          );
          localStorage.setItem(LS_KEYS.vizMode, state.vizMode);
          localStorage.setItem(
            LS_KEYS.isDark,
            state.isDark ? "1" : "0",
          );
          localStorage.setItem(LS_KEYS.moduleURL, state.moduleURL);
        } catch (e) {
          addLog("warning", "Preferences could not be saved.");
        }
      }

      // ---------- Toasts & Logs ----------
      function toast(type, msg, ms) {
        const ttl = ms ?? (type === "error" ? 6000 : 4000);
        const bg = {
          info: "bg-blue-600",
          success: "bg-emerald-600",
          warning: "bg-amber-600",
          error: "bg-red-600",
        }[type] || "bg-slate-700";

        const wrap = document.createElement("div");
        wrap.className =
          `rounded-2xl ${bg} px-4 py-3 text-white shadow-2xl flex items-start gap-3`;
        wrap.setAttribute("role", "status");
        wrap.innerHTML = `
          <div class="flex-1 text-sm leading-snug">${
          escapeHtml(msg)
        }</div>
          <button class="rounded-xl bg-white/20 px-2 py-1 text-xs font-bold" aria-label="Close toast">‚úñÔ∏è</button>
        `;
        const btn = wrap.querySelector("button");
        btn.addEventListener("click", () => wrap.remove());
        $("toasts").appendChild(wrap);
        setTimeout(() => wrap.remove(), ttl);
      }

      function addLog(level, message) {
        const entry = { level, message, ts: nowTs() };
        state.logs.unshift(entry);
        if (state.logs.length > 200) state.logs.length = 200;
        renderLogs();
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderLogs() {
        const filter = $("logFilter").value;
        const q = $("logSearch").value.trim().toLowerCase();
        const list = $("logList");
        list.innerHTML = "";

        const show = state.logs
          .filter((e) => filter === "all" ? true : e.level === filter)
          .filter((e) =>
            q
              ? (e.message.toLowerCase().includes(q) ||
                e.ts.toLowerCase().includes(q))
              : true
          )
          .slice(0, 50);

        const badge = (lvl) => ({
          info: "bg-blue-500/15 text-blue-700 dark:text-blue-200",
          success:
            "bg-emerald-500/15 text-emerald-700 dark:text-emerald-200",
          warning: "bg-amber-500/15 text-amber-800 dark:text-amber-200",
          error: "bg-red-500/15 text-red-700 dark:text-red-200",
        }[lvl] || "bg-slate-500/15 text-slate-700 dark:text-slate-200");

        for (const e of show) {
          const row = document.createElement("div");
          row.className =
            "rounded-2xl border border-slate-200/60 bg-white/70 p-3 text-xs dark:border-slate-700/60 dark:bg-slate-900/20";
          row.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <span class="rounded-xl px-2 py-1 text-[10px] font-extrabold uppercase tracking-widest ${
            badge(e.level)
          }">${escapeHtml(e.level)}</span>
              <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 tabular-nums">${
            escapeHtml(e.ts)
          }</span>
            </div>
            <div class="mt-2 text-sm text-slate-800 dark:text-slate-100 leading-snug">${
            escapeHtml(e.message)
          }</div>
          `;
          list.appendChild(row);
        }
      }

      function reportError(context, err) {
        const msg = `${context}: ${err?.message || String(err)}`;
        toast("error", msg);
        addLog("error", msg);
        console.error(err);
      }

      // ---------- Loading overlay ----------
      function showLoading(title, subtitle) {
        $("loadingTitle").textContent = title || "Processing...";
        $("loadingSubtitle").textContent = subtitle || "Please wait";
        setLoadingProgress(0);
        $("loadingOverlay").classList.remove("hidden");
      }
      function hideLoading() {
        $("loadingOverlay").classList.add("hidden");
      }
      function setLoadingProgress(pct) {
        const v = clamp(Math.round(pct), 0, 100);
        $("loadingPct").textContent = `${v}%`;
        $("loadingBar").style.width = `${v}%`;
        $("loadingOverlay").querySelector('[role="progressbar"]')
          .setAttribute("aria-valuenow", String(v));
      }

      // ---------- Worker / Engine Layer ----------
      let worker = null;
      let engineFallback = null; // { ESNRegression, model }
      let workerInitInProgress = false;

      function createWorkerScript() {
        // Web Worker module: dynamic import of ESNRegression; requestId tracking; cancel support
        return `
          let ESNRegression = null;
          let model = null;
          let moduleURL = null;

          // Cancellation
          let activeJobId = null;
          let cancelFlag = false;

          function respond(payload) {
            self.postMessage(payload);
          }

          async function ensureModule(url) {
            if (!ESNRegression || moduleURL !== url) {
              const mod = await import(url);
              // library may export ESNRegression named or default; handle both
              ESNRegression = mod.ESNRegression || mod.default?.ESNRegression || mod.default || mod;
              moduleURL = url;
            }
          }

          async function trainOnlineChunks(requestId, coordinates, chunkSize) {
            if (!model) throw new Error("No model to train.");
            if (!Array.isArray(coordinates) || coordinates.length < 2) {
              throw new Error("Training requires coordinates with at least 2 time steps.");
            }
            const totalPairs = Math.max(0, coordinates.length - 1);
            let processed = 0;

            // Fit online with sliding pairs: [[t], [t+1]]
            // Chunk to allow progress/cancel checks
            let lastMetrics = { averageLoss: null, gradientNorm: null, sampleWeight: null };
            for (let i = 0; i < totalPairs; i += chunkSize) {
              if (cancelFlag && activeJobId === requestId) {
                respond({ type: "result", requestId, ok: false, error: "Cancelled" });
                return;
              }
              const end = Math.min(totalPairs, i + chunkSize);

              // Build batch: need at least 2 points per fitOnline call, so we pass contiguous segment
              const segment = coordinates.slice(i, end + 1);
              const result = model.fitOnline({ coordinates: segment });
              lastMetrics = result || lastMetrics;

              processed = end;
              const pct = totalPairs === 0 ? 100 : Math.round((processed / totalPairs) * 100);
              respond({ type: "progress", requestId, progress: pct, processed, total: totalPairs });
              await new Promise(r => setTimeout(r, 0));
            }

            respond({ type: "result", requestId, ok: true, data: { metrics: lastMetrics, sampleCount: model.getModelSummary?.().sampleCount ?? null, summary: model.getModelSummary?.() ?? null } });
          }

          self.onmessage = async (ev) => {
            const msg = ev.data || {};
            const { type, requestId } = msg;

            try {
              if (type === "cancel") {
                cancelFlag = true;
                respond({ type: "result", requestId, ok: true, data: { cancelled: true } });
                return;
              }

              if (type === "init") {
                cancelFlag = false;
                activeJobId = requestId;
                await ensureModule(msg.moduleURL);
                respond({ type: "result", requestId, ok: true, data: { ready: true } });
                return;
              }

              if (type === "reset") {
                cancelFlag = false;
                activeJobId = requestId;
                model = null;
                respond({ type: "result", requestId, ok: true, data: { reset: true } });
                return;
              }

              if (type === "createModel") {
                cancelFlag = false;
                activeJobId = requestId;
                await ensureModule(msg.moduleURL);
                model = new ESNRegression(msg.config);
                respond({ type: "result", requestId, ok: true, data: { created: true } });
                return;
              }

              if (type === "train") {
                cancelFlag = false;
                activeJobId = requestId;
                await trainOnlineChunks(requestId, msg.dataset?.coordinates, msg.chunkSize || 32);
                return;
              }

              if (type === "predict") {
                cancelFlag = false;
                activeJobId = requestId;
                if (!model) throw new Error("No model to predict.");
                const futureSteps = msg.futureSteps;
                if (!Number.isFinite(futureSteps) || futureSteps <= 0) throw new Error("futureSteps must be a positive number.");
                const res = model.predict(futureSteps);
                respond({ type: "result", requestId, ok: true, data: res });
                return;
              }

              if (type === "save") {
                cancelFlag = false;
                activeJobId = requestId;
                if (!model) throw new Error("No model to save.");
                const saved = model.save();
                respond({ type: "result", requestId, ok: true, data: saved });
                return;
              }

              if (type === "load") {
                cancelFlag = false;
                activeJobId = requestId;
                await ensureModule(msg.moduleURL);
                if (!model) model = new ESNRegression(msg.config);
                model.load(msg.state);
                respond({ type: "result", requestId, ok: true, data: { loaded: true, summary: model.getModelSummary?.() ?? null } });
                return;
              }

              if (type === "getSummary") {
                cancelFlag = false;
                activeJobId = requestId;
                if (!model) throw new Error("No model.");
                const summary = model.getModelSummary ? model.getModelSummary() : null;
                respond({ type: "result", requestId, ok: true, data: summary });
                return;
              }

              respond({ type: "result", requestId, ok: false, error: "Unknown message type: " + type });
            } catch (err) {
              respond({ type: "result", requestId, ok: false, error: err?.message || String(err) });
            }
          };
        `;
      }

      async function initEngine() {
        if (workerInitInProgress) return;
        workerInitInProgress = true;

        try {
          // Try worker first
          const script = createWorkerScript();
          const blobURL = URL.createObjectURL(
            new Blob([script], { type: "text/javascript" }),
          );
          worker = new Worker(blobURL, { type: "module" });

          worker.onmessage = (ev) => {
            const msg = ev.data || {};
            if (msg.type === "progress") {
              if (state.lastOpRequestId === msg.requestId) {
                setLoadingProgress(msg.progress ?? 0);
              }
              addLog(
                "info",
                `Training progress: ${msg.progress ?? 0}%`,
              );
              return;
            }
            if (msg.type === "result") {
              const inflight = state.inFlight.get(msg.requestId);
              if (!inflight) return;
              state.inFlight.delete(msg.requestId);
              if (msg.ok) inflight.resolve(msg.data);
              else {inflight.reject(
                  new Error(msg.error || "Worker error"),
                );}
              return;
            }
          };

          worker.onerror = (e) => {
            state.workerHealthy = false;
            addLog(
              "error",
              "Worker crashed; falling back to main thread.",
            );
            toast(
              "warning",
              "Worker unavailable. Falling back to main thread.",
            );
            console.error(e);
          };

          // init handshake
          await callEngine("init", { moduleURL: state.moduleURL });
          state.workerHealthy = true;
          addLog("success", "Worker initialized.");
        } catch (err) {
          state.workerHealthy = false;
          worker = null;
          addLog(
            "warning",
            "Worker init failed; using main-thread fallback.",
          );
          toast(
            "warning",
            "Worker failed. Running in main thread (may be slower).",
          );
          await initFallback();
        } finally {
          workerInitInProgress = false;
        }
      }

      async function initFallback() {
        try {
          const mod = await import(state.moduleURL);
          const ESNRegression = mod.ESNRegression ||
            mod.default?.ESNRegression || mod.default || mod;
          engineFallback = { ESNRegression, model: null };
          addLog("success", "Fallback engine ready.");
        } catch (err) {
          engineFallback = null;
          reportError("Fallback init failed", err);
        }
      }

      function nextRequestId() {
        return state.requestSeq++;
      }

      async function callEngine(
        type,
        payload = {},
        trackLoading = false,
        loadingMeta = {},
      ) {
        const requestId = nextRequestId();
        const msg = { type, requestId, ...payload };

        // Long-running ops: allow cancel button to target latest
        if (trackLoading) state.lastOpRequestId = requestId;

        return await new Promise((resolve, reject) => {
          state.inFlight.set(requestId, { resolve, reject, type });

          try {
            if (worker && state.workerHealthy) {
              worker.postMessage(msg);
              return;
            }
            // fallback
            (async () => {
              try {
                const data = await callFallback(type, msg);
                state.inFlight.delete(requestId);
                resolve(data);
              } catch (err) {
                state.inFlight.delete(requestId);
                reject(err);
              }
            })();
          } catch (err) {
            state.inFlight.delete(requestId);
            reject(err);
          }
        });
      }

      async function callFallback(type, msg) {
        try {
          if (!engineFallback) await initFallback();
          if (!engineFallback) throw new Error("Engine unavailable.");

          const { ESNRegression } = engineFallback;
          if (type === "init") return { ready: true };
          if (type === "reset") {
            engineFallback.model = null;
            return { reset: true };
          }
          if (type === "createModel") {
            engineFallback.model = new ESNRegression(msg.config);
            return { created: true };
          }
          if (type === "train") {
            if (!engineFallback.model) {
              throw new Error("No model to train.");
            }
            const coords = msg.dataset?.coordinates;
            if (!Array.isArray(coords) || coords.length < 2) {
              throw new Error(
                "Training requires at least 2 time steps.",
              );
            }
            const totalPairs = coords.length - 1;
            let lastMetrics = {
              averageLoss: null,
              gradientNorm: null,
              sampleWeight: null,
            };
            for (let i = 0; i < totalPairs; i += msg.chunkSize || 32) {
              const end = Math.min(
                totalPairs,
                i + (msg.chunkSize || 32),
              );
              const segment = coords.slice(i, end + 1);
              lastMetrics = engineFallback.model.fitOnline({
                coordinates: segment,
              }) || lastMetrics;
              const pct = Math.round((end / totalPairs) * 100);
              if (state.lastOpRequestId === msg.requestId) {
                setLoadingProgress(pct);
              }
              await new Promise((r) => setTimeout(r, 0));
            }
            return {
              metrics: lastMetrics,
              summary: engineFallback.model.getModelSummary?.() ?? null,
            };
          }
          if (type === "predict") {
            if (!engineFallback.model) {
              throw new Error("No model to predict.");
            }
            return engineFallback.model.predict(msg.futureSteps);
          }
          if (type === "save") {
            if (!engineFallback.model) {
              throw new Error("No model to save.");
            }
            return engineFallback.model.save();
          }
          if (type === "load") {
            if (!engineFallback.model) {
              engineFallback.model = new ESNRegression(msg.config);
            }
            engineFallback.model.load(msg.state);
            return {
              loaded: true,
              summary: engineFallback.model.getModelSummary?.() ?? null,
            };
          }
          if (type === "getSummary") {
            if (!engineFallback.model) throw new Error("No model.");
            return engineFallback.model.getModelSummary?.() ?? null;
          }
          if (type === "cancel") return { cancelled: true };
          throw new Error("Unknown op: " + type);
        } catch (err) {
          throw err;
        }
      }

      async function cancelLastOp() {
        try {
          if (!state.lastOpRequestId) return;
          await callEngine("cancel", {}, false);
          addLog("warning", "Cancellation requested.");
          toast("warning", "Cancel requested.");
        } catch (err) {
          reportError("Cancel failed", err);
        }
      }

      // ---------- UI: Theme ----------
      function applyTheme() {
        document.documentElement.classList.toggle(
          "dark",
          !!state.isDark,
        );
        $("btnTheme").textContent = state.isDark ? "‚òÄÔ∏è" : "üåô";
        savePrefs();
      }

      // ---------- UI: Tabs ----------
      function setMode(mode) {
        state.vizMode = mode;
        savePrefs();
        renderTabs();
        renderModeControls();
        renderCanvas();
      }

      function renderTabs() {
        document.querySelectorAll(".tabBtn").forEach((btn) => {
          const active = btn.dataset.mode === state.vizMode;
          btn.className =
            "tabBtn rounded-xl px-3 py-2 text-sm font-semibold " +
            (active
              ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/20"
              : "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-100");
        });
      }

      function renderModeControls() {
        const hasPred = !!state.predictions?.predictions?.length;
        $("dimSelectorRow").classList.toggle(
          "hidden",
          !(hasPred && state.vizMode === "focus"),
        );
        $("statsBar").classList.toggle(
          "hidden",
          !(hasPred && state.vizMode === "focus"),
        );
        $("snapshotControls").classList.toggle(
          "hidden",
          !(hasPred && state.vizMode === "snapshot"),
        );
      }

      // ---------- Status/Top Controls ----------
      function updateStatus() {
        const dot = $("statusDot");
        const txt = $("statusText");
        const steps = state.sampleCount || 0;
        if (state.modelExists) {
          dot.className =
            "inline-block h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse";
          txt.textContent = `${steps} steps`;
          $("btnPredictTop").classList.remove("hidden");
          $("btnPredictTop").classList.add("flex");
        } else {
          dot.className =
            "inline-block h-2.5 w-2.5 rounded-full bg-slate-400 animate-pulse";
          txt.textContent = "No Model";
          $("btnPredictTop").classList.add("hidden");
          $("btnPredictTop").classList.remove("flex");
        }
        $("btnPredict").disabled = !state.modelExists;
        $("btnPredictTop").disabled = !state.modelExists;
      }

      function updatePanels() {
        $("mSamples").textContent = String(state.sampleCount || 0);
        $("mLoss").textContent = state.metrics.avgLoss == null
          ? "‚Äî"
          : fmtExp(state.metrics.avgLoss);
        $("mGrad").textContent = state.metrics.gradientNorm == null
          ? "‚Äî"
          : fmtExp(state.metrics.gradientNorm);
        $("mWeight").textContent = state.metrics.sampleWeight == null
          ? "‚Äî"
          : Number(state.metrics.sampleWeight).toFixed(3);
      }

      function fmtExp(v) {
        if (!Number.isFinite(v)) return "‚Äî";
        const abs = Math.abs(v);
        if (abs !== 0 && (abs < 0.001 || abs > 10000)) {
          return v.toExponential(2);
        }
        return v.toFixed(6).replace(/0+$/, "").replace(/\.$/, "");
      }

      // ---------- Dataset validation ----------
      function validateDataset(obj) {
        if (!obj || typeof obj !== "object") {
          return { ok: false, error: "JSON must be an object." };
        }
        const coords = obj.coordinates;
        if (!Array.isArray(coords)) {
          return {
            ok: false,
            error: '"coordinates" must be an array.',
          };
        }
        if (coords.length < 2) {
          return { ok: false, error: "Need at least 2 time steps." };
        }
        if (!Array.isArray(coords[0]) || coords[0].length < 1) {
          return {
            ok: false,
            error:
              "Each coordinate must be an array with at least 1 dimension.",
          };
        }
        const dims = coords[0].length;
        for (let i = 0; i < coords.length; i++) {
          if (!Array.isArray(coords[i]) || coords[i].length !== dims) {
            return {
              ok: false,
              error: `Inconsistent dimensions at step ${i}.`,
            };
          }
          for (let d = 0; d < dims; d++) {
            if (!Number.isFinite(coords[i][d])) {
              return {
                ok: false,
                error: `Non-numeric value at step ${i}, dim ${d + 1}.`,
              };
            }
          }
        }
        return { ok: true, dims, steps: coords.length };
      }

      // ---------- Model actions ----------
      async function createModel() {
        try {
          showLoading(
            "Creating model...",
            "Initializing ESN Regression",
          );
          state.lastOpRequestId = null;
          await callEngine("createModel", {
            moduleURL: state.moduleURL,
            config: state.config,
          }, false);
          state.modelExists = true;
          state.sampleCount = 0;
          state.metrics = {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          };
          state.predictions = null;
          state.nDimensions = 0;
          addLog("success", "Model created.");
          toast("success", "Model created.");
          updateStatus();
          updatePanels();
          renderAfterPredictions();
        } catch (err) {
          reportError("Create model failed", err);
        } finally {
          hideLoading();
        }
      }

      async function trainOnDataset(dataset, label = "uploaded data") {
        try {
          const v = validateDataset(dataset);
          if (!v.ok) throw new Error(v.error);

          if (!state.modelExists) {
            await createModel();
          }

          state.lastDataset = dataset;
          state.nDimensions = v.dims;

          showLoading("Training...", `Training on ${label}`);
          setLoadingProgress(0);

          // Track loading + enable cancel
          const requestId = nextRequestId();
          state.lastOpRequestId = requestId;

          // We must call callEngine with our requestId; simplest: temporary wrapper
          const trainPromise = new Promise((resolve, reject) => {
            state.inFlight.set(requestId, {
              resolve,
              reject,
              type: "train",
            });
            try {
              if (worker && state.workerHealthy) {
                worker.postMessage({
                  type: "train",
                  requestId,
                  dataset,
                  chunkSize: 32,
                });
              } else {
                (async () => {
                  try {
                    const data = await callFallback("train", {
                      type: "train",
                      requestId,
                      dataset,
                      chunkSize: 32,
                    });
                    state.inFlight.delete(requestId);
                    resolve(data);
                  } catch (e) {
                    state.inFlight.delete(requestId);
                    reject(e);
                  }
                })();
              }
            } catch (e) {
              state.inFlight.delete(requestId);
              reject(e);
            }
          });

          const res = await trainPromise;
          const metrics = res?.metrics || {};
          state.metrics.avgLoss = metrics.averageLoss ??
            metrics.avgLoss ?? state.metrics.avgLoss;
          state.metrics.gradientNorm = metrics.gradientNorm ??
            state.metrics.gradientNorm;
          state.metrics.sampleWeight = metrics.sampleWeight ??
            state.metrics.sampleWeight;
          const summary = res?.summary;
          if (summary?.sampleCount != null) {
            state.sampleCount = summary.sampleCount;
          } else state.sampleCount = dataset.coordinates.length;

          addLog(
            "success",
            `Training complete (${dataset.coordinates.length} steps, ${state.nDimensions} dims).`,
          );
          toast("success", "Training complete.");
          updateStatus();
          updatePanels();

          // Auto-predict a small preview
          await runPrediction(
            Number($("futureSteps").value) || 50,
            true,
          );
        } catch (err) {
          reportError("Training failed", err);
        } finally {
          hideLoading();
        }
      }

      function validateFutureSteps() {
        const el = $("futureSteps");
        const errEl = $("futureStepsErr");
        const v = Number(el.value);
        if (!Number.isFinite(v) || v <= 0 || Math.floor(v) !== v) {
          errEl.textContent = "Enter a positive integer.";
          errEl.classList.remove("hidden");
          return { ok: false };
        }
        errEl.classList.add("hidden");
        return { ok: true, value: v };
      }

      async function runPrediction(steps, quiet = false) {
        try {
          const vv = validateFutureSteps();
          if (!vv.ok && steps == null) return;
          const futureSteps = steps ?? vv.value;

          if (!state.modelExists) throw new Error("No model exists.");

          showLoading(
            "Predicting...",
            `Forecasting ${futureSteps} steps`,
          );
          setLoadingProgress(20);

          const res = await callEngine(
            "predict",
            { futureSteps },
            false,
          );
          state.predictions = res;
          state.selectedDim = clamp(
            state.selectedDim,
            0,
            (res?.predictions?.[0]?.length || 1) - 1,
          );
          state.selectedStep = clamp(
            state.selectedStep,
            0,
            (res?.predictions?.length || 1) - 1,
          );
          setLoadingProgress(100);

          addLog(
            "success",
            `Prediction generated (${futureSteps} steps).`,
          );
          if (!quiet) toast("success", "Prediction complete.");

          renderAfterPredictions();
        } catch (err) {
          reportError("Prediction failed", err);
        } finally {
          hideLoading();
        }
      }

      async function getSummary() {
        try {
          if (!state.modelExists) throw new Error("No model exists.");
          showLoading("Fetching summary...", "Reading model state");
          const summary = await callEngine("getSummary", {}, false);
          addLog("info", "Model summary: " + JSON.stringify(summary));
          toast("info", "Summary added to event log.");
        } catch (err) {
          reportError("Summary failed", err);
        } finally {
          hideLoading();
        }
      }

      async function resetApp() {
        try {
          showLoading("Resetting...", "Clearing model and predictions");
          await callEngine("reset", {}, false);
          state.modelExists = false;
          state.sampleCount = 0;
          state.nDimensions = 0;
          state.predictions = null;
          state.metrics = {
            avgLoss: null,
            gradientNorm: null,
            sampleWeight: null,
          };
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: 0,
          };
          state.hover = { active: false, x: 0, y: 0, dataIndex: -1 };
          addLog("warning", "App reset.");
          toast("warning", "Reset complete.");
          updateStatus();
          updatePanels();
          renderAfterPredictions();
        } catch (err) {
          reportError("Reset failed", err);
        } finally {
          hideLoading();
        }
      }

      // ---------- Canvas rendering ----------
      const canvas = $("chart");
      const ctx = canvas.getContext("2d");

      function ensureCanvasSize() {
        const wrap = $("canvasWrap");
        const rect = wrap.getBoundingClientRect();
        const dpr = Math.max(
          1,
          Math.floor(window.devicePixelRatio || 1),
        );
        const targetW = Math.floor(rect.width * dpr);
        const targetH = Math.floor(canvas.getAttribute("height") * 1); // keep height attribute (CSS already full width)
        if (canvas.width !== targetW || canvas.height !== targetH) {
          canvas.width = targetW;
          canvas.height = targetH;
        }
        ctx.setTransform(1, 0, 0, 1, 0, 0);
      }

      function getPredData() {
        const res = state.predictions;
        if (!res?.predictions?.length) return null;
        const P = res.predictions;
        const L = res.lowerBounds || null;
        const U = res.upperBounds || null;
        const steps = P.length;
        const dims = P[0]?.length || 0;
        return {
          P,
          L,
          U,
          steps,
          dims,
          confidence: res.confidence ?? null,
        };
      }

      function computeZoomWindow(steps) {
        const level = clamp(state.zoom.level, 1, 10);
        const visibleCount = Math.max(10, Math.floor(steps / level));
        state.zoom.visibleCount = visibleCount;
        state.zoom.visibleStart = clamp(
          state.zoom.visibleStart,
          0,
          Math.max(0, steps - visibleCount),
        );
      }

      function renderAfterPredictions() {
        const hasPred = !!state.predictions?.predictions?.length;
        $("emptyState").classList.toggle("hidden", hasPred);
        $("canvasWrap").classList.toggle("hidden", !hasPred);
        $("floatControls").classList.toggle("hidden", !hasPred);

        renderTabs();
        renderModeControls();
        renderDimButtons();
        renderStatsBar();
        renderSnapshotHint();

        renderCanvas();
      }

      function renderSnapshotHint() {
        const data = getPredData();
        if (!data) return;
        const maxStep = Math.max(0, data.steps - 1);
        $("snapshotStep").max = String(maxStep);
        $("snapshotStepHint").textContent = `0 ‚Ä¶ ${maxStep}`;
      }

      function renderDimButtons() {
        const data = getPredData();
        const wrap = $("dimButtons");
        wrap.innerHTML = "";
        if (!data) return;

        for (let d = 0; d < data.dims; d++) {
          const active = d === state.selectedDim;
          const btn = document.createElement("button");
          btn.className =
            "rounded-xl px-3 py-2 text-sm font-extrabold shadow-sm " +
            (active
              ? "text-white"
              : "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-100");
          btn.style.background = active
            ? PALETTE[d % PALETTE.length]
            : "";
          btn.textContent = `D${d + 1}`;
          btn.setAttribute("aria-label", `Select dimension ${d + 1}`);
          btn.addEventListener("click", () => {
            state.selectedDim = d;
            renderDimButtons();
            renderStatsBar();
            renderCanvas();
          });
          wrap.appendChild(btn);
        }
      }

      function seriesStats(values) {
        let min = Infinity, max = -Infinity, sum = 0;
        for (const v of values) {
          min = Math.min(min, v);
          max = Math.max(max, v);
          sum += v;
        }
        const mean = sum / Math.max(1, values.length);
        const final = values[values.length - 1] ?? 0;
        const first = values[0] ?? 0;
        return { min, max, mean, final, trend: final - first };
      }

      function renderStatsBar() {
        const data = getPredData();
        const bar = $("statsBar");
        bar.innerHTML = "";
        if (!data || state.vizMode !== "focus") return;

        const d = state.selectedDim;
        const y = data.P.map((r) => r[d]);
        const st = seriesStats(y);

        const conf = data.confidence ?? null;
        const trendUp = st.trend >= 0;

        const cards = [
          { label: "MIN", val: fmtExp(st.min) },
          { label: "MAX", val: fmtExp(st.max) },
          { label: "MEAN", val: fmtExp(st.mean) },
          { label: "FINAL", val: fmtExp(st.final) },
          {
            label: "TREND",
            val: `${trendUp ? "‚Üë" : "‚Üì"} ${fmtExp(Math.abs(st.trend))}`,
            valClass: trendUp
              ? "text-emerald-600 dark:text-emerald-300"
              : "text-red-600 dark:text-red-300",
          },
          {
            label: "CONF",
            val: conf == null ? "‚Äî" : `${Math.round(conf * 100)}%`,
          },
        ];

        for (const c of cards) {
          const el = document.createElement("div");
          el.className =
            "rounded-2xl border border-slate-200/60 bg-white/70 p-3 backdrop-blur dark:border-slate-700/60 dark:bg-slate-800/40";
          el.innerHTML = `
            <div class="text-[10px] font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">${
            escapeHtml(c.label)
          }</div>
            <div class="mt-1 text-sm font-extrabold tabular-nums ${
            c.valClass || ""
          }">${escapeHtml(c.val)}</div>
          `;
          bar.appendChild(el);
        }
      }

      function clearCanvas() {
        const isDark = state.isDark;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = isDark
          ? "rgba(15, 23, 42, 0.0)"
          : "rgba(248, 250, 252, 0.0)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      function drawAxes(x0, y0, w, h) {
        ctx.save();
        ctx.strokeStyle = state.isDark
          ? "rgba(148,163,184,0.35)"
          : "rgba(100,116,139,0.25)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x0, y0 + h);
        ctx.lineTo(x0 + w, y0 + h);
        ctx.stroke();
        ctx.restore();
      }

      function renderCanvas() {
        const data = getPredData();
        if (
          !$("canvasWrap") ||
          $("canvasWrap").classList.contains("hidden")
        ) return;
        ensureCanvasSize();
        clearCanvas();

        if (!data) return;

        computeZoomWindow(data.steps);
        $("zoomBadge").textContent = `${
          Math.round(100 / state.zoom.level)
        }%`;

        if (state.vizMode === "grid") renderGrid(data);
        else if (state.vizMode === "focus") renderFocus(data);
        else if (state.vizMode === "heatmap") renderHeatmap(data);
        else if (state.vizMode === "ci") renderUncertainty(data);
        else if (state.vizMode === "snapshot") renderSnapshot(data);
      }

      function windowedSteps(data) {
        const start = state.zoom.visibleStart;
        const count = state.zoom.visibleCount || data.steps;
        const end = Math.min(data.steps, start + count);
        return { start, end, count: end - start };
      }

      function findMinMax(series) {
        let min = Infinity, max = -Infinity;
        for (const v of series) {
          min = Math.min(min, v);
          max = Math.max(max, v);
        }
        if (!Number.isFinite(min) || !Number.isFinite(max)) {
          return { min: 0, max: 1 };
        }
        if (min === max) return { min: min - 1, max: max + 1 };
        return { min, max };
      }

      function mapY(v, min, max, y0, h) {
        const t = (v - min) / (max - min);
        return y0 + (1 - t) * h;
      }

      function renderGrid(data) {
        const padding = 24 * (window.devicePixelRatio || 1);
        const W = canvas.width, H = canvas.height;

        const cols = W > H ? 2 : 1;
        const rows = Math.ceil(data.dims / cols);

        const cardGap = 16 * (window.devicePixelRatio || 1);
        const cardW = (W - padding * 2 - cardGap * (cols - 1)) / cols;
        const cardH = (H - padding * 2 - cardGap * (rows - 1)) / rows;

        const { start, end, count } = windowedSteps(data);

        for (let d = 0; d < data.dims; d++) {
          const r = Math.floor(d / cols);
          const c = d % cols;
          const x = padding + c * (cardW + cardGap);
          const y = padding + r * (cardH + cardGap);

          // card background
          ctx.save();
          ctx.fillStyle = state.isDark
            ? "rgba(15,23,42,0.35)"
            : "rgba(255,255,255,0.9)";
          ctx.strokeStyle = state.isDark
            ? "rgba(51,65,85,0.6)"
            : "rgba(226,232,240,0.9)";
          ctx.lineWidth = 2;
          roundRect(
            x,
            y,
            cardW,
            cardH,
            18 * (window.devicePixelRatio || 1),
          );
          ctx.fill();
          ctx.stroke();
          ctx.restore();

          // label
          ctx.save();
          ctx.fillStyle = state.isDark
            ? "rgba(226,232,240,0.9)"
            : "rgba(15,23,42,0.9)";
          ctx.font = `${
            12 * (window.devicePixelRatio || 1)
          }px ui-sans-serif, system-ui`;
          ctx.fillText(
            `D${d + 1}`,
            x + 14 * (window.devicePixelRatio || 1),
            y + 22 * (window.devicePixelRatio || 1),
          );
          ctx.restore();

          const innerPad = 14 * (window.devicePixelRatio || 1);
          const x0 = x + innerPad;
          const y0 = y + innerPad + 16 * (window.devicePixelRatio || 1);
          const w = cardW - innerPad * 2;
          const h = cardH - innerPad * 2 -
            16 * (window.devicePixelRatio || 1);

          drawAxes(x0, y0, w, h);

          const series = [];
          for (let i = start; i < end; i++) series.push(data.P[i][d]);
          const { min, max } = findMinMax(series);

          ctx.save();
          ctx.strokeStyle = PALETTE[d % PALETTE.length];
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let i = 0; i < series.length; i++) {
            const xx = x0 + (i / Math.max(1, series.length - 1)) * w;
            const yy = mapY(series[i], min, max, y0, h);
            if (i === 0) ctx.moveTo(xx, yy);
            else ctx.lineTo(xx, yy);
          }
          ctx.stroke();
          ctx.restore();
        }
      }

      function renderFocus(data) {
        const W = canvas.width, H = canvas.height;
        const pad = 22 * (window.devicePixelRatio || 1);
        const x0 = pad, y0 = pad, w = W - pad * 2, h = H - pad * 2;

        const { start, end, count } = windowedSteps(data);
        const d = state.selectedDim;

        const y = [];
        const lo = [];
        const hi = [];
        for (let i = start; i < end; i++) {
          y.push(data.P[i][d]);
          lo.push(data.L ? data.L[i][d] : data.P[i][d]);
          hi.push(data.U ? data.U[i][d] : data.P[i][d]);
        }

        const mm = findMinMax([...lo, ...hi]);

        drawAxes(x0, y0, w, h);

        // CI band
        ctx.save();
        ctx.fillStyle = hexToRgba(
          PALETTE[d % PALETTE.length],
          state.isDark ? 0.22 : 0.16,
        );
        ctx.beginPath();
        for (let i = 0; i < count; i++) {
          const xx = x0 + (i / Math.max(1, count - 1)) * w;
          const yy = mapY(hi[i], mm.min, mm.max, y0, h);
          if (i === 0) ctx.moveTo(xx, yy);
          else ctx.lineTo(xx, yy);
        }
        for (let i = count - 1; i >= 0; i--) {
          const xx = x0 + (i / Math.max(1, count - 1)) * w;
          const yy = mapY(lo[i], mm.min, mm.max, y0, h);
          ctx.lineTo(xx, yy);
        }
        ctx.closePath();
        ctx.fill();
        ctx.restore();

        // Main line
        ctx.save();
        ctx.strokeStyle = PALETTE[d % PALETTE.length];
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 0; i < count; i++) {
          const xx = x0 + (i / Math.max(1, count - 1)) * w;
          const yy = mapY(y[i], mm.min, mm.max, y0, h);
          if (i === 0) ctx.moveTo(xx, yy);
          else ctx.lineTo(xx, yy);
        }
        ctx.stroke();
        ctx.restore();

        // Crosshair (if hovering)
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const idx = clamp(state.hover.dataIndex, 0, count - 1);
          const xx = x0 + (idx / Math.max(1, count - 1)) * w;
          const yy = mapY(y[idx], mm.min, mm.max, y0, h);

          ctx.save();
          ctx.strokeStyle = state.isDark
            ? "rgba(226,232,240,0.35)"
            : "rgba(15,23,42,0.25)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(xx, y0);
          ctx.lineTo(xx, y0 + h);
          ctx.moveTo(x0, yy);
          ctx.lineTo(x0 + w, yy);
          ctx.stroke();
          ctx.restore();

          // Highlight point (glow effect approximation: larger alpha circles)
          ctx.save();
          ctx.fillStyle = hexToRgba(PALETTE[d % PALETTE.length], 0.25);
          ctx.beginPath();
          ctx.arc(
            xx,
            yy,
            10 * (window.devicePixelRatio || 1),
            0,
            Math.PI * 2,
          );
          ctx.fill();
          ctx.fillStyle = hexToRgba(PALETTE[d % PALETTE.length], 0.45);
          ctx.beginPath();
          ctx.arc(
            xx,
            yy,
            6 * (window.devicePixelRatio || 1),
            0,
            Math.PI * 2,
          );
          ctx.fill();
          ctx.fillStyle = "#ffffff";
          ctx.beginPath();
          ctx.arc(
            xx,
            yy,
            3 * (window.devicePixelRatio || 1),
            0,
            Math.PI * 2,
          );
          ctx.fill();
          ctx.restore();
        }

        // Info badge
        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(2,6,23,0.45)"
          : "rgba(255,255,255,0.85)";
        ctx.strokeStyle = state.isDark
          ? "rgba(51,65,85,0.7)"
          : "rgba(226,232,240,0.9)";
        ctx.lineWidth = 2;
        const bx = x0 + 10 * (window.devicePixelRatio || 1);
        const by = y0 + 10 * (window.devicePixelRatio || 1);
        const bw = 190 * (window.devicePixelRatio || 1);
        const bh = 44 * (window.devicePixelRatio || 1);
        roundRect(bx, by, bw, bh, 16 * (window.devicePixelRatio || 1));
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle = state.isDark
          ? "rgba(226,232,240,0.9)"
          : "rgba(15,23,42,0.9)";
        ctx.font = `${
          12 * (window.devicePixelRatio || 1)
        }px ui-sans-serif, system-ui`;
        ctx.fillText(
          `üîç Focus: D${d + 1}`,
          bx + 12 * (window.devicePixelRatio || 1),
          by + 18 * (window.devicePixelRatio || 1),
        );
        ctx.font = `${
          10 * (window.devicePixelRatio || 1)
        }px ui-sans-serif, system-ui`;
        ctx.fillStyle = state.isDark
          ? "rgba(148,163,184,0.9)"
          : "rgba(71,85,105,0.9)";
        ctx.fillText(
          `Steps ${start}‚Äì${end - 1}`,
          bx + 12 * (window.devicePixelRatio || 1),
          by + 34 * (window.devicePixelRatio || 1),
        );
        ctx.restore();
      }

      function renderHeatmap(data) {
        const W = canvas.width, H = canvas.height;
        const pad = 22 * (window.devicePixelRatio || 1);
        const x0 = pad, y0 = pad, w = W - pad * 2, h = H - pad * 2;

        const { start, end, count } = windowedSteps(data);

        // compute global min/max for visible window
        let min = Infinity, max = -Infinity;
        for (let i = start; i < end; i++) {
          for (let d = 0; d < data.dims; d++) {
            const v = data.P[i][d];
            min = Math.min(min, v);
            max = Math.max(max, v);
          }
        }
        if (min === max) {
          min -= 1;
          max += 1;
        }

        // background card
        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(15,23,42,0.2)"
          : "rgba(255,255,255,0.6)";
        ctx.strokeStyle = state.isDark
          ? "rgba(51,65,85,0.6)"
          : "rgba(226,232,240,0.9)";
        ctx.lineWidth = 2;
        roundRect(x0, y0, w, h, 18 * (window.devicePixelRatio || 1));
        ctx.fill();
        ctx.stroke();
        ctx.restore();

        const cellW = w / count;
        const cellH = h / data.dims;

        for (let i = 0; i < count; i++) {
          const step = start + i;
          for (let d = 0; d < data.dims; d++) {
            const v = data.P[step][d];
            const t = (v - min) / (max - min);
            const col = heatColor(t);
            ctx.fillStyle = col;
            ctx.fillRect(
              x0 + i * cellW,
              y0 + d * cellH,
              cellW + 1,
              cellH + 1,
            );
          }
        }

        // Labels
        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(226,232,240,0.85)"
          : "rgba(15,23,42,0.85)";
        ctx.font = `${
          12 * (window.devicePixelRatio || 1)
        }px ui-sans-serif, system-ui`;
        ctx.fillText(
          "üå°Ô∏è Heatmap (value intensity)",
          x0 + 14 * (window.devicePixelRatio || 1),
          y0 + 22 * (window.devicePixelRatio || 1),
        );
        ctx.restore();
      }

      function renderUncertainty(data) {
        const W = canvas.width, H = canvas.height;
        const pad = 22 * (window.devicePixelRatio || 1);
        const x0 = pad, y0 = pad, w = W - pad * 2, h = H - pad * 2;

        const { start, end, count } = windowedSteps(data);

        // uncertainty: mean spread across dims per step
        const spread = [];
        for (let i = start; i < end; i++) {
          let s = 0;
          for (let d = 0; d < data.dims; d++) {
            const lo = data.L ? data.L[i][d] : data.P[i][d];
            const hi = data.U ? data.U[i][d] : data.P[i][d];
            s += hi - lo;
          }
          spread.push(s / Math.max(1, data.dims));
        }

        const mm = findMinMax(spread);
        drawAxes(x0, y0, w, h);

        ctx.save();
        ctx.strokeStyle = state.isDark
          ? "rgba(20,184,166,1)"
          : "rgba(20,184,166,1)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 0; i < count; i++) {
          const xx = x0 + (i / Math.max(1, count - 1)) * w;
          const yy = mapY(spread[i], mm.min, mm.max, y0, h);
          if (i === 0) ctx.moveTo(xx, yy);
          else ctx.lineTo(xx, yy);
        }
        ctx.stroke();
        ctx.restore();

        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(226,232,240,0.85)"
          : "rgba(15,23,42,0.85)";
        ctx.font = `${
          12 * (window.devicePixelRatio || 1)
        }px ui-sans-serif, system-ui`;
        ctx.fillText(
          "üìà Uncertainty (avg CI width)",
          x0 + 10 * (window.devicePixelRatio || 1),
          y0 + 20 * (window.devicePixelRatio || 1),
        );
        ctx.restore();
      }

      function renderSnapshot(data) {
        const W = canvas.width, H = canvas.height;
        const pad = 22 * (window.devicePixelRatio || 1);
        const x0 = pad, y0 = pad, w = W - pad * 2, h = H - pad * 2;

        const step = clamp(state.selectedStep, 0, data.steps - 1);
        const vals = data.P[step];

        const mm = findMinMax(vals);
        // Card
        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(15,23,42,0.2)"
          : "rgba(255,255,255,0.6)";
        ctx.strokeStyle = state.isDark
          ? "rgba(51,65,85,0.6)"
          : "rgba(226,232,240,0.9)";
        ctx.lineWidth = 2;
        roundRect(x0, y0, w, h, 18 * (window.devicePixelRatio || 1));
        ctx.fill();
        ctx.stroke();
        ctx.restore();

        const barPad = 18 * (window.devicePixelRatio || 1);
        const bx0 = x0 + barPad;
        const by0 = y0 + 54 * (window.devicePixelRatio || 1);
        const bw = w - barPad * 2;
        const bh = h - 72 * (window.devicePixelRatio || 1);
        drawAxes(bx0, by0, bw, bh);

        const barW = bw / Math.max(1, data.dims);
        for (let d = 0; d < data.dims; d++) {
          const v = vals[d];
          const yy = mapY(v, mm.min, mm.max, by0, bh);
          const baseY = mapY(0, mm.min, mm.max, by0, bh);
          const x = bx0 + d * barW + barW * 0.15;
          const ww = barW * 0.7;
          const top = Math.min(yy, baseY);
          const height = Math.abs(baseY - yy);
          ctx.fillStyle = hexToRgba(PALETTE[d % PALETTE.length], 0.9);
          ctx.fillRect(x, top, ww, height);
        }

        ctx.save();
        ctx.fillStyle = state.isDark
          ? "rgba(226,232,240,0.85)"
          : "rgba(15,23,42,0.85)";
        ctx.font = `${
          12 * (window.devicePixelRatio || 1)
        }px ui-sans-serif, system-ui`;
        ctx.fillText(
          `üì∑ Snapshot (step ${step})`,
          x0 + 14 * (window.devicePixelRatio || 1),
          y0 + 28 * (window.devicePixelRatio || 1),
        );
        ctx.restore();
      }

      function heatColor(t) {
        // interpolate between blue -> emerald -> amber -> red
        const stops = [
          { t: 0.0, c: [59, 130, 246] },
          { t: 0.45, c: [16, 185, 129] },
          { t: 0.7, c: [245, 158, 11] },
          { t: 1.0, c: [239, 68, 68] },
        ];
        t = clamp(t, 0, 1);
        let a = stops[0], b = stops[stops.length - 1];
        for (let i = 0; i < stops.length - 1; i++) {
          if (t >= stops[i].t && t <= stops[i + 1].t) {
            a = stops[i];
            b = stops[i + 1];
            break;
          }
        }
        const u = (t - a.t) / Math.max(1e-9, b.t - a.t);
        const r = Math.round(a.c[0] + (b.c[0] - a.c[0]) * u);
        const g = Math.round(a.c[1] + (b.c[1] - a.c[1]) * u);
        const bl = Math.round(a.c[2] + (b.c[2] - a.c[2]) * u);
        const alpha = state.isDark ? 0.92 : 0.9;
        return `rgba(${r},${g},${bl},${alpha})`;
      }

      function hexToRgba(hex, a) {
        const h = hex.replace("#", "");
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        return `rgba(${r},${g},${b},${a})`;
      }

      function roundRect(x, y, w, h, r) {
        const rr = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      }

      // ---------- Interactions: zoom/pan/tooltip ----------
      let dragging = false;
      let dragStartX = 0;
      let dragStartVisibleStart = 0;

      function updateZoomBadge() {
        $("zoomBadge").textContent = `${
          Math.round(100 / state.zoom.level)
        }%`;
      }

      function zoomIn() {
        const old = state.zoom.level;
        state.zoom.level = clamp(state.zoom.level * 1.25, 1, 10);
        if (state.zoom.level !== old) {
          addLog(
            "info",
            `Zoom: ${Math.round(100 / state.zoom.level)}%`,
          );
        }
        updateZoomBadge();
        renderCanvas();
      }
      function zoomOut() {
        const old = state.zoom.level;
        state.zoom.level = clamp(state.zoom.level / 1.25, 1, 10);
        if (state.zoom.level !== old) {
          addLog(
            "info",
            `Zoom: ${Math.round(100 / state.zoom.level)}%`,
          );
        }
        updateZoomBadge();
        renderCanvas();
      }
      function zoomReset() {
        state.zoom.level = 1;
        state.zoom.visibleStart = 0;
        updateZoomBadge();
        renderCanvas();
      }

      function setHoverFromClientXY(clientX, clientY) {
        const data = getPredData();
        if (!data) return;
        if (state.vizMode !== "focus") return;

        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        const { start, end, count } = windowedSteps(data);
        const pad = 22;
        const innerW = rect.width - pad * 2;
        const relX = clamp((x - pad) / Math.max(1, innerW), 0, 1);
        const idx = Math.round(relX * Math.max(1, count - 1));

        state.hover.active = true;
        state.hover.x = x;
        state.hover.y = y;
        state.hover.dataIndex = idx;

        // Tooltip data
        const step = start + idx;
        const d = state.selectedDim;
        const pred = data.P[step]?.[d];
        const lo = data.L ? data.L[step]?.[d] : pred;
        const hi = data.U ? data.U[step]?.[d] : pred;

        $("ttStep").textContent = String(step);
        $("ttDim").textContent = `D${d + 1}`;
        $("ttDot").style.background = PALETTE[d % PALETTE.length];
        $("ttPred").textContent = fmtExp(pred);
        $("ttCI").textContent = `${fmtExp(lo)} ‚Äì ${fmtExp(hi)}`;
        $("ttSpread").textContent = fmtExp(hi - lo);

        const tt = $("tooltip");
        tt.classList.remove("hidden");
        // position near cursor, clamp within card
        const card = $("canvasWrap").getBoundingClientRect();
        const ttRect = tt.getBoundingClientRect();
        let left = clientX - card.left + 14;
        let top = clientY - card.top + 14;
        left = clamp(left, 8, card.width - 8 - ttRect.width);
        top = clamp(top, 8, card.height - 8 - ttRect.height);
        tt.style.left = left + "px";
        tt.style.top = top + "px";

        renderCanvas();
      }

      function clearHover() {
        state.hover.active = false;
        state.hover.dataIndex = -1;
        $("tooltip").classList.add("hidden");
        renderCanvas();
      }

      // Touch hold tooltip
      let holdTimer = null;
      let holding = false;

      function attachCanvasInteractions() {
        canvas.addEventListener("wheel", (e) => {
          try {
            if (!getPredData()) return;
            e.preventDefault();
            if (e.deltaY < 0) zoomIn();
            else zoomOut();
          } catch (err) {
            reportError("Wheel interaction failed", err);
          }
        }, { passive: false });

        canvas.addEventListener("mousedown", (e) => {
          try {
            if (!getPredData()) return;
            dragging = true;
            dragStartX = e.clientX;
            dragStartVisibleStart = state.zoom.visibleStart;
          } catch (err) {
            reportError("Drag start failed", err);
          }
        });
        window.addEventListener("mouseup", () => dragging = false);
        window.addEventListener("mousemove", (e) => {
          try {
            const data = getPredData();
            if (!data) return;

            if (dragging && state.zoom.level > 1) {
              const rect = canvas.getBoundingClientRect();
              const { count } = windowedSteps(data);
              const steps = data.steps;
              const dx = e.clientX - dragStartX;
              const frac = dx / Math.max(1, rect.width);
              const shift = Math.round(-frac * count);
              state.zoom.visibleStart = clamp(
                dragStartVisibleStart + shift,
                0,
                Math.max(0, steps - count),
              );
              renderCanvas();
              return;
            }
            // hover for focus only
            if (state.vizMode === "focus") {
              setHoverFromClientXY(e.clientX, e.clientY);
            }
          } catch (err) {
            reportError("Pointer move failed", err);
          }
        });

        canvas.addEventListener("mouseleave", () => {
          try {
            dragging = false;
            clearHover();
          } catch {}
        });

        // Touch: drag pan + pinch zoom + hold tooltip
        let lastDist = null;
        canvas.addEventListener("touchstart", (e) => {
          try {
            const data = getPredData();
            if (!data) return;
            if (e.touches.length === 1) {
              dragging = true;
              dragStartX = e.touches[0].clientX;
              dragStartVisibleStart = state.zoom.visibleStart;

              holding = false;
              clearTimeout(holdTimer);
              holdTimer = setTimeout(() => {
                holding = true;
                setHoverFromClientXY(
                  e.touches[0].clientX,
                  e.touches[0].clientY,
                );
              }, 420);
            } else if (e.touches.length === 2) {
              dragging = false;
              clearTimeout(holdTimer);
              const dx = e.touches[0].clientX - e.touches[1].clientX;
              const dy = e.touches[0].clientY - e.touches[1].clientY;
              lastDist = Math.hypot(dx, dy);
            }
          } catch (err) {
            reportError("Touch start failed", err);
          }
        }, { passive: true });

        canvas.addEventListener("touchmove", (e) => {
          try {
            const data = getPredData();
            if (!data) return;

            if (e.touches.length === 1) {
              clearTimeout(holdTimer);
              if (holding && state.vizMode === "focus") {
                setHoverFromClientXY(
                  e.touches[0].clientX,
                  e.touches[0].clientY,
                );
                return;
              }
              if (dragging && state.zoom.level > 1) {
                const rect = canvas.getBoundingClientRect();
                const { count } = windowedSteps(data);
                const steps = data.steps;
                const dx = e.touches[0].clientX - dragStartX;
                const frac = dx / Math.max(1, rect.width);
                const shift = Math.round(-frac * count);
                state.zoom.visibleStart = clamp(
                  dragStartVisibleStart + shift,
                  0,
                  Math.max(0, steps - count),
                );
                renderCanvas();
              }
            } else if (e.touches.length === 2 && lastDist != null) {
              const dx = e.touches[0].clientX - e.touches[1].clientX;
              const dy = e.touches[0].clientY - e.touches[1].clientY;
              const dist = Math.hypot(dx, dy);
              const ratio = dist / Math.max(1, lastDist);
              if (ratio > 1.02) zoomIn();
              if (ratio < 0.98) zoomOut();
              lastDist = dist;
            }
          } catch (err) {
            reportError("Touch move failed", err);
          }
        }, { passive: true });

        canvas.addEventListener("touchend", () => {
          try {
            dragging = false;
            clearTimeout(holdTimer);
            holding = false;
            // keep tooltip a bit; but simplest: hide on end
            clearHover();
          } catch {}
        });
      }

      // ---------- Export ----------
      async function exportPNG() {
        try {
          if (!getPredData()) {
            throw new Error("No predictions to export.");
          }
          const url = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = url;
          a.download = "esn-studio.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          addLog("success", "PNG exported.");
        } catch (err) {
          reportError("PNG export failed", err);
        }
      }

      async function exportSVG() {
        try {
          if (!getPredData()) {
            throw new Error("No predictions to export.");
          }
          const png = canvas.toDataURL("image/png");
          const w = canvas.width, h = canvas.height;
          const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
  <image href="${png}" width="${w}" height="${h}" />
</svg>`;
          const blob = new Blob([svg], { type: "image/svg+xml" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "esn-studio.svg";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          addLog("success", "SVG exported.");
        } catch (err) {
          reportError("SVG export failed", err);
        }
      }

      async function copyToClipboard() {
        try {
          if (!getPredData()) {
            throw new Error("No predictions to copy.");
          }
          if (!navigator.clipboard) {
            throw new Error("Clipboard API unavailable.");
          }
          const blob = await new Promise((res) =>
            canvas.toBlob(res, "image/png")
          );
          if (!blob) throw new Error("Could not create image blob.");
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          toast("success", "Copied to clipboard.");
          addLog("success", "Copied chart to clipboard.");
        } catch (err) {
          reportError("Copy failed", err);
        }
      }

      // ---------- Modal System ----------
      const modalRoot = $("modalRoot");
      let lastFocused = null;

      function openModal(
        title,
        bodyHtml,
        footerHtml,
        { ariaLabel } = {},
      ) {
        closeModal(); // single modal at a time
        lastFocused = document.activeElement;

        const overlay = document.createElement("div");
        overlay.id = "modalOverlay";
        overlay.className = "fixed inset-0 z-50";
        overlay.innerHTML = `
          <div class="absolute inset-0 bg-slate-900/45 backdrop-blur-sm"></div>
          <div class="relative mx-auto mt-12 w-[94%] max-w-lg rounded-2xl border border-slate-200/60 bg-white shadow-2xl dark:border-slate-700/60 dark:bg-slate-800/80" role="dialog" aria-modal="true" aria-label="${
          escapeHtml(ariaLabel || title)
        }">
            <div class="flex items-start justify-between gap-3 border-b border-slate-200/60 px-4 py-3 dark:border-slate-700/60">
              <div>
                <div class="text-base font-extrabold">${
          escapeHtml(title)
        }</div>
              </div>
              <button id="btnModalClose" class="rounded-xl border border-slate-200/60 bg-white/70 px-3 py-2 text-sm font-semibold dark:border-slate-700/60 dark:bg-slate-900/40" aria-label="Close modal">‚úñÔ∏è</button>
            </div>
            <div class="max-h-[70vh] overflow-auto px-4 py-4">${bodyHtml}</div>
            <div class="border-t border-slate-200/60 px-4 py-3 dark:border-slate-700/60">${footerHtml}</div>
          </div>
        `;
        modalRoot.appendChild(overlay);

        overlay.querySelector("#btnModalClose").addEventListener(
          "click",
          closeModal,
        );
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeModal();
        });

        // focus management
        setTimeout(() => {
          const first = overlay.querySelector(
            "button, input, select, textarea",
          );
          if (first) first.focus();
        }, 0);
      }

      function closeModal() {
        const existing = $("modalOverlay");
        if (existing) existing.remove();
        if (lastFocused && typeof lastFocused.focus === "function") {
          lastFocused.focus();
        }
        lastFocused = null;
      }

      // ---------- Configuration Modal ----------
      function openConfigModal() {
        try {
          const presetButtons = Object.keys(PRESETS).map((name, i) => {
            const col = [
              "bg-blue-500",
              "bg-emerald-500",
              "bg-amber-500",
              "bg-red-500",
              "bg-purple-600",
              "bg-slate-600",
            ][i] || "bg-blue-500";
            return `<button data-preset="${
              escapeHtml(name)
            }" class="presetBtn ${col} rounded-xl px-3 py-2 text-xs font-extrabold text-white shadow-lg" aria-label="Preset ${
              escapeHtml(name)
            }">${escapeHtml(name)}</button>`;
          }).join("");

          const toggle = (id, label, desc) => `
            <label class="flex items-center justify-between gap-3 rounded-2xl border border-slate-200/60 bg-white/70 p-3 dark:border-slate-700/60 dark:bg-slate-900/20">
              <div>
                <div class="text-sm font-extrabold">${
            escapeHtml(label)
          }</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">${
            escapeHtml(desc)
          }</div>
              </div>
              <input id="${id}" type="checkbox" class="h-5 w-5" aria-label="${
            escapeHtml(label)
          }"/>
            </label>
          `;

          const num = (id, label, desc, min, max, step) => `
            <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-3 dark:border-slate-700/60 dark:bg-slate-900/20">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-extrabold">${
            escapeHtml(label)
          }</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">${
            escapeHtml(desc)
          }</div>
                </div>
                <input id="${id}" type="number" min="${min}" max="${max}" step="${step}"
                  class="w-28 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-700"
                  aria-label="${escapeHtml(label)}"/>
              </div>
              <div id="${id}Err" class="mt-2 hidden text-xs font-semibold text-red-600" aria-live="polite"></div>
            </div>
          `;

          const section = (title, inner, open = true) => `
            <details class="rounded-2xl border border-slate-200/60 bg-white/50 p-3 dark:border-slate-700/60 dark:bg-slate-800/30" ${
            open ? "open" : ""
          }>
              <summary class="cursor-pointer select-none text-sm font-extrabold">${
            escapeHtml(title)
          } <span class="text-xs text-slate-500 dark:text-slate-400">(tap to toggle)</span></summary>
              <div class="mt-3 space-y-2">${inner}</div>
            </details>
          `;

          const body = `
            <div class="overflow-x-auto">
              <div class="flex w-max gap-2">${presetButtons}</div>
            </div>

            <div class="mt-4 space-y-3">
              ${
            section(
              "Reservoir Architecture",
              `
                ${
                num(
                  "cfg_reservoirSize",
                  "reservoirSize",
                  "Neurons in reservoir",
                  16,
                  4096,
                  1,
                )
              }
                ${
                num(
                  "cfg_spectralRadius",
                  "spectralRadius",
                  "Memory length control",
                  0.01,
                  2.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_leakRate",
                  "leakRate",
                  "Temporal smoothing",
                  0.0,
                  1.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_inputScale",
                  "inputScale",
                  "Input scaling factor",
                  0.0,
                  10.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_biasScale",
                  "biasScale",
                  "Bias scaling",
                  0.0,
                  10.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_reservoirSparsity",
                  "reservoirSparsity",
                  "Zero connections",
                  0.0,
                  1.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_inputSparsity",
                  "inputSparsity",
                  "Input sparsity",
                  0.0,
                  1.0,
                  0.01,
                )
              }
                <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-3 dark:border-slate-700/60 dark:bg-slate-900/20">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="text-sm font-extrabold">activation</div>
                      <div class="text-xs text-slate-500 dark:text-slate-400">Activation function</div>
                    </div>
                    <select id="cfg_activation" class="w-28 rounded-xl border border-slate-200 bg-white px-2 py-2 text-sm dark:border-slate-700 dark:bg-slate-700" aria-label="Activation">
                      <option value="tanh">tanh</option>
                      <option value="relu">relu</option>
                    </select>
                  </div>
                </div>
              `,
              true,
            )
          }

              ${
            section(
              "Readout Configuration",
              `
                ${
                toggle(
                  "cfg_useInputInReadout",
                  "useInputInReadout",
                  "Append input to state",
                )
              }
                ${
                toggle(
                  "cfg_useBiasInReadout",
                  "useBiasInReadout",
                  "Include bias term",
                )
              }
              `,
              false,
            )
          }

              ${
            section(
              "Training (RLS)",
              `
                <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-3 dark:border-slate-700/60 dark:bg-slate-900/20">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="text-sm font-extrabold">readoutTraining</div>
                      <div class="text-xs text-slate-500 dark:text-slate-400">RLS training</div>
                    </div>
                    <div class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-extrabold dark:bg-slate-700">rls</div>
                  </div>
                </div>
                ${
                num(
                  "cfg_rlsLambda",
                  "rlsLambda",
                  "Forgetting factor",
                  0.90,
                  0.99999,
                  0.0001,
                )
              }
                ${
                num(
                  "cfg_rlsDelta",
                  "rlsDelta",
                  "Initial P diagonal",
                  1e-6,
                  1000.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_epsilon",
                  "epsilon",
                  "Numerical stability",
                  1e-12,
                  1e-2,
                  1e-9,
                )
              }
                ${
                num(
                  "cfg_l2Lambda",
                  "l2Lambda",
                  "L2 regularization",
                  0.0,
                  1.0,
                  0.0001,
                )
              }
                ${
                num(
                  "cfg_gradientClipNorm",
                  "gradientClipNorm",
                  "Max update norm",
                  0.0,
                  100.0,
                  0.1,
                )
              }
              `,
              false,
            )
          }

              ${
            section(
              "Normalization",
              `
                ${
                num(
                  "cfg_normalizationEpsilon",
                  "normalizationEpsilon",
                  "Stability constant",
                  1e-12,
                  1e-2,
                  1e-9,
                )
              }
                ${
                num(
                  "cfg_normalizationWarmup",
                  "normalizationWarmup",
                  "Warmup samples",
                  0,
                  100000,
                  1,
                )
              }
              `,
              false,
            )
          }

              ${
            section(
              "Outlier Handling",
              `
                ${
                num(
                  "cfg_outlierThreshold",
                  "outlierThreshold",
                  "Z-score threshold",
                  0.1,
                  10.0,
                  0.1,
                )
              }
                ${
                num(
                  "cfg_outlierMinWeight",
                  "outlierMinWeight",
                  "Outlier min weight",
                  0.0,
                  1.0,
                  0.01,
                )
              }
              `,
              false,
            )
          }

              ${
            section(
              "Uncertainty",
              `
                ${
                num(
                  "cfg_uncertaintyMultiplier",
                  "uncertaintyMultiplier",
                  "CI Multiplier (1.96 = 95% CI)",
                  0.1,
                  10.0,
                  0.01,
                )
              }
              `,
              false,
            )
          }

              ${
            section(
              "Initialization",
              `
                ${
                num(
                  "cfg_weightInitScale",
                  "weightInitScale",
                  "Initial weight scale",
                  0.0,
                  10.0,
                  0.01,
                )
              }
                ${
                num(
                  "cfg_seed",
                  "seed",
                  "Random seed",
                  -2147483648,
                  2147483647,
                  1,
                )
              }
                ${toggle("cfg_verbose", "verbose", "Detailed logging")}
              `,
              false,
            )
          }
            </div>
          `;

          const footer = `
            <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
              <button id="cfgResetDefaults" class="rounded-xl bg-slate-200 px-3 py-2 text-sm font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100" aria-label="Reset defaults">Reset Defaults</button>
              <button id="cfgResetAll" class="rounded-xl bg-red-500 px-3 py-2 text-sm font-extrabold text-white" aria-label="Reset all">Reset All</button>
              <button id="cfgCancel" class="rounded-xl border border-slate-200 bg-white/70 px-3 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Cancel">Cancel</button>
              <button id="cfgCreate" class="rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 px-3 py-2 text-sm font-extrabold text-white shadow-lg shadow-blue-500/20" aria-label="Create model">Create Model</button>
            </div>
          `;

          openModal("Configuration", body, footer, {
            ariaLabel: "Configuration modal",
          });

          // populate values
          const setCfgInputs = () => {
            const c = state.config;
            $("cfg_reservoirSize").value = c.reservoirSize;
            $("cfg_spectralRadius").value = c.spectralRadius;
            $("cfg_leakRate").value = c.leakRate;
            $("cfg_inputScale").value = c.inputScale;
            $("cfg_biasScale").value = c.biasScale;
            $("cfg_reservoirSparsity").value = c.reservoirSparsity;
            $("cfg_inputSparsity").value = c.inputSparsity;
            $("cfg_activation").value = c.activation;

            $("cfg_useInputInReadout").checked = !!c.useInputInReadout;
            $("cfg_useBiasInReadout").checked = !!c.useBiasInReadout;

            $("cfg_rlsLambda").value = c.rlsLambda;
            $("cfg_rlsDelta").value = c.rlsDelta;
            $("cfg_epsilon").value = c.epsilon;
            $("cfg_l2Lambda").value = c.l2Lambda;
            $("cfg_gradientClipNorm").value = c.gradientClipNorm;

            $("cfg_normalizationEpsilon").value =
              c.normalizationEpsilon;
            $("cfg_normalizationWarmup").value = c.normalizationWarmup;

            $("cfg_outlierThreshold").value = c.outlierThreshold;
            $("cfg_outlierMinWeight").value = c.outlierMinWeight;

            $("cfg_uncertaintyMultiplier").value =
              c.uncertaintyMultiplier;

            $("cfg_weightInitScale").value = c.weightInitScale;
            $("cfg_seed").value = c.seed;
            $("cfg_verbose").checked = !!c.verbose;
          };

          const validateCfg = () => {
            let ok = true;
            const showErr = (id, msg) => {
              const e = $(id + "Err");
              if (!e) return;
              if (!msg) {
                e.classList.add("hidden");
                e.textContent = "";
              } else {
                e.classList.remove("hidden");
                e.textContent = msg;
                ok = false;
              }
            };

            const readNum = (id, name, min, max, int = false) => {
              const el = $(id);
              const v = Number(el.value);
              if (!Number.isFinite(v)) {
                showErr(id, `${name} must be a number.`);
                return null;
              }
              if (v < min || v > max) {
                showErr(id, `${name} must be in [${min}, ${max}].`);
                return null;
              }
              if (int && Math.floor(v) !== v) {
                showErr(id, `${name} must be an integer.`);
                return null;
              }
              showErr(id, "");
              return v;
            };

            const next = { ...state.config };
            next.reservoirSize = readNum(
              "cfg_reservoirSize",
              "reservoirSize",
              16,
              4096,
              true,
            );
            next.spectralRadius = readNum(
              "cfg_spectralRadius",
              "spectralRadius",
              0.01,
              2.0,
              false,
            );
            next.leakRate = readNum(
              "cfg_leakRate",
              "leakRate",
              0.0,
              1.0,
              false,
            );
            next.inputScale = readNum(
              "cfg_inputScale",
              "inputScale",
              0.0,
              10.0,
              false,
            );
            next.biasScale = readNum(
              "cfg_biasScale",
              "biasScale",
              0.0,
              10.0,
              false,
            );
            next.reservoirSparsity = readNum(
              "cfg_reservoirSparsity",
              "reservoirSparsity",
              0.0,
              1.0,
              false,
            );
            next.inputSparsity = readNum(
              "cfg_inputSparsity",
              "inputSparsity",
              0.0,
              1.0,
              false,
            );
            next.activation = $("cfg_activation").value;

            next.useInputInReadout = $("cfg_useInputInReadout").checked;
            next.useBiasInReadout = $("cfg_useBiasInReadout").checked;

            next.rlsLambda = readNum(
              "cfg_rlsLambda",
              "rlsLambda",
              0.90,
              0.99999,
              false,
            );
            next.rlsDelta = readNum(
              "cfg_rlsDelta",
              "rlsDelta",
              1e-6,
              1000.0,
              false,
            );
            next.epsilon = readNum(
              "cfg_epsilon",
              "epsilon",
              1e-12,
              1e-2,
              false,
            );
            next.l2Lambda = readNum(
              "cfg_l2Lambda",
              "l2Lambda",
              0.0,
              1.0,
              false,
            );
            next.gradientClipNorm = readNum(
              "cfg_gradientClipNorm",
              "gradientClipNorm",
              0.0,
              100.0,
              false,
            );

            next.normalizationEpsilon = readNum(
              "cfg_normalizationEpsilon",
              "normalizationEpsilon",
              1e-12,
              1e-2,
              false,
            );
            next.normalizationWarmup = readNum(
              "cfg_normalizationWarmup",
              "normalizationWarmup",
              0,
              100000,
              true,
            );

            next.outlierThreshold = readNum(
              "cfg_outlierThreshold",
              "outlierThreshold",
              0.1,
              10.0,
              false,
            );
            next.outlierMinWeight = readNum(
              "cfg_outlierMinWeight",
              "outlierMinWeight",
              0.0,
              1.0,
              false,
            );

            next.uncertaintyMultiplier = readNum(
              "cfg_uncertaintyMultiplier",
              "uncertaintyMultiplier",
              0.1,
              10.0,
              false,
            );

            next.weightInitScale = readNum(
              "cfg_weightInitScale",
              "weightInitScale",
              0.0,
              10.0,
              false,
            );
            next.seed = readNum(
              "cfg_seed",
              "seed",
              -2147483648,
              2147483647,
              true,
            );
            next.verbose = $("cfg_verbose").checked;

            if (ok) {
              state.config = next;
              savePrefs();
            }
            return ok;
          };

          setCfgInputs();

          // preset handlers
          document.querySelectorAll(".presetBtn").forEach((btn) => {
            btn.addEventListener("click", () => {
              try {
                const name = btn.getAttribute("data-preset");
                state.config = { ...PRESETS[name] };
                savePrefs();
                setCfgInputs();
                addLog("info", `Preset applied: ${name}`);
              } catch (err) {
                reportError("Preset apply failed", err);
              }
            });
          });

          // live validation on number inputs
          document.querySelectorAll(
            "#modalOverlay input[type=number], #modalOverlay select, #modalOverlay input[type=checkbox]",
          ).forEach((el) => {
            el.addEventListener("input", () => {
              try {
                validateCfg();
              } catch {}
            });
          });

          $("cfgResetDefaults").addEventListener("click", () => {
            try {
              state.config = { ...DEFAULT_CONFIG };
              savePrefs();
              setCfgInputs();
              addLog("warning", "Config reset to defaults.");
            } catch (err) {
              reportError("Reset defaults failed", err);
            }
          });

          $("cfgResetAll").addEventListener("click", async () => {
            try {
              closeModal();
              await resetApp();
              state.config = { ...DEFAULT_CONFIG };
              state.vizMode = "grid";
              savePrefs();
              renderTabs();
            } catch (err) {
              reportError("Reset all failed", err);
            }
          });

          $("cfgCancel").addEventListener("click", closeModal);

          $("cfgCreate").addEventListener("click", async () => {
            try {
              if (!validateCfg()) {
                toast("error", "Fix configuration errors first.");
                addLog("error", "Configuration validation failed.");
                return;
              }
              closeModal();
              await createModel();
            } catch (err) {
              reportError("Create from config failed", err);
            }
          });
        } catch (err) {
          reportError("Open config failed", err);
        }
      }

      // ---------- Upload Dataset Modal ----------
      function openUploadModal() {
        try {
          const body = `
            <div class="space-y-3">
              <div id="dropZone" class="rounded-2xl border-2 border-dashed border-slate-300 bg-white/60 p-6 text-center dark:border-slate-600 dark:bg-slate-900/20" aria-label="Drop zone">
                <div class="text-3xl" aria-hidden="true">üìÅ</div>
                <div class="mt-2 text-sm font-extrabold">Drop JSON file here or tap to browse</div>
                <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">Expected: {"coordinates": [[...],[...]]}</div>
                <input id="fileInput" type="file" accept=".json,application/json" class="hidden" aria-label="JSON file input"/>
              </div>

              <div>
                <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Paste JSON</label>
                <textarea id="jsonText" rows="8" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/30" aria-label="Paste JSON"></textarea>
              </div>

              <details class="rounded-2xl border border-slate-200/60 bg-white/50 p-3 dark:border-slate-700/60 dark:bg-slate-800/30">
                <summary class="cursor-pointer select-none text-sm font-extrabold">Format example <span class="text-xs text-slate-500 dark:text-slate-400">(tap)</span></summary>
                <div class="mt-3">
                  <pre id="formatExample" class="rounded-2xl bg-slate-900 p-3 text-xs text-slate-100 overflow-auto" aria-label="Format example"><code>{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
                  <button id="btnCopyExample" class="mt-2 rounded-xl bg-slate-200 px-3 py-2 text-xs font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100" aria-label="Copy example">üìã Copy example</button>
                </div>
              </details>

              <div id="validationBox" class="hidden rounded-2xl border border-emerald-300 bg-emerald-50 p-3 text-sm text-emerald-800 dark:border-emerald-600/50 dark:bg-emerald-500/10 dark:text-emerald-200" aria-live="polite"></div>
              <div id="errorBox" class="hidden rounded-2xl border border-red-300 bg-red-50 p-3 text-sm text-red-800 dark:border-red-600/50 dark:bg-red-500/10 dark:text-red-200" aria-live="polite"></div>
            </div>
          `;
          const footer = `
            <div class="grid grid-cols-3 gap-2">
              <button id="upCancel" class="rounded-xl border border-slate-200 bg-white/70 px-3 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Cancel">Cancel</button>
              <button id="upValidate" class="rounded-xl bg-slate-200 px-3 py-2 text-sm font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100" aria-label="Validate">Validate</button>
              <button id="upApplyTrain" class="rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 px-3 py-2 text-sm font-extrabold text-white shadow-lg shadow-blue-500/20 disabled:opacity-50" aria-label="Apply and train" disabled>Apply & Train</button>
            </div>
          `;
          openModal("Upload Dataset", body, footer, {
            ariaLabel: "Upload dataset modal",
          });

          const dropZone = $("dropZone");
          const fileInput = $("fileInput");
          const jsonText = $("jsonText");
          const validationBox = $("validationBox");
          const errorBox = $("errorBox");
          const btnApply = $("upApplyTrain");

          let validated = null;

          function showOk(msg) {
            validationBox.classList.remove("hidden");
            validationBox.textContent = msg;
            errorBox.classList.add("hidden");
            errorBox.textContent = "";
          }
          function showErr(msg) {
            errorBox.classList.remove("hidden");
            errorBox.textContent = msg;
            validationBox.classList.add("hidden");
            validationBox.textContent = "";
          }

          function validateCurrent() {
            validated = null;
            btnApply.disabled = true;

            const parsed = safeJSONParse(jsonText.value.trim());
            if (!parsed.ok) {
              showErr("Invalid JSON: " + parsed.error.message);
              return;
            }
            const v = validateDataset(parsed.value);
            if (!v.ok) {
              showErr(v.error);
              return;
            }
            validated = parsed.value;
            showOk(
              `‚úÖ Valid: ${v.dims} dimensions, ${v.steps} time steps`,
            );
            btnApply.disabled = false;
          }

          dropZone.addEventListener("click", () => fileInput.click());
          dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("bg-blue-50");
          });
          dropZone.addEventListener(
            "dragleave",
            () => dropZone.classList.remove("bg-blue-50"),
          );
          dropZone.addEventListener("drop", async (e) => {
            e.preventDefault();
            dropZone.classList.remove("bg-blue-50");
            try {
              const f = e.dataTransfer.files?.[0];
              if (!f) return;
              const txt = await f.text();
              jsonText.value = txt;
              validateCurrent();
            } catch (err) {
              showErr("File read failed: " + (err?.message || err));
            }
          });

          fileInput.addEventListener("change", async () => {
            try {
              const f = fileInput.files?.[0];
              if (!f) return;
              const txt = await f.text();
              jsonText.value = txt;
              validateCurrent();
            } catch (err) {
              showErr("File read failed: " + (err?.message || err));
            }
          });

          $("btnCopyExample").addEventListener("click", async () => {
            try {
              const example = $("formatExample").innerText;
              await navigator.clipboard.writeText(example);
              toast("success", "Example copied.");
            } catch (err) {
              reportError("Copy example failed", err);
            }
          });

          $("upCancel").addEventListener("click", closeModal);
          $("upValidate").addEventListener("click", () => {
            try {
              validateCurrent();
            } catch (err) {
              showErr(err.message);
            }
          });
          btnApply.addEventListener("click", async () => {
            try {
              validateCurrent();
              if (!validated) return;
              closeModal();
              await trainOnDataset(validated, "uploaded data");
            } catch (err) {
              reportError("Apply & Train failed", err);
            }
          });
        } catch (err) {
          reportError("Open upload failed", err);
        }
      }

      // ---------- Manual Insert Modal ----------
      function openManualInsertModal() {
        try {
          const body = `
            <div class="space-y-3">
              <div class="text-sm text-slate-600 dark:text-slate-300">
                Insert a JSON object with <span class="font-mono">coordinates</span>. If you already trained once, keep the same dimension count.
              </div>

              <button id="btnGenTemplate" class="w-full rounded-xl bg-amber-500 px-4 py-3 text-sm font-extrabold text-white shadow-lg shadow-amber-500/20" aria-label="Generate template">
                üß© Generate Template
              </button>

              <textarea id="manualJson" rows="10" class="w-full rounded-2xl border border-slate-200 bg-white px-3 py-3 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/30" aria-label="Manual JSON"></textarea>

              <div id="manualFeedback" class="hidden rounded-2xl p-3 text-sm" aria-live="polite"></div>
            </div>
          `;
          const footer = `
            <div class="grid grid-cols-2 gap-2">
              <button id="manCancel" class="rounded-xl border border-slate-200 bg-white/70 px-3 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Cancel">Cancel</button>
              <button id="manInsertTrain" class="rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 px-3 py-2 text-sm font-extrabold text-white shadow-lg shadow-amber-500/20" aria-label="Insert and train">Insert & Train</button>
            </div>
          `;
          openModal("Manual Insert", body, footer, {
            ariaLabel: "Manual insert modal",
          });

          const ta = $("manualJson");
          const fb = $("manualFeedback");

          function setFb(ok, msg) {
            fb.classList.remove("hidden");
            fb.className = "rounded-2xl p-3 text-sm " +
              (ok
                ? "border border-emerald-300 bg-emerald-50 text-emerald-800 dark:border-emerald-600/50 dark:bg-emerald-500/10 dark:text-emerald-200"
                : "border border-red-300 bg-red-50 text-red-800 dark:border-red-600/50 dark:bg-red-500/10 dark:text-red-200");
            fb.textContent = msg;
          }

          $("btnGenTemplate").addEventListener("click", () => {
            try {
              const dims = state.nDimensions > 0
                ? state.nDimensions
                : 3;
              const tmpl = {
                coordinates: [
                  Array.from({ length: dims }, () => 0.0),
                  Array.from({ length: dims }, () => 0.0),
                ],
              };
              ta.value = JSON.stringify(tmpl, null, 2);
              setFb(true, `Template generated for ${dims} dimensions.`);
            } catch (err) {
              setFb(false, err.message);
            }
          });

          $("manCancel").addEventListener("click", closeModal);
          $("manInsertTrain").addEventListener("click", async () => {
            try {
              const parsed = safeJSONParse(ta.value.trim());
              if (!parsed.ok) {
                setFb(false, "Invalid JSON: " + parsed.error.message);
                return;
              }
              const v = validateDataset(parsed.value);
              if (!v.ok) {
                setFb(false, v.error);
                return;
              }
              if (state.nDimensions && v.dims !== state.nDimensions) {
                setFb(
                  false,
                  `Dimension mismatch: expected ${state.nDimensions}, got ${v.dims}.`,
                );
                return;
              }
              closeModal();
              await trainOnDataset(parsed.value, "manual insert");
            } catch (err) {
              reportError("Manual insert failed", err);
            }
          });
        } catch (err) {
          reportError("Open manual insert failed", err);
        }
      }

      // ---------- Save & Load Modal ----------
      function getSavedModels() {
        try {
          return JSON.parse(
            localStorage.getItem(LS_KEYS.savedModels) || "[]",
          );
        } catch {
          return [];
        }
      }
      function setSavedModels(arr) {
        localStorage.setItem(LS_KEYS.savedModels, JSON.stringify(arr));
      }

      function openSaveLoadModal() {
        try {
          const body = `
            <div class="space-y-4">
              <div>
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Save</div>
                <div class="mt-2 grid grid-cols-1 gap-2 sm:grid-cols-2">
                  <button id="btnDownloadModel" class="rounded-xl bg-emerald-500 px-4 py-3 text-sm font-extrabold text-white shadow-lg shadow-emerald-500/20 disabled:opacity-50" aria-label="Download model">üì• Download</button>
                  <button id="btnSaveBrowser" class="rounded-xl bg-slate-200 px-4 py-3 text-sm font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100 disabled:opacity-50" aria-label="Save to browser">üíæ Browser</button>
                </div>
                <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">Saves include model state and current config.</div>
              </div>

              <div>
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Load</div>
                <div id="loadZone" class="mt-2 rounded-2xl border-2 border-dashed border-slate-300 bg-white/60 p-5 text-center dark:border-slate-600 dark:bg-slate-900/20" aria-label="Upload saved model">
                  <div class="text-2xl" aria-hidden="true">üì§</div>
                  <div class="mt-2 text-sm font-extrabold">Tap to upload saved model JSON</div>
                  <input id="modelFile" type="file" accept=".json,application/json" class="hidden" aria-label="Model JSON file"/>
                </div>

                <div class="mt-4">
                  <div class="flex items-center justify-between">
                    <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Saved in Browser</div>
                    <button id="btnClearSaved" class="text-xs font-extrabold text-red-600 dark:text-red-300" aria-label="Clear all saved models">Clear all saved models</button>
                  </div>
                  <div id="savedList" class="mt-2 space-y-2"></div>
                </div>
              </div>
            </div>
          `;
          const footer = `
            <div class="flex justify-end">
              <button id="slClose" class="rounded-xl border border-slate-200 bg-white/70 px-4 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Close">Close</button>
            </div>
          `;
          openModal("Save & Load", body, footer, {
            ariaLabel: "Save and load modal",
          });

          const hasModel = state.modelExists;
          $("btnDownloadModel").disabled = !hasModel;
          $("btnSaveBrowser").disabled = !hasModel;

          function renderSavedList() {
            const list = $("savedList");
            list.innerHTML = "";
            const saved = getSavedModels();
            if (!saved.length) {
              const empty = document.createElement("div");
              empty.className =
                "rounded-2xl border border-slate-200/60 bg-white/60 p-3 text-sm text-slate-600 dark:border-slate-700/60 dark:bg-slate-900/20 dark:text-slate-300";
              empty.textContent = "No saved models yet.";
              list.appendChild(empty);
              return;
            }
            for (const item of saved) {
              const row = document.createElement("div");
              row.className =
                "rounded-2xl border border-slate-200/60 bg-white/70 p-3 dark:border-slate-700/60 dark:bg-slate-900/20";
              row.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <div class="text-sm font-extrabold">${
                escapeHtml(item.name || "Unnamed")
              }</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">Dims: ${
                escapeHtml(String(item.nDimensions ?? "‚Äî"))
              } ‚Ä¢ Saved: ${escapeHtml(item.savedAt || "‚Äî")}</div>
                  </div>
                  <button class="btnLoadOne rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 px-3 py-2 text-xs font-extrabold text-white shadow-lg shadow-emerald-500/20" data-id="${
                escapeHtml(item.id)
              }" aria-label="Load saved model">Load</button>
                </div>
              `;
              list.appendChild(row);
            }
            list.querySelectorAll(".btnLoadOne").forEach((btn) => {
              btn.addEventListener("click", async () => {
                try {
                  const id = btn.getAttribute("data-id");
                  const saved = getSavedModels();
                  const item = saved.find((x) => x.id === id);
                  if (!item) throw new Error("Saved model not found.");
                  closeModal();
                  await loadFromStateObject(item.payload);
                } catch (err) {
                  reportError("Load saved model failed", err);
                }
              });
            });
          }

          async function saveStatePayload() {
            if (!state.modelExists) throw new Error("No model exists.");
            const modelState = await callEngine("save", {}, false);
            return {
              app: "ESN Regression Studio",
              version: 1,
              savedAt: new Date().toISOString(),
              config: state.config,
              modelState,
              predictions: state.predictions || null,
              nDimensions: state.nDimensions || null,
              sampleCount: state.sampleCount || null,
            };
          }

          $("btnDownloadModel").addEventListener("click", async () => {
            try {
              showLoading("Saving...", "Preparing download");
              const payload = await saveStatePayload();
              const blob = new Blob(
                [JSON.stringify(payload, null, 2)],
                { type: "application/json" },
              );
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "esn-studio-model.json";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
              addLog("success", "Model downloaded.");
              toast("success", "Downloaded.");
            } catch (err) {
              reportError("Download failed", err);
            } finally {
              hideLoading();
            }
          });

          $("btnSaveBrowser").addEventListener("click", async () => {
            try {
              const name = prompt("Name this saved model:");
              if (!name) return;
              showLoading("Saving...", "Writing to browser storage");
              const payload = await saveStatePayload();
              const saved = getSavedModels();
              saved.unshift({
                id: crypto?.randomUUID?.() || String(Date.now()),
                name,
                savedAt: nowTs(),
                nDimensions: payload.nDimensions,
                payload,
              });
              setSavedModels(saved.slice(0, 30));
              addLog("success", `Saved model: ${name}`);
              toast("success", "Saved to browser.");
              renderSavedList();
            } catch (err) {
              reportError("Browser save failed", err);
            } finally {
              hideLoading();
            }
          });

          async function loadFromStateObject(obj) {
            try {
              if (!obj?.modelState) {
                throw new Error("Invalid file: missing modelState.");
              }
              // apply config from file
              state.config = {
                ...DEFAULT_CONFIG,
                ...(obj.config || {}),
              };
              savePrefs();

              showLoading("Loading model...", "Restoring state");
              await callEngine("createModel", {
                moduleURL: state.moduleURL,
                config: state.config,
              }, false);
              await callEngine("load", {
                moduleURL: state.moduleURL,
                config: state.config,
                state: obj.modelState,
              }, false);

              state.modelExists = true;
              state.predictions = obj.predictions || null;
              state.nDimensions = obj.nDimensions ||
                (obj.predictions?.predictions?.[0]?.length ?? 0);
              state.sampleCount = obj.sampleCount || 0;

              addLog("success", "Model loaded.");
              toast("success", "Model loaded.");
              updateStatus();
              updatePanels();
              renderAfterPredictions();
            } catch (err) {
              reportError("Load failed", err);
            } finally {
              hideLoading();
            }
          }

          const loadZone = $("loadZone");
          const modelFile = $("modelFile");
          loadZone.addEventListener("click", () => modelFile.click());
          modelFile.addEventListener("change", async () => {
            try {
              const f = modelFile.files?.[0];
              if (!f) return;
              showLoading("Loading file...", "Reading JSON");
              const txt = await f.text();
              const parsed = safeJSONParse(txt);
              if (!parsed.ok) {
                throw new Error(
                  "Invalid JSON: " + parsed.error.message,
                );
              }
              closeModal();
              await loadFromStateObject(parsed.value);
            } catch (err) {
              reportError("Load file failed", err);
            } finally {
              hideLoading();
            }
          });

          $("btnClearSaved").addEventListener("click", () => {
            try {
              if (!confirm("Clear all saved models?")) return;
              setSavedModels([]);
              addLog("warning", "Cleared saved models.");
              toast("warning", "Cleared saved models.");
              renderSavedList();
            } catch (err) {
              reportError("Clear saved failed", err);
            }
          });

          $("slClose").addEventListener("click", closeModal);
          renderSavedList();
        } catch (err) {
          reportError("Open save/load failed", err);
        }
      }

      // ---------- Random Test Modal ----------
      function mulberry32(seed) {
        let t = seed >>> 0;
        return function () {
          t += 0x6D2B79F5;
          let r = Math.imul(t ^ (t >>> 15), 1 | t);
          r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
          return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
        };
      }

      function openRandomTestModal() {
        try {
          const body = `
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Seed</label>
                  <input id="rtSeed" type="number" value="42" step="1"
                    class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700"
                    aria-label="Random test seed"/>
                </div>
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Dimensions</label>
                  <input id="rtDims" type="number" value="3" min="1" step="1"
                    class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700"
                    aria-label="Random test dimensions"/>
                </div>
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Time Steps</label>
                  <input id="rtSteps" type="number" value="200" min="2" step="1"
                    class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700"
                    aria-label="Random test time steps"/>
                </div>
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Noise</label>
                  <input id="rtNoise" type="number" value="0.1" min="0" step="0.01"
                    class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700"
                    aria-label="Random test noise"/>
                </div>
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Outliers rate</label>
                  <input id="rtOutliers" type="number" value="0.02" min="0" max="1" step="0.01"
                    class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700"
                    aria-label="Random test outliers rate"/>
                </div>
                <div>
                  <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Difficulty</label>
                  <select id="rtDiff" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-700" aria-label="Random test difficulty">
                    <option>Easy</option>
                    <option selected>Medium</option>
                    <option>Hard</option>
                  </select>
                </div>
              </div>

              <div id="rtErr" class="hidden rounded-2xl border border-red-300 bg-red-50 p-3 text-sm text-red-800 dark:border-red-600/50 dark:bg-red-500/10 dark:text-red-200" aria-live="polite"></div>
            </div>
          `;
          const footer = `
            <div class="grid grid-cols-2 gap-2">
              <button id="rtCancel" class="rounded-xl border border-slate-200 bg-white/70 px-3 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Cancel">Cancel</button>
              <button id="rtRun" class="rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 px-3 py-2 text-sm font-extrabold text-white shadow-lg shadow-purple-500/20" aria-label="Generate and run">Generate & Run</button>
            </div>
          `;
          openModal("Random Test", body, footer, {
            ariaLabel: "Random test modal",
          });

          const errEl = $("rtErr");
          const showErr = (m) => {
            errEl.classList.remove("hidden");
            errEl.textContent = m;
          };

          $("rtCancel").addEventListener("click", closeModal);
          $("rtRun").addEventListener("click", async () => {
            try {
              errEl.classList.add("hidden");
              errEl.textContent = "";
              const seed = Number($("rtSeed").value);
              const dims = Number($("rtDims").value);
              const steps = Number($("rtSteps").value);
              const noise = Number($("rtNoise").value);
              const outRate = Number($("rtOutliers").value);
              const diff = $("rtDiff").value;

              if (
                !Number.isFinite(dims) || dims < 1 ||
                Math.floor(dims) !== dims
              ) {
                return showErr(
                  "Dimensions must be a positive integer.",
                );
              }
              if (
                !Number.isFinite(steps) || steps < 2 ||
                Math.floor(steps) !== steps
              ) return showErr("Time steps must be an integer ‚â• 2.");
              if (!Number.isFinite(noise) || noise < 0) {
                return showErr("Noise must be ‚â• 0.");
              }
              if (
                !Number.isFinite(outRate) || outRate < 0 || outRate > 1
              ) return showErr("Outliers rate must be in [0, 1].");

              const rng = mulberry32((seed || 0) >>> 0);
              const difficultyScale = diff === "Easy"
                ? 0.6
                : diff === "Hard"
                ? 1.6
                : 1.0;

              const coords = [];
              const phase = Array.from(
                { length: dims },
                () => rng() * Math.PI * 2,
              );
              for (let t = 0; t < steps; t++) {
                const row = [];
                for (let d = 0; d < dims; d++) {
                  const base = Math.sin(
                    (t / (18 + d * 3)) * difficultyScale + phase[d],
                  ) +
                    0.35 *
                      Math.sin(
                        (t / (7 + d)) * difficultyScale +
                          phase[d] * 0.7,
                      ) +
                    0.15 * Math.cos((t / (3 + d)) * difficultyScale);
                  let v = base + (rng() - 0.5) * 2 * noise;

                  // outliers
                  if (rng() < outRate) {
                    v += (rng() - 0.5) * 6 * difficultyScale;
                  }

                  row.push(Number(v.toFixed(6)));
                }
                coords.push(row);
              }

              const dataset = { coordinates: coords };
              closeModal();
              await trainOnDataset(dataset, `random test (${diff})`);
            } catch (err) {
              reportError("Random test failed", err);
            }
          });
        } catch (err) {
          reportError("Open random test failed", err);
        }
      }

      // ---------- Settings Modal ----------
      function openSettingsModal() {
        try {
          const body = `
            <div class="space-y-3">
              <div>
                <label class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Module URL</label>
                <input id="setModuleURL" type="text" value="${
            escapeHtml(state.moduleURL)
          }"
                  class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/30"
                  aria-label="Module URL"/>
                <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                  Default: <span class="font-mono">${
            escapeHtml(DEFAULT_MODULE_URL)
          }</span>
                </div>
              </div>

              <button id="btnReinitWorker" class="w-full rounded-xl bg-amber-500 px-4 py-3 text-sm font-extrabold text-white shadow-lg shadow-amber-500/20" aria-label="Reinitialize worker">
                üîÅ Reinitialize Worker
              </button>

              <button id="btnClearPrefs" class="w-full rounded-xl bg-red-500 px-4 py-3 text-sm font-extrabold text-white shadow-lg shadow-red-500/20" aria-label="Clear preferences">
                üßπ Clear All Preferences
              </button>
            </div>
          `;
          const footer = `
            <div class="flex justify-end">
              <button id="setClose" class="rounded-xl border border-slate-200 bg-white/70 px-4 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Close settings">Close</button>
            </div>
          `;
          openModal("Settings", body, footer, {
            ariaLabel: "Settings modal",
          });

          $("btnReinitWorker").addEventListener("click", async () => {
            try {
              const url = $("setModuleURL").value.trim();
              if (!url) throw new Error("Module URL is required.");
              state.moduleURL = url;
              savePrefs();

              showLoading("Reinitializing...", "Restarting worker");
              // terminate current worker if exists
              if (worker) {
                try {
                  worker.terminate();
                } catch {}
              }
              worker = null;
              state.workerHealthy = false;
              engineFallback = null;

              await initEngine();
              toast("success", "Engine reinitialized.");
              addLog("success", "Engine reinitialized.");
            } catch (err) {
              reportError("Reinitialize failed", err);
            } finally {
              hideLoading();
            }
          });

          $("btnClearPrefs").addEventListener("click", () => {
            try {
              if (
                !confirm(
                  "Clear all preferences (config, theme, viz mode, module URL)?",
                )
              ) return;
              localStorage.removeItem(LS_KEYS.config);
              localStorage.removeItem(LS_KEYS.vizMode);
              localStorage.removeItem(LS_KEYS.isDark);
              localStorage.removeItem(LS_KEYS.moduleURL);
              state.config = { ...DEFAULT_CONFIG };
              state.vizMode = "grid";
              state.isDark = false;
              state.moduleURL = DEFAULT_MODULE_URL;
              applyTheme();
              renderTabs();
              addLog("warning", "Preferences cleared.");
              toast("warning", "Preferences cleared.");
            } catch (err) {
              reportError("Clear prefs failed", err);
            }
          });

          $("setClose").addEventListener("click", () => {
            try {
              const url = $("setModuleURL").value.trim();
              if (url) {
                state.moduleURL = url;
                savePrefs();
              }
              closeModal();
            } catch (err) {
              reportError("Close settings failed", err);
            }
          });
        } catch (err) {
          reportError("Open settings failed", err);
        }
      }

      // ---------- Data Table Modal ----------
      function openDataTableModal() {
        try {
          const data = getPredData();
          if (!data) {
            toast("warning", "No predictions to show.");
            return;
          }

          const dims = data.dims;
          const steps = data.steps;

          const body = `
            <div class="space-y-3">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="text-sm font-extrabold">Predictions Table</div>
                <div class="flex gap-2">
                  <button id="btnExportCSV" class="rounded-xl bg-slate-200 px-3 py-2 text-xs font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100" aria-label="Export CSV">üìä Export CSV</button>
                  <button id="btnCopyAll" class="rounded-xl bg-slate-200 px-3 py-2 text-xs font-extrabold text-slate-900 dark:bg-slate-700 dark:text-slate-100" aria-label="Copy all">üìã Copy All</button>
                </div>
              </div>
              <input id="dtSearch" type="text" placeholder="Search (step or value)..."
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:border-slate-700 dark:bg-slate-700"
                aria-label="Search table" />

              <div class="h-[62vh] overflow-auto rounded-2xl border border-slate-200/60 dark:border-slate-700/60">
                <table class="w-full text-xs font-mono">
                  <thead class="sticky top-0 bg-white dark:bg-slate-900/80">
                    <tr id="dtHeadRow" class="border-b border-slate-200 dark:border-slate-700"></tr>
                  </thead>
                  <tbody id="dtBody"></tbody>
                </table>
              </div>
              <div class="text-xs text-slate-500 dark:text-slate-400">Tip: click headers to sort.</div>
            </div>
          `;

          const footer = `
            <div class="flex justify-end">
              <button id="dtClose" class="rounded-xl border border-slate-200 bg-white/70 px-4 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Close table">Close</button>
            </div>
          `;

          openModal("Data Table", body, footer, {
            ariaLabel: "Data table modal",
          });

          let sortKey = "step";
          let sortDir = 1;

          function buildColumns() {
            const cols = ["Step"];
            for (let d = 0; d < dims; d++) cols.push(`P${d + 1}`);
            for (let d = 0; d < dims; d++) cols.push(`L${d + 1}`);
            for (let d = 0; d < dims; d++) cols.push(`U${d + 1}`);
            return cols;
          }

          const cols = buildColumns();
          const head = $("dtHeadRow");
          head.innerHTML = "";
          cols.forEach((c, idx) => {
            const th = document.createElement("th");
            th.className =
              "px-3 py-2 text-left font-extrabold cursor-pointer select-none";
            th.textContent = c +
              (keyFromCol(c) === sortKey
                ? (sortDir === 1 ? " ‚Üë" : " ‚Üì")
                : "");
            th.setAttribute("aria-label", "Sort by " + c);
            th.addEventListener("click", () => {
              try {
                const k = keyFromCol(c);
                if (sortKey === k) sortDir *= -1;
                else {
                  sortKey = k;
                  sortDir = 1;
                }
                render();
              } catch (err) {
                reportError("Sort failed", err);
              }
            });
            head.appendChild(th);
          });

          function keyFromCol(c) {
            if (c === "Step") return "step";
            return c;
          }

          function rowObject(step) {
            const obj = { step };
            for (let d = 0; d < dims; d++) {
              obj[`P${d + 1}`] = data.P[step][d];
            }
            for (let d = 0; d < dims; d++) {
              obj[`L${d + 1}`] = data.L
                ? data.L[step][d]
                : data.P[step][d];
            }
            for (let d = 0; d < dims; d++) {
              obj[`U${d + 1}`] = data.U
                ? data.U[step][d]
                : data.P[step][d];
            }
            return obj;
          }

          function render() {
            const q = $("dtSearch").value.trim().toLowerCase();
            const rows = [];
            for (let s = 0; s < steps; s++) rows.push(rowObject(s));

            let filtered = rows;
            if (q) {
              filtered = rows.filter((r) => {
                if (String(r.step).includes(q)) return true;
                return Object.keys(r).some((k) =>
                  k !== "step" && String(r[k]).toLowerCase().includes(q)
                );
              });
            }

            filtered.sort((a, b) => {
              const va = a[sortKey], vb = b[sortKey];
              if (sortKey === "step") return (va - vb) * sortDir;
              if (typeof va === "number" && typeof vb === "number") {
                return (va - vb) * sortDir;
              }
              return String(va).localeCompare(String(vb)) * sortDir;
            });

            // refresh header arrows
            head.querySelectorAll("th").forEach((th, idx) => {
              const c = cols[idx];
              th.textContent = c +
                (keyFromCol(c) === sortKey
                  ? (sortDir === 1 ? " ‚Üë" : " ‚Üì")
                  : "");
            });

            const body = $("dtBody");
            body.innerHTML = "";
            filtered.slice(0, 2000).forEach((r, i) => {
              const tr = document.createElement("tr");
              tr.className = (i % 2 === 0
                ? "bg-slate-50 dark:bg-slate-800/40"
                : "bg-white dark:bg-slate-900/30") +
                " border-b border-slate-200/50 dark:border-slate-700/50 hover:bg-blue-50/60 dark:hover:bg-blue-500/10";
              const tds = [];
              tds.push(
                `<td class="px-3 py-2 font-extrabold tabular-nums">${r.step}</td>`,
              );
              for (let d = 0; d < dims; d++) {
                tds.push(
                  `<td class="px-3 py-2 tabular-nums">${
                    fmtExp(r[`P${d + 1}`])
                  }</td>`,
                );
              }
              for (let d = 0; d < dims; d++) {
                tds.push(
                  `<td class="px-3 py-2 tabular-nums">${
                    fmtExp(r[`L${d + 1}`])
                  }</td>`,
                );
              }
              for (let d = 0; d < dims; d++) {
                tds.push(
                  `<td class="px-3 py-2 tabular-nums">${
                    fmtExp(r[`U${d + 1}`])
                  }</td>`,
                );
              }
              tr.innerHTML = tds.join("");
              body.appendChild(tr);
            });
          }

          function toCSV() {
            const header = cols.join(",");
            const lines = [header];
            for (let s = 0; s < steps; s++) {
              const r = rowObject(s);
              const row = [];
              row.push(String(r.step));
              for (let d = 0; d < dims; d++) {
                row.push(String(r[`P${d + 1}`]));
              }
              for (let d = 0; d < dims; d++) {
                row.push(String(r[`L${d + 1}`]));
              }
              for (let d = 0; d < dims; d++) {
                row.push(String(r[`U${d + 1}`]));
              }
              lines.push(row.join(","));
            }
            return lines.join("\n");
          }

          $("dtSearch").addEventListener("input", () => {
            try {
              render();
            } catch {}
          });

          $("btnExportCSV").addEventListener("click", () => {
            try {
              const csv = toCSV();
              const blob = new Blob([csv], { type: "text/csv" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "esn-studio.csv";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
              addLog("success", "CSV exported.");
            } catch (err) {
              reportError("CSV export failed", err);
            }
          });

          $("btnCopyAll").addEventListener("click", async () => {
            try {
              const csv = toCSV();
              await navigator.clipboard.writeText(csv);
              toast("success", "Copied table data.");
              addLog("success", "Copied table to clipboard.");
            } catch (err) {
              reportError("Copy all failed", err);
            }
          });

          $("dtClose").addEventListener("click", closeModal);
          render();
        } catch (err) {
          reportError("Open data table failed", err);
        }
      }

      // ---------- Help Modal ----------
      function openHelpModal() {
        try {
          const body = `
            <div class="space-y-4 text-sm text-slate-700 dark:text-slate-200">
              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Worker Setup</div>
                <pre class="mt-2 overflow-auto rounded-2xl bg-slate-900 p-3 text-xs text-slate-100"><code>The ESNRegression library runs in a Web Worker for non-blocking performance.
Module URL: ${escapeHtml(DEFAULT_MODULE_URL)}</code></pre>
              </div>

              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Creating a Model</div>
                <pre class="mt-2 overflow-auto rounded-2xl bg-slate-900 p-3 text-xs text-slate-100"><code>const model = new ESNRegression(config);</code></pre>
              </div>

              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Online Training (fitOnline)</div>
                <pre class="mt-2 overflow-auto rounded-2xl bg-slate-900 p-3 text-xs text-slate-100"><code>model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call (t, t+1), (t+2, t+3)...
// Returns: { averageLoss, gradientNorm, sampleWeight }</code></pre>
              </div>

              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Prediction</div>
                <pre class="mt-2 overflow-auto rounded-2xl bg-slate-900 p-3 text-xs text-slate-100"><code>const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }</code></pre>
              </div>

              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Save/Load</div>
                <pre class="mt-2 overflow-auto rounded-2xl bg-slate-900 p-3 text-xs text-slate-100"><code>const state = model.save();
model.load(state);</code></pre>
              </div>

              <div class="rounded-2xl border border-slate-200/60 bg-white/70 p-4 dark:border-slate-700/60 dark:bg-slate-900/20">
                <div class="text-xs font-extrabold uppercase tracking-widest text-slate-500 dark:text-slate-400">Presets</div>
                <ul class="mt-2 list-disc pl-5 text-sm text-slate-700 dark:text-slate-200">
                  <li>Start Here/Default: reservoirSize=256, spectralRadius=0.9, leakRate=0.3</li>
                  <li>Fast: reservoirSize=64, reservoirSparsity=0.95</li>
                  <li>Balanced: reservoirSize=256, spectralRadius=0.9</li>
                  <li>Accurate: reservoirSize=512, spectralRadius=0.95, leakRate=0.2</li>
                  <li>Adaptive: rlsLambda=0.97, spectralRadius=0.85, leakRate=0.5</li>
                  <li>Robust: outlierThreshold=2.0, outlierMinWeight=0.05, l2Lambda=0.01, leakRate=0.2</li>
                </ul>
              </div>
            </div>
          `;
          const footer = `
            <div class="flex justify-end">
              <button id="helpClose" class="rounded-xl border border-slate-200 bg-white/70 px-4 py-2 text-sm font-extrabold dark:border-slate-700 dark:bg-slate-800/50" aria-label="Close help">Close</button>
            </div>
          `;
          openModal("Help", body, footer, { ariaLabel: "Help modal" });
          $("helpClose").addEventListener("click", closeModal);
        } catch (err) {
          reportError("Open help failed", err);
        }
      }

      // ---------- Menu ----------
      function openMenu() {
        $("menuOverlay").classList.remove("hidden");
        $("menuOverlay").setAttribute("aria-hidden", "false");
        lastFocused = document.activeElement;
        setTimeout(() => $("btnCloseMenu").focus(), 0);
      }
      function closeMenu() {
        $("menuOverlay").classList.add("hidden");
        $("menuOverlay").setAttribute("aria-hidden", "true");
        if (lastFocused && typeof lastFocused.focus === "function") {
          lastFocused.focus();
        }
      }

      // ---------- Wire up ----------
      function wireUI() {
        // Tabs
        document.querySelectorAll(".tabBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            try {
              setMode(btn.dataset.mode);
            } catch (err) {
              reportError("Set mode failed", err);
            }
          });
        });

        // Theme
        $("btnTheme").addEventListener("click", () => {
          try {
            state.isDark = !state.isDark;
            applyTheme();
            renderCanvas();
          } catch (err) {
            reportError("Theme toggle failed", err);
          }
        });

        // Header
        $("btnConfig").addEventListener("click", openConfigModal);
        $("btnMenu").addEventListener("click", openMenu);
        $("btnPredict").addEventListener(
          "click",
          () => runPrediction(),
        );
        $("btnPredictTop").addEventListener(
          "click",
          () => runPrediction(),
        );
        $("btnSummary").addEventListener("click", getSummary);

        // Menu overlay
        $("menuBackdrop").addEventListener("click", closeMenu);
        $("btnCloseMenu").addEventListener("click", closeMenu);

        $("menuCreateConfig").addEventListener("click", () => {
          try {
            closeMenu();
            openConfigModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuSaveLoad").addEventListener("click", () => {
          try {
            closeMenu();
            openSaveLoadModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuUpload").addEventListener("click", () => {
          try {
            closeMenu();
            openUploadModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuManualInsert").addEventListener("click", () => {
          try {
            closeMenu();
            openManualInsertModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuRandomTest").addEventListener("click", () => {
          try {
            closeMenu();
            openRandomTestModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuSettings").addEventListener("click", () => {
          try {
            closeMenu();
            openSettingsModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuDataTable").addEventListener("click", () => {
          try {
            closeMenu();
            openDataTableModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuHelp").addEventListener("click", () => {
          try {
            closeMenu();
            openHelpModal();
          } catch (e) {
            reportError("Menu action failed", e);
          }
        });
        $("menuReset").addEventListener("click", async () => {
          try {
            closeMenu();
            await resetApp();
          } catch (e) {
            reportError("Menu reset failed", e);
          }
        });

        // Empty state actions
        $("btnStartDefaults").addEventListener("click", async () => {
          try {
            state.config = { ...DEFAULT_CONFIG };
            savePrefs();
            await createModel();
            toast(
              "info",
              "Model created. Upload data or run Demo/Random Test to train.",
            );
          } catch (err) {
            reportError("Start defaults failed", err);
          }
        });

        $("btnLoadFromEmpty").addEventListener("click", () => {
          try {
            openSaveLoadModal();
          } catch (err) {
            reportError("Open load failed", err);
          }
        });

        $("btnDemo").addEventListener("click", async () => {
          try {
            // quick demo: random medium, 3 dims, 220 steps
            const rng = mulberry32(12345);
            const dims = 3, steps = 220;
            const coords = [];
            for (let t = 0; t < steps; t++) {
              coords.push([
                Math.sin(t / 12) + (rng() - 0.5) * 0.15,
                Math.cos(t / 16) + (rng() - 0.5) * 0.15,
                Math.sin(t / 9) * 0.6 + Math.cos(t / 21) * 0.4 +
                (rng() - 0.5) * 0.15,
              ].map((x) => Number(x.toFixed(6))));
            }
            state.config = { ...PRESETS["Balanced"] };
            savePrefs();
            await trainOnDataset({ coordinates: coords }, "demo");
          } catch (err) {
            reportError("Demo failed", err);
          }
        });

        // Logs
        $("logFilter").addEventListener("change", renderLogs);
        $("logSearch").addEventListener("input", renderLogs);

        // Future steps validation
        $("futureSteps").addEventListener("input", () => {
          try {
            validateFutureSteps();
          } catch {}
        });

        // Snapshot step
        $("snapshotStep").addEventListener("input", () => {
          try {
            const data = getPredData();
            if (!data) return;
            const v = Number($("snapshotStep").value);
            if (!Number.isFinite(v) || Math.floor(v) !== v) return;
            state.selectedStep = clamp(v, 0, data.steps - 1);
            renderCanvas();
          } catch (err) {
            reportError("Snapshot step failed", err);
          }
        });

        // Loading cancel
        $("btnCancelOp").addEventListener("click", cancelLastOp);

        // Export
        $("btnSavePNG").addEventListener("click", exportPNG);
        $("btnSaveSVG").addEventListener("click", exportSVG);
        $("btnCopy").addEventListener("click", copyToClipboard);

        // Zoom
        $("btnZoomIn").addEventListener("click", zoomIn);
        $("btnZoomOut").addEventListener("click", zoomOut);
        $("btnZoomReset").addEventListener("click", zoomReset);

        attachCanvasInteractions();

        window.addEventListener("resize", () => {
          try {
            renderCanvas();
          } catch {}
        });
      }

      // ---------- Boot ----------
      (async function boot() {
        loadPrefs();
        applyTheme();
        renderTabs();
        renderLogs();

        updateStatus();
        updatePanels();
        renderAfterPredictions();

        wireUI();

        addLog("info", "Initializing engine...");
        try {
          await initEngine();
        } catch (err) {
          reportError("Engine init failed", err);
        }
      })();
    </script>
  </body>
</html>
