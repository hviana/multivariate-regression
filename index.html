<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    >
    <title>ESN Regression Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwindcss.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "system-ui",
                "-apple-system",
                "BlinkMacSystemFont",
                "Segoe UI",
                "sans-serif",
              ],
            },
          },
        },
      };
    </script>
    <style>
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-50 backdrop-blur-xl bg-white/80 dark:bg-slate-900/80 border-b border-slate-200/50 dark:border-slate-700/50 px-4 py-3"
    >
      <div class="flex items-center justify-between max-w-7xl mx-auto">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/30"
          >
            <span class="text-xl">üìä</span>
          </div>
          <div>
            <h1 class="font-bold text-lg leading-tight">ESN Studio</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400">
              Autoregressive Forecasting
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div
            id="modelStatus"
            class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800 text-sm"
          >
            <span
              id="statusDot"
              class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"
            ></span>
            <span id="statusText" class="text-slate-600 dark:text-slate-400"
            >No Model</span>
          </div>
          <button
            id="predictBtn"
            class="hidden px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-shadow"
            aria-label="Run prediction"
          >
            ‚ö° Predict
          </button>
          <button
            id="configBtn"
            class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-xl transition-colors"
            aria-label="Configure model"
          >
            ‚öôÔ∏è
          </button>
          <button
            id="menuBtn"
            class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-xl transition-colors"
            aria-label="Open menu"
          >
            ‚ò∞
          </button>
          <button
            id="themeBtn"
            class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-xl transition-colors"
            aria-label="Toggle theme"
          >
            <span class="dark:hidden">üåô</span>
            <span class="hidden dark:inline">‚òÄÔ∏è</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-col lg:flex-row gap-4 p-4 max-w-7xl mx-auto">
      <!-- Visualization Area -->
      <div class="flex-1 flex flex-col gap-4">
        <!-- Tab Navigation -->
        <div
          class="flex overflow-x-auto scrollbar-hide gap-2 pb-2"
          role="tablist"
        >
          <button
            data-mode="grid"
            class="viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all"
            role="tab"
            aria-selected="true"
          >
            üìä Grid
          </button>
          <button
            data-mode="focus"
            class="viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all"
            role="tab"
            aria-selected="false"
          >
            üîç Focus
          </button>
          <button
            data-mode="heatmap"
            class="viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all"
            role="tab"
            aria-selected="false"
          >
            üå°Ô∏è Heatmap
          </button>
          <button
            data-mode="uncertainty"
            class="viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all"
            role="tab"
            aria-selected="false"
          >
            üìà CI
          </button>
          <button
            data-mode="snapshot"
            class="viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all"
            role="tab"
            aria-selected="false"
          >
            üì∑ Snapshot
          </button>
        </div>

        <!-- Chart Container -->
        <div
          id="chartContainer"
          class="relative bg-white dark:bg-slate-800/80 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
          style="min-height: 400px"
        >
          <!-- Zoom Controls -->
          <div
            id="zoomControls"
            class="hidden absolute top-3 right-3 z-10 flex gap-1"
          >
            <button
              id="zoomInBtn"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
              aria-label="Zoom in"
            >
              ‚ûï
            </button>
            <button
              id="zoomOutBtn"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
              aria-label="Zoom out"
            >
              ‚ûñ
            </button>
            <button
              id="zoomResetBtn"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors"
              aria-label="Reset zoom"
            >
              üîÑ
            </button>
          </div>
          <div
            id="zoomBadge"
            class="hidden absolute top-3 left-3 z-10 px-2 py-1 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md text-xs font-medium"
          >
            100%
          </div>

          <!-- Export Controls -->
          <div
            id="exportControls"
            class="hidden absolute bottom-3 right-3 z-10 flex gap-1"
          >
            <button
              id="exportPng"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors text-sm"
              aria-label="Save as PNG"
            >
              üñºÔ∏è
            </button>
            <button
              id="exportSvg"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors text-sm"
              aria-label="Save as SVG"
            >
              üìÑ
            </button>
            <button
              id="exportClip"
              class="w-8 h-8 rounded-lg bg-white/90 dark:bg-slate-700/90 shadow-md flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors text-sm"
              aria-label="Copy to clipboard"
            >
              üìã
            </button>
          </div>

          <!-- Canvas -->
          <canvas id="vizCanvas" class="w-full h-full"></canvas>

          <!-- Tooltip -->
          <div
            id="tooltip"
            class="hidden absolute z-20 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 p-3 pointer-events-none min-w-48"
          >
            <div class="text-lg font-bold" id="tooltipStep">Step 0</div>
            <div class="flex items-center gap-2 mt-1">
              <span id="tooltipDot" class="w-3 h-3 rounded-full"></span>
              <span
                id="tooltipDim"
                class="text-sm text-slate-600 dark:text-slate-400"
              >Dimension 1</span>
            </div>
            <div class="mt-2 text-xl font-bold" id="tooltipValue">0.000</div>
            <div
              class="text-sm text-slate-500 dark:text-slate-400"
              id="tooltipCI"
            >
              CI: 0.00 - 0.00
            </div>
            <div class="text-xs text-slate-400 mt-1" id="tooltipSpread">
              Spread: 0.00
            </div>
          </div>

          <!-- Empty State -->
          <div
            id="emptyState"
            class="absolute inset-0 flex items-center justify-center"
          >
            <div class="text-center p-8">
              <div class="relative inline-block mb-6">
                <div
                  class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 rounded-3xl blur-xl"
                >
                </div>
                <div
                  class="relative w-24 h-24 bg-gradient-to-br from-blue-500/10 to-purple-600/10 dark:from-blue-500/20 dark:to-purple-600/20 rounded-3xl flex items-center justify-center"
                >
                  <span class="text-5xl">üìä</span>
                </div>
              </div>
              <h2 class="text-2xl font-bold mb-2">Create a Model to Begin</h2>
              <p
                class="text-slate-500 dark:text-slate-400 mb-6 max-w-sm mx-auto"
              >
                ESN autoregressive forecasting enables multivariate time series
                prediction with uncertainty estimation
              </p>
              <div class="flex flex-wrap gap-3 justify-center">
                <button
                  id="quickStartBtn"
                  class="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-shadow"
                >
                  ‚ö° Start with Defaults
                </button>
                <button
                  id="loadBtnEmpty"
                  class="px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                  üì§ Load
                </button>
                <button
                  id="demoBtn"
                  class="px-6 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 text-white font-medium shadow-lg shadow-purple-500/25 hover:shadow-purple-500/40 transition-shadow"
                >
                  ‚ú® Demo
                </button>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div
            id="loadingState"
            class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-30"
          >
            <div class="text-center p-8">
              <div
                class="w-16 h-16 border-4 border-slate-200 dark:border-slate-700 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"
              >
              </div>
              <p id="loadingText" class="font-medium mb-4">Processing...</p>
              <div
                class="w-64 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mb-4"
              >
                <div
                  id="progressBar"
                  class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300"
                  style="width: 0%"
                >
                </div>
              </div>
              <span id="progressText" class="text-sm text-slate-500">0%</span>
              <button
                id="cancelBtn"
                class="mt-4 block mx-auto px-4 py-2 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- Mode-Specific Controls -->
        <div
          id="dimensionSelector"
          class="hidden overflow-x-auto scrollbar-hide"
        >
          <div class="flex gap-2 pb-2" id="dimButtons"></div>
        </div>

        <div id="stepSelector" class="hidden flex items-center gap-3">
          <span class="text-sm font-medium">Step:</span>
          <input
            type="number"
            id="stepInput"
            min="0"
            value="0"
            class="w-24 px-3 py-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
          >
        </div>

        <!-- Statistics Bar (Focus Mode) -->
        <div id="statsBar" class="hidden grid grid-cols-3 sm:grid-cols-6 gap-3">
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Min
            </div>
            <div class="font-bold" id="statMin">-</div>
          </div>
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Max
            </div>
            <div class="font-bold" id="statMax">-</div>
          </div>
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Mean
            </div>
            <div class="font-bold" id="statMean">-</div>
          </div>
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Final
            </div>
            <div class="font-bold" id="statFinal">-</div>
          </div>
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Trend
            </div>
            <div class="font-bold" id="statTrend">-</div>
          </div>
          <div
            class="bg-white/60 dark:bg-slate-800/60 backdrop-blur rounded-xl p-3 text-center"
          >
            <div
              class="text-xs uppercase text-slate-500 dark:text-slate-400 mb-1"
            >
              Confidence
            </div>
            <div class="font-bold" id="statConf">-</div>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <aside class="w-full lg:w-80 flex flex-col gap-4">
        <!-- Model Metrics -->
        <div
          class="bg-white dark:bg-slate-800/80 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-4"
        >
          <h3
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3"
          >
            Model Metrics
          </h3>
          <div class="space-y-2">
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Samples Trained</span>
              <span id="metricSamples" class="font-bold text-blue-500">0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Avg Loss</span>
              <span id="metricLoss" class="font-mono text-sm">0.00e+0</span>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50"
            >
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Gradient Norm</span>
              <span id="metricGradient" class="font-mono text-sm">0.00e+0</span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-sm text-slate-600 dark:text-slate-400"
              >Sample Weight</span>
              <span id="metricWeight" class="font-mono text-sm">0.000</span>
            </div>
          </div>
        </div>

        <!-- Prediction -->
        <div
          class="bg-white dark:bg-slate-800/80 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-4"
        >
          <h3
            class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3"
          >
            Prediction
          </h3>
          <div class="flex gap-2">
            <div class="flex-1">
              <label
                class="text-xs text-slate-500 dark:text-slate-400 mb-1 block"
              >Future Steps</label>
              <input
                type="number"
                id="futureSteps"
                value="50"
                min="1"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
              >
            </div>
            <button
              id="runPredictBtn"
              disabled
              class="self-end px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium shadow-lg shadow-blue-500/25 disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed hover:shadow-blue-500/40 transition-all"
            >
              Run
            </button>
          </div>
        </div>

        <!-- Event Log -->
        <div
          class="bg-white dark:bg-slate-800/80 rounded-2xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 p-4 flex-1 min-h-64 flex flex-col"
        >
          <div class="flex items-center justify-between mb-3">
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400"
            >
              Event Log
            </h3>
            <select
              id="logFilter"
              class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 border-0 focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All</option>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>
          <input
            type="text"
            id="logSearch"
            placeholder="Search logs..."
            class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm mb-3"
          >
          <div
            id="logContainer"
            class="flex-1 overflow-y-auto space-y-2 text-sm"
          >
          </div>
        </div>
      </aside>
    </main>

    <!-- Slide-Out Menu -->
    <div id="menuOverlay" class="hidden fixed inset-0 bg-black/50 z-50"></div>
    <div
      id="menuPanel"
      class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-slate-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto"
    >
      <div class="p-4">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Menu</h2>
          <button
            id="closeMenu"
            class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
            aria-label="Close menu"
          >
            ‚úï
          </button>
        </div>

        <div class="space-y-6">
          <div>
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
            >
              üìÅ Model
            </h3>
            <div class="space-y-2">
              <button
                id="menuConfig"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-xl"
                >üéõÔ∏è</span>
                <div>
                  <div class="font-medium">Create & Configure</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Set up model parameters
                  </div>
                </div>
              </button>
              <button
                id="menuSaveLoad"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-xl"
                >üíæ</span>
                <div>
                  <div class="font-medium">Save & Load</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Persist your models
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div>
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
            >
              üìÇ Data
            </h3>
            <div class="space-y-2">
              <button
                id="menuUpload"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-xl"
                >üì§</span>
                <div>
                  <div class="font-medium">Upload Dataset</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Import time series data
                  </div>
                </div>
              </button>
              <button
                id="menuManual"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-xl"
                >‚ûï</span>
                <div>
                  <div class="font-medium">Manual Insert</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Add individual time steps
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div>
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
            >
              üß™ Test
            </h3>
            <div class="space-y-2">
              <button
                id="menuRandom"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center text-xl"
                >üí°</span>
                <div>
                  <div class="font-medium">Random Test</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Generate synthetic time series
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div>
            <h3
              class="text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"
            >
              ‚öôÔ∏è Advanced
            </h3>
            <div class="space-y-2">
              <button
                id="menuSettings"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
                >üîß</span>
                <div>
                  <div class="font-medium">Settings</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Module URL & preferences
                  </div>
                </div>
              </button>
              <button
                id="menuDataTable"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
                >üìã</span>
                <div>
                  <div class="font-medium">View Data Table</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Raw prediction values
                  </div>
                </div>
              </button>
              <button
                id="menuHelp"
                class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-left"
              >
                <span
                  class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xl"
                >‚ùì</span>
                <div>
                  <div class="font-medium">Help</div>
                  <div class="text-xs text-slate-500 dark:text-slate-400">
                    Documentation & API
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed bottom-4 left-4 right-4 z-50 flex flex-col gap-2 items-center pointer-events-none"
    >
    </div>

    <!-- Configuration Modal -->
    <div
      id="configModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
      aria-labelledby="configTitle"
    >
      <div class="absolute inset-0 bg-black/50" id="configOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 id="configTitle" class="text-xl font-bold">
            Model Configuration
          </h2>
        </div>

        <!-- Presets -->
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 overflow-x-auto"
        >
          <div class="flex gap-2">
            <button
              data-preset="default"
              class="preset-btn px-4 py-2 rounded-xl bg-blue-500 text-white font-medium text-sm whitespace-nowrap"
            >
              Start Here
            </button>
            <button
              data-preset="fast"
              class="preset-btn px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm whitespace-nowrap"
            >
              Fast
            </button>
            <button
              data-preset="balanced"
              class="preset-btn px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm whitespace-nowrap"
            >
              Balanced
            </button>
            <button
              data-preset="accurate"
              class="preset-btn px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm whitespace-nowrap"
            >
              Accurate
            </button>
            <button
              data-preset="adaptive"
              class="preset-btn px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm whitespace-nowrap"
            >
              Adaptive
            </button>
            <button
              data-preset="robust"
              class="preset-btn px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm whitespace-nowrap"
            >
              Robust
            </button>
          </div>
        </div>

        <!-- Config Sections -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="configSections">
          <!-- Reservoir Architecture -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Reservoir Architecture</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Reservoir Size</label>
                <input
                  type="number"
                  id="cfg_reservoirSize"
                  value="256"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Neurons in reservoir</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Spectral Radius</label>
                <input
                  type="number"
                  id="cfg_spectralRadius"
                  value="0.9"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400"
                >Memory length control</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Leak Rate</label>
                <input
                  type="number"
                  id="cfg_leakRate"
                  value="0.3"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Temporal smoothing</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Input Scale</label>
                <input
                  type="number"
                  id="cfg_inputScale"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Input scaling factor</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Bias Scale</label>
                <input
                  type="number"
                  id="cfg_biasScale"
                  value="0.1"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Bias scaling</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Reservoir Sparsity</label>
                <input
                  type="number"
                  id="cfg_reservoirSparsity"
                  value="0.9"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Zero connections</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Input Sparsity</label>
                <input
                  type="number"
                  id="cfg_inputSparsity"
                  value="0.0"
                  step="0.01"
                  min="0"
                  max="1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Input sparsity</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Activation</label>
                <select
                  id="cfg_activation"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                  <option value="tanh">tanh</option>
                  <option value="relu">relu</option>
                </select>
                <span class="text-xs text-slate-400">Activation function</span>
              </div>
            </div>
          </div>

          <!-- Readout Configuration -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Readout Configuration</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-3 grid grid-cols-2 gap-3">
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
              >
                <div>
                  <div class="text-sm font-medium">Use Input in Readout</div>
                  <div class="text-xs text-slate-400">
                    Append input to state
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="cfg_useInputInReadout"
                    checked
                    class="sr-only peer"
                  >
                  <div
                    class="w-11 h-6 bg-slate-300 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                  >
                  </div>
                </label>
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg"
              >
                <div>
                  <div class="text-sm font-medium">Use Bias in Readout</div>
                  <div class="text-xs text-slate-400">Include bias term</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="cfg_useBiasInReadout"
                    checked
                    class="sr-only peer"
                  >
                  <div
                    class="w-11 h-6 bg-slate-300 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                  >
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Training (RLS) -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Training (RLS)</span>
              <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="section-content mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Readout Training</label>
                <input
                  type="text"
                  value="rls"
                  disabled
                  class="w-full px-3 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 border border-slate-200 dark:border-slate-600 text-slate-500"
                >
                <span class="text-xs text-slate-400">RLS training</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >RLS Lambda</label>
                <input
                  type="number"
                  id="cfg_rlsLambda"
                  value="0.999"
                  step="0.001"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Forgetting factor</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >RLS Delta</label>
                <input
                  type="number"
                  id="cfg_rlsDelta"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Initial P diagonal</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Epsilon</label>
                <input
                  type="number"
                  id="cfg_epsilon"
                  value="1e-8"
                  step="1e-9"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Numerical stability</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >L2 Lambda</label>
                <input
                  type="number"
                  id="cfg_l2Lambda"
                  value="0.0001"
                  step="0.0001"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">L2 regularization</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Gradient Clip Norm</label>
                <input
                  type="number"
                  id="cfg_gradientClipNorm"
                  value="1.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Max update norm</span>
              </div>
            </div>
          </div>

          <!-- Normalization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Normalization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="section-content hidden mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Normalization Epsilon</label>
                <input
                  type="number"
                  id="cfg_normalizationEpsilon"
                  value="1e-8"
                  step="1e-9"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Stability constant</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Normalization Warmup</label>
                <input
                  type="number"
                  id="cfg_normalizationWarmup"
                  value="10"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Warmup samples</span>
              </div>
            </div>
          </div>

          <!-- Outlier Handling -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Outlier Handling</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="section-content hidden mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Outlier Threshold</label>
                <input
                  type="number"
                  id="cfg_outlierThreshold"
                  value="3.0"
                  step="0.1"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Z-score threshold</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Outlier Min Weight</label>
                <input
                  type="number"
                  id="cfg_outlierMinWeight"
                  value="0.1"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Outlier min weight</span>
              </div>
            </div>
          </div>

          <!-- Uncertainty -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Uncertainty</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="section-content hidden mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Uncertainty Multiplier</label>
                <input
                  type="number"
                  id="cfg_uncertaintyMultiplier"
                  value="1.96"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400"
                >CI Multiplier (1.96 = 95% CI)</span>
              </div>
            </div>
          </div>

          <!-- Initialization -->
          <div class="config-section">
            <button
              class="section-toggle w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-medium"
            >
              <span>Initialization</span>
              <span class="toggle-icon">‚ñ∂</span>
            </button>
            <div class="section-content hidden mt-3 grid grid-cols-2 gap-3">
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Weight Init Scale</label>
                <input
                  type="number"
                  id="cfg_weightInitScale"
                  value="0.1"
                  step="0.01"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Initial weight scale</span>
              </div>
              <div>
                <label
                  class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
                >Seed</label>
                <input
                  type="number"
                  id="cfg_seed"
                  value="42"
                  class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                >
                <span class="text-xs text-slate-400">Random seed</span>
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg col-span-2"
              >
                <div>
                  <div class="text-sm font-medium">Verbose</div>
                  <div class="text-xs text-slate-400">Detailed logging</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="cfg_verbose" class="sr-only peer">
                  <div
                    class="w-11 h-6 bg-slate-300 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"
                  >
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2 justify-between"
        >
          <div class="flex gap-2">
            <button
              id="cfgResetDefaults"
              class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
            >
              Reset Defaults
            </button>
            <button
              id="cfgResetAll"
              class="px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium text-sm hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
            >
              Reset All
            </button>
          </div>
          <div class="flex gap-2">
            <button
              id="cfgCancel"
              class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
            >
              Cancel
            </button>
            <button
              id="cfgCreate"
              class="px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium text-sm shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-shadow"
            >
              Create Model
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Dataset Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="uploadOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">üì§ Upload Dataset</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div
            id="dropZone"
            class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer"
          >
            <span class="text-4xl">üìÅ</span>
            <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
              Drop JSON file here or tap to browse
            </p>
            <input type="file" id="fileInput" accept=".json" class="hidden">
          </div>
          <div>
            <label class="text-sm font-medium mb-2 block">Or paste JSON:</label>
            <textarea
              id="jsonInput"
              rows="6"
              class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
              placeholder='{"coordinates": [[1,2,3], [4,5,6]]}'
            ></textarea>
          </div>
          <details class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-3">
            <summary class="cursor-pointer font-medium text-sm">
              Format Example
            </summary>
            <pre
              class="mt-2 text-xs bg-slate-100 dark:bg-slate-800 p-3 rounded-lg overflow-x-auto"
            >
<code>{
  "coordinates": [
    [1.0, 2.0, 3.0],
    [1.1, 2.1, 3.1],
    [1.2, 2.2, 3.2]
  ]
}</code></pre>
            <button
              id="copyExample"
              class="mt-2 text-xs text-blue-500 hover:text-blue-600"
            >
              Copy example
            </button>
          </details>
          <div
            id="uploadPreview"
            class="hidden p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800"
          >
            <div
              class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400"
            >
              <span>‚úì</span>
              <span id="previewText">Valid: 3 dimensions, 100 steps</span>
            </div>
          </div>
          <div
            id="uploadError"
            class="hidden p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
          >
            <div class="text-red-600 dark:text-red-400" id="errorText">
              Invalid format
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="uploadCancel"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="uploadValidate"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Validate
          </button>
          <button
            id="uploadApply"
            disabled
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Apply & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Manual Insert Modal -->
    <div
      id="manualModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="manualOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">‚ûï Manual Insert</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <p class="text-sm text-slate-600 dark:text-slate-400">
            Add time step data for online training. Minimum 2 coordinates
            required per batch.
          </p>
          <button
            id="genTemplate"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
          >
            Generate Template
          </button>
          <textarea
            id="manualJson"
            rows="8"
            class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
            placeholder='{"coordinates": [[x1,y1,z1], [x2,y2,z2]]}'
          ></textarea>
          <div id="manualFeedback"></div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="manualCancel"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="manualInsert"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium text-sm"
          >
            Insert & Train
          </button>
        </div>
      </div>
    </div>

    <!-- Save & Load Modal -->
    <div
      id="saveLoadModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="saveLoadOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">üíæ Save & Load</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <div>
            <h3
              class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-3"
            >
              Save Model
            </h3>
            <div class="flex gap-2">
              <button
                id="saveDownload"
                class="flex-1 px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
              >
                üì• Download JSON
              </button>
              <button
                id="saveBrowser"
                class="flex-1 px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
              >
                üíæ Save to Browser
              </button>
            </div>
          </div>
          <div>
            <h3
              class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-3"
            >
              Load Model
            </h3>
            <div
              id="loadDropZone"
              class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer mb-4"
            >
              <span class="text-2xl">üì§</span>
              <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                Tap to upload model file
              </p>
              <input
                type="file"
                id="loadFileInput"
                accept=".json"
                class="hidden"
              >
            </div>
            <div id="savedModelsList" class="space-y-2"></div>
            <button
              id="clearSavedModels"
              class="mt-3 text-xs text-red-500 hover:text-red-600"
            >
              Clear all saved models
            </button>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="saveLoadClose"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Random Test Modal -->
    <div
      id="randomModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="randomOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">üí° Random Test</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Seed</label>
              <input
                type="number"
                id="rnd_seed"
                value="42"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
            </div>
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Dimensions</label>
              <input
                type="number"
                id="rnd_dims"
                value="3"
                min="1"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
            </div>
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Time Steps</label>
              <input
                type="number"
                id="rnd_steps"
                value="200"
                min="10"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
            </div>
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Noise</label>
              <input
                type="number"
                id="rnd_noise"
                value="0.1"
                step="0.01"
                min="0"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
            </div>
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Outlier Rate</label>
              <input
                type="number"
                id="rnd_outliers"
                value="0.02"
                step="0.01"
                min="0"
                max="1"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
            </div>
            <div>
              <label
                class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
              >Difficulty</label>
              <select
                id="rnd_difficulty"
                class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
              >
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
              </select>
            </div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="randomCancel"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Cancel
          </button>
          <button
            id="randomGenerate"
            class="px-4 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 text-white font-medium text-sm shadow-lg shadow-purple-500/25"
          >
            Generate & Run
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="settingsOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">üîß Settings</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
          <div>
            <label class="text-xs text-slate-500 dark:text-slate-400 block mb-1"
            >Module URL</label>
            <input
              type="text"
              id="moduleUrl"
              class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
            >
          </div>
          <button
            id="reinitWorker"
            class="w-full px-4 py-3 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 font-medium hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors"
          >
            Reinitialize Worker
          </button>
          <button
            id="clearPrefs"
            class="w-full px-4 py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
          >
            Clear All Preferences
          </button>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="settingsClose"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Data Table Modal -->
    <div
      id="dataTableModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="dataTableOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
        >
          <h2 class="text-xl font-bold">üìã Data Table</h2>
          <div class="flex gap-2">
            <button
              id="exportCsv"
              class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 text-sm font-medium"
            >
              üìä CSV
            </button>
            <button
              id="copyAllData"
              class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 text-sm font-medium"
            >
              üìã Copy
            </button>
          </div>
        </div>
        <div class="p-4">
          <input
            type="text"
            id="tableSearch"
            placeholder="Search..."
            class="w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 outline-none text-sm"
          >
        </div>
        <div class="flex-1 overflow-auto p-4 pt-0">
          <table class="w-full text-sm" id="dataTable">
            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700">
              <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody" class="font-mono"></tbody>
          </table>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="dataTableClose"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="absolute inset-0 bg-black/50" id="helpOverlay"></div>
      <div
        class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
          <h2 class="text-xl font-bold">‚ùì Help & Documentation</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
          <section>
            <h3 class="font-bold text-lg mb-2">Worker Setup</h3>
            <div
              class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-sm"
            >
              <p>
                The ESNRegression library runs in a Web Worker for non-blocking
                performance.
              </p>
              <p class="mt-2 font-mono text-xs break-all">
                Module URL:
                https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3
              </p>
            </div>
          </section>
          <section>
            <h3 class="font-bold text-lg mb-2">Creating a Model</h3>
            <pre
              class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-sm overflow-x-auto"
            ><code>const model = new ESNRegression(config);</code></pre>
          </section>
          <section>
            <h3 class="font-bold text-lg mb-2">Online Training (fitOnline)</h3>
            <pre
              class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-sm overflow-x-auto"
            >
<code>model.fitOnline({ coordinates: [[x1,y1,z1], [x2,y2,z2]] });
// Min two coordinates per call (t, t+1), (t+2, t+3)...
// Returns: { averageLoss, gradientNorm, sampleWeight }</code></pre>
          </section>
          <section>
            <h3 class="font-bold text-lg mb-2">Prediction</h3>
            <pre
              class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-sm overflow-x-auto"
            >
<code>const result = model.predict(futureSteps);
// Returns: { predictions, lowerBounds, upperBounds, confidence }
// Each is array of arrays [step][dimension]</code></pre>
          </section>
          <section>
            <h3 class="font-bold text-lg mb-2">Save/Load</h3>
            <pre
              class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 text-sm overflow-x-auto"
            >
<code>const state = model.save();
model.load(state);</code></pre>
          </section>
          <section>
            <h3 class="font-bold text-lg mb-2">Preset Configurations</h3>
            <ul class="text-sm space-y-1 list-disc pl-5">
              <li>
                <strong>Start Here/Default:</strong> reservoirSize=256,
                spectralRadius=0.9, leakRate=0.3
              </li>
              <li>
                <strong>Fast:</strong> reservoirSize=64, reservoirSparsity=0.95
              </li>
              <li>
                <strong>Balanced:</strong> reservoirSize=256, spectralRadius=0.9
              </li>
              <li>
                <strong>Accurate:</strong> reservoirSize=512,
                spectralRadius=0.95, leakRate=0.2
              </li>
              <li>
                <strong>Adaptive:</strong> rlsLambda=0.97, spectralRadius=0.85,
                leakRate=0.5
              </li>
              <li>
                <strong>Robust:</strong> outlierThreshold=2.0,
                outlierMinWeight=0.05, l2Lambda=0.01
              </li>
            </ul>
          </section>
        </div>
        <div
          class="p-4 border-t border-slate-200 dark:border-slate-700 flex gap-2 justify-end"
        >
          <button
            id="helpClose"
            class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 font-medium text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===================== DIMENSION COLORS =====================
      const DIM_COLORS = [
        "#3B82F6",
        "#10B981",
        "#F59E0B",
        "#EF4444",
        "#8B5CF6",
        "#EC4899",
        "#06B6D4",
        "#84CC16",
        "#F97316",
        "#14B8A6",
      ];

      // ===================== DEFAULT CONFIG =====================
      const DEFAULT_CONFIG = {
        reservoirSize: 256,
        spectralRadius: 0.9,
        leakRate: 0.3,
        inputScale: 1.0,
        biasScale: 0.1,
        reservoirSparsity: 0.9,
        inputSparsity: 0.0,
        activation: "tanh",
        useInputInReadout: true,
        useBiasInReadout: true,
        readoutTraining: "rls",
        rlsLambda: 0.999,
        rlsDelta: 1.0,
        epsilon: 1e-8,
        l2Lambda: 0.0001,
        gradientClipNorm: 1.0,
        normalizationEpsilon: 1e-8,
        normalizationWarmup: 10,
        outlierThreshold: 3.0,
        outlierMinWeight: 0.1,
        uncertaintyMultiplier: 1.96,
        weightInitScale: 0.1,
        seed: 42,
        verbose: false,
      };

      const PRESETS = {
        default: { ...DEFAULT_CONFIG },
        fast: {
          ...DEFAULT_CONFIG,
          reservoirSize: 64,
          reservoirSparsity: 0.95,
        },
        balanced: {
          ...DEFAULT_CONFIG,
          reservoirSize: 256,
          spectralRadius: 0.9,
        },
        accurate: {
          ...DEFAULT_CONFIG,
          reservoirSize: 512,
          spectralRadius: 0.95,
          leakRate: 0.2,
        },
        adaptive: {
          ...DEFAULT_CONFIG,
          rlsLambda: 0.97,
          spectralRadius: 0.85,
          leakRate: 0.5,
        },
        robust: {
          ...DEFAULT_CONFIG,
          outlierThreshold: 2.0,
          outlierMinWeight: 0.05,
          l2Lambda: 0.01,
          leakRate: 0.2,
        },
      };

      // ===================== APPLICATION STATE =====================
      const state = {
        config: { ...DEFAULT_CONFIG },
        modelExists: false,
        nDimensions: 0,
        sampleCount: 0,
        predictions: null,
        vizMode: localStorage.getItem("vizMode") || "grid",
        selectedDim: 0,
        selectedStep: 0,
        isDark: localStorage.getItem("isDark") === "true",
        logs: [],
        metrics: { avgLoss: 0, gradientNorm: 0, sampleWeight: 0 },
        zoom: {
          level: 1,
          offsetX: 0,
          visibleStart: 0,
          visibleCount: 0,
        },
        hover: { active: false, x: 0, y: 0, dataIndex: -1 },
        currentRequestId: 0,
        cancelRequested: false,
      };

      // ===================== WEB WORKER =====================
      const MODULE_URL_DEFAULT =
        "https://cdn.esm.sh/jsr/@hviana/multivariate-regression@1.4.3";
      let moduleUrl = localStorage.getItem("moduleUrl") ||
        MODULE_URL_DEFAULT;
      let worker = null;

      const workerCode = `
        let ESNRegression = null;
        let model = null;
        let cancelFlag = false;

        self.onmessage = async (e) => {
            const { type, payload, requestId } = e.data;
            
            try {
                switch (type) {
                    case 'init':
                        const module = await import(payload.moduleUrl);
                        ESNRegression = module.ESNRegression;
                        self.postMessage({ type: 'init', success: true, requestId });
                        break;
                        
                    case 'createModel':
                        model = new ESNRegression(payload.config);
                        self.postMessage({ type: 'createModel', success: true, requestId });
                        break;
                        
                    case 'train':
                        cancelFlag = false;
                        const coords = payload.coordinates;
                        const batchSize = 10;
                        let results = { averageLoss: 0, gradientNorm: 0, sampleWeight: 0 };
                        
                        for (let i = 0; i < coords.length - 1 && !cancelFlag; i += batchSize) {
                            const batch = coords.slice(i, Math.min(i + batchSize + 1, coords.length));
                            if (batch.length >= 2) {
                                results = model.fitOnline({ coordinates: batch });
                            }
                            self.postMessage({ 
                                type: 'progress', 
                                progress: Math.min(100, ((i + batchSize) / coords.length) * 100),
                                requestId 
                            });
                        }
                        
                        if (cancelFlag) {
                            self.postMessage({ type: 'cancelled', requestId });
                        } else {
                            self.postMessage({ type: 'train', success: true, results, requestId });
                        }
                        break;
                        
                    case 'predict':
                        const prediction = model.predict(payload.steps);
                        self.postMessage({ type: 'predict', success: true, result: prediction, requestId });
                        break;
                        
                    case 'save':
                        const savedState = model.save();
                        self.postMessage({ type: 'save', success: true, state: savedState, requestId });
                        break;
                        
                    case 'load':
                        if (!model) {
                            model = new ESNRegression({});
                        }
                        model.load(payload.state);
                        self.postMessage({ type: 'load', success: true, requestId });
                        break;
                        
                    case 'getSummary':
                        const summary = model.getModelSummary();
                        self.postMessage({ type: 'getSummary', success: true, summary, requestId });
                        break;
                        
                    case 'reset':
                        model = null;
                        self.postMessage({ type: 'reset', success: true, requestId });
                        break;
                        
                    case 'cancel':
                        cancelFlag = true;
                        break;
                }
            } catch (error) {
                self.postMessage({ type: 'error', error: error.message, requestId });
            }
        };
    `;

      function initWorker() {
        try {
          const blob = new Blob([workerCode], {
            type: "application/javascript",
          });
          worker = new Worker(URL.createObjectURL(blob), {
            type: "module",
          });

          worker.onmessage = handleWorkerMessage;
          worker.onerror = (e) => {
            addLog("error", "Worker error: " + e.message);
            showToast("Worker error occurred", "error");
          };

          sendToWorker("init", { moduleUrl });
          addLog("info", "Worker initialized");
        } catch (e) {
          addLog("error", "Failed to initialize worker: " + e.message);
          showToast("Failed to initialize worker", "error");
        }
      }

      function sendToWorker(type, payload = {}) {
        if (!worker) {
          showToast("Worker not ready", "error");
          return null;
        }
        const requestId = ++state.currentRequestId;
        worker.postMessage({ type, payload, requestId });
        return requestId;
      }

      function handleWorkerMessage(e) {
        const { type, success, requestId, error, ...data } = e.data;

        if (error) {
          addLog("error", error);
          showToast(error, "error");
          hideLoading();
          return;
        }

        switch (type) {
          case "init":
            addLog("success", "ESN module loaded");
            break;

          case "createModel":
            state.modelExists = true;
            state.sampleCount = 0;
            updateUI();
            addLog("success", "Model created");
            hideLoading();
            break;

          case "progress":
            updateProgress(data.progress);
            break;

          case "train":
            state.metrics = data.results;
            sendToWorker("getSummary");
            updateMetricsUI();
            addLog("success", "Training complete");
            hideLoading();
            break;

          case "cancelled":
            addLog("warning", "Operation cancelled");
            hideLoading();
            break;

          case "predict":
            state.predictions = data.result;
            state.nDimensions = data.result.predictions[0]?.length || 0;
            updateUI();
            renderVisualization();
            addLog(
              "success",
              `Prediction complete: ${data.result.predictions.length} steps`,
            );
            hideLoading();
            break;

          case "save":
            handleSaveComplete(data.state);
            break;

          case "load":
            state.modelExists = true;
            sendToWorker("getSummary");
            addLog("success", "Model loaded");
            hideLoading();
            break;

          case "getSummary":
            if (data.summary) {
              state.nDimensions = data.summary.nFeatures || 0;
              state.sampleCount = data.summary.sampleCount || 0;
              updateUI();
            }
            break;

          case "reset":
            state.modelExists = false;
            state.predictions = null;
            state.nDimensions = 0;
            state.sampleCount = 0;
            updateUI();
            renderVisualization();
            addLog("info", "Model reset");
            break;
        }
      }

      // ===================== UI HELPERS =====================
      function showLoading(text = "Processing...") {
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingState").classList.remove(
          "hidden",
        );
        updateProgress(0);
      }

      function hideLoading() {
        document.getElementById("loadingState").classList.add("hidden");
      }

      function updateProgress(percent) {
        document.getElementById("progressBar").style.width = percent +
          "%";
        document.getElementById("progressText").textContent =
          Math.round(percent) + "%";
      }

      function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const colors = {
          info: "bg-blue-500",
          success: "bg-emerald-500",
          warning: "bg-amber-500",
          error: "bg-red-500",
        };

        const toast = document.createElement("div");
        toast.className = `${
          colors[type]
        } text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 pointer-events-auto`;
        toast.innerHTML = `
            <span>${message}</span>
            <button class="ml-2 hover:opacity-70" onclick="this.parentElement.remove()">‚úñÔ∏è</button>
        `;

        container.appendChild(toast);
        setTimeout(
          () => toast.remove(),
          type === "error" ? 6000 : 4000,
        );
      }

      function addLog(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        state.logs.unshift({ type, message, timestamp });
        if (state.logs.length > 200) state.logs.pop();
        renderLogs();
      }

      function renderLogs() {
        const container = document.getElementById("logContainer");
        const filter = document.getElementById("logFilter").value;
        const search = document.getElementById("logSearch").value
          .toLowerCase();

        const filtered = state.logs
          .filter((l) => filter === "all" || l.type === filter)
          .filter((l) =>
            !search || l.message.toLowerCase().includes(search)
          )
          .slice(0, 50);

        const colors = {
          info:
            "bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400",
          success:
            "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400",
          warning:
            "bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400",
          error:
            "bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400",
        };

        container.innerHTML = filtered.map((l) => `
            <div class="flex items-start gap-2 p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                <span class="px-1.5 py-0.5 rounded text-xs font-medium ${
          colors[l.type]
        }">${l.type}</span>
                <div class="flex-1 min-w-0">
                    <div class="text-sm truncate">${l.message}</div>
                    <div class="text-xs text-slate-400">${l.timestamp}</div>
                </div>
            </div>
        `).join("");
      }

      function updateUI() {
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const predictBtn = document.getElementById("predictBtn");
        const runPredictBtn = document.getElementById("runPredictBtn");
        const emptyState = document.getElementById("emptyState");
        const zoomControls = document.getElementById("zoomControls");
        const exportControls = document.getElementById(
          "exportControls",
        );

        if (state.modelExists) {
          statusDot.className =
            "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
          statusText.textContent = `${state.sampleCount} steps`;
          predictBtn.classList.remove("hidden");
          runPredictBtn.disabled = false;
        } else {
          statusDot.className =
            "w-2 h-2 rounded-full bg-slate-400 animate-pulse";
          statusText.textContent = "No Model";
          predictBtn.classList.add("hidden");
          runPredictBtn.disabled = true;
        }

        if (state.predictions) {
          emptyState.classList.add("hidden");
          zoomControls.classList.remove("hidden");
          exportControls.classList.remove("hidden");
        } else {
          emptyState.classList.remove("hidden");
          zoomControls.classList.add("hidden");
          exportControls.classList.add("hidden");
        }

        updateVizTabs();
        updateDimensionSelector();
        updateStepSelector();
        updateStatsBar();
      }

      function updateMetricsUI() {
        document.getElementById("metricSamples").textContent =
          state.sampleCount;
        document.getElementById("metricLoss").textContent =
          state.metrics.avgLoss?.toExponential(2) || "0.00e+0";
        document.getElementById("metricGradient").textContent =
          state.metrics.gradientNorm?.toExponential(2) || "0.00e+0";
        document.getElementById("metricWeight").textContent =
          state.metrics.sampleWeight?.toFixed(3) || "0.000";
      }

      function updateVizTabs() {
        document.querySelectorAll(".viz-tab").forEach((tab) => {
          const isActive = tab.dataset.mode === state.vizMode;
          tab.className =
            `viz-tab flex-shrink-0 px-4 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap transition-all ${
              isActive
                ? "bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/25"
                : "bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600"
            }`;
          tab.setAttribute("aria-selected", isActive);
        });

        document.getElementById("dimensionSelector").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !state.predictions,
        );
        document.getElementById("stepSelector").classList.toggle(
          "hidden",
          state.vizMode !== "snapshot" || !state.predictions,
        );
        document.getElementById("statsBar").classList.toggle(
          "hidden",
          state.vizMode !== "focus" || !state.predictions,
        );
      }

      function updateDimensionSelector() {
        const container = document.getElementById("dimButtons");
        if (!state.predictions || state.nDimensions === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = Array.from(
          { length: state.nDimensions },
          (_, i) => {
            const isActive = i === state.selectedDim;
            const color = DIM_COLORS[i % DIM_COLORS.length];
            return `
                <button 
                    data-dim="${i}" 
                    class="dim-btn px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap transition-all ${
              isActive
                ? "text-white shadow-lg"
                : "bg-slate-100 dark:bg-slate-700"
            }"
                    style="${
              isActive ? `background-color: ${color}` : ""
            }"
                >
                    D${i + 1}
                </button>
            `;
          },
        ).join("");
      }

      function updateStepSelector() {
        const input = document.getElementById("stepInput");
        if (state.predictions) {
          input.max = state.predictions.predictions.length - 1;
          input.value = Math.min(
            state.selectedStep,
            state.predictions.predictions.length - 1,
          );
        }
      }

      function updateStatsBar() {
        if (!state.predictions || state.vizMode !== "focus") return;

        const dim = state.selectedDim;
        const values = state.predictions.predictions.map((p) => p[dim]);

        const min = Math.min(...values);
        const max = Math.max(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const final = values[values.length - 1];
        const trend = final - values[0];
        const avgConfidence = state.predictions.confidence
          ? (state.predictions.confidence.reduce((a, b) => a + b, 0) /
            state.predictions.confidence.length * 100).toFixed(0)
          : "-";

        document.getElementById("statMin").textContent = min.toFixed(3);
        document.getElementById("statMax").textContent = max.toFixed(3);
        document.getElementById("statMean").textContent = mean.toFixed(
          3,
        );
        document.getElementById("statFinal").textContent = final
          .toFixed(3);
        document.getElementById("statTrend").innerHTML = `
            <span class="${
          trend >= 0 ? "text-emerald-500" : "text-red-500"
        }">
                ${trend >= 0 ? "‚Üë" : "‚Üì"} ${Math.abs(trend).toFixed(3)}
            </span>
        `;
        document.getElementById("statConf").textContent =
          avgConfidence + "%";
      }

      // ===================== VISUALIZATION =====================
      const canvas = document.getElementById("vizCanvas");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        const container = document.getElementById("chartContainer");
        const dpr = window.devicePixelRatio || 1;
        canvas.width = container.clientWidth * dpr;
        canvas.height = container.clientHeight * dpr;
        canvas.style.width = container.clientWidth + "px";
        canvas.style.height = container.clientHeight + "px";
        ctx.scale(dpr, dpr);
        renderVisualization();
      }

      function renderVisualization() {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;

        ctx.clearRect(0, 0, width, height);

        if (!state.predictions) return;

        switch (state.vizMode) {
          case "grid":
            renderGrid(width, height);
            break;
          case "focus":
            renderFocus(width, height);
            break;
          case "heatmap":
            renderHeatmap(width, height);
            break;
          case "uncertainty":
            renderUncertainty(width, height);
            break;
          case "snapshot":
            renderSnapshot(width, height);
            break;
        }

        document.getElementById("zoomBadge").textContent =
          Math.round(state.zoom.level * 100) + "%";
      }

      function renderGrid(width, height) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const nDims = state.nDimensions;
        const cols = Math.ceil(Math.sqrt(nDims));
        const rows = Math.ceil(nDims / cols);

        const cellWidth = (width - 60) / cols;
        const cellHeight = (height - 60) / rows;
        const padding = 20;

        for (let d = 0; d < nDims; d++) {
          const col = d % cols;
          const row = Math.floor(d / cols);
          const x = 30 + col * cellWidth;
          const y = 30 + row * cellHeight;

          const values = predictions.map((p) => p[d]);
          const lower = lowerBounds.map((l) => l[d]);
          const upper = upperBounds.map((u) => u[d]);

          const allVals = [...values, ...lower, ...upper];
          const minVal = Math.min(...allVals);
          const maxVal = Math.max(...allVals);
          const range = maxVal - minVal || 1;

          const color = DIM_COLORS[d % DIM_COLORS.length];

          // Draw CI area
          ctx.beginPath();
          ctx.fillStyle = color + "20";
          for (let i = 0; i < values.length; i++) {
            const px = x + padding +
              (i / (values.length - 1)) * (cellWidth - 2 * padding);
            const py = y + cellHeight - padding -
              ((upper[i] - minVal) / range) *
                (cellHeight - 2 * padding);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          for (let i = values.length - 1; i >= 0; i--) {
            const px = x + padding +
              (i / (values.length - 1)) * (cellWidth - 2 * padding);
            const py = y + cellHeight - padding -
              ((lower[i] - minVal) / range) *
                (cellHeight - 2 * padding);
            ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();

          // Draw line
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          for (let i = 0; i < values.length; i++) {
            const px = x + padding +
              (i / (values.length - 1)) * (cellWidth - 2 * padding);
            const py = y + cellHeight - padding -
              ((values[i] - minVal) / range) *
                (cellHeight - 2 * padding);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }
          ctx.stroke();

          // Label
          ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
          ctx.font = "bold 12px system-ui";
          ctx.fillText(`D${d + 1}`, x + 5, y + 15);
        }
      }

      function renderFocus(width, height) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const dim = state.selectedDim;
        const padding = { top: 40, right: 60, bottom: 40, left: 60 };

        const values = predictions.map((p) => p[dim]);
        const lower = lowerBounds.map((l) => l[dim]);
        const upper = upperBounds.map((u) => u[dim]);

        const allVals = [...values, ...lower, ...upper];
        const minVal = Math.min(...allVals);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const color = DIM_COLORS[dim % DIM_COLORS.length];

        // Grid lines
        ctx.strokeStyle = state.isDark ? "#334155" : "#e2e8f0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding.top + (i / 5) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(width - padding.right, y);
          ctx.stroke();

          const val = maxVal - (i / 5) * range;
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(val.toFixed(2), padding.left - 5, y + 3);
        }

        // CI area
        ctx.beginPath();
        ctx.fillStyle = color + "30";
        for (let i = 0; i < values.length; i++) {
          const px = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const py = padding.top + chartHeight -
            ((upper[i] - minVal) / range) * chartHeight;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        for (let i = values.length - 1; i >= 0; i--) {
          const px = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const py = padding.top + chartHeight -
            ((lower[i] - minVal) / range) * chartHeight;
          ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();

        // Main line
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        for (let i = 0; i < values.length; i++) {
          const px = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const py = padding.top + chartHeight -
            ((values[i] - minVal) / range) * chartHeight;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Hover indicator
        if (state.hover.active && state.hover.dataIndex >= 0) {
          const i = state.hover.dataIndex;
          const px = padding.left +
            (i / (values.length - 1)) * chartWidth;
          const py = padding.top + chartHeight -
            ((values[i] - minVal) / range) * chartHeight;

          // Crosshairs
          ctx.strokeStyle = state.isDark ? "#475569" : "#cbd5e1";
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(px, padding.top);
          ctx.lineTo(px, height - padding.bottom);
          ctx.moveTo(padding.left, py);
          ctx.lineTo(width - padding.right, py);
          ctx.stroke();
          ctx.setLineDash([]);

          // Point glow
          ctx.beginPath();
          ctx.fillStyle = color + "40";
          ctx.arc(px, py, 12, 0, Math.PI * 2);
          ctx.fill();

          ctx.beginPath();
          ctx.fillStyle = color;
          ctx.arc(px, py, 6, 0, Math.PI * 2);
          ctx.fill();
        }

        // Title
        ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Dimension ${dim + 1}`, padding.left, 20);
      }

      function renderHeatmap(width, height) {
        const { predictions } = state.predictions;
        const nDims = state.nDimensions;
        const nSteps = predictions.length;

        const padding = { top: 40, right: 20, bottom: 40, left: 50 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const cellWidth = chartWidth / nSteps;
        const cellHeight = chartHeight / nDims;

        // Find global min/max
        let globalMin = Infinity, globalMax = -Infinity;
        predictions.forEach((p) => {
          p.forEach((v) => {
            globalMin = Math.min(globalMin, v);
            globalMax = Math.max(globalMax, v);
          });
        });
        const range = globalMax - globalMin || 1;

        for (let d = 0; d < nDims; d++) {
          for (let s = 0; s < nSteps; s++) {
            const val = predictions[s][d];
            const norm = (val - globalMin) / range;

            // Color interpolation (blue to red)
            const r = Math.round(norm * 255);
            const b = Math.round((1 - norm) * 255);
            const g = Math.round(Math.min(norm, 1 - norm) * 2 * 128);

            ctx.fillStyle = `rgb(${r},${g},${b})`;
            ctx.fillRect(
              padding.left + s * cellWidth,
              padding.top + d * cellHeight,
              cellWidth + 0.5,
              cellHeight + 0.5,
            );
          }

          // Y-axis labels
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "right";
          ctx.fillText(
            `D${d + 1}`,
            padding.left - 5,
            padding.top + (d + 0.5) * cellHeight + 3,
          );
        }

        // Title
        ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText("Prediction Heatmap", padding.left, 20);
      }

      function renderUncertainty(width, height) {
        const { predictions, lowerBounds, upperBounds, confidence } =
          state.predictions;
        const padding = { top: 40, right: 20, bottom: 40, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Calculate uncertainty (spread) for each step
        const uncertainties = predictions.map((p, i) => {
          let totalSpread = 0;
          for (let d = 0; d < p.length; d++) {
            totalSpread += upperBounds[i][d] - lowerBounds[i][d];
          }
          return totalSpread / p.length;
        });

        const maxUnc = Math.max(...uncertainties);
        const minUnc = Math.min(...uncertainties);
        const range = maxUnc - minUnc || 1;

        // Draw bars
        const barWidth = chartWidth / uncertainties.length;
        uncertainties.forEach((unc, i) => {
          const norm = (unc - minUnc) / range;
          const barHeight = norm * chartHeight;

          // Gradient from green (low) to red (high)
          const r = Math.round(norm * 255);
          const g = Math.round((1 - norm) * 200);

          ctx.fillStyle = `rgb(${r},${g},100)`;
          ctx.fillRect(
            padding.left + i * barWidth,
            padding.top + chartHeight - barHeight,
            barWidth - 1,
            barHeight,
          );
        });

        // Draw confidence line if available
        if (confidence && confidence.length > 0) {
          ctx.beginPath();
          ctx.strokeStyle = "#8B5CF6";
          ctx.lineWidth = 2;
          confidence.forEach((c, i) => {
            const px = padding.left + (i + 0.5) * barWidth;
            const py = padding.top + chartHeight - (c * chartHeight);
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          });
          ctx.stroke();
        }

        // Title
        ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(
          "Uncertainty / Confidence Intervals",
          padding.left,
          20,
        );
      }

      function renderSnapshot(width, height) {
        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const step = Math.min(
          state.selectedStep,
          predictions.length - 1,
        );
        const values = predictions[step];
        const lower = lowerBounds[step];
        const upper = upperBounds[step];

        const padding = { top: 40, right: 20, bottom: 40, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        const allVals = [...values, ...lower, ...upper];
        const minVal = Math.min(...allVals, 0);
        const maxVal = Math.max(...allVals);
        const range = maxVal - minVal || 1;

        const barWidth = chartWidth / values.length;

        values.forEach((val, d) => {
          const color = DIM_COLORS[d % DIM_COLORS.length];
          const barHeight = ((val - minVal) / range) * chartHeight;
          const ciLow = ((lower[d] - minVal) / range) * chartHeight;
          const ciHigh = ((upper[d] - minVal) / range) * chartHeight;

          const x = padding.left + d * barWidth + barWidth * 0.1;
          const barW = barWidth * 0.8;

          // CI whiskers
          const centerX = x + barW / 2;
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(centerX, padding.top + chartHeight - ciHigh);
          ctx.lineTo(centerX, padding.top + chartHeight - ciLow);
          ctx.moveTo(centerX - 10, padding.top + chartHeight - ciHigh);
          ctx.lineTo(centerX + 10, padding.top + chartHeight - ciHigh);
          ctx.moveTo(centerX - 10, padding.top + chartHeight - ciLow);
          ctx.lineTo(centerX + 10, padding.top + chartHeight - ciLow);
          ctx.stroke();

          // Bar
          ctx.fillStyle = color;
          ctx.fillRect(
            x,
            padding.top + chartHeight - barHeight,
            barW,
            barHeight,
          );

          // Label
          ctx.fillStyle = state.isDark ? "#94a3b8" : "#64748b";
          ctx.font = "10px system-ui";
          ctx.textAlign = "center";
          ctx.fillText(
            `D${d + 1}`,
            centerX,
            height - padding.bottom + 15,
          );
        });

        // Title
        ctx.fillStyle = state.isDark ? "#f1f5f9" : "#1e293b";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(`Snapshot: Step ${step + 1}`, padding.left, 20);
      }

      // ===================== INTERACTION =====================
      let isPanning = false;
      let lastPanX = 0;
      let touchStartDist = 0;

      canvas.addEventListener("mousemove", (e) => {
        if (!state.predictions) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (state.vizMode === "focus") {
          const padding = { left: 60, right: 60, top: 40, bottom: 40 };
          const chartWidth = canvas.clientWidth - padding.left -
            padding.right;

          if (
            x >= padding.left && x <= canvas.clientWidth - padding.right
          ) {
            const relX = (x - padding.left) / chartWidth;
            const dataIndex = Math.round(
              relX * (state.predictions.predictions.length - 1),
            );

            state.hover = { active: true, x, y, dataIndex };
            renderVisualization();
            updateTooltip(x, y, dataIndex);
          } else {
            hideTooltip();
          }
        }
      });

      canvas.addEventListener("mouseleave", () => {
        state.hover = { active: false, x: 0, y: 0, dataIndex: -1 };
        hideTooltip();
        renderVisualization();
      });

      canvas.addEventListener("wheel", (e) => {
        if (!state.predictions) return;
        e.preventDefault();

        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        state.zoom.level = Math.max(
          0.5,
          Math.min(5, state.zoom.level * delta),
        );
        renderVisualization();
      });

      canvas.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          touchStartDist = Math.sqrt(dx * dx + dy * dy);
        } else if (e.touches.length === 1) {
          isPanning = true;
          lastPanX = e.touches[0].clientX;
        }
      });

      canvas.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const scale = dist / touchStartDist;
          state.zoom.level = Math.max(
            0.5,
            Math.min(5, state.zoom.level * scale),
          );
          touchStartDist = dist;
          renderVisualization();
        } else if (isPanning && e.touches.length === 1) {
          const deltaX = e.touches[0].clientX - lastPanX;
          state.zoom.offsetX += deltaX;
          lastPanX = e.touches[0].clientX;
          renderVisualization();
        }
      });

      canvas.addEventListener("touchend", () => {
        isPanning = false;
      });

      function updateTooltip(x, y, dataIndex) {
        if (!state.predictions || dataIndex < 0) return;

        const tooltip = document.getElementById("tooltip");
        const dim = state.selectedDim;
        const pred = state.predictions.predictions[dataIndex][dim];
        const lower = state.predictions.lowerBounds[dataIndex][dim];
        const upper = state.predictions.upperBounds[dataIndex][dim];
        const spread = upper - lower;
        const color = DIM_COLORS[dim % DIM_COLORS.length];

        document.getElementById("tooltipStep").textContent = `Step ${
          dataIndex + 1
        }`;
        document.getElementById("tooltipDot").style.backgroundColor =
          color;
        document.getElementById("tooltipDim").textContent =
          `Dimension ${dim + 1}`;
        document.getElementById("tooltipValue").textContent = pred
          .toFixed(4);
        document.getElementById("tooltipCI").textContent = `CI: ${
          lower.toFixed(3)
        } - ${upper.toFixed(3)}`;
        document.getElementById("tooltipSpread").textContent =
          `Spread: ${spread.toFixed(4)}`;

        const rect = canvas.getBoundingClientRect();
        tooltip.style.left = Math.min(x + 10, rect.width - 200) + "px";
        tooltip.style.top = Math.min(y + 10, rect.height - 150) + "px";
        tooltip.classList.remove("hidden");
      }

      function hideTooltip() {
        document.getElementById("tooltip").classList.add("hidden");
      }

      // ===================== EVENT HANDLERS =====================

      // Theme toggle
      document.getElementById("themeBtn").addEventListener(
        "click",
        () => {
          state.isDark = !state.isDark;
          document.documentElement.classList.toggle(
            "dark",
            state.isDark,
          );
          localStorage.setItem("isDark", state.isDark);
          renderVisualization();
        },
      );

      // Menu
      document.getElementById("menuBtn").addEventListener(
        "click",
        () => {
          document.getElementById("menuOverlay").classList.remove(
            "hidden",
          );
          document.getElementById("menuPanel").classList.remove(
            "translate-x-full",
          );
        },
      );

      document.getElementById("closeMenu").addEventListener(
        "click",
        closeMenu,
      );
      document.getElementById("menuOverlay").addEventListener(
        "click",
        closeMenu,
      );

      function closeMenu() {
        document.getElementById("menuOverlay").classList.add("hidden");
        document.getElementById("menuPanel").classList.add(
          "translate-x-full",
        );
      }

      // Viz tabs
      document.querySelectorAll(".viz-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          state.vizMode = tab.dataset.mode;
          localStorage.setItem("vizMode", state.vizMode);
          updateUI();
          renderVisualization();
        });
      });

      // Dimension selector
      document.getElementById("dimButtons").addEventListener(
        "click",
        (e) => {
          if (e.target.dataset.dim !== undefined) {
            state.selectedDim = parseInt(e.target.dataset.dim);
            updateDimensionSelector();
            updateStatsBar();
            renderVisualization();
          }
        },
      );

      // Step selector
      document.getElementById("stepInput").addEventListener(
        "input",
        (e) => {
          state.selectedStep = parseInt(e.target.value) || 0;
          renderVisualization();
        },
      );

      // Zoom controls
      document.getElementById("zoomInBtn").addEventListener(
        "click",
        () => {
          state.zoom.level = Math.min(5, state.zoom.level * 1.2);
          renderVisualization();
        },
      );

      document.getElementById("zoomOutBtn").addEventListener(
        "click",
        () => {
          state.zoom.level = Math.max(0.5, state.zoom.level / 1.2);
          renderVisualization();
        },
      );

      document.getElementById("zoomResetBtn").addEventListener(
        "click",
        () => {
          state.zoom = {
            level: 1,
            offsetX: 0,
            visibleStart: 0,
            visibleCount: 0,
          };
          renderVisualization();
        },
      );

      // Export
      document.getElementById("exportPng").addEventListener(
        "click",
        () => {
          const link = document.createElement("a");
          link.download = "esn-chart.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
          showToast("PNG saved", "success");
        },
      );

      document.getElementById("exportSvg").addEventListener(
        "click",
        () => {
          showToast("SVG export not yet implemented", "warning");
        },
      );

      document.getElementById("exportClip").addEventListener(
        "click",
        async () => {
          try {
            const blob = await new Promise((resolve) =>
              canvas.toBlob(resolve)
            );
            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob }),
            ]);
            showToast("Copied to clipboard", "success");
          } catch (e) {
            showToast("Failed to copy", "error");
          }
        },
      );

      // Config modal
      document.getElementById("configBtn").addEventListener(
        "click",
        openConfigModal,
      );
      document.getElementById("menuConfig").addEventListener(
        "click",
        () => {
          closeMenu();
          openConfigModal();
        },
      );
      document.getElementById("configOverlay").addEventListener(
        "click",
        closeConfigModal,
      );
      document.getElementById("cfgCancel").addEventListener(
        "click",
        closeConfigModal,
      );

      function openConfigModal() {
        document.getElementById("configModal").classList.remove(
          "hidden",
        );
        loadConfigToUI();
      }

      function closeConfigModal() {
        document.getElementById("configModal").classList.add("hidden");
      }

      // Presets
      document.querySelectorAll(".preset-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const preset = PRESETS[btn.dataset.preset];
          Object.assign(state.config, preset);
          loadConfigToUI();

          document.querySelectorAll(".preset-btn").forEach((b) => {
            b.className =
              `preset-btn px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap ${
                b === btn
                  ? "bg-blue-500 text-white"
                  : "bg-slate-100 dark:bg-slate-700"
              }`;
          });
        });
      });

      // Section toggles
      document.querySelectorAll(".section-toggle").forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const content = toggle.nextElementSibling;
          const icon = toggle.querySelector(".toggle-icon");
          content.classList.toggle("hidden");
          icon.textContent = content.classList.contains("hidden")
            ? "‚ñ∂"
            : "‚ñº";
        });
      });

      function loadConfigToUI() {
        const cfg = state.config;
        document.getElementById("cfg_reservoirSize").value =
          cfg.reservoirSize;
        document.getElementById("cfg_spectralRadius").value =
          cfg.spectralRadius;
        document.getElementById("cfg_leakRate").value = cfg.leakRate;
        document.getElementById("cfg_inputScale").value =
          cfg.inputScale;
        document.getElementById("cfg_biasScale").value = cfg.biasScale;
        document.getElementById("cfg_reservoirSparsity").value =
          cfg.reservoirSparsity;
        document.getElementById("cfg_inputSparsity").value =
          cfg.inputSparsity;
        document.getElementById("cfg_activation").value =
          cfg.activation;
        document.getElementById("cfg_useInputInReadout").checked =
          cfg.useInputInReadout;
        document.getElementById("cfg_useBiasInReadout").checked =
          cfg.useBiasInReadout;
        document.getElementById("cfg_rlsLambda").value = cfg.rlsLambda;
        document.getElementById("cfg_rlsDelta").value = cfg.rlsDelta;
        document.getElementById("cfg_epsilon").value = cfg.epsilon;
        document.getElementById("cfg_l2Lambda").value = cfg.l2Lambda;
        document.getElementById("cfg_gradientClipNorm").value =
          cfg.gradientClipNorm;
        document.getElementById("cfg_normalizationEpsilon").value =
          cfg.normalizationEpsilon;
        document.getElementById("cfg_normalizationWarmup").value =
          cfg.normalizationWarmup;
        document.getElementById("cfg_outlierThreshold").value =
          cfg.outlierThreshold;
        document.getElementById("cfg_outlierMinWeight").value =
          cfg.outlierMinWeight;
        document.getElementById("cfg_uncertaintyMultiplier").value =
          cfg.uncertaintyMultiplier;
        document.getElementById("cfg_weightInitScale").value =
          cfg.weightInitScale;
        document.getElementById("cfg_seed").value = cfg.seed;
        document.getElementById("cfg_verbose").checked = cfg.verbose;
      }

      function getConfigFromUI() {
        return {
          reservoirSize: parseInt(
            document.getElementById("cfg_reservoirSize").value,
          ),
          spectralRadius: parseFloat(
            document.getElementById("cfg_spectralRadius").value,
          ),
          leakRate: parseFloat(
            document.getElementById("cfg_leakRate").value,
          ),
          inputScale: parseFloat(
            document.getElementById("cfg_inputScale").value,
          ),
          biasScale: parseFloat(
            document.getElementById("cfg_biasScale").value,
          ),
          reservoirSparsity: parseFloat(
            document.getElementById("cfg_reservoirSparsity").value,
          ),
          inputSparsity: parseFloat(
            document.getElementById("cfg_inputSparsity").value,
          ),
          activation: document.getElementById("cfg_activation").value,
          useInputInReadout:
            document.getElementById("cfg_useInputInReadout").checked,
          useBiasInReadout:
            document.getElementById("cfg_useBiasInReadout").checked,
          readoutTraining: "rls",
          rlsLambda: parseFloat(
            document.getElementById("cfg_rlsLambda").value,
          ),
          rlsDelta: parseFloat(
            document.getElementById("cfg_rlsDelta").value,
          ),
          epsilon: parseFloat(
            document.getElementById("cfg_epsilon").value,
          ),
          l2Lambda: parseFloat(
            document.getElementById("cfg_l2Lambda").value,
          ),
          gradientClipNorm: parseFloat(
            document.getElementById("cfg_gradientClipNorm").value,
          ),
          normalizationEpsilon: parseFloat(
            document.getElementById("cfg_normalizationEpsilon").value,
          ),
          normalizationWarmup: parseInt(
            document.getElementById("cfg_normalizationWarmup").value,
          ),
          outlierThreshold: parseFloat(
            document.getElementById("cfg_outlierThreshold").value,
          ),
          outlierMinWeight: parseFloat(
            document.getElementById("cfg_outlierMinWeight").value,
          ),
          uncertaintyMultiplier: parseFloat(
            document.getElementById("cfg_uncertaintyMultiplier").value,
          ),
          weightInitScale: parseFloat(
            document.getElementById("cfg_weightInitScale").value,
          ),
          seed: parseInt(document.getElementById("cfg_seed").value),
          verbose: document.getElementById("cfg_verbose").checked,
        };
      }

      document.getElementById("cfgCreate").addEventListener(
        "click",
        () => {
          state.config = getConfigFromUI();
          localStorage.setItem("config", JSON.stringify(state.config));
          closeConfigModal();
          createModel();
        },
      );

      document.getElementById("cfgResetDefaults").addEventListener(
        "click",
        () => {
          state.config = { ...DEFAULT_CONFIG };
          loadConfigToUI();
        },
      );

      document.getElementById("cfgResetAll").addEventListener(
        "click",
        () => {
          if (confirm("Reset model and clear all data?")) {
            sendToWorker("reset");
            state.config = { ...DEFAULT_CONFIG };
            state.predictions = null;
            loadConfigToUI();
            updateUI();
            renderVisualization();
          }
        },
      );

      function createModel() {
        showLoading("Creating model...");
        sendToWorker("createModel", { config: state.config });
      }

      // Quick start
      document.getElementById("quickStartBtn").addEventListener(
        "click",
        () => {
          state.config = { ...DEFAULT_CONFIG };
          createModel();
        },
      );

      // Predict
      document.getElementById("predictBtn").addEventListener(
        "click",
        runPrediction,
      );
      document.getElementById("runPredictBtn").addEventListener(
        "click",
        runPrediction,
      );

      function runPrediction() {
        if (!state.modelExists) {
          showToast("Create a model first", "warning");
          return;
        }
        const steps =
          parseInt(document.getElementById("futureSteps").value) || 50;
        showLoading("Running prediction...");
        sendToWorker("predict", { steps });
      }

      // Cancel
      document.getElementById("cancelBtn").addEventListener(
        "click",
        () => {
          state.cancelRequested = true;
          sendToWorker("cancel");
        },
      );

      // Upload modal
      document.getElementById("menuUpload").addEventListener(
        "click",
        () => {
          closeMenu();
          openUploadModal();
        },
      );
      document.getElementById("uploadOverlay").addEventListener(
        "click",
        closeUploadModal,
      );
      document.getElementById("uploadCancel").addEventListener(
        "click",
        closeUploadModal,
      );

      function openUploadModal() {
        document.getElementById("uploadModal").classList.remove(
          "hidden",
        );
        document.getElementById("jsonInput").value = "";
        document.getElementById("uploadPreview").classList.add(
          "hidden",
        );
        document.getElementById("uploadError").classList.add("hidden");
        document.getElementById("uploadApply").disabled = true;
      }

      function closeUploadModal() {
        document.getElementById("uploadModal").classList.add("hidden");
      }

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");

      dropZone.addEventListener("click", () => fileInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add(
          "border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove(
          "border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove(
          "border-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20",
        );
        if (e.dataTransfer.files[0]) {
          handleUploadFile(e.dataTransfer.files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) {
          handleUploadFile(e.target.files[0]);
        }
      });

      function handleUploadFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("jsonInput").value = e.target.result;
          validateUpload();
        };
        reader.readAsText(file);
      }

      document.getElementById("uploadValidate").addEventListener(
        "click",
        validateUpload,
      );

      let validatedData = null;

      function validateUpload() {
        const json = document.getElementById("jsonInput").value;
        const preview = document.getElementById("uploadPreview");
        const error = document.getElementById("uploadError");
        const applyBtn = document.getElementById("uploadApply");

        try {
          const data = JSON.parse(json);
          if (
            !data.coordinates || !Array.isArray(data.coordinates) ||
            data.coordinates.length < 2
          ) {
            throw new Error("Need at least 2 coordinates");
          }

          const nDims = data.coordinates[0].length;
          if (
            !data.coordinates.every((c) =>
              Array.isArray(c) && c.length === nDims
            )
          ) {
            throw new Error(
              "All coordinates must have same dimensions",
            );
          }

          validatedData = data;
          preview.classList.remove("hidden");
          error.classList.add("hidden");
          document.getElementById("previewText").textContent =
            `Valid: ${nDims} dimensions, ${data.coordinates.length} steps`;
          applyBtn.disabled = false;
        } catch (e) {
          validatedData = null;
          preview.classList.add("hidden");
          error.classList.remove("hidden");
          document.getElementById("errorText").textContent = e.message;
          applyBtn.disabled = true;
        }
      }

      document.getElementById("uploadApply").addEventListener(
        "click",
        () => {
          if (!validatedData) return;

          closeUploadModal();

          if (!state.modelExists) {
            state.config = { ...DEFAULT_CONFIG };
            showLoading("Creating model and training...");
            sendToWorker("createModel", { config: state.config });

            // Wait for model creation, then train
            const checkModel = setInterval(() => {
              if (state.modelExists) {
                clearInterval(checkModel);
                trainOnData(validatedData.coordinates);
              }
            }, 100);
          } else {
            trainOnData(validatedData.coordinates);
          }
        },
      );

      function trainOnData(coordinates) {
        showLoading("Training on uploaded data...");
        state.sampleCount += coordinates.length;
        sendToWorker("train", { coordinates });
      }

      document.getElementById("copyExample").addEventListener(
        "click",
        () => {
          navigator.clipboard.writeText(JSON.stringify(
            {
              coordinates: [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1], [
                1.2,
                2.2,
                3.2,
              ]],
            },
            null,
            2,
          ));
          showToast("Example copied", "success");
        },
      );

      // Manual insert modal
      document.getElementById("menuManual").addEventListener(
        "click",
        () => {
          closeMenu();
          openManualModal();
        },
      );
      document.getElementById("manualOverlay").addEventListener(
        "click",
        closeManualModal,
      );
      document.getElementById("manualCancel").addEventListener(
        "click",
        closeManualModal,
      );

      function openManualModal() {
        document.getElementById("manualModal").classList.remove(
          "hidden",
        );
        document.getElementById("manualJson").value = "";
        document.getElementById("manualFeedback").innerHTML = "";
      }

      function closeManualModal() {
        document.getElementById("manualModal").classList.add("hidden");
      }

      document.getElementById("genTemplate").addEventListener(
        "click",
        () => {
          const nDims = state.nDimensions || 3;
          const template = {
            coordinates: [
              Array(nDims).fill(0).map((_, i) => 0),
              Array(nDims).fill(0).map((_, i) => 0),
            ],
          };
          document.getElementById("manualJson").value = JSON.stringify(
            template,
            null,
            2,
          );
        },
      );

      document.getElementById("manualInsert").addEventListener(
        "click",
        () => {
          const json = document.getElementById("manualJson").value;
          const feedback = document.getElementById("manualFeedback");

          try {
            const data = JSON.parse(json);
            if (!data.coordinates || data.coordinates.length < 2) {
              throw new Error("Need at least 2 coordinates");
            }

            closeManualModal();

            if (!state.modelExists) {
              state.config = { ...DEFAULT_CONFIG };
              showLoading("Creating model and training...");
              sendToWorker("createModel", { config: state.config });

              const checkModel = setInterval(() => {
                if (state.modelExists) {
                  clearInterval(checkModel);
                  trainOnData(data.coordinates);
                }
              }, 100);
            } else {
              trainOnData(data.coordinates);
            }
          } catch (e) {
            feedback.innerHTML =
              `<div class="text-red-500 text-sm mt-2">${e.message}</div>`;
          }
        },
      );

      // Save & Load modal
      document.getElementById("menuSaveLoad").addEventListener(
        "click",
        () => {
          closeMenu();
          openSaveLoadModal();
        },
      );
      document.getElementById("loadBtnEmpty").addEventListener(
        "click",
        openSaveLoadModal,
      );
      document.getElementById("saveLoadOverlay").addEventListener(
        "click",
        closeSaveLoadModal,
      );
      document.getElementById("saveLoadClose").addEventListener(
        "click",
        closeSaveLoadModal,
      );

      function openSaveLoadModal() {
        document.getElementById("saveLoadModal").classList.remove(
          "hidden",
        );
        loadSavedModelsList();
      }

      function closeSaveLoadModal() {
        document.getElementById("saveLoadModal").classList.add(
          "hidden",
        );
      }

      let pendingSaveState = null;

      document.getElementById("saveDownload").addEventListener(
        "click",
        () => {
          if (!state.modelExists) {
            showToast("No model to save", "warning");
            return;
          }
          pendingSaveState = "download";
          sendToWorker("save");
        },
      );

      document.getElementById("saveBrowser").addEventListener(
        "click",
        () => {
          if (!state.modelExists) {
            showToast("No model to save", "warning");
            return;
          }
          const name = prompt("Model name:", `ESN-${Date.now()}`);
          if (!name) return;
          pendingSaveState = name;
          sendToWorker("save");
        },
      );

      function handleSaveComplete(modelState) {
        if (pendingSaveState === "download") {
          const blob = new Blob([JSON.stringify(modelState)], {
            type: "application/json",
          });
          const link = document.createElement("a");
          link.download = `esn-model-${Date.now()}.json`;
          link.href = URL.createObjectURL(blob);
          link.click();
          showToast("Model downloaded", "success");
        } else if (pendingSaveState) {
          const saved = JSON.parse(
            localStorage.getItem("savedModels") || "{}",
          );
          saved[pendingSaveState] = {
            state: modelState,
            nDims: state.nDimensions,
            date: new Date().toISOString(),
          };
          localStorage.setItem("savedModels", JSON.stringify(saved));
          showToast("Model saved to browser", "success");
          loadSavedModelsList();
        }
        pendingSaveState = null;
      }

      function loadSavedModelsList() {
        const container = document.getElementById("savedModelsList");
        const saved = JSON.parse(
          localStorage.getItem("savedModels") || "{}",
        );

        container.innerHTML =
          Object.entries(saved).map(([name, data]) => `
            <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-xl">
                <div>
                    <div class="font-medium">${name}</div>
                    <div class="text-xs text-slate-500">${data.nDims} dims ¬∑ ${
            new Date(data.date).toLocaleDateString()
          }</div>
                </div>
                <button class="load-saved-btn px-3 py-1 rounded-lg bg-blue-500 text-white text-sm" data-name="${name}">Load</button>
            </div>
        `).join("") ||
          '<div class="text-slate-500 text-sm">No saved models</div>';

        container.querySelectorAll(".load-saved-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const name = btn.dataset.name;
            const saved = JSON.parse(
              localStorage.getItem("savedModels") || "{}",
            );
            if (saved[name]) {
              closeSaveLoadModal();
              showLoading("Loading model...");
              sendToWorker("load", { state: saved[name].state });
            }
          });
        });
      }

      const loadDropZone = document.getElementById("loadDropZone");
      const loadFileInput = document.getElementById("loadFileInput");

      loadDropZone.addEventListener(
        "click",
        () => loadFileInput.click(),
      );
      loadFileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const modelState = JSON.parse(ev.target.result);
              closeSaveLoadModal();
              showLoading("Loading model...");
              sendToWorker("load", { state: modelState });
            } catch (e) {
              showToast("Invalid model file", "error");
            }
          };
          reader.readAsText(e.target.files[0]);
        }
      });

      document.getElementById("clearSavedModels").addEventListener(
        "click",
        () => {
          if (confirm("Clear all saved models?")) {
            localStorage.removeItem("savedModels");
            loadSavedModelsList();
            showToast("Saved models cleared", "info");
          }
        },
      );

      // Random test modal
      document.getElementById("menuRandom").addEventListener(
        "click",
        () => {
          closeMenu();
          openRandomModal();
        },
      );
      document.getElementById("demoBtn").addEventListener(
        "click",
        () => {
          document.getElementById("rnd_seed").value = 42;
          document.getElementById("rnd_dims").value = 3;
          document.getElementById("rnd_steps").value = 200;
          document.getElementById("rnd_noise").value = 0.1;
          document.getElementById("rnd_outliers").value = 0.02;
          document.getElementById("rnd_difficulty").value = "medium";
          generateAndRun();
        },
      );
      document.getElementById("randomOverlay").addEventListener(
        "click",
        closeRandomModal,
      );
      document.getElementById("randomCancel").addEventListener(
        "click",
        closeRandomModal,
      );

      function openRandomModal() {
        document.getElementById("randomModal").classList.remove(
          "hidden",
        );
      }

      function closeRandomModal() {
        document.getElementById("randomModal").classList.add("hidden");
      }

      document.getElementById("randomGenerate").addEventListener(
        "click",
        () => {
          closeRandomModal();
          generateAndRun();
        },
      );

      function generateAndRun() {
        const seed = parseInt(
          document.getElementById("rnd_seed").value,
        );
        const dims = parseInt(
          document.getElementById("rnd_dims").value,
        );
        const steps = parseInt(
          document.getElementById("rnd_steps").value,
        );
        const noise = parseFloat(
          document.getElementById("rnd_noise").value,
        );
        const outlierRate = parseFloat(
          document.getElementById("rnd_outliers").value,
        );
        const difficulty =
          document.getElementById("rnd_difficulty").value;

        // Generate synthetic time series
        const coordinates = generateSyntheticData(
          seed,
          dims,
          steps,
          noise,
          outlierRate,
          difficulty,
        );

        state.config = { ...DEFAULT_CONFIG };
        showLoading("Creating model and training on synthetic data...");
        sendToWorker("createModel", { config: state.config });

        const checkModel = setInterval(() => {
          if (state.modelExists) {
            clearInterval(checkModel);
            trainOnData(coordinates);
          }
        }, 100);
      }

      function generateSyntheticData(
        seed,
        dims,
        steps,
        noise,
        outlierRate,
        difficulty,
      ) {
        // Simple seeded random
        let s = seed;
        const rand = () => {
          s = (s * 9301 + 49297) % 233280;
          return s / 233280;
        };

        const frequencies = difficulty === "easy"
          ? [0.05]
          : difficulty === "medium"
          ? [0.05, 0.15]
          : [0.05, 0.15, 0.3];

        const coordinates = [];
        for (let t = 0; t < steps; t++) {
          const point = [];
          for (let d = 0; d < dims; d++) {
            let val = 0;
            frequencies.forEach((f, i) => {
              val += Math.sin(2 * Math.PI * f * t + d * 0.5 + i) /
                (i + 1);
            });
            val += (rand() - 0.5) * 2 * noise;

            if (rand() < outlierRate) {
              val += (rand() - 0.5) * 10;
            }

            point.push(val);
          }
          coordinates.push(point);
        }

        return coordinates;
      }

      // Settings modal
      document.getElementById("menuSettings").addEventListener(
        "click",
        () => {
          closeMenu();
          openSettingsModal();
        },
      );
      document.getElementById("settingsOverlay").addEventListener(
        "click",
        closeSettingsModal,
      );
      document.getElementById("settingsClose").addEventListener(
        "click",
        closeSettingsModal,
      );

      function openSettingsModal() {
        document.getElementById("settingsModal").classList.remove(
          "hidden",
        );
        document.getElementById("moduleUrl").value = moduleUrl;
      }

      function closeSettingsModal() {
        document.getElementById("settingsModal").classList.add(
          "hidden",
        );
      }

      document.getElementById("reinitWorker").addEventListener(
        "click",
        () => {
          moduleUrl = document.getElementById("moduleUrl").value;
          localStorage.setItem("moduleUrl", moduleUrl);
          if (worker) worker.terminate();
          state.modelExists = false;
          state.predictions = null;
          updateUI();
          renderVisualization();
          initWorker();
          closeSettingsModal();
          showToast("Worker reinitialized", "info");
        },
      );

      document.getElementById("clearPrefs").addEventListener(
        "click",
        () => {
          if (confirm("Clear all preferences and reload?")) {
            localStorage.clear();
            location.reload();
          }
        },
      );

      // Data table modal
      document.getElementById("menuDataTable").addEventListener(
        "click",
        () => {
          closeMenu();
          openDataTableModal();
        },
      );
      document.getElementById("dataTableOverlay").addEventListener(
        "click",
        closeDataTableModal,
      );
      document.getElementById("dataTableClose").addEventListener(
        "click",
        closeDataTableModal,
      );

      function openDataTableModal() {
        document.getElementById("dataTableModal").classList.remove(
          "hidden",
        );
        renderDataTable();
      }

      function closeDataTableModal() {
        document.getElementById("dataTableModal").classList.add(
          "hidden",
        );
      }

      function renderDataTable() {
        if (!state.predictions) {
          document.getElementById("tableBody").innerHTML =
            '<tr><td colspan="100" class="p-4 text-center text-slate-500">No predictions available</td></tr>';
          return;
        }

        const { predictions, lowerBounds, upperBounds } =
          state.predictions;
        const nDims = state.nDimensions;

        // Header
        const header = document.getElementById("tableHeader");
        header.innerHTML = `
            <th class="p-2 text-left cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">Step</th>
            ${
          Array.from({ length: nDims }, (_, i) => `
                <th class="p-2 text-left cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">P${
            i + 1
          }</th>
                <th class="p-2 text-left cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">L${
            i + 1
          }</th>
                <th class="p-2 text-left cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600">U${
            i + 1
          }</th>
            `).join("")
        }
        `;

        // Body
        const body = document.getElementById("tableBody");
        const search = document.getElementById("tableSearch").value
          .toLowerCase();

        body.innerHTML = predictions.map((pred, step) => {
          const rowText = `${step + 1} ${pred.join(" ")}`;
          if (search && !rowText.toLowerCase().includes(search)) {
            return "";
          }

          return `
                <tr class="${
            step % 2 === 0 ? "bg-slate-50 dark:bg-slate-800/50" : ""
          } hover:bg-blue-50 dark:hover:bg-blue-900/20">
                    <td class="p-2 font-medium">${step + 1}</td>
                    ${
            Array.from({ length: nDims }, (_, d) => `
                        <td class="p-2">${pred[d].toFixed(4)}</td>
                        <td class="p-2 text-slate-500">${
              lowerBounds[step][d].toFixed(4)
            }</td>
                        <td class="p-2 text-slate-500">${
              upperBounds[step][d].toFixed(4)
            }</td>
                    `).join("")
          }
                </tr>
            `;
        }).join("");
      }

      document.getElementById("tableSearch").addEventListener(
        "input",
        renderDataTable,
      );

      document.getElementById("exportCsv").addEventListener(
        "click",
        () => {
          if (!state.predictions) return;

          const { predictions, lowerBounds, upperBounds } =
            state.predictions;
          const nDims = state.nDimensions;

          let csv = "Step," +
            Array.from(
              { length: nDims },
              (_, i) => `P${i + 1},L${i + 1},U${i + 1}`,
            ).join(",") +
            "\n";
          predictions.forEach((pred, step) => {
            csv += `${step + 1},` +
              Array.from(
                { length: nDims },
                (_, d) =>
                  `${pred[d]},${lowerBounds[step][d]},${
                    upperBounds[step][d]
                  }`,
              ).join(",") +
              "\n";
          });

          const blob = new Blob([csv], { type: "text/csv" });
          const link = document.createElement("a");
          link.download = "predictions.csv";
          link.href = URL.createObjectURL(blob);
          link.click();
          showToast("CSV exported", "success");
        },
      );

      document.getElementById("copyAllData").addEventListener(
        "click",
        async () => {
          if (!state.predictions) return;

          const { predictions, lowerBounds, upperBounds } =
            state.predictions;
          const text = predictions.map((pred, step) =>
            `Step ${step + 1}: ${
              pred.map((p, d) =>
                `D${d + 1}=${p.toFixed(4)} [${
                  lowerBounds[step][d].toFixed(4)
                }, ${upperBounds[step][d].toFixed(4)}]`
              ).join(", ")
            }`
          ).join("\n");

          await navigator.clipboard.writeText(text);
          showToast("Data copied", "success");
        },
      );

      // Help modal
      document.getElementById("menuHelp").addEventListener(
        "click",
        () => {
          closeMenu();
          openHelpModal();
        },
      );
      document.getElementById("helpOverlay").addEventListener(
        "click",
        closeHelpModal,
      );
      document.getElementById("helpClose").addEventListener(
        "click",
        closeHelpModal,
      );

      function openHelpModal() {
        document.getElementById("helpModal").classList.remove("hidden");
      }

      function closeHelpModal() {
        document.getElementById("helpModal").classList.add("hidden");
      }

      // Log filters
      document.getElementById("logFilter").addEventListener(
        "change",
        renderLogs,
      );
      document.getElementById("logSearch").addEventListener(
        "input",
        renderLogs,
      );

      // ===================== INITIALIZATION =====================
      function init() {
        // Apply theme
        if (state.isDark) {
          document.documentElement.classList.add("dark");
        }

        // Load saved config
        try {
          const savedConfig = localStorage.getItem("config");
          if (savedConfig) {
            state.config = {
              ...DEFAULT_CONFIG,
              ...JSON.parse(savedConfig),
            };
          }
        } catch (e) {}

        // Initialize
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
        initWorker();
        updateUI();
        addLog("info", "ESN Regression Studio initialized");
      }

      init();
    </script>
  </body>
</html>
